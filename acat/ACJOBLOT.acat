*          DATA SET ACJOBLOT   AT LEVEL 022 AS OF 10/03/06                      
*CATALP ACJOBLOT                                                                
         TITLE 'ACJOBLOT - EXTRACT VARIOUS JOB VALUES'                          
ACJOBLOT CSECT                                                                  
         PRINT NOGEN                                                            
BGN      NMOD1 LWSLNQ,**JOBL**,RA,CLEAR=YES                                     
         USING LWSD,RC                                                          
         LR    R9,R1                                                            
         USING JLD,R9                                                           
         MVC   JLBILLQ,=C'99'                                                   
         MVC   JLORDRQ,=C'**'                                                   
         LA    R1,BILLTAB                                                       
         ST    R1,ABILLTAB                                                      
*                                                                               
         ICM   R8,15,JLAGOBK                                                    
         USING GOBLOCKD,R8                                                      
         EJECT                                                                  
***********************************************************************         
* INITIALIZE                                                          *         
***********************************************************************         
                                                                                
         MVC   COMFACS,JLACOMF                                                  
         MVC   GETOPT,JLAGETOP                                                  
         MVC   JOBBER,JLAJOBR                                                   
         MVC   JOBCOL,JLAJOBC                                                   
         ZAP   PZERO,PZRO                                                       
*                                                                               
         L     RF,COMFACS                                                       
         MVC   DATAMGR,CDATAMGR-COMFACSD(RF)                                    
         MVC   DATCON,CDATCON-COMFACSD(RF)                                      
         MVC   ADDAY,CADDAY-COMFACSD(RF)                                        
*                                                                               
         MVC   COMMANDS,DMCMDS                                                  
         LA    RF,IO1                                                           
         ST    RF,AIO1                                                          
         LA    RF,IOLNQ(RF)                                                     
         ST    RF,AIO2                                                          
         LA    RF,IOLNQ(RF)                                                     
         ST    RF,AIO3                                                          
*                                                                               
         MVC   DATADISP,=Y(ACCORFST)                                            
         MVC   NEWDISP,=Y(ACCRFST-ACCRECD)                                      
         TM    JLOPTS,JLOPMST                                                   
         BNO   *+10                                                             
         MVC   DATADISP,=Y(ACCRFST-ACCRECD)                                     
*                                                                               
         MVI   SPACES,C' '                                                      
         MVC   SPACES+1(L'SPACES-1),SPACES                                      
*                                                                               
         OC    JLTODAY0,JLTODAY0                                                
         BNZ   SETUP2                                                           
         GOTO1 DATCON,DMCB,(5,0),(0,JLTODAY0)    GET SOME DATES                 
*                                                                               
SETUP2   GOTO1 DATCON,DMCB,(0,JLTODAY0),(1,JLTODAY1)                            
         GOTO1 DATCON,DMCB,(0,JLTODAY0),(2,JLTODAY2)                            
         GOTO1 ADDAY,DMCB,(C'M',JLTODAY0),WORK,F'-6'                            
         GOTO1 DATCON,DMCB,(0,WORK),(1,JLLESS6M)   TODAY LESS 6 MONTHS          
*                                                                               
*                                  SET JOBBER INTERFACE BLOCK                   
SETUP3   MVC   JBAJOB,JLAJOB       A(JOB)                                       
         MVC   JBACOM,COMFACS      A(COMFACS)                                   
         MVC   JBAGOBLK,JLAGOBK    A(GOBLOCK)                                   
         MVC   JBAIO,AIO1          A(IO1)                                       
         XC    JBASCH,JBASCH       A(SCHEME BLOCK)                              
         MVC   JBGETOPT,GETOPT     A(GETOPT)                                    
         MVC   JBSELSCH,GOSCHEME   SCHEME                                       
*                                                                               
         MVC   JBACOLS,JLACOLS     A(COLUMN LIST)                               
         OC    JBACOLS,JBACOLS                                                  
         BNZ   *+10                                                             
         MVC   JBACOLS,ACOLIST     IF NONE, USE DEFAULTS                        
*                                                                               
         MVC   JBACOLTB,JLACOLTB   A(OUTPUT COLUMN TABLE)                       
         MVC   JBLCOLTB,JLLCOLTB   OUTPUT COLUMN LENGTH                         
         OC    JBACOLTB,JBACOLTB                                                
         BNZ   *+16                                                             
         MVC   JBACOLTB,ACOLTAB    IF NONE, USE DEFAULTS                        
         MVC   JBLCOLTB,COLTABLQ                                                
*                                                                               
         MVC   JBAOPVTB,JLAOPVTB   A(OPERAND VALUE TABLE)                       
         MVC   JBLOPVTB,JLLOPVTB   OPERAND VALUE TABLE LENGTH                   
         OC    JBAOPVTB,JBAOPVTB                                                
         BNZ   *+16                                                             
         MVC   JBAOPVTB,AOPVTAB    IF NONE, USE DEFAULTS                        
         MVC   JBLOPVTB,OPVTABLQ                                                
*                                                                               
         OC    JLBIGBAL,JLBIGBAL                                                
         BNZ   *+10                                                             
         ZAP   JLBIGBAL,PZERO                                                   
*                                                                               
         OC    JLWCFLT,JLWCFLT                                                  
         BNZ   *+10                                                             
         MVC   JLWCFLT,SPACES                                                   
*                                                                               
         L     RF,JLAJOB                                                        
         MVC   CPY,0(RF)           SAVE COMPANY CODE                            
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,1,JLACTN                                                      
         SLL   RF,2                                                             
         B     *(RF)                                                            
*                                                                               
         B     ACCF                ACCOUNT FIRST                                
         B     PTRN                PROCESS TRANSACTION                          
         B     ACCL                ACCOUNT LAST                                 
         B     UPEL                UPDATE THE ERROR LIST                        
*                                                                               
                                                                                
         EJECT                                                                  
***********************************************************************         
* FIRST FOR ACCOUNT                                                   *         
***********************************************************************         
                                                                                
ACCF     DS    0H                                                               
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         LA    R0,JLRTN            CLEAR JOBLOT RETURN DATA                     
         LA    R1,JLRLNQ                                                        
         MVCL  R0,RE                                                            
*                                                                               
         LA    R0,JLBN             INITIALISE ALL PACKED FIELDS                 
         LA    R1,JLBUCK                                                        
         ZAP   0(L'JLBK,R1),PZERO                                               
         LA    R1,L'JLBK(R1)                                                    
         BCT   R0,*-10                                                          
*                                                                               
         LA    R0,LBKN             INITIALISE LOCAL ACCUMULATORS                
         LA    R1,LBK                                                           
         ZAP   0(L'LBK,R1),PZERO                                                
         LA    R1,L'LBK(R1)                                                     
         BCT   R0,*-10                                                          
*                                                                               
*              CALL JOBCOL TO GET ESTIMATE VALUES                               
         GOTO1 JOBCOL,DMCB,ESTLH,JBACOLS,COMFACS                                
         CLI   4(R1),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
*              CALL JOBBER                                                      
         LA    R0,LKEY          SAVE LAST KEY                                   
         ST    R0,ALKEY                                                         
         GOTO1 DATAMGR,DMCB,DMKEY,ACCDIR,(R0)                                   
*                                                                               
         MVC   JBAKEY,ALKEY        A(LAST KEY)                                  
         GOTO1 JOBBER,DMCB,JBLOCK                                               
         CLI   JBERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                DIE ON JOBBER ERROR                          
*                                                                               
         L     R7,GOAEXT                                                        
         USING GOXBLKD,R7                                                       
         L     RF,JLAEWCB                                                       
         MVI   0(RF),EOT                                                        
*                                                                               
         CLI   JLRROPT,0           RERUN OR UBILL OPTION                        
         BE    ACCF2                                                            
         CLI   GOBILTYP,C'U'       UNBILLABLE IS UNREVERSIBLE                   
         BE    ACCF2                                                            
         GOTOR RERN,DMCB,(RC)                                                   
*                                                                               
ACCF2    MVI   ELCODE,RSTELQ       GET STATUS ELEMENT                           
         LA    R0,3                FOR  CLI/PROD/JOB                            
         LA    R2,JLACLI                                                        
ACCF3    ICM   R3,15,0(R2)                                                      
         BRAS  RE,GETEL                                                         
         BNE   ACCF5                                                            
         USING RSTELD,R3                                                        
         MVC   JLLPSTDT,RSTTDATE   LAST TRANSACTION POST DATE                   
         MVC   JLLBILDT,RSTPBILL   LAST BILLED DATE                             
         CLI   RSTLN,RSTLN2Q                                                    
         BL    ACCF5                                                            
         TM    RSTSTAT2,RSTSBILN   TEST BILL SELECT = N                         
         BNO   *+8                                                              
         OI    JLSTAT2,JLS2BLSN    SET BILLSELECT=N                             
         TM    RSTSTAT2,RSTSBILY   TEST BILL SELECT = Y                         
         BNO   *+8                                                              
         NI    JLSTAT2,ALL-JLS2BLSN TURNOFF BILLSELECT=N                        
ACCF5    LA    R2,4(R2)                                                         
         BCT   R0,ACCF3                                                         
*                                                                               
         TM    RSTSTAT1,RSTSACIC   ACCOUNT CLOSED ?                             
         BNO   *+8                                                              
         OI    JLSTAT4,JLS4CLSD                                                 
         TM    RSTSTAT1,RSTSACIL   ACCOUNT LOCKED ?                             
         BNO   *+8                                                              
         OI    JLSTAT4,JLS4LOCK                                                 
*                                                                               
         MVC   BYTE,GOBILTYP       SAVE BILL TYPE                               
         CLI   BYTE,C'A'           AUTO CYCLE                                   
         BNE   *+8                                                              
         BAS   RE,GETCYC           GET CYCLE RECORD (SET BILLTYPE)              
         CLI   JLRROPT,0           TEST RERUN OR UNBILL                         
         BE    ACCF6                                                            
         CLI   JLRRTYP,0           TEST TYPE FROM ORIGINAL BILL                 
         BE    ACCF6               ASSUME POSTINGS NOT ON FILE                  
         MVC   BYTE,JLRRTYP        YES, USE ORIGINAL TYPE                       
*                                                                               
ACCF6    L     R1,ABILLTAB          GET BILL TYPE DATA                          
         CLC   0(1,R1),BYTE                                                     
         BE    *+16                                                             
         LA    R1,L'BILLTAB(R1)                                                 
         CLI   0(R1),JLBLUNBL      NOT IN TABLE(MAKE IT UNBILLABLE)             
         BNE   *-18                                                             
         MVC   JLBLCODE(L'BILLTAB),0(R1)                                        
*                                                                               
         CLI   GOSTUDIO,YES        STUDIO OFFICE ?                              
         BNE   *+8                                                              
         OI    JLSTAT2,JLS2STUD                                                 
         CLC   GODIST,SPACES       DISTRIBUTOR CODE ?                           
         BNH   *+8                                                              
         OI    JLSTAT1,JLS1DIST                                                 
*                                                                               
         CLI   GOPAYNET,YES        PAY=NET ?                                    
         BNE   *+8                                                              
         OI    JLSTAT3,JLS3PNET                                                 
         CLI   GOSUPAGY,YES        PAY=NET AND SUPPRESS                         
         BNE   *+8                                                              
         OI    JLSTAT3,JLS3PNET+JLS3SUPC                                        
         CLI   GONEEDES,YES        ESTIMATE REQUIRED ?                          
         BNE   *+8                                                              
         OI    JLSTAT3,JLS3ESRQ                                                 
         CLI   JBNEWEST,YES        JOB USES NEW ESTIMATES ?                     
         BNE   ACCF7                                                            
         OI    JLSTAT3,JLS3NEWS                                                 
         CLI   GONEEDAE,YES        NEED NEW ESTIMATE TO BILL ?                  
         BNE   *+8                                                              
         OI    JLSTAT3,JLS3NTOB                                                 
         CLI   JBHIAPP,0           ANY APPROVED ESTIMATES ?                     
         BNE   *+12                                                             
         OI    JLSTAT3,JLS3UNEW    UNAPPROVED 'NEW' ESTIMATE                    
         B     ACCF7                                                            
         OI    JLSTAT1,JLS1APPV                                                 
         CLC   JBHIAPP,JBHIREV     ANY UNAPPROVED REVISIONS ?                   
         BE    ACCF7                                                            
         OI    JLSTAT1,JLS1UNAR                                                 
*                                                                               
ACCF7    MVI   ELCODE,ABLELQ       GET BALANCE ELEMENT                          
         L     R3,JLAJOB                                                        
         BRAS  RE,GETEL                                                         
         USING ABLELD,R3                                                        
         STCM  R3,15,JLAABLEL      SAVE ADDRESS OF BALANCE ELEMENT              
         ZAP   JLDBTS,ABLDR        DEBITS                                       
         ZAP   JLCRTS,ABLCR        CREDITS                                      
         ZAP   JLBALN,JLDBTS                                                    
         SP    JLBALN,JLCRTS       BALANCE                                      
*                                                                               
         MVI   ELCODE,JOBELQ                                                    
         L     R3,JLAJOB                                                        
         BRAS  RE,GETEL                                                         
         BNE   ACCF9                                                            
         STCM  R3,15,JLAJOBEL      SAVE ADDRESS OF BALANCE ELEMENT              
         USING JOBELD,R3                                                        
         MVC   JLSTA1,JOBSTA1      SAVE JOB STATUS BYTES                        
         MVC   JLSTA2,JOBSTA2                                                   
         MVC   JLOPNDT,JOBADATE    JOB OPEN DATE                                
         MVC   JLCLSDT,JOBCDATE    JOB CLOSE DATE                               
         TM    JOBSTA1,JOBSXJOB    IS IT AN X JOB ?                             
         BNO   *+8                                                              
         OI    JLSTAT4,JLS4XJOB                                                 
         TM    JLSTAT3,JLS3NEWS    JOB USES NEW ESTIMATES ?                     
         BO    *+16                                                             
         TM    JOBSTA1,JOBSUEST    UNAPPROVED ESTIMATE (OLD)                    
         BNO   *+8                                                              
         OI    JLSTAT3,JLS3UOLD                                                 
         CLI   GOBILFUN,YES        BILL ONLY FUNDED JOBS ?                      
         BNE   ACCF9               NO                                           
         TM    JOBSTA2,JOBSFUN     IS JOB FUNDED ?                              
         BO    *+8                 YES                                          
         OI    JLSTAT5,JLS5NFND    SET ERROR - NOT FUNDED                       
*                                                                               
ACCF9    CLI   JLBLCODE,JLBLPEST   % OF ESTIMATE BILL ?                         
         BNE   ACCF13                                                           
         CLI   JLRROPT,0           TEST RERUN/UNBILL                            
         BNE   ACCF11                                                           
         CLI   JOBLN,JOBLN3Q                                                    
         BL    ACCF13                                                           
         TM    JOBBIST,JOBB3BIL    3RD BILLING DONE ?                           
         BNO   ACCF10                                                           
         TM    JLOPTS2,JLOPRTLA    TEST RETAIL ADJUSTMENT                       
         BNO   ACCF13              NO,                                          
         NI    JOBBIST,X'FF'-(JOBB3BIL) YES, BACKUP OBE CYCLE                   
*                                                                               
ACCF10   LA    RF,PESTAB                                                        
         CLC   JOBBIST,0(RF)       MATCH CURRENT STATUS                         
         BE    *+20                                                             
         LA    RF,L'PESTAB(RF)                                                  
         CLI   0(RF),EOT                                                        
         BNE   *-18                                                             
         B     ACCF13                                                           
         MVC   JLPESTST,2(RF)      SAVE % OF ESTIMATE NEW STATUS                
         XR    R0,R0                                                            
         ICM   R0,1,1(RF)          # OF BUCKETS                                 
         STC   R0,JLCYCLE                                                       
         XR    R2,R2               CUMULATIVE %'S                               
         LA    RE,GOBILAM1                                                      
         ICM   R1,15,0(RE)                                                      
         AR    R2,R1                                                            
         LA    RE,4(RE)                                                         
         BCT   R0,*-10                                                          
         OC    CYCPER,CYCPER       PERCENT FROM CYCLE RECORD                    
         BZ    *+8                                                              
         ICM   R2,15,CYCPER                                                     
         CVD   R2,DUB                                                           
         ZAP   JLPEST,DUB          SAVE % OF ESTIMATE TO BILL                   
*                                                                               
ACCF11   MVC   DMCB(15),SPACES                                                  
         EDIT  JLPEST,(6,DMCB),2,ALIGN=LEFT                                     
         LA    R1,DMCB+3                                                        
         LA    R0,3                                                             
         CLC   0(3,R1),=C'.00'     100.00PC ESTIMATE                            
         BE    *+14                                                             
         BCTR  R1,0                                                             
         BCT   R0,*-12             BECOMES 100PC ESTIMATE                       
         B     *+10                                                             
         MVC   0(3,R1),SPACES      99.99PC ESTIMATE = 99.99PC ESTIMAT           
         LA    R1,DMCB+6                                                        
         CLI   0(R1),C' '                                                       
         BNE   *+8                                                              
         BCT   R1,*-8                                                           
         MVC   1(11,R1),=C'PC ESTIMATE'                                         
         MVC   JLBLNME,DMCB                                                     
*                                                                               
ACCF13   DS    0H                                                               
*                                                                               
ACCF15   BAS   RE,BLDUSR           BUILD TABLE OF USER FIELDS                   
*                                                                               
         MVI   ELCODE,LNKELQ       LINK DATA ELEMENT                            
         L     R3,JLAJOB                                                        
         BRAS  RE,GETEL                                                         
         BNE   ACCF17                                                           
         USING LNKELD,R3                                                        
         OC    LNKAGJB,LNKAGJB     AGENCY JOB LINK ?                            
         BNZ   *+12                                                             
         OI    JLSTAT2,JLS2MISL    MISSING LINK                                 
         B     ACCF17                                                           
         OI    JLSTAT2,JLS2LKAG                                                 
*                                                                               
*                                  BUILD TABLE OF ESTIMATES                     
ACCF17   MVI   BYTE,0                                                           
         LA    RF,JLAEWC           A(TABLE OF WORKCODE ESTIMATES)               
         BAS   RE,BLDEST           BUILD ESTIMATE TABLE                         
         CLI   JLBLCODE,JLBLPEST    %EST BILL                                   
         BNE   ACCF19                                                           
         CLI   JLRROPT,0           TEST RERUN/UNBILL                            
         BNE   ACCF19              YES, TABLE ALREADY BUILD                     
         LA    RF,JLAEWCB          A(TABLE OF WC ESTIMATES TO BILL)             
         MVI   BYTE,C'P'                                                        
         BAS   RE,BLDEST           BUILD ESTIMATE TABLE                         
         DROP  R3                                                               
*                                                                               
ACCF19   DS    0H                                                               
         MVC   JLLOREV,JBLOWREV    REVISION NUMBERS                             
         MVC   JLHIREV,JBHIREV                                                  
         MVC   JLHIAPP,JBHIAPP                                                  
*                                                                               
         ICM   R3,15,JBACOLTB                                                   
         USING JBCOLD,R3                                                        
         ZAP   JLCUNEST,JBCOLVAL      CURRENT NET   ESTIMATE                    
         ZAP   JLCUGEST,JBCOLVAL+6(6)    "    GROSS   "                         
         ZAP   JLHINEST,JBCOLVAL+12(6) HIGH   NET     "                         
         ZAP   JLHIGEST,JBCOLVAL+18(6)   "    GROSS   "                         
*                                                                               
         ZAP   PL13,JLCUNEST       CURRENT NET ESTIMATE                         
         MP    PL13,GOOVRPER        * OVER PCT.                                 
         SRP   PL13,64-4,5                                                      
         ZAP   JLCUNOVR,PL13       NET * OVER PERCENT                           
         ZAP   PL13,JLCUGEST       CURRENT GROSS ESTIMATE                       
         MP    PL13,GOOVRPER        * OVER PCT.                                 
         SRP   PL13,64-4,5                                                      
         ZAP   JLCUGOVR,PL13       GROSS * OVER ESTIMATE                        
*                                                                               
         ZAP   JLOVRMAX,JLCUNEST   CURRENT                                      
         AP    JLOVRMAX,GOOVRAMT   + OVER AMOUNT - MAX OVER                     
*                                                                               
         ZAP   PL13,JLCUNEST       CURRENT NET ESTIMATE                         
         MP    PL13,JLPEST         * % OF ESTIMATE TO BILL                      
         SRP   PL13,64-4,5                                                      
         ZAP   JLPCTAMT,PL13       AMOUNT OF %EST TO BILL                       
*                                                                               
         ZAP   JLHINOVR,JLHINEST     HIGH NET ESTIMATE                          
         ZAP   PL13,JLHINOVR                                                    
         MP    PL13,GOOVRPER        * OVER PCT.                                 
         SRP   PL13,64-4,5                                                      
         CP    PL13,PZERO                                                       
         BE    *+10                                                             
         ZAP   JLHINOVR,PL13                                                    
*                                                                               
         ZAP   JLHIGOVR,JLHIGEST     HIGH GROSS ESTIMATE                        
         ZAP   PL13,JLHIGOVR                                                    
         MP    PL13,GOOVRPER        * OVER PCT.                                 
         SRP   PL13,64-4,5                                                      
         CP    PL13,PZERO                                                       
         BE    *+10                                                             
         ZAP   JLHIGOVR,PL13                                                    
         DROP  R3                                                               
*                                                                               
         TM    JLOPTS,JLOPTRN      OPTION TO LOOK AHEAD                         
         BNO   *+8                                                              
         BAS   RE,RDTRN            READ TRANSACTIONS                            
         MVC   JLADTXT,ADTXT                                                    
*                                                                               
         OC    GOASPCT,GOASPCT                                                  
         BNZ   *+10                                                             
         ZAP   GOASPCT,PZERO                                                    
*                                                                               
         OC    JLARETLB,JLARETLB   TEST RETAIL DISTRIBUTION BUFFER              
         BZ    ACCF21                                                           
         TM    JLSTAT1,JLS1DIST    TEST DISTRIBUTION SCHEME                     
         BNO   ACCF21                                                           
         GOTOR RTL,DMCB,('RTLINIQ',(RC))                                        
*                                                                               
ACCF21   DS    0H                                                               
         CLI   JLBLCODE,JLBLSPCL   SPECIAL AMOUNT                               
         BNE   ACCF23                                                           
*                                                                               
         TM    JLSTAT1,JLS1DIST    TEST DISTRIBUTION SCHEME                     
         BNO   ACCF21B             NO,                                          
         TM    JLRROPT,JLRROUNB    TEST UNBILL                                  
         BNO   ACCF21D             NO, OK TO ADD                                
         B     ACCF23              ALREADY ADDED                                
*                                                                               
ACCF21B  TM    JLRROPT,JLRROUNB    TEST UNBILL                                  
         BO    ACCF22              YES,                                         
*                                                                               
ACCF21D  ICM   R1,15,GOBILAM1                                                   
         CVD   R1,DUB                                                           
         ZAP   JLSPCL,DUB                                                       
         ZAP   NET,JLSPCL                                                       
         ZAP   COMR,GOAGYCOM       GET CURRENT COMMISSION RATE                  
         OI    FLAG,COMRTL         COMMISSION APPLIES TO RETAIL                 
         BAS   RE,GETGRS                                                        
         NI    FLAG,ALL-COMRTL                                                  
ACCF22   LA    RF,JLAALLO                                                       
         BAS   RE,ADDSET                                                        
*                                                                               
ACCF23   CP    JLBALN,PZERO                                                     
         BNE    *+8                                                             
         OI    JLSTAT4,JLS4BZRO    BALANCE IS ZERO                              
*                                                                               
         CLC   JLLPSTDT,JLLESS6M                                                
         BNL   *+8                                                              
         OI    JLSTAT6,JLS6NACT    INACTIVE FOR SIX MONTHS                      
*                                                                               
         CLI   JLBLTYP,NOTB                                                     
         BNE   *+8                                                              
         OI    JLSTAT6,JLS6UNBT    UNBILLABLE TYPE                              
*                                                                               
         CP    JLCUNEST,PZERO                                                   
         BNE   *+8                                                              
         OI    JLSTAT7,JLS7EGTZ    CURRENT ESTIMATE > ZERO                      
*                                                                               
         CLC   JLCLSDT,JLTODAY1                                                 
         BNL   *+8                                                              
         OI    JLSTAT7,JLS7CLSD    CLOSE DATE < TODAY                           
*                                                                               
         CLI   JLLOREV,0                                                        
         BE    *+8                                                              
         OI    JLSTAT7,JLS7LRNZ    LOW REVISION NOT ZERO                        
*                                                                               
         CP    JLBIGBAL,PZERO      TEST BIG BALANCE NOT EQUAL ZERO              
         BE    *+18                                                             
         CP    JLBALN,JLBIGBAL                                                  
         BNH   *+8                                                              
         OI    JLSTAT7,JLS7BGTB    BALANCE > BIG BALANCE                        
*                                                                               
         CP    JLPEST,PZERO                                                     
         BNE   *+8                                                              
         OI    JLSTAT8,JLS8PCTZ    % EST = ZERO                                 
*                                                                               
         TM    JLSTAT1,JLS1DIST    TEST DISTRIBUTION SCHEME                     
         BO    *+18                YES, SKIP % EST TEST                         
         CP    JLPCTAMT,JLCRTS                                                  
         BNE   *+8                                                              
         OI    JLSTAT8,JLS8ESFB    %ESTIMATE - CREDITS                          
*                                                                               
         CLC   JLLBILDT,JLTODAY2                                                
         BNE   *+8                                                              
         OI    JLSTAT8,JLS8BLDD    BILLED TODAY                                 
*                                                                               
         CP    JLRTLUNT,PZERO                                                   
         BNE   *+8                                                              
         OI    JLSTAT2,JLS2NRTL    NO RETAIL UNITS                              
*                                                                               
         TM    JLRTLSTA,JLRTLSUN   TEST RETAIL UNITS                            
         BO    ACCF30                                                           
         CP    JLRTLUNT,PONEHDRD                                                
         BE    *+8                                                              
         OI    JLSTAT2,JLS2RNEQ    RETAIL UNITS NOT EQUAL 100.0000              
*                                                                               
ACCF30   ZAP   JLPBPCT,PZERO       PERCENT OF BILL %                            
         XC    JLPBACC,JLPBACC     POB ACCOUNT                                  
         XC    JLPBWRK,JLPBWRK     POB WORKCODE                                 
         TM    JLBLTYP,TOTL+ONEL+PROG                                           
         BZ    ACCF35                                                           
         OC    GOPBPCT,GOPBPCT     TEST POB                                     
         BZ    ACCF35                                                           
         ZAP   JLPBPCT,GOPBPCT     SAVE PERCENT                                 
         CP    JLPBPCT,PZERO                                                    
         BE    ACCF35                                                           
         OI    JLPBSTA,JLPBSPCT    SET STATUS                                   
         OC    JLPBACC,GOPBACC     SAVE ACCOUNT                                 
         BNZ   *+8                                                              
         OI    JLPBSTA,JLPBSMAC    MISSING ACCOUNT                              
         OC    JLPBWRK,GOPBWRK     SAVE WORKCODE                                
         BNZ   *+8                                                              
         OI    JLPBSTA,JLPBSMWC    MISSING WORKCODE                             
*                                                                               
ACCF35   CLC   JLWCFLT,SPACES                                                   
         BE    *+8                                                              
         OI    JLSTAT8,JLS8TWCF                                                 
*                                                                               
ACCF37   MVI   MODE,ACCFRST                                                     
         BAS   RE,XRUL             APPLY EXCEPTION RULES                        
         BAS   RE,UPEL1            SET ERRORS FOR CALLER                        
         BAS   RE,SETER                                                         
         J     XIT                                                              
         DROP  R7                                                               
         EJECT                                                                  
***********************************************************************         
* READ AND PROCESS TRANSACTIONS                                       *         
***********************************************************************         
                                                                                
RDTRN    NTR1  ,                                                                
         MVC   DATADISP,=Y(ACCRFST-ACCRECD)                                     
         MVC   DKEY,SPACES                                                      
         LA    R2,DKEY                                                          
         USING ACTRECD,R2                                                       
         L     RF,JLAJOB                                                        
         MVC   ACTKCULA,0(RF)      READ ACCOUNT DIRECTORY                       
         BRAS  RE,READ                                                          
*                                                                               
RDTRN3   BRAS  RE,RSEQ                                                          
         LA    R3,DIR                                                           
         USING TRNRECD,R3                                                       
         CLC   ACTKCULA,TRNKCULA   SAME JOB ?                                   
         BNE   RDTRN9                                                           
         CLC   TRNKREF,SPACES      SKIP BUCKETS                                 
         BNH   RDTRN3                                                           
         TM    JLOPTS,JLOPDRFT     INCLUDE DRAFTS ?                             
         BO    *+12                                                             
         TM    TRNKSTAT,TRNSDRFT                                                
         BO    RDTRN3              SKIP DRAFTS                                  
         TM    TRNKSTAT,TRNSREVS                                                
         BO    RDTRN3              AND REVERSALS                                
         LA    RF,TRNKWORK                                                      
         BAS   RE,WCFLT            WORK CODE FILTER                             
         BNE   RDTRN3                                                           
*                                                                               
         MVC   AIO,AIO2                                                         
         BRAS  RE,GETR                                                          
         L     R3,AIO2                                                          
         BAS   RE,PTRN1                                                         
         B     RDTRN3                                                           
*                                                                               
RDTRN9   BAS   RE,ACCL1                                                         
         TM    JLOPTS,JLOPMST                                                   
         BO    *+10                                                             
         MVC   DATADISP,=Y(ACCORFST)                                            
         J     XIT                                                              
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* PROCESS A TRANSACTION                                               *         
***********************************************************************         
                                                                                
PTRN     L     R3,JLATRN           TRANSACTION FROM CALLER                      
         USING TRNRECD,R3                                                       
         BAS   RE,PTRN1                                                         
         J     XIT                                                              
                                                                                
PTRN1    NTR1  ,                                                                
         ST    R3,ADTRNR                                                        
         CLI   JLRROPT,0           RERUN OR UNBILL OPTION                       
         BE    PTRN3                                                            
         GOTOR RERN,DMCB,(RC)                                                   
         BE    PTRN3                                                            
         OI    JLTSTAT2,JLTS2NRR   SET 'NOT IN RERUN'                           
         J     XITN                                                             
*                                                                               
PTRN3    LA    RF,TRNKWORK                                                      
         BAS   RE,WCFLT            WORK CODE FILTER                             
         JNE   XIT                                                              
         LA    R0,JLTBN            INITIALISE ALL TRANSACTION FIELDS            
         LA    R1,JLTB                                                          
         ZAP   0(L'JLBK,R1),PZERO                                               
         LA    R1,L'JLBK(R1)                                                    
         BCT   R0,*-10                                                          
*                                                                               
         LA    R0,LBKN             INITIALISE LOCAL ACCUMULATORS                
         LA    R1,LBK                                                           
         ZAP   0(L'LBK,R1),PZERO                                                
         LA    R1,L'LBK(R1)                                                     
         BCT   R0,*-10                                                          
*                                                                               
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         LA    R0,JLRTNT           CLEAR JOBLOT RETURN DATA                     
         LA    R1,JLRTNTLQ                                                      
         MVCL  R0,RE                                                            
*                                                                               
         ZAP   COMR,GOAGYCOM       GET CURRENT COMMISSION RATE                  
*                                                                               
         CLC   TRNKWORK,JLORDRQ    IS IT AN ORDER ?                             
         BNE   PTRN7                                                            
         MVI   ELCODE,OAMELQ                                                    
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
PTRN5    BRAS  RE,NEXTEL                                                        
         JNE   XIT                                                              
         USING OAMELD,R3                                                        
         ZAP   NET,OAMAMNT         ORIGINAL ORDER AMOUNT                        
         AP    JLAONET,NET                                                      
         ZAP   CSD,PZERO                                                        
         MVC   WCODE,OAMWORK                                                    
         BAS   RE,GETWC            GET WORKCODE ENTRY                           
         BAS   RE,GETGRS           GET GROSS AMOUNT                             
         AP    JLAOGRS,GRS                                                      
         B     PTRN5                                                            
*                                                                               
PTRN7    MVI   ELCODE,TRNELQ       GET TRANSACTION ELEMENT                      
         BRAS  RE,GETEL                                                         
         JNE   XIT                                                              
         LR    R2,R3                                                            
         USING TRNELD,R2                                                        
         STCM  R2,15,JLATRNEL      SAVE A(TRNEL)                                
         MVC   JLTSTAT1,TRNSTAT    SAVE STATUS                                  
         MVC   WCODE,TRNANAL                                                    
*                                                                               
         CLC   WCODE,JLBILLQ                                                    
         BE    PTRN99              PREVIOUS BILLING                             
         BAS   RE,GETWC            GET WORKCODE ENTRY                           
*                                                                               
         LA    R7,JLTTOT                                                        
         USING JLBKD,R7                                                         
*                                                                               
         TM    JLTNS,JLTNSUNH      TREAT AS UNHELD                              
         BO    PTRN8                                                            
         TM    JLTSTAT1,TRNSHOLD   IS IT HELD ?                                 
         BNO   PTRN8                                                            
         OI    JLSTAT1,JLS1HELD    SET JOB HAS HELD INVOICES                    
         J     XIT                                                              
*                                                                               
PTRN8    AP    JLBNET,TRNAMNT      TOTAL NET                                    
         LA    R4,WCEL             R2=A(WORKCODE ELEMENT)                       
         USING WCOELD,R4                                                        
         TM    WCOSTAT,WCOSMEDT    MEDIA TRANSFER                               
         BNO   *+10                                                             
         AP    JLBMED,TRNAMNT      TOTAL MEDIA                                  
         DROP  R4                                                               
*                                                                               
         L     R3,ADTRNR                                                        
         USING TRNRECD,R3                                                       
         CLC   TRNKCUNT(2),=C'SK'  SK CONTRA                                    
         BE    PTRN9                                                            
         LR    R3,R2                                                            
         MVI   ELCODE,SPDELQ                                                    
         BRAS  RE,NEXTEL                                                        
         BNE   PTRN11                                                           
         USING SPDELD,R3                                                        
         CLC   SPDACCS(2),=C'SK'   SK IN ELEMENT (CONTRA 1R)                    
         BNE   PTRN11                                                           
PTRN9    ZAP   SKINC,TRNAMNT       SAVE AMOUNT FOR THIS TRANSACTION             
*                                                                               
PTRN11   LR    R3,R2                                                            
         MVI   ELCODE,TRXELQ       GET EXTRA STATUS ELEMENT                     
         BRAS  RE,NEXTEL                                                        
         BNE   PTRN13                                                           
         STCM  R3,15,JLATRXEL                                                   
         USING TRXELD,R3                                                        
         TM    TRXSTA2,TRXSXFRP+TRXSWOFP+TRXSBILP                               
         BZ    *+8                 TRANX, WO OR BILL ACT. PENDING               
         OI    JLTSTAT2,JLTS2PND                                                
*                                                                               
PTRN13   LR    R3,R2                                                            
         MVI   ELCODE,TRSELQ       TRANSACTION STATUS ELEMENT                   
         BRAS  RE,NEXTEL                                                        
         STCM  R3,15,JLATRSEL                                                   
         USING TRSELD,R3                                                        
         MVC   MOS,TRSPMOS         SAVE MOS                                     
*                                                                               
         TM    TRSSTAT3,TRSSNBIL   IS IT BILLABLE ?                             
         BNO   *+8                                                              
         OI    JLTSTAT2,JLTS2NTB                                                
*                                                                               
         OC    TRSUDAT,TRSUDAT     FULLY BILLED ?                               
         BZ    *+8                                                              
         OI    JLTSTAT2,JLTS2FBL                                                
*                                                                               
         CP    SKINC,PZERO         TEST INTERNAL INCOME                         
         BE    PTRN14              NO,                                          
         CLI   JLRROPT,0           RERUN OR UNBILL OPTION                       
         BE    PTRN13A             NO,                                          
         CLC   JLRRADT,TRSUDAT     TEST THIS IS BILLED DATE                     
         BNE   PTRN14              NO, SKIP INTERNAL INCOME                     
         B     PTRN13C             YES, RECORD INTERNAL INCOME                  
PTRN13A  TM    JLTSTAT2,JLTS2FBL   TEST FULLY BILLED                            
         BO    PTRN14              YES,                                         
PTRN13C  ZAP   JLBSKI,SKINC        OK TO RECORD INTERNAL INCOME                 
*                                                                               
PTRN14   LR    R3,R2                                                            
         MVI   ELCODE,SCIELQ       GET CASH DISCOUNT                            
         BRAS  RE,NEXTEL                                                        
         BNE   PTRN15                                                           
         USING SCIELD,R3                                                        
         CLI   SCITYPE,SCITCDSC                                                 
         BNE   *-12                                                             
         AP    JLBCSD,SCIAMNT      TOTAL CASH DISCOUNT                          
*                                                                               
PTRN15   XC    APTARRL,APTARRL     CLEAR ADDRESS OF RERUN PTAEL                 
         CLC   JLRRBILL,SPACES     IS THERE A RERUN/UNBILL NUMBER ?             
         BNH   PTRN19                                                           
         LR    R3,R2                                                            
         MVI   ELCODE,PTAELQ       PROD. TRANSACTION ACTIVITY                   
PTRN17   BRAS  RE,NEXTEL                                                        
         BNE   PTRN19                                                           
         USING PTAELD,R3                                                        
         CLI   PTATYPE,0                                                        
         BE    PTRN17                                                           
         CLC   JLRRBILL,PTARBLNO   THIS IS ELEMENT FOR RERUN/UNBILL ?           
         BNE   PTRN17                                                           
         ST    R3,APTARRL          SAVE A(PTAEL FOR RERUN)                      
*                                                                               
PTRN19   LR    R3,R2                                                            
         MVI   ELCODE,PRTELQ       GET PERSONNEL RATE                           
         BRAS  RE,NEXTEL                                                        
         BNE   PTRN21                                                           
         USING PRTELD,R3                                                        
         STCM  R3,15,JLAPRTEL                                                   
         AP    JLBHRS,PRTHOUR      HOURS                                        
*                                                                               
PTRN21   LR    R3,R2                                                            
         MVI   ELCODE,UNPELQ       GET UNIT PRICING                             
         BRAS  RE,NEXTEL                                                        
         BNE   PTRN23                                                           
         USING UNPELD,R3                                                        
         TM    UNPSTAT,UNPSQTRH    TEST HOURS                                   
         BNO   *+10                                                             
         AP    JLBHRS,UNPUNIT      ADD TO HOURS                                 
*                                                                               
PTRN23   ZAP   NET,JLBNET          NET                                          
         ZAP   CSD,JLBCSD          CD                                           
         OI    FLAG,COMRTL         COMMISSION APPLIES TO RETAIL                 
         BAS   RE,GETGRS           GET COMMISSION & GROSS                       
         NI    FLAG,ALL-COMRTL                                                  
         ZAP   JLBGRS,GRS                                                       
         ZAP   JLBCOM,COM                                                       
         DROP  R7                                                               
*                                                                               
         LR    R3,R2               ** OLD BNDEL ELEMENTS **                     
         MVI   ELCODE,BNDELQ       GET BILL NUMBER/DATE ELEMENT                 
PTRN25   BRAS  RE,NEXTEL                                                        
         BNE   PTRN27                                                           
         USING BNDELD,R3                                                        
         OC    BNDBNO,BNDBNO       IS IT A SPARE ELEMENT ?                      
         BZ    PTRN25                                                           
         ICM   RF,15,BNDAMNT       NET                                          
         CVD   RF,DUB                                                           
         ZAP   NET,DUB                                                          
         ICM   RF,15,BNDCSD        CASH DISCOUNT                                
         CVD   RF,DUB                                                           
         ZAP   CSD,DUB                                                          
         ICM   RF,15,BNDCMP        COMMISSION RATE                              
         CVD   RF,DUB                                                           
         TM    BNDCMP,BNDCPACK     COMMISSION RATE IS PACKED                    
         BNO   *+10                                                             
         ZAP   DUB,BNDCMP                                                       
         ZAP   COMR,DUB                                                         
         BAS   RE,GETGRS           GET COMMISSION & GROSS                       
*                                                                               
         LA    RF,JLTALLO          ASSUME ALLOCATED                             
         CLC   BNDBNO,SPACES       IS IT AN ALLOCATION ELEMENT ?                
         BNH   *+8                                                              
         LA    RF,JLTBILL          SET FOR BILLED                               
         BAS   RE,ADDSET           ADD TO TRANSACTION BUCKETS                   
         B     PTRN25                                                           
*                                                                               
PTRN27   LR    R3,R2               ** PTAEL ELEMENTS **                         
         MVI   ELCODE,PTAELQ       PROD. TRANSACTION ACTIVITY                   
PTRN29   BRAS  RE,NEXTEL                                                        
         BNE   PTRN37                                                           
         USING PTAELD,R3                                                        
         CLI   PTATYPE,0                                                        
         BE    PTRN29                                                           
         OC    JLRRBILL,JLRRBILL                                                
         BZ    PTRN31                                                           
         TM    PTASTAT1,PTASREVS+PTASREVU                                       
         BNZ   PTRN29              SKIP REVERSALS                               
         CLC   JLRRBILL,PTARBLNO   THIS IS ELEMENT FOR RERUN/UNBILL ?           
         BNE   PTRN31                                                           
         NI    JLTSTAT2,ALL-(JLTS2FBL) TURNOFF 'FULLY-BILLED'                   
         B     PTRN29              EXCLUDE FROM BILLED TOTALS                   
*                                                                               
PTRN31   ZAP   NET,PTANET          NET                                          
         ZAP   CSD,PTACDSC         CASH DISCOUNT                                
         LH    R1,PTAHOURS         HOURS                                        
         CVD   R1,DUB                                                           
         ZAP   HRS,DUB                                                          
         CLI   PTATYPE,PTATRAL     REGULAR ALLOCATION                           
         BNE   PTRN33                                                           
         ZAP   COM,PTARCOM         COMMISSION                                   
         LA    RF,JLTALLO          ASSUME ALLOCATED                             
         TM    PTASTAT1,PTASPEND   IS IT PENDING ?                              
         BO    PTRN35                                                           
         LA    RF,JLTBILL          SET FOR BILLED                               
         B     PTRN35                                                           
*                                                                               
PTRN33   LA    RF,JLTWOFF          SET FOR WRITEOFF                             
         CLI   PTATYPE,PTATWOF     WRITEOFF ?                                   
         BNE   *+12                                                             
         OI    JLTSTAT2,JLTS2WO                                                 
         B     PTRN35                                                           
         CLI   PTATYPE,PTATWOFR    W/O RECOVERY ?                               
         BNE   *+12                                                             
         OI    JLTSTAT2,JLTS2WOR                                                
         B     PTRN35                                                           
         LA    RF,JLTTRNX          SET FOR TRANSFER                             
         CLI   PTATYPE,PTATTRFF                                                 
         BNE   PTRN29              TRANSFER FROM OR TO                          
*                                                                               
PTRN35   ZAP   GRS,NET                                                          
         AP    GRS,CSD                                                          
         AP    GRS,COM             GROSS=NET+CD+COMM                            
         BAS   RE,ADDSET           ADD TO TRANSACTION BUCKETS                   
         B     PTRN29                                                           
*                                                                               
PTRN37   CLI   JLBLCODE,JLBLCLNT   IS IT CLIENT BILLING ?                       
         BE    PTRN41              LEAVE ALLOCATED(BILLABLE) AS IS              
         CLI   JLBLCODE,JLBLSPCL   IS IT SPECIAL BILLING ?                      
         BE    PTRN41              LEAVE ALLOCATED(BILLABLE) AS IS              
         TM    JLTSTAT2,JLTS2FBL   IS TRANSACTION FULLY BILLED ?                
         BNO   PTRN39                                                           
         MVC   JLTBILL,JLTTOT      SET BILLED ACCUMS = TOTAL                    
         CLI   JLBLCODE,JLBLTOTL   IS IT TOTAL BILLING ?                        
         BNE   *+10                                                             
         MVC   JLTALLO,JLTTOT      SET ALLOCATED TO BILL = TOTAL                
         B     PTRN41                                                           
*                                                                               
PTRN39   TM    JLTSTAT2,JLTS2PND   IS TRANSACTION PENDING ?                     
         JO    XIT                 JUST SKIP IT                                 
         TM    JLTSTAT1,TRNSHOLD   IS IT HELD ?                                 
         JO    XIT                                                              
         CP    JLTBILL+(JLBNET-JLBKD)(L'JLBK),PZERO TEST BILLED= ZERO           
         BNE   *+8                                                              
         OI    JLTSTAT2,JLTS2NEW   SET NEW ITEM                                 
         MVC   JLTALLO,JLTTOT      SET ALLOCATED = TOTAL                        
         LA    R3,JLTBILL                                                       
         LA    R4,JLTALLO                                                       
         CLI   JLBLCODE,JLBLTOTL   IS IT TOTAL BILLING ?                        
         BE    *+8                 DON'T TAKE FROM BILLABLE - USE 99'S          
         BAS   RE,SUBSET           SUBTRACT BILLED FROM ALLOCATED               
         LA    R3,JLTTRNX                                                       
         LA    R4,JLTALLO                                                       
         BAS   RE,SUBSET           SUBTRACT TRANSFERS FROM ALLOCATED            
         LA    R3,JLTWOFF                                                       
         LA    R4,JLTALLO                                                       
         BAS   RE,SUBSET           SUBTRACT WRITEOFFS FROM ALLOCATED            
*                                                                               
PTRN41   LA    R0,JLTBN            ADD TRANSACTION TO ACCOUNT BUCKETS           
         LA    RE,JLTB                                                          
         LA    RF,JLAB                                                          
         AP    0(L'JLBK,RF),0(L'JLBK,RE)                                        
         LA    RE,L'JLBK(RE)                                                    
         LA    RF,L'JLBK(RF)                                                    
         BCT   R0,*-14                                                          
         J     XIT                                                              
         DROP  R2,R3                                                            
         EJECT                                                                  
*                                  TRANSACTION VALUES TO BUCKETS                
*                                                                               
PTRN99   L     R3,ADTRNR           CREDITS                                      
         USING TRNRECD,R3                                                       
         L     R2,JLATRNEL                                                      
         USING TRNELD,R2                                                        
         MVI   BYTE,0                                                           
         OI    JLSTAT4,JLS4BILL    SET - JOB HAS BILLING                        
         CLI   TRNKCUNT,C'3'       ANY RETAIL BILLING ?                         
         BNE   *+8                                                              
         OI    JLSTAT1,JLS1RET                                                  
         MVI   BYTE,JLS1NCLB       SET NON-CLIENT BILLS                         
         CLC   TRNNARR(9),=C'CLIENT WP'   ANY $BILL ?                           
         BNE   *+8                                                              
         MVI   BYTE,JLS1CLB        SET CLIENT (ALLOCATED BILLING)               
         CLI   TRNNARR,C'A'        ANY ALLOCATED BILLING ?                      
         BNE   *+8                                                              
         MVI   BYTE,JLS1CLB                                                     
         OC    JLSTAT1,BYTE                                                     
         LA    R7,JLTTOT           GET BILLED AMOUNTS                           
         USING JLBKD,R7                                                         
         ZAP   JLBNET,TRNAMNT      TOTAL NET                                    
         ZAP   JLBCSD,TRNBLCD                                                   
         CLI   TRNLN,TRNLN2Q                                                    
         BL    *+10                                                             
         ZAP   JLBCOM,TRNBLCOM     COMMISSION                                   
*                                                                               
         AP    JLBNET,JLBCSD       ADD CD TO NET                                
         ZAP   JLBGRS,JLBNET       NET + COMMISSION = GROSS                     
         AP    JLBGRS,JLBCOM                                                    
*                                                                               
         OC    JLARETLB,JLARETLB   TEST RETAIL DISTRIBUTION                     
         JZ    XIT                                                              
         TM    JLSTAT1,JLS1DIST    TEST DISTRIBUTION SCHEME                     
         JNO   XIT                                                              
         GOTOR RTL,DMCB,('RTLPRBQ',(RC))                                        
         J     XIT                                                              
*                                                                               
         DROP  R2,R3,R7                                                         
         EJECT                                                                  
***********************************************************************         
* LAST FOR ACCOUNT                                                    *         
***********************************************************************         
                                                                                
ACCL     BAS   RE,ACCL1                                                         
         J     XIT                                                              
*                                                                               
ACCL1    NTR1  ,                                                                
         MVC   UNBIL,JLATOT          TOTAL                                      
         LA    R4,UNBIL                                                         
         LA    R3,JLABILL            LESS: BILLED                               
         BAS   RE,SUBSET                                                        
         LA    R4,UNBIL                                                         
         LA    R3,JLATRNX                  TRANSFERRED                          
         BAS   RE,SUBSET                                                        
         LA    R4,UNBIL                                                         
         LA    R3,JLAWOFF                  WRITTEN OFF                          
         BAS   RE,SUBSET                                                        
*                                                                               
         LA    R0,JLBKRN                                                        
         LA    R1,UNBIL                                                         
         CP    0(L'JLBK,R1),PZERO                                               
         BNE   ACCL3                                                            
         LA    R1,L'JLBK(R1)                                                    
         BCT   R0,*-14                                                          
         CP    UNBIL+(JLBK-JLBNET)(L'JLBK),JLCRTS                               
         BNE   ACCL3                                                            
         OI    JLSTAT4,JLS4FULB    SET FULLY BILLED                             
*                                                                               
ACCL3    ZAP   ESACBL,JLCUNEST     ESTIMATE                                     
         AP    ESACBL,JLDBTS        + DEBITS                                    
         AP    ESACBL,JLCRTS        + CREDITS                                   
*                                                                               
         OC    JLARETLB,JLARETLB   TEST RETAIL DISTRIBUTION                     
         BZ    ACCL5                                                            
         TM    JLSTAT1,JLS1DIST    TEST DISTRIBUTION SCHEME                     
         BNO   ACCL5                                                            
         GOTOR RTL,DMCB,('RTLALLQ',(RC))                                        
*                                                                               
ACCL5    LA    R7,JLAALLO                                                       
X        USING JLBKD,R7                                                         
*                                                                               
         CP    X.JLBNET,GOMINBIL                                                
         BNL   *+8                                                              
         OI    JLSTAT6,JLS6ULTM    UNBILLED < MINIMUM                           
*                                                                               
         CP    X.JLBNET,P1DLR                                                   
         BNH   *+8                                                              
         OI    JLSTAT6,JLS6UGT1    UNBILLED > $1.00                             
*                                                                               
         LA    R7,JLATOT                                                        
         CP    X.JLBNET,JLCUNOVR                                                
         BNH   *+8                                                              
         OI    JLSTAT6,JLS6NGTE    NET > ESTIMATE                               
*                                                                               
         CP    JLCUNEST,PZERO                                                   
         BE    *+8                                                              
         OI    JLSTAT6,JLS6NZRO    CURRENT ESTIMATE IS NOT ZERO                 
*                                                                               
         CP    JLPCTAMT,GOMINBIL                                                
         BNL   *+8                                                              
         OI    JLSTAT6,JLS6PLTM    %ESTIMATE < MINIMUM                          
*                                                                               
         CP    X.JLBNET,JLPCTAMT                                                
         BNH   *+8                                                              
         OI    JLSTAT6,JLS6GTPE     OVER % OF ESTIMATE AMOUNT                   
*                                                                               
         CP    X.JLBNET,PZERO                                                   
         BE    *+8                                                              
         OI    JLSTAT7,JLS7NGTZ     NET > ZERO                                  
*                                                                               
         CP    JLAONET,JLCUNOVR                                                 
         BNH   *+8                                                              
         OI    JLSTAT7,JLS7OGTE    ORDERED + NET > MAX EST                      
*                                                                               
         CP    GOOVRAMT,PZERO      OVER AMOUNT NOT ZERO                         
         BE    *+18                                                             
         CP    X.JLBNET,JLOVRMAX                                                
         BNH   *+8                                                              
         OI    JLSTAT8,JLS8OVMX     ACTUAL > MAX                                
*                                                                               
         CP    JLCUGOVR,PZERO       GROSS ESTIMATE  ZERO                        
         BE    *+18                                                             
         CP    X.JLBGRS,JLCUGOVR                                                
         BNH   *+8                  GROSS > ESTIMATE GROSS                      
         OI    JLSTAT8,JLS8GRPO     ACTUAL > MAX                                
*                                                                               
         CP    X.JLBNET,JLHINOVR                                                
         BH    *+8                                                              
         OI    JLSTAT8,JLS8NLTH     ACT. NET < = HIGH NET EST * OVR             
*                                                                               
         MVI   MODE,ACCLAST                                                     
         BAS   RE,XRUL             APPLY EXCEPTION RULES                        
         BAS   RE,UPEL1            SET ERRORS FOR CALLER                        
         BAS   RE,SETER                                                         
         J     XIT                                                              
         DROP  X                                                                
         EJECT                                                                  
***********************************************************************         
* BUILD TABLE OF USER FIELDS                                          *         
***********************************************************************         
                                                                                
BLDUSR   NTR1  ,                                                                
         ICM   R2,15,JLAUSRF       TEST USER FIELDS REQUESTED                   
         JZ    XIT                 NOT NEEDED                                   
         MVI   0(R2),EOT           MARK END OF TABLE                            
*                                                                               
         MVI   ELCODE,JFNELQ       CHECK FOR FUND ELEMENT                       
         L     R3,JLAJOB                                                        
         BRAS  RE,GETEL                                                         
         BNE   BLDUSR3                                                          
         USING JFNELD,R3                                                        
         XC    DKEY,DKEY                                                        
         LA    R2,DKEY                                                          
         USING AUTRECD,R2                                                       
         MVI   AUTKTYP,AUTKTYPQ    GET AUTHORIZATION RECORD                     
         MVI   AUTKSUB,AUTKSUBQ                                                 
         MVC   AUTKOGR(L'JFNKEY),JFNKEY                                         
         L     RF,JLAJOB                                                        
         MVC   AUTKCUL,0(RF)                                                    
         BRAS  RE,HIGH                                                          
         BE    *+12                                                             
         OI    JLSTAT5,JLS5MAUR    SET 'MISSING AUTHORIZATION'                  
         B     BLDUSR3                                                          
*                                                                               
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         MVI   BYTE,C'A'           SET ' AUTHORIZATION RECORD'                  
         MVI   ELCODE,UFSELQ       CHECK USER FIELDS(AUTH RECORD)               
         L     R3,AIO3                                                          
         BRAS  RE,GETELN                                                        
         BNE   *+8                                                              
         BAS   RE,BLDUSX           BUILD USER FIELD TABLE                       
*                                                                               
BLDUSR3  MVI   BYTE,C' '           SET 'NOT AUTHORIZATION RECORD'               
         MVI   ELCODE,UFSELQ       CHECK USER FIELDS                            
         L     R3,JLAJOB                                                        
         BRAS  RE,GETEL                                                         
         BNE   *+8                                                              
         BAS   RE,BLDUSX           BUILD USER FIELD TABLE                       
         J     XIT                                                              
         DROP  R2,R3                                                            
*                                                                               
R        USING UFSELD,R3           R.RECORD                                     
BLDUSX   ST    RE,SVRE                                                          
         ICM   R2,15,JLAUSRF       R2=A(USER TABLE)                             
         USING USRFD,R2                                                         
BLDUSX3  TM    R.UFSSTAT,USRFSALL  SHOW ON/NEED FOR BILLS, RCV                  
         BZ    BLDUSX13                                                         
         LA    R0,1                SET NEW ITEM FLAG                            
         CLI   BYTE,C'A'           TEST AUTHORIZATION RECORD                    
         BE    BLDUSX7             OK TO ADD TO TABLE                           
         ICM   R2,15,JLAUSRF       ELSE START FROM TOP                          
*                                                                               
BLDUSX5  LA    R0,1                NEW ITEM FLAG                                
         CLI   0(R2),EOT           TEST EOT                                     
         BE    BLDUSX7                                                          
         LA    R4,USRFLM                                                        
T        USING UFSELD,R4           T.TABLE                                      
         CLC   T.UFSDESC,R.UFSDESC SAME DESCRIPTION                             
         BNE   BLDUSX6                                                          
         XR    R0,R0               SET OVERRIDE FLAG                            
         TM    USRFIND,USRFIAUT    OVERRRIDE AUTHORIZATION ELEMENT              
         BO    BLDUSX7             YES, OK TO OVERRIDE                          
BLDUSX6  LA    R2,USRFLNQ(R2)                                                   
         B     BLDUSX5                                                          
*                                                                               
BLDUSX7  XC    USRFD(USRFLNQ),USRFD                                             
         CLI   BYTE,C'A'                                                        
         BNE   *+8                                                              
         OI    USRFIND,USRFIAUT    SET FROM AUTHORIZATION RECORD                
         SR    RF,RF                                                            
         IC    RF,R.UFSLN                                                       
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   USRFLM(0),R.UFSELD  SAVE ELEMENT                                 
         SHI   RF,UFSLN1Q-1                                                     
         BZ    BLDUSX9             BRANCH IF NO DATA                            
         STC   RF,USRFDLEN         SAVE LENGTH OF DATA                          
         B     BLDUSX11                                                         
*                                                                               
BLDUSX9  TM    R.UFSSTAT,UFSSNEBI  NEEDED FOR BILLING ?                         
         BNO   BLDUSX11                                                         
         OI    JLSTAT1,JLS1MUSR    SET MISSING USER FIELD                       
         OI    USRFIND,USRFIMIS                                                 
*                                                                               
BLDUSX11 LTR   R0,R0               IS THIS AN OVERRIDE ?                        
         BZ    BLDUSX13            YES, DON'T SET NEW EOT                       
         LA    R2,USRFLNQ(R2)                                                   
         MVI   0(R2),X'FF'                                                      
         LR    R0,R2                                                            
         A     R0,JLLUSRF          R0 = A(END OF TABLE)                         
         CR    R2,R0               TEST EOT                                     
         BL    *+6                                                              
         DC    H'0'                USER FIELD TABLE IS FULL                     
*                                                                               
BLDUSX13 BRAS  RE,NEXTEL                                                        
         BE    BLDUSX3                                                          
         L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  R2,R,T                                                           
         EJECT                                                                  
***********************************************************************         
* BUILD TABLE OF WORKCODE ESTIMATES                                   *         
*  RF= A(OUTPUT TABLE), F(TABLE LENGTH)                               *         
*  BYTE = P  (APPLY % OF ESTIMATE TO BILL                             *         
***********************************************************************         
                                                                                
BLDEST   NTR1  ,                                                                
         ICM   R2,15,0(RF)         R2=A(OUTPUT TABLE)                           
         JZ    XIT                                                              
         USING JLEWD,R2                                                         
         MVI   0(R2),EOT                                                        
         ICM   RE,15,4(RF)         RE=LENGTH OF TABLE AREA                      
         JZ    XIT                                                              
         SRDA  RE,32                                                            
         LA    R1,JLEWLNQ          GET MAXIMUM NUMBER OF ITEMS                  
         DR    RE,R1                                                            
         ICM   R3,15,JBACOLTB                                                   
         USING JBCOLD,R3                                                        
         ICM   R1,3,JBNROWS                                                     
         JZ    XIT                                                              
*                                                                               
BLDEST3  CLI   JBCOLTYP,JBCOLTWC        TEST WORKCODE ENTRY                     
         BNE   BLDEST7                                                          
         CP    JBCOLVAL(6),PZERO        SKIP  NET = 0                           
         BE    BLDEST7                                                          
         LA    RF,JBCOLWC                                                       
         BAS   RE,WCFLT                WORKCODE FILTER                          
         BNE   BLDEST7                                                          
         MVC   JLEWWC,JBCOLWC           WORKCODE TO TABLE                       
         ZAP   JLEWNET,JBCOLVAL(6)      CURRENT ESTIMATE - NET                  
         ZAP   JLEWGRS,JBCOLVAL+6(6)                     - GROSS                
         ZAP   JLEWCOMR,PZERO                                                   
         OC    JBCOLCOM,JBCOLCOM                                                
         BZ    *+10                                                             
         ZAP   JLEWCOMR,JBCOLCOM                                                
         CLI   BYTE,C'P'               IS IT % OF ESTIMATE ?                    
         BNE   BLDEST5                                                          
*                                                                               
*                                      NOW GET BILLABLE AMOUNTS BY WC           
         ZAP   PL13,JBCOLVAL(6)          NET                                    
         MP    PL13,JLPEST               * % OF EST                             
         SRP   PL13,64-4,5                                                      
         ZAP   JLEWNET,PL13                                                     
         ZAP   JLEWGRS,PL13                                                     
         CP    JLEWCOMR,PZERO                                                   
         BE    BLDEST5                                                          
         CLI   GOESTCOM,YES                                                     
         BNE   BLDEST5                                                          
         MP    PL13,JLEWCOMR            * COMMISSION                            
         SRP   PL13,64-6,5                                                      
         AP    JLEWGRS,PL13                                                     
*                                                                               
BLDEST5  LA    R2,JLEWLNQ(R2)                                                   
         BCT   RF,*+6                                                           
         DC    H'0'                TABLE OF WORKCODE ESTIMATES IS FULL          
         MVI   0(R2),EOT                                                        
*                                                                               
BLDEST7  AH    R3,JBLCOL                                                        
         BCT   R1,BLDEST3                                                       
         J     XIT                                                              
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* READ CYCLE RECORD TO DETERMINE BILLTYPE                             *         
***********************************************************************         
                                                                                
GETCYC   NTR1  ,                                                                
         MVI   BYTE,JLBLTOTL       ASSUME TOTAL                                 
         OI    JLSTAT5,JLS5AUTO    SET 'AUTO' BILL TYPE                         
         XC    JLCYCDA,JLCYCDA                                                  
         XC    JLCYCLE,JLCYCLE                                                  
         LA    R0,TKEY             SAVE ACCOUNT KEY                             
         ST    R0,ATKEY                                                         
         GOTO1 DATAMGR,DMCB,DMKEY,ACCDIR,(R0)                                   
*                                                                               
         XC    DKEY,DKEY                                                        
         LA    R2,DKEY                                                          
         USING JCBRECD,R2                                                       
         MVI   JCBKTYP,JCBKTYPQ    GET CYCLE BILLING RECORD                     
         MVI   JCBKSUB,JCBKSUBQ                                                 
         MVC   JCBKCUL,GOSELCUL                                                 
         MVC   JCBKCLI,GOSELCLI                                                 
         MVC   JCBKPRO,GOSELPRO                                                 
         MVC   JCBKJOB,GOSELJOB                                                 
         BRAS  RE,HIGH                                                          
         BNE   GETCYCN             RECORD NOT FOUND -  ERROR                    
*                                                                               
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         L     R3,AIO3                                                          
         MVI   ELCODE,BCYELQ                                                    
         BRAS  RE,GETELN                                                        
         B     *+8                                                              
GETCYC3  BRAS  RE,NEXTEL                                                        
         BNE   GETCYCN                                                          
*                                                                               
         USING BCYELD,R3                                                        
GETCYC7  TM    JLRROPT,JLRROUNB    TEST UNBILL                                  
         BO    GETCYC11                                                         
         OC    BCYBILD,BCYBILD     WAS THIS ONE BILLED ?                        
         BNZ   GETCYC3             YES, LOOK AT NEXT ONE                        
         CLC   JLMOA,BCYMON        GET CORRECT MONTH                            
         BE    GETCYC9                                                          
         TM    BCYSTAT,BCYSMON     CHECK IF DATE HIGHER ALSO ?                  
         BNO   GETCYCS             SEQUENCE ERROR                               
         CLC   JLMOA,BCYMON                                                     
         BH    GETCYCS             SEQUENCE ERROR                               
*                                                                               
GETCYC9  CLI   BCYPER,X'FF'        ANY PERCENTAGE ?                             
         BE    GETCYCX             NO, ALL DONE                                 
         MVI   BYTE,JLBLPEST       YES, CHANGE TYPE                             
         XR    RF,RF                                                            
         ICM   RF,3,BCYPER         GET PERCENTAGRE                              
         STCM  RF,15,CYCPER        SAVE CYCLE PERCENT                           
         B     GETCYCY                                                          
*                                                                               
*                                  * UNBILLING *                                
GETCYC11 CLC   BCYREF,JLRRNUM      CORRECT BILL ?                               
         BNE   GETCYC3                                                          
         CLC   BCYUNBD,JLRRADT     RUN DATE ?                                   
         BNE   GETCYC3                                                          
         BRAS  RE,NEXTEL           MUST BE LAST CYCLE                           
         BNE   *+14                                                             
         OC    BCYREF,BCYREF       TEST A LATER BILL                            
         BNZ   GETCYCN                                                          
*                                                                               
GETCYCY  MVC   JLCYCDA,DA          SAVE DA OF CYCLE RECORD                      
         MVC   JLCYCLE,BCYCLE      AND CYCLE NUMBER                             
         B     GETCYCX                                                          
*                                                                               
GETCYCN  TM    JLRROPT,JLRROUNB    TEST UNBILL                                  
         BNO   *+12                                                             
         OI    JLSTAT5,JLS5NUNB    CAN'T UNBILL                                 
         B     GETCYCX                                                          
         OI    JLSTAT5,JLS5NCYC    NO CYCLE RECORD                              
         B     GETCYCX                                                          
GETCYCS  OI    JLSTAT5,JLS5CYCS    SEQUENCE ERROR                               
GETCYCX  MVC   DKEY,TKEY           RESTORE SEQUENCE                             
         BRAS  RE,READ                                                          
         J     XIT                                                              
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* GET WORKCODE ENTRY                                                 *          
***********************************************************************         
                                                                                
GETWC    NTR1  ,                                                                
         LA    R2,WCEL             R2=A(WORKCODE ELEMENT)                       
         USING WCOELD,R2                                                        
         CLC   WCODE,WCOCODE       MATCH WORKCODE                               
         JE    XIT                                                              
         ICM   R2,15,JLAWCODE      A(WORKCODE ELEMENTS)                         
         BZ    GETWC9              NOT PASSED -  MUST READ FILE                 
*                                                                               
GETWC3   XR    R1,R1                                                            
         CLI   WCODE+1,C' '        TEST ONE BYTE CODE                           
         BNH   *+8                                                              
         LA    R1,1                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   WCODE(0),WCOCODE    FIND CORRECT WC ELEMENT                      
         BNE   GETWC5                                                           
         MVC   WCEL,WCOEL          SAVE WORKCODE DATA                           
         J     XIT                                                              
GETWC5   SR    R0,R0                                                            
         IC    R0,WCOLN                                                         
         AR    R2,R0                                                            
GETWC7   CLI   0(R2),WCOELQ                                                     
         BE    GETWC3                                                           
         CLI   0(R2),0                                                          
         BNE   GETWC5                                                           
         DC    H'0'                WORKCODE NOT FOUND                           
*                                                                               
                                                                                
GETWC9   LA    R0,TKEY             SAVE TRANSACTION KEY                         
         ST    R0,ATKEY                                                         
         GOTO1 DATAMGR,DMCB,DMKEY,ACCDIR,(R0)                                   
*                                                                               
         MVC   DKEY,SPACES                                                      
         LA    R2,DKEY                                                          
         USING WCORECD,R2                                                       
         MVI   WCOKTYP,WCOKTYPQ                                                 
         L     RF,JLAJOB                                                        
         MVC   WCOKCPY(3),0(RF)    CUL                                          
         MVC   WCOKWRK,WCODE       CODE                                         
         BRAS  RE,READ                                                          
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         L     R2,AIO3                                                          
         LA    R2,WCORFST                                                       
         MVC   DKEY,TKEY           RESTORE SEQUENCE                             
         BRAS  RE,READ                                                          
         B     GETWC7                                                           
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* GET COMMISSION AND GROSS                                           *          
***********************************************************************         
                                                                                
GETGRS   NTR1  ,                                                                
         ZAP   JLTCOMR,PZERO       START WITH COMMISSION RATE = ZERO            
         ICM   R2,15,JLATRNEL                                                   
         BZ    *+12                                                             
         USING TRNELD,R2                                                        
         TM    TRNSTAT,TRNSNOCM    TEST TRANSACTION NON-COMMISSIONABLE          
         BO    GETGRS3                                                          
         ICM   R3,15,JLAPRTEL                                                   
         BZ    *+12                                                             
         USING PRTELD,R3                                                        
         TM    PRTSTAT,PRTSNOTQ+PRTSRTEQ    IS IT 'N' OR 'R' TIME ?             
         BNZ   GETGRS3                                                          
         TM    JLBLTYP,ESTM+SPCL   ESTIMATE OR SPECIAL BILL ?                   
         BZ    *+12                                                             
         CLI   GOESTCOM,YES                                                     
         BNE   GETGRS3                                                          
         TM    JLBLTYP,SPCL        SPECIAL BILL                                 
         BO    GETGRS2                                                          
         LA    R4,WCEL             R2=A(WORKCODE ELEMENT)                       
         USING WCOELD,R4                                                        
         TM    WCOSTAT,WCOSNONC    NON-COMMISSIONABLE                           
         BO    GETGRS3                                                          
         TM    WCOSTAT,WCOSMEDT    MEDIA TRANSFER                               
         BO    GETGRS3                                                          
         DROP  R4                                                               
*                                                                               
GETGRS2  ZAP   JLTCOMR,COMR        OK TO SET COMMISSION RATE                    
         ICM   RF,15,APTARRL       IS THIS A RERUN OR UNBILL ?                  
         BZ    GETGRS3                                                          
         USING PTAELD,RF                                                        
         ZAP   JLTCOMR,PTARCORT    USE ORIGINAL COMMISSION RATE.                
         ZAP   COM,PTARCOM                                                      
         B     GETGRS4                                                          
         DROP  RF                                                               
*                                                                               
GETGRS3  ZAP   WORK(13),NET              NET                                    
         AP    WORK(13),CSD        PLUS: CD                                     
         MP    WORK(13),JLTCOMR        * RATE                                   
         SRP   WORK(13),64-6,5     ROUNDED TO 2DP                               
         ZAP   COM,WORK(13)        COMMISSION                                   
GETGRS4  ZAP   GRS,NET                                                          
         AP    GRS,COM             GROSS                                        
*                                                                               
         LTR   R2,R2                                                            
         BZ    *+12                                                             
         TM    TRNSTAT,TRNSNOCM    TEST TRANSACTION NON-COMMISSIONABLE          
         JO    XIT                                                              
         TM    FLAG,COMRTL         APPLY TO  RETAIL ?                           
         JNO   XIT                                                              
         OC    JLARETLB,JLARETLB   TEST RETAIL DISTRIBUTION BUFFER              
         JZ    XIT                                                              
         TM    JLSTAT1,JLS1DIST    TEST DISTRIBUTION SCHEME                     
         JNO   XIT                                                              
         L     RF,=A(RTLFLG)                                                    
         TM    0(RF),RTLFSCR       TEST ANY SPECIAL RATES                       
         BNO   *+10                                                             
         ZAP   COM,PZERO           RECALC THE TOTAL COMM.                       
*                                                                               
         L     R5,JLARETLB         TEST ANY RETAIL DISTRIBUTORS                 
         USING RTLD,R5                                                          
GETGRS5  ZAP   PL16,NET                                                         
         AP    PL16,CSD                                                         
         MP    PL16,RTLPCT         * PCT.                                       
         TM    RTLSTAT,RTLCOMM     TEST SPECIAL RATE FOR THIS DISTRIB.          
         BNO   GETGRS7             NO,                                          
         MP    PL16,RTLCRATE       * SPECIAL RATE                               
         B     GETGRS9                                                          
*                                                                               
GETGRS7  MP    PL16,JLTCOMR        * RATE                                       
*                                                                               
GETGRS9  SRP   PL16,64-12,5                                                     
         AP    RTLCMTOT,PL16       ADD TO TOTAL COMMISSION FOR DIST.            
         AP    JLRTLCOM,PL16       AND TO OVERALL TOTAL                         
         L     RF,=A(RTLFLG)                                                    
         TM    0(RF),RTLFSCR       TEST ANY SPECIAL RATES                       
         BNO   *+10                                                             
         AP    COM,PL16            RECALC THE TOTAL COMM.                       
         LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),EOT                                                        
         BNE   GETGRS5                                                          
         J     XIT                                                              
         DROP  R2,R3,R5                                                         
         EJECT                                                                  
***********************************************************************         
* WORKCODE FILTER                                                     *         
***********************************************************************         
                                                                                
WCFLT    CLC   JLWCFLT,SPACES      ANY WORKCODE FILTER?                         
         BE    WCFLTY                                                           
         CLC   0(L'TRNKWORK,RF),JLWCFLT                                         
         BE    WCFLTY                                                           
         TM    JLWCFLT,X'40'       IS IT POSITIVE FILTER                        
         BO    WCFLTN              YES, SKIP THIS RECORD                        
         MVC   WORK(2),JLWCFLT                                                  
         OI    WORK,X'40'                                                       
         CLC   0(L'TRNKWORK,RF),WORK DOES IT MATCH THE EXCLUDE ?                
         BE    WCFLTN               YES, SKIP IT                                
WCFLTY   CR    RB,RB                                                            
         BR    RE                                                               
WCFLTN   LTR   RB,RB                                                            
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* APPLY EXCEPTION RULES                                               *         
***********************************************************************         
                                                                                
XRUL     NTR1  ,1                                                               
         L     R3,ADXCP                                                         
         USING XCPD,R3                                                          
XRUL3    CLI   MODE,ACCLAST        AT ACCLAST ALL APPLY                         
         BE    *+12                                                             
         CLI   XCPTLEV,ACCFRST     ONLY LOOK AT ACCFRST RULES                   
         BNE   XRUL99                                                           
*                                                                               
         XR    R1,R1                                                            
         ICM   R1,1,XCPTSTA        TEST WARNING OR EXCEPTION                    
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    JLXRSTA,0                                                        
         BZ    XRUL99              DOES NOT APPLY                               
*                                                                               
         ICM   R1,1,XCPTBIN        BILL TYPES TO INCLUDE                        
         BZ    XRUL5                                                            
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    JLBLTYP,0                                                        
         BZ    XRUL99              NOT ONE TO BE INCLUDED                       
*                                                                               
XRUL5    ICM   R1,1,XCPTBEX        BILL TYPES TO EXCLUDE                        
         BZ    XRUL6                                                            
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    JLBLTYP,0                                                        
         BNZ   XRUL99              ONE TO BE EXCLUDED                           
*                                                                               
XRUL6    CLI   JLRROPT,0           TEST RERUN/UNBIL                             
         BE    XRUL7               NO,                                          
         TM    XCPINDS,XCPIRRN     DOES RULE APPLY TO RERUNS ?                  
         BZ    XRUL99              NO,                                          
*                                                                               
XRUL7    XR    R0,R0                                                            
         ICM   R0,1,XCPTNUM        NUMBER OF TESTS                              
         LA    R4,XCCNDL                                                        
XRUL9    XR    RF,RF                                                            
         ICM   RF,3,1(R4)          DISP. TO STATUS BYTE OR ROUTINE              
         CLI   0(R4),0             IS THERE A BIT TEST ?                        
         BE    XRUL13                                                           
         LA    RF,JLD(RF)                                                       
         XR    RE,RE                                                            
         IC    RE,0(R4)                                                         
         EX    RE,*+8                                                           
         B     *+8                                                              
         TM    0(RF),0             TEST STATUS BIT                              
         BNO   XRUL99              IF NOT ON - OK TO SKIP THE REST              
         B     XRUL15                                                           
*                                                                               
XRUL13   AR    RF,RB               GO TO SPECIAL ROUTINE                        
         BASR  RE,RF               TEST CONDITION                               
         BNE   XRUL99              NOT A PROBLEM                                
XRUL15   LA    R4,L'XCCNDL(R4)                                                  
         BCT   R0,XRUL9                                                         
*                                                                               
XRUL17   LA    R4,XCPTRN           SET ERROR BIT                                
         BAS   RE,SETBIT                                                        
         LA    RF,JLERRS(RF)                                                    
         OC    0(1,RF),BYTE                                                     
*                                                                               
         CLI   XCPTRN,1            ERROR 1                                      
         BNE   *+8                                                              
         OI    ERRORS,ERR1                                                      
         CLI   XCPTRN,15           ERROR F                                      
         BNE   *+8                                                              
         OI    ERRORS,ERRF                                                      
         CLI   XCPTRN,17           ERROR H                                      
         BNE   *+8                                                              
         OI    ERRORS,ERRH                                                      
*                                                                               
XRUL99   XR    R1,R1               BUMP TO NEXT RULE                            
         ICM   R1,1,XCPTNUM        NUMBER OF TESTS                              
         MHI   R1,L'XCCNDL                                                      
         AHI   R1,XCPTLNQ                                                       
         AR    R3,R1                                                            
         CLI   0(R3),EOT           TEST EOT                                     
         BNE   XRUL3                                                            
         J     XIT                                                              
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* UPDATE THE ERROR LIST                                               *         
***********************************************************************         
                                                                                
UPEL     BAS   RE,UPEL1                                                         
         BAS   RE,SETER                                                         
         J     XIT                                                              
                                                                                
UPEL1    NTR1  ,                                                                
         ICM   R4,15,JLAERINC      A(ERRORS TO INCLUDE)                         
         JZ    XIT                                                              
         XC    WORK,WORK                                                        
*                                                                               
UPEL3    CLI   0(R4),0             END OF LIST                                  
         BE    UPEL5                                                            
         BAS   RE,SETBIT           SET ERROR BIT                                
         LA    RF,WORK(RF)                                                      
         OC    0(1,RF),BYTE        SET BIT IN WORK                              
         LA    R4,1(R4)                                                         
         B     UPEL3                                                            
*                                                                               
UPEL5    TM    JLAERINC,X'80'      IS IT AN EXCLUDE LIST ?                      
         BNO   *+10                                                             
         XC    WORK(L'JLERRS),FFS  REVERSE BITS                                 
         NC    JLERRS,WORK         SET BOTH                                     
         J     XIT                                                              
         EJECT                                                                  
***********************************************************************         
* SET ERRORS                                                          *         
***********************************************************************         
                                                                                
SETER    NTR1  ,                                                                
         MVI   JLFLTYES,YES        SET 'FOUND'                                  
         OC    JLERRS,JLERRS       TEST ERRORS                                  
         BNZ   SETER5              BRANCH IF ERRORS                             
         CLI   JLFLTER,0           FILTER ON A SPECIAL ERROR ?                  
         JE    XIT                                                              
         MVI   JLFLTYES,NO         SET 'NOT FOUND'                              
         J     XIT                                                              
*                                                                               
SETER5   CLI   JLFLTER,0           FILTER ON A SPECIAL ERROR ?                  
         BE    SETER11                                                          
         MVI   JLFLTYES,NO         SET REASON FILTER TO 'NO'                    
         MVC   BYTE,JLFLTER                                                     
         CLI   BYTE,C' '           BINARY NUMBER USED ?                         
         BL    SETER9                                                           
*                                                                               
         L     R3,ADTXT            CONVERT THE CHARACTER TO BINARY              
         USING JLTXD,R3                                                         
SETER7   CLC   BYTE,JLTXCODE       MATCH THE CODE                               
         BNE   *+14                                                             
         MVC   BYTE,JLTXNUMQ       USE THE NUMBER                               
         B     SETER9                                                           
         LA    R3,JLTXLNQ(R3)                                                   
         CLI   0(R3),EOT                                                        
         BNE   SETER7                                                           
         B     SETER11                                                          
         DROP  R3                                                               
*                                                                               
SETER9   LA    R4,BYTE                                                          
         BAS   RE,SETBIT           SET BIT FOR THIS ERROR                       
         LA    RF,JLERRS(RF)       TEST BIT IS ON IN ERROR LIST                 
         XR    R1,R1                                                            
         IC    R1,BYTE                                                          
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    0(RF),0                                                          
         BNO   *+8                                                              
         MVI   JLFLTYES,YES        RETURN 'ERROR FOUND'                         
*                                                                               
SETER11  ICM   R4,15,JLAERRL       ANY RETURN LIST                              
         JZ    XIT                                                              
         SR    R1,R1                                                            
         ICM   R1,1,JLLERRL        LENGTH OF LIST                               
         JZ    XIT                                                              
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),SPACES                                                   
*                                                                               
         LA    R1,1                R1=ERROR NUMBER                              
         LA    R2,JLERRS           R2=A(ERROR BITS)                             
         LHI   R3,(L'JLERRS)/4     R3=NUMBER 0F SETS OF 4                       
*                                                                               
SETER13  ICM   RF,15,0(R2)         RF=32 ERROR BITS                             
         LA    R0,32               R0=NUMBER OF BITS                            
*                                                                               
SETER15  SR    RE,RE                                                            
         SLDL  RE,1                                                             
         LTR   RE,RE               TEST ERROR CONDITION                         
         BZ    SETER19             NO ERROR                                     
         TM    JLOPTS,JLOPERO      USE OLD 1 BYTE CODES                         
         BNO   SETER17                                                          
         LR    R6,R1                                                            
         BCTR  R6,0                                                             
         MHI   R6,JLTXLNQ                                                       
         L     RE,ADTXT                                                         
         LA    RE,0(R6,RE)                                                      
         MVC   0(1,R4),JLTXCODE-JLTXD(RE)                                       
         CLI   0(R4),C' '          ANY OLD CODE ?                               
         BE    SETER17             NO, USE NUMBER                               
         MVI   1(R4),C','                                                       
         LA    R4,2(R4)                                                         
         B     SETER19                                                          
*                                                                               
SETER17  CVD   R1,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  0(2,R4),DUB+6(2)    ERROR NUMBER 01,03,....                      
         MVI   2(R4),C','                                                       
         LA    R4,3(R4)                                                         
*                                                                               
SETER19  LA    R1,1(R1)            INCREMENT ERROR NUMBER                       
         BCT   R0,SETER15                                                       
         LA    R2,4(R2)            R2=NEXT 32                                   
         BCT   R3,SETER13                                                       
         BCTR  R4,0                                                             
         MVI   0(R4),C' '          REMOVE TRAILING COMMA                        
         J     XIT                                                              
         EJECT                                                                  
***********************************************************************         
* OTHER  ROUTINES                                                    *          
***********************************************************************         
                                                                                
*                                  SUBTRACT SET A (R3) FROM B (R4)              
SUBSET   LA    R0,JLBKRN                                                        
         SP    0(L'JLBK,R4),0(L'JLBK,R3)                                        
         LA    R3,L'JLBK(R3)                                                    
         LA    R4,L'JLBK(R4)                                                    
         BCT   R0,*-14                                                          
         BR    RE                                                               
*                                                                               
         USING JLBKD,RF                                                         
ADDSET   AP    JLBNET,NET                                                       
         AP    JLBCOM,COM                                                       
         AP    JLBGRS,GRS                                                       
         AP    JLBCSD,CSD                                                       
         AP    JLBHRS,HRS                                                       
         BR    RE                                                               
         DROP  RF                                                               
*                                                                               
SETBIT   ST    RE,SVRE                                                          
         LA    R1,128              X'80'                                        
         XR    RE,RE               SET ERROR BIT                                
         ICM   RE,1,0(R4)          REASON NUMBER                                
         SRDA  RE,32                                                            
         D     RE,=F'8'            DIVIDE BY 8                                  
         LTR   RE,RE               ANY REMAINDER ?                              
         BNZ   *+10                                                             
         BCTR  RF,0                NO, REDUCE QUOTIENT                          
         LA    RE,8                SHIFT WILL BE 7                              
         BCTR  RE,0                                                             
         LTR   RE,RE               NO SHIFT - IF REMAINDER IS ONE               
         BZ    *+12                                                             
         SRL   R1,1                SET CORRECT ERROR BIT                        
         BCT   RE,*-4                                                           
         STC   R1,BYTE                                                          
         L     RE,SVRE                                                          
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* DATA CONSTANTS AND EQUATES                                         *          
***********************************************************************         
                                                                                
YES      EQU   C'Y'                                                             
NO       EQU   C'N'                                                             
EOT      EQU   X'FF'                                                            
ALL      EQU   X'FF'                                                            
*                                                                               
FFS      DC    (L'JLERRS)X'FF'                                                  
*                                                                               
BILLTAB  DS   0CL20                                                             
         DC   C'P',AL1(TRNBTPRO),CL15'PROGRESSIVE'                              
         DC   AL1(PROG),AL1(JLBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'T',AL1(TRNBTTOT),CL15'TOTAL BILL'                               
         DC   AL1(TOTL),AL1(JLBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'1',AL1(TRNBTONE),CL15'ONE-LINE BILL'                            
         DC   AL1(ONEL),AL1(JLBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'E',AL1(TRNBTPER),CL15'   PC ESTIMATE'                           
         DC   AL1(ESTM),AL1(JLBLSTRN+JLBLSEST),AL1(0)                           
*                                                                               
         DC   C'S',AL1(TRNBTSPE),CL15'SPECIAL AMOUNT'                           
         DC   AL1(SPCL),AL1(JLBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'C',AL1(TRNBTCLI),CL15'CLIENT'                                   
         DC   AL1(CLIB),AL1(JLBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'U',AL1(0),CL15'UNBILLABLE'                                      
         DC   AL1(NOTB),AL1(0),AL1(0)                                           
*                                                                               
PESTAB   DS    0XL3      CURRENT STATUS/# OF GOBILAM'S/NEXT STATUS              
         DC    AL1(0),AL1(1),AL1(JOBB1BIL)                                      
         DC    AL1(JOBB1BIL),AL1(2),AL1(JOBB2BIL)                               
         DC    AL1(JOBB1BIL+JOBB2BIL),AL1(3),AL1(JOBB3BIL)                      
         DC    AL1(EOT)                                                         
*                                                                               
PZRO     DC    P'0'                                                             
P1DLR    DC    PL6'100'            $1.00                                        
P100P    DC    PL6'10000'          100.00%                                      
PONEHDRD DC    PL6'1000000'                                                     
*                                                                               
*              CURRENT ESTIMATE/HIGHEST REVISION (NET & GROSS)                  
ESTLH    DC    AL1(8+L'ESTL),4X'00',AL1(L'ESTL),AL2(0)                          
ESTL     DC    C'CE,CEG,HR,HRG'                                                 
*                                                                               
DMCMDS   DS    0CL8                                                             
         DC    CL8'DMKEY   '                                                    
         DC    CL8'ACCDIR  '                                                    
         DC    CL8'ACCMST  '                                                    
         DC    CL8'DMREAD  '                                                    
         DC    CL8'DMRDHI  '                                                    
         DC    CL8'DMRSEQ  '                                                    
         DC    CL8'GETREC  '                                                    
DMCMDLNQ EQU   *-DMCMDS                                                         
*                                                                               
ACOLIST  DC    A(COLIST)                                                        
ACOLTAB  DC    A(COLTAB)                                                        
AOPVTAB  DC    A(OPVTAB)                                                        
*                                                                               
ADXCP    DC    A(XCPTAB)                                                        
ADTXT    DC    A(TXTTAB)                                                        
*                                                                               
COLTABLQ DC    A(COLTABL)                                                       
OPVTABLQ DC    A(OPVTABL)                                                       
         EJECT                                                                  
***********************************************************************         
* CONDITIONALS - RETURNS AN EQUAL CC IF IT'S A PROBLEM                *         
***********************************************************************         
                                                                                
IFRSN01  TM    JLERS1,JLERR01      ERROR REASON 1 NOT ON                        
         BNO   IFYES                                                            
         B     IFNO                                                             
*                                                                               
IFADMAC  CLC   GOASACC,SPACES       ADMIN ACC MISSING                           
         BNH   IFYES                                                            
         B     IFNO                                                             
*                                                                               
IFADMPCT CP    GOASPCT,PZERO        ADMIN PCT NOT ZERO                          
         BNE   IFYES                                                            
         B     IFNO                                                             
*                                                                               
IFADMWRK OC    GOASWRK,GOASWRK      ADMIN WORKCODE - MISSING                    
         BZ    IFYES                                                            
         B     IFNO                                                             
*                                                                               
IFERF1H  TM    ERRORS,ERRF1H        ERROF F + (ERROR 1 OR H)                    
         BO    IFYES                                                            
         B     IFNO                                                             
*                                                                               
IFYES    CR    RB,RB                                                            
         BR    RE                                                               
IFNO     LTR   RB,RB                                                            
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* LITERAL POOL                                                        *         
***********************************************************************         
                                                                                
         LTORG                                                                  
*                                                                               
         DROP  RB,RA                                                            
         EJECT                                                                  
***********************************************************************         
* BUILD TABLE OF RETAIL DISTRIBUTORS                                 *          
***********************************************************************         
RTL      NMOD1 0,**RTL,RA                                                       
         XR    RC,RC                                                            
         ICM   RC,7,1(R1)                                                       
         USING LWSD,RC                                                          
         ICM   R8,15,JLAGOBK                                                    
         USING GOBLOCKD,R8                                                      
         XR    RF,RF                                                            
         ICM   RF,1,0(R1)                                                       
         SLL   RF,2                                                             
         B     *(RF)                                                            
*                                                                               
         B     RTLINI              INITIALIZE TABLE                             
         B     RTLPRB              POST PREVIOUS PARTICIPANTS                   
         B     RTLALL              ALLOCATE CURRENT CHARGES                     
*                                                                               
RTLINI   L     R5,JLARETLB         DISTRIBUTOR TABLE                            
         USING RTLD,R5                                                          
         LR    R0,R5               CLEAR THE RETAIL BLOCK                       
         L     R1,JLLRETLB         LENGTH OF BLOCK                              
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVI   0(R5),X'FF'         END OF TABLE                                 
         MVI   RTLFLG,0            INITALIZE SPECIAL RETAIL FLAG                
         ZAP   JLRTLUNT,PZERO                                                   
         TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BNO   *+8                 NO,                                          
         BAS   RE,RTLUNB           INITIALIZE UNBILL ENTRIES                    
*                                                                               
         MVC   DKEY,SPACES                                                      
         LA    R3,DKEY                                                          
         USING TRNRECD,R3                                                       
         MVC   TRNKCPY,CPY         BUILD KEY FOR RETAIL LEDGER                  
         MVI   TRNKUNT,C'3'                                                     
         MVC   TRNKLDG,GODIST                                                   
         BRAS  RE,READ                                                          
         L     R3,AIO3                                                          
         ST    R3,AIO                                                           
         BRAS  RE,GETR             GET LEDGER RECORD                            
         MVI   ELCODE,LDGELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                NO LEDGER ELEMENT                            
         USING LDGELD,R3                                                        
         MVC   LEDGSTA,LDGSTAT     SAVE LEDGER STATUS                           
         L     R3,AIO                                                           
         MVI   ELCODE,ACLELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                 GET HEIRARCHY ELEMENT                        
         DC    H'0'                                                             
         USING ACLELD,R3                                                        
         LA    R1,LEDGLVL          SAVE LEDGER LEVEL LENGTHS                    
         LA    RF,ACLVALS                                                       
         USING ACLVALS,RF                                                       
*                                                                               
RTLINI3  MVC   0(1,R1),ACLVLEN                                                  
         CLI   ACLVLEN,12                                                       
         BE    RTLINI5                                                          
         LA    R1,1(R1)                                                         
         LA    RF,L'ACLVALS(RF)                                                 
         B     RTLINI3                                                          
         DROP  R8,RF                                                            
*                                                                               
RTLINI5  BRAS  RE,RSEQ             GET THE FIRST                                
         CLC   DIR(TRNKACT-TRNKEY),DKEY SAME LEDGER                             
         BE    *+6                                                              
         DC    H'0'                NO RECORDS                                   
         LA    R3,DIR                                                           
         USING TRNRECD,R3                                                       
         CLI   TRNKACT,C'*'        TEST PASSED THE STAR ACCOUNTS                
         BNE   RTLINI7             YES, DOWN TO REGULAR ACCOUNTS                
         L     R6,JLAJOB                                                        
         CLC   TRNKCULC,0(R6)      TEST UNITS BY JOB                            
         BNE   RTLINI5                                                          
         BRAS  RE,GETR                                                          
         BAS   RE,GETSCHM          GET SCHEME ELEMENT                           
         BNE   RTLINI5                                                          
         OI    FLAG,JOBFLT         SET JOB FILTERING                            
         B     RTLINI5                                                          
*                                                                               
RTLINI7  BRAS  RE,GETR                                                          
*                                                                               
RTLINI9  L     R3,AIO                                                           
         LA    R1,L'TRNKACT        GET LENGTH OF ACCOUNT                        
         LA    RF,TRNKACT+L'TRNKACT-1                                           
         CLI   0(RF),C' '                                                       
         BH    *+10                                                             
         BCTR  RF,0                                                             
         BCT   R1,*-10                                                          
*                                                                               
         LA    RF,LEDGLVL          GET LEVEL FOR THIS ACCOUNT                   
         SR    R2,R2               R2=LEVEL MINUS 1                             
         CLM   R1,1,0(RF)          ACCOUNT LENGTH VS. LEVEL LENGTH              
         BNH   *+16                                                             
         LA    RF,1(RF)                                                         
         LA    R2,1(R2)                                                         
         B     *-16                                                             
*                                                                               
         NI    FLAG,ALL-(ACCTLO)                                                
         CLI   0(RF),12            TEST ACCOUNT LEVEL                           
         BNE   *+8                                                              
         OI    FLAG,ACCTLO         SET LOW LEVEL ACCOUNT INDICATOR              
*                                                                               
         CLI   TRNKCULC,C' '       ACCOUNT (ANY LEVEL)                          
         BE    RTLINI11                                                         
         TM    FLAG,ACCTLO                                                      
         BNO   RTLINI25            CONTRA (HIGH LEVEL)                          
         B     RTLINI13                                                         
*                                                                               
                                                                                
RTLINI11 LR    R1,R2               R1 = LEVEL NUMBER LESS ONE                   
         MHI   R1,LVACCLNQ                                                      
         LA    R1,LVACC(R1)        R1 TO FIRST ACCOUNT                          
         LR    R6,R1                                                            
         LA    R0,4                R0 = NUMBER OF LEVELS TO CLEAR               
         SR    R0,R2                                                            
         MVC   0(LVACCLNQ,R1),SPACES                                            
         LA    R1,LVACCLNQ(R1)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         BAS   RE,GETRCV           GET REC'V AND COST ACCOUNT                   
         TM    FLAG,ACCTLO         IS THIS ACCOUNT LEVEL ?                      
         BNO   RTLINI25            IF NOT DON'T NEED SCHEME                     
         BAS   RE,NAMADR           GET NAME AND ADDRESS                         
*                                                                               
RTLINI13 L     R3,AIO                                                           
         MVI   ELCODE,FFTELQ       GET COMMISSION RATE                          
         BRAS  RE,GETELN                                                        
RTLINI14 BNE   RTLINI16                                                         
         USING FFTELD,R3                                                        
         CLI   FFTTYPE,FFTTCOMR                                                 
         BE    RTLINI15                                                         
         BRAS  RE,NEXTEL                                                        
         B     RTLINI14                                                         
*                                                                               
RTLINI15 ZAP   RETLCMR,FFTDATA(4)  COMMISSION RATE                              
         L     R3,AIO                                                           
         USING TRNRECD,R3                                                       
         MVC   RETLACT,TRNKCULA     ACCOUNT                                     
*                                                                               
RTLINI16 L     R3,AIO                                                           
         LA    RF,SPACES                                                        
         TM    FLAG,JOBFLT          TEST FILTER BY JOB                          
         BNO   *+8                                                              
         L     RF,JLAJOB                                                        
         CLC   TRNKCULC,0(RF)                                                   
         BNE   RTLINI25                                                         
*                                                                               
         TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BNO   RTLINI19            NO,                                          
         L     R5,JLARETLB         YES, FIND ENTRY                              
RTLINI17 CLI   0(R5),EOT           TEST EOT                                     
         BE    RTLINI25            YES, NOT INCLUDED IN UNBILLING               
         CLC   RTLDIS,TRNKCULA     TEST MATCHING RETAILER                       
         BE    RTLINI18                                                         
         LA    R5,RTLLNQ(R5)                                                    
         B     RTLINI17                                                         
*                                                                               
RTLINI18 ZAP   RTLUNT,PZERO        USE OLD UNITS                                
         BAS   RE,GETSCHM          GET SCHEME ELEMENT                           
         BNE   RTLINI20            NOT IN SCHEME                                
         LR    R4,R3                                                            
         USING DSCELD,R4                                                        
         ZAP   RTLUNT,DSCVAL                                                    
         AP    JLRTLUNT,DSCVAL     ADD TO TOTAL UNITS                           
         B     RTLINI20                                                         
*                                                                               
RTLINI19 MVI   RTLSTAT,0                                                        
         ZAP   RTLPCT,PZERO                                                     
         ZAP   RTLUNT,PZERO                                                     
         BAS   RE,GETSCHM          GET SCHEME ELEMENT                           
         BNE   RTLINI25            NOT IN SCHEME                                
         LR    R4,R3                                                            
         USING DSCELD,R4                                                        
         ZAP   RTLPCT,DSCVAL                                                    
         ZAP   RTLUNT,DSCVAL                                                    
         AP    JLRTLUNT,DSCVAL     ADD TO TOTAL UNITS                           
         CP    DSCVAL,PZERO        SKIP ZERO ALLOCATION                         
         BE    *+8                                                              
         OI    RTLSTAT,RTLCURR                                                  
         DROP  R4                                                               
*                                                                               
RTLINI20 L     R3,AIO                                                           
         MVC   RTLDIS,TRNKCULA     SAVE DISTRIBUTOR CODE                        
         MVC   RTLRECV,SPACES      RECEIVABLE                                   
         MVC   RTLCOST,SPACES      COSTING                                      
         MVC   RTLNME,SRTLNME      RETAILER NAME                                
         MVC   RTLADDR,SRTLADDR    RETAILER ADDRESS                             
         ZAP   RTLCMTOT,PZERO      COMMISSION TOTAL AMOUNT FOR RETAIL           
         ZAP   JLRTLCOM,PZERO      COMMISSION TOTAL AMOUNT OVERALL              
         LA    R1,RTLBK                                                         
         LA    R0,RTLBKN                                                        
         ZAP   0(L'RTLBK,R1),PZERO                                              
         LA    R1,L'RTLBK(R1)                                                   
         BCT   R0,*-10                                                          
*                                                                               
         LA    R0,4                                                             
         LA    R6,LVACC            GET RECEIVABLE & COSTING ACCOUNTS            
         USING LVACC,R6                                                         
RTLINI21 CLI   LVARCV,C' '                                                      
         BE    *+10                                                             
         MVC   RTLRECV,LVARCV                                                   
         CLI   LVACST,C' '                                                      
         BE    *+10                                                             
         MVC   RTLCOST,LVACST                                                   
         LA    R6,LVACCLNQ(R6)                                                  
         BCT   R0,RTLINI21                                                      
         DROP  R6                                                               
*                                                                               
         CLC   TRNKCULA,RETLACT    COMMISSION ACCOUNT ?                         
         BNE   RTLINI23            NO,  SKIP                                    
         ZAP   RTLCRATE,RETLCMR    COMMISSION RATE                              
         OI    RTLSTAT,RTLCOMM                                                  
         OI    RTLFLG,RTLFSCR      TEST SPECIAL COMM. RATES IN USE              
*                                                                               
RTLINI23 TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BO    RTLINI25            YES, TABLE ALREADY BUILD                     
         SR    R1,R1                                                            
         IC    R1,JLRTLNUM         COUNT NUMBER IN TABLE                        
         LA    R1,1(R1)                                                         
         STC   R1,JLRTLNUM                                                      
         LA    R5,RTLLNQ(R5)                                                    
         MVI   0(R5),EOT                                                        
*                                                                               
RTLINI25 BRAS  RE,RSEQ             GET NEXT                                     
         CLC   DIR(TRNKACT-TRNKEY),DKEY SAME LEDGER                             
         BNE   RTLINI27                                                         
         BRAS  RE,GETR                                                          
         B     RTLINI9                                                          
*                                                                               
RTLINI27 TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
*&&DO*&& BO    RTLXIT              YES,                                         
         CP    JLRTLUNT,PZERO      TEST ANY UNITS                               
         BNP   RTLXIT                                                           
         TM    LEDGSTA,LDGRUPCT    TEST RETAIL UNITS ARE PERCENTS               
         BNO   *+12                                                             
         OI    JLRTLSTA,JLRTLSPC   SCHEME IS PERCENTS                           
         B     RTLXIT                                                           
*                                                                               
         OI    JLRTLSTA,JLRTLSUN   SCHEME IS UNITS                              
         L     R5,JLARETLB         DISTRIBUTOR TABLE                            
         ZAP   DUB,PZERO                                                        
         XR    RE,RE                                                            
*                                                                               
RTLINI29 TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BO    RTLXIT              YES,                                         
         TM    RTLSTAT,RTLCURR     TEST CURRENT ALLOCACTION                     
         BNO   RTLINI31            NO,                                          
         ZAP   PL16,RTLUNT         GET PERCENT FOR EACH DISTRIBUTOR             
         SRP   PL16,7,0            X 10000000                                   
         DP    PL16,JLRTLUNT       DIVIDE BY TOTAL                              
         SRP   PL16(L'PL16-L'JLRTLUNT),64-1,5   % ROUNDED TO 4DP                
         ZAP   RTLPCT,PL16(L'PL16-L'JLRTLUNT)   SAVE %                          
         AP    DUB,RTLPCT                                                       
         LTR   RE,RE                                                            
         BNZ   *+10                                                             
         LR    RE,R5                                                            
         B     RTLINI31                                                         
         CP    RTLUNT,RTLUNT-RTLD(L'RTLUNT,RE)                                  
         BNH   RTLINI31                                                         
         LR    RE,R5               RE=A(RETAILER WITH MOST UNITS)               
*                                                                               
RTLINI31 LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),EOT                                                        
         BNE   RTLINI29                                                         
         SP    DUB,=P'1000000'                                                  
         MP    DUB,=P'-1'                                                       
         LR    R5,RE                                                            
         AP    RTLPCT,DUB          ADD ROUNDING DIFFERENCE TO BIGGEST           
         B     RTLXIT                                                           
*                                                                               
         DROP  R3,R5                                                            
         EJECT                                                                  
***********************************************************************         
* SET UNBILL ENTRIES IN RETAIL TABLE                                 *          
***********************************************************************         
RTLUNB   NTR1  ,                                                                
         TM    JLBLTYP,SPCL        TEST SPECIAL BILL                            
         BNO   RTLUNB2             NO,                                          
         LA    RF,JLAALLO          YES, CLEAR TOTAL ACCUMS                      
         LA    R0,JLBKRN                                                        
         ZAP   0(L'JLBK,RF),PZERO                                               
         LA    RF,L'JLBK(RF)                                                    
         BCT   R0,*-10                                                          
*                                                                               
RTLUNB2  XC    DKEY,DKEY                                                        
         LA    R3,DKEY                                                          
         USING TRNRECD,R3                                                       
         L     RF,JLAJOB                                                        
         MVC   TRNKCULA,0(RF)      READ 99 TRANSACTIONS FOR JOB                 
         MVC   TRNKWORK,=C'99'                                                  
         BRAS  RE,HIGH                                                          
         CLC   DIR(TRNKCULC-TRNKEY),DKEY                                        
         BNE   RTLXIT              NONE                                         
*                                                                               
RTLUNB3  LA    R3,DIR                                                           
         CLC   TRNKDATE,JLRRDT1    TEST INVOICE DATE                            
         BNE   RTLUNB15            NO,                                          
         TM    FLAG,FRSTUB         TEST FOUND FIRST NUMBER                      
         BO    RTLUNB5             YES                                          
         CLC   TRNKREF,JLRRNUM     TEST INVOICE NUMBER                          
         BNE   RTLUNB15            NO, SKIP THIS BILL                           
         OI    FLAG,FRSTUB         TEST FOUND FIRST NUMBER                      
         B     RTLUNB7                                                          
*                                                                               
RTLUNB5  CLC   TRNKREF,JLRRNUM     TEST INVOICE NUMBER                          
         BL    RTLUNB15                                                         
*                                                                               
RTLUNB7  L     R5,JLARETLB                                                      
         USING RTLD,R5                                                          
RTLUNB9  CLI   0(R5),EOT           TEST EOT                                     
         BE    RTLUNB11            YES, READ NEXT BILL                          
         CLC   TRNKCULC,RTLDIS     TEST ALREADY IN TABLE                        
         BE    RTLUNB15            THAT'S BAD -  SKIP IT                        
         LA    R5,RTLLNQ(R5)       NEXT TABLE ENTRY                             
         B     RTLUNB9                                                          
*                                                                               
RTLUNB11 BRAS  RE,GETR             GET THE 99 RECORD                            
         L     R3,AIO                                                           
         LA    R4,TRNRFST                                                       
         USING TRNELD,R4                                                        
         CP    TRNRTPCT,PZERO      TEST OLD % ZERO                              
         BE    RTLUNB15            YES, SKIP IT                                 
         MVC   RTLDIS,TRNKCULC     ADD DISTRIBUTOR                              
         MVC   RTLBIL,TRNKREF      SAVE ORIGINAL BILL NUMBER                    
         ZAP   RTLPCT,TRNRTPCT     USE ORIGINAL PERCENT                         
         MVI   RTLSTAT,0                                                        
         OI    RTLSTAT,RTLCURR     SET CURRENT ACTIVITY                         
         ZAP   RTLUNT,PZERO                                                     
*                                                                               
         LA    R1,RTLBK                                                         
         LA    R0,RTLBKN                                                        
         ZAP   0(L'RTLBK,R1),PZERO                                              
         LA    R1,L'RTLBK(R1)                                                   
         BCT   R0,*-10                                                          
*                                                                               
         SR    R1,R1                                                            
         IC    R1,JLRTLNUM         COUNT NUMBER IN TABLE                        
         LA    R1,1(R1)                                                         
         STC   R1,JLRTLNUM                                                      
         LA    R5,RTLLNQ(R5)                                                    
         MVI   0(R5),EOT                                                        
*                                                                               
RTLUNB15 BRAS  RE,RSEQ                                                          
         CLC   DIR(TRNKCULC-TRNKEY),DKEY                                        
         BE    RTLUNB3                                                          
*                                                                               
*                                   ADD NAME AND ADDRESS                        
         L     R5,JLARETLB                                                      
RTLUNB17 CLI   0(R5),EOT           TEST EOT                                     
         BE    RTLXIT                                                           
         MVC   AIO,AIO3                                                         
         LA    R2,LEDGLVL          READ UNIT 3 ACCOUNTS                         
         MVC   DKEY,SPACES                                                      
*                                                                               
RTLUNB19 SR    R1,R1                                                            
         IC    R1,0(R2)                                                         
         LA    R1,2(R1)                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   DKEY(0),RTLDIS                                                   
         BRAS  RE,HIGH                                                          
         BNE   RTLUNB21                                                         
         BRAS  RE,GETR                                                          
         LA    R6,RTLRECV                                                       
         BAS   RE,GETRCV           GET RECEIVABLE & COSTING ACCOUNT             
         BAS   RE,NAMADR           GET NAME AND ADDRESS                         
         MVC   RTLNME,SRTLNME      RETAILER NAME                                
         MVC   RTLADDR,SRTLADDR    RETAILER ADDRESS                             
*                                                                               
RTLUNB21 CLI   0(R2),12                                                         
         BE    RTLUNB23                                                         
         LA    R2,1(R2)            NEXT LEVEL IN HEIRARCHY                      
         B     RTLUNB19                                                         
*                                                                               
RTLUNB23 LA    R5,RTLLNQ(R5)                                                    
         B     RTLUNB17                                                         
         DROP  R3,R4,R5                                                         
*                                                                               
         EJECT                                                                  
***********************************************************************         
* POST PREVIOUS BILLS                                                 *         
***********************************************************************         
RTLPRB   TM    JLBLTYP,SPCL        TEST SPECIAL                                 
         BNO   RTLPRB2             NO,                                          
         TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BNO   RTLXIT              NO, SKIP PREVIOUS BILLS                      
*                                                                               
RTLPRB2  L     R3,ADTRNR                                                        
         USING TRNRECD,R3                                                       
         L     R5,JLARETLB                                                      
         USING RTLD,R5                                                          
RTLPRB3  CLI   0(R5),EOT                                                        
         BNE   RTLPRB4             NOT IN TABLE - SKIP IT                       
         TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BO    RTLXIT              YES, DON'T ADD TO TABLE                      
         BAS   RE,RTLADD           ADD OLD RETAILER                             
         B     RTLPRB2                                                          
*                                                                               
RTLPRB4  CLC   TRNKCULC,RTLDIS     MATCH CONTRA TO DISTRIBUTOR TABLE            
         BE    RTLPRB5                                                          
         LA    R5,RTLLNQ(R5)                                                    
         B     RTLPRB3                                                          
*                                                                               
RTLPRB5  TM    JLBLTYP,SPCL        FOR SPECIAL                                  
         BNO   RTLPRB6             ONLY ADD BILLS IN THE RUN                    
         CLC   RTLBIL,TRNKREF                                                   
         BNE   RTLXIT                                                           
*                                                                               
RTLPRB6  L     R3,ADTRNR                                                        
         AH    R3,DATADISP                                                      
         USING TRNELD,R3                                                        
         LA    R6,RTLPRV                                                        
         USING JLBKD,R6                                                         
         OC    TRNBINTI,TRNBINTI    ANY INTERNAL INCOME ?                       
         BZ    *+10                                                             
         AP    JLBSKI,TRNBINTI      SAVE IT                                     
         SR    R0,R0                                                            
*                                                                               
RTLPRB7  CLI   0(R3),0                                                          
         BE    RTLPRB13                                                         
         CLI   0(R3),VBIELQ        TEST GST POSTING ELEMENT                     
         BNE   RTLPRB9                                                          
         USING VBIELD,R3                                                        
         AP    JLBGST,VBIVAT       TAX                                          
         B     RTLPRB11                                                         
*                                                                               
RTLPRB9  CLI   0(R3),PBIELQ        TEST PST POSTING ELEMENT                     
         BNE   RTLPRB11                                                         
         USING PBIELD,R3                                                        
         AP    JLBPST,PBIPST       PST                                          
*                                                                               
RTLPRB11 IC    R0,1(R3)            GET NEXT TAX ELEMENT                         
         AR    R3,R0                                                            
         B     RTLPRB7                                                          
*                                                                               
RTLPRB13 LA    R0,JLBKRN           ADD THIS BILL TO RETAILER BUCKETS            
         LA    R6,RTLPRV                                                        
         LA    R4,JLTTOT                                                        
         AP    0(L'JLBK,R6),0(L'JLBK,R4)                                        
         LA    R6,L'JLBK(R6)                                                    
         LA    R4,L'JLBK(R4)                                                    
         BCT   R0,*-14                                                          
*                                                                               
         TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BO    RTLPRB17            YES,                                         
         TM    RTLSTAT,RTLOLD      TEST OLD RETAILER                            
         BNO   RTLXIT              NO                                           
         MVC   RTLCHG,RTLPRV       PREV = CURRENT                               
         MVC   RTLNET,RTLPRV                                                    
         B     RTLXIT                                                           
*                                                                               
RTLPRB17 MVC   RTLCHG,RTLPRV       PREV = CURRENT                               
         MVC   RTLNET,RTLPRV                                                    
         TM    JLBLTYP,SPCL        TEST SPECIAL                                 
         BNO   RTLXIT                                                           
*                                                                               
         LA    R0,JLBKRN           ADD BILL TO OVERALL TOTAL                    
         LA    R4,JLTTOT                                                        
         LA    R6,JLAALLO                                                       
         AP    0(L'JLBK,R6),0(L'JLBK,R4)                                        
         LA    R6,L'JLBK(R6)                                                    
         LA    R4,L'JLBK(R4)                                                    
         BCT   R0,*-14                                                          
         B     RTLXIT                                                           
         DROP  R3,R5,R6                                                         
         EJECT                                                                  
***********************************************************************         
* ADD AN OLD RETAILER TO TABLE                                        *         
***********************************************************************         
         USING RTLD,R5                                                          
         USING TRNRECD,R3                                                       
RTLADD   NTR1  ,                                                                
         MVI   RTLLNQ(R5),EOT      MARK NEW EOT                                 
         MVC   RTLDIS,TRNKCULC     SAVE DISTRIBUTOR CODE                        
         MVC   RTLRECV,SPACES      RECEIVABLE                                   
         MVC   RTLCOST,SPACES      COSTING                                      
         ZAP   RTLCMTOT,PZERO      COMMISSION TOTAL AMOUNT                      
         ZAP   RTLPCT,PZERO                                                     
         ZAP   RTLUNT,PZERO                                                     
         MVI   RTLSTAT,0                                                        
         OI    RTLSTAT,RTLCURR+RTLOLD                                           
         LA    R1,RTLBK                                                         
         LA    R0,RTLBKN                                                        
         ZAP   0(L'RTLBK,R1),PZERO                                              
         LA    R1,L'RTLBK(R1)                                                   
         BCT   R0,*-10                                                          
*                                                                               
         SR    R1,R1                                                            
         IC    R1,JLRTLNUM         COUNT NUMBER IN TABLE                        
         LA    R1,1(R1)                                                         
         STC   R1,JLRTLNUM                                                      
*                                                                               
         MVC   AIO,AIO3                                                         
         LA    R2,LEDGLVL          READ UNIT 3 ACCOUNTS                         
         MVC   DKEY,SPACES                                                      
*                                                                               
RTLADD3  SR    R1,R1                                                            
         IC    R1,0(R2)                                                         
         LA    R1,2(R1)                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   DKEY(0),TRNKCULC                                                 
         BRAS  RE,HIGH                                                          
         BNE   RTLADD5                                                          
         BRAS  RE,GETR                                                          
         LA    R6,RTLRECV                                                       
         BAS   RE,GETRCV           GET RECEIVABLE & COSTING ACCOUNT             
         BAS   RE,NAMADR           GET NAME AND ADDRESS                         
         MVC   RTLNME,SRTLNME      RETAILER NAME                                
         MVC   RTLADDR,SRTLADDR    RETAILER ADDRESS                             
         L     R3,ADTRNR           RESTORE R3                                   
*                                                                               
RTLADD5  CLI   0(R2),12                                                         
         BE    RTLXIT                                                           
         LA    R2,1(R2)            NEXT LEVEL IN HEIRARCHY                      
         B     RTLADD3                                                          
         EJECT                                                                  
***********************************************************************         
* ALLOCATE CHARGES TO PARTICIPANTS                                    *         
***********************************************************************         
RTLALL   TM    JLBLTYP,SPCL        SPECIAL                                      
         BNO   RTLALL1                                                          
         TM    JLRROPT,JLRROUNB    UNBILLING                                    
         BO    RTLXIT              OK TO EXIT                                   
*                                                                               
RTLALL1  TM    JLBLTYP,ESTM        %ESTIMATE                                    
         BNO   RTLALL9                                                          
         TM    RTLFLG,RTLFSCR      TEST SPECIAL COMM. RATES IN USE              
         BNO   RTLALL3                                                          
         BAS   RE,RTLRAT           RECALCUTE COMMISSION                         
*                                                                               
RTLALL3  LA    R5,JLAALLO                                                       
         USING JLBKD,R5                                                         
         LA    R0,JLBKRN                                                        
         ZAP   0(L'JLBK,R5),PZERO                                               
         LA    R5,L'JLBK(R5)                                                    
         BCT   R0,*-10                                                          
*                                                                               
         LA    R5,JLAALLO                                                       
         L     R3,JLAEWCB          ESTIMATED BILLABLE BY WC                     
*                                                                               
         USING JLEWD,R3            ADD TO BILLABLE TOTALS                       
RTLALL5  CLI   0(R3),EOT                                                        
         JE    RTLALL9                                                          
         AP    JLBNET,JLEWNET      NET                                          
         AP    JLBGRS,JLEWGRS      GROSS                                        
         AP    JLBCOM,JLEWGRS      GROSS MINUS NET = COMMISSION                 
         SP    JLBCOM,JLEWNET                                                   
         LA    R3,JLEWLNQ(R3)                                                   
         B     RTLALL5                                                          
*                                                                               
RTLALL9  TM    RTLFLG,RTLFSCR      TEST SPECIAL RATES                           
         BZ    RTLALL10            NO,                                          
         LA    R5,JLAALLO                                                       
         ZAP   JLBCOM,JLRTLCOM     REPLACE TOTAL COMMISSION                     
         ZAP   JLBGRS,JLRTLCOM                                                  
         AP    JLBGRS,JLBNET                                                    
         LA    R5,JLATOT                                                        
         ZAP   JLBCOM,JLRTLCOM                                                  
         ZAP   JLBGRS,JLRTLCOM                                                  
         AP    JLBGRS,JLBNET                                                    
*                                                                               
RTLALL10 MVC   TOTCHRG,JLAALLO                                                  
         TM    JLBLTYP,PROG+SPCL+ESTM  PROGRESSIVE, SPECIAL, %EST               
         BNZ   RTLALL11                                                         
         MVC   TOTCHRG,JLATOT                                                   
         LA    R4,TOTCHRG                                                       
         LA    R3,JLATRNX          LESS: TRANSFERS                              
         BAS   RE,SUBA                                                          
         LA    R4,TOTCHRG                                                       
         LA    R3,JLAWOFF          AND LESS: WRITEOFFS                          
         BAS   RE,SUBA             LEAVES TOTAL FOR DISTRIBUTION                
*                                                                               
RTLALL11 MVC   TOTREMN,TOTCHRG     TOTAL REMAINING TO BE DISTRIBUTED            
         XC    ABIGRTL,ABIGRTL     ADDRESS OF ENTRY WITH LARGEST %              
         L     R5,JLARETLB         DISTRIBUTOR TABLE                            
         CLI   0(R5),EOT           TEST TABLE EMPTY                             
         BNE   RTLALL13                                                         
         OI    JLSTAT1,JLS1CLB+JLS1RET SET CONFLICT ERROR                       
         B     RTLXIT              SET OUT                                      
*                                                                               
         USING RTLD,R5                                                          
RTLALL13 TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BO    RTLALL15            YES, SKIP NEW                                
         TM    RTLSTAT,RTLCURR     TEST CURRENT PARTICIPANT                     
         BNO   RTLALL15            NO, DON'T ALLOCATE NEW CHARGES               
         ICM   RF,15,ABIGRTL       GET ADDRESS OF ENTRY WITH LARGEST %          
         BZ    *+14                                                             
         CP    RTLPCT,RTLPCT-RTLD(L'RTLPCT,RF)                                  
         BNH   *+8                                                              
         ST    R5,ABIGRTL                                                       
*                                                                               
RTLALL15 LA    R1,SHRLST           R1=LIST OF BUCKETS                           
         LA    R3,TOTCHRG          R3=CHARGE TO ALLOCATE                        
         LA    R4,RTLCHG           R4=RETAILER BUCKETS                          
         BAS   RE,GETSHR           GET RETAILER SHARE                           
         USING JLBKD,R4                                                         
         TM    RTLFLG,RTLFSCR      TEST SPECIAL COMM. RATES IN USE              
         BNO   *+10                                                             
         ZAP   JLBCOM,RTLCMTOT     SET TOTAL COMMISSION                         
*                                                                               
         ZAP   JLBGRS,JLBNET       RECALCULATE GROSS                            
         AP    JLBGRS,JLBCOM       GROSS = NET + COM                            
*                                                                               
         MVC   RTLNET,RTLCHG       CHARGES TO NET POSTING                       
         LA    R4,RTLNET           SHARE OF CHARGES                             
         LA    R3,RTLPRV           LESS: PREVIOUS                               
         BAS   RE,SUBA                                                          
*                                                                               
         LA    R4,TOTREMN          TOTAL REMAINING                              
         LA    R3,RTLCHG           LESS: CHARGES ALLOCATED                      
         BAS   RE,SUBA                                                          
*                                                                               
         LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),EOT                                                        
         BNE   RTLALL13                                                         
*                                                                               
*&&OS*&& B     RTLXIT              DON'T ALLOCATE REMAINDER                     
*                                                                               
         TM    RTLFLG,RTLFSCR      TEST SPECIAL RATES IN EFFECT                 
         BO    RTLXIT              YES, CAN'T HAVE REMAINDER                    
         TM    JLRROPT,JLRROUNB    TEST UNBILLING                               
         BO    RTLXIT              YES, USE OLD NUMBERS                         
*                                                                               
         LA    R1,SHRLST           ADD OVER/UNDER TO ENTRY WITH BIG %           
         L     R5,ABIGRTL                                                       
         LA    R4,RTLCHG           R4=RETAILER BUCKETS                          
         LA    R6,TOTREMN                                                       
         SR    RF,RF                                                            
*                                                                               
RTLALL19 ICM   RF,3,0(R1)          RF=DISPLACEMENT TO BUCKET                    
         LA    R2,0(RF,R4)                                                      
         LA    R3,0(RF,R6)                                                      
         AP    0(L'JLBK,R2),0(L'JLBK,R3)                                        
         LA    R1,L'SHRLST(R1)                                                  
         CLI   0(R1),EOT                                                        
         BNE   RTLALL19                                                         
         LA    R4,RTLCHG           R4=RETAILER BUCKETS                          
         USING JLBKD,R4                                                         
         ZAP   JLBGRS,JLBNET       RECALCULATE GROSS (AGAIN)                    
         AP    JLBGRS,JLBCOM       GROSS = NET + COM                            
*                                                                               
         MVC   RTLNET,RTLCHG       CHARGES TO NET POSTING                       
         LA    R4,RTLNET           SHARE OF CHARGES                             
         LA    R3,RTLPRV           LESS: PREVIOUS                               
         BAS   RE,SUBA                                                          
*                                                                               
RTLXIT   XIT1                                                                   
         DROP  R3,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
* RECALCULATE COMMISSION BY RETAILER                                 *          
***********************************************************************         
RTLRAT   NTR1  ,                                                                
         L     R2,JLAEWCB                                                       
         USING JLEWD,R2                                                         
RTLRAT1  ZAP   JLEWGRS,JLEWNET     SET GROSS = NET                              
*                                                                               
         L     R5,JLARETLB         TEST ANY RETAIL DISTRIBUTORS                 
         USING RTLD,R5                                                          
RTLRAT3  ZAP   PL16,JLEWNET                                                     
         MP    PL16,RTLPCT         NET * PCT. (SHARE)                           
         ZAP   DUB,JLEWCOMR        DEFAULT RATE                                 
         TM    RTLSTAT,RTLCOMM     TEST SPECIAL RATE FOR THIS DISTRIB.          
         BNO   *+10                                                             
         ZAP   DUB,RTLCRATE        USE SPECIAL RATE                             
         MP    PL16,DUB                                                         
         SRP   PL16,64-12,5                                                     
         AP    RTLCMTOT,PL16       ADD TO TOTAL COMMISSION FOR DIST.            
         AP    JLRTLCOM,PL16       AND TO OVERALL TOTAL                         
         AP    JLEWGRS,PL16        COMMISSION BY WC                             
         LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),EOT                                                        
         BNE   RTLRAT3                                                          
*                                                                               
         LA    R2,JLEWLNQ(R2)                                                   
         CLI   0(R2),EOT           TEST END IF ESTIMATES                        
         BNE   RTLRAT1                                                          
         J     XIT                                                              
*                                                                               
         DROP  R2,R5                                                            
         EJECT                                                                  
***********************************************************************         
*  SUBTRACT SET A (R3) FROM B (R4)                                              
***********************************************************************         
                                                                                
SUBA     LA    R0,JLBKRN                                                        
         SP    0(L'JLBK,R4),0(L'JLBK,R3)                                        
         LA    R3,L'JLBK(R3)                                                    
         LA    R4,L'JLBK(R4)                                                    
         BCT   R0,*-14                                                          
         BR    RE                                                               
                                                                                
                                                                                
***********************************************************************         
*  GET SHARE OF TOTAL AMOUNT                                                    
***********************************************************************         
                                                                                
         USING RTLD,R5                                                          
GETSHR   SR    RF,RF                                                            
         ICM   RF,3,0(R1)          RF=DISPLACEMENT TO BUCKET                    
         AR    RF,R3                                                            
         ZAP   PL16,0(L'JLBK,RF)   TOTAL AMOUNT                                 
         MP    PL16,RTLPCT         * PERCENT                                    
         SRP   PL16,64-6,5         ROUNDED                                      
         SR    RF,RF                                                            
         ICM   RF,3,0(R1)          DISPLACEMENT TO                              
         AR    RF,R4                                                            
         ZAP   0(L'JLBK,RF),PL16   SAVE HIS SHARE                               
         LA    R1,L'SHRLST(R1)                                                  
         CLI   0(R1),EOT                                                        
         BNE   GETSHR                                                           
         BR    RE                                                               
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
* GET DISTRIBUTION FOR SCHEME                                        *          
***********************************************************************         
                                                                                
GETSCHM  LR    R0,RE                                                            
         ICM   R8,15,JLAGOBK                                                    
         USING GOBLOCKD,R8                                                      
         L     R3,AIO                                                           
         MVI   ELCODE,DSCELQ                                                    
         BRAS  RE,GETELN                                                        
GETSCHM3 BE    GETSCHM5                                                         
         LR    RE,R0                                                            
         LTR   RB,RB                                                            
         BR    RE                                                               
*                                                                               
         USING DSCELD,R3                                                        
GETSCHM5 CLC   DSCCODE,GODIST+1    MATCH SCHEME                                 
         BNE   GETSCHM7                                                         
         LR    RE,R0                                                            
         CR    RB,RB                                                            
         BR    RE                                                               
*                                                                               
GETSCHM7 BRAS  RE,NEXTEL                                                        
         B     GETSCHM3                                                         
         DROP  R3,R8                                                            
         EJECT                                                                  
***********************************************************************         
* GET RECEIVABLE AND COSTING CODES                                   *          
***********************************************************************         
                                                                                
         USING LVACC,R6                                                         
GETRCV   LR    R0,RE                                                            
         L     R3,AIO                                                           
         MVI   ELCODE,RBRELQ       GET RETAIL ELEMENT                           
         BRAS  RE,GETELN                                                        
         BNE   GETRCVX                                                          
*                                                                               
         USING RBRELD,R3                                                        
GETRCV3  CLI   RBRRECB,X'40'                                                    
         BNH   GETRCV5                                                          
         MVC   LVARCV(L'ACTKCPY),CPY   SET RECEIVABLE ACCOUNT                   
         MVC   LVARCV+(ACTKULA-ACTKEY)(L'ACTKULA),RBRRECB                       
*                                                                               
GETRCV5  CLI   RBRCOST,X'40'                                                    
         BNH   GETRCVX                                                          
         MVC   LVACST(L'ACTKCPY),CPY   SET COSTING ACCOUNT                      
         MVC   LVACST+(ACTKULA-ACTKEY)(L'ACTKULA),RBRCOST                       
*                                                                               
GETRCVX  LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
         DROP  R3,R6                                                            
         EJECT                                                                  
***********************************************************************         
* ADD NAME AND ADDRESS TO RETAIL ENTRY                               *          
***********************************************************************         
NAMADR   LR    R0,RE                                                            
         MVC   SRTLNME,SPACES                                                   
         MVC   SRTLADDR,SPACES                                                  
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,NAMELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING NAMELD,R3                                                        
         SR    R1,R1                                                            
         IC    R1,NAMLN                                                         
         SHI   R1,NAMLN1Q+1                                                     
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SRTLNME(0),NAMEREC                                               
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,ADRELQ                                                    
         BRAS  RE,GETELN                                                        
         BNE   NAMADRX                                                          
*                                                                               
         USING ADRELD,R3                                                        
         SR    R1,R1                                                            
         IC    R1,ADRNUM                                                        
         LA    RF,ADRADD1                                                       
         LA    RE,SRTLADDR                                                      
*                                                                               
         MVC   0(L'ADRADD1,RE),0(RF)                                            
         LA    RE,L'ADRADD1(RE)                                                 
         LA    RF,L'ADRADD1(RF)                                                 
         BCT   R1,*-14                                                          
*                                                                               
NAMADRX  LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* CONSTANTS - LITERAL POOL                                           *          
***********************************************************************         
*                                                                               
**  MUST MOVE THIS FOR ONLINE  *****                                            
LEDGSTA  DC    X'00'               LEDGER STATUS                                
LEDGLVL  DC    F'0'                LEDGER LEVEL LENGTHS                         
RTLFLG   DC    X'00'                                                            
RTLFSCR  EQU   X'80'               SPECIAL COMMISSION RATE IN USE               
                                                                                
SHRLST   DS    0H                                                               
         DC    AL2(JLBNET-JLBKD)                                                
         DC    AL2(JLBCOM-JLBKD)                                                
         DC    AL2(JLBCSD-JLBKD)                                                
         DC    AL2(JLBSKI-JLBKD)                                                
         DC    AL2(JLBGST-JLBKD)                                                
         DC    AL2(JLBPST-JLBKD)                                                
         DC    AL1(EOT)                                                         
*                                                                               
         LTORG                                                                  
         DROP  RB,RA                                                            
*                                                                               
         EJECT                                                                  
***********************************************************************         
* RERUN / UNBILL -   ACCOUNT FIRST                                    *         
***********************************************************************         
                                                                                
RERN     NMOD1 0,**RRN                                                          
         L     RC,0(R1)                                                         
         USING LWSD,RC                                                          
*                                                                               
         CLI   JLACTN,JLAPACF      ACCOUNT FIRST ?                              
         BNE   RERNT                                                            
         OC    JLRRBDA,JLRRBDA     TEST 99 POSTING ON FILE                      
         BZ    XITY                NO, PROCESS WHAT'S MARKED                    
         MVC   AIO,AIO2                                                         
         MVC   DA,JLRRBDA          RETRIEVE BILL POSTING TO BE RERUN            
         BRAS  RE,GETR                                                          
         L     R3,AIO2                                                          
         MVI   ELCODE,TRNELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TRNELD,R3                                                        
*                                                                               
         L     RF,ABILLTAB         MATCH NUMBER TO TABLE                        
         CLC   TRNBTYPE,JLBLNUM-JLBLCODE(RF)                                    
         BE    RERNA1                                                           
         LA    RF,L'BILLTAB(RF)                                                 
         CLI   0(RF),0                                                          
         BNE   *-18                                                             
         B     RERNXN                                                           
*                                                                               
RERNA1   MVC   JLRRTYP,0(RF)       SET BILL TYPE                                
         MVC   JLWCFLT,TRNQTFLT    SET WC FILTER                                
         OC    JLWCFLT,SPACES                                                   
*                                                                               
         CLI   JLRRTYP,C'S'        TEST SPECIAL                                 
         JE    RERNA15                                                          
         CLI   JLRRTYP,C'E'        TEST % OF EST.                               
         JNE   XITY                                                             
         LA    R0,8                                                             
         LA    R1,TRNNARR                                                       
         LA    R2,WORK                                                          
         SR    RE,RE               RE=COUNT OF NUMERICS                         
         SR    RF,RF               RF=START OF DP                               
*                                                                               
RERNA3   CLC   0(4,R1),=C'PC E'    PC ESTIMATE CONSTANT                         
         BE    RERNA9                                                           
         CLI   0(R1),C'.'                                                       
         BNE   RERNA5                                                           
         LTR   RF,RF               TEST ALREADY HAVE DP                         
         BZ    *+6                                                              
         DC    H'0'                                                             
         LA    RF,1(R1)                                                         
         B     RERNA7                                                           
*                                                                               
RERNA5   CLI   0(R1),C'0'                                                       
         BNL   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R1),C'9'                                                       
         BNH   *+6                                                              
         DC    H'0'                                                             
         MVC   0(1,R2),0(R1)       GET NUMERICS                                 
         LA    RE,1(RE)                                                         
         LA    R2,1(R2)                                                         
*                                                                               
RERNA7   LA    R1,1(R1)            R1 TO NEXT TRNNARR BYTE                      
         BCT   R0,RERNA3                                                        
         DC    H'0'                                                             
*                                                                               
RERNA9   CR    RF,R1               TEST END AFTER DP(IE 99.PC)                  
         BNE   *+6                                                              
         SR    RF,RF               YES, MAKE IT NO DP'S                         
         LTR   RF,RF               TEST ANY DP'S                                
         BZ    *+8                 BRANCH IF NO DP                              
         SR    R1,RF               R1=NUMBER OF DECIMAL PLACES                  
         LR    RF,R1               RF=NUMBER OF DECIMAL PLACES                  
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         PACK  DUB,WORK(0)         PACK THE NUMBER                              
         CHI   RF,2                ALREADY HAVE 2 DP?                           
         BE    *+18                                                             
         MP    DUB,=P'10'                                                       
         AHI   RF,1                                                             
         B     *-18                                                             
*                                                                               
         ZAP   JLPEST,DUB                                                       
*                                                                               
         L     R3,AIO2                                                          
         MVI   ELCODE,BESELQ       GET ESTIAMTES BY WC                          
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R2,JLAEWCB                                                       
*                                                                               
         USING BESELD,R3                                                        
         USING JLEWD,R2                                                         
RERNA11  MVC   JLEWWC,BESWORK      WORKCODE                                     
         ZAP   JLEWNET,BESPEBC     NET                                          
         ZAP   JLEWGRS,BESPEBCG    GROSS                                        
         ZAP   JLEWCOMR,PZERO                                                   
         LA    R2,JLEWLNQ(R2)                                                   
         MVI   0(R2),EOT           TEST ANY ESTIMATES                           
         BRAS  RE,NEXTEL                                                        
         BE    RERNA11                                                          
         J     XITY                                                             
*                                   ** SPECIAL BILL **                          
         USING TRNELD,R3                                                        
RERNA15  ZAP   NET,TRNAMNT                                                      
         ZAP   COM,TRNBLCOM                                                     
         ZAP   GRS,NET                                                          
         AP    GRS,COM                                                          
         J     XITY                                                             
*                                                                               
RERNXN   OI    JLSTAT5,JLS5NUNB   CAN'T UNBILL OR RERUN                         
         J     XITN                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* RERUN / UNBILL -   TRANSACTION                                      *         
***********************************************************************         
RERNT    CLI   JLACTN,JLAPTRN      TRANSACTION                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R3,ADTRNR                                                        
         MVI   ELCODE,TRSELQ                                                    
         BRAS  RE,GETEL            GET STATUS ELEMENT                           
         JNE   XITN                                                             
         USING TRSELD,R3                                                        
         CLC   TRSDATE,JLRRADT     TEST DATE ADDED TO FILE                      
         JH    XITN                SKIP ITEMS ADDED AFTER RERUN DATE            
*                                                                               
         L     R3,ADTRNR                                                        
         USING TRNRECD,R3                                                       
         CLC   TRNKWORK,JLBILLQ    IS IT A PREVIOUS BILL ?                      
         BE    RERNT21                                                          
         MVI   ELCODE,PTAELQ                                                    
         BRAS  RE,GETEL            GET PTAEL                                    
         B     *+8                                                              
*                                                                               
RERNT3   BRAS  RE,NEXTEL                                                        
         JNE   XITN                TRANSACTION NOT IN RERUN                     
         USING PTAELD,R3                                                        
         CLI   PTATYPE,PTATRAL     TEST BILLING ELEMENT                         
         BNE   RERNT3                                                           
*                                                                               
         TM    JLRROPT,JLRRORRB+JLRROUNB  RERUN AN UNBILLING ?                  
         BO    RERNT11                    YES,                                  
*                                                                               
         TM    JLBLTYP,TOTL+ONEL   TEST TOTAL OR ONE LINE                       
         BZ    RERNT5                                                           
         CLC   PTADATE,JLRRADT     TEST ACTIVITY VS DATE OF BILLING             
         BH    RERNT3              ADDED LATER                                  
         BL    RERNT7              ADDED BEFORE                                 
         CLC   PTARBLNO,JLRRBILL   SAME DAY - CHECK NUMBER                      
         BH    RERNT3              BILLED LATER                                 
         B     RERNT7              MUST ALSO BE ON RERUN                        
*                                                                               
RERNT5   TM    JLBLTYP,PROG        TEST PROGRESSIVE                             
         BNO   XITN                                                             
         CLC   JLRRBILL,PTARBLNO   TEST BILL NUMBER & DATE                      
         BNE   RERNT3                                                           
*                                                                               
RERNT7   TM    JLRROPT,JLRROUNB    UNBILLING ?                                  
         BNO   XITY                                                             
         TM    PTASTAT1,PTASPEND   PENDING ?                                    
         BO    RERNT3                                                           
         TM    PTASTAT1,PTASREVS   THIS A REVERSAL ?                            
         BO    RERNT13                                                          
         J     XITY                                                             
*                                                                               
*                                  ** RERUN AN UNBILLING **                     
RERNT11  TM    PTASTAT1,PTASPEND   PENDING ?                                    
         BO    RERNT3                                                           
         TM    PTASTAT1,PTASREVS   THIS A REVERSAL ?                            
         BZ    RERNT13                                                          
         CLC   PTARORGD,JLRRDT2    ORIGINAL BILL DATE ?                         
         BNE   RERNT3                                                           
         CLC   PTARORGB,JLRRNUM    ORIGINAL BILL NUMBER ?                       
         BNE   RERNT3                                                           
         CLC   PTARDATE,JLRRDT2    TEST BILL DATE(ACTIVITY DATE)                
         BNE   RERNT3                                                           
         J     XITY                                                             
*                                                                               
RERNT13  TM    PTASTAT1,PTASREVU   THIS A REVERSAL UPDATED ?                    
         BO    RERNT3                                                           
         CLI   JLBLCODE,JLBLTOTL   TOTAL BILL ?                                 
         BNE   RERNT3                                                           
         CLC   PTARDATE,JLRRDT2    BILLED BEFORE THIS ONE ?                     
         BH    RERNT3                                                           
         J     XITY                                                             
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* RERUN / UNBILL -   PREVIOUS BILL - WC=99                            *         
***********************************************************************         
                                                                                
         USING TRNRECD,R3                                                       
RERNT21  MVI   ELCODE,TRNELQ                                                    
         BRAS  RE,GETEL            GET TRNEL                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TRNELD,R3                                                        
         CLC   TRN2DAY,JLRRADT     TEST  RERUN DATE                             
         BE    RERNT23                                                          
         JH    XITN                YES, SKIP IT                                 
         J     XITY                                                             
*                                                                               
RERNT23  CLC   TRNREF,JLRRNUM      TEST BILL NUMBER                             
         BE    XITY                YES,                                         
         TM    JLSTAT1,JLS1DIST    TEST RETAIL BILL                             
         BO    RERNT25             YES,                                         
         CLC   TRNREF,JLRRNUM                                                   
         BH    XITN                                                             
         J     XITY                                                             
*                                                                               
RERNT25  J     XITY                INCLUDE ALL RETAIL                           
*                                                                               
         DROP  R3                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* DATAMGR ROUTINES                                                   *          
***********************************************************************         
                                                                                
READ     LR    R0,RE                                                            
         GOTO1 DATAMGR,DMCB,DMREAD,ACCDIR,DKEY,DIR                              
         CLI   8(R1),0                                                          
         JE    *+6                                                              
         DC    H'0'                CAN'T READ ACCOUNT                           
         MVC   DA,DIR+(ACCKDA-ACCRECD)                                          
         TM    JLOPTS,JLOPTIO       TRACE IO'S ?                                
         JNO   *+8                                                              
         BRAS  RE,DMTRCE                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
HIGH     LR    R0,RE                                                            
         GOTO1 DATAMGR,DMCB,DMRDHI,ACCDIR,DKEY,DIR                              
         MVC   DA,DIR+(ACCKDA-ACCRECD)                                          
         TM    JLOPTS,JLOPTIO       TRACE IO'S ?                                
         JNO   *+8                                                              
         BRAS  RE,DMTRCE                                                        
         LR    RE,R0                                                            
         CLC   DKEY,DIR                                                         
         BR    RE                                                               
*                                                                               
RSEQ     LR    R0,RE                                                            
         GOTO1 DATAMGR,DMCB,DMRSEQ,ACCDIR,DKEY,DIR                              
         CLI   8(R1),0                                                          
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   DA,DIR+(ACCKDA-ACCRECD)                                          
         TM    JLOPTS,JLOPTIO       TRACE IO'S ?                                
         JNO   *+8                                                              
         BRAS  RE,DMTRCE                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
GETR     LR    R0,RE                                                            
         GOTO1 DATAMGR,DMCB,GETREC,ACCMST,DA,AIO,DMWORK                         
         CLI   8(R1),0                                                          
         JE    *+6                                                              
         DC    H'0'                                                             
         TM    JLOPTS,JLOPTIO       TRACE IO'S ?                                
         JNO   *+8                                                              
         BRAS  RE,DMTRCE                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
DMTRCE   NTR1  BASE=*                                                           
         MVC   DMBLK,SPACES                                                     
         L     R2,0(R1)                                                         
         MVC   DMBPGM,DMJOBW                                                    
         MVC   DMBCOM,0(R2)        COMMAND                                      
         L     R2,4(R1)                                                         
         MVC   DMBFIL,0(R2)        FILE                                         
         MVC   DMBDMCW,DMCOUNTW    DMCOUNT=00                                   
         L     RF,JLAACMST         A(MONACC)                                    
         L     RF,ACMDMCNT-ACMD(RF)                                             
         ICM   R0,15,0(RF)                                                      
         EDIT  (R0),DMBDMC,ALIGN=LEFT                                           
         L     R2,12(R1)           R2=A(IO)                                     
         MVC   DMBIOW,DMSTIOW      START IO=                                    
         L     RF,JLADDMST         A(ADMASTC)                                   
         ICM   R0,15,MCACTIOS-MASTD(RF)                                         
         EDIT  (R0),DMBIO,ALIGN=LEFT                                            
         MVC   DMCB+20(4),MCVPRINT-MASTD(RF)                                    
         MVI   DMCB+20,C'P'                                                     
         GOTO1 JLAPRNTB,DMCB,(L'DMBLK,DMBLK),(R2),C'DUMP',42,=C'2D'             
         J     XIT                                                              
*                                                                               
DMJOBW   DC    C'JOBLOT'                                                        
DMCOUNTW DC    C'DMCOUNT='                                                      
DMSTIOW  DC    C'START IO='                                                     
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
*                                                                               
         EJECT                                                                  
         GETEL R3,DATADISP,ELCODE                                               
GETELN   AH    R3,NEWDISP                                                       
         J     FIRSTEL                                                          
*                                                                               
XITY     CR    RB,RB                                                            
         J     *+6                                                              
XITN     LTR   RB,RB                                                            
XIT      XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* EXCEPTION RULES TABLE                                               *         
***********************************************************************         
                                                                                
ACJOBLOT CSECT                                                                  
XCPTAB   DS    0X                                                               
* 1-CAN'T BILL DUE TO OVERSPENDING ESTIMATE                                     
XCPT1    DC    AL1(XR01),AL1(JLXRSEX),AL1(XCPTACL)                              
         DC    AL1(0)                                                           
         DC    AL1(SPCL+ESTM)      EXCLUDE SPECIAL &  ESTIMATE                  
         DC    AL1(0)                                                           
         DC    AL1((XCPT1X-*)/L'XCCNDL)                                         
         DC    AL1(JLS3ESRQ),AL2(JLSTAT3-JLD)   ESTIMATE REQUIRED               
         DC    AL1(JLS6NZRO),AL2(JLSTAT6-JLD)   ESTIMATE IS NOT ZERO            
         DC    AL1(JLS6NGTE),AL2(JLSTAT6-JLD)   NET > MAX. EXT                  
XCPT1X   EQU   *                                                                
***********************************************************************         
                                                                                
* 2-CAN'T BILL DUE TO BALANCE BELOW MINIMUM                                     
XCPT2    DC    AL1(XR02),AL1(JLXRSEX),AL1(XCPTACL)                              
         DC    AL1(PROG)           ONLY PROGRESSIVE                             
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT2X-*)/L'XCCNDL)                                         
         DC    AL1(JLS6ULTM),AL2(JLSTAT6-JLD)   UNBILLED < MINIMUM              
         DC    AL1(JLS6UGT1),AL2(JLSTAT6-JLD)   UNBILLED > $1.00                
XCPT2X   EQU   *                                                                
*                                                                               
XCPT2A   DC    AL1(XR02),AL1(JLXRSEX),AL1(XCPTACL)                              
         DC    AL1(ESTM)           ESTIMATED                                    
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT2AX-*)/L'XCCNDL)                                        
         DC    AL1(JLS6PLTM),AL2(JLSTAT6-JLD)   %EST. < MINIMUM                 
XCPT2AX  EQU   *                                                                
***********************************************************************         
                                                                                
* 3-WARNING - JOB INACTIVE FOR 6 MONTHS                                         
XCPT3    DC    AL1(XR03),AL1(JLXRSWA),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT3X-*)/L'XCCNDL)                                         
         DC    AL1(JLS6NACT),AL2(JLSTAT6-JLD)   INACTIVE FOR 6 MONTHS           
XCPT3X   EQU   *                                                                
***********************************************************************         
                                                                                
* 4-WARNING - ACTUALS EXCEED PCT OF ESTIMATE                                    
XCPT4    DC    AL1(XR04),AL1(JLXRSWA),AL1(XCPTACL)                              
         DC    AL1(ESTM)           ESTIMATED                                    
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT4X-*)/L'XCCNDL)                                         
         DC    AL1(JLS6GTPE),AL2(JLSTAT6-JLD)   > % OF ESTIMATE                 
XCPT4X   EQU   *                                                                
***********************************************************************         
                                                                                
* 5-CAN'T BILL-JOB HAS UNBILLABLE BILL TYPE                                     
XCPT5    DC    AL1(XR05),AL1(JLXRSEX),AL1(XCPTACL)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT5X-*)/L'XCCNDL)                                         
         DC    AL1(JLS6UNBT),AL2(JLSTAT6-JLD)   UNBILLABLE TYPE                 
         DC    AL1(JLS7NGTZ),AL2(JLSTAT7-JLD)   NET > ZERO                      
XCPT5X   EQU   *                                                                
***********************************************************************         
                                                                                
* 6-CAN'T BILL-JOB DOES NOT HAVE AN ESTIMATE                                    
XCPT6    DC    AL1(XR06),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(ALL-SPCL)       ALL EXCEPT SPECIAL BILL TYPES                
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT6X-*)/L'XCCNDL)                                         
         DC    AL1(JLS3ESRQ),AL2(JLSTAT3-JLD)   ESTIMATE REQUIRED               
         DC    AL1(JLS7EGTZ),AL2(JLSTAT7-JLD)   ESTIMATE > ZERO                 
XCPT6X   EQU   *                                                                
***********************************************************************         
                                                                                
* 7-WARNING - NO ESTIMATE,CHARGES OR BILLING                                    
XCPT7    DC    AL1(XR07),AL1(JLXRSWA),AL1(XCPTACL)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT7X-*)/L'XCCNDL)                                         
         DC    AL1(JLS7EABZ),AL2(JLSTAT7-JLD)   EST.+ACTUAL+BILLING=0           
XCPT7X   EQU   *                                                                
***********************************************************************         
                                                                                
* 8-WARNING - JOB IS PAST CLOSING DATE                                          
XCPT8    DC    AL1(XR08),AL1(JLXRSWA),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT8X-*)/L'XCCNDL)                                         
         DC    AL1(JLS7CLSD),AL2(JLSTAT7-JLD)   CLOSE DATE < TODAY              
XCPT8X   EQU   *                                                                
***********************************************************************         
                                                                                
* 9-CAN'T BILL - CLIENT OR RETAIL CONFLICT                                      
XCPT9    DC    AL1(XR09),AL1(JLXRSEX),AL1(XCPTACL)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT9X-*)/L'XCCNDL)                                         
         DC    AL1(JLS4BILL),AL2(JLSTAT4-JLD)         JOB HAS BILLING           
         DC    AL1(JLS1CLB+JLS1RET),AL2(JLSTAT1-JLD) RETAIL SCHEME MIX          
XCPT9X   EQU   *                                                                
*                                                                               
XCPT9A   DC    AL1(XR09),AL1(JLXRSEX),AL1(XCPTACL)                              
         DC    AL1(0)                                                           
         DC    AL1(CLIB)           ALL EXCEPT CLIENT BILL TYPE                  
         DC    AL1(0)                                                           
         DC    AL1((XCPT9AX-*)/L'XCCNDL)                                        
         DC    AL1(JLS1CLB),AL2(JLSTAT1-JLD)     ANY CLIENT BILLS               
XCPT9AX  EQU   *                                                                
***********************************************************************         
                                                                                
* A-CAN'T BILL - JOB HAS UNAPPROVED ESTIMATE                                    
XCPT10   DC    AL1(XR10),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT10X-*)/L'XCCNDL)                                        
         DC    AL1(JLS3UNEW),AL2(JLSTAT3-JLD)  UNAPPROVED 'NEW' EST.            
         DC    AL1(JLS3ESRQ+JLS3NEWS+JLS3NTOB),AL2(JLSTAT3-JLD)                 
         DC    AL1(JLS7LRNZ),AL2(JLSTAT7-JLD)  LOW REVISION NOT ZERO            
XCPT10X  EQU   *                                                                
*                                                                               
XCPT10A  DC    AL1(XR10),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT10AX-*)/L'XCCNDL)                                       
         DC    AL1(JLS3ESRQ+JLS3UOLD),AL2(JLSTAT3-JLD)                          
XCPT10AX EQU   *                                                                
***********************************************************************         
                                                                                
* B-JOB BALANCE GREATER THAN ''NNN''                                            
XCPT11   DC    AL1(XR11),AL1(JLXRSWA),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT11X-*)/L'XCCNDL)                                        
         DC    AL1(JLS7BGTB),AL2(JLSTAT7-JLD)   BALANCE > BIG                   
XCPT11X  EQU   *                                                                
***********************************************************************         
                                                                                
* C-WARNING-CHARGES+ORDERS EXCEED ESTIMATE                                      
XCPT12   DC    AL1(XR12),AL1(JLXRSWA),AL1(XCPTACL)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT12X-*)/L'XCCNDL)                                        
         DC    AL1(JLS7OGTE),AL2(JLSTAT7-JLD)  ORDERED + NET > MAX EST          
         DC    AL1(JLS6NZRO),AL2(JLSTAT6-JLD)  ESTIMATE IS NOT ZERO             
         DC    AL1(0),AL2(IFRSN01-BGN)         ERROR REASON 1  NOT SET          
XCPT12X  EQU   *                                                                
***********************************************************************         
                                                                                
* D-WARNING - JOB HAS HELD INVOICES                                             
XCPT13   DC    AL1(XR13),AL1(JLXRSWA),AL1(XCPTACL)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT13X-*)/L'XCCNDL)                                        
         DC    AL1(JLS1HELD),AL2(JLSTAT1-JLD)    HELD INVOICES                  
XCPT13X  EQU   *                                                                
***********************************************************************         
                                                                                
* E-CAN'T BILL - MISSING USER FIELD                                             
XCPT14   DC    AL1(XR14),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT14X-*)/L'XCCNDL)                                        
         DC    AL1(JLS1MUSR),AL2(JLSTAT1-JLD)   MISSING USER FIELD              
XCPT14X  EQU   *                                                                
***********************************************************************         
                                                                                
* F-WARNING-ADDITIONAL R'S AWAITING APPROVAL                                    
XCPT15   DC    AL1(XR15),AL1(JLXRSWA),AL1(XCPTACL)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT15X-*)/L'XCCNDL)                                        
         DC    AL1(JLS1UNAR),AL2(JLSTAT1-JLD)   UNAPPROVED REVISION             
         DC    AL1(JLS3NTOB),AL2(JLSTAT3-JLD)   NEED APPROVAL TO BILL           
XCPT15X  EQU   *                                                                
***********************************************************************         
                                                                                
* G-CAN'T BILL - BILLING SELECT SET TO NO                                       
XCPT16   DC    AL1(XR16),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT16X-*)/L'XCCNDL)                                        
         DC    AL1(JLS2BLSN),AL2(JLSTAT2-JLD)    BILLSELECT = NO                
XCPT16X  EQU   *                                                                
***********************************************************************         
                                                                                
* H-CAN'T BILL - OVER ESTIMATE MAX AMOUNT                                       
XCPT17   DC    AL1(XR17),AL1(JLXRSEX),AL1(XCPTACL)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT17X-*)/L'XCCNDL)                                        
         DC    AL1(JLS3ESRQ),AL2(JLSTAT3-JLD)   ESTIMATE REQUIRED               
         DC    AL1(JLS8OVMX),AL2(JLSTAT8-JLD)   ACTUAL > MAX                    
         DC    AL1(JLS7NGTZ),AL2(JLSTAT7-JLD)   NET > ZERO                      
XCPT17X  EQU   *                                                                
***********************************************************************         
                                                                                
* I-WARNING - OVER ESTIMATE MAX PCT-GROSS                                       
XCPT18   DC    AL1(XR18),AL1(JLXRSWA),AL1(XCPTACL)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT18X-*)/L'XCCNDL)                                        
         DC    AL1(JLS8GRPO),AL2(JLSTAT8-JLD)  ACTUAL GROSS > GROSS EST         
XCPT18X  EQU   *                                                                
***********************************************************************         
                                                                                
* J-CAN'T BILL-LINKED STUDIO JOB, INVALID BT                                    
XCPT19   DC    AL1(XR19),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(ESTM+SPCL)      ESTIMATE & SPECIAL                           
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT19X-*)/L'XCCNDL)                                        
         DC    AL1(JLS2LKAG),AL2(JLSTAT2-JLD)  AGENCY LINK                      
         DC    AL1(JLS2STUD),AL2(JLSTAT2-JLD)  STUDIO JOB                       
XCPT19X  EQU   *                                                                
***********************************************************************         
                                                                                
* K-CAN'T BILL - STUDIO JOB IS MISSING LINK                                     
XCPT20   DC    AL1(XR20),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(0)                                                           
         DC    AL1(CLIB)           ALL BUT CLIENT BILLTYPE                      
         DC    AL1(0)                                                           
         DC    AL1((XCPT20X-*)/L'XCCNDL)                                        
         DC    AL1(JLS2MISL),AL2(JLSTAT2-JLD)  NO AGENCY LINK DEFINED           
XCPT20X  EQU   *                                                                
***********************************************************************         
                                                                                
* L-CAN'T BILL RETAIL FOR STUDIO JOB WITH LINK                                  
XCPT21   DC    AL1(XR21),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT21X-*)/L'XCCNDL)                                        
         DC    AL1(JLS2LKAG),AL2(JLSTAT2-JLD)  AGENCY LINK                      
         DC    AL1(JLS2STUD),AL2(JLSTAT2-JLD)  STUDIO JOB                       
         DC    AL1(JLS1DIST),AL2(JLSTAT1-JLD)  DISTRIBUTION SCHEME              
XCPT21X  EQU   *                                                                
***********************************************************************         
                                                                                
* M-CAN'T BILL - MISSING ACCOUNTS FOR ADMINISTRATIVE SURCHARGE                  
XCPT22   DC    AL1(XR22),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(CLIB)           CLIENT BILL TYPE                             
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT22X-*)/L'XCCNDL)                                        
         DC    AL1(0),AL2(IFADMAC-BGN)     ADMIN. ACC                           
         DC    AL1(0),AL2(IFADMPCT-BGN)    ADMIN. PCT.                          
XCPT22X  EQU   *                                                                
***********************************************************************         
                                                                                
* N-CAN'T BILL - MISSING WORKCODE FOR ADMINISTRATIVE SURCHARGE                  
XCPT23   DC    AL1(XR23),AL1(JLXRSEX),AL1(XCPTACF)                              
         DC    AL1(CLIB)           CLIENT BILL TYPE                             
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT23X-*)/L'XCCNDL)                                        
         DC    AL1(0),AL2(IFADMWRK-BGN)    ADMIN. WORK CODE                     
         DC    AL1(0),AL2(IFADMPCT-BGN)    ADMIN. PCT.                          
XCPT23X  EQU   *                                                                
***********************************************************************         
                                                                                
* O-CAN'T BILL - ACTUALS EXCEED MAX CE, ADDITIONAL R'S NEEDED                   
XCPT24   DC    AL1(XR24),AL1(JLXRSEX),AL1(XCPTACL)                              
         DC    AL1(0)              ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT24X-*)/L'XCCNDL)                                        
         DC    AL1(JLS8NLTH),AL2(JLSTAT8-JLD) ACT. NET < = HIGH NET EST         
         DC    AL1(0),AL2(IFERF1H-BGN)        ERROF F + (ERROR 1 OR H)          
XCPT24X  EQU   *                                                                
***********************************************************************         
                                                                                
*  -%ESTIMATE BILL - BILLED 100% OR PERCENT IS ZER0                             
XCPT25   DC    AL1(XR25),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ESTM)           % OF ESTIMATE BILLS                          
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT25X-*)/L'XCCNDL)                                        
         DC    AL1(JLS8PCTZ),AL2(JLSTAT8-JLD)   % OF ESTIMATE = ZERO            
XCPT25X  EQU   *                                                                
*                                                                               
XCPT25A  DC    AL1(XR25),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ESTM)           % OF ESTIMATE BILLS                          
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT25AX-*)/L'XCCNDL)                                       
         DC    AL1(JLS8P100),AL2(JLSTAT8-JLD)   % OF ESTIMATE = 100 %           
XCPT25AX EQU   *                                                                
***********************************************************************         
                                                                                
*  -JOB IS CLOSED                                                               
XCPT26   DC    AL1(XR26),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT26X-*)/L'XCCNDL)                                        
         DC    AL1(JLS4CLSD),AL2(JLSTAT4-JLD)   CLOSED                          
XCPT26X  EQU   *                                                                
***********************************************************************         
                                                                                
*  -JOB IS AN X-JOB                                                             
XCPT27   DC    AL1(XR27),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT27X-*)/L'XCCNDL)                                        
         DC    AL1(JLS4XJOB),AL2(JLSTAT4-JLD)    X-JOB                          
XCPT27X  EQU   *                                                                
***********************************************************************         
                                                                                
*  %ESTIMATE IS EQUAL PREVIOUS BILLS                                            
XCPT28   DC    AL1(XR28),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ESTM)           %ESTIMATE                                    
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT28X-*)/L'XCCNDL)                                        
         DC    AL1(JLS8ESFB),AL2(JLSTAT8-JLD)   %EST AMOUNT BILLED              
XCPT28X  EQU   *                                                                
***********************************************************************         
                                                                                
*  JOB ALREADY BILLED TODAY                                                     
XCPT29   DC    AL1(XR29),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT29X-*)/L'XCCNDL)                                        
         DC    AL1(JLOPOVNB),AL2(JLOPTS2-JLD)  OVERNIGHT                        
         DC    AL1(JLS8BLDD),AL2(JLSTAT8-JLD)  BILLED TODAY                     
XCPT29X  EQU   *                                                                
***********************************************************************         
                                                                                
*  NO CYCLE RECORDS                                                             
XCPT30   DC    AL1(XR30),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT30X-*)/L'XCCNDL)                                        
         DC    AL1(JLS5NCYC),AL2(JLSTAT5-JLD)  NO CYCLE RECORDS                 
XCPT30X  EQU   *                                                                
***********************************************************************         
                                                                                
*  CYCLE OUT OF SEQUENCE                                                        
XCPT31   DC    AL1(XR31),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT31X-*)/L'XCCNDL)                                        
         DC    AL1(JLS5CYCS),AL2(JLSTAT5-JLD)  CYCLE SEQUENCE ERROR             
XCPT31X  EQU   *                                                                
***********************************************************************         
                                                                                
*  NOT 'AUTO' BILL TYPE                                                         
XCPT32   DC    AL1(XR32),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT32X-*)/L'XCCNDL)                                        
         DC    AL1(JLS5NAUT),AL2(JLSTAT5-JLD)  NOT AUTO BILL TYPE               
XCPT32X  EQU   *                                                                
***********************************************************************         
                                                                                
*  NO DISTRIBUTOR PERCENTS                                                      
XCPT33   DC    AL1(XR33),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT33X-*)/L'XCCNDL)                                        
         DC    AL1(JLS1DIST),AL2(JLSTAT1-JLD)  DISTRIBUTION SCHEME              
         DC    AL1(JLS2NRTL),AL2(JLSTAT2-JLD)  NO RETAIL UNITS                  
XCPT33X  EQU   *                                                                
***********************************************************************         
                                                                                
*  DISTRIBUTION UNITS NOT EQUAL 100.00 %                                        
XCPT34   DC    AL1(XR34),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT34X-*)/L'XCCNDL)                                        
         DC    AL1(JLS1DIST),AL2(JLSTAT1-JLD)  DISTRIBUTION SCHEME              
         DC    AL1(JLS2RNEQ),AL2(JLSTAT2-JLD)  RETAIL NOT EQUAL 100%            
XCPT34X  EQU   *                                                                
***********************************************************************         
                                                                                
*  JOB HAS NO UNBILLED CHARGES                                                  
XCPT35   DC    AL1(XR35),AL1(JLXRSXB),AL1(XCPTACL)                              
         DC    AL1(TOTL+PROG)         TOTAL & PROG                              
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT35X-*)/L'XCCNDL)                                        
         DC    AL1(JLS4FULB),AL2(JLSTAT4-JLD)  FULLY BILLED                     
XCPT35X  EQU   *                                                                
*                                                                               
XCPT35A  DC    AL1(XR35),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(TOTL+PROG+ONEL)      TOTAL & PROG &ONEL                      
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT35AX-*)/L'XCCNDL)                                       
         DC    AL1(JLS4BZRO),AL2(JLSTAT4-JLD)  BALANCE IS ZERO                  
XCPT35AX EQU   *                                                                
***********************************************************************         
                                                                                
*  INVALID BILL TYPE FOR JOB WITH STUDIO LINK                                   
XCPT36   DC    AL1(XR36),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ESTM+SPCL+CLIB)                                              
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT36X-*)/L'XCCNDL)                                        
         DC    AL1(JLS2LKAG),AL2(JLSTAT2-JLD)  AGENCY LINK                      
XCPT36X  EQU   *                                                                
***********************************************************************         
                                                                                
*  JOB IS NOT FUNDED                                                            
XCPT37   DC    AL1(XR37),AL1(JLXRSXB),AL1(XCPTACL)                              
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT37X-*)/L'XCCNDL)                                        
         DC    AL1(JLS5NFND),AL2(JLSTAT5-JLD)     NOT FUNDED                    
XCPT37X  EQU   *                                                                
***********************************************************************         
                                                                                
*  MISSING AUTHORIZATION RECORD                                                 
XCPT38   DC    AL1(XR38),AL1(JLXRSXB),AL1(XCPTACL)                              
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT38X-*)/L'XCCNDL)                                        
         DC    AL1(JLS5MAUR),AL2(JLSTAT5-JLD) MISSING AUTHORIZ. REC.            
XCPT38X  EQU   *                                                                
***********************************************************************         
                                                                                
*  CAN'T UNBILL OR RERUN                                                        
XCPT39   DC    AL1(XR39),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT39X-*)/L'XCCNDL)                                        
         DC    AL1(JLS5NUNB),AL2(JLSTAT5-JLD)  CAN'T UNBILL                     
XCPT39X  EQU   *                                                                
*                                                                               
***********************************************************************         
                                                                                
*  CAN''T BILL MISSING ACCOUNT FOR POB'                                         
XCPT40   DC    AL1(XR40),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(TOTL+PROG+ONEL)      TOTAL & PROG &ONEL                      
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT40X-*)/L'XCCNDL)                                        
         DC    AL1(JLPBSMAC),AL2(JLPBSTA-JLD)                                   
XCPT40X  EQU   *                                                                
*                                                                               
***********************************************************************         
                                                                                
*  CAN''T BILL MISSING WORKCODE FOR POB'                                        
XCPT41   DC    AL1(XR41),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(TOTL+PROG+ONEL)      TOTAL & PROG &ONEL                      
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT41X-*)/L'XCCNDL)                                        
         DC    AL1(JLPBSMWC),AL2(JLPBSTA-JLD)                                   
XCPT41X  EQU   *                                                                
*                                                                               
***********************************************************************         
                                                                                
*  BILLTYPE MUST BE PROGRESSIVE OR ESTIMATE TO USE SELECTIVE WC'S               
                                                                                
XCPT42   DC    AL1(XR42),AL1(JLXRSXB),AL1(XCPTACF)                              
         DC    AL1(0)                                                           
         DC    AL1(PROG+ESTM)                                                   
         DC    AL1(0)                                                           
         DC    AL1((XCPT42X-*)/L'XCCNDL)                                        
         DC    AL1(JLS8TWCF),AL2(JLSTAT8-JLD)                                   
XCPT42X  EQU   *                                                                
         DC    AL1(EOT)                                                         
         EJECT                                                                  
***********************************************************************         
* EXCEPTION ERROR TEXT                                                *         
***********************************************************************         
                                                                                
TXTTAB   DS    0XL126                                                           
XR01     EQU   1                                                                
         DC    C'1'                                                             
         DC    AL1(XR01)                                                        
         DC    CL15'OVER EST%'                                                  
         DC    CL40'CAN''T BILL DUE TO OVERSPENDING ESTIMATE'                   
         DC    CL70'1 = CAN''T BILL-OVER EST MAX PCT-EXCEPT WHEN %EST,SX        
               PEC AMT,EST NOT REQ'                                             
*                                                                               
XR02     EQU   2                                                                
         DC    C'2'                                                             
         DC    AL1(XR02)                                                        
         DC    CL15'BAL < MIN'                                                  
         DC    CL40'CAN''T BILL DUE TO BALANCE BELOW MINIMUM'                   
         DC    CL70'2 = CAN''T BILL - BALANCE LESS THAN ''LOW''.'               
*                                                                               
XR03     EQU   3                                                                
         DC    C'3'                                                             
         DC    AL1(XR03)                                                        
         DC    CL15'JOB INACTIVE'                                               
         DC    CL40'WARNING - JOB INACTIVE FOR 6 MONTHS'                        
         DC    CL70'3 = WARNING - JOB HAS BEEN INACTIVE FOR 6 MONTHS.'          
*                                                                               
XR04     EQU   4                                                                
         DC    C'4'                                                             
         DC    AL1(XR04)                                                        
         DC    CL15'CHRGS > %EST'                                               
         DC    CL40'WARNING - ACTUALS EXCEED PCT OF ESTIMATE'                   
         DC    CL70'4 = WARNING - BILL TYPE IS %EST; ACTUALS EXCEED PCTX        
               . OF EST.'                                                       
*                                                                               
XR05     EQU   5                                                                
         DC    C'5'                                                             
         DC    AL1(XR05)                                                        
         DC    CL15'UNBILLABLE BT'                                              
         DC    CL40'CAN''T BILL-JOB HAS UNBILLABLE BILL TYPE'                   
         DC    CL70'5 = CAN''T BILL - JOB HAS UNBILLABLE BILLING TYPE.'         
*                                                                               
XR06     EQU   6                                                                
         DC    C'6'                                                             
         DC    AL1(XR06)                                                        
         DC    CL15'NO ESTIMATE'                                                
         DC    CL40'CAN''T BILL-JOB DOES NOT HAVE AN ESTIMATE'                  
         DC    CL70'6 = CAN''T BILL - JOB DOES NOT HAVE AN ESTIMATE (ORX        
                CURRENT=0).'                                                    
*                                                                               
XR07     EQU   7                                                                
         DC    C'7'                                                             
         DC    AL1(XR07)                                                        
         DC    CL15'NO EST,CHRG,BIL'                                            
         DC    CL40'WARNING - NO ESTIMATE,CHARGES OR BILLING'                   
         DC    CL70'7 = WARNING - JOB HAS NO ESTIMATE, CHARGES OR BILLIX        
               NG'                                                              
*                                                                               
XR08     EQU   8                                                                
         DC    C'8'                                                             
         DC    AL1(XR08)                                                        
         DC    CL15'PAST CLOSE DATE'                                            
         DC    CL40'WARNING - JOB IS PAST CLOSING DATE'                         
         DC    CL70'8 = WARNING - JOB IS PAST CLOSING DATE.'                    
*                                                                               
XR09     EQU   9                                                                
         DC    C'9'                                                             
         DC    AL1(XR09)                                                        
         DC    CL15'BILL CONFLICT'                                              
         DC    CL40'CAN''T BILL - CLIENT OR RETAIL CONFLICT'                    
         DC    CL70'9 = CAN''T BILL - CLT WP,ALLOCATED BILLING OR RETAIX        
               L/NONRETAIL CONFLICT'                                            
*                                                                               
XR10     EQU   10                                                               
         DC    C'A'                                                             
         DC    AL1(XR10)                                                        
         DC    CL15'UNAPP EST'                                                  
         DC    CL40'CAN''T BILL - JOB HAS UNAPPROVED ESTIMATE'                  
         DC    CL70'A = CAN''T BILL - JOB HAS UNAPPROVED ESTIMATE.'             
*                                                                               
XR11     EQU   11                                                               
         DC    C'B'                                                             
         DC    AL1(XR11)                                                        
         DC    CL15'BAL > '                                                     
         DC    CL40'JOB BALANCE GREATER THAN ''NNN'''                           
         DC    CL70'B = WARNING - JOB HAS BALANCE GREATER THAN ''NNN''.X        
               '                                                                
*                                                                               
XR12     EQU   12                                                               
         DC    C'C'                                                             
         DC    AL1(XR12)                                                        
         DC    CL15'CHGS+PO''S > EST'                                           
         DC    CL40'WARNING-CHARGES+ORDERS EXCEED ESTIMATE'                     
         DC    CL70'C = WARNING - CHARGES PLUS ORDERS EXCEED ESTIMATE.'         
*                                                                               
XR13     EQU   13                                                               
         DC    C'D'                                                             
         DC    AL1(XR13)                                                        
         DC    CL15'HELD INV'                                                   
         DC    CL40'WARNING - JOB HAS HELD INVOICES'                            
         DC    CL70'D = WARNING - JOB HAS HELD INVOICES.'                       
*                                                                               
XR14     EQU   14                                                               
         DC    C'E'                                                             
         DC    AL1(XR14)                                                        
         DC    CL15'NEED USER FLD'                                              
         DC    CL40'CAN''T BILL - MISSING USER FIELD'                           
         DC    CL70'E = CAN''T BILL - MISSING USER FIELD'                       
*                                                                               
XR15     EQU   15                                                               
         DC    C'F'                                                             
         DC    AL1(XR15)                                                        
         DC    CL15'ADD''L UNAPP R''S'                                          
         DC    CL40'WARNING-ADDITIONAL R''S AWAITING APPROVAL'                  
         DC    CL70'F = WARNING - ADDITIONAL REVISIONS AWAITING APPROVAX        
               L'                                                               
*                                                                               
XR16     EQU   16                                                               
         DC    C'G'                                                             
         DC    AL1(XR16)                                                        
         DC    CL15'BILL SELECT=NO'                                             
         DC    CL40'CAN''T BILL - BILLING SELECT SET TO NO'                     
         DC    CL70'G = CAN''T BILL - BILLING SELECT SET TO NO'                 
*                                                                               
XR17     EQU   17                                                               
         DC    C'H'                                                             
         DC    AL1(XR17)                                                        
         DC    CL15'OVER EST $'                                                 
         DC    CL40'CAN''T BILL - OVER ESTIMATE MAX AMOUNT'                     
         DC    CL70'H = CAN''T BILL-OVER EST MAX AMT-EXCEPT WHEN %EST,SX        
               PEC AMT,EST NOT REQ''D'                                          
*                                                                               
XR18     EQU   18                                                               
         DC    C'I'                                                             
         DC    AL1(XR18)                                                        
         DC    CL15'OVER GRS EST%'                                              
         DC    CL40'WARNING - OVER ESTIMATE MAX PCT-GROSS'                      
         DC    CL70'I = WARNING-OVER EST MAX PCT IN GROSS DOLLARS'              
*                                                                               
XR19     EQU   19                                                               
         DC    C'J'                                                             
         DC    AL1(XR19)                                                        
         DC    CL15'INVALID BT'                                                 
         DC    CL40'CAN''T BILL-LINKED STUDIO JOB, INVALID BT'                  
         DC    CL70'J = CAN''T BILL - INVALID BILL TYPE FOR STUDIO JOB X        
               WITH LINK.'                                                      
*                                                                               
XR20     EQU   20                                                               
         DC    C'K'                                                             
         DC    AL1(XR20)                                                        
         DC    CL15'MISSING LINK'                                               
         DC    CL40'CAN''T BILL - STUDIO JOB IS MISSING LINK'                   
         DC    CL70'K = CAN''T BILL - STUDIO JOB IS MISSING LINK.'              
*                                                                               
XR21     EQU   21                                                               
         DC    C'L'                                                             
         DC    AL1(XR21)                                                        
         DC    CL15'RETAIL STUDIO'                                              
         DC    CL40'CAN''T RETAIL BILL STUDIO JOB      '                        
         DC    CL70'L = CAN''T BILL RETAIL FOR STUDIO JOB WITH LINK.'           
*                                                                               
XR22     EQU   22                                                               
         DC    C'M'                                                             
         DC    AL1(XR22)                                                        
         DC    CL15'NO ASP ACCT'                                                
         DC    CL40'CAN''T BILL - MISSING ASP ACCOUNT  '                        
         DC    CL70'M = CAN''T BILL - MISSING ACCOUNT(S) FOR ADMINISTRAX        
               TIVE SURCHARGE.'                                                 
*                                                                               
XR23     EQU   23                                                               
         DC    C'N'                                                             
         DC    AL1(XR23)                                                        
         DC    CL15'NO ASP WC'                                                  
         DC    CL40'CAN''T BILL - MISSING ASP WORKCODE '                        
         DC    CL70'N = CAN''T BILL - MISSING WORKCODE FOR ADMINISTRATIX        
               VE SURCHARGE.'                                                   
*                                                                               
XR24     EQU   24                                                               
         DC    C'O'                                                             
         DC    AL1(XR24)                                                        
         DC    CL15'OVER CE+UNAPP R'                                            
         DC    CL40'CAN''T BILL-ACTLS EXCEED CE,ADD''L UNAPP R'                 
         DC    CL70'O = CAN''T BILL - ACTUALS EXCEED MAX CE, ADDITIONALX        
                R''S NEED APPROVAL.'                                            
*                                                                               
XR25     EQU   25                                                               
         DC    C' '                                                             
         DC    AL1(XR25)                                                        
         DC    CL15'%ESTIMATE ZERO'                                             
         DC    CL40'CAN''T BILL - % OF ESTIMATE =  0 OR 100%'                   
         DC    CL70'CAN''T BILL - % OF ESTIMATES = 0 OR 100%'                   
*                                                                               
XR26     EQU   26                                                               
         DC    C' '                                                             
         DC    AL1(XR26)                                                        
         DC    CL15'JOB CLOSED'                                                 
         DC    CL40'CAN''T BILL - JOB IS CLOSED'                                
         DC    CL70'CAN''T BILL - JOB IS CLOSED'                                
*                                                                               
XR27     EQU   27                                                               
         DC    C' '                                                             
         DC    AL1(XR27)                                                        
         DC    CL15'X-JOB'                                                      
         DC    CL40'CAN''T BILL - X-JOB'                                        
         DC    CL70'CAN''T BILL - X-JOB'                                        
*                                                                               
XR28     EQU   28                                                               
         DC    C' '                                                             
         DC    AL1(XR28)                                                        
         DC    CL15'%EST = BILLS'                                               
         DC    CL40'CAN''T BILL - %ESTIMATE = PREVIOUS BILLS'                   
         DC    CL70'CAN''T BILL - %ESTIMATE = PREVIOUS BILLS'                   
*                                                                               
XR29     EQU   29                                                               
         DC    C' '                                                             
         DC    AL1(XR29)                                                        
         DC    CL15'BILLED TODAY'                                               
         DC    CL40'CAN''T BILL - JOB ALREADY BILLED TODAY'                     
         DC    CL70'CAN''T BILL - JOB ALREADY BILLED TODAY'                     
*                                                                               
XR30     EQU   30                                                               
         DC    C' '                                                             
         DC    AL1(XR30)                                                        
         DC    CL15'NO CYCLE RECORDS'                                           
         DC    CL40'CAN''T BILL - NO CYCLE RECORDS'                             
         DC    CL70'CAN''T BILL - NO CYCLE RECORDS'                             
*                                                                               
XR31     EQU   31                                                               
         DC    C' '                                                             
         DC    AL1(XR31)                                                        
         DC    CL15'CYCLE SEQUENCE'                                             
         DC    CL40'CAN''T BILL - CYCLE BILLING OUT OF SEQUENCE'                
         DC    CL70'CAN''T BILL - CYCLE BILLING OUT OF SEQUENCE'                
*                                                                               
XR32     EQU   32                                                               
         DC    C' '                                                             
         DC    AL1(XR32)                                                        
         DC    CL15'TYPE NOT AUTO'                                              
         DC    CL40'CAN''T BILL - NOT AN ''AUTO'' BILL TYPE'                    
         DC    CL70'CAN''T BILL - NOT AN ''AUTO'' BILL TYPE'                    
*                                                                               
XR33     EQU   33                                                               
         DC    C' '                                                             
         DC    AL1(XR33)                                                        
         DC    CL15'NO DISTRIB. %'                                              
         DC    CL40'NO DISTRIBUTOR PERCENTS'                                    
         DC    CL70'NO DISTRIBUTOR PERCENTS'                                    
*                                                                               
XR34     EQU   34                                                               
         DC    C' '                                                             
         DC    AL1(XR34)                                                        
         DC    CL15'DIST. NOT 100%'                                             
         DC    CL40'DISTRIBUTION % NOT EQUAL 100'                               
         DC    CL70'DISTRIBUTION % NOT EQUAL 100'                               
*                                                                               
XR35     EQU   35                                                               
         DC    C' '                                                             
         DC    AL1(XR35)                                                        
         DC    CL15'FULLY BILLED'                                               
         DC    CL40'JOB HAS NO UNBILLED CHARGES'                                
         DC    CL70'JOB HAS NO UNBILLED CHARGES'                                
*                                                                               
XR36     EQU   36                                                               
         DC    C' '                                                             
         DC    AL1(XR36)                                                        
         DC    CL15'INVALID STUDIO'                                             
         DC    CL40'INVALID BILL TYPE FOR JOB WITH STUDIO LINK'                 
         DC    CL70'INVALID BILL TYPE FOR JOB WITH STUDIO LINK'                 
*                                                                               
XR37     EQU   37                                                               
         DC    C' '                                                             
         DC    AL1(XR37)                                                        
         DC    CL15'NOT FUNDED'                                                 
         DC    CL40'CAN''T BILL - JOB IS NOT FUNDED'                            
         DC    CL70'CAN''T BILL - JOB IS NOT FUNDED'                            
*                                                                               
XR38     EQU   38                                                               
         DC    C' '                                                             
         DC    AL1(XR38)                                                        
         DC    CL15'MISSING AUT REC'                                            
         DC    CL40'MISSING AUTHORIZATION RECORD'                               
         DC    CL70'MISSING AUTHORIZATION RECORD'                               
*                                                                               
XR39     EQU   39                                                               
         DC    C' '                                                             
         DC    AL1(XR39)                                                        
         DC    CL15'CAN''T UNBILL'                                              
         DC    CL40'CAN''T UNBILL OR RERUND'                                    
         DC    CL70'CAN''T UNBILL OR RERUND'                                    
*                                                                               
XR40     EQU   40                                                               
         DC    C' '                                                             
         DC    AL1(XR40)                                                        
         DC    CL15'MISSING POB ACC'                                            
         DC    CL40'CAN''T BILL MISSING ACCOUNT FOR POB'                        
         DC    CL70'CAN''T BILL MISSING ACCOUNT FOR PERCENT OF BILLING'         
*                                                                               
XR41     EQU   41                                                               
         DC    C' '                                                             
         DC    AL1(XR41)                                                        
         DC    CL15'MISSING POB W/C'                                            
         DC    CL40'CAN''T BILL MISSING WORKCODE FOR POB'                       
         DC    CL70'CAN''T BILL MISSING WORKCODE FOR PERCENT OF BILLINGX        
               '                                                                
*                                                                               
XR42     EQU   42                                                               
         DC    C' '                                                             
         DC    AL1(XR42)                                                        
         DC    CL15'MUST BE P OR %'                                             
         DC    CL40'BILLTYPE MUST BE PROGRESSIVE OR ESTIMATE'                   
         DC    CL70'BILLTYPE MUST BE PROGRESSIVE OR ESTIMATE TO USE SELX        
               ECTIVE WC''S'                                                    
*                                                                               
         DC    AL1(EOT)                                                         
         EJECT                                                                  
***********************************************************************         
* TABLES / STORGAGE                                                   *         
***********************************************************************         
                                                                                
COLISTL  EQU   400                                                              
COLIST   DS    (COLISTL)X                                                       
*                                                                               
COLTABL  EQU   20000                                                            
COLTAB   DS    (COLTABL)X                                                       
*                                                                               
OPVTABL  EQU   24000                                                            
OPVTAB   DS    (OPVTABL)X                                                       
*                                                                               
         EJECT                                                                  
***********************************************************************         
* DSECT FOR LOCAL WORKING STORAGE                                     *         
***********************************************************************         
                                                                                
LWSD     DSECT                                                                  
DATAMGR  DS    A                                                                
DATCON   DS    A                                                                
ADDAY    DS    A                                                                
COMFACS  DS    A                                                                
GETOPT   DS    A                                                                
JOBBER   DS    A                                                                
JOBCOL   DS    A                                                                
AIO      DS    A                                                                
*                                                                               
COMMANDS DS    0CL(DMCMDLNQ)                                                    
DMKEY    DS    CL8                                                              
ACCDIR   DS    CL8                                                              
ACCMST   DS    CL8                                                              
DMREAD   DS    CL8                                                              
DMRDHI   DS    CL8                                                              
DMRSEQ   DS    CL8                                                              
GETREC   DS    CL8                                                              
*                                                                               
AIO1     DS    A                                                                
AIO2     DS    A                                                                
AIO3     DS    A                                                                
*                                                                               
DUB      DS    D                                                                
FULL     DS    F                                                                
DMCB     DS    6F                                                               
WORK     DS    CL80                                                             
HALF     DS    H                                                                
DATADISP DS    H                                                                
NEWDISP  DS    H                                                                
BYTE     DS    XL1                                                              
SPACES   DS    CL80                                                             
BINZ     DS    XL15                                                             
PZERO    DS    PL6                                                              
*                                                                               
PL13     DS    PL13                                                             
PL16     DS    PL16                                                             
MODE     DS    XL1                                                              
ACCFRST  EQU   XCPTACF                                                          
ACCLAST  EQU   XCPTACL                                                          
*                                                                               
ERRORS   DS    XL1                                                              
ERRF     EQU   X'80'               ERROR F + (1 OR H)                           
ERR1     EQU   X'40'                     1                                      
ERRH     EQU   X'40'                     H                                      
ERRF1H   EQU   X'C0'                                                            
*                                                                               
CPY      DS    XL1                 COMPANY CODE                                 
MOS      DS    XL2                                                              
WCODE    DS    CL2                 WORKCODE                                     
CYCPER   DS    F                   % FROM CYCLE RECORD                          
*                                                                               
LBK      DS    0PL6                                                             
NET      DS    PL(L'LBK)                                                        
COM      DS    PL(L'LBK)                                                        
GRS      DS    PL(L'LBK)                                                        
CSD      DS    PL(L'LBK)                                                        
HRS      DS    PL(L'LBK)                                                        
COMR     DS    PL(L'LBK)                                                        
SKINC    DS    PL(L'LBK)                                                        
UNBIL    DS    XL(JLBKRLQ)         UNBILLED BUCKETS                             
LBKN     EQU   (*-LBK)/L'LBK                                                    
*                                                                               
ELCODE   DS    XL1                                                              
*                                                                               
ESACBL   DS    PL(L'JLBK)          ESTIMATE + ACTUAL + BILLING                  
*                                                                               
SVRE     DS    F                                                                
SVRF     DS    F                                                                
SVR0     DS    F                                                                
SVR1     DS    F                                                                
SVR2     DS    F                                                                
SVR3     DS    F                                                                
SVR4     DS    F                                                                
SVR5     DS    F                                                                
SVR6     DS    F                                                                
SVR7     DS    F                                                                
*                                                                               
WCEL     DS    XL(WCOLNQ)          WORKCODE ELEMENT                             
*                                                                               
ADTRNR   DS    A                   A(TRANSACTION)                               
ABILLTAB DS    A                   A(BILLTAB)                                   
APTARRL  DS    A                   A(PTAEL BEING RERUN/UNBILLED)                
*                                                                               
DKEY     DS    XL42                                                             
DIR      DS    XL60                                                             
DA       DS    F                                                                
DMWORK   DS    XL96                                                             
*                                                                               
ALKEY    DS    A                   A(LAST KEY)                                  
LKEY     DS    XL(L'ACCKEY)                                                     
ATKEY    DS    A                   A(TRANSACTION KEY)                           
TKEY     DS    XL(L'ACCKEY)                                                     
*                                                                               
FLAG     DS    XL1                                                              
COMRTL   EQU   X'80'               COMMISSION RATE APPLIES TO RETAIL            
JOBFLT   EQU   X'40'               RETAIL FILTER BY JOB                         
ACCTLO   EQU   X'20'               LOW LEVEL ACCOUNT                            
FRSTUB   EQU   X'10'               FOUND FIRST FOR UNBILL                       
*                                                                               
LVACC    DS    0X                                                               
LVARCV   DS    CL(L'ACTKCULA)      LEVEL A RECEIVABLE                           
LVACST   DS    CL(L'ACTKCULA)      LEVEL A COSTING                              
LVACCLNQ EQU   *-LVACC                                                          
LVBRCV   DS    CL(L'ACTKCULA)                                                   
LVBCST   DS    CL(L'ACTKCULA)                                                   
LVCRCV   DS    CL(L'ACTKCULA)                                                   
LVCCST   DS    CL(L'ACTKCULA)                                                   
LVDRCV   DS    CL(L'ACTKCULA)                                                   
LVDCST   DS    CL(L'ACTKCULA)                                                   
*                                                                               
RTLINIQ  EQU   1                   INITIALIZE RETAIL TABLE                      
RTLPRBQ  EQU   2                   ADD PREVIOUS BILLS TO TABLE                  
RTLALLQ  EQU   3                   ALLOCATE BILLABLE CHARGES                    
RTLUNBQ  EQU   4                   ADD AN UNBILLING ENTRY                       
*                                                                               
RETLCMR  DS    PL6                 COMMISSION RATE                              
RETLACT  DS    CL(L'ACTKCULA)      ACCOUNT TO WHICH RATE APPLIES                
TOTCHRG  DS    XL(JLBKRLQ)         TOTAL CHARGES FOR DISTRIBUTION               
TOTREMN  DS    XL(JLBKRLQ)         TOTAL REMAINING                              
ABIGRTL  DS    A                   ADDRESS OF ENTRY WITH BIGGEST %              
*                                                                               
SRTLNME  DS    CL(L'RTLNME)                                                     
SRTLADDR DS    CL(L'RTLADDR)                                                    
*                                                                               
DMBLK    DS    0CL(DMBLKX-DMBPGM)                                               
DMBPGM   DS    CL(L'DMJOBW)         PROGRAM                                     
         DS    CL1                                                              
DMBCOM   DS    CL8                  COMMAND                                     
         DS    CL1                                                              
DMBFIL   DS    CL8                  FILE                                        
         DS    CL1                                                              
DMBDMCW  DS    CL(L'DMCOUNTW)       DMCOUNT=                                    
DMBDMC   DS    CL7                  000                                         
         DS    CL1                                                              
DMBIOW   DS    CL(L'DMSTIOW)        START IO=                                   
DMBIO    DS    CL7                  000                                         
DMBLKX   EQU   *                                                                
       ++INCLUDE ACJOBBLOCK                                                     
*                                                                               
IOLNQ    EQU   2048                                                             
IO1      DS    XL(IOLNQ)                                                        
IO2      DS    XL(IOLNQ)                                                        
IO3      DS    XL(IOLNQ)                                                        
LWSLNQ   EQU   *-LWSD                                                           
                                                                                
         EJECT                                                                  
JLD      DSECT                                                                  
       ++INCLUDE ACJOBLOTD                                                      
         EJECT                                                                  
***********************************************************************         
* DSECT FOR EXCEPTION REASON TABLE                                    *         
***********************************************************************         
                                                                                
XCPD     DSECT ,                   EXCEPTION TABLE                              
XCPTRN   DS    AL1                 REASON NUMBER                                
XCPTSTA  DS    XL1                 STATUS (SEE JLXRSTA)                         
XCPTLEV  DS    XL1                 LEVEL AT WHICH IT CAN BE TESTED              
XCPTACF  EQU   1                   CAN BE TESTED AT ACCFRST OR ACCLAST          
XCPTACL  EQU   0                   CAN BE TESTED AT ACCLAST - ONLY              
XCPTBIN  DS    XL1                 BILL TYPES TO INCLUDE                        
XCPTBEX  DS    XL1                 BILL TYPES TO EXCLUDE                        
XCPINDS  DS    XL1                 INDICATORS                                   
XCPIRRN  EQU   X'80'               RULE APPLIES TO RERUN/UNBILN                 
XCPTNUM  DS    XL1                 NUMBER OF TESTS                              
XCPTLNQ  EQU   *-XCPD                                                           
*                                                                               
XCCNDL   DS    0XL3                CONDITION TESTS                              
XCCBITS  DS    AL1                 BITS TO TEST                                 
XCCDSP   DS    AL2                 DISPLACEMENT TO STATUS BYTE                  
                                                                                
         EJECT                                                                  
         PRINT ON                                                               
* ACDDEQUS                                                                      
         PRINT OFF                                                              
       ++INCLUDE ACDDEQUS                                                       
         PRINT ON                                                               
* ACGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACGENFILE                                                      
         PRINT ON                                                               
* ACMASTD                                                                       
         PRINT OFF                                                              
       ++INCLUDE ACMASTD                                                        
         PRINT ON                                                               
GOBLOCKD DSECT                                                                  
* ACGOBLOCK                                                                     
*        PRINT OFF                                                              
       ++INCLUDE ACGOBLOCK                                                      
GOXBLKD  DSECT                                                                  
       ++INCLUDE ACGOXBLOCK                                                     
         PRINT ON                                                               
* ACJOBBERD                                                                     
*--->    PRINT OFF                                                              
       ++INCLUDE ACJOBBERD                                                      
         PRINT ON                                                               
* COMFACSD                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDCOMFACSD                                                     
         PRINT ON                                                               
* DDCOREQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCOREQUS                                                      
         PRINT ON                                                               
* DDMASTD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDMASTD                                                        
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'022ACJOBLOT  10/03/06'                                      
         END                                                                    
