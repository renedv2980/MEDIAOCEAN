*          DATA SET DDSCRGEN   AT LEVEL 033 AS OF 01/08/13                      
*PROCESS USING(WARN(15))                                                        
*CATALP SCRGEN                                                                  
         SPACE 1                                                                
*USES WRKFIL TO STORE ALL INPUT FROM CARDS AND/OR PAN LIBRARY                   
*                                                                               
*USES PANFIL TO BUILD INPUT TO PAN#1 FOR DSECT CREATION/UPDATING                
*                                                                               
*USES LNKFIL TO BUILD INPUT TO LNKEDT FOR PHASE CREATION                        
         SPACE 1                                                                
*FOR DOS VERSION LNKFIL IS THE SAME FILE AS PANFIL                              
         TITLE 'SCRGEN - PROGRAM TO HANDLE SCREEN DECKS (CARDS OR PAN)'         
         PRINT NOGEN                                                            
SCRGEN   CSECT                                                                  
         NBASE 0,**SGEN**,=V(REGSAVE),R9,R8,R7                                  
*                                                                               
         ENTRY SSB                                                              
*                                                                               
         L     RA,=V(CPRINT)                                                    
         USING DPRINT,RA                                                        
         GOTO1 =V(STXITER),PARA,A(DUMPLIST)                                     
         L     R6,=A(BOOKPOOL)                                                  
         USING POOLD,R6                                                         
         BAS   RE,OPNDSK           OPEN ALL DISK FILES                          
         GOTO1 =V(PANIC),PNPL,(X'00',=C'OPEN')                                  
         SPACE 2                                                                
         MVC   TITLE+15(30),=C'INPUT LISTING AND ERROR REPORT'                  
         MVC   SUB1(39),=C'DETAILS OF INPUT CARDS (AND OTHER INFO)'             
         MVC   SUB1+90(11),=C'CARD ERRORS'                                      
         MVC   SUB2(39),=39C'-'                                                 
         MVC   SUB2+90(11),=11C'-'                                              
         DATE  DATE,DATE=NO                                                     
         MVC   COUNTRY,DATE+6                                                   
         GOTO1 =V(DATCON),PARA,(5,0),(10,DATE)                                  
         EJECT                                                                  
*              ROUTINES TO HANDLE READING OF CARDS AND PAN BOOKS                
*                                                                               
READ     MVC   LASTC,C                                                          
         GOTO1 =V(CARDS),PARA,C,=C'RE00'                                        
         OC    C(30),SPACES                                                     
         CLC   C(2),=C'/*'                                                      
         BNE   READ2                                                            
         BAS   RE,BKEND1                                                        
         BAS   RE,PUTWRK                                                        
         B     PHASE2                                                           
         SPACE 2                                                                
READ2    MVC   P(80),C             TEST START OF SCREEN CARD                    
         CLI   C,C'S'                                                           
         BNE   READ4                                                            
         BAS   RE,BKEND1                                                        
         MVC   PANBOOK,SPACES      CLEAR PAN BOOK DATA                          
         MVC   PANTYPE,SPACES                                                   
         MVC   PANLEVEL,SPACES                                                  
         BAS   RE,BKSTART1                                                      
         B     READ                                                             
         SPACE 2                                                                
READ4    CLI   C,C'F'              TEST SCREEN FIELD CARD                       
         BNE   READ6                                                            
         CLC   C+3(10),SPACES      TEST IF CONTINUATION CARD                    
         BNE   *+14                                                             
         MVC   C(3),SPACES                                                      
         B     READ6                                                            
         BAS   RE,FIELD1                                                        
         B     READ                                                             
         SPACE 2                                                                
READ6    CLC   C(13),SPACES        TEST CONTINUATION CARD                       
         BNE   READ8                                                            
         BAS   RE,OVER1            TEST IF VALID                                
         B     READ                                                             
         SPACE 2                                                                
READ8    MVI   NOOPFLAG,C'N'                                                    
         CLI   C,C'P'              TEST IF NAME OF PAN BOOK                     
         BE    PAN                                                              
         CLC   C(11),=C'OPTION TEST'                                            
         BNE   READ10                                                           
         MVI   TESTSW,C'Y'                                                      
         CLI   C+12,C' '           SET PHASE TEST LEVEL (DEFAULT IS T)          
         BE    READ                                                             
         MVC   TESTSW,C+12                                                      
         B     READ                                                             
         SPACE 2                                                                
READ10   CLC   C(12),=C'OPTION PHASE'                                           
         BNE   READ12                                                           
         MVC   OVRPHASE,C+13                                                    
         B     READ                                                             
         SPACE 2                                                                
READ12   CLC   C(13),=C'OPTION NOTAGS'                                          
         BNE   READ14                                                           
         MVI   TAGSW,C'N'                                                       
         B     READ                                                             
         SPACE 2                                                                
READ14   CLC   C(9),=C'OPTION UK'                                               
         BE    *+14                                                             
         CLC   C(9),=C'OPTION US'                                               
         BNE   READ16                                                           
         MVC   COUNTRY,C+7                                                      
         B     READ                                                             
         SPACE 2                                                                
READ16   CLC   C(11),=C'OPTION LANG'                                            
         BNE   READ17                                                           
         MVC   LANGS,C+12                                                       
         B     READ                                                             
         SPACE 2                                                                
READ17   CLC   C(11),=C'OPTION XATB'                                            
         BNE   READ20                                                           
         CLI   C+12,C'B'                                                        
         BNE   *+8                                                              
         OI    XATBOPT,X'80'                                                    
         B     READ                                                             
         SPACE 2                                                                
READ20   BAS   RE,ERROR1                                                        
         B     READ                                                             
         EJECT                                                                  
PAN      BAS   RE,BKEND1           LOCATE PAN BOOK ON PAN LIBRARY               
         MVI   NEWBOOK,C'Y'        ABOUT TO READ A NEW PAN BOOK                 
         MVC   PANBOOK,C+1                                                      
         MVC   PANSRCBK,PANBOOK                                                 
         MVC   PANLEVEL,SPACES                                                  
         MVC   PANTYPE,SPACES                                                   
         MVC   DICTBOOK(2),PANBOOK BUILD THE DEFAULT DICTIONARY                 
         BAS   RE,DEFDICT                                                       
         LA    R2,1                                                             
         GOTO1 =V(PANIC),PNPL,(X'00',=C'READ'),=C'DIR',PANBOOK,C                
         OC    C(30),SPACES                                                     
         CLI   PNPL+8,0                                                         
         BNE   PAN4A                                                            
         MVC   PANLEVEL,C+10       SAVE LEVL FROM 0-UP DIR ENTRY                
         MVC   PANTYPE,C+18        SAVE TYPE FROM 0-UP DIR ENTRY                
         SPACE 2                                                                
         MVC   STAMPID+5(10),C+0   FILL IN STAMP VALUES                         
         MVC   STAMPID+22(3),C+10                                               
         MVC   STAMPID+31(8),C+26                                               
         OC    STAMPID,SPACES                                                   
         SPACE 2                                                                
PAN2     MVC   LASTC,C                                                          
         GOTO1 =V(PANIC),PNPL,(X'80',=C'READ'),=C'PAN',PANBOOK,C                
         OC    C(30),SPACES                                                     
         TM    PNPL+8,X'80'                                                     
         BZ    PAN4                                                             
         BAS   RE,BKEND1                                                        
         B     READ                                                             
         SPACE 2                                                                
PAN4     TM    PNPL+8,X'10'                                                     
         BZ    PAN4B                                                            
PAN4A    MVC   P(10),PANBOOK                                                    
         MVC   P+90(20),=C'PAN BOOK NOT ON FILE'                                
         GOTO1 =V(PRINTER)                                                      
         ZAP   LINE,=P'75'                                                      
         MVC   PANBOOK,SPACES                                                   
         B     READ                                                             
         SPACE 2                                                                
PAN4B    DS    0H                                                               
*                                  THIS WAS US ONLY                             
         CLI   NEWBOOK,C'Y'        EACH NEW MEMBER MUST BEGIN WITH *GEN         
         BNE   PAN5                                                             
         MVI   NEWBOOK,C'N'                                                     
         CLC   =C'*GEN ',C                                                      
         BE    PAN5                                                             
         MVC   P+90(31),=C'PAN BOOK MUST BEGIN WITH "*GEN"'                     
         B     ERROR                                                            
*                                                                               
PAN5     CLI   C,C'*'              IGNORE PAN BAL COMMENT CARD                  
         BNE   PAN5A                                                            
         CLC   C+1(10),SPACES                                                   
         BNE   PAN5A                                                            
         CLC   C+11(8),=C'DATA SET'                                             
         BE    PAN2                                                             
         CLC   =C'EQUATE BOOK FOR DATA DICTIONARY',C+22                         
         BNE   PAN5A                                                            
         BAS   RE,INCDICT          BUILD THE OVERRIDE DATA DICTIONARY           
         B     PAN2                                                             
         SPACE 2                                                                
PAN5A    CVD   R2,DUB              BUMP SEQUENCE NUMBER                         
         LA    R2,1(R2)                                                         
         CLC   PANTYPE(3),=C'ASM'                                               
         BE    PAN5B                                                            
         UNPK  P+81(5),DUB                                                      
         OI    P+85,X'F0'                                                       
PAN5B    CLI   PNPL+8,0                                                         
         BE    PAN6                                                             
         DC    H'0'                                                             
         DC    C'DISK ERROR ON READING PAN '                                    
         SPACE 2                                                                
PAN6     CLI   C,C'S'                                                           
         BNE   PAN8                                                             
         BAS   RE,BKEND1                                                        
         MVC   C+46(04),=C'PAN='                                                
         MVC   C+50(10),PANBOOK    SET BOOK/LEVEL/TYPE ON SCREEN CARD           
         MVI   C+60,C'/'                                                        
         MVC   C+61(3),PANLEVEL                                                 
         MVI   C+64,C'/'                                                        
         MVC   C+65(5),PANTYPE                                                  
         BAS   RE,BKSTART1                                                      
         B     PAN2                                                             
         SPACE 2                                                                
PAN8     CLI   C,C'F'              TEST SCREEN FIELD CARD                       
         BNE   PAN10                                                            
         CLC   C+3(10),SPACES      TEST IF CONTINUATION CARD                    
         BNE   *+14                                                             
         MVC   C(3),SPACES                                                      
         B     PAN10                                                            
         BAS   RE,FIELD1                                                        
         B     PAN2                                                             
         SPACE 2                                                                
PAN10    CLC   C(13),SPACES        TEST CONTINUATION CARD                       
         BNE   PAN12                                                            
         BAS   RE,OVER1            TEST IF VALID                                
         B     PAN2                                                             
         SPACE 2                                                                
PAN12    MVI   NOOPFLAG,C'N'                                                    
         CLI   C,C'*'                                                           
         BNE   PAN14                                                            
         MVC   P(80),C                                                          
         GOTO1 =V(PRINTER)                                                      
         B     PAN2                                                             
         SPACE 2                                                                
PAN14    BAS   RE,ERROR1                                                        
         B     PAN2                                                             
         EJECT                                                                  
*              BUILD DEFAULT DATA DICTIONARY                                    
*                                                                               
DEFDICT  NTR1                                                                   
*                                                                               
         MVC   P(44),=C'(READING DEFAULT DATA DICTIONARY XXXXXXXXXX)'           
         MVC   P+33(10),DICTBOOK                                                
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         GOTO1 =V(PANIC),PNPL,(X'00',=C'READ'),=C'DIR',DICTBOOK,C               
         CLI   PNPL+8,0                                                         
         BNE   DEFDICT4            PROBLEM READING DICTIONARY BOOK              
*                                                                               
DEFDICT2 GOTO1 =V(PANIC),PNPL,(X'80',=C'READ'),=C'PAN',DICTBOOK,C               
         CLI   PNPL+8,0                                                         
         BNE   *+12                WE DON'T HAVE A RECORD                       
         BAS   RE,ADD1DENT         ADD 1 ENTRY TO THE DATA DICTIONARY           
         B     DEFDICT2            LOOP THROUGH THE ENTIRE PAN BOOK             
*                                                                               
         TM    PNPL+8,X'80'        END OF PAN BOOK?                             
         BO    DEFDICTX            YES                                          
         TM    PNPL+8,X'10'        INCLUDE NOT FOUND?                           
         BO    DEFDICT4            YES                                          
         DC    H'0'                FATAL PAN ERROR                              
*                                                                               
DEFDICT4 MVC   P(31),=C'(PAN BOOK XXXXXXXXXX NOT FOUND)'                        
         MVC   P+10(10),DICTBOOK                                                
         GOTO1 =V(PRINTER)                                                      
*                                                                               
DEFDICTX B     XIT                                                              
         EJECT                                                                  
*              BUILD ++INCLUDED (OVERRIDE) DICTIONARY                           
*                                                                               
INCDICT  NTR1                                                                   
*                                                                               
         L     RF,=A(DICTPOOL)     A(DATA DICTIONARY)                           
         ST    RF,ANXTDICT         RESET POINTER BACK TO BEGINNING              
         L     R0,=A(MAXDENTS)                                                  
         XC    0(10,RF),0(RF)      CLEAR THE DEFAULT DICTIONARY ENTRIES         
         LA    RF,10(RF)           BUMP TO NEXT DICTIONARY ENTRY                
         BCT   R0,*-10                                                          
*                                                                               
         MVC   P(34),=C'(READING OVERRIDE DATA DICTIONARY)'                     
         GOTO1 =V(PRINTER)                                                      
*                                                                               
INCDICT2 GOTO1 =V(PANIC),PNPL,(X'80',=C'READ'),=C'PAN',PANBOOK,C                
         CLI   PNPL+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                NO PAN ERROR CAN LEGITIMATELY OCCUR!         
*                                                                               
         CLC   =C'END OF DATA DICTIONARY EQUATE BOOK',C+22                      
         BE    XIT                                                              
         BAS   RE,ADD1DENT         ADD 1 ENTRY TO THE DATA DICTIONARY           
         B     INCDICT2            LOOP THROUGH THE ENTIRE PAN BOOK             
         EJECT                                                                  
*              ADD ONE ENTRY TO DATA DICTIONARY TABLE                           
*                                                                               
ADD1DENT NTR1                                                                   
*                                                                               
         CLC   =C' EQU ',C+8       EQU CARD?                                    
         BNE   ADD1DX              NO -- IGNORE IT                              
*                                                                               
         LA    RE,C+15             LOCATE EQUATED VALUE                         
         SR    R1,R1               SET BLANK AS DELIMITER                       
ADD1D10  CLI   0(RE),C' '                                                       
         BE    ADD1D50                                                          
         CLI   0(RE),C'+'                                                       
         BNE   ADD1D40                                                          
*                                                                               
         CLC   =C'#DISK ',3(RE)    EQUATE FOR DISK ITEM?                        
         BE    *+14                                                             
         CLC   =C'32768',1(RE)                                                  
         BNE   *+12                                                             
         L     R1,=F'32768'        SET +32768 AS DELIMITER                      
         B     ADD1D50                                                          
*                                                                               
         CLC   =C'#COM',3(RE)      EQUATE FOR COMMON ITEM?                      
         BE    ADD1D20                                                          
         CLC   =C'#GEN',3(RE)                                                   
         BE    ADD1D20                                                          
         CLC   =C'16384',1(RE)                                                  
         BNE   *+12                                                             
ADD1D20  LHI   R1,16384            SET +16384 AS DELIMITER                      
         B     ADD1D50                                                          
*                                                                               
         CLC   =C'#DISKC',3(RE)    EQUATE FOR DISK COMMON ITEM?                 
         BE    ADD1D30                                                          
         CLC   =C'#DISKG',3(RE)                                                 
         BE    ADD1D30                                                          
         CLC   =C'49152',1(RE)                                                  
         BNE   ADD1DX                                                           
ADD1D30  L     R1,=F'49152'        SET +49152 AS DELIMITER                      
         B     ADD1D50                                                          
*                                                                               
ADD1D40  LA    RE,1(RE)                                                         
         B     ADD1D10                                                          
*                                                                               
ADD1D50  LA    RF,C+15                                                          
         SR    RE,RF                                                            
         BNP   ADD1DX                                                           
         BCTR  RE,0                                                             
         MVC   DUB,=8C'0'          TEST IF NUMERIC                              
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVZ   DUB(0),C+15                                                      
         CLC   DUB,=8C'0'                                                       
         BNE   ADD1DX                                                           
         EX    RE,*+8                                                           
         B     *+10                                                             
         PACK  DUB(8),C+15(0)                                                   
         CVB   R0,DUB                                                           
         AR    R0,R1               ADJUST FOR DISK AND/OR COMMON                
*                                                                               
         L     RF,ANXTDICT         SAVE DICTIONARY ITEM                         
         CLC   =CL10'ENDOFDICT',10(RF)                                          
         BNE   *+6                                                              
         DC    H'0'                INCREASE MAXDENTS                            
*                                                                               
         MVC   0(8,RF),C           SET EQUATE NAME                              
         STH   R0,8(RF)            SET EQUATE BINARY VALUE                      
         LA    RF,10(RF)                                                        
         ST    RF,ANXTDICT                                                      
*                                                                               
ADD1DX   B     XIT                                                              
         EJECT                                                                  
*              START AND END OF BOOKS (PHASE 1)                                 
*                                                                               
BKSTART1 NTR1                                                                   
         XC    POOLITEM,POOLITEM                                                
         MVC   BOOK(4),C+4         BOOK=TSPPOO                                  
         MVC   BOOK+4(2),C+1                                                    
         CLI   C+3,C' '            OVERRIDE TEST PHASE SUFFIX PRESENT?          
         BNH   *+10                                                             
         MVC   TESTSW,C+3          YES: USE IT                                  
         MVC   BEFORE(3),C+9                                                    
         MVC   GEN,C+12                                                         
         MVI   VALIDITY,C'Y'                                                    
         MVI   SWITCH,1                                                         
         MVC   P(80),C                                                          
         MVI   SPACING+3,C'2'                                                   
         GOTO1 =V(PRINTER)                                                      
         MVI   SPACING+3,C'1'                                                   
         MVC   STAMPIT,C+16        SAVE STAMP FLAG                              
         CLC   PANTYPE(3),=C'ASM'                                               
         BNE   BKSTRT1A                                                         
         CLI   C+29,C' '                                                        
         BNE   BKSTRT1A                                                         
         MVI   C+29,C'B'           SET COL72 DEFAULT FOR BAL BOOKS              
*                                                                               
BKSTRT1A XC    TWAHDR,TWAHDR       INITIALISE CONTINUATION CARD STACK           
         MVI   TWAHDR+3,50         SET DATA WIDTH                               
         CLI   C+29,C' '                                                        
         BE    *+8                                                              
         MVI   TWAHDR+3,42                                                      
         BAS   RE,PUTWRK                                                        
         MVC   LASTROW(7),=C'0000000'                                           
         XC    LASTEND,LASTEND                                                  
         B     XIT                                                              
         SPACE 2                                                                
BKEND1   NTR1                                                                   
         CLI   SWITCH,0                                                         
         BE    XIT                                                              
         MVI   SWITCH,0                                                         
         BAS   RE,PUTSTK           PUT CARDS IN STACK TO WRK FILE               
         BNE   ERROR                                                            
         ZAP   LINE,=P'75'                                                      
         MVC   DUB,PHASELEN                                                     
         LH    R1,DUB                                                           
         LA    R1,3(R1)            ADD THREE FOR EOS AND INDICS                 
         STH   R1,DUB                                                           
         MVC   PHASELEN,DUB                                                     
         LA    R6,16(R6)                                                        
         B     XIT6                                                             
         EJECT                                                                  
*              VALIDATE FIELD CARDS                                             
*                                                                               
OVER1    NTR1                                                                   
         MVC   P(80),C                                                          
         CLI   NOOPFLAG,C'Y'       TEST PREVIOUS CARD DELETED BY CNTRY          
         BNE   OVER2                                                            
         GOTO1 =V(PRINTER)                                                      
         B     XIT                                                              
         SPACE 2                                                                
OVER2    CLI   LASTC+29,C'C'       PREVIOUS CARD MUST SAY CONTINUE              
         BE    OVER21                                                           
         MVC   P+90(32),=C'PREVIOUS CARD NOT A CONTINUATION'                    
         B     ERROR                                                            
         SPACE 2                                                                
OVER21   CLC   C+24(3),SPACES      TEST IF STEREO FIELD NUMBER                  
         BE    CARDSV                                                           
         MVC   P+90(32),=CL32'INVALID STEREO ID NUMBER'                         
         CLC   TWAHDR(2),=H'1'                                                  
         BNE   ERROR               STEREO NUMBER ONLY ON 2ND CARD               
         CLI   C+26,C' '                                                        
         BNE   *+20                                                             
         MVC   C+26(1),C+25                                                     
         MVC   C+25(1),C+24                                                     
         MVI   C+24,C' '                                                        
         CLI   C+26,C' '                                                        
         BNE   *+20                                                             
         MVC   C+26(1),C+25                                                     
         MVC   C+25(1),C+24                                                     
         MVI   C+24,C' '                                                        
         CLI   C+24,C' '                                                        
         BNE   *+8                                                              
         MVI   C+24,C'0'                                                        
         CLI   C+25,C' '                                                        
         BNE   *+8                                                              
         MVI   C+25,C'0'                                                        
         MVC   WORK(3),=3X'F0'                                                  
         MVZ   WORK(3),C+24                                                     
         CLC   WORK(3),=3X'F0'                                                  
         BNE   ERROR                                                            
         CLC   C+24(3),=C'000'                                                  
         BE    ERROR                                                            
         CLC   C+24(3),=C'255'                                                  
         BH    ERROR                                                            
*                                  CHECK FIELD # IN FIRST CARD ALREADY          
         CLC   LASTC+24(3),SPACES  ADDED LENGTH FOR EXTENDED HEADED             
         BNE   CARDSV                                                           
         SR    RF,RF                                                            
         ICM   RF,3,PHASELEN       ELSE ADD LENGTH FOR EXTENDED HEADER          
         LA    RF,EXTENLNQ(RF)     CREATED BY STEREO FIELD #                    
         STCM  RF,3,PHASELEN                                                    
         B     CARDSV                                                           
         SPACE 2                                                                
ERROR1   NTR1                                                                   
         MVC   P+90(21),=C'NOT A VALID CARD TYPE'                               
         B     ERROR                                                            
         SPACE 2                                                                
FIELD1   NTR1                                                                   
         MVC   P(80),C                                                          
         BAS   RE,TSTCTRY          FILTER ON COUNTRY CODE                       
         BE    FIELD1A                                                          
         SPACE 2                                                                
         MVI   NOOPFLAG,C'Y'       TURN ON DELETED FLAG                         
         MVC   P+90(32),=CL32'DELETED BY COUNTRY CODE'                          
         MVI   P,C'*'                                                           
         GOTO1 =V(PRINTER)                                                      
         B     XIT                                                              
         SPACE 2                                                                
FIELD1A  MVC   P+90(32),=CL32'INVALID ID NUMBER'                                
         CLC   C+24(3),SPACES                                                   
         BE    FIELD1C                                                          
         CLI   C+26,C' '                                                        
         BNE   *+20                                                             
         MVC   C+26(1),C+25                                                     
         MVC   C+25(1),C+24                                                     
         MVI   C+24,C' '                                                        
         CLI   C+26,C' '                                                        
         BNE   *+20                                                             
         MVC   C+26(1),C+25                                                     
         MVC   C+25(1),C+24                                                     
         MVI   C+24,C' '                                                        
         CLI   C+24,C' '                                                        
         BNE   *+8                                                              
         MVI   C+24,C'0'                                                        
         CLI   C+25,C' '                                                        
         BNE   *+8                                                              
         MVI   C+25,C'0'                                                        
         MVC   WORK(3),=3X'F0'                                                  
         MVZ   WORK(3),C+24                                                     
         CLC   WORK(3),=3X'F0'                                                  
         BNE   ERROR                                                            
         CLC   C+24(3),=C'255'                                                  
         BH    ERROR                                                            
         SPACE 2                                                                
FIELD1C  CLI   C+13,C'N'           TEST FOR NOP FIELD                           
         BNE   FIELD1D                                                          
         MVC   P+90(32),=CL32'INVALID DATA ON NOP CARD'                         
         CLC   C+1(7),SPACES                                                    
         BNE   ERROR                                                            
         CLC   C+11(2),SPACES                                                   
         BNE   ERROR                                                            
         CLC   C+14(4),SPACES                                                   
         BNE   ERROR                                                            
         CLC   C+24(3),SPACES                                                   
         BNE   ERROR                                                            
         CLC   C+22(1),SPACES                                                   
         BNE   ERROR                                                            
         CLC   C+27(2),SPACES                                                   
         BNE   ERROR                                                            
         B     LENGTH                                                           
         SPACE 2                                                                
FIELD1D  CLI   C+6,C' '            VALIDATE COLUMN                              
         BNE   *+8                                                              
         MVI   C+6,C'0'                                                         
         MVC   P+90(32),=CL32'INVALID COLUMN'                                   
         MVC   WORK(3),=3X'F0'                                                  
         MVZ   WORK(2),C+6                                                      
         CLC   WORK(3),=3X'F0'                                                  
         BNE   ERROR                                                            
         CLC   C+6(2),=C'80'                                                    
         BH    ERROR                                                            
         CLC   C+6(2),=C'00'                                                    
         BE    ERROR                                                            
         SPACE 2                                                                
         MVC   P+90(32),=CL32'INVALID ROW FIELD'                                
         PACK  DUB,LASTROW                                                      
         CVB   R2,DUB                                                           
         CLI   C+4,C'+'            PLUS FEATURE                                 
         BNE   ROW2                                                             
         CLI   C+5,C'0'                                                         
         BL    ERROR                                                            
         CLI   C+5,C'9'                                                         
         BH    ERROR                                                            
         PACK  DUB,C+5(1)                                                       
         CVB   R3,DUB                                                           
         AR    R2,R3                                                            
         CVD   R2,DUB                                                           
         UNPK  C+4(2),DUB                                                       
         OI    C+5,X'F0'                                                        
         B     LENGTH                                                           
         SPACE 2                                                                
ROW2     CLC   C+4(2),=C' *'       AUTO FEATURE                                 
         BE    ROW3                                                             
         CLC   C+4(2),=C'* '                                                    
         BNE   ROW4                                                             
         SPACE 2                                                                
ROW3     MVC   C+4(2),LASTROW      EITHER ON THE SAME LINE                      
         CLC   C+6(2),LASTCOL                                                   
         BH    LENGTH                                                           
         PACK  DUB,C+4(2)          OR ON THE NEXT IF COLUMN NOT HIGH            
         AP    DUB,=P'1'                                                        
         UNPK  C+4(2),DUB                                                       
         OI    C+5,X'F0'                                                        
         B     LENGTH                                                           
         SPACE 2                                                                
ROW4     CLI   C+4,C' '                                                         
         BNE   *+8                                                              
         MVI   C+4,X'F0'                                                        
         MVC   WORK(3),=3X'F0'                                                  
         MVZ   WORK(2),C+4                                                      
         CLC   WORK(3),=3X'F0'                                                  
         BNE   ERROR                                                            
         SPACE 2                                                                
LENGTH   MVC   P+90(32),=CL32'INVALID LENGTH'                                   
         CLI   C+8,C' '                                                         
         BNE   *+8                                                              
         MVI   C+8,X'F0'                                                        
         CLI   C+9,C' '                                                         
         BNE   *+8                                                              
         MVI   C+9,X'F0'                                                        
         MVC   WORK(3),=3X'F0'                                                  
         MVZ   WORK(3),C+8                                                      
         CLC   WORK(3),=3X'F0'                                                  
         BNE   ERROR                                                            
         CLC   C+8(3),=3X'F0'                                                   
         BE    ERROR                                                            
         CLC   C+24(3),SPACES                                                   
         BNE   *+18                                                             
         CLC   C+8(3),=C'247'                                                   
         BH    ERROR                                                            
         B     LENGTH1                                                          
         LA    R5,247-EXTENLNQ                                                  
         CVD   R5,DUB                                                           
         UNPK  WORK(3),DUB                                                      
         OI    WORK+2,X'F0'                                                     
         CLC   C+8(3),WORK                                                      
         BH    ERROR                                                            
LENGTH1  MVC   DUB(2),PHASELEN                                                  
         LH    R2,DUB                                                           
         PACK  DUB,C+8(3)                                                       
         CVB   R4,DUB                                                           
         LA    R2,8(R2,R4)                                                      
         CLC   C+24(3),SPACES                                                   
         BE    *+8                                                              
         LA    R2,EXTENLNQ(R2)                                                  
         STH   R2,DUB                                                           
         MVC   PHASELEN,DUB                                                     
         SPACE 2                                                                
         CLI   C+13,C'N'           TEST FOR NOP FIELD                           
         BE    CARDOK                                                           
         PACK  DUB,C+4(2)          CALCULATE START ADDRESS OF THIS FLD          
         CVB   R2,DUB                                                           
         PACK  DUB,C+6(2)                                                       
         CVB   R3,DUB                                                           
         LR    R5,R2                                                            
         CLC   C+24(3),SPACES                                                   
         BE    LENGTH2                                                          
         MVC   P+90(32),=CL32'NO EXTENDED HEADERS ON ROW 1'                     
         CH    R5,=H'1'                                                         
         BE    ERROR                                                            
LENGTH2  MVC   P+90(32),=CL32'INVALID ROW'                                      
         LTR   R5,R5                                                            
         BZ    ERROR                                                            
         BCTR  R5,R0                                                            
         MH    R5,=H'80'                                                        
         AR    R5,R3                                                            
         BCTR  R5,R0                                                            
         SPACE 2                                                                
         CLI   C+13,C'P'           SPECIAL TESTS FOR UNPROTECTED FIELDS         
         BE    LENGTH3                                                          
         MVC   P+90(32),=CL32'UNPROTECTED FIELDS S/B 2-80'                      
         CH    R3,=H'1'                                                         
         BE    ERROR                                                            
         BCTR  R5,R0               (UNPROTECTED NEED SPACE BEFORE)              
         LA    R1,0(R3,R4)                                                      
         CH    R1,=H'81'           UNPROTECTED MAY NOT OVERLAP                  
         BH    ERROR                                                            
         SPACE 2                                                                
LENGTH3  MVC   P+90(32),=CL32'FIELD STARTS BEFORE PREVIOUS END'                 
         CH    R5,LASTEND                                                       
         BL    ERROR                                                            
         BH    LENGTH4                                                          
         CLI   C+13,C'P'           UNPROT ATTB CAN OVERLAP PROT ATTB            
         BE    ERROR               FROM LAST UNPROT FIELD                       
         CLI   LASTPROT,C'P'                                                    
         BE    ERROR                                                            
LENGTH4  CLI   C+13,C'P'           NOW ESTABLISH END OF THIS ONE                
         BE    *+8                                                              
         LA    R5,2(R5)                                                         
         AR    R5,R4                                                            
         BCTR  R5,R0                                                            
         STH   R5,LASTEND                                                       
         MVC   LASTPROT,C+13                                                    
         MVC   P+90(32),=CL32'FIELD EXCEEDS SCREEN END'                         
         CH    R5,=H'1920'                                                      
         BNL   ERROR                                                            
         MVC   LASTROW(7),C+4                                                   
         SPACE 2                                                                
*                                  VALIDATE EXTENDED ATTRIBUTES                 
XATTS    EQU   *                                                                
         CLI   C+27,C' '           HIGHLIGHTING                                 
         BNE   XATT010                                                          
         CLI   C+28,C' '           COLOUR                                       
         BNE   XATT010                                                          
         BAS   RE,TSTSYM           SYMBOL SET                                   
         BNE   CARDOK              NON OF THESE                                 
*                                  CHECK UNPROTECTED EXTENDED FIELD#            
XATT010  MVC   P+90(32),=CL32'MISSING UNPROTECTED FIELD#'                       
         CLI   C+13,C'P'                                                        
         BE    XATT020                                                          
         CLC   C+24(3),SPACES                                                   
         BE    ERROR                                                            
*                                  VALIDATE HIGHLIGHT BYTE                      
XATT020  MVC   P+90(32),=CL32'EXTENDED HIGHLIGHT ERROR'                         
         CLI   C+27,C' '                                                        
         BE    XATT040                                                          
         CLI   C+27,C'B'                                                        
         BE    XATT040                                                          
         CLI   C+27,C'R'                                                        
         BE    XATT040                                                          
         CLI   C+27,C'U'                                                        
         BNE   ERROR                                                            
*                                  VALIDATE COLOUR BYTE                         
XATT040  MVC   P+90(32),=CL32'EXTENDED COLOUR ERROR'                            
         CLI   C+28,C' '                                                        
         BE    XATT050                                                          
         CLI   C+28,C'B'                                                        
         BE    XATT050                                                          
         CLI   C+28,C'R'                                                        
         BE    XATT050                                                          
         CLI   C+28,C'P'                                                        
         BE    XATT050                                                          
         CLI   C+28,C'G'                                                        
         BE    XATT050                                                          
         CLI   C+28,C'T'                                                        
         BE    XATT050                                                          
         CLI   C+28,C'Y'                                                        
         BE    XATT050                                                          
         CLI   C+28,C'W'                                                        
         BNE   ERROR                                                            
*                                                                               
XATT050  B     CARDOK                                                           
         SPACE 2                                                                
CARDOK   CLI   C+29,C'C'           THIS FIELD CARD IS VALID                     
         BE    CARDSV                                                           
         MVC   P+90(32),SPACES                                                  
         GOTO1 =V(PRINTER)                                                      
CARDOK1  BAS   RE,PUTSTK           EMPTY STACK                                  
         BNE   ERROR                                                            
         L     RE,=A(TWA)                                                       
         MVC   0(80,RE),C                                                       
         MVC   TWAHDR(2),=H'1'                                                  
         BAS   RE,PUTSTK           WRITE THIS CARD TO WORK VIA STACK            
         BNE   ERROR                                                            
         B     XIT                                                              
         SPACE 2                                                                
CARDSV   MVC   P+90(32),SPACES     SAVE CARD IN STACK                           
         GOTO1 =V(PRINTER)                                                      
         LH    RE,TWAHDR           GET NUMBER OF CARDS                          
         LA    RE,1(RE)                                                         
         STH   RE,TWAHDR                                                        
         CH    RE,=H'20'           CHECK FOR MAXIMUM                            
         BNH   *+14                                                             
         MVC   P+90(32),=CL32'TOO MANY CONTINUATION CARDS'                      
         B     ERROR                                                            
         BCTR  RE,0                                                             
         MH    RE,=H'80'                                                        
         L     RF,=A(TWA)                                                       
         AR    RF,RE                                                            
         MVC   0(80,RF),C          SAVE CARD IN STACK                           
         CLI   C+29,C'C'                                                        
         BE    XIT                                                              
         BAS   RE,PUTSTK           EMPTY STACK IF LAST CONTUATION               
         BE    XIT                                                              
         SPACE 2                                                                
ERROR    MVC   SVP,P                                                            
         GOTO1 =V(PRINTER)                                                      
         MVC   P(13),=C'*** ERROR ***'                                          
         MVC   P+14(32),SVP+90                                                  
         GOTO1 =V(PRINTER)                                                      
         MVI   VALIDITY,C'N'                                                    
         MVI   ERRORFLG,C'Y'       SO WE GET NON-ZERO RETURN CODE               
         B     XIT                                                              
*                                                                               
*  ROUTINE TO TEST SYMBOL SET CODE IN C+22                                      
*                                                                               
TSTSYM   NTR1                                                                   
         CLI   C+23,C' '                                                        
         BE    TSYM010                                                          
         CLI   C+23,C'K'           HANDLE SYMBOL SET BYTE + UK/US               
         BE    TSYM010                                                          
         CLI   C+23,C'S'                                                        
         BNE   TSYMNO                                                           
TSYM010  CLI   C+22,C'9'                                                        
         BH    TSYMNO                                                           
         CLI   C+22,C'0'                                                        
         BL    TSYMNO                                                           
         B     TSYMOK                                                           
TSYMOK   SR    RC,RC                                                            
TSYMNO   LTR   RC,RC                                                            
         B     XIT                                                              
         SPACE 2                                                                
*                                                                               
*  ROUTINE TO TEST IF COUNTRY CODE CORRECT                                      
*  ALLOW:                                                                       
*  1) 2 SPACES                                                                  
*  2) 2 CHARACTER COUNTRY CODE                                                  
*  3) 1 SYMBOL SET CHARACTER AND 'K' OR 'S' FOR UK OR US.                       
*  3) 1 SYMBOL SET AND 1 SPACE                                                  
*  4) 1 SPACE AND 'K' OR 'S' FOR UK OR US                                       
*                                                                               
TSTCTRY  NTR1                                                                   
         CLC   C+22(2),SPACES                                                   
         BE    TCTROK                                                           
         CLC   C+22(1),SPACES                                                   
         BE    TCTR010                                                          
         BAS   RE,TSTSYM                                                        
         BNE   TCTR020                                                          
         CLC   C+23(1),SPACES                                                   
         BE    TCTROK                                                           
TCTR010  CLC   C+23(1),COUNTRY+1                                                
         BE    TCTROK                                                           
         B     TCTRNO                                                           
TCTR020  CLC   C+22(2),COUNTRY                                                  
         BNE   TCTRNO                                                           
         B     TCTROK                                                           
TCTROK   SR    RC,RC                                                            
TCTRNO   LTR   RC,RC                                                            
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
* PUT CARDS STACKED IN TWA AREA TO WORK FILE AFTER THEY HAVE BEEN    *          
* MASSAGED AND CONVERTED TO DATA DICTIONARY ESCAPE SEQUENCES.        *          
* DICTIONARY ENTRY DEFINED BY &NN... FOR NUMERIC REFERENCE OR BY     *          
* &XX#XX.. FOR ALPHA EQUATE REFERENCE.                               *          
*                                                                    *          
* &XX#XXXXX          FOR FIRST AND ONLY REFERENCE - LENGTH SET TO    *          
*                    FIELD LEN - LEFT JUSTIFY.                       *          
* &XX#XXXXX/LL/J&    MUST BE USED IF OTHER TEXT IN FIELD. LL IS THE  *          
*                    LENGTH AND J IS JUSTIFICATION L/R/C/S.THE /J    *          
*                    CAN BE OMMITED IF LEFT JUSTIFY IE /L.THE FINAL  *          
*                    & DENOTES END OF DCTNRY DEFINITION AND THE CHR  *          
*                    AFTER THIS IS THE NEXT VALID FIELD TEXT CHR.    *          
*                                                                    *          
* NOTE THAT AN ESCAPE SEQUENCE CAN BE LONGER OR SHORTER THAN THE     *          
* LENGTH OF THE FIELD THAT IT DEFINES (GIVEN BY LL)                  *          
**********************************************************************          
         SPACE 1                                                                
PUTSTK   NTR1                                                                   
         MVC   SVC,C                                                            
         MVI   BYTE,0              SET OK RETURN CODE                           
         SR    R2,R2                                                            
         ICM   R2,3,TWAHDR         R2=NUMBER OF CARDS                           
         BZ    PUTSTKX             EXIT IF NO CARDS                             
*                                                                               
         L     R3,=A(TWA)          POINT TO FIRST CARD IN STACK                 
         MVI   3(R3),0             SET NO STEREO FIELD NUMBER                   
         CH    R2,=H'1'                                                         
         BNH   PUTSTK0                                                          
         CLI   29(R3),C'C'                                                      
         BNE   PUTSTK0                                                          
         CLC   80+24(3,R3),SPACES  TEST IF NUMBER IN CONTINUATION CARD          
         BE    PUTSTK0                                                          
         PACK  DUB,80+24(3,R3)                                                  
         CVB   RE,DUB                                                           
         STC   RE,3(R3)            SAVE BINARY STEREO NUM IN C+3                
         MVC   80+24(3,R3),SPACES                                               
*                                                                               
PUTSTK0  XC    TWAHDR+4(4),TWAHDR+4                                             
         L     R3,=A(TWA)          R3=A(NEXT CARD IN STACK)                     
         PACK  DUB,8(3,R3)                                                      
         CVB   R0,DUB                                                           
         STH   R0,ESCMAXL          SAVE MAXIMUM FIELD LENGTH                    
         MVI   WORK,C' '                                                        
         MVC   WORK+1(255),WORK                                                 
         LA    R4,WORK             R4=A(NEXT CHR IN WORK)                       
*                                                                               
PUTSTK1  LH    R1,TWAHDR+2         GET NUMBER OF CHR OF DATA                    
         LTR   R1,R1                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         LA    RE,30(R3)           RE=A(NEXT CARD IN CARD DATA)                 
PUTSTK2  CLI   0(RE),EOC           TEST END OF CARD CHR                         
         BNE   *+12                                                             
         OI    TWAHDR+6,X'80'      SET EOC FOUND                                
         B     PUTSTK3                                                          
         CLI   0(RE),DDC           TEST DATA DICTIONARY CHR                     
         BNE   PUTSTK2D                                                         
         CLI   1(RE),C' '                                                       
         BE    PUTSTK2D                                                         
         CLI   1(RE),C'0'          TEST FOR &NN FOR NUMERIC ID                  
         BL    PUTSTK2B                                                         
         CLI   2(RE),C'0'                                                       
         BL    PUTSTK2D                                                         
         B     PUTSTK2C                                                         
PUTSTK2B CLI   3(RE),C'#'          TEST &AA#... FOR ALPHA EQUATE ID             
         BNE   PUTSTK2D                                                         
PUTSTK2C OI    TWAHDR+6,X'40'      SET DDC FOUND                                
PUTSTK2D MVC   0(1,R4),0(RE)                                                    
         LA    RE,1(RE)                                                         
         LA    R4,1(R4)                                                         
         BCT   R1,PUTSTK2          BACK FOR NEXT CHR OF DATA                    
PUTSTK3  LA    R3,80(R3)                                                        
         BCT   R2,PUTSTK1          BACK FOR NEXT CARD                           
         MVC   WORKH,ESCMAXL       SET LENGTH OF DATA IN WORK                   
*                                                                               
PUTSTK4  TM    TWAHDR+6,X'40'      TEST IF DATA DCTNRY NEEDED                   
         BO    PUTSTK5             YES                                          
         MVC   DDWKH,WORKH                                                      
         MVC   DDWK,WORK                                                        
         B     PUTSTKA                                                          
*                                                                               
PUTSTK5  MVI   DDWK,C' '           INITIALISE TRANSLATED AREA                   
         MVC   DDWK+1(255),DDWK                                                 
         LA    R3,DDWK             R3=A(NEXT CHR IN OUTPUT STRING)              
         LA    R4,WORK             R4=A(NEXT CHR IN INPUT STRING)               
         LH    R5,WORKH                                                         
         AR    R5,R3               R5=A(END OF OUTPUT STRING)                   
PUTSTK5A CLI   0(R4),DDC           TEST DATA DICT CHR                           
         BNE   PUTSTK5D            YES                                          
         CLI   1(R4),C' '                                                       
         BE    PUTSTK5D                                                         
         CLI   1(R4),C'0'          TEST FOR &NN FOR NUMERIC ID                  
         BL    PUTSTK5B                                                         
         CLI   2(R4),C'0'                                                       
         BL    PUTSTK5D                                                         
         B     PUTSTK6                                                          
PUTSTK5B CLI   3(R4),C'#'          TEST &AA#... FOR ALPHA EQUATE ID             
         BE    PUTSTK6                                                          
PUTSTK5D MVC   0(1,R3),0(R4)       NO COPY CHR FROM INPUT TO OUTPUT             
         LA    R3,1(R3)                                                         
         LA    R4,1(R4)                                                         
         CR    R3,R5                                                            
         BL    PUTSTK5A                                                         
         B     PUTSTK9F                                                         
*                                                                               
PUTSTK6  STM   R3,R5,SAVER345      SAVE LOCATION OF &.... SEQUENCE              
         MVC   ESCDATA,SPACES                                                   
         MVC   ESCTXT,SPACES                                                    
         LA    RE,ESCTXT           ISOLATE DCTNRY NUMBER OR ALPHA               
         LA    RF,1(R4)                                                         
         SR    R1,R1                                                            
PUTSTK6B CLI   0(RF),DDD           DCTNRY DELIMITER                             
         BE    PUTSTK6C                                                         
         CLI   0(RF),DDT           DCTNRY TERMINATOR                            
         BE    PUTSTK6C                                                         
         CLI   0(RF),C' '          OR A SPACE                                   
         BE    PUTSTK6C                                                         
         MVC   0(1,RE),0(RF)                                                    
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         AH    R1,=H'1'                                                         
         CH    R1,=H'8'                                                         
         BH    PUTSTKW                                                          
         B     PUTSTK6B                                                         
*                                                                               
PUTSTK6C LTR   R1,R1               R1 IS LENGTH OF DCTNRY NUMBER                
         BZ    PUTSTKW                                                          
         ST    RF,SAVERF           SAVE A(TERMINATER CHR)                       
         LH    R2,=H'8'                                                         
         SR    R2,R1                                                            
         MVC   DUB(8),=8C'0'                                                    
         LA    R2,DUB(R2)                                                       
         BCTR  R1,0                                                             
         EX    R1,*+8              RT JUSTIFY IN DUB                            
         B     *+10                                                             
         MVC   0(0,R2),ESCTXT                                                   
         MVC   DUB1,=8C'0'                                                      
         MVZ   DUB1,DUB                                                         
         CLC   DUB1,=8C'0'                                                      
         BNE   PUTSTK6E                                                         
*                                                                               
PUTSTK6D PACK  DUB1,DUB            DCTNRY ID IS NUMERIC                         
         CVB   R0,DUB1                                                          
         LTR   R0,R0                                                            
         BZ    PUTSTKW                                                          
         C     R0,=F'9999'         CHECK MAX VALUE FOR DCTNRY NUM               
         BH    PUTSTKW                                                          
         STCM  R0,3,ESCNUM                                                      
         B     PUTSTK7                                                          
*                                                                               
PUTSTK6E L     R1,ADICT            SEARCH DICTIONARY FOR EQUATE NAME            
PUTSTK6F CLI   0(R1),0                                                          
         BE    PUTSTKW             END OF DICTIONARY                            
         CLC   0(8,R1),ESCTXT                                                   
         BE    *+12                                                             
         LA    R1,10(R1)                                                        
         B     PUTSTK6F                                                         
         MVC   ESCNUM,8(R1)        EXTRACT EQUATED NUMBER                       
*                                                                               
PUTSTK7  L     RF,SAVERF           POINT TO TERMINATE CHR                       
         CLI   0(RF),C' '                                                       
         BE    *+12                                                             
         CLI   0(RF),DDT                                                        
         BNE   PUTSTK7A                                                         
         LA    RE,WORK             TERMINATOR OR SPACE                          
         CR    R4,RE               ONLY VALID IF FIRST DATA IN FIELD            
         BNE   PUTSTKW                                                          
         CLC   1(20,RF),SPACES                                                  
         BNE   PUTSTKW                                                          
         MVI   ESCCDE,DD#ESCL      DEFAULT IS LEFT JUSTIFY                      
         MVC   ESCLEN,ESCMAXL+1    LENGTH IS MAXIMUM FIELD LENGTH               
         B     PUTSTK9                                                          
*                                                                               
PUTSTK7A LA    RE,ESCTXT           ISOLATE DCTNRY LENGTH                        
         MVC   ESCTXT,SPACES                                                    
         LA    RF,1(RF)            BUMP TO CHR AFTER PREV TERMINATOR            
         SR    R1,R1                                                            
PUTSTK7B CLI   0(RF),DDD           DCTNRY DELIMITER                             
         BE    PUTSTK7C                                                         
         CLI   0(RF),DDT           DCTNRY TERMINATER                            
         BE    PUTSTK7C                                                         
         CLI   0(RF),C' '          OR A SPACE                                   
         BE    PUTSTK7C                                                         
         MVC   0(1,RE),0(RF)                                                    
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         AH    R1,=H'1'                                                         
         CH    R1,=H'2'            TWO CHRS MAX FOR LENGTH FIELD                
         BH    PUTSTKW                                                          
         B     PUTSTK7B                                                         
*                                                                               
PUTSTK7C LTR   R1,R1               R1 IS LENGTH OF DCTNRY LENGTH                
         BZ    PUTSTKW                                                          
         ST    RF,SAVERF           SAVE A(TERMINATER CHR)                       
         LH    R2,=H'8'                                                         
         SR    R2,R1                                                            
         MVC   DUB(8),=8C'0'                                                    
         LA    R2,DUB(R2)                                                       
         BCTR  R1,0                                                             
         EX    R1,*+8              RT JUSTIFY IN DUB                            
         B     *+10                                                             
         MVC   0(0,R2),ESCTXT                                                   
         MVC   DUB1,=8C'0'                                                      
         MVZ   DUB1,DUB                                                         
         CLC   DUB1,=8C'0'                                                      
         BNE   PUTSTKW                                                          
         PACK  DUB1,DUB            DCTNRY LENGTH IS VALID NUMERIC               
         CVB   R0,DUB1                                                          
         CH    R0,=H'2'            CHECK MIN VALUE FOR DCTNRY LEN               
         BL    PUTSTKW                                                          
         CH    R0,=H'80'           CHECK MAX VALUE FOR DCTNRY LEN               
         BH    PUTSTKW                                                          
         STC   R0,ESCLEN           SET LENGTH OF ESC SEQUENCE                   
*                                                                               
PUTSTK8  L     RF,SAVERF           POINT TO TERMINATE CHR                       
         CLI   0(RF),DDT                                                        
         BE    *+12                                                             
         CLI   0(RF),C' '                                                       
         BNE   PUTSTK8A                                                         
         MVI   ESCCDE,DD#ESCL      DEFAULT IS LEFT JUSTIFY                      
         B     PUTSTK9                                                          
*                                                                               
PUTSTK8A LA    RF,1(RF)            POINT TO DCTNRY TYPE                         
         CLI   0(RF),C'L'                                                       
         BNE   *+12                                                             
         MVI   ESCCDE,DD#ESCL                                                   
         B     PUTSTK8B                                                         
         CLI   0(RF),C'C'                                                       
         BNE   *+12                                                             
         MVI   ESCCDE,DD#ESCC                                                   
         B     PUTSTK8B                                                         
         CLI   0(RF),C'R'                                                       
         BNE   *+12                                                             
         MVI   ESCCDE,DD#ESCR                                                   
         B     PUTSTK8B                                                         
         CLI   0(RF),C'S'                                                       
         BNE   *+12                                                             
         MVI   ESCCDE,DD#ESCS                                                   
         B     PUTSTK8B                                                         
         CLI   0(RF),C'F'                                                       
         BNE   *+12                                                             
         MVI   ESCCDE,DD#ESCF                                                   
         B     PUTSTK8B                                                         
         B     PUTSTKW             INVALID DCTNRY TYPE CHR                      
*                                                                               
PUTSTK8B CLI   1(RF),C'U'          IS UNDERLINE REQUIRED                        
         BNE   *+12                NO                                           
         OI    ESCCDE,X'08'        YES TURN ON BIT IN ESCAPE CODE               
         LA    RF,1(RF)            AND POSITION PAST U CHR                      
         CLI   1(RF),C'.'          IS DUMMY EXTRA CHR PRESENT                   
         BNE   *+8                 NO                                           
         LA    RF,1(RF)            YES POSITION PAST IT                         
         LA    RF,1(RF)            POINT TO TERMINATER CHR                      
         ST    RF,SAVERF           SAVE A(TERMINATER CHR)                       
         CLI   0(RF),C' '                                                       
         BE    *+12                MUST TERMINATE WITH BLANK                    
         CLI   0(RF),DDT                                                        
         BNE   PUTSTKW             OR TERMINATE CHR                             
*                                                                               
PUTSTK9  CLI   ESCLEN,2            ADJUST FOR SHORT LENGTHS                     
         BH    PUTSTK9A                                                         
         TM    ESCCDE,X'08'        TEST IF UNDERLINE WANTED                     
         BZ    *+12                                                             
         MVI   ESCCDE,DD#ESUL2                                                  
         B     *+8                                                              
         MVI   ESCCDE,DD#ESCL2                                                  
         LA    R1,3                SET LENGTH OF SHORT ESCAPE                   
         B     PUTSTK9D                                                         
PUTSTK9A CLI   ESCLEN,3                                                         
         BNE   PUTSTK9B                                                         
         TM    ESCCDE,X'08'        TEST IF UNDERLINE WANTED                     
         BZ    *+12                                                             
         MVI   ESCCDE,DD#ESUL3                                                  
         B     *+8                                                              
         MVI   ESCCDE,DD#ESCL3                                                  
         LA    R1,3                SET LENGTH OF SHORT ESCAPE                   
         B     PUTSTK9D                                                         
PUTSTK9B SR    R1,R1                                                            
         IC    R1,ESCLEN           GET LENGTH OF FULL ESCAPE                    
*                                                                               
PUTSTK9D CH    R1,ESCMAXL          LENGTH CANT BE LONGER THAN FIELD             
         BH    PUTSTKW                                                          
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),ESCDATA     MOVE ESCAPE STRING TO DEST AREA              
*                                                                               
PUTSTK9E LA    R1,1(R1)            R1=LEN OF ESC SEQUENCE IN DEST               
         AR    R3,R1               BUMP DESTINATION POINTER                     
         LA    R4,1(RF)            BUMP PAST SOURCE TERMINATE CHR               
         CR    R3,R5                                                            
         BH    PUTSTKW                                                          
         BL    PUTSTK5A            BACK FOR NEXT ESC SEQ                        
*                                                                               
PUTSTK9F LA    R1,DDWK             SET LENGTH OF TRANSLATED STRING              
         SR    R3,R1                                                            
         STH   R3,DDWKH                                                         
*                                                                               
PUTSTKA  L     R3,=A(TWA)          MOVE TRANSLATED DATA BACK TO STACK           
         LH    RF,TWAHDR+2         GET WIDTH OF DATA                            
         LR    R1,RF                                                            
         SH    R1,=H'1'                                                         
         BNM   *+6                                                              
         DC    H'0'                                                             
         LA    R2,1                NEW NUMBER OF CARDS                          
         LA    R4,DDWK                                                          
         LH    R5,DDWKH                                                         
PUTSTKB  EX    R1,*+8              MOVE DATA BACK TO CARD IN STACK              
         B     *+10                                                             
         MVC   30(0,R3),0(R4)                                                   
         SR    R5,RF                                                            
         BNP   PUTSTKC                                                          
         MVI   29(R3),C'C'         SET MORE DATA TO COME                        
         LA    R2,1(R2)            BUMP NUMBER OF CARDS                         
         LA    R3,80(R3)                                                        
         MVC   00(30,R3),SPACES                                                 
         AR    R4,RF                                                            
         B     PUTSTKB                                                          
PUTSTKC  MVI   29(R3),C' '         SET LAST CARD TO NOT CONTINUATION            
         STH   R2,TWAHDR           SET NEW NUMBER OF CARDS                      
*                                                                               
PUTSTKD  L     R3,=A(TWA)          WRITE NEW CARDS TO WORK FILE                 
         MVC   C(80),0(R3)                                                      
         BAS   RE,PUTWRK                                                        
         LA    R3,80(R3)                                                        
         BCT   R2,PUTSTKD+4                                                     
         B     PUTSTKX                                                          
*                                                                               
PUTSTKW  MVC   P+90(32),=CL32'INVALID DATA DICTIONARY'                          
         MVI   BYTE,1                                                           
*                                                                               
PUTSTKX  MVC   C,SVC               RESTORE SAVED CARD                           
         XC    TWAHDR(2),TWAHDR    SET NO CARDS IN STACK                        
         CLI   BYTE,0              EXIT WITH CC EQL IF VALID CARDS              
         XIT1                                                                   
         EJECT                                                                  
*              CONTROL OF PHASE 2 (DSECT GENERATION AND PRINT)                  
*                                                                               
PHASE2   MVC   SUB1,SPACES                                                      
         MVC   SUB2,SPACES                                                      
         L     RE,=A(SUBLINE1)                                                  
         MVC   SUB1+22(49),0(RE)                                                
         L     RE,=A(SUBLINE2)                                                  
         MVC   SUB2+22(49),0(RE)                                                
         BAS   RE,PNTWRK           POINT TO START OF WRK FILE                   
         L     R6,=A(BOOKPOOL)                                                  
         BAS   RE,SOJPAN           OUTPUT ANY START OF PAN CARDS                
         SPACE 2                                                                
PH22     BAS   RE,GETWRK           READ WRK FILE RECORD                         
*                                                                               
         CLC   C(2),=C'/*'                                                      
         BNE   PH24                                                             
         BAS   RE,BKEND2                                                        
         B     PHASE3                                                           
         SPACE 2                                                                
PH24     CLI   C,C'S'                                                           
         BNE   PH26                                                             
         BAS   RE,BKEND2                                                        
         BAS   RE,BKSTART2                                                      
         B     PH22                                                             
         SPACE 2                                                                
PH26     CLI   C,C'F'                                                           
         BNE   PH22                                                             
         BAS   RE,FIELD2                                                        
         B     PH22                                                             
         EJECT                                                                  
*              ROUTINE FOR START OF BOOK (PHASE 2)                              
*                                                                               
BKSTART2 NTR1                                                                   
         MVI   SWITCH,1                                                         
         CLI   VALIDITY,C'Y'                                                    
         BNE   XIT                                                              
         MVC   BOOKTAGS,C+15                                                    
         MVC   PANBOOK,SPACES      SET NAME OF DSECT BOOK                       
         MVC   PANBOOK(6),BOOK                                                  
         MVI   PANBOOK+6,C'D'      CARD DECK DEFAULT IS TSPPOOD                 
*&&DO                                                                           
* DEIS: SUPPORT FOR OVERRIDE DSECT NAME WITHDRAWN JUL19/06.                     
*  WE EITHER HAD TO ADD SUPPORT TO PANAPT FOR THE OVERRIDE DSECT NAME,          
*  OR WITHDRAW THE OPTION FROM THIS PROGRAM. WE CHOSE THE LATTER!               
*                                                                               
         CLC   C+30(10),SPACES                                                  
         BE    *+14                                                             
         MVC   PANDBOOK,C+30       USER OVERRIDE NAME IN COL 31                 
         B     BKST21                                                           
*&&                                                                             
         CLC   C+50(10),SPACES     PHASE ONE MOVED PAN BOOK IN COL 51           
         BE    BKST21                                                           
         MVC   PANDBOOK,C+50       DEFAULT IS (PANBOOK)D                        
         LA    R2,PANDBOOK                                                      
         BAS   RE,PANSCAN                                                       
         MVI   0(R2),C'D'                                                       
         SPACE 2                                                                
BKST21   DS    0H                                                               
         GOTO1 =V(PANIC),PNPL,(X'20',=C'READ'),=C'DIR',PANDBOOK,WORK            
         TM    PNPL+8,X'10'                                                     
         BO    BKST22                                                           
         MVC   D(8),=C'++UPDATE'                                                
         MVC   D+9(10),PANDBOOK                                                 
         LA    R2,D+9                                                           
         BAS   RE,PANSCAN                                                       
         MVC   0(6,R2),=C',0,ALL'                                               
         BAS   RE,PUTPAN                                                        
         B     BKST24                                                           
         SPACE 2                                                                
BKST22   MVC   D(5),=C'++ADD'                                                   
         MVC   D+6(10),PANDBOOK                                                 
         LA    R2,D+6                                                           
         BAS   RE,PANSCAN                                                       
         MVC   0(4,R2),=C',BAL'                                                 
         BAS   RE,PUTPAN                                                        
         SPACE 2                                                                
BKST24   MVC   TITLE,SPACES                                                     
         MVC   TITLE(29),=C'DSECT TO COVER SCREEN PANBOOK'                      
         MVC   TITLE+22(7),PANBOOK                                              
         ZAP   LINE,=P'75'                                                      
         MVC   D+9(7),=C'SPACE 1'                                               
         BAS   RE,PUTPAN                                                        
         SPACE 2                                                                
         MVI   D,C'*'                                                           
         MVC   D+15(29),TITLE                                                   
         MVC   D+50(4),=C'DATE'                                                 
         MVC   D+55(8),DATE                                                     
         BAS   RE,PUTPAN                                                        
         SPACE 2                                                                
         MVC   D+9(7),=C'SPACE 1'                                               
         BAS   RE,PUTPAN                                                        
         CLI   NODSECT,C' '        OPTION NOT TO GENERATE                       
         BNE   BKST26              DSECT AND     DS  XL64                       
         MVC   D+9(5),=C'DSECT'                                                 
         MVC   D(7),PANBOOK                                                     
         MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         SPACE 2                                                                
         MVC   D+9(10),=C'DS    XL64'                                           
         MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         SR    RE,RE                                                            
         ICM   RE,3,PHASELEN                                                    
         LA    RE,64(RE)                                                        
         STCM  RE,3,PHASELEN                                                    
         SPACE 2                                                                
BKST26   MVI   D,C'*'                                                           
         MVC   D+22(49),SUB1+22                                                 
         MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         MVC   D+9(7),=C'SPACE 1'                                               
         BAS   RE,PUTPAN                                                        
         B     XIT                                                              
         SPACE 2                                                                
PANSCAN  CLI   0(R2),C' '                                                       
         BCR   8,RE                                                             
         LA    R2,1(R2)                                                         
         B     PANSCAN                                                          
         EJECT                                                                  
*              ROUTINE FOR FIELD CARDS (PHASE 2)                                
*                                                                               
FIELD2   NTR1                                                                   
         CLI   VALIDITY,C'Y'                                                    
         BNE   XIT                                                              
         BAS   RE,TSTCTRY                                                       
         BNE   XIT                                                              
         MVI   EXTENHDR,C'N'       SET NORMAL FIELD HEADER                      
         MVC   EXTENSTR,C+3                                                     
         CLC   C+24(3),SPACES                                                   
         BNE   *+12                                                             
         CLI   EXTENSTR,0                                                       
         BE    *+8                                                              
         MVI   EXTENHDR,C'Y'       SET NEED EXTENDED HEADER                     
         SPACE 2                                                                
         MVC   D+9(9),=C'DS    XL8'                                             
         CLI   C+18,C' '                                                        
         BE    FIELD23                                                          
         MVC   D(3),GEN            GIVE IT A LABEL                              
         MVC   D+3(4),C+18                                                      
         LA    R2,D+4                                                           
         SPACE 2                                                                
FIELD21  CLI   0(R2),C' '          FIND A SPACE TO ADD A H                      
         BE    FIELD22                                                          
         LA    R2,1(R2)                                                         
         B     FIELD21                                                          
         SPACE 2                                                                
FIELD22  MVI   0(R2),C'H'                                                       
         SPACE 2                                                                
FIELD23  MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         CLI   C+18,C' '           NOW GENERATE DATA FIELD                      
         BE    FIELD24                                                          
         MVC   D(3),GEN                                                         
         MVC   D+3(4),C+18                                                      
         SPACE 2                                                                
FIELD24  MVC   D+9(8),=C'DS    CL'                                              
         MVC   D+17(3),C+8         ALIGN LENGTH FIELD AND EDIT                  
         MVC   D+32(3),C+8                                                      
         CLI   C+8,C'0'                                                         
         BNE   FIELD25                                                          
         MVC   D+17(3),D+18                                                     
         MVI   D+32,C' '                                                        
         CLI   C+9,C'0'                                                         
         BNE   FIELD25                                                          
         MVC   D+17(3),D+18                                                     
         MVI   D+33,C' '                                                        
         SPACE 2                                                                
FIELD25  MVC   D+40(1),C+13        PROTECTION                                   
         CLI   D+40,C' '                                                        
         BNE   *+8                                                              
         MVI   D+40,C'U'                                                        
         CLI   C+13,C'N'           TEST FOR NOP FIELD                           
         BE    FIELD26                                                          
         SPACE 2                                                                
         MVC   D+23(2),C+4         LINE EDIT                                    
         CLI   D+23,C'0'                                                        
         BNE   *+8                                                              
         MVI   D+23,C' '                                                        
         SPACE 2                                                                
         MVC   D+28(2),C+6         COLUMN EDIT                                  
         CLI   D+28,C'0'                                                        
         BNE   *+8                                                              
         MVI   D+28,C' '                                                        
         SPACE 2                                                                
         MVI   D+37,C'A'           ALPHA/NUMERIC/LOWERCASE                      
         CLI   C+12,C'N'                                                        
         BNE   *+8                                                              
         MVI   D+37,C'N'                                                        
         CLI   C+12,C'L'                                                        
         BNE   *+8                                                              
         MVI   D+37,C'L'                                                        
         SPACE 2                                                                
         MVI   D+42,C'N'           BRILLIANCE                                   
         CLI   C+14,C' '                                                        
         BE    *+10                                                             
         MVC   D+42(1),C+14                                                     
         SPACE 2                                                                
         CLI   C+15,C'M'           MODIFY OPTION                                
         BNE   *+8                                                              
         MVI   D+51,C'M'                                                        
         SPACE 2                                                                
         MVI   D+56,C'T'           TRANSMIT OPTION                              
         CLI   C+16,C'N'                                                        
         BNE   *+8                                                              
         MVI   D+56,C'N'                                                        
         SPACE 2                                                                
         CLI   C+17,C'I'           INSERT CURSOR                                
         BNE   *+8                                                              
         MVI   D+61,C'I'                                                        
         SPACE 2                                                                
         MVI   D+65,C'Y'           DELETE BLANKS OPTION                         
         CLI   C+11,C'N'                                                        
         BNE   *+8                                                              
         MVI   D+65,C'N'                                                        
         SPACE 2                                                                
         CLC   C+24(3),SPACES      EDIT ID NUMBER                               
         BE    FIELD25A                                                         
         PACK  DUB,C+24(3)                                                      
         CVB   R4,DUB                                                           
         EDIT  (R4),(3,D+68),ZERO=NOBLANK                                       
*                                                                               
FIELD25A CLC   C+22(1),SPACES      SYMBOL SET                                   
         BE    FIELD25B                                                         
         BAS   RE,TSTSYM                                                        
         BNE   FIELD25B                                                         
         MVC   D+48(1),C+22                                                     
         SPACE 2                                                                
FIELD25B CLC   C+27(1),SPACES      EXTENDED HIGHLIGHTING                        
         BE    *+10                                                             
         MVC   D+44(1),C+27                                                     
         SPACE 2                                                                
         CLC   C+28(1),SPACES      EXTENDED COLOUR                              
         BE    *+10                                                             
         MVC   D+46(1),C+28                                                     
         SPACE 2                                                                
FIELD26  MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         SPACE 2                                                                
         CLI   EXTENHDR,C'Y'       TEST EXTENDED HEADER                         
         BNE   FIELDX                                                           
         CLI   C+18,C' '           PUT LABLE ON FIELD IF POSSIBLE               
         BE    FIELD28                                                          
         MVC   D(3),GEN                                                         
         MVC   D+3(4),C+18                                                      
         LA    R1,D+4                                                           
FIELD27  CLI   0(R1),C' '                                                       
         BE    *+12                                                             
         LA    R1,1(R1)                                                         
         B     FIELD27                                                          
         MVI   0(R1),C'X'                                                       
         SPACE 2                                                                
FIELD28  MVC   D+9(9),=C'DS    XL '    GENERATE DS STATEMENT                    
         LA    R1,EXTENLNQ                                                      
         CVD   R1,DUB                                                           
         UNPK  D+17(1),DUB                                                      
         OI    D+17,X'F0'                                                       
         SR    R4,R4               SET STEREO FIELD NUMBER                      
         ICM   R4,1,EXTENSTR                                                    
         BZ    FIELD29                                                          
         EDIT  (R4),(3,D+68),ZERO=NOBLANK                                       
         MVC   D+65(2),=C'S='                                                   
FIELD29  MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         SPACE 2                                                                
FIELDX   B     XIT                                                              
         EJECT                                                                  
*              ROUTINES FOR END OF BOOK (PHASE 2)                               
*                                                                               
BKEND2   NTR1                                                                   
         CLI   SWITCH,0                                                         
         BE    XIT                                                              
         MVI   SWITCH,0                                                         
         CLI   VALIDITY,C'Y'                                                    
         BNE   BKEND22                                                          
         MVC   D(3),GEN                                                         
         MVC   D+3(15),=C'LAST  DS    XL1'                                      
         CLI   TAGSW,C'N'                                                       
         BNE   *+10                                                             
         MVC   D(8),SPACES                                                      
         CLI   BOOKTAGS,C' '                                                    
         BE    *+10                                                             
         MVC   D(8),SPACES                                                      
         MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         MVC   D+9(20),=C'DS    XL2    INDICS='                                 
         MVC   D+29(2),BEFORE                                                   
         MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         MVC   D(3),GEN                                                         
         MVC   D+3(42),=C'WORK  DS    0D     START OF REMAINING WORK'           
         CLI   TAGSW,C'N'                                                       
         BNE   *+10                                                             
         MVC   D(8),SPACES                                                      
         CLI   BOOKTAGS,C' '                                                    
         BE    *+10                                                             
         MVC   D(8),SPACES                                                      
         MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         MVI   D,C'*'                                                           
         MVC   D+22(30),=C'SPACE USED SO FAR = NNNN BYTES'                      
         MVC   DUB,PHASELEN                                                     
         LH    R2,DUB                                                           
         LA    R2,7(R2)            ROUND UP TO NEXT DOUBLE WORD                 
         SRL   R2,3                                                             
         SLL   R2,3                                                             
         EDIT  (R2),(4,D+42),ALIGN=LEFT                                         
         MVC   P(80),D                                                          
         GOTO1 =V(PRINTER)                                                      
         BAS   RE,PUTPAN                                                        
         SPACE 2                                                                
         MVC   D(9),=C'++COMMENT'                                               
         MVC   D+10(10),PANDBOOK                                                
         LA    R2,D+10                                                          
         BAS   RE,PANSCAN                                                       
         MVC   0(30,R2),=C',SCRGEN-GENERATED SCREEN DSECT'                      
         BAS   RE,PUTPAN                                                        
         SPACE 2                                                                
BKEND22  LA    R6,16(R6)                                                        
         B     XIT6                                                             
         EJECT                                                                  
*              CONTROL OF PHASE 3 (SCREEN PRINT AND OBJECT DECK)                
*                                                                               
PHASE3   MVC   SUB1,SPACES                                                      
         MVC   SUB2,SPACES                                                      
         BAS   RE,PNTWRK           POINT TO START OF WRK FILE                   
         L     R6,=A(BOOKPOOL)                                                  
         BAS   RE,EOJPAN           OUTPUT ANY END OF PAN CARDS                  
         BAS   RE,SOJLNK           OUTPUT ANY START OF LINK CARDS               
         SPACE 2                                                                
PH32     BAS   RE,GETWRK           READ WRK FILE RECORD                         
         CLC   C(2),=C'/*'                                                      
         BNE   PH34                                                             
         BAS   RE,BKEND3                                                        
         BAS   RE,EOJLNK           OUTPUT ANY END OF LINK CARDS                 
         BAS   RE,CLSDSK           CLOSE ALL DISK FILES                         
         GOTO1 =V(PANIC),PNPL,(X'00',=C'CLOSE')                                 
         SPACE 2                                                                
         TM    OUTFLAG,X'01'                                                    
         BO    *+8                                                              
         OI    RETCODE+3,X'01'     SET NO PAN DATA                              
         TM    OUTFLAG,X'02'                                                    
         BO    *+8                                                              
         OI    RETCODE+3,X'02'     SET NO LNK DATA                              
         CLI   ERRORFLG,C'Y'                                                    
         BNE   *+8                                                              
         OI    RETCODE+3,X'04'     SET ERROR(S) FOUND                           
         XBASE RC=RETCODE                                                       
         SPACE 2                                                                
PH34     CLI   C,C'S'                                                           
         BNE   PH36                                                             
         BAS   RE,BKEND3                                                        
         BAS   RE,BKSTART3                                                      
         B     PH32                                                             
         SPACE 2                                                                
PH36     CLI   C,C'F'                                                           
         BNE   PH38                                                             
         BAS   RE,FIELD3                                                        
         B     PH32                                                             
         SPACE 2                                                                
PH38     BAS   RE,OVER3                                                         
         B     PH32                                                             
         EJECT                                                                  
*              ROUTINES FOR FIELD CARDS                                         
*                                                                               
FIELD3   NTR1                                                                   
         CLI   VALIDITY,C'Y'                                                    
         BNE   XIT2                                                             
         BAS   RE,TSTCTRY                                                       
         BNE   XIT2                                                             
         XC    0(8,R2),0(R2)       GENERATE EIGHT BYTE HEADER                   
         MVI   EXTENHDR,C'N'                                                    
         MVC   EXTENSTR,C+3                                                     
         CLC   C+24(3),SPACES                                                   
         BNE   *+12                                                             
         CLI   EXTENSTR,0                                                       
         BE    FIELD32                                                          
         MVI   EXTENHDR,C'Y'       SET NEED EXTENDED HEADER                     
         SPACE 2                                                                
FIELD32  SR    R3,R3               R3=ATTRIBUTE BYTE                            
*                                                                               
         CLI   C+13,C'N'                                                        
         BNE   *+12                                                             
         LA    R3,X'FF'            NOP=X'FF'                                    
         B     FIELD33                                                          
*                                                                               
         CLI   C+13,C'P'                                                        
         BNE   *+8                                                              
         LA    R3,X'20'            PROTECTED=X'20'                              
*                                                                               
         CLI   C+12,C'N'                                                        
         BNE   *+8                                                              
         LA    R3,X'10'(R3)        NUMERIC=X'10'                                
         CLI   C+12,C'L'                                                        
         BNE   *+8                                                              
         LA    R3,X'40'(R3)        LOWER CASE=X'40'                             
*                                                                               
         CLI   C+14,C'H'                                                        
         BNE   *+8                                                              
         LA    R3,X'08'(R3)        HIGH INTENSITY=X'08'                         
         CLI   C+14,C'Z'                                                        
         BNE   *+8                                                              
         LA    R3,X'0C'(R3)        LOW INTENSITY=X'0C'                          
*                                                                               
         CLI   C+11,C'N'                                                        
         BNE   *+8                                                              
         LA    R3,X'80'(R3)        DELETE BLANKS=X'80'                          
*                                                                               
         CLI   EXTENHDR,C'Y'                                                    
         BNE   *+8                                                              
         LA    R3,X'02'(R3)        EXTENDED HEADER=X'02'                        
*                                                                               
         CLI   C+15,C'M'                                                        
         BNE   *+8                                                              
         LA    R3,X'01'(R3)        MODIFY DATA = X'01'                          
*                                                                               
FIELD33  STC   R3,1(R2)            STORE ATTRIBUTE BYTE IN HEADER               
*                                                                               
         BAS   RE,BLDXA            BUILD EXTENDED ATTRIBUTE IN XABYTE           
*                                                                               
         CLI   XABYTE,0                                                         
         BE    FIELD34                                                          
         CLI   C+13,C'P'           SAVE XA BYTE IN HEADER IF PROTECTED          
         BNE   FIELD34                                                          
         MVI   4(R2),FINPXATT                                                   
         MVC   5(1,R2),XABYTE                                                   
*                                                                               
FIELD34  CLI   C+13,C'N'           TEST FOR NOP FIELD                           
         BE    FIELD38                                                          
         PACK  DUB,C+4(2)          SCREEN ADDRESS                               
         CVB   R3,DUB                                                           
         BCTR  R3,R0                                                            
         MH    R3,=H'80'                                                        
         PACK  DUB,C+6(2)                                                       
         CVB   R4,DUB                                                           
         AR    R3,R4                                                            
         BCTR  R3,R0                                                            
         STH   R3,DUB                                                           
         MVC   2(2,R2),DUB                                                      
         SPACE 2                                                                
FIELD36  SR    R3,R3               OUTPUT INDICATORS                            
         CLI   C+16,C'N'                                                        
         BE    *+8                                                              
         LA    R3,X'80'            TRANSMIT BIT=X'80'                           
         CLI   TRANSOPT,C'N'                                                    
         BE    *+8                                                              
         LA    R3,X'80'            FORCED IN US                                 
*                                                                               
         CLI   C+17,C'I'                                                        
         BNE   *+8                                                              
         LA    R3,X'40'(R3)        INSERT CURSOR=X'40'                          
         STC   R3,6(R2)                                                         
*                                                                               
FIELD38  PACK  DUB,C+8(3)          FIELD LENGTH                                 
         CVB   R3,DUB                                                           
         STC   R3,7(R2)                                                         
         LA    R4,8(R3)                                                         
         MVC   EXTENNUM,C+24       SAVE FIELD EXTENDED HEADER NUMBER            
         CLI   EXTENHDR,C'Y'                                                    
         BNE   *+8                                                              
         LA    R4,EXTENLNQ(R4)     SET EXTRA LEN FOR EXTENDED HEADER            
         STC   R4,0(R2)                                                         
*                                                                               
         LA    R3,8(R2)                                                         
         B     DATA                                                             
         EJECT                                                                  
*              OUTPUT THE DATA AND HANDLE CONTINUATIONS                         
*                                                                               
OVER3    NTR1                                                                   
         CLI   VALIDITY,C'Y'                                                    
         BNE   XIT2                                                             
         L     R3,OVERFLAD                                                      
         SPACE 2                                                                
DATA     MVI   0(R3),C' '          PAD FIELDS WITH SPACES                       
         MVC   1(249,R3),0(R3)                                                  
         CLI   COLS,C' '                                                        
         BNE   DATA1                                                            
         MVC   0(50,R3),C+30       80 COLUMN DATA                               
         CLI   C+29,C'C'                                                        
         BNE   DATA2                                                            
         LA    R3,50(R3)                                                        
         ST    R3,OVERFLAD                                                      
         B     XIT2                                                             
*                                                                               
DATA1    MVC   0(42,R3),C+30       72 COLUMN DATA                               
         CLI   C+29,C'C'                                                        
         BNE   DATA2                                                            
         LA    R3,42(R3)                                                        
         ST    R3,OVERFLAD                                                      
         B     XIT2                                                             
         SPACE 2                                                                
DATA2    SR    R3,R3               BUMP POINTER TO NEXT FIELD                   
         IC    R3,0(R2)                                                         
         CLI   EXTENHDR,C'Y'       TEST IF F CARD HAD/HAS EXTENDED              
         BNE   *+10                                                             
         LA    R5,EXTENLNQ                                                      
         SR    R3,R5                                                            
         LR    R4,R3                                                            
         SH    R4,=H'8'                                                         
         AR    R2,R3                                                            
         LR    R3,R2                                                            
         BCTR  R3,R0                                                            
*                                                                               
         CLI   EXTENHDR,C'Y'       GENERATE EXTENDED HEADER                     
         BNE   DATA4                                                            
         XC    0(EXTENLNQ,R2),0(R2)                                             
         MVI   EXTENHED,C'Y'       WE HAVE FOUND AN EXTENSION                   
*                                                                               
         OC    EXTENNUM,=C'000'    FIELD ID NUMBER                              
         PACK  DUB,EXTENNUM                                                     
         CVB   R1,DUB                                                           
         STC   R1,0(R2)                                                         
         GOTO1 =V(HEXIN),PARA,BOOK+4,4(R2),2                                    
         OC    PARA+12(4),PARA+12  SCREEN NUMBER                                
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   3(1,R2),EXTENSTR    STEREO FIELD NUMBER                          
*                                                                               
         MVC   5(1,R2),XABYTE      EXTENDED COLOR OPTIONS                       
*                                                                               
DATA3    LA    R2,EXTENLNQ(R2)     BUMP TO NEXT FIELD                           
*                                                                               
DATA4    CLI   0(R3),C' '          SCAN BACKWARDS PADDING FIELD                 
         BNE   XIT2                WITH TRAILING NULL CHARACTERS                
         MVI   0(R3),0                                                          
         BCTR  R3,0                                                             
         BCT   R4,DATA4                                                         
         B     XIT2                                                             
         SPACE 2                                                                
XIT      XIT1                      EXIT ROUTINES FOR ALL SUBROUTINES            
         SPACE 2                                                                
XIT2     XIT1  REGS=(R2)                                                        
         SPACE 2                                                                
XIT6     XIT1  REGS=(R6)                                                        
         EJECT                                                                  
*                                                                               
*        ROUTINE TO BUILD EXTENDED ATTRIBUTE BYTE IN XABYTE                     
*        R2=A(FIELD HEADER)                                                     
*                                                                               
         SPACE 2                                                                
BLDXA    NTR1                                                                   
         MVI   XABYTE,0                                                         
         CLI   C+22,C' '           CONVERT SYMBOL SET                           
         BE    BXA010                                                           
         BAS   RE,TSTSYM                                                        
         BNE   BXA010                                                           
         PACK  DUB,C+22(1)                                                      
         CVB   RF,DUB                                                           
         SLL   RF,3                                                             
         STC   RF,XABYTE                                                        
*                                                                               
BXA010   CLI   C+27,C' '           CONVERT EXTENDED HIGHLIGHTS                  
         BE    BXA020                                                           
         CLI   C+27,C'B'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATHBLK     BLINK                                        
         CLI   C+27,C'R'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATHREV     REVERSE VIDEO                                
         CLI   C+27,C'U'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATHUND     UNDERSCORE                                   
*                                                                               
BXA020   CLI   C+28,C' '           CONVERT EXTENDED COLOUR                      
         BE    BXA030                                                           
         CLI   C+28,C'B'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATCBLU     BLUE                                         
         CLI   C+28,C'R'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATCRED     RED                                          
         CLI   C+28,C'P'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATCPNK     PINK                                         
         CLI   C+28,C'G'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATCGRN     GREEN                                        
         CLI   C+28,C'T'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATCTUR     TURQUOISE                                    
         CLI   C+28,C'Y'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATCYEL     YELLOW                                       
         CLI   C+28,C'W'                                                        
         BNE   *+8                                                              
         OI    XABYTE,FXATCWHI     WHITE                                        
         B     BXA040                                                           
*                                                                               
BXA030   TM    XATBOPT,X'80'       CHECK OPTION TO SET BASE COLOURS             
         BNO   BXA040                                                           
         TM    1(R2),X'20'+X'08'   CHECK FIELD TYPE FROM HEADER                 
         BNZ   *+12                                                             
         MVI   XABYTE,FXATCGRN     UNPROT/NORMAL - GREEN                        
         B     BXA040                                                           
         TM    1(R2),X'20'                                                      
         BNZ   *+12                                                             
         MVI   XABYTE,FXATCRED     UNPROT/HIGH - RED                            
         B     BXA040                                                           
         TM    1(R2),X'08'                                                      
         BNZ   *+12                                                             
         MVI   XABYTE,FXATCBLU     PROT/NORMAL - BLUE                           
         B     BXA040                                                           
         MVI   XABYTE,FXATCWHI     PROT/HIGH - WHITE                            
*                                                                               
BXA040   EQU   *                                                                
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE FOR START OF BOOK (PHASE 3)                              
*                                                                               
BKSTART3 NTR1                                                                   
         MVI   SWITCH,1                                                         
         CLI   VALIDITY,C'Y'                                                    
         BNE   XIT2                                                             
         MVC   COLS,C+29           COL30 ON S CARD DEFINES 80/72 COLS           
         MVC   TITLE,SPACES                                                     
         L     RE,=A(TWA)                                                       
         LA    RF,4000                                                          
         XCEF                                                                   
         L     R2,=A(TWA)                                                       
         B     XIT2                                                             
         SPACE 2                                                                
*              ROUTINES FOR END OF BOOK (PHASE 3)                               
*                                                                               
BKEND3   NTR1                                                                   
         CLI   SWITCH,0                                                         
         BE    XIT                                                              
         MVI   SWITCH,0                                                         
         CLI   VALIDITY,C'Y'                                                    
         BNE   ENDCARD2                                                         
         XC    0(3,R2),0(R2)                                                    
         CLI   BEFORE,C'0'         COMPLETE TWA WITH INDICATORS                 
         BE    BKEND32                                                          
         CLI   BEFORE,C' '                                                      
         BE    BKEND32                                                          
         MVI   1(R2),1                                                          
         SPACE 2                                                                
BKEND32  CLI   AFTER,C' '                                                       
         BE    BKEND34                                                          
         CLI   AFTER,C'0'                                                       
         BE    BKEND34                                                          
         MVI   2(R2),1                                                          
         SPACE 2                                                                
BKEND34  CLI   INDICON,C'N'                                                     
         BE    *+8                                                              
         MVI   2(R2),1                                                          
*                                                                               
         CLI   STAMPIT,C' '                                                     
         BNE   BKEND35                                                          
*                                                                               
         MVI   3(R2),0                                                          
         MVC   4(L'STAMPID,R2),STAMPID                                          
         SR    R1,R1                                                            
         ICM   R1,3,PHASELEN                                                    
         LA    R1,L'STAMPID+1(R1)                                               
         STCM  R1,3,PHASELEN                                                    
*                                                                               
BKEND35  BAS   RE,SODLNK           OUTPUT ANY START OF DECK CARDS               
         MVI   D,X'02'             ESD CARD                                     
         MVC   D+1(3),=C'ESD'                                                   
         MVC   D+10(2),=H'16'                                                   
         MVC   D+14(2),=H'01'                                                   
         MVC   D+16(6),BOOK                                                     
         MVC   D+24(4),=F'0'                                                    
         MVI   D+29,0                                                           
         MVC   D+30(2),PHASELEN                                                 
         MVC   D+76(4),=C'0001'                                                 
         BAS   RE,PUTLNK                                                        
         SPACE 2                                                                
         L     R2,=A(TWA)                                                       
         MVC   DUB,PHASELEN                                                     
         LH    R3,DUB                                                           
         SR    R4,R4                                                            
         LA    R5,2                                                             
         SPACE 2                                                                
TXTLOOP  LTR   R3,R3               NOW LOOP WITH THE TEXT CARDS                 
         BZ    ENDCARD                                                          
         MVI   D,X'02'                                                          
         MVC   D+1(3),=C'TXT'                                                   
         ST    R4,DUB                                                           
         MVC   D+5(3),DUB+1        ORIGIN                                       
         MVC   D+14(2),=H'1'                                                    
         CVD   R5,DUB                                                           
         UNPK  D+76(4),DUB                                                      
         OI    D+79,X'F0'                                                       
         CH    R3,=H'56'                                                        
         BNH   TXT2                                                             
         MVC   D+10(2),=H'56'      FULL 56 BYTE CARD                            
         MVC   D+16(56),0(R2)                                                   
         BAS   RE,PUTLNK                                                        
         LA    R2,56(R2)                                                        
         SH    R3,=H'56'                                                        
         LA    R4,56(R4)                                                        
         LA    R5,1(R5)                                                         
         B     TXTLOOP                                                          
         SPACE 2                                                                
TXT2     STH   R3,DUB              REMNANTS OF PHASE                            
         MVC   D+10(2),DUB                                                      
         BCTR  R3,R0                                                            
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   D+16(0),0(R2)                                                    
         BAS   RE,PUTLNK                                                        
         LA    R5,1(R5)                                                         
         SPACE 2                                                                
ENDCARD  MVI   D,X'02'                                                          
         MVC   D+1(3),=C'END'                                                   
         CVD   R5,DUB                                                           
         UNPK  D+76(4),DUB                                                      
         OI    D+79,X'F0'                                                       
         BAS   RE,PUTLNK                                                        
         BAS   RE,EODLNK           OUTPUT ANY END OF DECK CARDS                 
         SPACE 2                                                                
ENDCRD1A LA    RE,TWAHDR           PRINT SCREEN IMAGE(S)                        
         ST    RE,PARA                                                          
         XC    PARA+4(4),PARA+4                                                 
         MVC   PARA+8(2),=C'DD'    SET DATA DCTNRY INFO FLAG                    
         MVC   PARA+10(1),BOOK+1   SET SYSTEM LETTER FOR DCTNRY                 
         LA    R1,LANGS                                                         
         ST    R1,ALANGS           POINT TO LANG LETTER LIST                    
ENDCRD1B CLI   0(R1),C' '                                                       
         BE    ENDCRD1C                                                         
         MVC   PARA+11(1),0(R1)    SET LANG LETTER FOR DCTNRY                   
         ZAP   LINE,=P'75'                                                      
         MVC   P,SPACES                                                         
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(SCRPRT),PARA                                                  
         L     R1,ALANGS                                                        
         LA    R1,1(R1)                                                         
         ST    R1,ALANGS                                                        
         B     ENDCRD1B                                                         
ENDCRD1C EQU   *                                                                
*                                                                               
         CLI   EXTENHED,C'Y'       PRINT EXTENDED HDR HELP INFO                 
         BNE   *+8                                                              
         BAS   RE,HELPPRT                                                       
         SPACE 2                                                                
ENDCARD2 LA    R6,16(R6)                                                        
         B     XIT6                                                             
         EJECT                                                                  
HELPPRT  NTR1                                                                   
*                                                                               
         ZAP   LINE,=P'75'         EJECT PAGE                                   
         MVC   TITLE,SPACES                                                     
         MVC   TITLE(23),=C'HELP RECORD INFORMATION'                            
         MVC   P,SPACES                                                         
         GOTO1 =V(PRINTER)                                                      
         MVC   P(11),=C'SYSTEM  -- '                                            
         MVC   P+11(2),BOOK                                                     
         GOTO1 =V(PRINTER)                                                      
         MVC   P(11),=C'PROGRAM -- '                                            
         MVC   P+11(2),BOOK+2                                                   
         GOTO1 =V(PRINTER)                                                      
         MVC   P(11),=C'SCREEN  -- '                                            
         MVC   P+11(2),BOOK+4                                                   
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P(30),=C'ROW     COL     FIELD     NAME'                         
         GOTO1 =V(PRINTER)                                                      
         MVC   P(30),=C'---     ---     -----     ----'                         
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         L     R2,=A(TWA)          BEGINNING OF SCREEN                          
*                                                                               
HP10     ZIC   R1,0(R2)            LENGTH OF FIELD                              
         TM    1(R2),X'20'         TEST PROTECTED                               
         BZ    HP30                NO                                           
*                                                                               
         MVC   SVP,SPACES                                                       
         SH    R1,=H'8'                                                         
         TM    1(R2),X'02'         TEST EXTENDED HEADER                         
         BZ    *+8                                                              
         SH    R1,=Y(EXTENLNQ)                                                  
*                                                                               
         BCTR  R1,0                R1 IS LENGTH OF DATA                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         OC    8(0,R2),8(R2)       TEST ANY DATA IN FIELD                       
         BZ    HP50                NO -- TRY NEXT FIELD                         
*                                                                               
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SVP+26(0),8(R2)     SAVE THE TEXT                                
         B     HP50                                                             
*                                                                               
HP30     TM    1(R2),X'02'         TEST EXTENDED HEADER                         
         BO    *+14                IT IS                                        
         MVC   SVP,SPACES                                                       
         B     HP50                                                             
*                                                                               
         ZIC   R1,0(R2)                                                         
         AR    R1,R2                                                            
         SH    R1,=Y(EXTENLNQ)     BEGINNING OF EXTENDED HEADER                 
         CLI   0(R1),0             TEST ID NUMBER EXISTS FOR THIS FIELD         
         BNE   *+14                IT DOES                                      
         MVC   SVP,SPACES                                                       
         B     HP50                                                             
*                                                                               
         ZIC   RE,0(R1)            EDIT FIELD ID                                
         EDIT  (RE),(3,SVP+18)                                                  
*                                                                               
         LH    RE,2(R2)            FIELD ADDRESS                                
         SRDL  RE,32                                                            
         D     RE,=F'80'                                                        
         AHI   RE,1                COL NUM (1..80)                              
         AHI   RF,1                ROW NUM (1..24)                              
         CVD   RF,DUB                                                           
         UNPK  DUB(3),DUB+6(2)                                                  
         OI    DUB+2,X'F0'                                                      
         MVC   SVP+1(2),DUB+1      EDIT ROW NUMBER                              
         CLI   SVP+1,C'0'                                                       
         BNE   *+8                                                              
         MVI   SVP+1,C' '                                                       
         CVD   RE,DUB                                                           
         UNPK  DUB(3),DUB+6(2)                                                  
         OI    DUB+2,X'F0'                                                      
         MVC   SVP+9(2),DUB+1      EDIT COLUMN NUMBER                           
         CLI   SVP+9,C'0'                                                       
         BNE   *+8                                                              
         MVI   SVP+9,C' '                                                       
*                                                                               
         MVC   P,SVP                                                            
         GOTO1 =V(PRINTER)                                                      
*                                                                               
HP50     ZIC   R1,0(R2)            FIELD LENGTH                                 
         AR    R2,R1               NEXT FIELD                                   
         LTR   R1,R1               TEST END OF TWA                              
         BNZ   HP10                                                             
*                                                                               
         GOTO1 =V(PRINTER)         SKIP A LINE                                  
         B     XIT                                                              
         EJECT                                                                  
SOJPAN   NTR1                      MVS START OF PAN CARDS                       
         B     XIT                                                              
EOJPAN   NTR1                      MVS END OF PAN CARDS                         
         B     XIT                                                              
SOJLNK   NTR1                      MVS START OF LINK CARDS                      
         B     XIT                                                              
EOJLNK   NTR1                      MVS END OF LINK CARDS                        
         B     XIT                                                              
SODLNK   NTR1                      MVS START OF OBJECT DECK CARDS               
         B     XIT                                                              
*                                                                               
EODLNK   NTR1                      MVS END OF OBJECT DECK CARDS                 
*                                                                               
         MVC   D(80),=CL80' IDENTIFY XXXXXX(''GEN:UUUUUUU BBBBBBBBBB MM+        
               MDD/YY HH:MM'')'                                                 
         L     RF,PSAAOLD-PSA(,0)       GET CURRENT/HOME ASCB                   
         L     RF,(ASCBASXB-ASCB)(,RF)  GET ASXB ADDRESS                        
         L     RF,(ASXBSENV-ASXB)(,RF)  GET ACEE ADDRESS                        
         CLC   =CL4'ACEE',0(RF)         VALID ACEE?                             
         JE    *+6                      YES: EXTRACT RACF USERID                
         DC    H'0'                     NO: IMPOSSIBLE                          
         MVC   D+10(6),BOOK        CSECT NAME                                   
         MVC   D+22(7),(ACEEUSRI-ACEE)(RF)  USER WHO SUBMITTED COMPILE          
         MVC   D+30(10),PANSRCBK   PAN SOURCE BOOK NAME                         
         GOTO1 =V(DATCON),PARA,(5,0),(11,D+41)                                  
         THMS                                                                   
         ST    R1,FULL             R1=0HHMMSS+                                  
         OI    FULL+3,X'0F'                                                     
         UNPK  DUB(6),FULL         CONSTRUCT COMPILE TIME                       
         MVC   D+50(2),DUB         HOURS                                        
         MVI   D+52,C':'                                                        
         MVC   D+53(2),DUB+2       MINUTES                                      
         BAS   RE,PUTLNK                                                        
*                                                                               
         MVC   D(80),=CL80' NAME ABCDEF(R)'                                     
         MVC   D+6(6),BOOK                                                      
         CLC   OVRPHASE,SPACES                                                  
         BE    *+10                                                             
         MVC   D+6(4),OVRPHASE     OVERRIDE LOAD MODULE NAME                    
         CLI   TESTSW,C'Y'                                                      
         BNE   *+14                                                             
         MVC   D+12(4),=C'T(R)'    SET TEST LEVEL CHR AT END OF NAME            
         B     EODLNK1                                                          
         CLI   TESTSW,C'N'                                                      
         BE    EODLNK1                                                          
         MVC   D+12(4),=C'T(R)'                                                 
         MVC   D+12(1),TESTSW                                                   
EODLNK1  MVC   TITLE(20),D+1       SET LOAD MODULE NAME IN TITLE                
         BAS   RE,PUTLNK                                                        
*                                                                               
         B     XIT                                                              
         EJECT                                                                  
OPNDSK   NTR1                      OPEN WRKFIL,PANFIL,LNKFIL                    
         LA    R2,WRKFIL                                                        
         OPEN  ((2),OUTIN)                                                      
         LA    R2,PANFIL                                                        
         OPEN  ((2),OUTPUT)                                                     
         LA    R2,LNKFIL                                                        
         OPEN  ((2),OUTPUT)                                                     
         B     XIT                                                              
CLSDSK   NTR1                      CLOSE WRKFIL,PANFIL,LNKFIL                   
         LA    R2,WRKFIL                                                        
         CLOSE ((2))                                                            
         LA    R2,PANFIL                                                        
         CLOSE ((2))                                                            
         LA    R2,LNKFIL                                                        
         CLOSE ((2))                                                            
         B     XIT                                                              
GETWRK   NTR1                      READ WRK FILE RECORD                         
         LA    R2,WRKFIL                                                        
         READ  DECBR,SF,(R2),C                                                  
         CHECK DECBR                                                            
         B     XIT                                                              
PNTWRK   NTR1                      POINT TO START OF WRK FILE                   
         LA    R2,WRKFIL                                                        
         POINT (R2),WRKTTBF                                                     
         B     XIT                                                              
PUTWRK   NTR1                      WRITE WRK FILE RECORD                        
         LA    R2,WRKFIL                                                        
         WRITE DECBW,SF,(R2),C                                                  
         CHECK DECBW                                                            
         B     XIT                                                              
PUTPAN   NTR1                      WRITE PAN FILE RECORD                        
         LA    R1,PANFIL                                                        
         PUT   (R1),D                                                           
         MVC   D(80),SPACES                                                     
         OI    OUTFLAG,X'01'       SET PAN DATA OUTPUT                          
         B     XIT                                                              
PUTLNK   NTR1                      WRITE LNK FILE RECORD                        
         LA    R1,LNKFIL                                                        
         PUT   (R1),D                                                           
         MVC   D(80),SPACES                                                     
         OI    OUTFLAG,X'02'       SET LNK DATA OUTPUT                          
         B     XIT                                                              
         EJECT                                                                  
WRKFIL   DCB   DDNAME=WRKFIL,DSORG=PS,RECFM=FB,LRECL=80,               X        
               BLKSIZE=80,MACRF=(RP,WP),EODAD=WRKEOF                            
WRKTTBF  DC    A(1)                                                             
WRKEOF   DC    A(0)                                                             
         SPACE 2                                                                
PANFIL   DCB   DDNAME=PANFIL,DSORG=PS,RECFM=FB,LRECL=80,               X        
               BLKSIZE=0,MACRF=PM                                               
         SPACE 2                                                                
LNKFIL   DCB   DDNAME=LNKFIL,DSORG=PS,RECFM=FB,LRECL=80,               X        
               BLKSIZE=0,MACRF=PM                                               
         SPACE 2                                                                
         DS    0L                                                               
         DC    CL16'*SSB*SSB*SSB*SSB'                                           
* ++INCLUDE FASSBOFF                                                            
         PRINT OFF                                                              
       ++INCLUDE FASSBOFF                                                       
         PRINT ON                                                               
         ORG   SSOOFF                                                           
SSB      DC    XL(SSOOFFX-SSOOFF)'00'                                           
         ORG   SSOXTND                                                          
         DC    X'FF'               SET EXTENDED OFFLINE SSB                     
         ORG   SSOMTIND            SYSTEM DATAMGR FLAGS                         
         DC    AL1(SSOWRTN)        WRITE=NO (DON'T OPEN FOR UPDATE)             
         ORG                                                                    
         SPACE 3                                                                
         EJECT                                                                  
*              STORAGE AREAS FOR PROGRAM                                        
*                                                                               
*        Note stampid must be lower case or CCPAN thinks its a stamp            
*                                                                               
STAMPIT  DC    C' '                                                             
STAMPID  DC    C'book=?????????? level=??? date=??/??/??'                       
SCRNHEAD DC    C'SCREEN LAYOUT PHASE ABCDEF'                                    
DUB      DS    D                                                                
DUB1     DS    D                                                                
FULL     DS    F                                                                
SAVER345 DS    3F                                                               
SAVERE   DS    F                                                                
SAVERF   DS    F                                                                
PARA     DS    6F                                                               
PNPL     DC    A(0),A(DUB),A(PANDBOOK),A(C)                                     
OVERFLAD DC    F'0'                                                             
RETCODE  DC    F'0'                                                             
LASTEND  DC    H'0'                                                             
PANBOOK  DS    CL10                                                             
PANDBOOK DS    CL10                                                             
PANSRCBK DS    CL10                                                             
PANLEVEL DS    CL3                                                              
PANTYPE  DS    CL5                                                              
COLS     DC    C' '                                                             
LASTROW  DC    C'00'                                                            
LASTCOL  DC    C'00'                                                            
LASTLEN  DC    C'000'                                                           
LASTPROT DC    C'P'                                                             
CONTINUE DC    C' '                                                             
OUTFLAG  DC    X'00'                                                            
ERRORFLG DC    C'N'                'Y' IF ANY ERROR WAS FOUND                   
SWITCH   DC    X'00'                                                            
TESTSW   DC    C'A'                DEFAULT TO "OPTION TEST=A"                   
NEWBOOK  DC    C'N'                                                             
OVRPHASE DC    CL4' '                                                           
EXTENHDR DC    C'N'                                                             
EXTENNUM DC    CL3' '                                                           
EXTENSTR DC    X'00'                                                            
TAGSW    DC    C'Y'                                                             
BOOKTAGS DC    C' '                                                             
DATE     DS    CL8                                                              
COUNTRY  DS    CL2                                                              
NOOPFLAG DS    C'N'                                                             
TRANSOPT DC    C'Y'                                                             
INDICON  DC    C'Y'                                                             
BYTE     DC    X'00'                                                            
XABYTE   DC    X'00'                                                            
XATBOPT  DC    X'00'                                                            
         SPACE 1                                                                
ALANGS   DC    A(LANGS)                                                         
ADICT    DC    A(DICTPOOL)                                                      
ANXTDICT DC    A(DICTPOOL)                                                      
LANGS    DC    CL7'E      ',C' '                                                
DICTBOOK DC    CL10'XXDDEQUS'                                                   
         DC    CL2' '                                                           
ESCTXT   DS    CL8                                                              
ESCMAXL  DS    H                                                                
         DS    H                                                                
ESCDATA  DS    0CL80               ESCAPE DATA FIELD                            
ESCCDE   DS    X                                                                
ESCNUM   DS    XL2                                                              
ESCLEN   DS    X                                                                
ESCFILL  DS    XL76                                                             
         SPACE 1                                                                
C        DC    CL80' '                                                          
D        DC    CL80' '                                                          
SVC      DC    CL80' '                                                          
LASTC    DC    CL80' '                                                          
SVP      DC    CL132' '                                                         
         SPACE 1                                                                
WORKH    DC    H'0'                                                             
WORK     DC    CL256' '                                                         
         DC    CL30' '                                                          
DDWKH    DC    H'0'                                                             
DDWK     DC    CL256' '                                                         
         DC    CL30' '                                                          
         SPACE 1                                                                
DUMPLIST DS    0F                                                               
         DC    A(SCRGEN),V(DUMMY)                                               
         ORG   *-4                                                              
         DC    X'80'                                                            
         ORG                                                                    
         SPACE 1                                                                
EXTENLNQ EQU   8                                                                
EOC      EQU   X'79'               END OF CARD C'`'                             
DDC      EQU   X'50'               DATA DCTNRY C'&' START CHR                   
DDD      EQU   X'61'               DATA DCTNRY C'/' DELIM CHR                   
DDT      EQU   X'50'               DATA DCTNRY C'&' TERM CHR                    
         SPACE 1                                                                
         LTORG                                                                  
         DS    0D                                                               
         DC    CL8'*TWAHDR*'                                                    
TWAHDR   DC    XL64'00'                                                         
TWA      DC    6000X'00'                                                        
         SPACE 1                                                                
BOOKPOOL DC    960X'00'                                                         
         SPACE 1                                                                
         DS    0D                                                               
         DC    C'DICTPOOL'                                                      
DICTPOOL DC    (MAXDENTS)XL10'00'                                               
         DC    CL10'ENDOFDICT'                                                  
MAXDENTS EQU   15000                                                            
SUBLINE1 DC    C'LINE COLM LEN A/N P B H C S MODF TRNS CUR DEL ID#'             
SUBLINE2 DC    C'---- ---- --- --- - - - - - ---- ---- --- --- ---'             
         EJECT                                                                  
POOLD    DSECT                     DSECT TO COVER POOL ITEM                     
POOLITEM DS    0CL16                                                            
BOOK     DS    CL6                                                              
BEFORE   DS    CL1                                                              
AFTER    DS    CL1                                                              
NODSECT  DS    CL1                                                              
GEN      DS    CL3                                                              
VALIDITY DS    CL1                                                              
PHASELEN DS    CL2                                                              
EXTENHED DS    CL1                                                              
         SPACE 2                                                                
       ++INCLUDE DDDDEQUS                                                       
         EJECT                                                                  
       ++INCLUDE DDFLDHDR                                                       
         EJECT                                                                  
       ++INCLUDE DDDPRINT                                                       
         SPACE 2                                                                
         IHAPSA                                                                 
         IHAACEE                                                                
         IHAASCB                                                                
         IHAASXB                                                                
         SPACE 2                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'033DDSCRGEN  01/08/13'                                      
         END                                                                    
