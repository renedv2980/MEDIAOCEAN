*          DATA SET MPQVERT    AT LEVEL 031 AS OF 05/01/02                      
*CATALP MPQVERT                                                                 
         TITLE 'MPQVERT  - QUESTIONNAIRE FILE INVERSION PROGRAM'                
QVERT    CSECT                                                                  
         PRINT NOGEN                                                            
         NBASE 500,QVERT,=V(REGSAVE)                                            
         LR    RA,RC                                                            
         USING WORKD,RA                                                         
         SPACE 3                                                                
*                                  ADDRESS CONSTANTS                            
MAIN     DS    0H                                                               
         LA    R1,ACONS                                                         
         LA    R2,RCONS                                                         
         LA    R0,ACONSN                                                        
MP3      DS    0H                                                               
         MVC   0(4,R2),0(R1)                                                    
         LA    R1,4(R1)                                                         
         LA    R2,4(R2)                                                         
         BCT   R0,MP3                                                           
*                                                                               
         L     R9,CPRINT                                                        
         USING DPRINT,R9                                                        
         MVI   DASHES,C'-'                                                      
         MVC   DASHES+1(L'DASHES-1),DASHES                                      
         ZAP   MAXPAGE,=P'0'                                                    
*                                                                               
         MVC   TITLE(36),=C'QVERT - QUESTIONNAIRE FILE INVERSION'               
         GOTO1 ASETRUN             RUN CONTROL CARDS                            
*                                  ADJUST QVOUT DTF                             
         L     RF,AQVOUT                                                        
         MVC   62(2,RF),OPBLKSZE+2  BLKSIZE                                     
         MVC   82(2,RF),OPRMAX+2    REC SIZE                                    
         OPEN  (QVOUT,OUTPUT)                                                   
*                                                                               
MP3C     DS    0H                                                               
*                                  ADJUST INPUT DTF                             
         L     R6,AQVIN                                                         
         MVC   62(2,R6),IPBLKSZE+2  BLKSIZE                                     
         MVC   82(2,R6),CRECL+2    'CARD' REC SIZE                              
         OPEN  (QVIN,INPUT)                                                     
*                                                                               
         GOTO1 COVAIL,DMCB,C'LOOK'     LOOK SEE HOW MUCH                        
         L     RE,DMCB+8           TOTAL AMOUNT                                 
         S     RE,=A(600*1024)     LEAVE 600 K FOR SORT, ETC                    
         BNP   MP3D                NOT ENOUGH CORE                              
         C     RE,=A(50*1024)      NEED AT LEAST 50 K FOR TABLES                
         BNL   MP3F                                                             
*                                                                               
MP3D     DS    0H                                                               
         MVI   ERR,CORERR                                                       
         GOTO1 AGETERR,DMCB,(ERR,P)                                             
         B     MP3J                                                             
*                                                                               
MP3F     DS    0H                                                               
         ST    RE,DMCB+4                                                        
         ST    RE,DMCB+8                                                        
         GOTO1 (RF),(R1),C'GET'        ACTUALLY GET CORE                        
         MVC   ACTAB,DMCB+4            SET START OF TABLE                       
         L     RF,ACTAB                                                         
         A     RF,DMCB+8                                                        
         ST    RF,ACTABX           END OF TABLE                                 
*                                                                               
         LA    RF,WORKD                                                         
         ST    RF,DUB                                                           
         MVC   DUB+4(4),ACTABX                                                  
         OI    DUB+4,X'80'         EOL                                          
         GOTO1 STXITER,DMCB,DUB                                                 
*                                                                               
         GOTO1 ABCT                BUILD CONDITION TABLE                        
*                                                                               
         LA    R3,PRTVS1           PRINT COUNTERS FOR SPEC PHASE                
         LA    R4,PRTWDS1                                                       
         BAS   RE,PRTCNTS                                                       
*                                                                               
         TM    ERRLEV,X'80'        TEST ERROR SEVERITY                          
         BZ    MP4                                                              
         MVC   P(43),=C'**ERRORS IN SPECIFICATIONS, RUN CANCELLED**'            
         GOTO1 PRINTER                                                          
*                                                                               
MP3J     DS    0H                                                               
         CLI   DMPSW,C'Y'                                                       
         BNE   *+6                                                              
         DC    H'0'                                                             
         ABEND 999                                                              
*                                                                               
MP4      DS    0H                                                               
         GOTO1 PRINTER                                                          
         MVC   P(11),=C'INPUT PHASE'                                            
         GOTO1 PRINTER                                                          
         MVC   P(11),DASHES                                                     
*                                                                               
MP6      DS    0H                                                               
         GOTO1 AGETRESP            GET A RESPONDENT                             
         CLI   LASTRNO,X'FF'       TEST END                                     
         BE    MP10                                                             
         GOTO1 APOSTR              POST TO STRING TABLE                         
*                                                                               
         CLC   RGCNT,GULPSZE       TEST 'GULP' FULL                             
         BL    MP6                                                              
*                                                                               
MP10     DS    0H                                                               
         GOTO1 AFLSHTAB            YES- FLUSH STRINGS TO SORTER                 
         CLI   LASTRNO,X'FF'       TEST END                                     
         BNE   MP6                                                              
*                                                                               
         LA    R3,PRTVS2           PRINT INPUT PHASE COUNTERS                   
         LA    R4,PRTWDS2                                                       
         BAS   RE,PRTCNTS                                                       
*                                                                               
         CLC   NRESPS,RESPCNT      TEST RIGHT NUMBER OF RESPS                   
         BE    MP22                                                             
         MVC   P(2),=C'**'                                                      
         MVI   ERR,RCNTERR                                                      
         GOTO1 AGETERR,DMCB,(ERR,P+3)                                           
         GOTO1 PRINTER                                                          
         GOTO1 SORTER,DMCB,=C'END'                                              
         B     MP3J                                                             
*                                                                               
MP22     DS    0H                                                               
         ZAP   LINE,=P'99'           NEW PAGE                                   
         MVC   MID1(12),=C'OUTPUT PHASE'                                        
         MVC   MID2(12),DASHES                                                  
         CLI   PRINTCCP,C'Y'                                                    
         BNE   MP23                                                             
         MVC   SUB1(53),=C'CARD COLUMN PUNCH ACCESS          COUNT   COX        
               MPRESSION'                                                       
         MVC   SUB2(53),=C'---- ------ ----- ------          -----   --X        
               ---------'                                                       
*                                                                               
MP23     DS    0H                                                               
         GOTO1 SORTER,DMCB,=C'GET'   STRINGS BACK FROM SORT                     
         L     R4,DMCB+4                                                        
         LTR   R4,R4                                                            
         BNZ   *+8                                                              
         LA    R4,=X'FF'           SET EOF                                      
         ST    R4,AWTREC                                                        
*                                                                               
         GOTO1 AOPPROC             FINAL OUTPUT PHASE                           
         CLI   0(R4),X'FF'         TEST DONE                                    
         BNE   MP23                                                             
*                                                                               
MP90     DS    0H                                                               
         LA    R3,PRTVS3           PRINT OUTPUT PHASE COUNTERS                  
         LA    R4,PRTWDS3                                                       
         BAS   RE,PRTCNTS                                                       
*                                                                               
MP92     DS    0H                                                               
         GOTO1 SORTER,DMCB,=C'END'                                              
*                                                                               
DONE     DS    0H                                                               
         CLI   DMPSW,C'Y'                                                       
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
EOJ      DS    0H                                                               
         XBASE                                                                  
         SPACE 3                                                                
*                                  PRINT SET OF COUNTERS                        
PRTCNTS  NTR1                                                                   
         GOTO1 PRINTER                                                          
         ZIC   R5,0(R4)            NUMBER OF COUNTERS                           
         LA    R4,1(R4)                                                         
*                                                                               
PRTCNT2  DS    0H                                                               
         MVC   P(35),1(R4)                                                      
         EDIT  (B4,0(R3)),(10,P+35),COMMAS=YES,ZERO=NOBLANK                     
         GOTO1 PRINTER                                                          
*                                                                               
PRTCNT4  DS    0H                                                               
         LA    R3,4(R3)                                                         
         LA    R4,36(R4)                                                        
         BCT   R5,PRTCNT2                                                       
*                                                                               
         GOTO1 PRINTER                                                          
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         SPACE 3                                                                
ACONS    DS    0F                                                               
         DC    V(CARDS)                                                         
         DC    V(SCANNER)                                                       
         DC    A(BCT)                                                           
         DC    V(SORTER)                                                        
         DC    A(SETRUN)                                                        
         DC    V(HEXOUT)                                                        
         DC    V(XSORT)                                                         
         DC    V(COVAIL)                                                        
         DC    V(STXITER)                                                       
         DC    A(CVEBC)                                                         
         DC    V(CBTBL)                                                         
         DC    A(PRNTR)                                                         
         DC    V(PRINTER)                                                       
         DC    V(CPRINT)                                                        
         DC    A(GETERR)                                                        
         DC    A(QVIN)                                                          
         DC    A(QVOUT)                                                         
         DC    A(MASKTAB)                                                       
         DC    A(DMPREC)                                                        
         DC    A(OPPROC)                                                        
         DC    A(SETSORT)                                                       
         DC    A(FLSHTAB)                                                       
         DC    V(NUMVAL)                                                        
         DC    V(DATVAL)                                                        
         DC    V(DATCON)                                                        
         DC    A(GETRESP)                                                       
         DC    A(POSTR)                                                         
ACONSN   EQU   (*-ACONS)/4                                                      
         SPACE 2                                                                
PRTWDS1  DS    0C                                                               
         DC    AL1(6)                                                           
         DC    X'80',CL35'VALID SPEC COUNT...................'                  
         DC    X'00',CL35'SPEC COUNT ADJUSTED FOR NUMERICS...'                  
         DC    X'80',CL35'PROJECTED RESPONDENT COUNT.........'                  
         DC    X'00',CL35'CORE AVAILABLE FOR STRINGS.........'                  
         DC    X'00',CL35'''GULP'' SIZE........................'                
         DC    X'00',CL35'WORKFILE RECORD LENGTH.............'                  
         SPACE 2                                                                
PRTWDS2  DS    0C                                                               
         DC    AL1(5)                                                           
         DC    X'80',CL35'INPUT FILE RECORD COUNT............'                  
         DC    X'80',CL35'ACTUAL RESPONDENT COUNT............'                  
         DC    X'00',CL35'''GULP'' COUNT.......................'                
         DC    X'80',CL35'INPUT DATA ERRORS..................'                  
         DC    X'00',CL35'WORKFILE OUTPUT COUNT..............'                  
         SPACE 2                                                                
PRTWDS3  DS    0C                                                               
         DC    AL1(3)                                                           
         DC    X'00',CL35'WORK FILE INPUT COUNT..............'                  
         DC    X'80',CL35'OUTPUT FILE RECORD COUNT...........'                  
         DC    X'80',CL35'OUTPUT FILE BYTE COUNT.............'                  
*                                                                               
*                                  COLUMN BINARY CONVERSION TABLE               
MASKTAB  DS    0C                                                               
         DC    C'Y',X'20'                                                       
         DC    C'X',X'10'                                                       
         DC    C'0',X'08'                                                       
         DC    C'1',X'04'                                                       
         DC    C'2',X'02'                                                       
         DC    C'3',X'01'                                                       
         DC    C'4',X'A0'          X'80' = BYTE 2                               
         DC    C'5',X'90'                                                       
         DC    C'6',X'88'                                                       
         DC    C'7',X'84'                                                       
         DC    C'8',X'82'                                                       
         DC    C'9',X'81'                                                       
         DC    C'B',X'C0'          SPECIAL- BLANK (NO PUNCH)                    
         DC    C'S',X'C1'          SPECIAL- SINGLE PUNCH                        
         DC    X'FFFF'             EOL                                          
*                                                                               
         EJECT                                                                  
*                                  SET RUN PARAMETERS                           
SETRUN   CSECT                                                                  
         NMOD1 0,SETRUN                                                         
         SPACE 2                                                                
         GOTO1 PRINTER                                                          
         MVC   P(18),=C'RUN SPECIFICATIONS'                                     
         GOTO1 PRINTER                                                          
         MVC   P(18),DASHES                                                     
         GOTO1 PRINTER                                                          
*                                                                               
         MVI   ERR,SPECERR                                                      
*                                                                               
         MVC   CNUMLST,=C'1234567890XY'    CARD NOS 1 - 12                      
         MVC   MAXGULP,=A((4096-L'WTKEY)*8) MAX PER GULP                        
*                                         (FIXES MAX OF WTREC AT 4096)          
         MVC   OPRMAX,=F'4000'     DEFAULT OUTPUT REC LEN                       
SR2      DS    0H                                                               
         GOTO1 CARDS,DMCB,CARD,=C'RE00'                                         
         CLC   =C'/*',CARD                                                      
         BE    SR60                                                             
         MVC   P(80),CARD                                                       
         GOTO1 PRINTER                                                          
         CLI   CARD,C'*'           IGNORE CARDS WITH *                          
         BE    SR2                                                              
         LA    RE,CEDTWRK                                                       
         LA    RF,L'CEDTWRK                                                     
*        XCEF                                                                   
*                                                                               
         GOTO1 SCANNER,DMCB,(C'C',CARD),CEDTWRK                                 
         LA    R2,CEDTWRK                                                       
*                                                                               
SR3      DS    0H                                                               
         CLI   0(R2),0             END OF FIELDS                                
         BE    SR2                 NEXT CARD                                    
*                                                                               
         CLC   =C'DUMP',12(R2)                                                  
         BNE   SR8                                                              
         MVI   DMPSW,C'Y'                                                       
         B     SR40                                                             
*                                                                               
SR8      DS    0H                                                               
         CLC   =C'NCARDS',12(R2)   NUMBER OF CARDS/RESP                         
         BNE   SR9                                                              
         OC    8(4,R2),8(R2)                                                    
         BZ    SRERRC                                                           
         MVC   NCARDS,8(R2)                                                     
         B     SR40                                                             
*                                                                               
SR9      DS    0H                                                               
         CLC   =C'NCOLS',12(R2)    NUMBER OF COLUMNS/CARD                       
         BNE   SR10                                                             
         OC    8(4,R2),8(R2)                                                    
         BZ    SRERRC                                                           
         MVC   NCOLS,8(R2)                                                      
         B     SR40                                                             
*                                                                               
SR10     DS    0H                                                               
         CLC   =C'IPBLKSZE',12(R2)  INPUT FILE BLOCK SIZE                       
         BNE   SR11                                                             
         OC    8(4,R2),8(R2)                                                    
         BZ    SRERRC                                                           
         MVC   IPBLKSZE,8(R2)                                                   
         B     SR40                                                             
*                                                                               
SR11     DS    0H                                                               
         CLC   =C'RESPNCOL',12(R2)   COLUMN FOR RESP NUMBER                     
         BNE   SR12                                                             
         OC    8(4,R2),8(R2)                                                    
         BZ    SRERRC                                                           
         MVC   RESPCOL,8(R2)                                                    
         B     SR40                                                             
*                                                                               
SR12     DS    0H                                                               
         CLC   =C'RESPNLEN',12(R2)   LENGTH OF RESPONDENT NUMBER                
         BNE   SR13                                                             
         OC    8(4,R2),8(R2)                                                    
         BZ    SRERRC                                                           
         CLC   RESPLEN,=F'10'                                                   
         BH    SRERRC                                                           
         MVC   RESPLEN,8(R2)                                                    
         B     SR40                                                             
*                                                                               
SR13     DS    0H                                                               
         CLC   =C'CARDNCOL',12(R2)   COLUMN FOR CARD NUMBER                     
         BNE   SR14                                                             
         OC    8(4,R2),8(R2)                                                    
         BZ    SRERRC                                                           
         MVC   CARDCOL,8(R2)                                                    
         B     SR40                                                             
*                                                                               
SR14     DS    0H                                                               
         CLC   =C'CARDNLEN',12(R2)   LENGTH OF CARD NUMBER FIELD                
         BNE   SR15                                                             
         OC    8(4,R2),8(R2)                                                    
         BZ    SRERRC                                                           
         MVC   CARDLEN,8(R2)                                                    
         B     SR40                                                             
*                                                                               
SR15     DS    0H                                                               
         CLC   =C'PRINTWI',12(R2)   PRINT WORK INPUT TAPE RECS                  
         BNE   SR15B                                                            
         MVC   PRINTWI,22(R2)                                                   
         B     SR40                                                             
*                                                                               
SR15B    DS    0H                                                               
         CLC   =C'PRINTWO',12(R2)  PRINT WORK OUTPUT RECS                       
         BNE   SR16                                                             
         MVC   PRINTWO,22(R2)                                                   
         B     SR40                                                             
*                                                                               
SR16     DS    0H                                                               
         CLC   =C'PRINTI',12(R2)   PRINT INPUT RECORDS                          
         BNE   SR17                                                             
         MVC   PRINTI,22(R2)                                                    
         B     SR40                                                             
*                                                                               
SR17     DS    0H                                                               
         CLC   =C'PRINTE',12(R2)   PRINT ERROR RESPONDENTS                      
         BNE   SR18                                                             
         MVC   PRINTE,22(R2)                                                    
         B     SR40                                                             
*                                                                               
SR18     DS    0H                                                               
         CLC   =C'PRINTO',12(R2)   PRINT OUTPUT RECORDS                         
         BNE   SR18B                                                            
         MVC   PRINTO,22(R2)                                                    
         B     SR40                                                             
*                                                                               
SR18B    DS    0H                                                               
         CLC   =C'PRINTCCP',12(R2)  PRINT SPEC COUNTS                           
         BNE   SR18F                                                            
         MVC   PRINTCCP,22(R2)                                                  
         B     SR40                                                             
*                                                                               
SR18F    DS    0H                                                               
         CLC   =C'PRINTALL',12(R2)                                              
         BNE   SR20                                                             
         MVC   PRINTI,22(R2)                                                    
         MVC   PRINTE,22(R2)                                                    
         MVC   PRINTO,22(R2)                                                    
         MVC   PRINTWI,22(R2)                                                   
         MVC   PRINTWO,22(R2)                                                   
         MVC   PRINTCCP,22(R2)                                                  
         B     SR40                                                             
*                                                                               
SR20     DS    0H                                                               
         CLC   =C'CORE',12(R2)     LIMIT CORE FOR TESTING                       
         BNE   SR22                                                             
         MVC   CORELIM,8(R2)                                                    
         B     SR40                                                             
*                                                                               
SR22     DS    0H                                                               
         CLC   =C'RESPCOUNT',12(R2)   PRE-SET NUMBER OF RESPONDENTS             
         BNE   SR24                                                             
         MVC   NRESPS,8(R2)                                                     
         B     SR40                                                             
*                                                                               
SR24     DS    0H                                                               
         CLC   =C'INCARD',12(R2)   REPLICATION FACTOR FOR CARD INPUT            
         BNE   SR24D               (**TEST ONLY**)                              
         MVC   INCARD,8(R2)                                                     
         MVC   INCARDC,8(R2)                                                    
         B     SR40                                                             
*                                                                               
SR24D    DS    0H                                                               
         CLC   =C'INPUT',12(R2)    INPUT MODE                                   
         BNE   SR27                (**TEST ONLY**)                              
         MVC   INPUT,22(R2)                                                     
         B     SR40                                                             
*                                                                               
SR27     DS    0H                                                               
         CLC   =C'PAGES',12(R2)                                                 
         BNE   SR28                (**TEST ONLY**)                              
         L     RF,8(R2)                                                         
         CVD   RF,DUB                                                           
         ZAP   MAXPAGE,DUB                                                      
         B     SR40                                                             
*                                                                               
SR28     DS    0H                                                               
         CLC   =C'OPRECMAX',12(R2)                                              
         BNE   SR29                                                             
         MVC   OPRMAX,8(R2)                                                     
         B     SR40                                                             
*                                                                               
SR29     DS    0H                                                               
         CLC   =C'OPBLKSZE',12(R2)                                              
         BNE   SR30                                                             
         MVC   OPBLKSZE,8(R2)                                                   
         B     SR40                                                             
*                                                                               
SR30     DS    0H                                                               
         CLC   =C'SURVEY',12(R2)                                                
         BNE   SR31                                                             
         MVC   SURVEY,22(R2)                                                    
         B     SR40                                                             
*                                                                               
SR31     DS    0H                                                               
         CLC   =C'WAVE',12(R2)                                                  
         BNE   SR32                                                             
         MVI   WAVDATE,X'FF'                                                    
         CLC   =C'NONE',22(2)                                                   
         BE    SR40                                                             
         GOTO1 DATVAL,DMCB,22(R2),DUB                                           
         OC    DMCB(4),DMCB                                                     
         BZ    SRERRC                                                           
         GOTO1 DATCON,DMCB,DUB,(2,WAVDATE)                                      
         B     SR40                                                             
*                                                                               
SR32     DS    0H                                                               
         B     SRERRC              UNKNOWN SPEC                                 
*                                                                               
SR40     DS    0H                                                               
         LA    R2,32(R2)           NEXT SCANNER                                 
         B     SR3                                                              
*                                  CHECK ALL FIELDS FOR CONSISTENCY             
SR60     DS    0H                                                               
         GOTO1 PRINTER                                                          
         GOTO1 PRINTER                                                          
         SR    R2,R2               SO SRERR WILL NOT PRINT FROM CARD            
*                                                                               
         MVI   ERR,NCRDERR                                                      
         OC    NCARDS,NCARDS                                                    
         BNZ   *+8                                                              
         BAS   RE,SRERR                                                         
*                                                                               
         MVI   ERR,NCOLERR                                                      
         OC    NCOLS,NCOLS                                                      
         BNZ   *+8                                                              
         BAS   RE,SRERR                                                         
*                                                                               
         L     RF,NCOLS            NO. OF COLUMNS                               
         SLL   RF,1                X 2 FOR COLUMN BINARY                        
         ST    RF,CRECL            =ACTUAL 'CARD' SIZE                          
*                                                                               
         OC    IPBLKSZE,IPBLKSZE                                                
         BNZ   SR62                                                             
         L     RF,NCOLS                                                         
         SLL   RF,1                NCOLS X 2 FOR COL BINARY                     
         ST    RF,IPBLKSZE                                                      
         B     SR64                                                             
*                                                                               
SR62     DS    0H                                                               
         L     R1,IPBLKSZE                                                      
         SR    R0,R0                                                            
         L     RF,NCOLS                                                         
         SLL   RF,1                X 2 FOR COL BINARY                           
         DR    R0,RF                                                            
         LTR   R0,R0                                                            
         BZ    SR64                                                             
         MVI   ERR,BLKERR          BLKSIZE NOT MULTIPLE OF CARD SIZE            
         BAS   RE,SRERR                                                         
*                                                                               
SR64     DS    0H                                                               
         OC    RESPCOL,RESPCOL     IF RESP NO. USED                             
         BZ    SR68                                                             
         MVI   ERR,RSPLERR                                                      
         OC    RESPLEN,RESPLEN     LENGTH MUST BE GIVEN                         
         BNZ   *+8                                                              
         BAS   RE,SRERR                                                         
*                                                                               
         L     RF,RESPCOL                                                       
         A     RF,RESPLEN                                                       
         BCTR  RF,R0                                                            
         C     RF,NCOLS                                                         
         BNH   *+8                                                              
         BAS   RE,SRERR                                                         
*                                                                               
SR68     DS    0H                                                               
         MVI   ERR,CRDLERR                                                      
         OC    CARDCOL,CARDCOL     IF CARD NO. USED                             
         BZ    SR72                                                             
         OC    CARDLEN,CARDLEN     LENGTH MUST BE GIVEN                         
         BNZ   *+8                                                              
         BAS   RE,SRERR                                                         
         CLC   CARDLEN,=F'4'                                                    
         BNH   *+8                                                              
         BAS   RE,SRERR                                                         
*                                                                               
         L     RF,CARDCOL                                                       
         A     RF,CARDLEN                                                       
         BCTR  RF,R0                                                            
         C     RF,NCOLS                                                         
         BNH   *+8                                                              
         BAS   RE,SRERR                                                         
*                                                                               
*                                                                               
SR72     DS    0H                                                               
         L     RF,NCARDS                                                        
         M     RE,NCOLS                                                         
         SLL   RF,1                X 2 FOR COLUMN BINARY                        
         C     RF,=F'65535'                                                     
         BNH   SR73                                                             
         MVI   ERR,CXCERR                                                       
         BAS   RE,SRERR                                                         
SR73     DS    0H                                                               
         ST    RF,LREC             LENGTH OF RESPONDENT SET                     
*                                                                               
         CLI   SURVEY,C' '         TEST HAVE FILE CODE                          
         BH    SR74B                                                            
         MVI   ERR,SURVERR                                                      
         BAS   RE,SRERR                                                         
*                                                                               
SR74B    DS    0H                                                               
         CLI   WAVDATE,0           TEST HAVE WAVE DATE                          
         BH    SR74D                                                            
         MVI   ERR,WAVDTERR                                                     
         BAS   RE,SRERR                                                         
*                                                                               
SR74D    DS    0H                                                               
         CLI   WAVDATE,X'FF'       SET NONE TO ZERO                             
         BNE   *+10                                                             
         XC    WAVDATE,WAVDATE                                                  
*                                                                               
         OC    NRESPS,NRESPS       MUST HAVE RESPONDENT COUNT                   
         BNZ   SR75                                                             
         MVI   ERR,NRSPCERR                                                     
         BAS   RE,SRERR                                                         
*                                                                               
SR75     DS    0H                                                               
SRX      DS    0H                                                               
         XIT1                                                                   
SRERR    NTR1                                                                   
         GOTO1 AGETERR,DMCB,(ERR,P)                                             
         LA    R6,P+2                                                           
         A     R6,DMCB+4                                                        
         LTR   R2,R2               TEST HAVE SCANNER FIELD                      
         BZ    *+10                                                             
         MVC   0(10,R6),12(R2)                                                  
         GOTO1 PRINTER                                                          
         XIT1                                                                   
*                                                                               
SRERRC   DS    0H                                                               
         BAS   RE,SRERR                                                         
         B     SR40                                                             
         SPACE 3                                                                
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                  BUILD CONDITION TABLE                        
         SPACE 2                                                                
BCT      CSECT                                                                  
         NMOD1 0,BCT                                                            
*                                                                               
         GOTO1 PRINTER                                                          
         MVC   P(32),=C'CARD/COLUMN/PUNCH SPECIFICATIONS'                       
         GOTO1 PRINTER                                                          
         MVC   P(32),DASHES                                                     
         GOTO1 PRINTER                                                          
*                                                                               
         MVI   ERR,SPECERR                                                      
         L     R4,ACTAB                                                         
         MVC   0(8,R4),=C'*CONTAB*'                                             
         LA    R4,8(R4)                                                         
         ST    R4,ACTAB                                                         
         USING CTABD,R4                                                         
*                                                                               
BCT2     DS    0H                                                               
         GOTO1 CARDS,DMCB,CARD,=C'RE00'                                         
         CLC   =C'/*',CARD                                                      
         BE    BCT60                                                            
         MVC   P(80),CARD                                                       
         GOTO1 PRINTER                                                          
         CLC   CARD,SPACES                                                      
         BE    BCT2                                                             
         CLI   CARD,C'*'           COMMENT CARD                                 
         BE    BCT2                                                             
*                                  'COMPRESS' CARD                              
         MVC   X(132),SPACES                                                    
         LA    R3,CARD+79          FIND END                                     
         CLI   0(R3),C' '                                                       
         BH    *+8                                                              
         BCT   R3,*-8                                                           
         ST    R3,FULL                                                          
*                                                                               
         LA    R3,CARD                                                          
         LA    R5,X+1                                                           
         MVI   X,C','              START WITH A DUMMY DELIMITER                 
*                                                                               
BCT2D4   DS    0H                                                               
         C     R3,FULL             TEST AT END                                  
         BH    BCT2D7                                                           
         CLI   0(R3),C','                                                       
         BE    BCT2D6                                                           
         CLI   0(R3),C' '                                                       
         BE    BCT2D6                                                           
*                                                                               
         MVC   0(1,R5),0(R3)       GOOD CHARACTER                               
*                                                                               
BCT2D5   DS    0H                                                               
         LA    R5,1(R5)                                                         
         LA    R3,1(R3)                                                         
         B     BCT2D4                                                           
*                                                                               
BCT2D6   DS    0H                  COMMA OR BLANK                               
         BCTR  R5,R0               SEE IF HAVE ALREADY                          
         CLI   0(R5),C','          SET DELIMITER                                
         BE    *+12                                                             
         MVI   1(R5),C','                                                       
         LA    R5,1(R5)                                                         
         B     BCT2D5                                                           
*                                                                               
BCT2D7   DS    0H                                                               
         LA    RE,CEDTWRK                                                       
         LA    RF,L'CEDTWRK                                                     
         XCEF                                                                   
*                                                                               
         XC    DMCB+8(4),DMCB+8                                                 
         CLC   =C'ACCESS',X+1          ACCESS CARD USES NORMAL SCANNER          
         BE    *+10                    ELSE ADJUST DELIMITERS                   
         MVC   DMCB+8(4),=X'6B7E6BFF'  ,=,FF                                    
*                                                                               
         GOTO1 SCANNER,DMCB,(C'C',X+1),CEDTWRK                                  
*                                                                               
         LA    R2,CEDTWRK                                                       
BCT3     DS    0H                                                               
         CLI   0(R2),0             NO FIELDS                                    
         BE    BCT2                NEXT CARD                                    
*                                                                               
         CLC   =C'ACCESS',12(R2)   ACCESS LIMIT                                 
         BNE   BCT12                                                            
         OC    8(4,R2),8(R2)                                                    
         BZ    BCTERRC                                                          
         CLC   8(4,R2),=F'255'                                                  
         BH    BCTERRC                                                          
         MVC   ACCESS,8+3(R2)      ACCESS  LIMIT CODE                           
         B     BCT2                NEXT CARD                                    
*                                                                               
BCT12    DS    0H                  FIRST POSITIONAL FIELD IS CARD NUM           
         CLI   12(R2),C'='         TEST REPEAT                                  
         BE    BCT12F                                                           
         CLI   12(R2),C'+'         TEST RELATIVE DISPLACEMENT                   
         BE    BCT12B                                                           
         CLI   12(R2),C'-'                                                      
         BNE   BCT12D                                                           
*                                                                               
BCT12B   DS    0H                                                               
         ZIC   R3,0(R2)                                                         
         GOTO1 NUMVAL,DMCB,12(R2),(R3)                                          
         CLI   DMCB,0                                                           
         BNE   BCTERRC                                                          
         L     R0,DMCB+4           VALUE                                        
         A     R0,CRDNO            ADD TO CURRENT CARD NO                       
         ST    R0,CRDNO                                                         
         B     BCT12F                                                           
*                                                                               
BCT12D   DS    0H                                                               
         MVC   CRDNO,4(R2)                                                      
*                                                                               
BCT12F   DS    0H                                                               
         OC    CRDNO,CRDNO         NUMERIC VALUE                                
         BZ    BCTERRC                                                          
         CLC   CRDNO,NCARDS                                                     
         BH    BCTERRC                                                          
         LA    R2,32(R2)           NEXT SCANNER FIELD                           
*                                                                               
BCT13    DS    0H                  COLUMN NUMBER                                
         CLI   12(R2),C'='         TEST REPEAT                                  
         BE    BCT13F                                                           
         CLI   12(R2),C'+'         TEST RELATIVE DISPLACEMENT                   
         BE    BCT13B                                                           
         CLI   12(R2),C'-'                                                      
         BNE   BCT13D                                                           
*                                                                               
BCT13B   DS    0H                                                               
         ZIC   R3,0(R2)                                                         
         GOTO1 NUMVAL,DMCB,12(R2),(R3)                                          
         CLI   DMCB,0                                                           
         BNE   BCTERRC                                                          
         L     R0,DMCB+4           VALUE                                        
         A     R0,COLNO            ADD TO CURRENT COLUMN NO                     
         ST    R0,COLNO                                                         
         B     BCT13F                                                           
*                                                                               
BCT13D   DS    0H                                                               
         MVC   COLNO,4(R2)                                                      
*                                                                               
BCT13F   DS    0H                                                               
         OC    COLNO,COLNO         NUMERIC VALUE                                
         BZ    BCTERRC                                                          
         CLC   COLNO,NCOLS                                                      
         BH    BCTERRC                                                          
         LA    R2,32(R2)           NEXT SCANNER FIELD                           
*                                                                               
BCT14    DS    0H                                                               
         MVC   SPECTYP,12(R2)      SPC TYPE IS NEXT                             
         CLI   SPECTYP,C'P'        P=PUNCH                                      
         BE    BCT15                                                            
         CLI   SPECTYP,C'S'        S=SIGNED NUMERIC FIELD                       
         BE    BCT14A                                                           
         CLI   SPECTYP,C'N'        N= NUMERIC FIELD                             
         BNE   BCTERRC                                                          
*                                                                               
BCT14A   DS    0H                                                               
         LA    R2,32(R2)           NEXT SCANNER FIELD                           
         OC    4(4,R2),4(R2)       VALUE                                        
         BZ    BCTERRC                                                          
         L     R0,4(R2)                                                         
         STC   R0,CTNLEN                                                        
         CLI   SPECTYP,C'S'                                                     
         BNE   *+8                                                              
         OI    CTNLEN,X'80'        SET IS A SIGNED FIELD                        
*                                                                               
         A     R0,COLNO                                                         
         BCTR  R0,R0                                                            
         C     R0,NCOLS                                                         
         BNH   BCT14B                                                           
         MVI   ERR,COLERR          PAST END OF CARD                             
         B     BCTERRC                                                          
BCT14B   DS    0H                                                               
*                                                                               
*                                  SET BINARY LENGTH                            
*                                  BASED ON FIELD LENGTH                        
         MVC   BYTE,CTNLEN                                                      
         NI    BYTE,X'0F'          STRIP HOBS                                   
         LA    R1,1                                                             
         CLI   BYTE,2                                                           
         BNH   BCT14D                                                           
         LA    R1,2                                                             
         CLI   BYTE,4                                                           
         BNH   BCT14D                                                           
         LA    R1,3                                                             
         CLI   BYTE,7                                                           
         BNH   BCT14D                                                           
         LA    R1,4                                                             
*                                                                               
BCT14D   DS    0H                                                               
         STC   R1,CTTYP            SET TYPE = BINARY LENGTH                     
         SLL   R1,3                                                             
         ST    R1,CFACT            SET FACTOR FOR CORE NEED                     
         LA    R3,1                FOR BCT WHICH CONTROLS BCT15A LOOP           
         B     BCT30                                                            
*                                                                               
BCT15    DS    0H                  PUNCH SPEC-STRING OF PUNCHES                 
         LA    R2,32(R2)           NEXT SCANNER FIELD                           
         CLI   0(R2),0             MUST BE PRESENT                              
         BE    BCTERRC                                                          
*                                                                               
         CLI   12(R2),C'='         TEST REPEAT                                  
         BE    BCT1501                                                          
         MVC   SAVPCH,12(R2)                                                    
         MVC   SAVNPCH,0(R2)                                                    
*                                                                               
BCT1501  DS    0H                                                               
         CLI   SAVNPCH,0           NO SAVED PUNCH STRING                        
         BE    BCTERRC                                                          
         ZIC   R3,SAVNPCH          FOR BCT                                      
         LA    R5,SAVPCH                                                        
*                                  CONVERT TO COLUMN BINARY MASK                
BCT15A   DS    0H                                                               
         L     R1,AMASKTAB                                                      
BCT15B   DS    0H                                                               
         CLI   0(RF),X'FF'         EOL                                          
         BE    BCTERRC                                                          
         CLC   0(1,R5),0(R1)                                                    
         BE    BCT15D                                                           
         LA    R1,2(R1)                                                         
         B     BCT15B                                                           
*                                                                               
BCT15D   DS    0H                                                               
         MVC   CTMASK,1(R1)        SET IN TAB                                   
         MVI   CTTYP,0             PUNCH CONDITION                              
         MVI   CFACT+3,1           FACTOR FOR CORE NEEDS                        
*                                                                               
BCT30    DS    0H                                                               
         L     RF,CRDNO            CARD NO                                      
         BCTR  RF,R0               MINUS 1                                      
         M     RE,NCOLS            X NCOLS                                      
         A     RF,COLNO            + COLUMN NO                                  
         BCTR  RF,R0               MINUS 1                                      
         SLL   RF,1                X 2 FOR COLUMN BINARY                        
         STCM  RF,3,CTDISP         =DISPLACEMENT INTO RESP                      
         MVC   CTACC,ACCESS        SET ACCESS LIMIT CODE                        
*                                                                               
         L     RF,CNEED            BUMP CORE NEED                               
         A     RF,CFACT                                                         
         ST    RF,CNEED                                                         
*                                  BUMP CONDITION COUNT BY TYPE                 
         ZIC   RF,CTTYP                                                         
         SLL   RF,2                                                             
         L     RE,NCONDS(RF)                                                    
         LA    RE,1(RE)                                                         
         ST    RE,NCONDS(RF)                                                    
*                                                                               
         L     RE,NCONDT           TOTAL CONDITIONS                             
         LA    RE,1(RE)                                                         
         ST    RE,NCONDT                                                        
*                                                                               
         LA    R4,CTABL(R4)        NEXT CONDITION                               
*                                                                               
BCT32    DS    0H                                                               
         LA    R5,1(R5)             NEXT PUNCH SPEC                             
         BCT   R3,BCT15A                                                        
*                                                                               
         LA    R2,32(R2)           ANY MORE FIELDS                              
         CLI   0(R2),0             NO- OK                                       
         BE    BCT2                NEXT CARD                                    
         CLI   12(R2),C'*'         ELSE MUST BE COMMENT                         
         BNE   BCTERRC                                                          
         B     BCT2                NEXT CARD                                    
         DROP  R4                                                               
         SPACE 3                                                                
BCT60    DS    0H                                                               
         GOTO1 PRINTER                                                          
*                                  SORT CONDITON TABLE                          
         CLC   NCONDT,=F'1'                                                     
         BNH   BCT60F                                                           
         L     R5,NCONDT                                                        
         ST    R5,DMCB+4                                                        
         LA    R6,CTABL                                                         
         GOTO1 XSORT,DMCB,ACTAB,,(R6),(R6),0                                    
*                                  CHECK FOR DUPES                              
         L     R5,ACTAB                                                         
         USING CTABD,R5                                                         
         L     R7,NCONDT                                                        
         BCTR  R7,R0                                                            
*                                                                               
BCT60B   DS    0H                                                               
         CLC   0(CTABL,R5),CTABL(R5)           TEST DUPES                       
         BE    BCT60D                          YES- ERROR                       
         CLI   CTTYP,0                         FOR PUNCH SPECS                  
         BE    BCT60C                          DONE                             
         MVC   WORK(CTABL*2),0(R5)             SET PAIR IN WORK                 
         NI    WORK+CTNLEN-CTABD,X'0F'         STRIP LEN HOB IN 1ST             
         NI    WORK+CTABL+CTNLEN-CTABD,X'0F'   AND 2ND                          
         CLC   WORK(CTABL),WORK+CTABL          NOW COMPARE                      
         BE    BCT60D                                                           
*                                                                               
BCT60C   DS    0H                                                               
         LA    R5,CTABL(R5)                                                     
         BCT   R7,BCT60B                                                        
         B     BCT60F                                                           
*                                                                               
BCT60D   DS    0H                                                               
         SR    R2,R2                                                            
         MVI   ERR,CTDUPERR                                                     
         BAS   RE,BCTERR                                                        
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,CTDISP         DISPLACEMENT                                 
         SRL   RF,1                                                             
         LA    RF,1(RF)                                                         
         A     RF,NCOLS                                                         
         SR    RE,RE                                                            
         D     RE,NCOLS            RF = CARD NO, RE = COLUMN                    
*                                  NOTE- R6 POINTS AFTER ERR MSG                
         LA    R6,P+2              WHERE TO PUT MXG EXTENSION                   
         A     R6,DMCB+4           SET BY GETERR                                
         MVC   0(18,R6),=C'CARDNNN COLNNN(NN)'                                  
         EDIT  (RF),(3,4(R6))      CARD NO                                      
         EDIT  (RE),(3,11(R6))     COLUMN NO                                    
         CLI   CTTYP,0             TEST PUNCH                                   
         BE    BCT60D2             YES                                          
         MVC   BYTE,CTNLEN         NO- SET FIELD LENGTH                         
         NI    BYTE,X'0F'          STRIP HOBS                                   
         EDIT  (B1,BYTE),(2,15(R6)),FILL=0                                      
         B     BCT60E                                                           
*                                                                               
BCT60D2  DS    0H                                                               
         MVC   14(6,R6),=C' PUNCH'                                              
         L     RF,AMASKTAB                                                      
         CLC   CTMASK,1(RF)                                                     
         BE    *+12                                                             
         LA    RF,2(RF)                                                         
         B     *-14                                                             
*                                                                               
         MVC   21(1,R6),0(RF)                                                   
*                                                                               
BCT60E   DS    0H                                                               
         GOTO1 PRINTER                                                          
         B     BCT60C                                                           
         DROP  R5                                                               
*                                                                               
BCT60F   DS    0H                                                               
         MVI   0(R4),X'FF'         END OF CONDITION TABLE                       
         LA    R4,8(R4)            PUT ON DOUBLE WORD BOUNDARY                  
*                                  BUMP BY 8 (NOT 7) FOR EOF FF                 
         SRL   R4,3                                                             
         SLL   R4,3                                                             
         MVC   0(8,R4),=C'**RESP**'                                             
         LA    R4,8(R4)                                                         
         ST    R4,AREC             A(DATA RECORD SET)                           
*                                                                               
         LR    RF,R4                                                            
         A     RF,LREC                                                          
         LA    RF,7(RF)            PUT ON DOUBLE WORD BOUNDARY                  
         SRL   RF,3                                                             
         SLL   RF,3                                                             
         MVC   0(8,RF),=C'*INPIOW*'                                             
         LA    RF,8(RF)                                                         
         ST    RF,ARECWRK          AREA FOR RECORD READS                        
         L     RF,NCOLS                                                         
         SLL   RF,1                X 2 FOR COLUMN BINARY                        
         A     RF,ARECWRK                                                       
*                                                                               
         LA    RF,7(RF)            PUT ON DOUBLE WORD BOUNDARY                  
         SRL   RF,3                                                             
         SLL   RF,3                                                             
         MVC   0(8,RF),=C'**WTREC*'                                             
         LA    RF,8(RF)                                                         
         ST    RF,AWTREC           WORK RECORD AREA                             
*                                                                               
         AH    RF,=H'4096'         PLUS WORK RECORD MAX LENGTH                  
         LA    RF,7(RF)            PUT ON DOUBLE WORD BOUNDARY                  
         SRL   RF,3                                                             
         SLL   RF,3                                                             
         MVC   0(8,RF),=C'*CONWTB*'                                             
         LA    RF,8(RF)                                                         
         ST    RF,ADTAB            ADDRESS FOR CONDITION WORK AREA              
*                                                                               
         LR    R4,RF                                                            
         L     RF,ACTABX                                                        
         SR    RF,R4                                                            
         OC    CORELIM,CORELIM     TEST CORESIZE SET FOR TEST                   
         BZ    BCT62B                                                           
         C     RF,CORELIM                                                       
         BNH   BCT62B                                                           
         L     RF,CORELIM                                                       
*                                                                               
BCT62B   DS    0H                                                               
         ST    RF,CWKSIZE          CORE AVAILABLE FOR STRINGS                   
         SLL   RF,3                X 8 BEFORE DIVISION                          
         SR    RE,RE                                                            
         L     R1,CNEED            CNEED IS 8 X (BITS NOT BYTES)                
         LA    R1,2(R1)            BUMP BY 2 (ROOM FOR WTREC AREA)              
         DR    RE,R1                                                            
         ST    RF,GULPSZE          SIZE OF GULP - RESPONDENTS THAT              
*                                  CAN BE PROCESSED IN ONE SHOT                 
*                                  ADJUST GULPSZE                               
         L     RF,NRESPS                                                        
         LA    RF,7(RF)            FORCE UP TO MULTIPE OF 8                     
         SRL   RF,3                                                             
         SLL   RF,3                                                             
*                                                                               
         C     RF,GULPSZE          IS IT LOWER THAN CALCULATED SIZE             
         BH    *+12                                                             
         ST    RF,GULPSZE          YES-USE KNOWN SIZE                           
         B     BCT63                                                            
*                                  IF HIGHER ADJUST GULPSZE FOR                 
*                                  EVEN SIZED GULPS                             
         SR    R0,R0                                                            
         LR    R1,RF                                                            
         D     R0,GULPSZE                                                       
         LTR   R0,R0                                                            
         BZ    BCT63               ALREADY EVEN                                 
         LA    RE,1(R1)                                                         
         LR    R1,RE                                                            
         SLL   R1,3                                                             
         AR    R1,RF                                                            
*                                                                               
         SR    R0,R0                                                            
         DR    R0,RE                                                            
         ST    R1,GULPSZE          EVENED UP GULPSZE                            
*                                                                               
BCT63    DS    0H                                                               
         CLC   GULPSZE,MAXGULP  TEST VS MAXIMUM                                 
         BNH   *+10                                                             
         MVC   GULPSZE,MAXGULP                                                  
         L     RF,GULPSZE                                                       
         SRL   RF,3                ENSURE DIVISIBILITY BY 8                     
         SLL   RF,3                                                             
         ST    RF,GULPSZE                                                       
*                                                                               
         LTR   RF,RF                                                            
         BP    BCT62D                                                           
         MVI   ERR,CORERR                                                       
         BAS   RE,BCTERR                                                        
         GOTO1 PRINTER                                                          
         B     BCTX                                                             
BCT62D   DS    0H                                                               
*                                  SET CONDITION AREA WORK LENGTHS              
         L     RF,GULPSZE                                                       
         SRL   RF,3                1 BYTE FOR 8 RESPS                           
         ST    RF,CONDLTAB+0       FOR COND TYPE 0 (PUNCH)                      
         L     RF,GULPSZE          1 BYTE PER RESP                              
         ST    RF,CONDLTAB+4       FOR TYPE 1                                   
         A     RF,GULPSZE          2 PER                                        
         ST    RF,CONDLTAB+8       FOR TYPE 2                                   
         A     RF,GULPSZE          3 PER                                        
         ST    RF,CONDLTAB+12      FOR TYPE 3                                   
         A     RF,GULPSZE          4 PER                                        
         ST    RF,CONDLTAB+16      FOR TYPE 4                                   
*                                                                               
         MVC   CONDSZE,CONDLTAB+0  REPEAT FOR TYPE 0                            
         L     RF,CONDSZE                                                       
         CH    RF,=H'4'            MUST BE AT LEAST 4                           
         BNL   *+8                 FOR WORK REC                                 
         LH    RF,=H'4'                                                         
         LA    RF,L'WTKEY(RF)                                                   
         ST    RF,LWTREC           LENGTH OF WORK RECORD                        
*                                                                               
         B     BCTX                                                             
*                                                                               
BCTX     DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
BCTERR   NTR1                                                                   
         GOTO1 AGETERR,DMCB,(ERR,P)                                             
         LA    R6,P+2                                                           
         A     R6,DMCB+4                                                        
         LTR   R2,R2               TEST HAVE SCANNER FIELD                      
         BZ    *+10                                                             
         MVC   0(10,R6),12(R2)                                                  
         XIT1                                                                   
BCTERRC  DS    0H                                                               
         BAS   RE,BCTERR                                                        
         GOTO1 PRINTER                                                          
         B     BCT2                NEXT CARD                                    
*                                                                               
         SPACE 3                                                                
         LTORG                                                                  
         SPACE 3                                                                
         EJECT                                                                  
*                             GET RESPONDENT AND CHECK VALIDITY                 
         SPACE 2                                                                
GETRESP  CSECT                                                                  
         NMOD1 0,GETRESP                                                        
         CLI   INPSW,0        TEST FIRST TIME                                   
         BNE   GR12                                                             
         MVI   INPSW,1                                                          
*                             DO INITIAL READ                                   
         XC    CRDCNT,CRDCNT                                                    
         BAS   RE,GRGET                                                         
         B     GR13B                                                            
*                                                                               
GR12     DS    0H                                                               
         ICM   RF,15,INCARDC       FOR CARD TEST RUN CHECK REPLICATION          
         BZ    GR13                ZERO MEANS NO REPLICATION                    
         BCTR  RF,R0                                                            
         ST    RF,INCARDC                                                       
         LTR   RF,RF                                                            
         BP    GR15                RETURN WITH SAME RESPONDENT                  
         MVC   INCARDC,INCARD      RESET REPLICATION FACTOR                     
*                                                                               
GR13     DS    0H                                                               
         MVI   ERR,0                                                            
GR13B    DS    0H                                                               
         MVC   LASTRNO,THISRNO                                                  
         CLI   LASTRNO,X'FF'                                                    
         BE    GRX                                                              
*                                                                               
         L     RE,AREC             CLEAR RESPONDENT AREA                        
         L     RF,LREC                                                          
         XCEF                                                                   
*                                                                               
GR14     DS    0H                                                               
         L     R2,ARECWRK          THIS 'CARD'                                  
         L     R3,AREC                                                          
         A     R3,CDISP            DISP FOR THIS CARD                           
*                                  TEST FOR DUPE CARD                           
         ICM   RF,15,RESPCOL                                                    
         BZ    GR14B               NO RESP NO                                   
         BCTR  RF,R0                                                            
         SLL   RF,1                X 2 FOR COL BIN                              
         AR    RF,R3                                                            
         OC    0(2,RF),0(RF)       TEST ALREADY THERE                           
         BZ    GR14B                                                            
         MVI   ERR,DUPCERR                                                      
         BAS   RE,GRERR                                                         
         B     GR14D                                                            
*                                                                               
GR14B    DS    0H                                                               
         L     R1,NCOLS                                                         
         SLL   R1,1                X 2 FOR COL BIN                              
         MOVE  ((R3),(R1)),(R2)                                                 
*                                                                               
GR14D    DS    0H                                                               
         BAS   RE,GRGET                                                         
         CLC   THISRNO,LASTRNO                                                  
         BE    GR14                SAME RESP                                    
*                                                                               
GR15     DS    0H                                                               
         L     RF,RESPCNT          BUMP RESP COUNT                              
         LA    RF,1(RF)                                                         
         ST    RF,RESPCNT                                                       
         L     RF,RGCNT            BUMP RESP/GULP COUNT                         
         LA    RF,1(RF)                                                         
         ST    RF,RGCNT                                                         
         MVC   CRDCNT,=F'1'        RESET CARDS/RESP COUNT                       
*                                                                               
         CLC   RESPCNT,NRESPS      IS IT EXCEEDED                               
         BNH   GR16                                                             
         MVI   ERR,RCNTERR                                                      
         MVI   PRINTE,C'Y'         SET TO PRINT ERRORS                          
         BAS   RE,GRERR                                                         
         MVI   INPSW,X'FF'         SET EOF                                      
         MVI   THISRNO,X'FF'                                                    
         MVC   LASTRNO,THISRNO                                                  
         B     GRX                                                              
*                                                                               
*                             SET WORK AREA DISPS FOR THIS RESP                 
GR16     DS    0H                                                               
         BCTR  RF,R0                                                            
         SRL   RF,3           1 BYTE FOR 8 RESPS                                
         ST    RF,RESPDPTB+0  FOR COND TYPE 0                                   
         L     RF,RGCNT                                                         
         BCTR  RF,R0                                                            
         LR    RE,RF                 1 BYTE PER RESP                            
         ST    RE,RESPDPTB+4      FOR TYPE 1                                    
         AR    RE,RF              2 PER                                         
         ST    RE,RESPDPTB+8      FOR TYPE 2                                    
         AR    RE,RF              3 PER                                         
         ST    RE,RESPDPTB+12     FOR TYPE 3                                    
         AR    RE,RF              4 PER                                         
         ST    RE,RESPDPTB+16     FOR TYPE 4                                    
*                                                                               
         L     R0,RGCNT                                                         
         SR    R1,R1                                                            
         SRDL  R0,3                                                             
         SRL   R1,29               R1 = COUNT MOD 8                             
         LA    R1,RBTAB(R1)                                                     
         MVC   RESPBMSK,0(R1)      BIT MASK FOR THIS RESP                       
*                                                                               
GRX      DS    0H                                                               
         XIT1                                                                   
*                                                                               
RBTAB    DC    X'0180402010080402'   REMAINDER 0 - 8                            
         EJECT                                                                  
GRGET    NTR1                                                                   
         SPACE 2                                                                
GRG2     DS    0H                                                               
         CLI   INPSW,X'FF'         TEST HAVE EOF                                
         BE    GRGX                                                             
         CLI   INPUT,C'C'          TEST CARD INPUT                              
         BNE   GRG2B                                                            
         BAS   RE,GRCARD                                                        
         CLI   INPSW,X'FF'         TEST EOF                                     
         BE    GRGX                                                             
         B     GRG2D                                                            
*                                                                               
GRG2B    DS    0H                                                               
         L     R1,AQVIN                                                         
         L     R0,ARECWRK                                                       
         GET   (1),(0)                                                          
*                                                                               
GRG2D    DS    0H                                                               
         L     RF,RECCNT           BUMP RECORD COUNT                            
         LA    RF,1(RF)                                                         
         ST    RF,RECCNT                                                        
*                                                                               
         L     RF,CRDCNT           BUMP CARD COUNT WITHIN RESP                  
         LA    RF,1(RF)                                                         
         ST    RF,CRDCNT                                                        
*                                                                               
*                                                                               
         CLI   PRINTI,C'Y'                                                      
         BNE   GRG3                                                             
         L     R2,NCOLS                                                         
         SLL   R2,1                                                             
         GOTO1 ADMPREC,DMCB,ARECWRK,(R2),=CL6'INPUT'                            
*                                                                               
GRG3     DS    0H                                                               
         ICM   R2,15,RESPCOL       TEST HAVE RESP NO                            
         BNZ   GRG3D                                                            
*                                  NO RESP NO                                   
         CLC   CRDCNT,NCARDS       TEST END OF RESP SET                         
         BNH   GRG4                                                             
*                                                                               
         MVC   THISRNO,LASTRNO     YES FORCE 'RESPNO' CHANGE                    
         XI    THISRNO+1,X'FF'                                                  
         B     GRGX                                                             
*                                                                               
GRG3D    DS    0H                                                               
         MVC   THISRNO,SPACES                                                   
         BCTR  R2,R0                                                            
         SLL   R2,1                                                             
         A     R2,ARECWRK                                                       
         L     R3,RESPLEN                                                       
         GOTO1 ACVEBC,DMCB,((R3),(R2)),THISRNO                                  
*                                                                               
*                                                                               
GRG4     DS    0H                                                               
         XC    CDISP,CDISP                                                      
         ICM   R2,15,CARDCOL       IF NO CARD NUMBER                            
         BNZ   GRG4D                                                            
*                                                                               
         L     RF,CRDCNT         USE SEQ OF CARD READ AS CARD NO                
         C     RF,NCARDS         MUST NOT EXCEED EXPECTED CARDS/RESP            
         BNH   GRG14                                                            
         B     GRG20                                                            
*                                                                               
GRG4D    DS    0H                                                               
         BCTR  R2,R0                                                            
         SLL   R2,1                                                             
         A     R2,ARECWRK                                                       
         L     R3,CARDLEN                                                       
         GOTO1 ACVEBC,DMCB,((R3),(R2)),THISCNO                                  
*                                                                               
         CH    R3,=H'1'            LENGTH OF NUMBER                             
         BH    GRG10                                                            
*                                                                               
         LA    R4,CNUMLST          IF 1 LOOKUP VALUE IN LIST                    
         LA    R0,L'CNUMLST                                                     
*                                                                               
GRG6     DS    0H                                                               
         CLC   THISCNO(1),0(R4)                                                 
         BE    GRG7                                                             
         LA    R4,1(R4)                                                         
         BCT   R0,GRG6                                                          
         B     GRG20               ERROR                                        
GRG7     DS    0H                                                               
         LA    RF,L'CNUMLST+1                                                   
         SR    RF,R0               RF HAS ACTUAL CARD NUM                       
         B     GRG14                                                            
*                             MULTIPLE COLUMN CARD NUMBER                       
GRG10    DS    0H                                                               
         GOTO1 NUMVAL,DMCB,THISCNO,(R3)                                         
         CLI   DMCB,0                                                           
         BNE   GRG20               ERROR                                        
         L     RF,DMCB+4           CARD NUM                                     
*                                                                               
GRG14    DS    0H                                                               
         LTR   RF,RF                                                            
         BNP   GRG20                                                            
         C     RF,NCARDS                                                        
         BH    GRG20                                                            
*                                                                               
         BCTR  RF,R0               CARD NO - 1                                  
         L     RE,NCOLS                                                         
         SLL   RE,1                                                             
         MR    RE,RE                                                            
         ST    RF,CDISP                                                         
         MVI   ERR,0                                                            
GRGX     DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
*                                                                               
GRG20    DS    0H                                                               
         MVI   ERR,CNUMERR    INVALID CARD NUMBER                               
         BAS   RE,GRERR                                                         
         B     GRG2           BYPASS CARD                                       
         SPACE 3                                                                
GRERR    NTR1                                                                   
         L     RF,IERRCNT          BUMP ERROR COUNTER                           
         LA    RF,1(RF)                                                         
         ST    RF,IERRCNT                                                       
*                                                                               
         CLI   PRINTE,C'Y'                                                      
         BNE   GRERRX                                                           
         GOTO1 AGETERR,DMCB,(ERR,P)                                             
         LA    R6,P+2                                                           
         A     R6,DMCB+4                                                        
         MVC   0(10,R6),THISRNO                                                 
         MVC   11(4,R6),THISCNO                                                 
         GOTO1 PRINTER                                                          
GRERRX   DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
INEOT    DS    0H                                                               
         CLOSE  (QVIN,)                                                         
         MVI   THISRNO,X'FF'                                                    
         MVI   INPSW,X'FF'                                                      
         B     GRGX                                                             
         EJECT                                                                  
*                                  CARD INPUT ROUTINE                           
GRCARD   NTR1                                                                   
         SPACE 2                                                                
         GOTO1 CARDS,DMCB,CARD,=C'RE00'                                         
         CLC   =C'/*',CARD                                                      
         BNE   GRC2                                                             
         MVI   INPSW,X'FF'                                                      
         MVI   THISRNO,X'FF'                                                    
         B     GRCX                                                             
*                                  EBCDIC TO COL BINARY                         
GRC2     DS    0H                                                               
         MVC   P(6),=C'**CARD'                                                  
         MVC   P+10(80),CARD                                                    
         GOTO1 PRINTER                                                          
         LA    R3,CARD                                                          
         L     R4,ARECWRK                                                       
         LA    R0,80                                                            
*                                                                               
GRC4     DS    0H                                                               
         LA    R6,GRCTAB                                                        
GRC6     DS    0H                                                               
         CLC   0(1,R3),0(R6)                                                    
         BE    GRC7                                                             
         LA    R6,3(R6)                                                         
         CLI   0(R6),X'FF'         UNTRANSLATED                                 
         BNE   GRC6                                                             
*                                                                               
GRC7     DS    0H                                                               
         MVC   0(2,R4),1(R6)                                                    
         LA    R3,1(R3)                                                         
         LA    R4,2(R4)                                                         
         BCT   R0,GRC4                                                          
*                                                                               
GRCX     DS    0H                                                               
         XIT1                                                                   
*                                  BRIEF EBCDIC TO COLBIN TABLE                 
GRCTAB   DS    0X                                                               
         DC    C'&&',X'2000'                                                    
         DC    C'-',X'1000'                                                     
         DC    C'0',X'0800'                                                     
         DC    C'1',X'0400'                                                     
         DC    C'2',X'0200'                                                     
         DC    C'3',X'0100'                                                     
         DC    C'4',X'0020'                                                     
         DC    C'5',X'0010'                                                     
         DC    C'6',X'0008'                                                     
         DC    C'7',X'0004'                                                     
         DC    C'8',X'0002'                                                     
         DC    C'9',X'0001'                                                     
         DC    X'FF',X'0000'                                                    
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                  CONVERT 360 COLUMN BINARY TO EBCDIC          
*                                  PARAM1 =A(INPUT) - BYTE 0 = LENGTH           
*                                  PARAM2 =A(OUTPUT)                            
         SPACE 2                                                                
CVEBC    CSECT                                                                  
         NMOD1 0,CVEBC                                                          
         SPACE 2                                                                
         LM    R2,R3,0(R1)         R2 = A(INPUT)                                
*                                  R3 = A(OUTPUT)                               
         SR    R0,R0                                                            
         ICM   R0,1,0(R1)          R0 = LENGTH OF INPUT (POSITIONS)             
         BZ    CVEX                                                             
*                                                                               
*                                                                               
CVE4     DS    0H                                                               
         ZIC   R4,0(R2)            6 BITS FROM BYTE 1                           
         SLL   R4,6                                                             
         ZIC   R5,1(R2)            6 BITS FROM BYTE 2                           
         OR    R5,R4               R5 = 12 BIT RESULT                           
*                                                                               
         A     R5,ACBTBL           DISPLACE INTO TRANSLATE TABLE                
         MVC   0(1,R3),0(R5)       SET IN OUTPUT                                
*                                                                               
         LA    R2,2(R2)            NEXT POSITION                                
         LA    R3,1(R3)                                                         
         BCT   R0,CVE4                                                          
*                                                                               
CVEX     DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                             FLUSH DATA TABLE                                  
         SPACE 2                                                                
FLSHTAB  CSECT                                                                  
         NMOD1 0,FLSHTAB                                                        
         SPACE 2                                                                
         OC    RGCNT,RGCNT                                                      
         BZ    FTX                 NO RESPS FOR THIS GULP                       
*                                                                               
         L     RF,GULPCNT                                                       
         LA    RF,1(RF)                                                         
         ST    RF,GULPCNT                                                       
*                                                                               
         L     R4,ACTAB                                                         
         USING CTABD,R4                                                         
         L     R5,ADTAB                                                         
         L     R6,AWTREC                                                        
         USING WTRECD,R6                                                        
         XC    WTKEY,WTKEY                                                      
         MVC   WTGULP,GULPCNT+2                                                 
*                                                                               
FT4      DS    0H                                                               
         CLI   0(R4),X'FF'         END OF CONDITIONS                            
         BE    FT40                                                             
*                                                                               
*                                  SET CONDITION IN KEY                         
         SR    RF,RF                                                            
         ICM   RF,3,CTDISP           DISPLACEMENT                               
         SRL   RF,1                                                             
         LA    RF,1(RF)                                                         
         A     RF,NCOLS                                                         
         SR    RE,RE                                                            
         D     RE,NCOLS                                                         
         STCM  RF,3,WTCRD          CARD NUMBER                                  
         STCM  RE,3,WTCOL            REMAINDER IS COL NUM                       
*                                                                               
         CLI   CTTYP,0             PUNCH CONDITION                              
         BNE   FT4F                                                             
         L     RF,AMASKTAB         GET TRANSLATION                              
FT4B     DS    0H                                                               
         CLI   1(RF),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   1(1,RF),CTMASK                                                   
         BE    FT4D                                                             
         LA    RF,2(RF)                                                         
         B     FT4B                                                             
*                                                                               
FT4D     DS    0H                                                               
         MVC   WTPNCH,0(RF)        PUNCH CODE (0-9,X,Y)                         
         B     FT4M                                                             
*                                                                               
FT4F     DS    0H                                                               
         MVC   WTNLEN,CTNLEN       NUMERIC FIELD LENGTH                         
         NI    WTNLEN,X'0F'        STRIP HOBS                                   
*                                                                               
FT4M     DS    0H                                                               
         MVC   WTACC,CTACC         ACCESS LIMIT CODE                            
         ZIC   R2,CTTYP            R2 TO HAVE NO. OF RECS                       
         IC    R2,TCTAB(R2)        FOR THIS TYPE OF COND                        
         LA    R3,1                FOR SEQ                                      
         LR    R7,R5                                                            
*                                                                               
FT6      DS    0H                                                               
         STC   R3,WTSEQ                                                         
         L     R1,CONDSZE          FOR EXEC MVC                                 
         MOVE  (WTDATA,(R1)),0(R7)    SET DATA                                  
         LR    RE,R7               CLEAR THIS CONDITION AREA                    
         L     RF,CONDSZE                                                       
         XCEF                                                                   
*                                                                               
         BAS   RE,FTPUT                                                         
*                                                                               
         LA    R3,1(R3)            BUMP SEQ                                     
         A     R7,CONDSZE          NEXT PART OF CONDITION AREA                  
         BCT   R2,FT6                                                           
*                                                                               
         ZIC   R2,CTTYP            BUMP BY LENGTH FOR THIS TYPE                 
         SLL   R2,2                                                             
         A     R5,CONDLTAB(R2)     NEXT COND AREA                               
         LA    R4,CTABL(R4)        NEXT COND                                    
         B     FT4                                                              
*                                                                               
FT40     DS    0H                                                               
*                                                                               
FTX      DS    0H                                                               
         XC    RGCNT,RGCNT         ZERO RESPS/GULP                              
         XIT1                                                                   
*                                                                               
TCTAB    DC    AL1(1,8,16,24,32)   NUMBER OF WORK RECS FOR                      
*                                  EACH COND TYPE                               
         SPACE 3                                                                
*                             FLUSH OUTPUT ROUTINE                              
FTPUT    NTR1                                                                   
         SPACE 2                                                                
         CLI   FLSHSW,0                                                         
         BNE   FTP2                                                             
         MVI   FLSHSW,1                                                         
         GOTO1 ASETSORT            INITIALIZE SORT                              
*                                                                               
FTP2     DS    0H                                                               
         L     RF,WRKOCNT         BUMP COWRK OUTPUT COUNTER                     
         LA    RF,1(RF)                                                         
         ST    RF,WRKOCNT                                                       
         GOTO1 SORTER,DMCB,=C'PUT',WTRECD                                       
*                                                                               
         CLI   PRINTWO,C'Y'                                                     
         BNE   FTPX                                                             
*                                                                               
         L     R0,LWTREC                                                        
         GOTO1 ADMPREC,DMCB,WTRECD,(R0),=CL6'WORKO'                             
*                                                                               
FTPX     DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                             POST A RESPONDENT TO CONDITION WORK AREAS         
         SPACE 2                                                                
POSTR    CSECT                                                                  
         NMOD1 0,POSTR                                                          
         USING CTABD,R4                                                         
         L     R4,ACTAB            A(CONDITION TABLE)                           
         L     R5,ADTAB            A(DATA TABLE AREA)                           
*                                                                               
PR4      DS    0H                                                               
         CLI   0(R4),X'FF'    END OF CONDITIONS                                 
         BE    PRX                                                              
         SR    R6,R6                                                            
         ICM   R6,3,CTDISP         DISP INTO RESPONDENT RECORD                  
         A     R6,AREC                                                          
         CLI   CTTYP,0                                                          
         BNE   PR8                                                              
*                                  PUNCH CONDITION                              
         CLI   CTMASK,X'C0'        SPECIAL - FOR BLANK (NO PUNCHES)             
         BNE   PR5                                                              
         OC    0(2,R6),0(R6)       TEST ANY PUNCHES                             
         BZ    PR7B                NO- OK                                       
         B     PR40                YES=REJECT                                   
*                                                                               
PR5      DS    0H                                                               
         CLI   CTMASK,X'C1'        SPECIAL- SIGNLE PUNCH                        
         BNE   PR6                                                              
         LA    RF,SPLIST           LIST OF SINGLE PUNCH BIT CONFIGS             
*                                                                               
PR5F     DS    0H                                                               
         CLC   0(2,R6),0(RF)                                                    
         BE    PR7B                YES- IS A SINGLY PUNCH                       
         BL    PR40                NO- REJECT                                   
         LA    RF,2(RF)                                                         
         B     PR5F                                                             
         SPACE 2                                                                
SPLIST   DS    0H                                                               
         DC    X'0001'             9                                            
         DC    X'0002'             8                                            
         DC    X'0004'             7                                            
         DC    X'0008'             6                                            
         DC    X'0010'             5                                            
         DC    X'0020'             4                                            
         DC    X'0100'             3                                            
         DC    X'0200'             2                                            
         DC    X'0400'             1                                            
         DC    X'0800'             0                                            
         DC    X'1000'             X                                            
         DC    X'2000'             Y                                            
         DC    X'FFFF'             EOL                                          
*                                                                               
PR6      DS    0H                                                               
PR7      DS    0H                                                               
         MVC   BYTE,CTMASK                                                      
         NI    BYTE,X'3F'          STRIP 2 HOBS                                 
         TM    CTMASK,X'80'                                                     
         BZ    *+8                                                              
         LA    R6,1(R6)            USE 2ND BYTE                                 
         IC    RF,BYTE                                                          
         EX    RF,*+8                                                           
         B     *+8                                                              
         TM    0(R6),0                                                          
         BZ    PR40                                                             
*                                                                               
PR7B     DS    0H                                                               
         LR    RF,R5                                                            
         A     RF,RESPDPTB+0       DISP INTO COND WORK AREA FOR PUNCH           
         OC    0(1,RF),RESPBMSK    SET RESPONDENTS BIT                          
*                                                                               
         B     PR40                                                             
*                                  NUMERIC VALUE CONDITIONS                     
PR8      DS    0H                                                               
         MVC   BYTE,CTNLEN                                                      
         NI    BYTE,X'0F'          STRIP HOBS                                   
         ZIC   R3,BYTE             LENGTH OF FIELD                              
         GOTO1 ACVEBC,DMCB,((R3),(R6)),X     GET EBCDIC                         
         TM    CTNLEN,X'80'        TEST FIELD IS TO BE SIGNED                   
         BNZ   PR8D                YES                                          
         OC    X(15),=15C'0'       NO-STRIP ANY OVERPUNCHES                     
         MVI   BYTE,C'0'                                                        
         B     PR8F                                                             
*                                                                               
PR8D     DS    0H                FOR SIGNED FIELDS SAVE LOW OVERPUNCH           
         LA    RF,X-1(R3)          POINT TO LAST BYTE                           
         MVC   BYTE,0(RF)          SAVE IT                                      
         OI    0(RF),C'0'          SET AS POSITIVE FOR NUMVAL                   
*                                                                               
PR8F     DS    0H                                                               
         GOTO1 NUMVAL,(R1),X,(R3)            GET VALUE                          
         CLI   DMCB,0                                                           
         BE    PR10                                                             
         MVI   ERR,NVALERR                                                      
         BAS   RE,PRERR                                                         
         B     PR40                                                             
*                                                                               
PR10     DS    0H                                                               
         L     RE,DMCB+4           VALUE                                        
         TM    BYTE,X'30'          TEST FOR MINUS OVERPUNCH                     
         BNM   *+6                 IF MIXED                                     
         LCR   RE,RE               THEN COMPLEMENT                              
         ZIC   R1,CTTYP                                                         
         SLL   R1,2                                                             
         LR    RF,R5                                                            
         A     RF,RESPDPTB(R1)     DISPL INTO COND AREA                         
         IC    R1,CTTYP                                                         
         IC    R2,STCMSKS-1(R1)                                                 
         EX    R2,*+8                                                           
         B     PR12                                                             
         STCM  RE,0,0(RF)          SET VALUE IN AREA                            
*                                                                               
STCMSKS  DC    X'0103070F'         MASKS FOR STCM 1,2,3,4 BYTES                 
*                                                                               
PR12     DS    0H                                                               
*                                                                               
PR40     DS    0H                                                               
         ZIC   R1,CTTYP            BUMP WORK AREA POINTER BY                    
         SLL   R1,2                LENGTH FOR THIS CONDITION TYPE               
         A     R5,CONDLTAB(R1)                                                  
         LA    R4,CTABL(R4)        NEXT CONDITION                               
         B     PR4                                                              
*                                                                               
PRX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
PRERR    NTR1                                                                   
         L     RF,IERRCNT          BUMP INPUT ERROR COUNT                       
         LA    RF,1(RF)                                                         
         ST    RF,IERRCNT                                                       
*                                                                               
         CLI   PRINTE,C'Y'                                                      
         BNE   PRERRX                                                           
         GOTO1 AGETERR,DMCB,(ERR,P)                                             
         LA    R6,P+2                                                           
         A     R6,DMCB+4                                                        
         MVC   0(10,R6),LASTRNO                                                 
*                                                                               
         CLI   ERR,NVALERR         FOR NUM FIELD ERR                            
         BNE   PRERR4              SPECIFY WHICH FIELD                          
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,CTDISP         DISPLACEMENT                                 
         SRL   RF,1                                                             
         LA    RF,1(RF)                                                         
         A     RF,NCOLS                                                         
         SR    RE,RE                                                            
         D     RE,NCOLS            RF = CARD NO, RE = COLUMN                    
*                                                                               
         LA    R6,11(R6)                                                        
         MVC   0(18,R6),=C'CARDNNN COLNNN(NN)'                                  
         EDIT  (RF),(3,4(R6))      CARD NO                                      
         EDIT  (RE),(3,11(R6))     COLUMN NO                                    
         MVC   BYTE,CTNLEN         FIELD LENGTH                                 
         NI    BYTE,X'0F'          STRIP HOBS                                   
         EDIT  (B1,BYTE),(2,15(R6)),FILL=0                                      
*                                                                               
PRERR4   DS    0H                                                               
         GOTO1 PRINTER                                                          
PRERRX   DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                             ROUTINE TO PRINT RECORD HEX                       
         SPACE 2                                                                
DMPREC   CSECT                                                                  
         NMOD1 0,DMPREC                                                         
         L     RF,8(R1)                                                         
         MVC   P(2),=C'**'                                                      
         MVC   P+2(6),0(RF)                                                     
         L     R2,4(R1)            LENGTH OF RECORD                             
         L     R3,0(R1)            A(RECORD)                                    
DMPREC4  DS    0H                                                               
         LR    R4,R2                                                            
         C     R4,=F'60'                                                        
         BNH   *+8                                                              
         LA    R4,60                                                            
*                                                                               
         GOTO1 HEXOUT,DMCB,(R3),P+10,(R4),=C'N'                                 
         GOTO1 PRINTER                                                          
         AR    R3,R4                                                            
         SR    R2,R4                                                            
         BP    DMPREC4                                                          
*                                                                               
*                                                                               
DMPRECX  DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*                             PROCESS WORK RECORDS FOR OUTPUT                   
         SPACE 2                                                                
OPPROC   CSECT                                                                  
         NMOD1 0,OPPROC                                                         
         SPACE 2                                                                
         L     R6,AWTREC                                                        
         USING WTRECD,R6                                                        
         CLI   PRINTWI,C'Y'                                                     
         BNE   OPP4                                                             
         L     R0,LWTREC                                                        
         GOTO1 ADMPREC,DMCB,WTREC,(R0),=CL6'WORKI'                              
*                                                                               
OPP4     DS    0H                                                               
         CLI   WTKEY,X'FF'         EXCEPT AT EOF                                
         BE    OPP4B                                                            
         L     RF,WRKICNT          BUMP WORK INPUT COUNT                        
         LA    RF,1(RF)                                                         
         ST    RF,WRKICNT                                                       
*                                                                               
OPP4B    DS    0H                                                               
         CLI   OPSW,0              FIRST TIME                                   
         BNE   OPP6                                                             
         MVI   OPSW,1                                                           
*                                                                               
         L     RF,ADTAB            FOR NOW USE CONDITION WORK AREA              
         ST    RF,ALDREC           FOR OUTPUT REC AREA                          
         A     RF,=F'8008'                                                      
         ST    RF,ALDWRKA          AND OUTPUT WORK AREA                         
         B     OPP18                                                            
*                                                                               
OPP6     DS    0H                                                               
         CLC   WTCOND,LASTWKEY  TEST SAME CONDITION                             
         BE    OPP20                                                            
*                                  BUILD OUTPUT RECORD                          
*                                  AND FLUSH WORK AREA                          
         LA    R6,LASTWKEY         RESET WTREC BASE REG TO LAST KEY             
         L     R7,ALDREC                                                        
         LA    R7,4(R7)                                                         
         USING QVTRECD,R7                                                       
         XC    QVTREC(256),QVTREC                                               
         MVI   QVTKSYS,C'Q'        SUB-SYSTEM CODE                              
         MVI   QVTKRCD,X'41'       RECORD CODE                                  
         MVC   QVTKFCD,SURVEY       SURVEY                                      
         MVC   QVTKWDT,WAVDATE      WAVE DATE                                   
         MVC   QVTKCRD(5),WTCOND    CONDITION ID                                
*                                                                               
OPP11    DS    0H                                                               
         MVI   QVTKSEQ,1           SEQ 1                                        
*                                  CONTROL ELEM                                 
         MVI   QVTCNTEL,X'01'                                                   
         MVI   QVTCNTEL+1,10                                                    
         MVC   QVTACC,WTACC        SET ACCESS LIMIT CODE                        
         MVI   QVTCDLEN,0          DATA LEN IS 0 (1 BIT)                        
         CLI   WTPNCH,X'50'        FOR ALL PUNCH CONDITIONS                     
         BNL   OPP11A                                                           
         ZIC   R1,WTPNCH         ELSE GET FROM FIELD LENGTH                     
         LA    R1,DLENTAB-1(R1)                                                 
         MVC   QVTCDLEN,0(R1)                                                   
OPP11A   DS    0H                                                               
         MVC   QVTRLEN,=Y(QVTSTREL-QVTREC)    SET REC LENGTH                    
*                                                                               
         L     R6,AWTREC           RESTORE WTREC BASE REG                       
         BAS   RE,OPCMPRES         DO STRING COMPRESSION                        
*                                  AND WRITE OUTPUT RECORDS                     
OPP18    DS    0H                                                               
         L     R4,ALDWRKA          RESET WORK AREA POINTER                      
         ST    R4,OPSVR4                                                        
*                                                                               
OPP20    DS    0H                  SAME KEY-SET DATA IN WORK AREA               
         MVC   LASTWKEY,WTKEY                                                   
         CLI   WTKEY,X'FF'         TEST EOF                                     
         BE    OPP30                                                            
         L     R1,CONDSZE                                                       
         L     R4,OPSVR4                                                        
         MOVE  ((R4),(R1)),WTDATA                                               
         A     R4,CONDSZE          BUMP WORK AREA POINER                        
         ST    R4,OPSVR4                                                        
*                                                                               
         B     OPPX                                                             
*                                                                               
OPP30    DS    0H                                                               
         CLOSE  (QVOUT,)                                                        
*                                                                               
OPPX     DS    0H                                                               
         XIT1                                                                   
*                          DATA LENGTH FOR FIELD LENGTHS                        
DLENTAB  DC    X'010102020303030404040404040404'                                
         EJECT                                                                  
*                             COMPRESS STRING AND WRITE OUTPUT RECORDS          
*                                                                               
*        **NOTE- THE CODE FROM HERE THROUGH THE END OF THIS CSECT               
*                CAN BE USED ALMOST VERBATIM IN THE PROGRAM TO CREATE           
*                PRE-TABBED QSPEC VECTOR RECORDS.                               
*                                                                               
         SPACE 2                                                                
OPCMPRES NTR1                                                                   
         SPACE 2                                                                
         XC    RBYTES,RBYTES       CLEAR OUTPUT RECORD BYTE COUNT               
         XC    CMPCOUNT,CMPCOUNT   CLEAR COMPRESSION COUNT                      
         XC    DLN,DLN             COMPARAND LENGTH                             
         OC    DLN+3(1),QVTCDLEN   = RESPONSE LENGTH IN BYTES                   
         BNZ   *+8                                                              
         MVI   DLN+3,1             BUT 1 FOR BIT RESPONSES AS WELL              
*                                                                               
         L     RF,DLN                                                           
         SR    RE,RE                                                            
         IC    RE,EQLST-1(RF)                                                   
         ST    RE,EQNEED           BYTES NEEDED FOR REPEAT                      
*                                                                               
*                                  SET DATA LENGTH AND END                      
         L     RF,RESPCNT                                                       
         CLI   QVTCDLEN,0          FOR BIT STRINGS                              
         BNE   OPC6                                                             
*                                                                               
         LA    RF,7(RF)            LENGTH EQUALS                                
         SRL   RF,3                RESP COUNT/8 - FORCED UP                     
         B     OPC9                                                             
*                                                                               
OPC6     DS    0H                                                               
         MH    RF,DLN+2            ELSE = RESPONSE LENGTH X RESP COUNT          
*                                                                               
OPC9     DS    0H                                                               
         A     RF,ALDWRKA                                                       
         ST    RF,EOL              SET END OF DATA                              
*                                  COUNT RESPONSES                              
         CLI   QVTCDLEN,0                                                       
         BNE   OPC14                                                            
*                                  FOR BIT STRINGS COUNT YESSES                 
         L     R3,ALDWRKA          START OF STRING                              
         SR    R6,R6                                                            
         SR    R4,R4                                                            
*                                                                               
OPC10    DS    0H                                                               
         ICM   R4,1,0(R3)                                                       
         BZ    OPC13               SKIP NULL BYTES                              
*                                                                               
OPC11    DS    0H                                                               
         LA    R5,X'80'            SET BIT FINDER MASK                          
*                                                                               
OPC12    DS    0H                                                               
         LR    RE,R5                                                            
         NR    RE,R4                                                            
         BZ    *+8                                                              
         LA    R6,1(R6)            BUMP COUNTER                                 
         SRA   R5,1                NEXT BIT                                     
         BNZ   OPC12                                                            
*                                                                               
OPC13    DS    0H                                                               
         LA    R3,1(R3)            NEXT BYTE                                    
         C     R3,EOL                                                           
         BL    OPC10                                                            
         B     OPC18                                                            
*                                  NUMERIC RESPONSES                            
OPC14    DS    0H                                                               
         SR    R6,R6                                                            
         L     R5,DLN                                                           
         IC    R5,ICMSKS-1(R5)     MASK FOR EXECUTED ICM'S                      
         L     R3,ALDWRKA          START OF DATA                                
*                                                                               
OPC15    DS    0H                                                               
         SR    R1,R1                                                            
         EX    R5,OPCICM                                                        
         AR    R6,R1               ADD TO TOTAL                                 
         A     R3,DLN              NEXT ITEM                                    
         C     R3,EOL                                                           
         BL    OPC15                                                            
*                                                                               
         B     OPC18                                                            
*                                                                               
ICMSKS   DC    X'0103070F'         MASKS FOR EXECUTED ICM                       
OPCICM   ICM   R1,0,0(R3)                                                       
*                                                                               
OPC18    DS    0H                                                               
         STCM  R6,15,QVTCOUNT      RESULT OF COUNT                              
         MVC   X+QVTCNTEL-QVTREC(10),QVTCNTEL  SAVE QVTCNTEL                    
*                                                                               
         L     R4,ALDWRKA          START OF DATA                                
         ST    R4,PTR1                                                          
         ST    R4,PTR2                                                          
*                                  SET DATA LENGTH AND EOL                      
         L     R6,DLN                                                           
         BCTR  R6,R0               R6 FOR EXECUTED CLC'S                        
*                                                                               
         MVC   ELMAX,=F'255'                                                    
         MVC   ELMAXB,=F'253'                                                   
         BAS   RE,ADJELMB          ADJUST EL MAX                                
         XC    EQHAVE,EQHAVE                                                    
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,QVTRLEN                                                     
         AR    R7,RF               SET FIRST START FOR ELEMS                    
*                                                                               
*                                                                               
OPC20    DS    0H                                                               
         LR    R5,R4                                                            
         A     R5,DLN              POINT ONE POS AHEAD                          
         C     R5,EOL                                                           
         BNL   OPC24                                                            
*                                                                               
         EX    R6,CMPCLC           TEST BREAK IN STRING OF EQUALS               
         BE    OPC40                                                            
*                                                                               
*                                  BREAK                                        
OPC24    DS    0H                                                               
         LR    R1,R5                                                            
         S     R1,PTR2                                                          
         C     R1,EQNEED           TEST VS MINIMUM                              
         BL    OPC30                                                            
         ST    R1,EQHAVE           SAVE EQ LEN AND SET REPEAT PENDING           
*                                  ENOUGH TO DO A REPEATER                      
         BAS   RE,SETNORM          DO NORMAL ELEM                               
         BAS   RE,SETRPT           DO REPEAT ELEM                               
         B     OPC34                                                            
*                                     INSUFFICIENTLY LONG EQUAL STRING          
OPC30    DS    0H                                                               
         ST    R5,PTR2             SET STARTER FOR NEW EQUAL STRING             
         C     R5,EOL              AT EOL FORCE COMPLETION                      
         BE    OPC32                                                            
         LR    R1,R5                                                            
         S     R1,PTR1             LENGTH OF CURRENT UNEQUAL STRING             
         C     R1,ELMAXB           TEST VS MAX FOR ELEM                         
         BL    OPC40               LOW - OK TO CONTINUE                         
OPC32    DS    0H                                                               
         BAS   RE,SETNORM          ELSE DO NORMAL ELEM                          
OPC34    DS    0H                                                               
         C     R5,EOL              TEST DONE                                    
         BNL   OPC60                                                            
         ST    R5,PTR1             SET STARTER FOR NEW UNEQUAL                  
         ST    R5,PTR2             AND EQUAL                                    
*                                  NO BREAK IN EQUAL STRING                     
OPC40    DS    0H                                                               
         A     R4,DLN              CONTINUE                                     
         B     OPC20                                                            
*                                                                               
OPC60    DS    0H                                                               
         L     RF,ALDWRKA          MAKE SURE DIDNT LOSE ANY DATA                
         A     RF,RBYTES           IN COMPRESSION                               
         C     RF,EOL                                                           
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   EOL,X'FF'                                                        
         BAS   RE,CHKREC           DO LAST RECORD                               
*                                                                               
         CLI   PRINTCCP,C'Y'       TEST TO PRINT CCP COUNTS                     
         BNE   OPC65                                                            
*                                                                               
         L     R7,ALDREC                                                        
         LA    R7,4(R7)                                                         
         USING QVTRECD,R7                                                       
         EDIT  (B2,QVTKCRD),(3,P+0)        CARD NO                              
         EDIT  (B2,QVTKCOL),(3,P+7)        COL NO                               
         MVC   P+15(1),QVTKTYP             PUNCH CODE                           
         CLI   QVTKTYP,C'A'                                                     
         BNL   OPC64                                                            
         MVI   P+14,C'N'                   OR NUMERIC LENGTH                    
         EDIT  (B1,QVTKTYP),(2,P+15),ALIGN=LEFT                                 
*                                                                               
OPC64    DS    0H                                                               
         LA    R7,X                USE SAVE QVTCNTEL                            
         EDIT  (B1,QVTACC),(3,P+20)          ACCESS LIMIT CODE                  
         ICM   R6,15,QVTCOUNT                                                   
         EDIT  (R6),(14,P+25),COMMAS=YES,ZERO=NOBLANK,MINUS=YES                 
         EDIT  (B4,CMPCOUNT),(8,P+43),ZERO=NOBLANK                              
         GOTO1 PRINTER                                                          
*                                                                               
OPC65    DS    0H                                                               
OPCX     DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
*                                  ADD NORMAL ELEM                              
         DS    F                                                                
SETNORM  DS    0H                                                               
         ST    RE,SETNORM-4                                                     
*                                                                               
SETNM4   DS    0H                                                               
         L     RF,PTR2             START OF EQUAL STRING                        
         S     RF,PTR1             LESS START OF UNEQUALS                       
         BP    *+12                                                             
         BAS   RE,CHKREC                                                        
         B     SETNORMX                                                         
*                                                                               
         C     RF,ELMAXB           IF EXCEEDS MAX BYTE COUNT                    
         BNH   *+8                 WILL NEED 2 ELEMS                            
         L     RF,ELMAXB           FIRST IS MAX LEN                             
*                                  (NOTE- THIS CAN HAPPEN WHEN A STRING         
*                                   OF EQUALS TOO SHORT TO USE CAUSES           
*                                   ELMAXB TO BE EXCEEDED)                      
*                                                                               
*                                  IS LENGTH OF UNEQUALS                        
         MVI   0(R7),X'02'         NORMAL ELEM CODE                             
         L     R3,PTR1             START OF UNEQUALS                            
         L     R0,RBYTES           CUME DATA BYTE COUNT                         
         AR    R0,RF                                                            
         ST    R0,RBYTES                                                        
         ST    RF,SETNSAV          SAVE BYTE COUNT                              
         BCTR  RF,R0                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   2(0,R7),0(R3)                                                    
         LA    RF,3(RF)                                                         
         STC   RF,1(R7)            ELEM LENGTH                                  
         AR    R7,RF               BUMP ELEM POINTER                            
         BAS   RE,CHKREC                                                        
*                                                                               
         L     RF,SETNSAV          RESTORE BYTE COUNT                           
         L     R1,PTR1             DID WE USE UP ALL DATA                       
         AR    R1,RF                                                            
         C     R1,PTR2                                                          
         BE    SETNORMX            YES DONE                                     
*                                                                               
         ST    R1,PTR1             NO- NEW DATA START                           
         B     SETNM4                                                           
*                                                                               
SETNORMX DS    0H                                                               
         L     RE,SETNORM-4                                                     
         BR    RE                                                               
         SPACE 2                                                                
*                                  ADD REPEATER ELEM                            
SETRPT   DS    0H                                                               
         L     R1,EQHAVE           SAVED NUMBER OF EQUAL BYTES                  
         L     R0,CMPCOUNT         BUMP COMRESSED BYTE COUNT                    
         AR    R0,R1                                                            
         ST    R0,CMPCOUNT                                                      
         L     R0,RBYTES           BUMP DATA BYTE COUNT                         
         AR    R0,R1                                                            
         ST    R0,RBYTES                                                        
         SR    R0,R0                                                            
         D     R0,DLN              DIV BY LENGTH = NO. OF REPEATS               
         MVI   0(R7),X'03'         REPEATER ELEM CODE                           
         STCM  R1,3,2(R7)          SET NO. OF REPEATS                           
         L     R3,PTR2             START OF EQUALS                              
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   4(0,R7),0(R3)       PUT ONE EQUAL IN ELEM                        
         L     RF,DLN              DATA RESPONSE LENGTH                         
         LA    RF,4(RF)            PLUS 4                                       
         STC   RF,1(R7)            =   ELEM LENGTH                              
*                                                                               
         AR    R7,RF               BUMP ELEM POINTER                            
         XC    EQHAVE,EQHAVE                                                    
         B     CHKREC                                                           
         SPACE 2                                                                
*                                  TEST RECORD FULL                             
         DS    F                                                                
CHKREC   DS    0H                                                               
         ST    RE,CHKREC-4                                                      
         LR    RF,R7                                                            
         S     RF,ALDREC                                                        
         CLI   EOL,X'FF'           TEST FORCE LAST RECORD                       
         BE    CKR10                                                            
         L     R1,OPRMAX                                                        
         SR    R1,RF               R1 = LEFT IN RECORD                          
*                                  TEST ROOM FOR ANOTHER ELEM                   
         L     R3,DLN                                                           
         LA    R3,2(R3)            DATA LEN +2                                  
         OC    EQHAVE,EQHAVE       IF NO REPEATER PENDING                       
         BZ    CKR8                                                             
         LA    R3,2(R3)            ELSE DATA LEN + 4                            
*                                                                               
CKR8     DS    0H                                                               
         CR    R1,R3               TEST ROOM                                    
         BNH   CKR10               NO - PUT AND START NEW REC                   
*                                                                               
         C     R1,ELMAX                                                         
         BNH   *+8                                                              
         L     R1,ELMAX                                                         
         SH    R1,=H'2'                                                         
         ST    R1,ELMAXB           SET NEW MAX DATA LENGTH                      
         BAS   RE,ADJELMB          ADJUST EL MAX                                
*                                                                               
         B     CHKRECX                                                          
*                                  PUT OUTPUT RECORD                            
CKR10    DS    0H                                                               
         CH    RF,=Y(QVTELS-QVTREC+4)                                           
         BNH   CHKRECX             SKIP NULL RECORD                             
         L     R7,ALDREC                                                        
         XC    0(4,R7),0(R7)                                                    
         STH   RF,0(R7)                                                         
         LA    R7,4(R7)                                                         
         SH    RF,=H'4'                                                         
         STCM  RF,3,QVTRLEN        SET RECORD LENGTH                            
         A     RF,LDBCNT           BUMP BYTE COUNTER                            
         ST    RF,LDBCNT                                                        
*                                                                               
         L     R1,AQVOUT           PUT OUTPUT RECORD                            
         L     R0,ALDREC                                                        
         PUT   (1),(0)                                                          
*                                                                               
         CLI   PRINTO,C'Y'                                                      
         BNE   CKR12                                                            
         L     RF,ALDREC                                                        
         LH    RF,0(RF)                                                         
         ST    RF,DMCB+4                                                        
         GOTO1 ADMPREC,DMCB,ALDREC,,=CL6'OUTPUT'                                
*                                                                               
CKR12    DS    0H                                                               
         L     RF,LDRCNT           BUMP COUNTER                                 
         LA    RF,1(RF)                                                         
         ST    RF,LDRCNT                                                        
*                                                                               
         ZIC   RF,QVTKSEQ          BUMP REC SEQUENCE NUMBER                     
         LA    RF,1(RF)                                                         
         STC   RF,QVTKSEQ                                                       
*                                                                               
         LA    R7,QVTELS           POINT TO ELEM START AREA                     
         MVC   ELMAXB,=F'253'                                                   
         BAS   RE,ADJELMB          ADJUST EL MAX                                
CHKRECX  L     RE,CHKREC-4                                                      
         BR    RE                                                               
*                                                                               
CMPCLC   CLC   0(0,R4),0(R5)                                                    
EQLST    DC    AL1(6,8,9,12)    BYTES NEEDED FOR REPEAT FOR                     
*                               VARIOUS DATA LENGTHS                            
         SPACE 3                                                                
*        ADJUST MAX ELEM SIZE FOR DIFFERENT DATA LENGTHS                        
         SPACE 1                                                                
ADJELMB  DS    0H                                                               
         CLI   DLN+3,1             NO ADJUST IF DATA LEN =1                     
         BER   RE                                                               
*                                                                               
         L     R1,ELMAXB           ELSE TRUNCATE TO MULITPLE                    
         SR    R0,R0               OF DLN                                       
         D     R0,DLN                                                           
         M     R0,DLN                                                           
         ST    R1,ELMAXB                                                        
         BR    RE                                                               
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*                             INITIALIZE SORT                                   
         SPACE 2                                                                
SETSORT  CSECT                                                                  
         NMOD1 0,SETSORT                                                        
         SPACE 2                                                                
         L     R3,LWTREC           SET SORT REC LENGTH                          
         CVD   R3,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SRD+21(4),DUB                                                    
*                                                                               
         LA    R3,L'WTKEY          SET SORT KEY LENGTH                          
         CVD   R3,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SFD+15(2),DUB                                                    
*                                                                               
         GOTO1 SORTER,DMCB,SFD,SRD,0                                            
         B     SSRTX                                                            
SRD      DC    C'RECORD TYPE=F,LENGTH=NNNN '                                    
SFD      DC    C'SORT FIELDS=(1,NN,A),FORMAT=BI,WORK=1 '                        
*                                                                               
SSRTX    DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                  PRINTER INTERFACE                            
*                                                                               
PRNTR    CSECT                                                                  
         NMOD1 0,PRNTR                                                          
*                                                                               
         CP    MAXPAGE,=P'0'                                                    
         BE    PRNT2                                                            
         CP    PAGE,MAXPAGE                                                     
         BNH   *+6                                                              
         DC    H'0'                                                             
PRNT2    DS    0H                                                               
         GOTO1 VPRINTER                                                         
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
         SPACE 2                                                                
GETERR   CSECT                                                                  
         NMOD1 0,GETERR                                                         
         LA    R4,ERRLST                                                        
GE4      DS    0H                                                               
         CLC   0(1,R1),0(R4)       ERR NO IN HOB OF 1ST PARM                    
         BE    GE8                                                              
         ZIC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         CLI   0(R4),0                                                          
         BNE   GE4                                                              
         DC    H'0'                BAD ERROR                                    
*                                                                               
GE8      DS    0H                                                               
         XC    4(4,R1),4(R1)                                                    
         ZIC   RF,1(R4)                                                         
         SH    RF,=H'3'                                                         
         STC   RF,7(R1)            SET MSG LEN IN PARM2                         
         BCTR  RF,R0                                                            
         L     RE,0(R1)            OUTPUT IN PARM 1                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),3(R4)       SET MSG                                      
         MVC   0(1,R1),2(R4)       SET SEVERITY LEVEL                           
         OC    ERRLEV,2(R4)        KEEP TRACK OF SEVERITY LEVEL                 
*                                                                               
GEX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         SPACE 3                                                                
ERRLST   DS    0X                                                               
         DC    AL1(SPECERR),AL1(L'ERR001+3),X'80'                               
ERR001   DC    C'INVALID SPECIFICATION'                                         
         DC    AL1(COLERR),AL1(L'ERR002+3),X'80'                                
ERR002   DC    C'COLUMN SPEC EXTENDS PAST CARD END'                             
         DC    AL1(NCRDERR),AL1(L'ERR003+3),X'80'                               
ERR003   DC    C'NUMBER OF CARDS INVALID'                                       
         DC    AL1(NCOLERR),AL1(L'ERR004+3),X'80'                               
ERR004   DC    C'NUMBER OF COLUMNS/CARD INVALID'                                
         DC    AL1(BLKERR),AL1(L'ERR005+3),X'80'                                
ERR005   DC    C'BLKSIZE NOT MULTIPLE OF CARD SIZE'                             
         DC    AL1(RSPCERR),AL1(L'ERR006+3),X'80'                               
ERR006   DC    C'RESPONDENT NUMBER SPEC INVALID'                                
         DC    AL1(CRDCERR),AL1(L'ERR007+3),X'80'                               
ERR007   DC    C'COLUMN FOR CARD NUMBER SPEC INVALID'                           
         DC    AL1(CXCERR),AL1(L'ERR008+3),X'80'                                
ERR008   DC    C'NCARDS X NCOLS EXCEEDS 65535'                                  
         DC    AL1(CNUMERR),AL1(L'ERR009+3),X'00'                               
ERR009   DC    C'INVALID CARD NUMBER FOR RESPONDENT -'                          
         DC    AL1(RCNTERR),AL1(L'ERR010+3),X'80'                               
ERR010   DC    C'RESPONDENT COUNT INCORRECT'                                    
         DC    AL1(NVALERR),AL1(L'ERR011+3),X'00'                               
ERR011   DC    C'INV NUMERIC FIELD FOR RESPONDENT-'                             
         DC    AL1(DUPCERR),AL1(L'ERR012+3),X'00'                               
ERR012   DC    C'DUPLICATE CARD FOR RESPONDENT-'                                
         DC    AL1(CTDUPERR),AL1(L'ERR013+3),X'80'                              
ERR013   DC    C'DUPLICATE CONDITON SPECS'                                      
         DC    AL1(CORERR),AL1(L'ERR014+3),X'80'                                
ERR014   DC    C'INSUFFICIENT CORE'                                             
         DC    AL1(SURVERR),AL1(L'ERR015+3),X'80'                               
ERR015   DC    C'SURVEY INVALID OR MISSING'                                     
         DC    AL1(WAVDTERR),AL1(L'ERR016+3),X'80'                              
ERR016   DC    C'WAVE DATE INVALID OR MISSING'                                  
         DC    AL1(NRSPCERR),AL1(L'ERR017+3),X'80'                              
ERR017   DC    C'RESP. COUNT NOT GIVEN'                                         
         DC    X'FF'                                                            
         SPACE 3                                                                
SPECERR  EQU   1                                                                
COLERR   EQU   2                                                                
NCRDERR  EQU   3                                                                
NCOLERR  EQU   4                                                                
BLKERR   EQU   5                                                                
RSPCERR  EQU   6                                                                
RSPLERR  EQU   6                                                                
CRDCERR  EQU   7                                                                
CRDLERR  EQU   7                                                                
CXCERR   EQU   8                                                                
CNUMERR  EQU   9                                                                
RCNTERR  EQU   10                                                               
NVALERR  EQU   11                                                               
DUPCERR  EQU   12                                                               
CTDUPERR EQU   13                                                               
CORERR   EQU   14                                                               
SURVERR  EQU   15                                                               
WAVDTERR EQU   16                                                               
NRSPCERR EQU   17                                                               
*                                                                               
         SPACE 3                                                                
QVIN     DCB   DDNAME=QVIN,                                            X        
               DSORG=PS,                                               X        
               RECFM=FB,                                               X        
               LRECL=160,           ADJUSTED                           X        
               BLKSIZE=160,         ADJUSTED                           X        
               MACRF=GM,                                               X        
               BUFNO=1,                                                X        
               EODAD=INEOT                                                      
         SPACE 3                                                                
QVOUT    DCB   DDNAME=QVOUT,                                           X        
               DSORG=PS,                                               X        
               RECFM=VB,                                               X        
               LRECL=7996,          ADJUSTED                           X        
               BLKSIZE=8000,        ADJUSTED                           X        
               BUFNO=1,                                                X        
               MACRF=PM                                                         
         SPACE 3                                                                
WORKD    DSECT                                                                  
RCONS    DS    0F                                                               
CARDS    DS    A                                                                
SCANNER  DS    A                                                                
ABCT     DS    A                                                                
SORTER   DS    A                                                                
ASETRUN  DS    A                                                                
HEXOUT   DS    A                                                                
XSORT    DS    A                                                                
COVAIL   DS    A                                                                
STXITER  DS    A                                                                
ACVEBC   DS    A                                                                
ACBTBL   DS    A                                                                
PRINTER  DS    A                                                                
VPRINTER DS    A                                                                
CPRINT   DS    A                                                                
AGETERR  DS    A                                                                
AQVIN    DS    A                                                                
AQVOUT   DS    A                                                                
AMASKTAB DS    A                                                                
ADMPREC  DS    A                                                                
AOPPROC  DS    A                                                                
ASETSORT DS    A                                                                
AFLSHTAB DS    A                                                                
NUMVAL   DS    A                                                                
DATVAL   DS    A                                                                
DATCON   DS    A                                                                
AGETRESP DS    A                                                                
APOSTR   DS    A                                                                
RCONSX   EQU   *                                                                
*                                                                               
ACTAB    DS    A                                                                
ACTABX   DS    A                                                                
AREC     DS    A                                                                
AWTREC   DS    A                                                                
ADTAB    DS    A                                                                
DMCB     DS    6F                                                               
FULL     DS    F                                                                
DUB      DS    D                                                                
WORK     DS    XL64                                                             
X        DS    256X                                                             
BYTE     DS    X                                                                
CARD     DS    CL80                                                             
*                                                                               
NCARDS   DS    F                                                                
NCOLS    DS    F                                                                
IPBLKSZE DS    F                                                                
RESPCOL  DS    F                                                                
RESPLEN  DS    F                                                                
CARDCOL  DS    F                                                                
CARDLEN  DS    F                                                                
MAXPAGE  DS    PL3                                                              
*                                                                               
INPUT    DS    C                                                                
PRINTWI  DS    C                                                                
PRINTWO  DS    C                                                                
PRINTI   DS    C                                                                
PRINTE   DS    C                                                                
PRINTO   DS    C                                                                
PRINTCCP DS    C                                                                
INPSW    DS    X                                                                
IPSW     DS    X                                                                
OPSW     DS    X                                                                
FLSHSW   DS    X                                                                
INCARD   DS    F                                                                
INCARDC  DS    F                                                                
SURVEY   DS    CL8                                                              
WAVDATE  DS    XL2                                                              
RECCODE  DS    XL1                                                              
THISRNO  DS    CL10                                                             
LASTRNO  DS    CL10                                                             
LASTWKEY DS    CL20                                                             
CDISP    DS    F                                                                
THISCNO  DS    CL4                                                              
CNUMLST  DS    XL12                                                             
RGCNT    DS    F                                                                
*                                                                               
CONDSZE  DS    F                                                                
CONDLTAB DS    XL20                TABLE OF WORK AREA LEN REQ FOR EACH          
*                                  TYPE OF CONDITION (5 FULLS)                  
RESPDPTB DS    XL20                FOR A RESP,DISP INTO CONDITION               
*                                  WORK AREA BY TYPE OF CONDITION               
RESPBMSK DS    XL1                 MASK FOR THIS RESP                           
*                                                                               
CRDNO    DS    F                                                                
COLNO    DS    F                                                                
CFACT    DS    F                                                                
LREC     DS    F                                                                
CRECL    DS    F                                                                
LDWRKL   DS    F                                                                
LDRECDL  DS    F                                                                
*                                                                               
OPRMAX   DS    F                   MAX SIZE FOR OUTPUT REC                      
OPBLKSZE DS    F                   OUTPUT FILE BLOCK SIZEB                      
PTR1     DS    A                   FIRST BYTE OF UNEQUAL STRING                 
PTR2     DS    A                   FIRST BYTE OF EQUAL STRING                   
DLN      DS    F                   LENGTH OF COMPARAND                          
EOL      DS    A                   END OF DATA                                  
EQNEED   DS    F                   BYTES NEEDED TO JUSTIFY COMPRESSION          
EQHAVE   DS    F                   EQUAL BYTE COUNT                             
CMPCOUNT DS    F                   COUNT OF COMRESSED RESPONSES                 
ELMAX    DS    F                   MAX ELEM SIZE                                
ELMAXB   DS    F                   MAX BYTES FOR CURRENT ELEM                   
*                                                                               
ALDREC   DS    A                                                                
ALDWRKA  DS    A                                                                
OPSVR4   DS    F                                                                
SETNSAV  DS    F                                                                
ARECWRK  DS    A                                                                
CORELIM  DS    F                                                                
RBYTES   DS    F                                                                
ERR      DS    X                                                                
ERRLEV   DS    X                                                                
DMPSW    DS    X                                                                
ACCESS   DS    X                                                                
SAVNPCH  DS    X                                                                
SAVPCH   DS    CL20                                                             
SPECTYP  DS    C                                                                
         DS    0F                                                               
NCONDS   DS    XL20                COND COUNTS BY TYPE                          
*                                                                               
PRTVS1   DS    0F                  VALUES TO BE PRINTED AFTER SPECS             
NCONDT   DS    F                                                                
CNEED    DS    F                                                                
NRESPS   DS    F                                                                
CWKSIZE  DS    F                                                                
GULPSZE  DS    F                                                                
LWTREC   DS    F                                                                
*                                                                               
PRTVS2   DS    0F                  PRINTED AFTER INPUT PHASE                    
RECCNT   DS    F                                                                
RESPCNT  DS    F                                                                
GULPCNT  DS    F                                                                
IERRCNT  DS    F                                                                
WRKOCNT  DS    F                                                                
         SPACE 2                                                                
PRTVS3   DS    0F                  PRINTED AFTER OUTPUT PHASE                   
WRKICNT  DS    F                                                                
LDRCNT   DS    F                                                                
LDBCNT   DS    F                                                                
         SPACE 2                                                                
CRDCNT   DS    F                                                                
MAXGULP  DS    F                                                                
DASHES   DS    CL40'-'                                                          
*                                                                               
CEDTWRK  DS    XL1200                                                           
*                                                                               
*                                                                               
CTABD    DSECT                     DSECT FOR CONDITION TABLE                    
CTDISP   DS    XL2                 DISPLACEMENT INTO RESP                       
CTTYP    DS    XL1                 0=PUNCH, 1-4 = BINARY NUMERIC LENGTH         
CTMASK   DS    XL1                 BIT MASK  X'80'= 2ND BYTE                    
CTNLEN   EQU   CTMASK              OR NUM FIELD LEN (X'80'=SIGNED)              
CTACC    DS    XL1                 ACCESS LIMIT CODE                            
CTABL    EQU   *-CTABD                                                          
         SPACE 3                                                                
*                                  DSECT FOR WORK TAPE RECORDS                  
WTRECD   DSECT                                                                  
WTREC    DS    0X                                                               
WTKEY    DS    0XL9                                                             
WTCOND   DS    0XL5                CONDITION                                    
WTCRD    DS    XL2                 CARD NUM                                     
WTCOL    DS    XL2                 COLUMN NUM                                   
WTPNCH   DS    XL1                 PUNCH CODE                                   
WTNLEN   EQU   WTPNCH              OR NUMERIC FIELD LEN                         
WTACC    DS    XL1                 ACCESS LIMIT CODE                            
WTGULP   DS    XL2                 GULP NUMBER                                  
WTSEQ    DS    XL1                 SEQUENCE WITHIN GULP                         
*                                                                               
WTDATA   DS    0X                  DATA AREA                                    
         EJECT                                                                  
*                                                                               
       ++INCLUDE MPGENQS                                                        
         EJECT                                                                  
*                                                                               
       ++INCLUDE DDDPRINT                                                       
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'031MPQVERT   05/01/02'                                      
         END                                                                    
