*          DATA SET CPREPFILM  AT LEVEL 137 AS OF 05/10/05                      
*CATALP CPFILMST                                                                
         TITLE 'MAIN FILE CONTROLLER'                                           
CPFILCON CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 40,CPFILCON                                                      
         LA    R9,2048(RB)                                                      
         LA    R9,2048(R9)                                                      
         LA    R8,2048(R9)                                                      
         LA    R8,2048(R8)                                                      
         USING CPFILCON+4096,R9,R8                                              
         L     RA,=V(CPWORKC)                                                   
         USING CPWORKD,RA                                                       
         LA    R7,2048(RA)                                                      
         LA    R7,2048(R7)                                                      
         USING CPWORKD+4096,R7                                                  
         USING MONARCHD,RC                                                      
         L     R1,=V(MASTC)                                                     
         USING MASTD,R1                                                         
         LA    RE,ENDREQ                                                        
         STM   R0,RF,MCREQLST                                                   
         LA    RE,FINAL                                                         
         STM   R0,RF,MCRUNLST                                                   
         DROP  R1                                                               
         EJECT                                                                  
*                   INITIALISATION, REQUEST READ AND FINALISATION               
         SPACE 3                                                                
INITIAL  MVI   MODE,RUNFRST        FIRST TIME HOOK                              
         BAS   RE,GO                                                            
         SPACE 2                                                                
READREQ  CP    RCRQTOT,RCENNUM                                                  
         BNL   EOF                                                              
         SPACE 2                                                                
READCARD GOTO1 =V(REQSTART)                                                     
         L     R1,=V(MASTC)                                                     
         USING MASTD,R1                                                         
         MVC   QPROG(80),MCREQREC                                               
         CLC   QPROG(2),=C'/*'                                                  
         BE    FINAL                                                            
         CLC   QPROG(2),=C'/&&'                                                 
         BE    FINAL                                                            
         B     REQCON                                                           
         SPACE 3                                                                
EOF      DS    0H                                                               
         SPACE 2                                                                
FINAL    MVI   MODE,RUNLAST        LAST TIME HOOK                               
         BAS   RE,GO                                                            
         SPACE 2                                                                
FCEXT    XMOD1 1                                                                
         EJECT                                                                  
*                   FILTERING AND EDITING REQUESTS                              
         SPACE 3                                                                
REQCON   MVC   WORK(12),=CL12'X000'                                             
         MVC   WORK+4(2),QAGY                                                   
         MVC   WORK+4(2),=C'JW'                                                 
         GOTO1 GETPROF,DMCB,WORK,USERPROF,DATAMGR                               
         MVC   WORK+2(2),QCODE                                                  
         GOTO1 GETPROF,DMCB,WORK,PROGPROF,DATAMGR                               
         SPACE 2                                                                
RC2      AP    RCRQTOT,=P'1'                                                    
         CP    RCRQTOT,RCSTNUM     CHECK WE HAVE REACHED START OPTION           
         BL    READREQ                                                          
         GOTO1 REQREP,DMCB                                                      
         OC    DMCB(4),DMCB                                                     
         BZ    RC4                                                              
         AP    RCRQERR,=P'1'                                                    
         B     READREQ                                                          
         SPACE 2                                                                
RC4      AP    RCRQVAL,=P'1'                                                    
         CLI   QGRP,C'S'           TEST FOR SPOT MGRPS                          
         BNE   RC4A                                                             
         GOTO1 =V(CPSPOTMK),DMCB,(RA)                                           
RC4A     DS    0C                                                               
         MVC   SVAGY,QAGY                                                       
*                                                                               
         CLI   QGRP,C'T'           COMBINE TRACY AND NEEDHAM                    
         BNE   *+12                                                             
         L     R1,=A(TRACYTAB)                                                  
         B     RC4B                                                             
*                                                                               
         CLC   QAGY,=C'H7'         COMBINE H7,JW,OM                             
         BNE   RC4A1                                                            
         CLC   QPROG,=C'4T'                                                     
         BE    RC4A1                                                            
         L     R1,=A(H7TAB)                                                     
         B     RC4B                                                             
*                                                                               
RC4A1    CLC   QPROG,=C'06'        SPECIAL ALL AGENCY REPORT                    
         BNE   RC5                                                              
         L     R1,=A(AGYTAB)       SET START OF AGENCY LIST                     
         CLI   QMED,C'C'           CHECK IF CANADIAN                            
         BNE   *+8                                                              
         L     R1,=A(AGYTABCN)     YES - SET CANADIAN AGENCIES                  
RC4B     ST    R1,AGYLIST          SAVE POINTER                                 
         MVC   QAGY,0(R1)          SET FIRST AGENCY                             
         SPACE 1                                                                
RC5      BAS   RE,SETUPPER                                                      
         BAS   RE,SETPROJ                                                       
         XC    BMKT,BMKT                                                        
         XC    ATHISMKT,ATHISMKT                                                
         CLI   QRANGE,C'O'         DONT SUPPORT REAL OFFICE RECORDS             
         BNE   RC6                 SO MAKE IT LOOK LIKE CLI=ALL                 
         MVI   QRANGE,C'C'                                                      
         MVC   QCLT(3),=C'ALL'     WITH OFFICE FILTERED                         
         SPACE 1                                                                
RC6      LA    R4,KEY                                                           
         USING CPKEYD,R4                                                        
         XC    CPKEY,CPKEY                                                      
         MVI   CPKTYPE,X'14'                                                    
         MVC   CPKAGY,QAGY                                                      
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(3),KEY                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R4,ADDATA                                                        
         MVI   ELCODE,X'04'                                                     
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING CPNAMED,R4                                                       
         ZIC   R5,CPNLEN                                                        
         SH    R5,=H'3'                                                         
         MVC   AGYNM(66),SPACES                                                 
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   AGYNM(0),CPNAME                                                  
         MVC   MED,QMED                                                         
         MVC   MEDNM,=CL10'T.V'                                                 
         L     RE,=V(CPMKT99)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'88'      1988 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT87)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'89'      1989 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT88)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'90'      1990 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT88)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'91'      1990 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT90)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'92'      1991 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT91)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'93'      1992 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT92)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'94'      1993 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT93)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'96'      1995 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT95)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLC   QEND(2),=C'97'      1996 MARKET RANKS                            
         BL    *+12                                                             
         L     RE,=V(CPMKT96)                                                   
         ST    RE,ADMKTTAB                                                      
*                                                                               
         CLI   QMED,C'C'                                                        
         BNE   *+12                                                             
         L     RE,=V(CPCMKT)       SET TO CANADIAN MARKETS                      
         ST    RE,ADMKTTAB                                                      
         MVC   SVQCLOFF,QCLOFFC                                                 
         MVI   MODE,REQFRST                                                     
         BAS   RE,GO                                                            
         XC    NCLTS,NCLTS         ENSURE CLIENT POOL IS REFRESHED              
         BAS   RE,SETUPPER                                                      
         BAS   RE,SETPROJ                                                       
         EJECT                                                                  
*              MAIN FILE READING LOGIC                                          
         SPACE 3                                                                
         CLI   OPTRDSEQ,C'Y'                                                    
         BE    FR20                                                             
         CLI   QRANGE,C'C'                                                      
         BNE   FR4                                                              
         SPACE 2                                                                
FR2      BAS   RE,GETCLT                                                        
         BNE   ENDREQ                                                           
         MVI   MODE,CLTFRST                                                     
         BAS   RE,GO                                                            
         SPACE 2                                                                
FR4      BAS   RE,SKELETON                                                      
         BAS   RE,GETMKT                                                        
         BE    FR6                                                              
         CLI   QRANGE,C'C'                                                      
         BNE   ENDREQ                                                           
         MVI   MODE,CLTLAST                                                     
         BAS   RE,GO                                                            
         CLI   OPTRDSEQ,C'M'                                                    
         BE    ENDREQ                                                           
         B     FR2                                                              
         SPACE 2                                                                
FR6      MVC   KEY+4(2),MARKET                                                  
         MVI   MKTSW,C'Y'                                                       
         GOTO1 HIGH                                                             
         B     FR10                                                             
         SPACE 2                                                                
FR8      GOTO1 SEQ                                                              
         SPACE 2                                                                
FR10     CLC   KEY(9),KEYSAVE                                                   
         BE    FR12                                                             
         CLI   OPTRDSEQ,C'M'       IF APPLICATION IS HANDLING MARKETS           
         BNE   FR11                                                             
         CLI   QRANGE,C'C'         AND CLIENT RECORDS WERE REQUESTED,           
         BNE   FR11                                                             
         CLC   QCLT(3),=C'ALL'     UNLESS A SPECIFIC CLIENT                     
         BNE   FR11                                                             
         CLC   KEY(6),KEYSAVE      IGNORE CHANGE OF CLIENT                      
         BE    FR12                                                             
         SPACE 2                                                                
FR11     CLI   MKTSW,C'Y'                                                       
         BE    FR4                                                              
         MVI   MODE,MKTLAST                                                     
         BAS   RE,GO                                                            
         B     FR4                                                              
         SPACE 2                                                                
FR12     BAS   RE,DATAPOST                                                      
         BNE   FR8                                                              
         BAS   RE,FILTER                                                        
         BNE   FR8                                                              
         BAS   RE,POSTPER                                                       
         BNE   FR8                                                              
         CLI   MKTSW,C'Y'                                                       
         BNE   FR14                                                             
         MVI   MODE,MKTFRST                                                     
         BAS   RE,GO                                                            
         MVI   MKTSW,C'N'                                                       
         SPACE 2                                                                
FR14     MVI   MODE,PROCDATA                                                    
         BAS   RE,GO                                                            
         B     FR8                                                              
         SPACE 2                                                                
MKTSW    DC    C'Y'                                                             
         EJECT                                                                  
*              SPECIAL SEQUENTIAL FILE READING                                  
         SPACE 3                                                                
FR20     CLI   QRANGE,C'C'                                                      
         BNE   FR22                                                             
         BAS   RE,GETCLT                                                        
         BNE   ENDREQ                                                           
         SPACE 2                                                                
FR22     BAS   RE,SKELETON                                                      
         BAS   RE,GETMKT                                                        
         MVC   KEY+4(2),MARKET                                                  
FR23     GOTO1 HIGH                                                             
         CLI   QRANGE,C'B'                                                      
         BE    FR25                                                             
         CLC   KEY+1(2),QAGY                                                    
         BNE   ENDREQ              THANKS - KEN                                 
         SPACE 1                                                                
         B     FR25                                                             
         SPACE 2                                                                
FR24     GOTO1 SEQ                                                              
FR25     CLI   QGRP,C'S'           SPOT MARKET GROUPS                           
         BE    FR26                                                             
         OC    BMKT,BMKT           CHECK FOR SINGLE MARKET                      
         BZ    FR26                                                             
         L     R4,ADDATA                                                        
         USING CPKEYD,R4                                                        
         CLC   BMKT,CPKMKT                                                      
         BE    FR26                                                             
         BH    *+8                                                              
         B     ENDREQ                                                           
         MVC   CPKMKT,BMKT                                                      
         B     FR23                                                             
         SPACE 2                                                                
FR26     CLC   KEY(4),KEYSAVE                                                   
         BNE   ENDREQ                                                           
         BAS   RE,DATAPOST                                                      
         BNE   FR24                                                             
         BAS   RE,FILTER                                                        
         BNE   FR24                                                             
         BAS   RE,POSTPER                                                       
         BNE   FR24                                                             
         MVI   MODE,PROCDATA                                                    
         BAS   RE,GO                                                            
         B     FR24                                                             
         EJECT                                                                  
*              ROUTINE TO FILTER                                                
         SPACE 2                                                                
FILTER   NTR1                                                                   
         L     R4,ADDATA                                                        
         USING CPKEYD,R4                                                        
         CLC   CPKMKT,=AL2(601)                                                 
         BNE   *+10                                                             
         MVC   CPKMKT,=AL2(511)                                                 
         CLC   QSLFILT,SPACES      SPOT LENGTH FILTER                           
         BE    FILTER2                                                          
         PACK  DUB,QSLFILT                                                      
         CVB   R0,DUB                                                           
         STC   R0,DUB                                                           
         CLC   CPKSPTLN,DUB                                                     
         BNE   NOTOK                                                            
         SPACE 2                                                                
FILTER2  CLC   QDPFILT,SPACES      DAY PART FILTER                              
         BE    FILTER4                                                          
         MVC   DUB,QDPFILT                                                      
         CLI   DUB,X'F0'           IS IT AN ALPHA TIME CODE REQUEST             
         BL    FILTER3                                                          
         GOTO1 HEXIN,DMCB,QDPFILT,DUB,2                                         
         SPACE 2                                                                
FILTER3  CLC   CPKDAYPT,DUB                                                     
         BNE   NOTOK                                                            
         SPACE 2                                                                
FILTER4  CLI   QAFFILT,C' '        AFFILIATION FILTER                           
         BE    FILTER6                                                          
         CLC   QAFFILT,CPKAFFIL                                                 
         BNE   NOTOK                                                            
         SPACE 2                                                                
FILTER6  CLI   QPTFILT,C' '        PROGRAM TYPE                                 
         BE    FILTER8                                                          
         CLC   QPTFILT,CPKPROG                                                  
         BNE   NOTOK                                                            
         SPACE 2                                                                
FILTER8  LA    R2,QTARGET                                                       
         LA    R3,CPKTARGT                                                      
         BAS   RE,DEMFILT                                                       
         BNE   NOTOK                                                            
         LA    R2,QSELECT                                                       
         LA    R3,CPKDEMO                                                       
         BAS   RE,DEMFILT                                                       
         BNE   NOTOK                                                            
         CLI   QOPT3,C'Y'          OPTION 3=Y MEANS TARGETS ONLY                
         BNE   FILTER12                                                         
         CLC   CPKTARGT,CPKDEMO                                                 
         BNE   NOTOK                                                            
         SPACE 2                                                                
FILTER12 CLI   QCLOFFC,C' '                                                     
         BE    FILTER14                                                         
         CLC   QCLOFFC,CLTOFF                                                   
         BNE   NOTOK                                                            
         SPACE 2                                                                
FILTER14 DS    0H                                                               
         CLI   OPTRDSEQ,C'Y'       FILTER MARKET FOR SEQ. READING               
         BNE   FILTER18                                                         
         CLI   QGRP,C'S'           DOING SPOT MARKET GROUPS                     
         BE    FILTER19                                                         
         CLC   QMKT,=C'ALL '                                                    
         BE    FILTER18                                                         
         CLC   QMKT(2),=C'MG'                                                   
         BE    FILTER16                                                         
         PACK  DUB,QMKT            ONE MARKET REQUESTED                         
         CVB   R3,DUB                                                           
         STH   R3,BMKT             SAVE REQUESTED MARKET                        
         CH    R3,CPKMKT           HAVE WE FOUND IT                             
         BE    FILTER18                                                         
         B     NOTOK                                                            
         SPACE 2                                                                
FILTER16 PACK  DUB,QMKT+2(2)       GROUP OF MARKETS REQUESTED                   
         CVB   R3,DUB                                                           
         BCTR  R3,0                                                             
         SLL   R3,2                                                             
         LA    R3,MKTGRTAB(R3)                                                  
         CLC   MKTRANK,0(R3)                                                    
         BL    NOTOK                                                            
         CLC   MKTRANK,2(R3)                                                    
         BH    NOTOK                                                            
         SPACE 2                                                                
FILTER18 CLI   QSERVICE,C' '                                                    
         BE    OK                                                               
         CLC   QSERVICE,CPKSERV                                                 
         BNE   NOTOK                                                            
         B     OK                                                               
         SPACE 2                                                                
FILTER19 L     R3,ADMGROUP         TEST IF IN MGR                               
         USING MPTABD,R3                                                        
FILTER20 OC    0(2,R3),0(R3)       END OF TABLE                                 
         BZ    NOTOK                                                            
         CLI   MPMGRID,0           IN THIS GROUP                                
         BE    *+14                                                             
         CLC   MPNSINO,CPKMKT      CHECK THE MARKET NUMBER                      
         BE    FILTER18                                                         
         LA    R3,MPEND-MPSTART(R3)                                             
         B     FILTER20                                                         
         DROP  R3                                                               
         SPACE 2                                                                
OK       SR    R1,R1                                                            
         B     FILTEX                                                           
         SPACE 2                                                                
NOTOK    LA    R1,1                                                             
         SPACE 2                                                                
FILTEX   LTR   R1,R1                                                            
XIT      XIT1                                                                   
         SPACE 2                                                                
ENDREQ   CLC   QCODE,=C'32'        INDUSTRY VS. AGENCY                          
         BE    *+10                                                             
         CLC   QCODE,=C'33'        INDUSTRY VS. CLIENT                          
         BNE   ENDREQ2                                                          
         CLC   SVAGY,=C'H7'                                                     
         BE    ENDREQ2A                                                         
         CLI   QGRP,C'T'           SPECIAL TRACY/DDB REPORT                     
         BE    ENDREQ2                                                          
         CLI   QRANGE,C'B'         IF BANK RECORDS PROCESSED                    
         BE    ENDREQ2             THEN END THE REQUEST                         
         MVI   QRANGE,C'B'         ELSE DO THEM NOW                             
         XC    ATHISMKT,ATHISMKT                                                
         MVI   OPTRDSEQ,C'Y'                                                    
         B     FR22                                                             
*                                                                               
ENDREQ2  CLI   QGRP,C'T'           SPECIAL TRACY/DDB REPORT                     
         BE    ENDREQ2A                                                         
         CLC   QCODE,=C'04'        SPECIAL ALL AGY REPORT                       
         BNE   *+10                                                             
         CLC   QCODE,=C'06'        SPECIAL ALL AGY REPORT                       
         BNE   ENDREQ4                                                          
ENDREQ2A CLI   QRANGE,C'B'         IF BANK RECORDS PROCESSED                    
         BE    ENDREQX             THEN END THE REQUEST                         
         L     R1,AGYLIST          POINT TO LAST ENTRY                          
         LA    R1,2(R1)                                                         
         ST    R1,AGYLIST                                                       
         CLI   0(R1),X'FF'         END OF LIST                                  
         BE    ENDREQ3                                                          
         MVC   QAGY,0(R1)          SET NEXT AGENCY                              
         MVI   QRANGE,C'A'         FORCE TO AGENCY RECORDS                      
         XC    ATHISMKT,ATHISMKT                                                
         MVI   OPTRDSEQ,C'Y'                                                    
         B     FR22                                                             
*                                                                               
ENDREQ3  CLC   QCODE,=C'38'        TREND IS ONE DIMENSIONAL                     
         BE    ENDREQ5                                                          
         MVI   QRANGE,C'B'         ELSE DO THEM NOW                             
         XC    ATHISMKT,ATHISMKT                                                
         MVI   OPTRDSEQ,C'Y'                                                    
         B     FR22                                                             
ENDREQ4  DS    0C                                                               
         CLC   QCODE,=C'42'        AGENCY REPORT                                
         BNE   ENDREQ5                                                          
         MVC   QCLOFFC,SVQCLOFF    RESTORE THE OFFICE                           
         CLI   QRANGE,C'A'         IF AGENCY RECORDS PROCESSED                  
         BE    ENDREQX             THEN END THE REQUEST                         
         MVI   QRANGE,C'A'         ELSE DO THEM NOW                             
         MVI   QCLOFFC,C' '        AGENCY BELONGS TO NO OFFICE                  
         XC    ATHISMKT,ATHISMKT                                                
         MVI   OPTRDSEQ,C'Y'                                                    
         B     FR22                                                             
*                                                                               
ENDREQ5  DS    0H                                                               
*                                                                               
ENDREQX  MVI   MODE,REQLAST                                                     
         BAS   RE,GO                                                            
         B     READREQ                                                          
BMKT     DS    H                                                                
         SPACE 2                                                                
         GETEL (R4),DATADISP,ELCODE                                             
         SPACE 2                                                                
ELCODE   DC    X'00'                                                            
         DC    X'00'                                                            
         SPACE 2                                                                
DEMFILT  NTR1                                                                   
         CLC   0(3,R2),SPACES      FILTER DEMOS                                 
         BE    OK                                                               
         PACK  DUB,0(3,R2)                                                      
         CVB   R4,DUB                                                           
         STC   R4,DUB                                                           
         CH    R4,=H'240'                                                       
         BH    DEMFILT2                                                         
         CLC   0(1,R3),DUB         CHECK MATCH ON DEMO NO.                      
         BE    OK                                                               
         BNE   NOTOK                                                            
         SPACE 2                                                                
DEMFILT2 SH    R4,=H'240'          GROUP NO = DEMO - 240                        
         L     R5,ADDEMGRP                                                      
         BCT   R4,DEMFILT4                                                      
         B     DEMFILT6                                                         
         SPACE 2                                                                
DEMFILT4 ZIC   R1,0(R5)            POSITION TO GROUP                            
         AR    R5,R1                                                            
         BCT   R4,DEMFILT4                                                      
         SPACE 2                                                                
DEMFILT6 LA    R5,1(R5)            NOW LOOK FOR MATCH IN LIST                   
         CLI   0(R5),X'FF'                                                      
         BE    NOTOK                                                            
         CLC   0(1,R5),0(R3)                                                    
         BE    OK                                                               
         BNE   DEMFILT6                                                         
         EJECT                                                                  
*              ROUTINES TO HANDLE THE CLIENT TABLE                              
         SPACE 3                                                                
GETCLT   NTR1                                                                   
         L     R2,ADCLTBUF                                                      
         L     R3,0(R2)                                                         
         LA    R2,4(R2)                                                         
         L     R6,NCLTS                                                         
         LTR   R6,R6                                                            
         BNZ   GETCLT10                                                         
         ST    R2,ATHISCLT         FIRST TIME THRU, BUILD CLIENT POOL           
         LA    R4,KEY                                                           
         USING CPKEYD,R4                                                        
         XC    CPKEY,CPKEY                                                      
         MVI   CPKTYPE,X'12'                                                    
         MVC   CPKAGY,QAGY                                                      
         MVC   CPKMED,QMED                                                      
         GOTO1 HIGH                                                             
         B     GETCLT4                                                          
         SPACE 2                                                                
GETCLT2  GOTO1 SEQ                                                              
         SPACE 2                                                                
GETCLT4  CLC   KEYSAVE(4),KEY      GET A CLIENT                                 
         BNE   GETCLT8                                                          
         CLC   QCLT(3),=C'ALL'     SPECIAL FOR CLIENT GROUPS                    
         BNE   GETCLT5                                                          
         CLC   QCLT+3(2),SPACES                                                 
         BE    GETCLT5                                                          
         MVC   INSW(2),QCLT+3      ALLOW ALL-X                                  
         CLI   INSW,C'-'                                                        
         BE    *+10                                                             
         MVC   INGROUP,QCLT+3      OR ALLX                                      
         L     RF,=V(CPCLILST)                                                  
         SPACE 2                                                                
LIST2    CLC   0(2,RF),QAGY        LOOK FOR A LIST FOR AGY/GROUP                
         BNE   LIST4                                                            
         CLC   2(1,RF),INGROUP                                                  
         BE    LIST6                                                            
         SPACE 2                                                                
LIST4    LA    RF,8(RF)                                                         
         CLI   0(RF),X'FF'                                                      
         BE    GETCLT5             NO GOOD                                      
         B     LIST2                                                            
         SPACE 2                                                                
LIST6    L     RF,4(RF)                                                         
         SPACE 2                                                                
LIST8    CLI   0(RF),X'FF'         LOOK FOR CLIENT IN LIST                      
         BE    LIST12                                                           
         CLC   0(3,RF),KEY+6                                                    
         BE    LIST10                                                           
         LA    RF,3(RF)                                                         
         B     LIST8                                                            
         SPACE 2                                                                
LIST10   CLI   INSW,C'-'           CLIENT WAS IN LIST                           
         BE    GETCLT2                    MAY BE EXCLUDED                       
         B     GETCLT5                                                          
         SPACE 2                                                                
LIST12   CLI   INSW,C'-'           CLIENT NOT IN LIST                           
         BNE   GETCLT2                                                          
         SPACE 2                                                                
GETCLT5  L     R4,ADDATA                                                        
         MVI   ELCODE,X'04'        DIG OUT THE NAME                             
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING CPNAMED,R4                                                       
         ZIC   R5,CPNLEN                                                        
         SH    R5,=H'3'                                                         
         MVC   0(24,R2),SPACES                                                  
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   3(0,R2),CPNAME                                                   
         L     R4,ADDATA                                                        
         MVI   ELCODE,X'06'        AND OFFICE IF AROUND                         
         BAS   RE,GETEL                                                         
         BNE   GETCLT6                                                          
         USING CPCLTD,R4                                                        
         MVC   23(1,R2),CPCOFF                                                  
         SPACE 2                                                                
GETCLT6  MVC   0(3,R2),KEY+6       AND CLIENT CODE                              
         AH    R2,WIDTHCLT                                                      
         LA    R6,1(R6)                                                         
         BCT   R3,GETCLT2                                                       
         DC    H'0'                                                             
         SPACE 2                                                                
GETCLT8  ST    R6,NCLTS            SAVE NUMBER OF CLIENTS FOUND                 
         L     R2,ATHISCLT         POSITION TO FIRST CLIENT                     
         B     GETCLT12                                                         
         SPACE 2                                                                
GETCLT10 L     R2,ATHISCLT         POSITION TO NEXT CLIENT                      
         AH    R2,WIDTHCLT                                                      
         SPACE 2                                                                
GETCLT12 ST    R2,ATHISCLT         EXTRACT VALUES                               
         MVC   CLT,0(R2)                                                        
         MVC   CLTNM,SPACES                                                     
         MVC   CLTNM(20),3(R2)                                                  
         MVC   CLTOFF,23(R2)                                                    
         OC    0(24,R2),0(R2)                                                   
         BZ    GETCLT18                                                         
         CLC   QCLT(3),=C'ALL'     WAS A SPECIFIC CLIENT REQUESTED              
         BE    GETCLT16                                                         
         CLC   QCLT,SPACES                                                      
         BE    GETCLT16                                                         
         MVC   WORK,QCLT                                                        
         TM    QCLT+3,X'F0'                                                     
         BO    *+10                                                             
         MVC   QCLT+3(2),SPACES                                                 
         CLC   QCLT+3(2),SPACES                                                 
         BE    GETCLT14                                                         
         PACK  DUB,QCLT+1(4)       CATER FOR (UK) XNNNN FORMAT                  
         CVB   R0,DUB                                                           
         STH   R0,DUB                                                           
         MVC   WORK+1(2),DUB                                                    
         SPACE 2                                                                
GETCLT14 CLC   WORK(3),CLT         IS THIS A MATCH                              
         BNE   GETCLT10                                                         
         SPACE 2                                                                
GETCLT16 CLI   QCLOFFC,C' '        IF OFFICE WAS REQUESTED,                     
         BE    OK                                                               
         CLC   QCLOFFC,CLTOFF         DID THIS CLIENT MATCH                     
         BE    OK                                                               
         B     GETCLT10                                                         
         SPACE 2                                                                
GETCLT18 L     R2,ADCLTBUF                                                      
         LA    R2,4(R2)                                                         
         ST    R2,ATHISCLT                                                      
         B     NOTOK                                                            
         EJECT                                                                  
*              ROUTINES TO HANDLE THE MARKET TABLE                              
         SPACE 3                                                                
GETMKT   NTR1                                                                   
         OC    NMKTS,NMKTS                                                      
         BNZ   GETMKT4                                                          
         L     R2,ADMKTTAB                                                      
         SR    R3,R3                                                            
         SPACE 2                                                                
GETMKT2  CLI   0(R2),X'FF'         FIRST TIME - COUNT MARKETS                   
         BE    GETMKT4                                                          
         LA    R3,1(R3)                                                         
         ST    R3,NMKTS                                                         
         AH    R2,WIDTHMKT                                                      
         B     GETMKT2                                                          
         SPACE 2                                                                
GETMKT4  OC    ATHISMKT,ATHISMKT   ARE WE STARTING FROM BEGINNING               
         BNZ   GETMKT6                                                          
         L     R2,ADMKTTAB                                                      
         SLL   R2,8                                                             
         SRL   R2,8                                                             
         ST    R2,ATHISMKT                                                      
         CLC   QMKTSEQ,MKTSEQ      IS THE MARKET TABLE IN THE RIGHT             
         BE    GETMKT8             SEQUENCE - YES SO SKIP XSORT                 
         MVC   MKTSEQ,QMKTSEQ                                                   
         L     R3,NMKTS                                                         
         LH    R4,WIDTHMKT                                                      
         LA    R5,24                                                            
         LA    R6,6                DEFAULT IS TO SORT BY ALPHA                  
         CLI   MKTSEQ,C'R'                                                      
         BNE   GETMKT5                                                          
         LA    R6,4                OPTION TO SORT BY RANK                       
         CLI   USERPROF,C'S'       CAN BE SMA OR DMA                            
         BE    GETMKT5                                                          
         LA    R6,2                                                             
         SPACE 1                                                                
GETMKT5  CLI   MKTSEQ,C'C'                                                      
         BNE   *+6                                                              
         SR    R6,R6               OPTION TO SORT BY CODE                       
         CLC   QCODE,=C'32'        32 ALWAYS SORTS                              
         BE    *+10                                                             
         CLC   QCODE,=C'33'        33 ALWAYS SORTS                              
         BE    *+10                                                             
         CLC   QCODE,=C'42'        42 ALWAYS SORTS                              
         BE    *+10                                                             
         CLC   QCODE,=C'06'        34 ALWAYS SORTS                              
         BE    *+10                                                             
         CLC   QCODE,=C'26'        26 ALWAYS SORTS                              
*                                  SO ALWAYS READ IN FILE SEQUENCE              
         BNE   *+6                                                              
         SR    R6,R6                                                            
         STM   R2,R6,DMCB                                                       
         GOTO1 XSORT,DMCB                                                       
         B     GETMKT8                                                          
         SPACE 2                                                                
GETMKT6  L     R2,ATHISMKT         BUMP TO NEXT MARKET                          
         AH    R2,WIDTHMKT                                                      
         ST    R2,ATHISMKT                                                      
         SPACE 2                                                                
GETMKT8  CLI   0(R2),X'FF'         HAVE WE REACHED THE END                      
         BNE   GETMKT10                                                         
         XC    ATHISMKT,ATHISMKT   YES SO SET FOR NEXT TIME                     
         B     NOTOK                                                            
         SPACE 2                                                                
GETMKT10 CLI   QZNFILT,C' '        FILTERING ON TIME ZONE                       
         BE    GETMKT12                                                         
         LH    R3,0(R2)                                                         
         CVD   R3,DUB                                                           
         UNPK  WORK(3),DUB+6(2)                                                 
         CLC   QZNFILT,WORK        FIRST CHARACTER OF CODE IS ZONE              
         BNE   GETMKT6                                                          
         SPACE 2                                                                
GETMKT12 CLC   QMKT,=C'    '                                                    
         BNE   *+10                                                             
         MVC   QMKT,=C'ALL '                                                    
         CLI   QGRP,C'S'           DOING SPOT MARKET GROUPS                     
         BE    GETMKT18                                                         
         CLC   QMKT,=C'ALL '                                                    
         BE    GETMKT16                                                         
         CLC   QMKT(2),=C'MG'                                                   
         BE    GETMKT14                                                         
         PACK  DUB,QMKT            ONE MARKET REQUESTED                         
         CVB   R3,DUB                                                           
         CH    R3,0(R2)            HAVE WE FOUND IT                             
         BE    GETMKT16                                                         
         B     GETMKT6                                                          
         SPACE 2                                                                
GETMKT14 PACK  DUB,QMKT+2(2)       GROUP OF MARKETS REQUESTED                   
         CVB   R3,DUB                                                           
         BCTR  R3,0                                                             
         SLL   R3,2                                                             
         LA    R3,MKTGRTAB(R3)                                                  
         MVC   DUB(2),2(R2)        DIG OUT DMA                                  
         CLI   USERPROF,C'S'                                                    
         BNE   *+10                                                             
         MVC   DUB(2),4(R2)        OR SMA MARKET RANK                           
         CLC   DUB(2),0(R3)        SEE IF MARKET'S RANK FITS                    
         BL    GETMKT6                                                          
         CLC   DUB(2),2(R3)                                                     
         BH    GETMKT6                                                          
         SPACE 2                                                                
GETMKT16 MVC   MARKET,0(R2)        GOT ONE - EXTRACT VALUES                     
         MVC   MKTRANK,2(R2)                                                    
         CLI   USERPROF,C'S'                                                    
         BNE   *+10                                                             
         MVC   MKTRANK,4(R2)                                                    
         MVC   MKTNAME,6(R2)                                                    
         B     OK                                                               
         SPACE 2                                                                
GETMKT18 L     R3,ADMGROUP         TEST IF IN MGR                               
         USING MPTABD,R3                                                        
GETMKT19 OC    0(2,R3),0(R3)       END OF TABLE                                 
         BZ    GETMKT6                                                          
         CLI   MPMGRID,0           IN THIS GROUP                                
         BE    *+14                                                             
         CLC   MPNSINO,0(R2)       CHECK THE MARKET NUMBER                      
         BE    GETMKT16                                                         
         LA    R3,MPEND-MPSTART(R3)                                             
         B     GETMKT19                                                         
         DROP  R3                                                               
         EJECT                                                                  
*              TABLE OF MARKET GROUP VALUES                                     
         SPACE 1                                                                
MKTGRTAB DS    0D                                                               
         DC    AL2(001),AL2(010)   GROUP 01                                     
         DC    AL2(011),AL2(020)   GROUP 02                                     
         DC    AL2(001),AL2(020)   GROUP 03                                     
         DC    AL2(021),AL2(030)   GROUP 04                                     
         DC    AL2(001),AL2(030)   GROUP 05                                     
         DC    AL2(031),AL2(040)   GROUP 06                                     
         DC    AL2(001),AL2(040)   GROUP 07                                     
         DC    AL2(041),AL2(050)   GROUP 08                                     
         DC    AL2(001),AL2(050)   GROUP 09                                     
         DC    AL2(051),AL2(100)   GROUP 10                                     
         DC    AL2(001),AL2(100)   GROUP 11                                     
         DC    AL2(101),AL2(200)   GROUP 12                                     
         DC    AL2(001),AL2(200)   GROUP 13                                     
         SPACE 3                                                                
*              TABLE OF AGENCY GROUPS                                           
         SPACE 1                                                                
GRUPTAB  DS    0F                                                               
         DC    X'FF'                                                            
         EJECT                                                                  
*              ROUTINE TO BUILD A SKELETON KEY                                  
         SPACE 3                                                                
SKELETON NTR1                                                                   
         LA    R4,KEY                                                           
         USING CPKEYD,R4                                                        
         XC    KEY,KEY                                                          
         MVC   CPKMED,QMED                                                      
         IF    QRANGE,EQ,C'A',SK2                                               
         IF    QRANGE,EQ,C'B',SK4                                               
         IF    QRANGE,EQ,C'C',SK6                                               
         IF    QRANGE,EQ,C'G',SK8                                               
         IF    QRANGE,EQ,C'O',SK11                                              
         DC    H'0'                                                             
         SPACE 2                                                                
SK2      MVI   CPKTYPE,X'04'       AGENCY                                       
         MVC   CPKAGY,QAGY                                                      
         B     SK14                                                             
         SPACE 2                                                                
SK4      MVI   CPKTYPE,X'06'       BANK                                         
         B     SK14                                                             
         SPACE 2                                                                
SK6      MVI   CPKTYPE,X'02'       CLIENT                                       
         MVC   CPKAGY,QAGY                                                      
         MVC   CPKCLT,CLT                                                       
         CLI   OPTRDSEQ,C'M'                                                    
         BNE   SK14                                                             
         CLC   QCLT(3),=C'ALL'                                                  
         BNE   SK14                                                             
         XC    CPKCLT,CPKCLT                                                    
         B     SK14                                                             
         SPACE 2                                                                
SK8      MVI   CPKTYPE,X'08'       GROUP                                        
         LA    R2,GRUPTAB                                                       
         SPACE 2                                                                
SK10     CLC   QAGY,0(R2)                                                       
         BE    SK12                                                             
         LA    R2,4(R2)                                                         
         CLI   0(R2),X'FF'                                                      
         BNE   SK10                                                             
         B     SK4                                                              
         SPACE 2                                                                
SK11     MVC   CPKCLT(1),QCLOFFC                                                
         MVI   CPKTYPE,X'0A'       OFFICE                                       
         SPACE 2                                                                
SK12     MVC   CPKAGY,2(R2)                                                     
         SPACE 2                                                                
SK14     IF    QTARGET,=,SPACES,OR,QTARGET,GT,=C'240',SK16                      
         PACK  DUB,QTARGET                                                      
         CVB   R0,DUB                                                           
         STC   R0,CPKTARGT                                                      
         SPACE 2                                                                
SK16     IF    QSELECT,=,SPACES,OR,QSELECT,GT,=C'240',XIT                       
         PACK  DUB,QSELECT                                                      
         CVB   R0,DUB                                                           
         STC   R0,CPKDEMO                                                       
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINES TO EXTRACT MARKET & CLIENT DETAILS                      
         SPACE 3                                                                
DATAPOST NTR1                                                                   
         L     R4,ADDATA                                                        
         USING CPKEYD,R4                                                        
         CLC   MARKET,CPKMKT       DO THE MARKET DETAILS MATCH                  
         BE    DP6                                                              
         L     R2,ADMKTTAB                                                      
         L     R3,NMKTS                                                         
         SPACE 2                                                                
DP2      CLC   0(2,R2),CPKMKT      NO - FIND ITEM IN TABLE                      
         BE    DP4                                                              
         AH    R2,WIDTHMKT                                                      
         BCT   R3,DP2                                                           
         MVC   MARKET,CPKMKT       MISSING MARKET                               
         MVC   MKTRANK,=H'230'     FAKE IT                                      
         MVC   MKTNAME,=C'MARKET -        '                                     
         LA    RF,MKTNAME+10                                                    
         EDIT  CPKMKT,(3,(RF))                                                  
         B     DP6                                                              
         SPACE 2                                                                
DP4      MVC   MARKET,CPKMKT       AND EXTRACT                                  
         MVC   MKTRANK,2(R2)                                                    
         CLI   USERPROF,C'S'                                                    
         BNE   *+10                                                             
         MVC   MKTRANK,4(R2)                                                    
         MVC   MKTNAME,6(R2)                                                    
         SPACE 2                                                                
DP6      CLI   CPKTYPE,X'02'       FOR CLIENT LEVEL RECORDS,                    
         BNE   OK                                                               
         CLC   CPKCLT,CLIENT       DO THE CLIENT DETAILS FIT                    
         BE    OK                                                               
         L     R2,ADCLTBUF                                                      
         LA    R2,4(R2)                                                         
         L     R3,NCLTS                                                         
         SPACE 2                                                                
DP8      CLC   0(3,R2),CPKCLT      NO - FIND ITEM IN TABLE                      
         BE    DP10                                                             
         AH    R2,WIDTHCLT                                                      
         BCT   R3,DP8                                                           
         B     NOTOK                                                            
         SPACE 2                                                                
DP10     MVC   CLIENT,CPKCLT                                                    
         MVC   CLTNM,3(R2)                                                      
         MVC   CLTOFF,23(R2)                                                    
         B     OK                                                               
         EJECT                                                                  
*              ROUTINE TO SET UP PERIOD TABLE                                   
         SPACE 3                                                                
SETUPPER NTR1                                                                   
         LA    R2,PERTABLE                                                      
         USING CPERD,R2                                                         
         XCEF  (R2),384                                                         
         LA    R3,QSTART           FIRRST DO START                              
         CLI   0(R3),X'FA'                                                      
         BNE   *+8                                                              
         MVI   0(R3),C'0'                                                       
         CLI   4(R3),X'FA'                                                      
         BNE   *+8                                                              
         MVI   4(R3),C'0'                                                       
         LA    R4,SUPSTART                                                      
         LA    R5,2                                                             
         SPACE 2                                                                
*UP      PACK  DUB,0(2,R3)         CONVERT YEAR                                 
*        CVB   R0,DUB                                                           
*        CH    R0,=H'50'                                                        
*        BH    SUP0                                                             
*        AHI   R0,100                                                           
*UP0     DS    0C                                                               
*        STC   R0,0(R4)                                                         
*        PACK  DUB,2(2,R3)         CONVERT MONTH                                
*        CVB   R0,DUB                                                           
*        STC   R0,1(R4)                                                         
*        LA    R3,4(R3)            NOW DO END                                   
*        LA    R4,2(R4)                                                         
*        BCT   R5,SUP                                                           
* CONVERT DATE TO BINARY                                                        
SUP      MVC   DUB(4),0(R3)                                                     
         MVC   DUB+4(2),=C'01'                                                  
         GOTO1 DATCON,DMCB,(0,DUB),(3,FULL)                                     
         MVC   0(2,R4),FULL                                                     
         LA    R3,4(R3)                                                         
         LA    R4,2(R4)                                                         
         BCT   R5,SUP                                                           
*                                                                               
         MVC   CPSTARTB,SUPSTART                                                
         MVC   CPENDB,SUPEND                                                    
         MVI   NPERIODS+3,1                                                     
         CLI   FCMONTH,C'Q'        OPTION TO FORCE QUARTERS                     
         BE    SUP1                                                             
         CLI   FCMONTH,C'Y'        DO WE NEED PERIOD ANALYSIS ?                 
         BNE   SUP2                                                             
         LA    R3,1                TRY MONTHLY                                  
         BAS   RE,SUP8                                                          
         BE    SUP2                                                             
         SPACE 2                                                                
SUP1     LA    R3,3                NO GO - MUST BE QUARTERLY                    
         BAS   RE,SUP8                                                          
         SPACE 2                                                                
SUP2     L     R3,NPERIODS         NOW EDIT DATES                               
         SPACE 2                                                                
SUP4     LA    R4,CPSTARTB                                                      
         LA    R5,CPSTART                                                       
         BAS   RE,SUP6                                                          
         LA    R4,CPENDB                                                        
         LA    R5,CPEND                                                         
         BAS   RE,SUP6                                                          
         A     R2,WIDTHPER                                                      
         BCT   R3,SUP4                                                          
         XC    PROJDATE,PROJDATE   SET UP PROJECT FROM DATE                     
         CLC   QINDEX,SPACES                                                    
         BE    XIT                                                              
         CLI   QPROJECT,C' '                                                    
         BE    XIT                                                              
         PACK  DUB,QINDEX(2)                                                    
         CVB   R0,DUB                                                           
         STC   R0,PROJDATE                                                      
         PACK  DUB,QINDEX+2(2)                                                  
         CVB   R0,DUB                                                           
         STC   R0,PROJDATE+1                                                    
         B     XIT                                                              
         SPACE 2                                                                
SUP6     EDIT  (1,0(R4)),(2,3(R5))                                              
         ZIC   R1,1(R4)                                                         
         BCTR  R1,0                                                             
         MH    R1,=H'3'                                                         
         LA    R1,MONTHS(R1)                                                    
         MVC   0(3,R5),0(R1)                                                    
         BR    RE                                                               
         SPACE 2                                                                
SUP8     NTR1                                                                   
         XCEF  (R2),384                                                         
         MVC   CPSTARTB,SUPSTART                                                
         MVC   SUPDATE,SUPSTART                                                 
         MVI   NPERIODS+3,1                                                     
         SPACE 2                                                                
SUP10    MVC   CPENDB,CPSTARTB                                                  
         CLC   CPENDB,SUPEND                                                    
         BE    OK                                                               
         CH    R3,=H'1'                                                         
         BE    SUP12                                                            
         BAS   RE,BUMP                                                          
         MVC   CPENDB,SUPDATE                                                   
         CLC   CPENDB,SUPEND                                                    
         BE    OK                                                               
         BAS   RE,BUMP                                                          
         MVC   CPENDB,SUPDATE                                                   
         CLC   CPENDB,SUPEND                                                    
         BE    OK                                                               
         SPACE 2                                                                
SUP12    L     R1,NPERIODS                                                      
         CH    R1,=H'12'                                                        
         BE    NOTOK                                                            
         LA    R1,1(R1)                                                         
         ST    R1,NPERIODS                                                      
         BAS   RE,BUMP                                                          
         A     R2,WIDTHPER                                                      
         MVC   CPSTARTB,SUPDATE                                                 
         B     SUP10                                                            
         SPACE 2                                                                
BUMP     ZIC   R1,SUPDATE+1                                                     
         LA    R1,1(R1)                                                         
         STC   R1,SUPDATE+1                                                     
         CH    R1,=H'13'                                                        
         BCR   7,RE                                                             
         ZIC   R1,SUPDATE                                                       
         LA    R1,1(R1)                                                         
         STC   R1,SUPDATE                                                       
         MVI   SUPDATE+1,1                                                      
         BR    RE                                                               
         SPACE 2                                                                
SUPSTART DS    CL2                                                              
SUPEND   DS    CL2                                                              
SUPDATE  DS    CL2                                                              
         EJECT                                                                  
*              ROUTINE TO POST TO PERIOD TABLE                                  
         SPACE 2                                                                
POSTPER  NTR1                                                                   
         BAS   RE,CLEARPER                                                      
*                                  NEED EQIVALENCY FACTOR FOR RECORD            
         GOTO1 =V(CPEQUIV),DMCB,(RA)                                            
         MVI   ANYHITS,C'N'                                                     
         L     R4,ADDATA                                                        
         MVI   ELCODE,0                                                         
         BAS   RE,GETEL                                                         
         B     POST4                                                            
         SPACE 2                                                                
POST2    BAS   RE,NEXTEL                                                        
         SPACE 2                                                                
POST4    BE    POST6                                                            
         CLI   ANYHITS,C'Y'                                                     
         BE    OK                                                               
         B     NOTOK                                                            
         SPACE 2                                                                
POST6    CLI   0(R4),X'02'                                                      
         BNE   POST8                                                            
         USING CPDATAD,R4                                                       
         MVC   MKTWT,CPDMKTWT                                                   
         MVC   MKTWT,=H'1'         SET DEFAULT WEIGHT                           
*                                                                               
         SR    RE,RE               FORCE THE MARKET WEIGHT                      
         ICM   RE,3,MARKET         TO BE THE SAME FOR A RUN                     
         SH    RE,=H'400'                                                       
         STH   RE,HALF                                                          
         L     RE,=V(CPMWGHT)                                                   
POST7    CLI   0(RE),X'FF'         END OF TABLE                                 
         BE    POST2                                                            
         CLC   HALF,0(RE)          CORRECT MARKET                               
         BE    *+12                                                             
         LA    RE,4(RE)                                                         
         B     POST7                                                            
         MVC   MKTWT,2(RE)                                                      
*                                                                               
         CLC   MARKET,=H'568'                                                   
         BNE   *+10                                                             
         MVC   MKTWT,=H'1199'      FIX FOR ATLANTA                              
         B     POST2                                                            
         SPACE 2                                                                
POST8    CLI   0(R4),70                                                         
         BL    POST2                                                            
         USING CPPERFD,R4                                                       
         MVC   POSTDATE(1),CPPYEAR                                              
         MVC   POSTDATE+1(1),CPPMONTH                                           
         OC    PROJDATE,PROJDATE                                                
         BZ    POST10                                                           
         CLC   POSTDATE,PROJDATE                                                
         BNE   POST2                                                            
         BAS   RE,POSTUNPK                                                      
         BAS   RE,POSTPROJ                                                      
         B     OK                                                               
         SPACE 2                                                                
POST10   LA    R2,PERTABLE                                                      
         L     R3,NPERIODS                                                      
         USING CPERD,R2                                                         
         SPACE 2                                                                
POST12   CLC   POSTDATE,CPSTARTB                                                
         BL    POST14                                                           
         CLC   POSTDATE,CPENDB                                                  
         BH    POST14                                                           
         MVI   ANYHITS,C'Y'                                                     
         BAS   RE,POSTUNPK                                                      
*                                                                               
         L     RE,ADDATA                                                        
         USING CPKEYD,RE                                                        
         CLC   QPROG,=C'40'        FOR CPG REPORTS                              
         BE    *+10                                                             
         CLC   QPROG,=C'4T'                                                     
         BNE   *+10                                                             
         CLC   QAGY,=C'JW'         MAKE 15'S INTO 30'S                          
         BNE   *+8                 FOR JWT                                      
         CLI   CPKSPTLN,15         04/13/87                                     
         BNE   *+8                                                              
         BAS   RE,SPLT30                                                        
         DROP  RE                                                               
*                                                                               
         LA    R1,CPSPOTS                                                       
         LA    R5,WORK                                                          
         LA    R6,4                                                             
         SPACE 2                                                                
POST13   L     R0,0(R1)                                                         
         A     R0,0(R5)                                                         
         ST    R0,0(R1)                                                         
         LA    R1,4(R1)                                                         
         LA    R5,4(R5)                                                         
         BCT   R6,POST13                                                        
         B     POST2                                                            
         SPACE 2                                                                
POST14   A     R2,WIDTHPER                                                      
         BCT   R3,POST12                                                        
         B     POST2                                                            
*                                                                               
SPLT30   L     R1,WORK             MAKE 15 SEC INTO 30                          
         SRL   R1,1                                                             
         ST    R1,WORK             SPOTS                                        
         L     R1,WORK+8                                                        
         SRL   R1,1                                                             
         ST    R1,WORK+8           POINTS                                       
         L     R1,WORK+12                                                       
         SRL   R1,1                                                             
         ST    R1,WORK+12          IMPS                                         
         MVC   EQVFACT,=F'1000'                                                 
         BR    RE                                                               
         EJECT                                                                  
*              ROUTINE TO READ PROJECTION FORMULAE                              
         SPACE 3                                                                
SETPROJ  NTR1                                                                   
         OC    PROJDATE,PROJDATE                                                
         BZ    XIT                                                              
         LA    R4,KEY                                                           
         USING CTYREC,R4                                                        
         XC    CTYKEY,CTYKEY       BUILD BASIC KEY                              
         MVI   CTYKTYP,C'Y'                                                     
         MVC   CTYKAGY,QAGY              AGENCY                                 
         MVC   CTYKFORM,QPROJECT         FORMULA CODE                           
         MVC   CTYKYEAR(2),PROJDATE      BASE Y/M                               
         LA    R5,PROJBASE                                                      
         BAS   RE,FACTOUT                                                       
         MVC   PROJFACT,PROJBASE                                                
         OC    PROJBASE,PROJBASE                                                
         BNZ   SETPROJ2                                                         
         MVC   PROJFACT,=H'1'                                                   
         MVC   PROJBASE,PROJFACT                                                
         B     XIT                                                              
         SPACE 2                                                                
SETPROJ2 LA    R2,PERTABLE                                                      
         L     R3,NPERIODS                                                      
         USING CPERD,R2                                                         
         LA    R5,PROJFACT                                                      
         SPACE 2                                                                
SETPROJ4 MVC   CTYKYEAR(2),CPSTARTB                                             
         BAS   RE,FACTOUT                                                       
         A     R2,WIDTHPER                                                      
         LA    R5,2(R5)                                                         
         BCT   R3,SETPROJ4                                                      
         B     XIT                                                              
         SPACE 2                                                                
FACTOUT  NTR1                                                                   
         L     R4,=V(CPDTABUF)                                                  
         MVC   0(25,R4),KEY                                                     
         GOTO1 DATAMGR,DMCB,(DMINBTS,DMREAD),=C'CTFILE',               X        
               (R4),(R4),(0,DMWORK)                                             
         CLI   DMCB+8,0                                                         
         BNE   XIT                                                              
         LA    R4,28(R4)                                                        
         SPACE 2                                                                
FACTOUT2 CLI   0(R4),0             RECORDS OK - DIG OUT FACTOR                  
         BE    XIT                                                              
         CLI   0(R4),X'78'                      FROM X'78' ELEMENT              
         BNE   FACTOUT4                                                         
         USING CTPFD,R4                                                         
         MVC   0(2,R5),CTPFACT                                                  
         B     XIT                                                              
         SPACE 2                                                                
FACTOUT4 ZIC   R3,1(R4)                                                         
         AR    R4,R3                                                            
         B     FACTOUT2                                                         
         EJECT                                                                  
*              SUBSIDIARY ROUTINES FOR POSTING                                  
         SPACE 3                                                                
CLEARPER NTR1                                                                   
         LA    R2,PERTABLE         CLEAR TABLE                                  
         L     R3,NPERIODS                                                      
         SPACE 2                                                                
         USING CPERD,R2                                                         
CLEARP2  XC    CPSPOTS(16),CPSPOTS                                              
         A     R2,WIDTHPER                                                      
         BCT   R3,CLEARP2                                                       
         B     XIT                                                              
         SPACE 2                                                                
POSTUNPK NTR1                                                                   
         USING CPPERFD,R4                                                       
         LA    R2,CPPSPOTS         CONVERT ELEMENT TO 4 FULL-WORDS              
         LA    R3,WORK                                  IN WORK                 
         LA    R5,4                                                             
         SPACE 2                                                                
POSTUN2  SR    R1,R1                                                            
         ICM   R1,3,0(R2)                                                       
         PRINT GEN                                                              
         XUNPK                                                                  
         PRINT NOGEN                                                            
         ST    R1,0(R3)                                                         
         LA    R2,2(R2)                                                         
         LA    R3,4(R3)                                                         
         BCT   R5,POSTUN2                                                       
         B     XIT                                                              
         SPACE 2                                                                
POSTPROJ NTR1                                                                   
         LA    R2,PERTABLE         PROJECT DATA                                 
         L     R3,NPERIODS                                                      
         USING CPERD,R2                                                         
         LA    R4,PROJFACT                                                      
         SPACE 2                                                                
POSTPR2  BAS   RE,POSTPR4                                                       
         A     R2,WIDTHPER                                                      
         LA    R4,2(R4)                                                         
         BCT   R3,POSTPR2                                                       
         B     XIT                                                              
         SPACE 2                                                                
POSTPR4  NTR1                                                                   
         MVC   CPSPOTS(16),WORK                                                 
         LH    R0,PROJBASE                                                      
         SPACE 2                                                                
POSTPR6  LH    RF,0(R4)            (FACTOR)                                     
         M     RE,WORK+4           PROJECT DOLLARS                              
         SLDA  RE,1                                                             
         DR    RE,R0                                                            
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         ST    RF,CPCASH                                                        
         B     XIT                                                              
         SPACE 2                                                                
POSTDATE DS    CL2                                                              
PROJDATE DS    CL2                                                              
ANYHITS  DS    CL1                                                              
         EJECT                                                                  
*                   ROUTINE TO GO TO APPLICATION PROGRAMS                       
         SPACE 2                                                                
GO       NTR1                                                                   
         CLI   RCTRACE,C'Y'                                                     
         BNE   GO2                                                              
         MVC   P,SPACES                                                         
         MVC   P(10),=C'MODE=X''  '''                                           
         MVI   SKIPSPEC,C'Y'                                                    
         GOTO1 HEXOUT,DMCB,MODE,P+7,1,=C'N'                                     
         BAS   RE,GETMODE                                                       
         GOTO1 REPORT                                                           
         SPACE 2                                                                
GO2      EQU   *                                                                
         GOTO1 APPLIC,DMCB,WORKC                                                
         B     XIT                                                              
         EJECT                                                                  
*              ROUTINE TO EXPAND MODE NAME                                      
         SPACE 3                                                                
GETMODE  MVC   P+20(8),=C'UNKNOWN '                                             
         LA    RF,MODETAB                                                       
         SPACE 2                                                                
GETMODE2 CLC   MODE,0(RF)                                                       
         BE    GETMODE4                                                         
         CLI   0(RF),X'FF'                                                      
         BCR   8,RE                                                             
         LA    RF,9(RF)                                                         
         B     GETMODE2                                                         
         SPACE 2                                                                
GETMODE4 MVC   MODEALPH,1(RF)                                                   
         MVC   P+20(8),1(RF)                                                    
         BR    RE                                                               
         SPACE 2                                                                
MODETAB  DS    0C                                                               
         DC    AL1(10),CL8'RUNFRST '                                            
         DC    AL1(15),CL8'REQFRST '                                            
         DC    AL1(20),CL8'CLTFRST '                                            
         DC    AL1(25),CL8'DEMFRST'                                             
         DC    AL1(30),CL8'MKTFRST'                                             
         DC    AL1(60),CL8'PROCDATA'                                            
         DC    AL1(140),CL8'MKTLAST'                                            
         DC    AL1(145),CL8'DEMLAST'                                            
         DC    AL1(150),CL8'CLTLAST '                                           
         DC    AL1(155),CL8'REQLAST '                                           
         DC    AL1(160),CL8'RUNLAST '                                           
*                                                                               
         DC    AL1(253),CL8'DISKERR '                                           
         DC    AL1(254),CL8'GOTONXTR'                                           
*                                                                               
         DC    X'FF'                                                            
SVQCLOFF DC    C' '                                                             
SVAGY    DS    CL2                                                              
AGYLIST  DC    F'0'                                                             
TRACYTAB DC    C'TR'                                                            
         DC    C'NE'                                                            
         DC    X'FF'                                                            
*                                                                               
H7TAB    DC    C'JW'                                                            
         DC    C'OM'                                                            
         DC    C'H7'                                                            
         DC    X'FF'                                                            
*                                                                               
AGYTAB   DC    C'AC'                                                            
         DC    C'AL'                                                            
         DC    C'BB'                                                            
         DC    C'BD'                                                            
         DC    C'BJ'                                                            
         DC    C'BN'                                                            
         DC    C'BS'                                                            
         DC    C'BW'                                                            
         DC    C'CA'                                                            
         DC    C'CE'                                                            
         DC    C'CH'                                                            
         DC    C'COCZ'                                                          
         DC    C'DE'                                                            
         DC    C'DFFM'                                                          
         DC    C'FC'                                                            
         DC    C'GA'                                                            
         DC    C'HC'                                                            
         DC    C'HE'                                                            
         DC    C'HR'                                                            
         DC    C'JM'                                                            
         DC    C'JW'                                                            
         DC    C'KA'                                                            
         DC    C'LC'                                                            
         DC    C'LE'                                                            
         DC    C'OGRRSSRS'                                                      
         DC    C'LG'                                                            
         DC    C'LH'                                                            
         DC    C'LM'                                                            
         DC    C'NE'                                                            
         DC    C'H7'                                                            
         DC    C'MC'                                                            
         DC    C'MN'                                                            
         DC    C'NE'                                                            
         DC    C'NW'                                                            
         DC    C'OM'                                                            
         DC    C'QJ'                                                            
         DC    C'RP'                                                            
         DC    C'SC'                                                            
         DC    C'SH'                                                            
         DC    C'SW'                                                            
         DC    C'TK'                                                            
         DC    C'TRUB'                                                          
         DC    C'WE'                                                            
         DC    C'WI'                                                            
         DC    C'WL'                                                            
         DC    C'YN'                                                            
         DC    C'YR'                                                            
         DC    X'FF'                                                            
         EJECT                                                                  
AGYTABCN DC    C'NT'               CANADIAN BANK AGENCIES                       
         DC    C'SM'                                                            
         DC    C'MW'                                                            
         DC    C'VA'                                                            
         DC    C'VR'                                                            
         DC    C'FT'                                                            
         DC    C'BA'                                                            
         DC    C'SA'                                                            
         DC    C'YR'                                                            
         DC    C'BE'                                                            
         DC    C'ME'                                                            
         DC    C'CY'                                                            
         DC    C'GR'                                                            
         DC    C'RC'                                                            
         DC    C'PV'                                                            
         DC    C'GT'                                                            
         DC    X'FF'                                                            
         EJECT                                                                  
*                   LITERAL POOL FOR PROGRAM                                    
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*              DSECT FOR MONACC                                                 
         SPACE 3                                                                
MONARCHD DSECT                                                                  
TRACEKEY DS    CL32                                                             
THISKEY  DS    CL32                                                             
TRACEDM8 DS    CL1                                                              
FT1      DS    CL1                                                              
FT2      DS    CL1                                                              
FT3      DS    CL1                                                              
DEPTH    DS    CL1                                                              
SAVEMODE DS    CL1                                                              
BOOKIO   DS    CL80                                                             
INSW     DS    CL1                                                              
INGROUP  DS    CL1                                                              
*        PRINT OFF                                                              
       ++INCLUDE CTGENFILE                                                      
       ++INCLUDE DDMASTD                                                        
       ++INCLUDE CPREPWORKD                                                     
       ++INCLUDE CPGENFILE                                                      
       ++INCLUDE CPREPMODES                                                     
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'137CPREPFILM 05/10/05'                                      
         END                                                                    
