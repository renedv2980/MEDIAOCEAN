*          DATA SET DDACCESS   AT LEVEL 041 AS OF 12/22/20                      
*CATALP ACCESS                                                                  
DDACCESS TITLE ' - SECURITY ACCESS INTERFACE!'                                  
ACCESS   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 WORKX-WORKD,**ACCS**,CLEAR=YES,RA,R9,RR=RE                       
         USING WORKD,RC            RC=A(W/S)                                    
         ST    RE,RELO                                                          
         LR    R8,R1                                                            
         USING ACCPARMD,R8         R8=A(PARAMETER LIST)                         
         ICM   R7,15,ACCPDATA                                                   
         USING ACCDATAD,R7         R7=A(ACCESS DATA AREA)                       
*                                                                               
         PROT  OFF                 DISABLE CALLER'S STORAGE PROTECTION          
*                                                                               
         BRAS  RE,INITIAL          GENERAL INITIALISATION                       
*                                                                               
         MVC   ACTN,ACCPACTN       SET ACTION                                   
         CLI   ACTN,0                                                           
         BH    *+6                                                              
         DC    H'0'                ACTION IS UNDEFINED                          
         CLI   ACTN,ACCPUNDF                                                    
         BL    *+6                                                              
         DC    H'0'                ACTION IS UNDEFINED                          
*                                                                               
         XR    RF,RF                                                            
         IC    RF,ACTN                                                          
         SLL   RF,2                                                             
         B     *(RF)                                                            
         B     IPCHACT             01 - ACCPIP                                  
         B     UAUTACT             02 - ACCPUSER                                
         B     PAUTACT             03 - ACCPAUTH                                
         B     PACCACT             04 - ACCPPACC                                
         B     CPWDACT             05 - ACCPCP                                  
         B     SSRVACT             06 - ACCSSRV                                 
         B     ACSAACT             07 - ACCCLAA - CLIENT ACCESS AUTH            
         B     ACSAACT             08 - ACCGAIN - GENERAL ACCESS INFO           
                                                                                
*                                                                               
ACCRETN  MVC   ACCPRC,RETCODE                                                   
         MVC   ACCPRS,REASCODE+1                                                
         B     ACCRETX                                                          
*                                                                               
ACCRETY  MVI   ACCPRC,ACRCOK       VALID                                        
*                                                                               
ACCRETX  EQU   *                                                                
         PROT  ON                  RESTORE CALLER'S STORAGE PROTECTION          
         CLI   ACCPRC,ACRCOK       SET CC FOR CALLER (EQUAL=OK)                 
EXIT     XIT1                                                                   
                                                                                
***********************************************************************         
* GENERAL INITIALISATION                                              *         
***********************************************************************         
INITIAL  NTR1                                                                   
*                                                                               
         MVI   DDSUSER,C'N'                                                     
         MVI   SFLAG,C'N'                                                       
         XC    RETCODE,RETCODE                                                  
         XC    REASCODE,REASCODE                                                
         LA    R0,WORKD                                                         
         AH    R0,=Y(IOAREA-WORKD)                                              
         ST    R0,AIOAREA                                                       
         LA    R0,WORKD                                                         
         AH    R0,=Y(UTLSAVE-WORKD)                                             
         ST    R0,AUTLSAVE                                                      
         LA    R0,WORKD                                                         
         AH    R0,=Y(TCBSAVE-WORKD)                                             
         ST    R0,ATCBSAVE                                                      
         LA    R0,WORKD                                                         
         AH    R0,=Y(SECBLOC-WORKD)                                             
         ST    R0,ASECBLOC                                                      
*                                                                               
         ICM   RF,15,ACCPSYS                                                    
         BZ    INIT010                                                          
         ST    RF,APARMS                                                        
         USING SRPARMD,RF                                                       
         MVC   ASYSFAC,SRQASYSF                                                 
         MVC   ATIA,SRQATIA                                                     
         MVC   AUTL,SRQAUTL                                                     
         MVC   ACOMFACS,SRQACOMF                                                
         MVC   ASELIST,SRQASEL                                                  
         MVC   ATWA,SRQATWA                                                     
         MVC   AMAP,SRQAMAP                                                     
         MVC   ATIOB,SRQATIOB                                                   
         L     RF,ASYSFAC                                                       
         L     RE,VDMOD000-SYSFACD(RF)                                          
         ST    RE,ADMOD000                                                      
         L     RE,VFINDSYS-SYSFACD(RF)                                          
         ST    RE,AFINDSYS                                                      
         L     RE,VSSB-SYSFACD(RF)                                              
         ST    RE,ASSB                                                          
         L     RE,SSBTKADR-SSBD(RE)                                             
         ST    RE,ATCBTASK                                                      
         DROP  RF                                                               
         MVC   ASAVE,ACCPSAVE                                                   
         MVC   SAVESCRN,ACCPSCRN                                                
         MVC   SAVELEN,ACCPSLEN                                                 
         L     RF,ASYSFAC                                                       
         L     RE,VSYSFAC0-SYSFACD(RF)                                          
         ST    RE,ACOMFACS                                                      
         USING COMFACSD,RE                                                      
         MVC   ADATAMGR,CDATAMGR                                                
         MVC   ADATCON,CDATCON                                                  
         MVC   ACALLOV,CCALLOV                                                  
         MVC   ASECRET,CSECRET                                                  
         MVC   AHEXOUT,CHEXOUT                                                  
         MVC   ASWITCH,CSWITCH                                                  
         MVC   ASCANNER,CSCANNER                                                
         MVC   AHEXIN,CHEXIN                                                    
         MVC   AHELLO,CHELLO                                                    
         MVC   AJESMAIL,CJESMAIL                                                
         MVC   AOFFLAL,ACCDAOFL                                                 
         MVC   ADICTATE,CDICTATE                                                
*&&UK*&& MVC   ALIMACC,CLIMACC                                                  
         DROP  RE                                                               
         ICM   R0,15,=XL4'D9000ABC'                                             
         GOTO1 ACALLOV,PARM,0,(R0)                                              
         CLI   4(R1),X'FF'                                                      
         BE    *+10                                                             
         MVC   ARCPACK,0(R1)                                                    
         B     INITX                                                            
         B     INIT030                                                          
*                                                                               
INIT010  EQU   *                                                                
         CLI   OFFLMODE,C' '      TEST OFFLINE PROCESSING INITIALISED           
         BNE   INIT020                                                          
         ICM   RF,15,=V(CALLOV)                                                 
         ST    RF,ACALLOV                                                       
         BRAS  RE,INITMAST                                                      
         BRAS  RE,INITSFAC                                                      
*                                                                               
INIT020  EQU   *                                                                
         L     RF,CSYSFAC                                                       
         ST    RF,ASYSFAC                                                       
*                                                                               
INIT030  EQU   *                                                                
         L     RF,ASYSFAC                                                       
         L     RE,VSYSFAC0-SYSFACD(RF)                                          
         ST    RE,ACOMFACS                                                      
         USING COMFACSD,RE                                                      
         MVC   ADATAMGR,CDATAMGR                                                
         MVC   ADATCON,CDATCON                                                  
         MVC   ACALLOV,CCALLOV                                                  
         MVC   ASECRET,CSECRET                                                  
         MVC   AHEXOUT,CHEXOUT                                                  
         MVC   AHEXIN,CHEXIN                                                    
         DROP  RE                                                               
         L     RE,VSSB-SYSFACD(RF)                                              
         ST    RE,ASSB                                                          
         L     RE,VTCB-SYSFACD(RF)                                              
         ST    RE,ATCB                                                          
         L     RE,VUTL-SYSFACD(RF)                                              
         ST    RE,AUTLTAB                                                       
         MVC   ALCM,VLCM-SYSFACD(RF)                                            
         L     RE,ASSB                                                          
         L     RE,SSBTKADR-SSBD(RE)                                             
         ST    RE,ATCBTASK                                                      
         L     RF,TCBUTL-TCBD(RE)                                               
         ST    RF,AUTL                                                          
         L     RF,TCBTWA-TCBD(RE)                                               
         ST    RF,ATWA                                                          
         L     RF,TCBTIA-TCBD(RE)                                               
         ST    RF,ATIA                                                          
*                                                                               
         GOTO1 ADATCON,PARM,(5,0),(0,WORK)                                      
         PACK  DUB(2),WORK+4(2)                                                 
         ICM   RE,3,DUB                                                         
         SRL   RE,4                                                             
         STC   RE,DAYTODAY                                                      
         GOTOR (RF),(R1),(0,WORK),(10,DATE)                                     
         MVI   CUCTRY,0                                                         
         LA    RF,SRPARMS                                                       
         ST    RF,APARMS                                                        
         USING SRPARMD,RF                                                       
         MVC   SRQASYSF,ASYSFAC                                                 
         MVC   SRQATIA,ATIA                                                     
         MVC   SRQAUTL,AUTL                                                     
         MVC   SRQACOMF,ACOMFACS                                                
         MVC   SRQASEL,ASELIST                                                  
         MVC   SRQATWA,ATWA                                                     
         MVC   SRQAMAP,AMAP                                                     
         MVC   SRQATIOB,ATIOB                                                   
         DROP  RF                                                               
*                                                                               
INITX    J     EXIT                                                             
                                                                                
***********************************************************************         
* INITIALISE DB2EXE MASTC REFERENCE - FAKE UP IF TSO BATCH            *         
***********************************************************************         
INITMAST NTR1                                                                   
*                                                                               
         ICM   RF,15,=V(MASTC)                                                  
         BZ    IMAS010                                                          
         STCM  RF,15,AMASTC                                                     
         MVI   OFFLMODE,OMMASTQ                                                 
         B     IMASX                                                            
*                                                                               
IMAS010  EQU   *                                                                
         MVI   OFFLMODE,OMTSOBQ                                                 
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         STCM  R1,15,AMASTC                                                     
*                                                                               
         LR    RE,R1                                                            
         LR    R1,R0                                                            
         BCTR  R1,0                                                             
         LA    R0,*                                                             
         L     RF,=F'0'                                                         
         MVCL  RE,R0                                                            
*                                                                               
         ICM   R1,15,AMASTC                                                     
         USING MASTD,R1                                                         
         ICM   RF,15,=V(DATAMGR)                                                
         STCM  RF,15,MCVDMGR                                                    
         ICM   RF,15,=V(DATCON)                                                 
         STCM  RF,15,MCVDTCON                                                   
         ICM   RF,15,=V(DICTATE)                                                
         STCM  RF,15,MCVDICT                                                    
         ICM   RF,15,=V(GETTXT)                                                 
         STCM  RF,15,MCVGETXT                                                   
         ICM   RF,15,=V(HEXIN)                                                  
         STCM  RF,15,MCVHEXIN                                                   
         ICM   RF,15,=V(HEXOUT)                                                 
         STCM  RF,15,MCVHEXOU                                                   
         ICM   RF,15,=V(PRINT)                                                  
         STCM  RF,15,MCVPRINT                                                   
         ICM   RF,15,=V(LOADER)                                                 
         STCM  RF,15,MCVLOADR                                                   
         DROP  R1                                                               
*                                                                               
IMASX    J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* INITIALISE OFFLINE SYS FACS                                         *         
***********************************************************************         
                                                                                
INITSFAC NTR1                                                                   
         ICM   R0,15,=AL4(TWAMAX)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATIA                                                          
*                                                                               
         ICM   R0,15,=AL4(TWAMAX)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATWA                                                          
*                                                                               
         ICM   R0,15,=AL4(TWAMAX)                                               
         STCM  R0,7,SAVELEN                                                     
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ASAVE                                                         
*                                                                               
         ICM   R0,15,=AL4(TUTLXALN)                                             
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,AUTL                                                          
*                                                                               
         ICM   R0,15,=AL4(200000)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATCBTASK                                                      
*                                                                               
         ICM   R0,15,=AL4(200000)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,AUTLTAB                                                       
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATCB                                                          
*                                                                               
         ICM   R0,15,=AL4(200000)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ASELIST                                                       
*                                                                               
         ICM   R0,15,=AL4(200000)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,AMAP                                                          
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATIOB                                                         
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ASSB                                                          
         USING SSBD,R1                                                          
         MVI   SSBSTAT2,X'02'                                                   
         MVC   SSBTKADR,ATCBTASK                                                
         DROP  R1                                                               
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ACOMFACS                                                      
         USING COMFACSD,R1                                                      
         MVC   CCALLOV,ACALLOV                                                  
         ICM   RE,15,AMASTC                                                     
         USING MASTD,RE                                                         
         MVC   CDATAMGR,MCVDMGR                                                 
         MVC   CDATCON,MCVDTCON                                                 
         MVC   CHEXOUT,MCVHEXOU                                                 
         MVC   CHEXIN,MCVHEXIN                                                  
         MVC   CDICTATE,MCVDICT                                                 
         MVC   CGETTXT,MCVGETXT                                                 
         DROP  R1,RE                                                            
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         STCM  R1,15,ASYSFAC                                                    
         USING SYSFACD,R1                                                       
         MVC   VUTL,AUTLTAB                                                     
         MVC   VTCB,ATCB                                                        
         MVC   VSSB,ASSB                                                        
         MVC   VSYSFAC0,ACOMFACS                                                
         DROP  R1                                                               
*                                                                               
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* IP CHECK ACTION                                                     *         
***********************************************************************         
                                                                                
IPCHACT  EQU   *                                                                
         LA    RE,ADIPRD                                                        
         ICM   RF,15,=AL4(ADIPRDLQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
         NI    ACCDINDS,X'FF'-ACCDIIV                                           
         MVI   ADIPFLAG,C'N'                                                    
         BRAS  RE,VALIP                                                         
         BNE   IPCHNO                                                           
*                                                                               
         BRAS  RE,GETIPD                                                        
         BNE   IPCHNO                                                           
         MVI   ADIPFLAG,C'Y'                                                    
         OI    ACCDINDS,ACCDIIV                                                 
         B     IPCHOK                                                           
*                                                                               
IPCHNO   B     ACCRETN                                                          
IPCHOK   B     ACCRETY                                                          
         EJECT                                                                  
                                                                                
***********************************************************************         
* USER AUTHENTICATION ACTION                                          *         
***********************************************************************         
UAUTACT  EQU   *                                                                
*                                                                               
         LA    RE,ADUARD                                                        
         ICM   RF,15,=AL4(ADUARDLQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
         NI    ACCDINDS,X'FF'-ACCDIUV                                           
         MVC   ACCDSYS,=CL7'CON'                                                
         MVC   ACCDPGM,=CL7'MAD'                                                
         MVI   ADUAFLAG,C'N'                                                    
*                                                                               
         BRAS  RE,VALDDS                                                        
         BNE   UAUTNO                                                           
         BRAS  RE,LOADCT                                                        
         BNE   UAUTNO                                                           
         BRAS  RE,GETUAV                                                        
         BNE   UAUTNO                                                           
*                                                                               
         OC    ADPAPID,ADPAPID                                                  
         BZ    UAUT010                                                          
         CLC   ADPAPID,SPACES                                                   
         BE    UAUT010                                                          
*                                                                               
         GOTO1 LOADNUM,PARM,PIDNUM,ADUAPIN,L'ADUAPIN                            
         GOTO1 LOADNUM,PARM,UIDNUM,ADUAUIN,L'ADUAUIN                            
         GOTO1 LOADNUM,PARM,AGRNUM,ADUAAGNU,L'ADUAAGNU                          
*                                                                               
         BRAS  RE,VALUIP                                                        
         BNE   UAUTNO                                                           
         GOTO1 VALSYP,ADPAPID                                                   
         BNE   UAUTNO                                                           
         BRAS  RE,VALPAC                                                        
         BNE   UAUTNO                                                           
*                                                                               
         L     R3,ASSB                                                          
         TM    SSBSYSFL-SSBD(R3),X'80' TEST SYSTEM?                             
         BO    UAUT010                 YES: SKIP PRISMA CHECK                   
         CLC   =C'04FA',ADPAPID        PRINT/PRISMA OR MED/PRISMA?              
         BNE   UAUT010                 NO: CONTINUE                             
         CLC   READPID#,PIDNUM         MEDIAOCEAN INTERNAL PID                  
         BNE   UAUT010                 NO: CONTINUE                             
         LA    RE,ACRSPAE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     UAUTNO                                                           
*                                                                               
UAUT010  MVI   ADUAFLAG,C'Y'                                                    
         OI    ACCDINDS,ACCDIUV                                                 
         B     UAUTOK                                                           
*                                                                               
UAUTNO   B     ACCRETN                                                          
UAUTOK   B     ACCRETY                                                          
         EJECT                                                                  
***********************************************************************         
* PROGRAM AUTHORISATION ACTION                                        *         
***********************************************************************         
PAUTACT  BRAS  RE,SAVEUTL                                                       
*                                                                               
         LA    RE,ADPARD                                                        
         ICM   RF,15,=AL4(ADPARDLQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
         NI    ACCDINDS,X'FF'-ACCDIPA                                           
         MVI   ADPAFLAG,C'N'                                                    
*                                                                               
         OC    ADUAPIN,ADUAPIN                                                  
         BZ    PAUT010                                                          
         CLC   ADUAPIN,SPACES                                                   
         BE    PAUT010                                                          
*                                                                               
         CLC   ADUAPAID,SPACES     DO WE HAVE AN AGENCY FOR THE PERSON?         
         BH    PAUT020             YES                                          
         MVC   ADUAPAID,ADUASAID   NO: WE'RE GOING TO NEED IT                   
         B     PAUT020                                                          
*                                                                               
PAUT010  BRAS  RE,GETUID                                                        
         BNE   PAUTNO                                                           
         MVC   ADUASAID,ADUAUAID                                                
         MVC   ADUAPAID,ADUAUAID                                                
         BRAS  RE,GETACC                                                        
         BNE   PAUTNO                                                           
         BRAS  RE,GETPIN                                                        
         BNE   PAUTNO                                                           
*                                                                               
PAUT020  GOTO1 LOADNUM,PARM,PIDNUM,ADUAPIN,L'ADUAPIN                            
         GOTO1 LOADNUM,PARM,UIDNUM,ADUAUIN,L'ADUAUIN                            
         GOTO1 LOADNUM,PARM,AGRNUM,ADUAAGNU,L'ADUAAGNU                          
*                                                                               
         CLC   PIDNUM,=H'4096'     DDS PERSON NUMBERS ARE LOW VALUES            
         JNL   *+10                MUST OVERRIDE IF NECESSARY                   
*&&UK*&& MVC   ADUAPAID,=C'#E'                                                  
*&&US*&& MVC   ADUAPAID,=C'#N'                                                  
*                                                                               
         TM    ACCDINDS,ACCDIUVR   DO WE WANT USER VALIDATION                   
         BZ    PAUT030             NO: SKIP IT                                  
         NI    ACCDINDS,X'FF'-ACCDIUVR                                          
         BRAS  RE,VALIDPER         CHECK PERSON & USER ID COMPATIBLE            
         BNE   PAUTNO                                                           
*                                                                               
PAUT030  GOTO1 VALSYP,ADPAPID                                                   
         BNE   PAUTNO                                                           
*                                                                               
         BRAS  RE,VALPAC                                                        
         BNE   PAUTNO                                                           
*                                                                               
         L     R3,AUIDSYS                                                       
         USING CTSYSD,R3                                                        
         MVC   SESYSN,CTSYSSE                                                   
         DROP  R3                                                               
*                                                                               
         MVC   ADPAADV,SPACES                                                   
         BRAS  RE,GETADV                                                        
         BNE   PAUTNO                                                           
         MVC   ADPAADV,ADVID                                                    
*                                                                               
         GOTO1 AHEXOUT,PARM,SESYSN,ADPASEN,1,=C'TOG'                            
*                                                                               
         OC    AGRNUM,AGRNUM                                                    
         BZ    *+12                                                             
         BRAS  RE,LOADSEC                                                       
         BNE   PAUTNO                                                           
*                                                                               
         MVI   ADPAFLAG,C'Y'                                                    
         OI    ACCDINDS,ACCDIPA                                                 
         B     PAUTOK                                                           
*                                                                               
PAUTNO   B     ACCRETN                                                          
PAUTOK   B     ACCRETY                                                          
                                                                                
***********************************************************************         
* PROGRAM ACCESS ACTION                                               *         
***********************************************************************         
PACCACT  LA    RE,ADUAPAD                                                       
         ICM   RF,15,=AL4(ADUAPALQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
*                                                                               
         GOTO1 LOADNUM,PARM,PIDNUM,ADUAPIN,L'ADUAPIN                            
         GOTO1 LOADNUM,PARM,UIDNUM,ADUAUIN,L'ADUAUIN                            
*                                                                               
         BRAS  RE,VALPAL                                                        
         BNE   PACCNO                                                           
*                                                                               
         MVC   ADUAPACL,ADPAPID                                                 
         B     PACCOK                                                           
*                                                                               
PACCNO   B     ACCRETN                                                          
PACCOK   B     ACCRETY                                                          
                                                                                
***********************************************************************         
* OLD PROGRAM AUTHORISATION ACTION                                    *         
***********************************************************************         
PAUTOLD  NI    ACCDINDS,X'FF'-ACCDIUV                                           
         BRAS  RE,LOADCT                                                        
         BNE   POLDNO                                                           
*                                        TEST IF CONNECT SUCCESFUL              
         L     RE,AUTLSAVE                                                      
         OC    TSVCREQ-UTLD(L'TSVCREQ,RE),TSVCREQ-UTLD(RE)                      
         BNZ   POLDOK                                                           
         OI    ACCDINDS,ACCDIUV                                                 
*                                                                               
         BRAS  RE,LOADSEC                                                       
         BNE   POLDNO                                                           
         B     POLDOK                                                           
*                                                                               
POLDNO   B     ACCRETN                                                          
POLDOK   B     ACCRETY                                                          
         EJECT                                                                  
                                                                                
***********************************************************************         
* CHANGE PASSWORD ACTION                                                        
***********************************************************************         
CPWDACT  DS    0H                                                               
         LA    RE,ADUARD                                                        
         ICM   RF,15,=AL4(ADUARDLQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
         NI    ACCDINDS,X'FF'-ACCDIUV                                           
         MVI   ADUAFLAG,C'N'                                                    
*                                                                               
         BRAS  RE,VALDDS                                                        
         BNE   CPWDNO                                                           
         CLI   ADIPADRL,0          IP ADDRESS PROVIDED                          
         BE    CPWD010             NO: SKIP CHECK                               
         BRAS  RE,VALUIP                                                        
         BNE   CPWDNO                                                           
*                                                                               
CPWD010  BRAS  RE,GETUID           GET USER ID INFORMATION                      
         BNE   CPWDNO                                                           
         MVC   ADUASAID,ADUAUAID                                                
         MVC   ADUAPAID,ADUAUAID                                                
*                                                                               
         BRAS  RE,GETACC           GET AGENCY ACCESS INFORMATION                
         BNE   CPWDNO                                                           
*                                                                               
         CLC   ADUAUAID,ADUASAID   SECURITY AGENCY INFO IF NECESSARY            
         BE    *+12                NO NEED IF SAME AGENCY                       
         BRAS  RE,GETSAC           GET INFO FROM SECURITY AGENCY                
         BNE   CPWDNO                                                           
*                                                                               
         BRAS  RE,GETPIN           GET PERSON ID NUMBER INFORMATION             
         BNE   CPWDNO                                                           
*                                                                               
         GOTO1 LOADNUM,PARM,PIDNUM,ADUAPIN,L'ADUAPIN                            
         GOTO1 LOADNUM,PARM,UIDNUM,ADUAUIN,L'ADUAUIN                            
         GOTO1 LOADNUM,PARM,AGRNUM,ADUAAGNU,L'ADUAAGNU                          
*                                                                               
         CLC   ADUAPWD,=CL10'R E S E T '  OLD PASSWORD                          
         BNE   CPWD020                                                          
         CLC   ADNPWD,=CL10'R A N D OM'   NEW PASSWORD                          
         BNE   CPWD020                                                          
*                                                                               
         BRAS  RE,FORGOTPW                FORGOT PASSWORD                       
         BE    CPWD030                                                          
         B     CPWDNO                                                           
*                                                                               
CPWD020  BRAS  RE,LOADPASS         LOAD AND CALL =PASS                          
         BNE   CPWDNO                                                           
*                                                                               
CPWD030  MVI   ADUAFLAG,C'Y'                                                    
         OI    ACCDINDS,ACCDIUV                                                 
         B     CPWDOK                                                           
*                                                                               
CPWDNO   B     ACCRETN                                                          
CPWDOK   B     ACCRETY                                                          
                                                                                
***********************************************************************         
* SYSTEM SERVICE ACTION                                               *         
***********************************************************************         
SSRVACT  CLC   ADSSRV,=C'CTSYSPRG' SYSTEM SERVICE INFORMATION CALL              
         BNE   SSRV000                                                          
         MVI   SYPINIT,C'N'        INIT NEEDED                                  
*                                                                               
         BRAS  RE,PARSUSR          PARSE USERNAME (PERSON@USER)                 
         BNE   SSSPERR1                                                         
*                                                                               
         BRAS  RE,GETUID           GET COMPANY USER ID INFO                     
         JNE   ACCRETN                                                          
*                                                                               
         MVC   ADUASAID,ADUAUAID   SECURITY ALPHA AND                           
         MVC   ADUAPAID,ADUAUAID   SEC FOR PID ALPHA DEFAULT TO ALPHA           
         GOTO1 LOADNUM,PARM,UIDNUM,ADUAUIN,L'ADUAUIN                            
*                                                                               
         BRAS  RE,GETSYPR          GET SYSTEM/PROGRAM LIST (ID)                 
*                                                                               
         BRAS  RE,GETACC           GET AGENCY ALPHA INFO                        
         JNE   ACCRETN                                                          
*                                                                               
         BRAS  RE,GETSYPR          GET SYSTEM/PROGRAM LIST (ID)                 
*                                                                               
         BRAS  RE,GETPIN           GET PERSON ID NUMBER                         
         JNE   ACCRETN                                                          
         GOTO1 LOADNUM,PARM,PIDNUM,ADUAPIN,L'ADUAPIN                            
*                                                                               
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
         MVC   TAGYPER,ADUAPAID                                                 
         MVC   TPASSWD,PIDNUM                                                   
         DROP  R4                                                               
*                                                                               
         BRAS  RE,VALIDPER         CHECK PERSON & USER ID COMPATIBLE            
         JNE   ACCRETN                                                          
*                                                                               
         BRAS  RE,GETPWD                                                        
         JNE   ACCRETN                                                          
*                                                                               
         BRAS  RE,GETSYPR          GET SYSTEM/PROGRAM LIST (PERSON)             
*                                                                               
         BRAS  RE,OUTSYPR          OUTPUT SYSTEM/PROGRAM LIST                   
         J     ACCRETY                                                          
*                                                                               
SSSPERR1 MVI   RETCODE,ACRCERR1                                                 
         LA    RE,ACRSGPE2         NO PID PROVIDED                              
         ST    RE,REASCODE                                                      
         J     ACCRETN                                                          
                                                                                
*----------------------------------------------------------------------         
* Legacy System Service Call for client validation                              
*----------------------------------------------------------------------         
SSRV000  LA    RE,ADUARD                                                        
         ICM   RF,15,=AL4(ADUARDLQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
         NI    ACCDINDS,X'FF'-ACCDIUV                                           
*                                                                               
SSRV010  L     RF,=A(SETUC)        SET UP USER CONTROL DATA                     
         A     RF,RELO                                                          
         BASR  RE,RF                                                            
*                                                                               
         GOTO1 VALSYP,ADPAPID                                                   
         BNE   PAUTNO                                                           
*                                                                               
         BRAS  RE,SAVETWA                                                       
         BRAS  RE,SAVEUTL                                                       
*                                                                               
         L     R2,AUTL             ADJUST UTL VALUES                            
         USING UTLD,R2                                                          
         L     R3,ATCBTASK         ADJUST TCB VALUES                            
         USING TCBD,R3                                                          
         MVC   TOVSYS,SYSCODE                                                   
         MVC   TPRG,PGMCODE                                                     
         MVC   TAGY,ADUAUAID                                                    
         MVC   TAGYSEC,ADUASAID                                                 
         MVC   TAGYPER,ADUAPAID                                                 
         MVC   TPASSWD,PIDNUM                                                   
         MVC   TPERSON,PIDNUM                                                   
         MVC   TUSER,UIDNUM                                                     
         MVC   TSAGN,AGRNUM                                                     
         MVC   TACCS,ADPALACC                                                   
         MVC   TAUTH,ADPAAUTH                                                   
         OI    TFLAG,TFLAGSEC                                                   
         XC    PARM(8*4),PARM                                                   
         DROP  R2,R3                                                            
*                                                                               
         L     RE,ASECBLOC                                                      
         LHI   RF,L'SECBLOC                                                     
         LA    R0,*                                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         L     R4,ASECBLOC                                                      
         GOTOR ASECRET,PARM,('SECPINIT',(R4)),L'SECBLOC                         
         BL    SSRVNO                                                           
*                                                                               
         MVC   WORK(1),SESYSN                                                   
         MVC   WORK+1(3),=XL3'FFFFFF'                                           
         ICM   RF,15,WORK                                                       
         GOTO1 ASWITCH,PARM,(RF),0                                              
         CLI   4(R1),0                                                          
         BNE   SSRVNO                                                           
         MVI   SFLAG,C'Y'                                                       
*                                                                               
         L     R3,ATWA             ADJUST TWA VALUES                            
         USING TWAD,R3                                                          
         MVC   TWASAGN,AGRNUM                                                   
         MVC   TWAACCS,ADPALACC                                                 
         DROP  R3                                                               
*                                                                               
         BRAS  RE,SSCALL           SYSTEM SERVICE CALL                          
         BNE   SSRVNO                                                           
*                                                                               
         ICM   RF,15,=XL4'01FFFFFF'                                             
         GOTO1 ASWITCH,PARM,(RF),0                                              
         B     SSRVOK                                                           
*                                                                               
SSRVNO   CLI   SFLAG,C'Y'                                                       
         BNE   SSRVNO1                                                          
         ICM   RF,15,=XL4'01FFFFFF'                                             
         GOTO1 ASWITCH,PARM,(RF),0                                              
         B     SSRVOK                                                           
*                                                                               
SSRVNO1  B     ACCRETN                                                          
*                                                                               
SSRVOK   BRAS  RE,SWAPUTL                                                       
         BRAS  RE,RESTTWA                                                       
         B     ACCRETY                                                          
                                                                                
***********************************************************************         
* ACCESS AUTHORIZATION                                                          
***********************************************************************         
ACSAACT  GOTO1 VALSYP,ADPAPID      VALIDATE SYSTEM/PROGRAM                      
         BNE   AAX                                                              
*                                                                               
         BRAS  RE,SAVETWA                                                       
         BRAS  RE,SAVEUTL                                                       
*                                                                               
         BRAS  RE,SETVALS          SET ACCESS VALUES                            
         BNE   AAX                                                              
*                                                                               
         L     R2,AUTL             ADJUST UTL VALUES                            
         USING UTLD,R2                                                          
         L     R3,ATCBTASK         ADJUST TCB VALUES                            
         USING TCBD,R3                                                          
         MVC   TOVSYS,SYSCODE                                                   
         MVC   TPRG,PGMCODE                                                     
         MVC   TAGY,ADUAUAID                                                    
         MVC   TAGYSEC,ADUASAID                                                 
         MVC   TAGYPER,ADUAPAID                                                 
         MVC   TPASSWD,PIDNUM                                                   
         MVC   TPERSON,PIDNUM                                                   
         MVC   TUSER,UIDNUM                                                     
         MVC   TSAGN,AGRNUM                                                     
         MVC   TACCS,PGMLACC                                                    
         OI    TFLAG,TFLAGSEC                                                   
         DROP  R2,R3                                                            
*                                                                               
         L     RE,ASECBLOC                                                      
         LHI   RF,L'SECBLOC                                                     
         LA    R0,*                                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         GOTOR ASECRET,PARM,('SECPINIT+SECPOLP',ASECBLOC),L'SECBLOC,0           
         BL    ACCRETN                                                          
*                                                                               
         L     R3,ATWA             ADJUST TWA VALUES                            
         USING TWAD,R3                                                          
         MVC   TWASAGN,AGRNUM                                                   
         MVC   TWAACCS,PGMLACC                                                  
         DROP  R3                                                               
*                                                                               
         CLI   ACTN,ACCCLAA                                                     
         BNE   AA010                                                            
         MVC   WORK(1),SESYSN                                                   
         MVC   WORK+1(3),=XL3'FFFFFF'                                           
         ICM   RF,15,WORK                                                       
         GOTO1 ASWITCH,PARM,(RF),0                                              
         CLI   4(R1),0                                                          
         BNE   ACCRETN                                                          
         MVI   SFLAG,C'Y'                                                       
         BRAS  RE,SSCALL           CLIENT ACCESS AUTHORIZATION                  
         B     AAX                                                              
*                                                                               
AA010    CLI   ACTN,ACCGAIN                                                     
         BNE   *+8                                                              
         BRAS  RE,GEACIN           GENERAL ACCESS INFORMATION                   
*                                                                               
AAX      CLI   SFLAG,C'Y'                                                       
         BNE   ACCRETY                                                          
         ICM   RF,15,=XL4'01FFFFFF'                                             
         GOTO1 ASWITCH,PARM,(RF),0                                              
         BRAS  RE,SWAPUTL                                                       
         BRAS  RE,RESTTWA                                                       
         B     ACCRETY                                                          
         EJECT                                                                  
                                                                                
***********************************************************************         
* LOAD CONNECT SCREEN WITH INPUT DATA                                 *         
* CALLS OVERLAYS AND SETS SYSTEM DATA FOR =CT CONNECT CALL            *         
* EXIT TO FACPAK MONITOR IF SUCCESFUL CONNECT,                        *         
* ELSE SYSTEM DATA AND PC TWA RESTORED AND NORMAL ERROR EXIT          *         
***********************************************************************         
LOADCT   NTR1                                                                   
         BRAS  RE,SAVETWA                                                       
         BRAS  RE,SAVEUTL                                                       
*                                                                               
         L     R6,ATWA             LOAD CONNECT BASE SCREEN                     
         LA    R6,64(R6)                                                        
         GOTO1 ACALLOV,PARM,(R6),X'D90110FF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOCTERR2                                                         
*                                  MOVE DATA TO FIELDS AT RELATIVE              
*                                  LOGICAL POSITIONS IN TWA                     
*                                  MOVE TEXT TO SERVICE REQUEST FIELD           
         GOTO1 LOADFLD,PARM,=C'=CT',3,1                                         
*                                  BUILD PPS USERID,PERSONID FIELD              
         XC    WORK,WORK                                                        
         LA    RF,WORK                                                          
         LA    RE,ADUAUID                                                       
         LA    R1,L'ADUAUID                                                     
LOCT1    CLI   0(RE),C' '                                                       
         BE    LOCT2                                                            
         CLI   0(RE),0                                                          
         BE    LOCT2                                                            
         MVC   0(1,RF),0(RE)                                                    
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         BCT   R1,LOCT1                                                         
*                                                                               
LOCT2    EQU   *                                                                
         CLC   ADUAPID,SPACES                                                   
         BE    LOCT4                                                            
         OC    ADUAPID,ADUAPID                                                  
         BZ    LOCT4                                                            
         MVI   0(RF),C','                                                       
         LA    RF,1(RF)                                                         
         LA    RE,ADUAPID                                                       
         LA    R1,L'ADUAPID                                                     
LOCT3    CLI   0(RE),C' '                                                       
         BE    LOCT4                                                            
         CLI   0(RE),0                                                          
         BE    LOCT4                                                            
         MVC   0(1,RF),0(RE)                                                    
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         BCT   R1,LOCT3                                                         
*                                                                               
LOCT4    EQU   *                                                                
         LA    R3,WORK                                                          
         SR    RF,R3                                                            
         LR    R3,RF                                                            
         LA    R2,WORK             MOVE DATA TO USER ID FIELD                   
         GOTO1 LOADFLD,PARM,(R2),(R3),2                                         
*                                                                               
         LA    R3,L'ACCDSYS                                                     
         LA    R2,ACCDSYS          MOVE DATA TO SYSTEM FIELD                    
         GOTO1 LOADFLD,PARM,(R2),(R3),3                                         
*                                                                               
         LA    R3,L'ACCDPGM                                                     
         LA    R2,ACCDPGM          MOVE DATA TO PROGRAM FIELD                   
         GOTO1 LOADFLD,PARM,(R2),(R3),4                                         
*                                                                               
         LA    R3,L'ADUAPWD                                                     
         LA    R2,ADUAPWD          MOVE DATA TO PASSWORD FIELD                  
         GOTO1 LOADFLD,PARM,(R2),(R3),5                                         
*                                                                               
         L     RF,AUTL             INHIBIT BROADCAST MSGS                       
         USING UTLD,RF                                                          
         NI    TFLAG,X'FF'-TFLAGIRB                                             
         DROP  RF                                                               
*                                                                               
         EJECT                                                                  
*                                  FIND ADDRESS OF CONNECT CODE                 
*                                  OVERLAY WHICH IS CORE RESIDENT               
LOCT100  EQU   *                                                                
         MVC   PARM+4(4),=X'D9011000'                                           
         MVC   PARM(4),ACCPLODA    IN CASE NOT CORE RESIDENT ??                 
         GOTO1 ACALLOV,PARM,,,0                                                 
         CLI   4(R1),X'FF'                                                      
         BE    LOCTERR3                                                         
         MVC   FULL,0(R1)                                                       
*                                  SET SYSTEM STATUS TABLE VALUES AS IF         
*                                  FOR ENTRY DIRECT FROM FACPAK MONITOR         
*                                  AND GOTO CONNECT ROUTINE                     
*                                                                               
         L     R2,AUTL             ADJUST UTL VALUES                            
         USING UTLD,R2                                                          
*                                                                               
         L     R3,ATCBTASK         ADJUST TCB VALUES                            
         USING TCBD,R3                                                          
         MVC   TSRSAVE(2),TSVCREQ  SAVE CURRENT UTL PROGRAM STATE               
         MVI   TSYS,1                                                           
         MVI   TSVCREQ,X'01'       INDICATE CT SERVICE REQUEST STATE            
         MVI   TSVCREQ+1,$CT                                                    
         MVI   TCBPRG,$CT          INDICATE CT SERVICE REQUEST STATE            
         MVC   SVTSTAT1,TSTAT1                                                  
         MVC   SVTTYPE,TTYPE                                                    
         NI    TSTAT1,X'FF'-TSTATDDS                                            
         CLI   DDSUSER,C'Y'        SET DDS USER TERMINAL EQUIVALENT             
         BNE   *+8                                                              
         OI    TSTAT1,TSTATDDS                                                  
         MVC   SVTVIFLG,TVIFLAG                                                 
*        OI    TVIFLAG,TVIVIRT                                                  
         OI    TTYPE,TTYPEWAP      FLAG WEB APPL PROCESSING                     
         L     RF,FULL             GET CODE ENTRY POINT                         
         L     R1,APARMS           POINT TO ENTRY PARAMETERS                    
         BASR  RE,RF               GOTO CONNECT ROUTINE                         
*                                                                               
         OC    TSVCREQ,TSVCREQ     TEST IF CONNECT SUCCESFUL                    
         BNZ   LOCTERR1                                                         
*                                                                               
         L     R6,ATWA             RESTORE CALLERS TWA SCREEN                   
         LA    R6,64(R6)           LOAD OVERLAY                                 
         GOTO1 ACALLOV,PARM,(R6),X'D90121FF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOCTERR4                                                         
*                                                                               
         MVC   TCBPRG(1),TSVCREQ+1 RESTORE TCB PROGRAM STATE                    
         MVC   TSTAT1,SVTSTAT1                                                  
         MVC   TTYPE,SVTTYPE                                                    
         MVC   TVIFLAG,SVTVIFLG                                                 
         BRAS  RE,SWAPUTL                                                       
         BRAS  RE,RESTTWA                                                       
         B     LOCTOK                                                           
*                                                                               
$CT      EQU   X'10'               CONNECT PROGRAM #                            
*                                                                               
* INPUT ACTION ROUTINE RETURN POINTS                                            
*                                                                               
LOCTERR1 EQU   *                                                                
         BRAS  RE,GETCTER          INTERPRET ERROR MSG IN TWA LINE 1            
         L     R6,ATWA             RESTORE CALLERS TWA SCREEN                   
         LA    R6,64(R6)           LOAD OVERLAY                                 
         GOTO1 ACALLOV,PARM,(R6),X'D90121FF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOCTERR4                                                         
*                                                                               
         MVC   TCBPRG(1),TSVCREQ+1 RESTORE TCB PROGRAM STATE                    
         MVC   TSTAT1,SVTSTAT1                                                  
         MVC   TVIFLAG,SVTVIFLG                                                 
         BRAS  RE,SWAPUTL                                                       
         BRAS  RE,RESTTWA                                                       
         B     LOCTNO                                                           
*                                                                               
LOCTERR2 EQU   *                                                                
         LA    RE,ACRSLCE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     LOCTNO                                                           
*                                                                               
LOCTERR3 EQU   *                                                                
         LA    RE,ACRSLCE3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     LOCTNO                                                           
*                                                                               
LOCTERR4 EQU   *                                                                
         LA    RE,ACRSLCE4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     LOCTNO                                                           
*                                                                               
LOCTOK   SR    RC,RC                                                            
LOCTNO   LTR   RC,RC                                                            
         J     EXIT                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
                                                                                
***********************************************************************         
* SUBROUTINE TO INTERPRET ERROR MESSAGE IN TWA FIELD ONE                        
***********************************************************************         
GETCTER  NTR1                                                                   
         L     RE,ATWA                                                          
*                                                                               
         LA    R3,L'TWAUSER+8+TWAUSER-TWAD(RE)                                  
         CLC   0(2,R3),=C'ED'      TEST FOR ERROR CODE IN FIELD                 
         BNE   GCTEUND1            UNDEFINED ERROR CODE                         
*                                                                               
         LA    R2,4                READ 4 DIGIT CODE                            
         LA    R3,3(R3)                                                         
         GOTO1 TESTNUM,PARM,(R3),(R2)                                           
         BNE   GCTEUND1                                                         
*                                                                               
         BCTR  R2,0                CONVERT VALUE TO BINARY                      
         EX    R2,*+8                                                           
         B     *+10                                                             
         PACK  DUB,0(0,R3)                                                      
         CVB   R2,DUB                                                           
         B     GCTE100                                                          
*                                                                               
GCTEUND1 SR    R2,R2               SET DEFAULT VALUE                            
         B     GCTE100                                                          
*                                                                               
GCTE100  EQU   *                                                                
         ST    R2,REASCODE                                                      
         MVI   RETCODE,ACRCERR2                                                 
         B     GCTEX                                                            
*                                                                               
GCTEX    J     EXIT                                                             
         EJECT                                                                  
                                                                                
***********************************************************************         
* TEST IF SOME NUMBER OF BYTES PAST A GIVEN ADDRESS ARE ALL NUMERIC             
*                                                                               
*     PARAMETER 1 - A(FIRST BYTE)                                               
*     PARAMETER 2 - NUMBER OF BYTES                                             
*                                                                               
*     ON RETURN, COND CODE IS EQ IF ALL BYTES ARE NUMERIC, NEQ                  
*     OTHERWISE.                                                                
***********************************************************************         
TESTNUM  NTR1                                                                   
         LM    R2,R3,0(R1)         R2 = A(FIRST BYTE) , R3 = # OF BYTES         
*                                                                               
TN10     CLI   0(R2),C'0'          TEST BYTE IS NOT NUMERIC                     
         BL    TN20                                                             
         CLI   0(R2),C'9'                                                       
         BH    TN20                                                             
*                                                                               
         LA    R2,1(R2)            BUMP TO NEXT BYTE AND TRY AGAIN              
         BCT   R3,TN10                                                          
*                                                                               
         CR    RF,RF               ALL BYTES NUMERIC - RETURN EQ                
         B     TNX                                                              
*                                                                               
TN20     LTR   RF,RF               SOME BYTE NOT NUMERIC - RETURN NEQ           
TNX      J     EXIT                                                             
         EJECT                                                                  
                                                                                
***********************************************************************         
* LOAD SECRET INFO                                                              
***********************************************************************         
LOADSEC  NTR1                                                                   
         BRAS  RE,SAVEUTL                                                       
         L     R2,AUTL             ADJUST UTL VALUES                            
         USING UTLD,R2                                                          
         L     R3,ATCBTASK         ADJUST TCB VALUES                            
         USING TCBD,R3                                                          
         MVC   SAVETSYS,TSYS                                                    
         MVC   TOVSYS,SYSCODE                                                   
         MVC   TPRG,PGMCODE                                                     
         MVC   TAGYSEC,ADUASAID                                                 
         MVC   TAGYPER,ADUAPAID                                                 
         MVC   TPASSWD,PIDNUM                                                   
         MVC   TPERSON,PIDNUM                                                   
         MVC   TUSER,UIDNUM                                                     
         MVC   TSAGN,AGRNUM                                                     
         OI    TFLAG,TFLAGSEC                                                   
         XC    PARM(8*4),PARM                                                   
         ICM   R4,15,ACCPASEC                                                   
         BNZ   LSEC010              //?? CLEAR SEC BLOCK ??                     
*                                                                               
         L     R4,ASECBLOC                                                      
         STCM  R4,15,ACCPASEC                                                   
*                                                                               
LSEC010  L     RE,ASECBLOC                                                      
         LHI   RF,L'SECBLOC                                                     
         LA    R0,*                                                             
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         L     R4,ASECBLOC                                                      
         GOTOR ASECRET,PARM,('SECPINIT',(R4)),L'SECBLOC                         
         BL    LOSEERR1                                                         
*                                                                               
         USING SECD,R4                                                          
         TM    SECINDS,SECIDDS+SECIOLD                                          
         BNZ   LSEC100                                                          
         BRAS  RE,GETRAL                                                        
         BNE   LOSEERR1                                                         
         TM    SECINDS,SECIDDS+SECIOLD                                          
         BNZ   LSEC100                                                          
         GOTOR ASECRET,PARM,('SECPGOCL',(R4)),(L'ADPAOCON,ADPAOCON)             
         LA    RF,ADPAOCON                                                      
         BL    LOSEERR1                                                         
         TM    SECINDS,SECIDDS+SECIOLD                                          
         BNZ   LSEC100                                                          
         GOTOR ASECRET,PARM,('SECPGFCL',(R4)),(L'ADPAFCON,ADPAFCON)             
         LA    RF,ADPAFCON                                                      
         BL    LOSEERR1                                                         
*                                                                               
LSEC100  MVC   TSYS,SAVETSYS                                                    
         BRAS  RE,SWAPUTL                                                       
         B     LOSEOK                                                           
*                                                                               
* INPUT ACTION ROUTINE RETURN POINTS                                            
*                                                                               
LOSEERR1 EQU   *                                                                
         LA    RE,ACRSLSE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR3                                                 
         MVC   TSYS,SAVETSYS                                                    
         BRAS  RE,SWAPUTL                                                       
         B     LOSENO                                                           
         DROP  R2,R3,R4                                                         
*                                                                               
LOSEOK   SR    RC,RC                                                            
LOSENO   LTR   RC,RC                                                            
         J     EXIT                                                             
         EJECT                                                                  
                                                                                
***********************************************************************         
* VALIDATE USER CHECK IP ADDRESS                                                
***********************************************************************         
VALUIP   NTR1                                                                   
         CLI   ADUAWCTL,C'N'                                                    
         BNE   VUIP100                                                          
         OC    ACCNETID,ACCNETID                                                
         BZ    VUIPOK                                                           
         CLC   ACCNETID,SPACES                                                  
         BE    VUIPOK                                                           
         MVC   ADIPADR,SPACES                                                   
         MVC   ADIPADR(L'ACCNETID),ACCNETID                                     
         LA    RE,L'ADIPADR                                                     
         LA    RF,ADIPADR                                                       
         AR    RF,RE                                                            
         BCTR  RF,0                                                             
         LA    R1,0                                                             
VUIP010  EQU   *                                                                
         CLI   0(RF),C' '                                                       
         BNE   VUIP020                                                          
         BCTR  RF,0                                                             
         BCT   RE,VUIP010                                                       
         B     VUIPOK                                                           
VUIP020  EQU   *                                                                
         STC   RE,ADIPADRL                                                      
*                                                                               
VUIP100  EQU   *                                                                
         BRAS  RE,VALIP                                                         
         BNE   VUIPNO                                                           
         MVC   USERID,ADUAUID                                                   
         LA    R2,IOAREA                                                        
         BRAS  RE,VALID            ENSURE ID IS COMPATIBLE WITH IP              
         BNE   VUIPERR1                                                         
         B     VUIPOK                                                           
*                                                                               
VUIPERR1 EQU   *                                                                
         LA    RE,ACRSVUE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VUIPNO                                                           
*                                                                               
VUIPOK   SR    RC,RC                                                            
VUIPNO   LTR   RC,RC                                                            
VUIPX    J     EXIT                                                             
         EJECT                                                                  
                                                                                
***********************************************************************         
* VALIDATE PROGRAM ACCESS                                                       
***********************************************************************         
VALPAC   NTR1                                                                   
         LA    R2,IOKEY                                                         
         USING CTIREC,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ     RECORD TYPE C'I'                            
         MVC   CTIKNUM,UIDNUM                                                   
         BRAS  RE,READSA                                                        
         BNE   VPACERR1                                                         
         L     R2,AIOAREA                                                       
         LA    R1,AUIDSYS            AND SAVE SYSTEM ELEMENT                    
         BRAS  RE,GETSYS                                                        
         BE    VPACERR3                                                         
         XC    UIDSYSEL,UIDSYSEL                                                
         ICM   R1,15,AUIDSYS                                                    
         SR    RF,RF                                                            
         IC    RF,1(R1)                                                         
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   UIDSYSEL(0),0(R1)                                                
         LA    RF,UIDSYSEL                                                      
         STCM  RF,15,AUIDSYS                                                    
         LA    R2,IOKEY                                                         
         USING SA0REC,R2                                                        
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ                                                 
         OC    ADUAPAID,ADUAPAID                                                
         BZ    *+14                                                             
         MVC   SA0KAGY,ADUAPAID                                                 
         B     *+10                                                             
         MVC   SA0KAGY,ADUASAID                                                 
         MVC   SA0KNUM,PIDNUM                                                   
         BRAS  RE,READSA                                                        
         BNE   VPACERR2                                                         
         L     R2,AIOAREA                                                       
         LA    R1,APIDSYS            AND SAVE SYSTEM ELEMENT                    
         BRAS  RE,GETSYS                                                        
         BE    VPACERR4                                                         
         XC    PIDSYSEL,PIDSYSEL                                                
         ICM   R1,15,APIDSYS                                                    
         SR    RF,RF                                                            
         IC    RF,1(R1)                                                         
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PIDSYSEL(0),0(R1)                                                
         LA    RF,PIDSYSEL                                                      
         STCM  RF,15,APIDSYS                                                    
*                                                                               
         BRAS  RE,GETAUT           GET PROGRAM AUTHORISATION                    
         BNE   VPACNO                                                           
         GOTO1 AHEXOUT,PARM,PGMAUTH,ADPAAUTH,2,=C'TOG'                          
*                                                                               
         BRAS  RE,GETLAC           GET PROGRAM LIMIT ACCESS                     
         BNE   VPACNO                                                           
         MVC   ADPALACC,PGMLACC                                                 
         B     VPACOK                                                           
*                                                                               
VPACERR1 EQU   *                                                                
         LA    RE,ACRSPAE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR2 EQU   *                                                                
         LA    RE,ACRSPAE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR3 EQU   *                                                                
         LA    RE,ACRSPAE3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR4 EQU   *                                                                
         LA    RE,ACRSPAE4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR5 EQU   *                                                                
         LA    RE,ACRSPAE5                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR6 EQU   *                                                                
         LA    RE,ACRSPAE6                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACOK   SR    RC,RC                                                            
VPACNO   LTR   RC,RC                                                            
VPACX    J     EXIT                                                             
         DROP  R2                                                               
                                                                                
* GET A(SYSTEM ELEMENT) FOR AN ID/AUTHORIZATION RECORD                          
* ON ENTRY R4=A(RECORD), R1=A(ELEMENT ADDRESS), SYSCODE=SYSTEM NUMBER           
*                                                                               
GETSYS   LA    RF,CTIDATA-CTIREC(R2)                                            
         SR    R0,R0                                                            
GETSYS2  CLI   0(RF),0             TEST E-O-R                                   
         BNE   *+10                                                             
         SR    RF,RF                                                            
         B     GETSYSX                                                          
         CLI   0(RF),X'21'         TEST FOR CORRECT SYSTEM ELEMENT              
         BNE   *+14                                                             
         CLC   SYSCODE,CTSYSNUM-CTSYSD(RF)                                      
         BE    GETSYSX                                                          
         IC    R0,1(RF)                                                         
         AR    RF,R0                                                            
         B     GETSYS2                                                          
GETSYSX  LTR   RF,RF               EXIT IF SYSTEM ELEMENT FOUND                 
         BNZ   GETSYSX1                                                         
GETSYSX1 ST    RF,0(R1)            RETURN A(ELEMENT) OR ZERO                    
         LTR   RF,RF               SET CC=EQ IF NO ELEMENT FOUND                
         BR    RE                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* VALIDATE PROGRAM ACCESS LIST                                                  
***********************************************************************         
VALPAL   NTR1                                                                   
         LA    R4,ADPAPID                                                       
*                                                                               
         GOTO1 VALSYP,ADPAPID                                                   
         BNE   VPALNO                                                           
*                                                                               
         BRAS  RE,VALPAC                                                        
         BNE   VPALNO                                                           
         B     VPALOK                                                           
*                                                                               
VPALOK   SR    RC,RC                                                            
VPALNO   LTR   RC,RC                                                            
VPALX    J     EXIT                                                             
         EJECT                                                                  
                                                                                
***********************************************************************         
* GET FACPAK ADV VTAM ID FOR THIS USER SE NUMBER                                
***********************************************************************         
GETADV   NTR1                                                                   
*                                                                               
         MVC   ADVID,SPACES                                                     
*&&UK*&& MVI   ADVID,C'L'                                                       
*                                                                               
         L     R3,AUIDSYS                                                       
         USING CTSYSD,R3                                                        
         MVC   SESYSN,CTSYSSE                                                   
         DROP  R3                                                               
*                                                                               
         L     R3,ASSB                                                          
         TM    SSBSYSFL-SSBD(R3),X'80' TEST SYSTEM?                             
         BO    GADV110             YES, RETURN VTAM APPLICATION ID              
*                                                                               
         GOTO1 ADMOD000,PARM,AFINDSYS,(1,0)                                     
         L     R1,4(R1)            R1=A(SYSFILES LIST)                          
         AHI   R1,-4                                                            
         L     R1,0(R1)            EXTRACT SYSSTAB                              
*                                                                               
         SR    RF,RF               CHECK SESYSN AGAINST TABLE                   
         IC    RF,SESYSN                                                        
         AR    RF,R1                                                            
         CLI   0(RF),X'FF'                                                      
         BE    GADV100                                                          
         L     R3,ASSB             GET A(FACIDTAB) FROM SSB                     
         ICM   R3,15,SSBAFID-SSBD(R3)                                           
         BZ    GADVERR1                                                         
         USING FACITABD,R3                                                      
*                                                                               
GADV010  CLI   0(R3),X'FF'                                                      
         BE    GADVERR1                                                         
         CLC   0(1,RF),FACIID                                                   
         BE    GADV020                                                          
         LA    R3,L'FACITAB(R3)                                                 
         B     GADV010                                                          
GADV020  EQU   *                                                                
*&&UK*&& MVC   ADVID+1(L'FACISN4),FACISN4                                       
*&&US*&& MVC   ADVID(L'FACISN4),FACISN4                                         
         B     GADVOK                                                           
         DROP  R3                                                               
*                                                                               
GADV100  EQU   *                                                                
*&&UK*&& MVC   ADVID+1(4),=CL4'ADV1'                                            
*&&US*&& MVC   ADVID(4),=CL4'ADV1'                                              
         B     GADVOK                                                           
*                                                                               
GADV110  MVC   ADVID,SSBVTID-SSBD(R3) USE VTAM APPLID FOR TEST SYSTEM           
         B     GADVOK                                                           
*                                                                               
GADVERR1 LA    RE,ACRSADE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GADVNO                                                           
*                                                                               
GADVOK   SR    RC,RC                                                            
GADVNO   LTR   RC,RC                                                            
GADVX    J     EXIT                                                             
                                                                                
***********************************************************************         
* VALIDATE FACPAK SYSTEM PROGRAM CODES FROM INPUT                     *         
* R3=A(SYS/PGM HEX CODE IN INPUT)                                     *         
***********************************************************************         
VALSYP   NTR1                                                                   
         LR    R3,R1                                                            
         GOTO1 AHEXIN,PARM,0(R3),SYSCODE,2                                      
         OC    12(4,R1),12(R1)                                                  
         BZ    VSYPERR1                                                         
         GOTO1 AHEXIN,PARM,2(R3),PGMCODE,2                                      
         OC    12(4,R1),12(R1)                                                  
         BZ    VSYPERR2                                                         
         B     VSYPOK                                                           
*                                                                               
VSYPERR1 EQU   *                                                                
         LA    RE,ACRSSPE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSYPNO                                                           
*                                                                               
VSYPERR2 EQU   *                                                                
         LA    RE,ACRSSPE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSYPNO                                                           
*                                                                               
VSYPOK   SR    RC,RC                                                            
VSYPNO   LTR   RC,RC                                                            
VSYPX    J     EXIT                                                             
                                                                                
***********************************************************************         
* VALIDATE DDS USER IP ADDRESS                                        *         
***********************************************************************         
VALDDS   NTR1                                                                   
         MVI   DDSUSER,C'N'                                                     
         MVC   SNIDSTRV,ADIPADR                                                 
         MVC   SNIDSTRL,ADIPADRL                                                
*                                                                               
VDDS008  EQU   *                                                                
         CLI   ADIPADRL,7                    0.0.0.0    (min is 7)              
         BL    VDDSOK                                                           
*        BL    VDDSNO                        Invalid IP                         
*                                                                               
         CLI   ADIPADRL,8                    Min length                         
         BL    VDDSOK                                                           
         CLC   ADIPADR(5),=CL5'10.2.'        00.0.0.0   (min 8)                 
         BE    VDDSYES                       Yes DDS                            
         CLC   ADIPADR(5),=CL5'10.3.'                                           
         BE    VDDSYES                       Yes DDS                            
         CLC   ADIPADR(5),=CL5'10.8.'                                           
         BE    VDDSYES                       Yes DDS                            
*                                                                               
         CLI   ADIPADRL,9                    Min length                         
         BL    VDDSOK                        Not DDS                            
         BH    VDDS012                                                          
         CLC   ADIPADR(9),=CL9'127.0.0.1'    Exact match                        
         BE    VDDSYES                       Yes DDS                            
*                                                                               
VDDS012  CLC   ADIPADR(6),=CL6'10.16.'       00.00.0.0  (min  9)                
         BE    VDDSYES                       Yes DDS                            
*                                                                               
         CLI   ADIPADRL,10                   Min length                         
         BL    VDDSOK                                                           
         CLC   ADIPADR(7),=CL7'10.243.'      00.000.0.0 (min 10)                
         BE    VDDSYES                                                          
         CLC   ADIPADR(7),=CL7'10.253.'                                         
         BNE   VDDSOK                                                           
*                                                                               
VDDSYES  MVI   DDSUSER,C'Y'                                                     
*                                                                               
VDDSOK   SR    RC,RC                                                            
VDDSNO   LTR   RC,RC                                                            
VDDSX    J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VALIDATE IP ADDRESS                                                 *         
***********************************************************************         
                                                                                
VALIP    NTR1                                                                   
         BAS   RE,VALDDS                                                        
         BNE   VAIPX               Invalid                                      
*                                                                               
VAIP015  BRAS  RE,VALSNID          RETURN VALUE IN "SNID"                       
         BNE   VAIPX                                                            
         XC    SVIPRKEY,SVIPRKEY   CLEAR SAVED IP SUBNET KEY                    
         XC    SVIPMASK,SVIPMASK   CLEAR SAVED IP SUBNET MASK                   
*                                                                               
         LA    R2,IOKEY                                                         
         USING CTIPREC,R2                                                       
         XC    CTIPKEY,CTIPKEY                                                  
         MVI   CTIPKTYP,CTIPKTEQ   RECORD TYPE C'3'                             
         MVI   CTIPKTY2,CTIPKT2E   SUB RECORD TYPE C'I'                         
         BRAS  RE,RDHISA                                                        
         BNE   VAIPERR1                                                         
*                                                                               
         LA    R2,IOAREA                                                        
VAIP020  CLI   CTIPKTYP,CTIPKTEQ                                                
         BNE   VAIP100             END OF IP SUBNET RECORD                      
         CLI   CTIPKTY2,CTIPKT2E                                                
         BNE   VAIP100             END OF IP SUBNET RECORD                      
         MVC   IPRKSNID,CTIPKSID   SAVE THIS SUBNET ID                          
         DROP  R2                                                               
*                                                                               
         LA    R3,IOAREA+(CTIPDATA-CTIPREC)                                     
VAIP060  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    VAIPERR2                                                         
         CLI   0(R3),CTIPMELQ                                                   
         BE    VAIP080                                                          
         SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
*                                                                               
         USING CTIPMEL,R3                                                       
VAIP080  EQU   *                                                                
         XC    SNIDMASK,SNIDMASK                                                
         SR    RF,RF                                                            
         IC    RF,CTIPMLEN                                                      
         SHI   RF,3                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   SNIDMASK(0),CTIPM                                                
         DROP  R3                                                               
*                                                                               
         BRAS  RE,VALIPM                                                        
         BNE   VAIP090                                                          
*                                                                               
         CLC   SNIDMASK,SVIPMASK   HIGHER MASK (MORE NARROW RANGE)?             
         BL    VAIP090             NO - READ NEXT RECORD                        
*                                  YES - SAVE THE CURRENT INFO                  
         MVC   SVIPRKEY,IPRKSNID   SAVE THIS IP SUBNET KEY (1S COMP)            
         MVC   SVIPMASK,SNIDMASK   SAVE THIS IP SUBNET MASK                     
*                                                                               
         CLC   SVIPMASK,=16X'FF'   HIGHEST MASK (V6)?                           
         BE    VAIP100                                                          
*                                  HIGHEST MASK (V4)?                           
         CLC   SVIPMASK,=XL16'00000000000000000000FFFFFFFFFFFF'                 
         BE    VAIP100                                                          
*                                                                               
VAIP090  EQU   *                   GET NEXT IP SUBNET RECORD                    
         BRAS  RE,RDSQSA                                                        
         B     VAIP020                                                          
*                                                                               
VAIP100  EQU   *                                                                
         OC    SVIPRKEY,SVIPRKEY   ANY IP SUBNET RECORD FOR THIS IP?            
         BZ    VAIPERR3            NO - OUT OF ANY SUBNET RANGE                 
*                                  YES - RE-READ THE RECORD                     
         LA    R2,IOKEY                                                         
         USING CTIPREC,R2                                                       
         XC    CTIPKEY,CTIPKEY                                                  
         MVI   CTIPKTYP,CTIPKTEQ   RECORD TYPE C'3'                             
         MVI   CTIPKTY2,CTIPKT2E   SUB RECORD TYPE C'I'                         
         MVC   CTIPKSID,SVIPRKEY   IP SUBNET (1S COMP)                          
         BRAS  RE,READSA                                                        
         BE    VAIPOK                                                           
         DC    H'0'                                                             
         DROP  R2                                                               
*                                                                               
VAIPERR1 EQU   *                                                                
         LA    RE,ACRSIPE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VAIPNO                                                           
*                                                                               
VAIPERR2 EQU   *                                                                
         LA    RE,ACRSIPE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VAIPNO                                                           
*                                                                               
VAIPERR3 EQU   *                                                                
         LA    RE,ACRSIPE3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VAIPNO                                                           
*                                                                               
VAIPOK   SR    RC,RC                                                            
VAIPNO   LTR   RC,RC                                                            
VAIPX    J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* GET IP CHECK DATA VALUES                                            *         
* IP RECORD IN IOAREA                                                 *         
***********************************************************************         
GETIPD   NTR1                                                                   
         LA    R3,IOAREA+(CTIPDATA-CTIPREC)                                     
*                                                                               
GIPD010  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPD020                                                          
         CLI   0(R3),CTIPPELQ                                                   
         BE    GIPD014                                                          
         CLI   0(R3),CTIPRELQ                                                   
         BE    GIPD016                                                          
GIPD012  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPD010                                                          
*                                                                               
         USING CTIPPEL,R3                                                       
GIPD014  EQU   *                                                                
         ZIC   R1,CTIPPLEN                                                      
         SH    R1,=Y(CTIPPLNQ+1)                                                
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ADIPPUID(0),CTIPPID                                              
         B     GIPD012                                                          
         DROP  R3                                                               
*                                                                               
         USING CTIPREL,R3                                                       
GIPD016  EQU   *                                                                
         ZIC   R1,CTIPRLEN                                                      
         SH    R1,=Y(CTIPRLNQ+1)                                                
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ADIPRNAM(0),CTIPRNAM                                             
         B     GIPD012                                                          
         DROP  R3                                                               
*                                                                               
GIPD020  EQU   *                                                                
         LA    R3,IOAREA+(CTIPDATA-CTIPREC)                                     
GIPD022  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPD024                                                          
         CLI   0(R3),CTPIDELQ                                                   
         BE    GIPD023                                                          
         SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPD022                                                          
*                                                                               
         USING CTPIDEL,R3                                                       
GIPD023  EQU   *                                                                
         MVC   ADIPUID,CTPID                                                    
         B     GIPD030                                                          
*                                                                               
GIPD024  EQU   *                                                                
         LA    R3,IOAREA+(CTIPDATA-CTIPREC)                                     
*                                                                               
GIPD026  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPD030                                                          
         CLI   0(R3),CTIDELQ                                                    
         BE    GIPD028                                                          
         SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPD026                                                          
*                                                                               
         USING CTIDEL,R3                                                        
GIPD028  EQU   *                                                                
         CLC   CTID(10),=CL10'ALL'                                              
         BNE   GIPD029                                                          
*&&UK*&& MVC   ADIPUID,=CL10'DDS1'                                              
*&&US*&& MVC   ADIPUID,=CL10'SJR'                                               
         B     GIPD030                                                          
GIPD029  EQU   *                                                                
         MVC   ADIPUID,CTID                                                     
*                                                                               
GIPD030  EQU   *                                                                
         OC    ADIPUID,ADIPUID                                                  
         BZ    GIPDERR1                                                         
         LA    R2,IOKEY                                                         
         USING CTIREC,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ  RECORD TYPE C'I'                               
         MVC   CTIKID,ADIPUID    SUBNET ID (1S COMPLEMENT)                      
         BRAS  RE,READSA                                                        
         BNE   GIPDERR2                                                         
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
*                                                                               
GIPD100  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPD200                                                          
         CLI   0(R3),CTAGYELQ                                                   
         BE    GIPD110                                                          
         CLI   0(R3),CTDSTELQ                                                   
         BE    GIPD120                                                          
         CLI   0(R3),CTORGELQ                                                   
         BE    GIPD130                                                          
GIPD112  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPD100                                                          
*                                                                               
         USING CTAGYEL,R3                                                       
GIPD110  EQU   *                                                                
         MVC   ADIPAID,CTAGYID                                                  
         B     GIPD112                                                          
*                                                                               
         USING CTDSTEL,R3                                                       
GIPD120  EQU   *                                                                
         MVC   ADIPDNAM,CTDSTNAM                                                
         MVC   ADIPADL1,CTDSTADD                                                
         CLI   CTDSTLEN,(CTDSTAD3+L'CTDSTAD3-CTDSTEL)                           
         BNH   GIPD112                                                          
         MVC   ADIPADL2,CTDSTAD2                                                
         MVC   ADIPADL3,CTDSTAD3                                                
         B     GIPD112                                                          
*                                                                               
         USING CTORGEL,R3                                                       
GIPD130  EQU   *                                                                
         MVC   ADIPANAM,CTORGNAM                                                
         B     GIPD112                                                          
         DROP  R3                                                               
*                                                                               
GIPD200  EQU   *                                                                
         BRAS  RE,GETIPA                                                        
         BNE   GIPDNO                                                           
         B     GIPDOK                                                           
*                                                                               
GIPDERR1 EQU   *                                                                
         LA    RE,ACRSGIE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GIPDNO                                                           
*                                                                               
GIPDERR2 EQU   *                                                                
         LA    RE,ACRSGIE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GIPDNO                                                           
*                                                                               
GIPDOK   SR    RC,RC                                                            
GIPDNO   LTR   RC,RC                                                            
GIPDX    J     EXIT                                                             
         DROP  R2                                                               
                                                                                
***********************************************************************         
* GET AGENCY ACCESS RECORD VALUES FOR IP CHECK                        *         
***********************************************************************         
                                                                                
GETIPA   NTR1                                                                   
         MVI   ADIPPFLG,C'N'                                                    
         LA    R2,IOKEY                                                         
         USING CT5REC,R2                                                        
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ                                                 
         MVC   CT5KALPH,ADIPAID                                                 
         BRAS  RE,READSA                                                        
         BNE   GIPAERR1                                                         
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
*                                                                               
GIPA010  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPA100                                                          
         CLI   0(R3),CTAADELQ                                                   
         BE    GIPA020                                                          
GIPA012  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPA010                                                          
*                                                                               
         USING CTAADEL,R3                                                       
GIPA020  EQU   *                                                                
         CLI   CTAADLEN,CTAADLNQ                                                
         BNE   GIPA100                                                          
         TM    CTAADFLG,CTAADPRQ                                                
         BZ    GIPA100                                                          
         MVI   ADIPPFLG,C'Y'                                                    
         B     GIPA100                                                          
         DROP  R3                                                               
*                                                                               
GIPA100  EQU   *                                                                
         B     GIPAOK                                                           
*                                                                               
GIPAERR1 EQU   *                                                                
         LA    RE,ACRSIAE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GIPANO                                                           
*                                                                               
GIPAOK   SR    RC,RC                                                            
GIPANO   LTR   RC,RC                                                            
GIPAX    J     EXIT                                                             
         DROP  R2                                                               
                                                                                
***********************************************************************         
* GET USER AUTHENTICATION VALUES                                      *         
***********************************************************************         
GETUAV   NTR1                                                                   
*                                                                               
         BRAS  RE,GETUTL                                                        
         BNE   GUAVNO                                                           
         BRAS  RE,GETUID                                                        
         BNE   GUAVNO                                                           
         BRAS  RE,GETACC                                                        
         BNE   GUAVNO                                                           
         BRAS  RE,GETPWD                                                        
         BNE   GUAVNO                                                           
         BRAS  RE,GETPER                                                        
         BNE   GUAVNO                                                           
         BRAS  RE,GETOFF                                                        
         BNE   GUAVNO                                                           
         BRAS  RE,GETDEP                                                        
         BNE   GUAVNO                                                           
         BRAS  RE,GETAGR                                                        
         BNE   GUAVNO                                                           
         MVC   ADUAWCTL,WEBCNTLS                                                
         MVC   ADUAACOD,ACCESSCD                                                
         B     GUAVOK                                                           
*                                                                               
GUAVOK   SR    RC,RC                                                            
GUAVNO   LTR   RC,RC                                                            
GUAVX    J     EXIT                                                             
                                                                                
***********************************************************************         
* GET VALUES FROM UTL FOR USER AUTHENTICATION                         *         
***********************************************************************         
GETUTL   NTR1                                                                   
*                                                                               
         B     GUTLOK                                                           
*                                                                               
GUTLOK   SR    RC,RC                                                            
GUTLNO   LTR   RC,RC                                                            
GUTLX    J     EXIT                                                             
                                                                                
***********************************************************************         
* GET USER ID RECORD VALUES FOR USER AUTHENTICATION                             
***********************************************************************         
GETUID   NTR1                                                                   
         XC    CULANG,CULANG       AGENCY LANGUAGE                              
*                                                                               
         LA    R2,IOKEY                                                         
         USING CTIREC,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ  RECORD TYPE C'I'                               
         MVC   CTIKID,ADUAUID                                                   
         BRAS  RE,READSA                                                        
         BNE   GUIDERR1                                                         
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
*                                                                               
GUID100  CLI   0(R3),0                                                          
         BE    GUID200                                                          
         CLI   0(R3),CTAGYELQ                                                   
         BE    GUID110                                                          
         CLI   0(R3),CTDSTELQ                                                   
         BE    GUID120                                                          
         CLI   0(R3),CTORGELQ                                                   
         BE    GUID130                                                          
         CLI   0(R3),X'02'                                                      
         BE    GUID150                                                          
GUID112  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GUID100                                                          
*                                                                               
         USING CTAGYEL,R3                                                       
GUID110  MVC   ADUAUAID,CTAGYID    AGENCY ALPHA ID                              
         MVC   CULANG,CTAGYLNG     AGENCY LANGUAGE                              
         B     GUID112                                                          
*                                                                               
         USING CTDSTEL,R3                                                       
GUID120  MVC   ADUADNAM,SPACES     DESTINATION NAME                             
         MVC   ADUADNAM(L'CTDSTNAM),CTDSTNAM                                    
         MVC   ADUAADL1,CTDSTADD   ADDRESS LINE ONE                             
         CLI   CTDSTLEN,(CTDSTAD3+L'CTDSTAD3-CTDSTEL)                           
         BNH   GUID112                                                          
         MVC   ADUAADL2,CTDSTAD2   ADDRESS LINE TWO                             
*                                                                               
         CLI   ACTN,ACCPCP         CHANGE PASSWORD ACTION?                      
         BE    GUID112             YES: NO ADDRESS 3, USE FOR EMAIL             
         CLC   ADPAPID,=C'04FA'    HARD CODE FOR PRINT/MEDIA PRISMA             
         BE    GUID112             NO ADDRESS 3, USE THIS FOR EMAIL             
         CLC   ADPAPID,=C'04FB'    HARD CODE FOR PRINT/MEDIA RADIA              
         BE    GUID112             NO ADDRESS 3, USE THIS FOR EMAIL             
         CLC   ADPAPID,=C'0624'    HARD CODE FOR ACC BRAND/AURA                 
         BE    GUID112             NO ADDRESS 3, USE THIS FOR EMAIL             
         CLC   ADPAPID,=C'0A14'    HARD CODE FOR CONTROL ARCHIVE                
         BE    GUID112             NO ADDRESS 3, USE THIS FOR EMAIL             
         CLC   ADPAPID,=C'0ABC'    HARD CODE FOR CONTROL BLKCHN                 
         BE    GUID112             NO ADDRESS 3, USE THIS FOR EMAIL             
         CLC   ADPAPID,=C'0AFC'    HARD CODE FOR CONTROL IPA                    
         BE    GUID112             NO ADDRESS 3, USE THIS FOR EMAIL             
         CLC   ADPAPID,=C'0AF9'    HARD CODE FOR CONTROL OPTICA                 
         BE    GUID112             NO ADDRESS 3, USE THIS FOR EMAIL             
         MVC   ADUAADL3,CTDSTAD3   ADDRESS LINE THREE                           
         B     GUID112                                                          
*                                                                               
         USING CTORGEL,R3                                                       
GUID130  MVC   ADUAUANM,CTORGNAM                                                
         B     GUID112                                                          
         DROP  R3                                                               
*                                                                               
GUID150  SR    RF,RF                                                            
         ICM   RF,3,2(R3)                                                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ADUAUIN,DUB+5(3)                                                 
         B     GUID112                                                          
*                                                                               
GUID200  B     GUIDOK                                                           
*                                                                               
GUIDERR1 LA    RE,ACRSGUE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GUIDNO                                                           
*                                                                               
GUIDOK   SR    RC,RC                                                            
GUIDNO   LTR   RC,RC                                                            
GUIDX    J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* GET AGENCY ACCESS RECORD VALUES FOR USER AUTHENTICATION                       
***********************************************************************         
GETACC   NTR1                                                                   
*                                                                               
         XC    PEXPIRE,PEXPIRE     RESET AGENCY ACCESS FIELDS                   
         XC    PWARNED,PWARNED                                                  
         XC    PACSFLG,PACSFLG                                                  
*                                                                               
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
         LA    R2,IOKEY                                                         
         USING CT5REC,R2                                                        
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ                                                 
         MVC   CT5KALPH,ADUAUAID                                                
         BRAS  RE,READSA                                                        
         BNE   GACCERR1                                                         
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
GACC100  CLI   0(R3),0                                                          
         BE    GACC200                                                          
         CLI   0(R3),CTAGDELQ                                                   
         BE    GACC114                                                          
         CLI   0(R3),WEBELQ                                                     
         BE    GACC120                                                          
         CLI   0(R3),CTSEAELQ                                                   
         BE    GACC130                                                          
         CLI   0(R3),CTAADELQ      X'B9' AGENCY ACCESS DETAILS                  
         BE    GACC140                                                          
GACC112  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GACC100                                                          
*                                                                               
         USING CTAGDD,R3                                                        
GACC114  TM    CTAGOPTS,CTAGUAT+CTAGTST+CTAGTNG                                 
         BZ    GACC115                                                          
         MVC   WORK(L'ADUADNAM),ADUADNAM                                        
         MVC   ADUADNAM(5),=CL5'*TST*'  ASSUME TEST AGENCY                      
         MVC   ADUADNAM+5(L'ADUADNAM-5),WORK                                    
         TM    CTAGOPTS,CTAGTNG         IS THIS FOR TRAINING?                   
         BZ    *+10                                                             
         MVC   ADUADNAM(5),=CL5'*TRN*'                                          
         TM    CTAGOPTS,CTAGUAT         IS THIS A UAT?                          
         BZ    *+10                                                             
         MVC   ADUADNAM(5),=CL5'*UAT*'                                          
*                                                                               
GACC115  CLI   CTAGDLEN,CTAGDL2Q                                                
         BNE   GACC112                                                          
         MVC   BYTE,CTAGDCTY                                                    
         CLI   BYTE,0              CHECK FOR DEFAULT                            
         BNE   GACC116                                                          
*&&US*&& MVI   BYTE,CTRYUSAQ                                                    
*&&UK*&& MVI   BYTE,CTRYGBRQ                                                    
GACC116  GOTO1 AHEXOUT,PARM,BYTE,ADUACTRY,1,=C'TOG'                             
         MVC   ADUACTRY+2(3),CTAGDCUR                                           
         MVC   CUCTRY,BYTE                                                      
         B     GACC112                                                          
         DROP  R3                                                               
*                                                                               
         USING WEBEL,R3                                                         
GACC120  CLI   WEBLN,WEBLNQ                                                     
         BNE   GACC112                                                          
         MVC   ACCESSCD,WEBACOD                                                 
         MVC   ACCNETID,SPACES                                                  
         MVC   ACCNETID(L'ACCNETID),WEBNID                                      
         MVC   WEBCNTLS,=CL3'YYN'                                               
         TM    WEBFLAG,WEBFIP                                                   
         BZ    *+8                                                              
         MVI   WEBCNTLS,C'N'                                                    
         TM    WEBFLAG,WEBFSS                                                   
         BZ    *+8                                                              
         MVI   WEBCNTLS+1,C'N'                                                  
         TM    WEBFLAG,WEBFAC                                                   
         BZ    *+10                                                             
         MVC   WEBCNTLS+2(1),WEBACT                                             
         B     GACC112                                                          
         DROP  R3                                                               
*                                                                               
         USING CTSEAEL,R3                                                       
GACC130  MVC   ADUASAID,CTSEAAID   SECURITY AGENCY                              
         B     GACC112                                                          
*                                                                               
         USING CTAADD,R3           X'B9' AGENCY ACCESS DETAILS ELEMENT          
GACC140  MVC   PEXPIRE,CTAADPTO    PASSWORD TIMEOUT IN DAYS                     
         MVC   PWARNED,CTAADPTW    PASSWORD WARNING IN DAYS                     
         MVC   PACSFLG,CTAADFLG    ACCESS CONTROLS FLAG                         
         B     GACC112                                                          
         DROP  R3                                                               
*                                                                               
GACC200  MVC   ADUAPAID,ADUASAID   SECURITY AGENCY FOR PERSON                   
         OC    TAGYPER,TAGYPER                                                  
         BZ    *+10                                                             
         MVC   ADUAPAID,TAGYPER                                                 
         B     GACCOK                                                           
*                                                                               
GACCERR1 LA    RE,ACRSGAE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GACCNO                                                           
*                                                                               
GACCOK   SR    RC,RC                                                            
GACCNO   LTR   RC,RC                                                            
GACCX    J     EXIT                                                             
         DROP  R2                                                               
                                                                                
***********************************************************************         
* GET OFFICE RECORD VALUES FOR USER AUTHENTICATION                    *         
***********************************************************************         
                                                                                
GETOFF   NTR1                                                                   
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
*                                                                               
         LA    R2,IOKEY            INITIALIZE OFFICE RECORD KEY                 
         USING SAOFREC,R2                                                       
         XC    SAOFKEY,SAOFKEY                                                  
         MVI   SAOFTYP,SAOFTYPQ                                                 
         MVI   SAOFSUB,SAOFSUBQ                                                 
         OC    ADUAPAID,ADUAPAID                                                
         BZ    *+14                                                             
         MVC   SAOFAGY,ADUAPAID                                                 
         B     *+10                                                             
         MVC   SAOFAGY,ADUASAID                                                 
         MVC   SAOFOID,ADUAOFF                                                  
*                                                                               
         BRAS  RE,READSA           READ RECORD                                  
         BNE   GOFFERR1                                                         
*                                                                               
         LA    R3,IOAREA+(SAOFDATA-SAOFREC)                                     
         USING SAOFFD,R3           FIND OFFICE ELEMENT                          
         XR    RF,RF                                                            
         IC    RF,SAOFFLN                                                       
         CLI   SAOFFEL,SAOFFELQ                                                 
         BE    *+8                                                              
         BXH   R3,RF,*-12                                                       
         AR    RF,R3               APPEND SPACES TO NAME                        
         MVC   0(L'SPACES,RF),SPACES                                            
         LA    R1,SAOFFNAM                                                      
         DROP  R3                                                               
*                                                                               
GOFFN10  LA    RF,L'ADUAOFFN       RF=L(OUTPUT)                                 
         LA    RF,L'SAOFFNAM                                                    
*                                                                               
         XR    RE,RE               COPY NAME INTO OUTPUT                        
         LA    RE,ADUAOFFN                                                      
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R1)                                                    
*                                                                               
GOFF200  EQU   *                                                                
         B     GOFFOK                                                           
*                                                                               
GOFFERR1 EQU   *                                                                
         LA    RE,ACRSGOE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GOFFNO                                                           
*                                                                               
GOFFOK   SR    RC,RC                                                            
GOFFNO   LTR   RC,RC                                                            
GOFFX    J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* GET DEPARTMENT RECORD VALUES FOR USER AUTHENTICATION                *         
***********************************************************************         
                                                                                
GETDEP   NTR1                                                                   
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
*                                                                               
         LA    R2,IOKEY            INITIALIZE OFFICE RECORD KEY                 
         USING SADPREC,R2                                                       
         XC    SADPKEY,SADPKEY                                                  
         MVI   SADPTYP,SADPTYPQ                                                 
         MVI   SADPSUB,SADPSUBQ                                                 
         OC    ADUAPAID,ADUAPAID                                                
         BZ    *+14                                                             
         MVC   SADPAGY,ADUAPAID                                                 
         B     *+10                                                             
         MVC   SADPAGY,ADUASAID                                                 
         MVC   SADPOID,ADUAOFF                                                  
         MVC   SADPDID,ADUADEP                                                  
*                                                                               
         BRAS  RE,READSA           READ RECORD                                  
         BNE   GDEPERR1                                                         
*                                                                               
         LA    R3,IOAREA+(SADPDATA-SADPREC)                                     
         USING SADPTD,R3           FIND DEPICE ELEMENT                          
         XR    RF,RF                                                            
         IC    RF,SADPTLN                                                       
         CLI   SADPTEL,SADPTELQ                                                 
         BE    *+8                                                              
         BXH   R3,RF,*-12                                                       
         AR    RF,R3               APPEND SPACES TO NAME                        
         MVC   0(L'SPACES,RF),SPACES                                            
         LA    R1,SADPTNAM                                                      
         DROP  R3                                                               
*                                                                               
GDEPN10  LA    RF,L'ADUADEPN       RF=L(OUTPUT)                                 
         LA    RF,L'SADPTNAM                                                    
*                                                                               
         XR    RE,RE               COPY NAME INTO OUTPUT                        
         LA    RE,ADUADEPN                                                      
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R1)                                                    
*                                                                               
GDEP200  EQU   *                                                                
         B     GDEPOK                                                           
*                                                                               
GDEPERR1 EQU   *                                                                
         LA    RE,ACRSGDE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GDEPNO                                                           
*                                                                               
GDEPOK   SR    RC,RC                                                            
GDEPNO   LTR   RC,RC                                                            
GDEPX    J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* GET ACCESS GROUP RECORD VALUES FOR USER AUTHENTICATION              *         
***********************************************************************         
                                                                                
GETAGR   NTR1                                                                   
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
*                                                                               
         CLC   ADUAAGCD,SPACES                                                  
         BE    GAGCOK                                                           
         OC    ADUAAGCD,ADUAAGCD                                                
         BZ    GAGCOK                                                           
         LA    R2,IOKEY            INITIALIZE OFFICE RECORD KEY                 
         USING SAAGREC,R2                                                       
         XC    SAAGKEY,SAAGKEY                                                  
         MVI   SAAGTYP,SAAGTYPQ                                                 
         MVI   SAAGSUB,SAAGSUBQ                                                 
         OC    ADUAPAID,ADUAPAID                                                
         BZ    *+14                                                             
         MVC   SAAGAGY,ADUAPAID                                                 
         B     *+10                                                             
         MVC   SAAGAGY,ADUASAID                                                 
         MVC   SAAGAGR,ADUAAGCD                                                 
*                                                                               
         BRAS  RE,READSA           READ RECORD                                  
         BNE   GAGCERR1                                                         
*                                                                               
         LA    R3,IOAREA+(SAOFDATA-SAOFREC)                                     
         USING SAAGND,R3           FIND OFFICE ELEMENT                          
         XR    RF,RF                                                            
         IC    RF,SAAGNLN                                                       
         CLI   SAAGNEL,SAAGNELQ                                                 
         BE    *+8                                                              
         BXH   R3,RF,*-12                                                       
         AR    RF,R3               APPEND SPACES TO NAME                        
         MVC   0(L'SPACES,RF),SPACES                                            
         LA    R1,SAAGNNAM                                                      
         DROP  R3                                                               
*                                                                               
GAGCN10  LA    RF,L'ADUAAGNA       RF=L(OUTPUT)                                 
         LA    RF,L'SAAGNNAM                                                    
*                                                                               
         XR    RE,RE               COPY NAME INTO OUTPUT                        
         LA    RE,ADUAAGNA                                                      
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R1)                                                    
*                                                                               
GAGC200  EQU   *                                                                
         B     GAGCOK                                                           
*                                                                               
GAGCERR1 EQU   *                                                                
         LA    RE,ACRSGGE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GAGCNO                                                           
*                                                                               
GAGCOK   SR    RC,RC                                                            
GAGCNO   LTR   RC,RC                                                            
GAGCX    J     EXIT                                                             
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* SAVE TWA                                                            *         
***********************************************************************         
                                                                                
SAVETWA  NTR1                                                                   
         L     RE,ATWA             SAVE SCREEN TWA IN WORKING STORE             
         L     R0,ASAVE                                                         
         XR    R1,R1                                                            
         ICM   R1,7,SAVELEN                                                     
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* RESTORE TWA                                                         *         
***********************************************************************         
                                                                                
RESTTWA  NTR1                                                                   
         L     R0,ATWA             MOVE SAVED TWA DATA FROM STORAGE             
         L     RE,ASAVE                                                         
         XR    R1,R1                                                            
         ICM   R1,7,SAVELEN                                                     
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* SAVE UTL                                                            *         
***********************************************************************         
                                                                                
SAVEUTL  NTR1                                                                   
         L     RE,AUTL             SAVE UTL IN WORKING STORE                    
         L     R0,AUTLSAVE                                                      
         ICM   R1,15,=AL4(L'UTLSAVE)                                            
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* SWAP SAVED LOGICAL CONNECT DUMMY UTL                                *         
***********************************************************************         
                                                                                
SWAPUTL  NTR1                                                                   
         L     RE,AIOAREA          MOVE CURRENT UTL TO TEMP AREA                
         L     R0,AUTL                                                          
         ICM   R1,15,=AL4(L'UTLSAVE)                                            
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
         L     RE,AUTLSAVE                                                      
         L     R0,AUTL                                                          
         ICM   R1,15,=AL4(L'UTLSAVE)                                            
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     RE,AUTLSAVE         SAVE UTL                                     
         L     R0,AIOAREA                                                       
         ICM   R1,15,=AL4(L'UTLSAVE)                                            
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* SAVE TCB                                                            *         
***********************************************************************         
                                                                                
SAVETCB  NTR1                                                                   
         L     RE,ATCBTASK         SAVE TCB IN WORKING STORE                    
         L     R0,ATCBSAVE                                                      
         ICM   R1,15,=AL4(L'TCBSAVE)                                            
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* RESTORE TCB                                                         *         
***********************************************************************         
                                                                                
RESTTCB  NTR1                                                                   
         L     RE,ATCBTASK         MOVE SAVED TCB FROM STORAGE                  
         L     R0,ATCBSAVE                                                      
         ICM   R1,15,=AL4(L'TCBSAVE)                                            
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
         J     EXIT                                                             
         EJECT                                                                  
* LOAD STRING OF DATA INTO UNPROTECTED TWA FIELD AT GIVEN RELATIVE              
* POSITION SETTING VALUES IN FIELD HEADER                                       
*                                                                               
*     PARAMETER 1 - A(DATA)                                                     
*     PARAMETER 2 - LENGTH DATA                                                 
*     PARAMETER 3 - FIELD NUMBER                                                
*                                                                               
*     ON RETURN.                                                                
*                                                                               
LOADFLD  NTR1                                                                   
         LM    R2,R4,0(R1)         R2=A(DATA), R3=LENGTH, R4=FLD#               
*                                                                               
         SR    RF,RF               FIND UNPROTECTED FIELD                       
         L     RE,ATWA             IN TWA                                       
         LA    RE,64(RE)                                                        
         USING FLDHDRD,RE                                                       
*                                                                               
LF10     TM    FLDATB,FATBPROT                                                  
         BZ    LF30                                                             
*                                                                               
LF20     IC    RF,FLDLEN           BUMP TO NEXT FIELD                           
         AR    RE,RF                                                            
         B     LF10                                                             
*                                                                               
LF30     BCT   R4,LF20             BUMP TO NEXT FIELD                           
*                                  SET FIELD HEADER STATUS                      
         OI    FLDIIND,X'80'       INPUT THIS TIME                              
*                                  SET FIELD HEADER STATUS                      
LF32     LTR   R3,R3                                                            
         BZ    LF34                                                             
         BCTR  R3,0                                                             
         LA    RF,0(R3,R2)                                                      
         CLI   0(RF),0                                                          
         BE    LF32                                                             
         CLI   0(RF),C' '                                                       
         BE    LF32                                                             
         LA    R3,1(R3)                                                         
LF34     STC   R3,FLDILEN          INPUT LENGTH                                 
         LTR   R3,R3                                                            
         BZ    LFX                                                              
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FLDDATA(0),0(R2)    MOVE IN DATA                                 
*                                                                               
         SR    R2,R2          SET NUM/ALPHA/HEX BITS FOR INPUT FIELD            
         IC    R2,FLDILEN                                                       
         LTR   R2,R2                                                            
         BZ    LFX                                                              
         LA    R3,FLDDATA                                                       
         OI    FLDIIND,B'00001110' SET BITS ON                                  
*                                                                               
LF40     TM    FLDATB,FATBLC       LOWER CASE TESTS                             
         BZ    LF50                                                             
         CLI   0(R3),X'81'         TEST LITTLE A                                
         BL    LF50A                                                            
         CLI   0(R3),X'A9'         TEST LITTLE Z                                
         BH    LF50                                                             
         NI    FLDIIND,B'11110101' FLD NOT NUM/HEX                              
         B     LF60                                                             
*                                                                               
LF50     CLI   0(R3),C'A'                                                       
         BNL   *+12                                                             
LF50A    NI    FLDIIND,B'11110001' FLD NOT NUM/ALPHA/HEX                        
         B     LF70                                                             
LF50B    CLI   0(R3),C'Z'                                                       
         BNH   LF50C                                                            
         NI    FLDIIND,B'11111011' FLD NOT ALPHA                                
         B     LF60                                                             
LF50C    NI    FLDIIND,B'11110111' FLD NOT NUM                                  
         CLI   0(R3),C'F'                                                       
         BNH   *+8                                                              
         NI    FLDIIND,B'11111101' FLD NOT HEX                                  
*                                                                               
LF60     LA    R3,1(R3)                                                         
         BCT   R2,LF40                                                          
*                                                                               
LF70     TM    FLDATB,FATBNUM      REQUIRED NUM FIELD                           
         BZ    LFX                 NO                                           
         TM    FLDIIND,X'08'       IS IT NUM                                    
         BO    LFX                 YES                                          
         OI    FLDIIND,X'10'       NO SET FLD INV                               
         B     LFX                                                              
*                                                                               
LFX      J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* LOAD NUMBER FROM STRING                                                       
***********************************************************************         
LOADNUM  NTR1  ,                                                                
         LM    R2,R4,0(R1)                                                      
         XC    0(2,R2),0(R2)                                                    
         LTR   R4,R4                                                            
         BZ    LNUMOK                                                           
*                                                                               
LNUM010  CLI   0(R3),C'0'                                                       
         BL    LNUMOK                                                           
         CLI   0(R3),C'9'                                                       
         BH    LNUMOK                                                           
         MVC   BYTE,0(R3)                                                       
         NI    BYTE,X'0F'                                                       
         SR    RF,RF                                                            
         IC    RF,BYTE                                                          
         ICM   RE,3,0(R2)                                                       
         MH    RE,=H'10'                                                        
         AR    RE,RF                                                            
         STCM  RE,3,0(R2)                                                       
         LA    R3,1(R3)                                                         
         BCT   R4,LNUM010                                                       
         B     LNUMOK                                                           
*                                                                               
* INPUT ACTION ROUTINE RETURN POINTS                                            
*                                                                               
LNUMERRX EQU   *                                                                
         B     LNUMNO                                                           
*                                                                               
LNUMOK   SR    RC,RC                                                            
LNUMNO   LTR   RC,RC                                                            
         J     EXIT                                                             
         EJECT                                                                  
                                                                                
***********************************************************************         
* FIND IF INPUT USER-ID IS COMPATIBLE WITH A RECORD                             
* ON ENTRY R2=A(RECORD) (IP RECORD)                                             
***********************************************************************         
VALID    NTR1                                                                   
         XC    PARM(32),PARM       GET A(GETIDS)                                
*&&UK*&& MVC   PARM+4(4),=X'D9000AF9'                                           
*&&US*&& MVC   PARM+4(4),=X'D9000AFA'                                           
         GOTO1 ACALLOV,PARM,,,0                                                 
         CLI   4(R1),X'FF'                                                      
         BE    VALIDN                                                           
         MVC   AGETIDS,0(R1)                                                    
         MVC   DUB(2),0(R2)        SAVE RECORD TYPE                             
VALID0   MVI   GETOVER,0           CLEAR GETID OVERFLOW FLAG                    
         L     RF,ATIA                                                          
         GOTO1 AGETIDS,PARM,(C'C',(R2)),(RF),(C'S',ADATAMGR),          X        
               USERID,IDOSID                                                    
         TM    4(R1),X'08'         TEST GETID OUTPUT BLOCK OVERFLOW             
         BZ    *+8                                                              
         MVI   GETOVER,X'FF'       FLAG OVERFLOW ERROR IN GETIDS                
         TM    4(R1),X'01'         TEST GETIDS PARAMETER ERROR                  
         BNZ   VALID1                                                           
         CLI   12(R1),X'04'        TEST SPECIAL WILDCARD MATCH                  
         BE    VALIDY              YES CAN TREAT AS VALID                       
         CLI   8(R1),0             TEST COMPATIBLE ID COUNT BYTE 2              
         BNE   VALID4                                                           
         CLI   0(R1),0             TEST COMPATIBLE ID COUNT BYTE 1              
         BNE   VALID4                                                           
VALID1   CLI   0(R2),CT0KTEQU      IF AN AUTH RECORD                            
         BE    VALIDY              ID NEED NOT BE COMPATIBLE                    
         CLI   0(R2),C'3'          IS THIS AN IP RECORD                         
         BNE   VALID1A                                                          
         CLI   1(R2),C'I'                                                       
         BNE   VALID1A                                                          
         B     VALID1B                                                          
VALID1A  CLI   0(R2),C'T'          IS THIS A TERMINAL RECORD                    
         BNE   VALIDN              NO - EXIT                                    
VALID1B  LA    R1,CTTDATA-CTTREC(R2)                                            
         SR    R0,R0               FIND PRINCIPAL ID ELEMENT                    
*                                                                               
VALID2   CLI   0(R1),0             TEST E-O-R                                   
         BE    VALIDN                                                           
         CLI   0(R1),X'1F'         PRINCIPAL ID                                 
         BE    *+14                                                             
         IC    R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     VALID2                                                           
VALID2A  CLC   USERID,CTPID-CTPIDD(R1)                                          
         BE    VALIDY                                                           
         USING CTIREC,R2                                                        
         LA    R2,IOKEY                                                         
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,C'I'                                                     
         MVC   CTIKID,CTPID-CTPIDD(R1)                                          
         BRAS  RE,READSA                                                        
         BNE   VALIDN              CAN'T READ - IS INVALID                      
         L     R2,AIOAREA                                                       
         B     VALID0              OK GO GET COMPATIBLE ID'S                    
VALID4   L     R1,4(R1)            R1=A(COMPATIBLE ID LIST)                     
         LA    R1,0(R1)                                                         
         CLI   DUB,C'T'                                                         
         BE    VALID5                                                           
         CLI   DUB,C'3'                                                         
         BNE   VALID6                                                           
         CLI   DUB+1,C'I'                                                       
         BNE   VALID6                                                           
VALID5   MVI   ALLVALID,C'N'                                                    
VALID6   CLI   0(R1),X'FF'         TEST E-O-L                                   
         BE    VALIDN                                                           
         CLC   0(10,R1),=CL10'ALL'                                              
         BNE   VALID8                                                           
*        TM    TSTAT,TSTATDDS      ALL ONLY VALID FOR DDS TERMINALS             
*        BZ    VALID10                                                          
         MVI   ALLVALID,C'Y'                                                    
         B     VALIDY                                                           
VALID8   CLC   0(10,R1),USERID     MATCH ID WITH TABLE                          
         BE    VALIDY                                                           
VALID10  LA    R1,12(R1)                                                        
         B     VALID6                                                           
VALIDY   CR    RB,RB               SET CC=EQUAL IF ID OK                        
         J     EXIT                                                             
VALIDN   LTR   RB,RB               SET CC=NOT EQUAL IF ID NOT OK                
         J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* LOAD =PASS SCREEN WITH INPUT DATA                                             
* CALLS OVERLAYS AND SETS SYSTEM DATA FOR =PASS CALL                            
***********************************************************************         
LOADPASS NTR1                                                                   
         BRAS  RE,SAVETWA                                                       
         BRAS  RE,SAVEUTL                                                       
*                                                                               
         L     R6,ATWA             LOAD PASS BASE SCREEN                        
         LA    R6,64(R6)                                                        
         GOTO1 ACALLOV,PARM,(R6),X'D9011EFF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOPAERR2                                                         
                                                                                
*----------------------------------------------------------------------         
* MOVE DATA TO FIELDS AT RELATIVE LOGICAL POSITIONS IN TWA                      
* MOVE TEXT TO SERVICE REQUEST FIELD                                            
*----------------------------------------------------------------------         
         GOTO1 LOADFLD,PARM,=C'=PASSPC',7,1                                     
*                                                                               
         LA    R3,L'ADUAUID                                                     
         LA    R2,ADUAUID          MOVE DATA TO USER ID FIELD                   
         GOTO1 LOADFLD,PARM,(R2),(R3),2                                         
*                                                                               
         LA    R3,L'ADUAPID                                                     
         LA    R2,ADUAPID          MOVE DATA TO PERSONID FIELD                  
         GOTO1 LOADFLD,PARM,(R2),(R3),3                                         
*                                                                               
         LA    R3,L'ADUAPWD                                                     
         LA    R2,ADUAPWD          MOVE DATA TO PASSWORD FIELD                  
         GOTO1 LOADFLD,PARM,(R2),(R3),4                                         
*                                                                               
         LA    R3,L'ADNPWD                                                      
         LA    R2,ADNPWD           MOVE DATA TO NEW PASSWORD FIELD              
         GOTO1 LOADFLD,PARM,(R2),(R3),5                                         
                                                                                
*----------------------------------------------------------------------         
* SET SYSTEM STATUS TABLE VALUES AS IF FOR ENTRY DIRECT FROM FACPAK             
* MONITOR AND GOTO PASS ROUTINE                                                 
*----------------------------------------------------------------------         
         L     R2,AUTL             ADJUST UTL VALUES                            
         USING UTLD,R2                                                          
         L     R3,ATCBTASK         ADJUST TCB VALUES                            
         USING TCBD,R3                                                          
*                                                                               
         MVI   TPRG,$PASS          FILL UTL FIELDS                              
         MVC   TAGYSEC,ADUASAID                                                 
         MVC   TAGYPER,ADUAPAID                                                 
         MVC   TPASSWD,PIDNUM                                                   
         MVC   TPERSON,PIDNUM                                                   
         MVC   TUSER,UIDNUM                                                     
         MVC   TSAGN,AGRNUM                                                     
         OI    TFLAG,TFLAGSEC                                                   
*                                                                               
         MVC   TSRSAVE(2),TSVCREQ  SAVE CURRENT UTL PROGRAM STATE               
         MVI   TSYS,1                                                           
         MVI   TSVCREQ,X'01'       INDICATE CT SERVICE REQUEST STATE            
         MVI   TSVCREQ+1,$PASS                                                  
         MVI   TCBPRG,$PASS        INDICATE CT SERVICE REQUEST STATE            
         MVC   SVTSTAT1,TSTAT1                                                  
         MVC   SVTTYPE,TTYPE                                                    
         MVC   SVTVIFLG,TVIFLAG                                                 
         OI    TTYPE,TTYPEWAP      FLAG WEB APPL PROCESSING                     
         NI    TFLAG,X'FF'-TFLAGIRB INHIBIT BROADCAST MSGS                      
*                                                                               
         MVC   PARM+4(4),=X'D9011E00'                                           
         MVC   PARM(4),ACCPLODA    IN CASE NOT CORE RESIDENT ??                 
         GOTO1 ACALLOV,PARM,,,0    ADDRESS OF =PASS                             
         CLI   4(R1),X'FF'         WHICH IS CORE RESIDENT                       
         BE    LOPAERR3                                                         
         MVC   FULL,0(R1)                                                       
*                                                                               
         L     RF,FULL             GET CODE ENTRY POINT                         
         L     R1,APARMS           POINT TO ENTRY PARAMETERS                    
         BASR  RE,RF               GOTO =PASS ROUTINE                           
         BRAS  RE,GETCTER          INTERPRET ERROR MSG IN TWA LINE 1            
         OC    REASCODE,REASCODE                                                
         BNZ   LOPAERR1                                                         
*                                                                               
         L     R6,ATWA             RESTORE CALLERS TWA SCREEN                   
         LA    R6,64(R6)           LOAD OVERLAY                                 
         GOTO1 ACALLOV,PARM,(R6),X'D90121FF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOPAERR4                                                         
*                                                                               
         MVC   TCBPRG(1),TSVCREQ+1 RESTORE TCB PROGRAM STATE                    
         MVC   TSTAT1,SVTSTAT1                                                  
         MVC   TTYPE,SVTTYPE                                                    
         MVC   TVIFLAG,SVTVIFLG                                                 
*                                                                               
         BRAS  RE,SWAPUTL                                                       
         BRAS  RE,RESTTWA                                                       
         B     LOPAOK                                                           
                                                                                
*----------------------------------------------------------------------         
* INPUT ACTION ROUTINE RETURN POINTS                                            
*----------------------------------------------------------------------         
LOPAERR1 L     R6,ATWA             RESTORE CALLERS TWA SCREEN                   
         LA    R6,64(R6)           LOAD OVERLAY                                 
         GOTO1 ACALLOV,PARM,(R6),X'D90121FF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOPAERR4                                                         
*                                                                               
         MVC   TCBPRG(1),TSVCREQ+1 RESTORE TCB PROGRAM STATE                    
         MVC   TSTAT1,SVTSTAT1                                                  
         MVC   TVIFLAG,SVTVIFLG                                                 
         BRAS  RE,SWAPUTL                                                       
         BRAS  RE,RESTTWA                                                       
         B     LOPANO                                                           
*                                                                               
LOPAERR2 LHI   RE,ACRSLCE2         UNABLE TO LOAD PHASE SCREEN                  
         B     LOPAERR                                                          
LOPAERR3 LHI   RE,ACRSLCE3         UNABLE TO LOAD PHASE                         
         B     LOPAERR                                                          
LOPAERR4 LHI   RE,ACRSLCE4         UNABLE TO RESTORE TWA                        
         B     LOPAERR                                                          
LOPAERR  ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     LOPANO                                                           
*                                                                               
LOPAOK   SR    RC,RC                                                            
LOPANO   LTR   RC,RC                                                            
         J     EXIT                                                             
         DROP  R2,R3                                                            
*                                                                               
$PASS    EQU   X'1E'               =PASS PROGRAM #                              
                                                                                
***********************************************************************         
* CONSTANTS AND LITERALS                                                        
***********************************************************************         
         LTORG                                                                  
*                                                                               
         DS    0D                                                               
AMASTC   DC    A(0)                                                             
CSYSFAC  DC    A(0)                                                             
*                                                                               
OFFLMODE DC    C' '                                                             
OMMASTQ  EQU   C'M'                                                             
OMTSOBQ  EQU   C'B'                                                             
ONEK     EQU   1024                                                             
*                                                                               
         DS    0D                                                               
*                                                                               
READONLY DS    0CL8                     READONLY PID                            
*&&US*&& DC    C'READDDNY'                                                      
*&&UK*&& DC    C'READDDLO'                                                      
READPID# DS    0XL2                     READONLY PID NUMBER                     
*&&US*&& DC    X'0006'                                                          
*&&UK*&& DC    X'00DA'                                                          
*                                                                               
SPACES   DC    CL132' '                                                         
EFFS     DC    X'FFFFFFFFFFFFFFFF'                                              
*                                                                               
DMREAD   DC    C'DMREAD '          FOR DATA MANAGER CALLS                       
DMRDHI   DC    C'DMRDHI '                                                       
DMRDSQ   DC    C'DMRSEQ '                                                       
CTFILE   DC    C'CTFILE '                                                       
         DROP  RB                                                               
                                                                                
***********************************************************************         
* ROUTINE TO READ SECURITY ACCESS RECORD                              *         
***********************************************************************         
READSA   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   IOAREA(L'IOKEY),IOKEY                                            
         GOTO1 ADATAMGR,PARM,DMREAD,CTFILE,IOAREA,IOAREA                        
         J     EXIT                                                             
                                                                                
***********************************************************************         
* ROUTINE TO READ HIGH FOR A SECURITY ACCESS RECORD                   *         
***********************************************************************         
RDHISA   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   IOAREA(L'IOKEY),IOKEY                                            
         GOTO1 ADATAMGR,PARM,DMRDHI,CTFILE,IOAREA,IOAREA                        
         J     EXIT                                                             
                                                                                
***********************************************************************         
* ROUTINE TO READ SEQUENTIAL FOR A SECURITY ACCESS RECORD             *         
***********************************************************************         
RDSQSA   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   IOAREA(L'IOKEY),IOKEY                                            
         GOTO1 ADATAMGR,PARM,DMRDSQ,CTFILE,IOAREA,IOAREA                        
         J     EXIT                                                             
                                                                                
***********************************************************************         
* GET SECURITY AGENCY INFORMATION                                               
***********************************************************************         
GETSAC   NTR1  BASE=*,LABEL=*                                                   
         XC    PEXPIRE,PEXPIRE                                                  
         XC    PWARNED,PWARNED                                                  
         XC    PACSFLG,PACSFLG                                                  
*                                                                               
         LA    R2,IOKEY            READ SECURITY AGENCY ACCESS RECORD           
         USING CT5REC,R2                                                        
         L     R3,AUTL                                                          
         USING UTLD,R3                                                          
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ    C'5'                                         
         MVC   CT5KALPH,ADUASAID   SECURITY AGENCY                              
         BRAS  RE,READSA                                                        
         BNE   GSACERR1                                                         
         DROP  R3                                                               
*                                                                               
         LA    R2,IOAREA                                                        
         LA    R3,CT5DATA                                                       
GSAC010  CLI   0(R3),0             END OF RECORD                                
         BE    GSAC100                                                          
         CLI   0(R3),CTAADELQ      X'B9' AGENCY ACCESS DETAILS                  
         BE    GSAC020                                                          
GSAC012  LLC   R1,1(R3)                                                         
         AR    R3,R1                                                            
         B     GSAC010                                                          
*                                                                               
         USING CTAADD,R3           X'B9' AGENCY ACCESS DETAILS ELEMENT          
GSAC020  MVC   PEXPIRE,CTAADPTO    PASSWORD TIMEOUT IN DAYS                     
         MVC   PWARNED,CTAADPTW    PASSWORD WARNING IN DAYS                     
         MVC   PACSFLG,CTAADFLG    ACCESS CONTROLS FLAG                         
         B     GSAC012                                                          
         DROP  R2,R3                                                            
*                                                                               
GSAC100  B     GSACOK                                                           
*                                                                               
GSACERR1 LA    RE,ACRSPWE1         ERROR EXIT 1                                 
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GSACNO                                                           
*                                                                               
GSACOK   SR    RC,RC               EXIT EQUAL                                   
GSACNO   LTR   RC,RC               EXIT NOT EQUAL                               
GSACX    J     EXIT                                                             
         LTORG                                                                  
                                                                                
***********************************************************************         
* GET SYSTEMS AND PROGRAMS FOR USER/PID                                         
*  If we want to use the whole programs table, instead of the                   
*  subset table get the UTL and bump through the PGMS -AUTL TASYS               
***********************************************************************         
GETSYPR  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,IOAREA                                                        
*                                                                               
         MVI   SYPIND,USRAUTHQ     Processing User ID authorization             
         CLI   0(R2),CTIKTYPQ      User ID record                               
         BE    GSP010              Yes: Init then process record                
*                                                                               
         MVI   SYPIND,NEWAUTHQ     Processing System Access auth                
         CLI   0(R2),CT5KTYPQ      Security record                              
         BE    GSP010              Yes: process record                          
*                                                                               
         MVI   SYPIND,PERAUTHQ     Processing Person authorization              
         CLI   0(R2),SA0KTYPQ      Personal Authorization/Password              
         BE    GSP010              Yes: process record                          
         B     GSPX                                                             
*                                                                               
GSP010   CLI   SYPINIT,C'Y'        Initialized?                                 
         BE    GSP050              Yes                                          
         MVI   SYPINIT,C'Y'                                                     
*                                                                               
         LA    R4,INSYPR           SYSTEM/PROGRAM STRING                        
         LA    RE,INPROGS          SUBSET OF SYSTEM/PROGAMS FOR CALL            
         LHI   RF,INPROGSL                                                      
GSP020   MVC   0(1,R4),0(RE)       COPY OVER SYSTEM PROGRAM LIST                
         CLI   0(RE),0             AT END OF SYSTEM LIST IS ZERO                
         BE    *+12                                                             
         MVI   1(R4),0                                                          
         LA    R4,1(,R4)                                                        
         LA    R4,1(,R4)                                                        
         LA    RE,1(,RE)                                                        
         BCT   RF,GSP020                                                        
*&&UK                              UK: New Sec only ignores person auth         
         LA    R4,INSYPR                                                        
GSP030   CLI   0(R4),0                                                          
         BE    GSP050                                                           
*                                                                               
         L     R3,ASELIST          SELIST entry for Service system              
         AHI   R3,-6               Back up to start for BXLE                    
         LH    RE,0(R3)                                                         
         L     RF,2(R3)                                                         
         LA    R3,6(R3)                                                         
         USING SELISTD,R3                                                       
         CLC   SEOVSYS,0(R4)       System for programs list                     
         BE    *+10                                                             
         BXLE  R3,RE,*-10                                                       
         DC    H'0'                                                             
         ST    R3,ASENTRY                                                       
         MVC   APGMLIST,SEPGMS     Save A(Program list)                         
*                                                                               
         LA    R4,2(,R4)           Bump to subset system programs               
GSP035   CLI   0(R4),0                                                          
         BNE   GSP040                                                           
         LA    R4,1(,R4)                                                        
         B     GSP030                                                           
*                                                                               
GSP040   L     R3,APGMLIST         A(Program list)                              
         LH    RE,0(R3)                                                         
         L     RF,2(R3)                                                         
         LA    R3,6(R3)                                                         
         USING PGMLSTD,R3                                                       
         CLI   PGMCTRY,0           Is there a country code defined              
         BE    GSP041                                                           
         CLC   CUCTRY,PGMCTRY      Be sure entry is for correct country         
         BNE   GSP042                                                           
GSP041   CLC   PGMNUM,0(R4)        Find the desired program in list             
         BE    *+12                                                             
GSP042   BXLE  R3,RE,*-10                                                       
         B     GSP045                                                           
         TM    PGMIND2,PGMISECB    Security=Both                                
         BO    GSP045              Need to look at system element               
         TM    PGMIND2,PGMISECA    Security=New                                 
         BZ    GSP045              No: Need to check Person auth                
         OI    1(R4),NEWAUTHQ      Yes: No need to check Person auth            
*                                                                               
GSP045   LA    R4,2(,R4)           Next program                                 
         B     GSP035                                                           
         DROP  R3                                                               
*&&                                                                             
GSP050   LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
GSP100   CLI   0(R3),0                                                          
         BE    GSPX                                                             
         CLI   0(R3),CTSYSELQ                                                   
         BE    GSP120                                                           
GSP110   LLC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     GSP100                                                           
*                                                                               
         USING CTSYSD,R3                                                        
GSP120   LA    R4,INSYPR                                                        
GSP121   CLI   0(R4),0             Any programs for this system?                
         BE    GSP110              No: next element                             
         CLC   0(1,R4),CTSYSNUM    Is this the system we want?                  
         BE    GSP130              Yes: Process                                 
GSP122   CLI   0(R4),0                                                          
         BNE   *+12                                                             
         LA    R4,1(,R4)                                                        
         B     GSP121                                                           
         LA    R4,2(,R4)                                                        
         B     GSP122                                                           
*                                                                               
GSP130   ST    R4,FULL                                                          
         OC    1(1,R4),SYPIND                                                   
*&&UK                                                                           
         CLI   CTSYSLEN,X'18'      Check Security record system element         
         BE    GSP150                                                           
*&&                                                                             
         LA    R4,2(,R4)           First program                                
GSP140   CLI   0(R4),0             End of programs                              
         BE    GSP150                                                           
         OC    CTSYSALL,CTSYSALL   Check all equals value                       
         BZ    *+10                                                             
         OC    1(1,R4),SYPIND      Mark accordingly                             
         LA    R4,2(,R4)                                                        
         B     GSP140                                                           
*                                                                               
GSP150   L     R4,FULL                                                          
         LA    R4,2(,R4)           First program                                
*&&UK                              If New Security, ignore person Auth          
         CLI   CTSYSLEN,X'18'      Check Security record system element         
         BNE   GP158                                                            
*                                                                               
GSP152   CLI   0(R4),0             Any programs left?                           
         BE    GSP110              No: move on to next system                   
*                                                                               
         TM    SYPIND,NEWAUTHQ     Looking for New Security                     
         BZ    GSP154              No                                           
         TM    1(R4),NEWAUTHQ      Already flagged New Security only?           
         BO    GSP156              Yes: No need to check system element         
*                                                                               
GSP154   MVC   BYTE,0(R4)          Program number                               
         OC    1(1,R4),SYPIND      Default to new security                      
         BRAS  RE,GETPAVAL         Check Security bit                           
         BE    GSP156              Yes: new                                     
         XC    1(1,R4),SYPIND      Shut bit off, using old security             
*                                                                               
GSP156   LA    R4,2(,R4)           Next program                                 
         B     GSP152                                                           
*&&                                                                             
GP158    LLC   RF,CTSYSLEN                                                      
         AHI   RF,-CTSYSL1Q        Are there any valid programs?                
         BNP   GSP110              No: get next element                         
*                                                                               
         LA    RE,CTSYSPGM         Program list                                 
         AR    RF,RE               End of element                               
*                                                                               
GSP160   CLI   0(R4),0                                                          
         BE    GSP110                                                           
         LA    RE,CTSYSPGM         Reset to start of program list               
*                                                                               
GSP165   CR    RE,RF               Anymore programs?                            
         BNL   GSP200              No                                           
*                                                                               
         CLC   0(1,RE),0(R4)       Match on program                             
         BNE   GSP180                                                           
         OC    1(1,R4),SYPIND      Mark accordingly                             
         OC    1(2,RE),1(RE)       Unless we are removing access                
         BNZ   GSP180                                                           
         XC    1(1,R4),SYPIND      Shut the bit off                             
*                                                                               
GSP180   LA    RE,L'CTSYSPGM(,RE)                                               
         B     GSP165                                                           
*                                                                               
GSP200   LA    R4,2(,R4)           Next program in table                        
         B     GSP160                                                           
*                                                                               
GSPX     J     EXIT                                                             
*----------------------------------------------------------------------         
* GET PROGRAM ACCESS FLAG VALUE FROM SYSTEM ELEMENT                             
*  ON ENTRY BYTE IS 1 BYTE PROGRAM CODE, R3 POINTS TO SYSTEM ELEM.              
*  ON EXIT CC SET EQUAL IF FLAG FOUND, NE IF FLAG NOT FOUND                     
*----------------------------------------------------------------------         
         USING CTSYSD,R3                                                        
GETPAVAL NTR1                                                                   
*                                                                               
         LA    RE,1                                                             
         SLL   RE,31                                                            
         SR    RF,RF                                                            
         SR    R1,R1                                                            
         IC    R1,BYTE                                                          
         BCTR  R1,0                                                             
         SRDL  RE,0(R1)                                                         
         LTR   RE,RE                                                            
         BZ    GPAV010                                                          
         ICM   RF,15,CTSYSPGM                                                   
         NR    RE,RF                                                            
         BZ    GPAVNO                                                           
         B     GPAVYES                                                          
*                                                                               
GPAV010  ICM   RE,15,CTSYSPGM+4                                                 
         NR    RF,RE                                                            
         BZ    GPAVNO                                                           
*                                                                               
GPAVYES  SR    RC,RC               RETURN CC EQUAL                              
GPAVNO   LTR   RC,RC               RETURN CC NOT EQUAL                          
         J     EXIT                                                             
         DROP  R3                                                               
*                                                                               
         LTORG                                                                  
*----------------------------------------------------------------------         
* DEFAULT INPUT PROGRAM LIST                                                    
*----------------------------------------------------------------------         
INPROGS  DS    0X                                                               
*&&US                                                                           
         DC    X'02'   * Spot *                                                 
         DC    X'02'     GOALS                                                  
         DC    X'11'     BUY                                                    
         DC    X'17'     SFM                                                    
         DC    X'FC'     BYTRCKR                                                
         DC    X'FE'     USDESK                                                 
         DC    X'00'                                                            
*                                                                               
         DC    X'03'   * Network *                                              
         DC    X'18'     NNAV                                                   
         DC    X'1C'     SFM                                                    
         DC    X'00'                                                            
*&&                                                                             
         DC    X'04'   * Media (UK) / Print (US) *                              
*&&UK*&& DC    X'02'     BUY        /  --------                                 
*&&US*&& DC    X'11'      --------  / BUY                                       
*&&UK*&& DC    X'13'     FLIST      /  --------                                 
*&&US*&& DC    X'14'      --------  / ADBUYER                                   
*&&US*&& DC    X'1C'      --------  / SFM                                       
         DC    X'F9'     ADMIN      / ADMIN                                     
         DC    X'FA'     PRISMA     / PRISMA                                    
         DC    X'FB'     RADIA      / RADIA                                     
         DC    X'00'                                                            
*                                                                               
         DC    X'06'   * Accounting *                                           
         DC    X'24'     AURA / BRAND                                           
         DC    X'EC'     REPORT                                                 
         DC    X'ED'     TIMEOFF                                                
         DC    X'F3'     JDASHB                                                 
         DC    X'F5'     INV                                                    
         DC    X'F6'     QUIKREP                                                
         DC    X'F8'     EST                                                    
         DC    X'F9'     EXPENSE                                                
         DC    X'FA'     TIME                                                   
         DC    X'FB'     PURCHSE                                                
         DC    X'00'                                                            
*                                                                               
         DC    X'0A'   * Control *                                              
         DC    X'0D'     SECURE                                                 
         DC    X'BC'     BLKCHN                                                 
*&&US*&& DC    X'F9'     OPTICA                                                 
         DC    X'FC'     AUTHS (Lumina/IPA)                                     
         DC    X'00'                                                            
*                                                                               
         DC    X'00'                                                            
INPROGSL EQU   *-INPROGS                                                        
*                                                                               
USRAUTHQ EQU  X'80'                                                             
PERAUTHQ EQU  X'40'                                                             
NEWAUTHQ EQU  X'20'                                                             
                                                                                
***********************************************************************         
* OUTPUT SYSTEM/PROGRAM AUTHORIZED LIST                                         
***********************************************************************         
OUTSYPR  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R4,INSYPR           R4 = input - A(sys/pgm table)                
         LA    R2,IOAREA           R2 = ouput - A(auth sys/pgm list)            
*                                                                               
OSP010   CLI   0(R4),0                                                          
         BE    OSP100                                                           
*                                                                               
         TM    1(R4),USRAUTHQ+PERAUTHQ   Any system access?                     
         BO    OSP030                    Yes: check programs                    
*&&UK                                                                           
         CLC   ADUAAGCD,SPACES           Any access group for person?           
         BNH   OSP020                    No: Move on                            
         TM    1(R4),USRAUTHQ+NEWAUTHQ   In UK User/New Sec means auth          
         BO    OSP030                    Yes: Authorized                        
*&&                                                                             
OSP020   CLI   0(R4),0                                                          
         BNE   *+12                                                             
         LA    R4,1(,R4)                                                        
         B     OSP010                                                           
         LA    R4,2(,R4)                                                        
         B     OSP020                                                           
*                                                                               
OSP030   MVC   0(1,R2),0(R4)             Copy system                            
         LA    R2,1(,R2)                                                        
         LA    R4,2(,R4)                 Then look through programs             
*                                                                               
OSP040   CLI   0(R4),0                                                          
         BE    OSP070                                                           
*                                                                               
         TM    1(R4),USRAUTHQ+PERAUTHQ    Program access?                       
         BO    OSP050                     Yes: authorized                       
*&&UK                                                                           
         CLC   ADUAAGCD,SPACES           Any access group for person?           
         BNH   OSP050                    No: Move on                            
         TM    1(R4),USRAUTHQ+NEWAUTHQ    in UK User/New Sec means auth         
         BO    OSP050                     Yes: Authorized                       
*&&                                                                             
         B     OSP060                     No: next program                      
*                                                                               
OSP050   MVC   0(1,R2),0(R4)              Yes: copy in program                  
         LA    R2,1(,R2)                  and look at next                      
OSP060   LA    R4,2(,R4)                                                        
         B     OSP040                                                           
*                                                                               
OSP070   MVC   0(1,R2),0(R4)                                                    
         LA    R2,1(,R2)                                                        
         LA    R4,1(,R4)                                                        
         B     OSP010                                                           
*                                                                               
OSP100   MVC   0(1,R2),0(R4)                                                    
         LA    R2,1(,R2)                                                        
*                                                                               
         LA    R1,IOAREA                                                        
         SR    R2,R1                                                            
         ST    R2,PARM+8                                                        
*                                                                               
         ICM   RF,15,ADADATA                                                    
         ICM   R3,15,4(RF)         GET INPUT DATA ADDRESS                       
*                                                                               
         GOTO1 AHEXOUT,PARM,IOAREA,(R3),,0                                      
*                                                                               
         ICM   RF,15,ADADATA                                                    
         MVC   0(4,RF),PARM+16                                                  
*                                                                               
         J     EXIT                                                             
         LTORG                                                                  
                                                                                
***********************************************************************         
* VALIDATE USER ID AND PERSON RECORD ARE COMPATIBLE                             
***********************************************************************         
VALIDPER NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,IOKEY                                                         
         USING CTIREC,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ  RECORD TYPE C'I'                               
         MVC   CTIKNUM,UIDNUM                                                   
         BRAS  RE,READSA                                                        
         BNE   VIDPEX1                                                          
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
VIDP010  CLI   0(R3),0                                                          
         BE    VIDPEX1                                                          
         CLI   0(R3),X'02'                                                      
         BE    VIDP020                                                          
         LLC   RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     VIDP010                                                          
*                                                                               
         USING CTDSCD,R3                                                        
VIDP020  MVC   USERID,CTDSC      TEXT USER ID                                   
         DROP  R3                                                               
*                                                                               
         LA    R2,IOKEY                                                         
         USING SA0REC,R2                                                        
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ                                                 
         MVC   SA0KAGY,ADUAPAID                                                 
         MVC   SA0KNUM,PIDNUM                                                   
         BRAS  RE,READSA         READ PERSON/SYSTEM RECORD FOR USER IDS         
         BNE   VIDPEX1                                                          
*                                                                               
         MVI   BYTE,0                                                           
         LA    R3,IOAREA+(SA0DATA-SA0REC)                                       
VIDP030  CLI   0(R3),0           END OF RECORD                                  
         BE    VIDP050                                                          
         CLI   0(R3),SAPALELQ    X'C3' PID ELEMENT                              
         BE    VIDP040                                                          
         CLI   0(R3),SAIDELQ     X'20' LOOK FOR USER ID ELEMENT                 
         BNE   *+8                                                              
         MVI   BYTE,C'U'         USER ID ELEMENT FOUND                          
VIDP035  LLC   RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     VIDP030                                                          
*                                                                               
         USING SAPALD,R3                                                        
VIDP040  MVC   PERSONID,SAPALPID   SAVE PERSON ID                               
         B     VIDP035                                                          
         DROP  R3                                                               
*                                                                               
VIDP050  CLI   BYTE,C'U'           DID WE FIND USER ID ELEMENT?                 
         BNE   VIDP060             NO: THEN ALL USER IDS OK                     
*&&UK*&& MVC   PARM+4(4),=X'D9000AF9'                                           
*&&US*&& MVC   PARM+4(4),=X'D9000AFA'                                           
         GOTO1 ACALLOV,PARM,0,,0   GET A(GETIDS)                                
         LT    RF,0(R1)                                                         
         JZ    *+2                                                              
         ST    RF,AGETIDS                                                       
*                                                                               
         GOTO1 AGETIDS,PARM,(C'C',AIOAREA),0,(C'A',ADATAMGR),USERID,0           
         CLI   12(R1),0                                                         
         BE    VIDPEX1             NO MATCH FOUND, INCOMPATIBLE                 
*                                                                               
VIDP060  LA    R2,IOKEY                                                         
         USING SAPEREC,R2                                                       
         XC    SAPEKEY,SAPEKEY                                                  
         MVI   SAPETYP,SAPETYPQ  C'F'                                           
         MVI   SAPESUB,SAPESUBQ  X'04'                                          
         MVC   SAPEAGY,ADUAPAID                                                 
         MVC   SAPEPID,PERSONID                                                 
         GOTO1 ADATCON,PARM,(5,(0)),(2,SAPEDEF)                                 
         XC    SAPEDEF,EFFS        COMPLEMENT DATE                              
         BRAS  RE,RDHISA         READ PERSON/SYSTEM RECORD FOR USER IDS         
         BNE   VIDPEX2                                                          
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),IOAREA                                  
         BNE   VIDPEX2                                                          
*                                                                               
         LA    R3,IOAREA+(SAPEDATA-SAPEREC)                                     
VIDP070  CLI   0(R3),0           END OF RECORD                                  
         BE    VIDPEOK                                                          
         CLI   0(R3),SAAGCELQ    X'C8' PERSON ACCESS GROUP CODE                 
         BE    VIDP080                                                          
VIDP075  LLC   RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     VIDP070                                                          
*                                                                               
         USING SAAGCD,R3                                                        
VIDP080  MVC   AGRNUM,SAAGCNUM   PICK UP ACCESS GROUP NUMBER                    
         B     VIDP075                                                          
         DROP  R3                                                               
*                                                                               
VIDPEX1  LA    RE,ACRSPAE5       USERID NOT VALID FOR PID                       
         B     VIDPEXX                                                          
VIDPEX2  LA    RE,ACRSGPE3       PID NOT FOUND                                  
VIDPEXX  ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VIDPENO                                                          
*                                                                               
VIDPEOK  SR    RC,RC                                                            
VIDPENO  LTR   RC,RC                                                            
         J     EXIT                                                             
         DROP  R2                                                               
         LTORG                                                                  
                                                                                
***********************************************************************         
* VALIDATE IP SUBNET ID MASK AND KEY                                  *         
* AND CHECK IF THE INPUT IP ADDRESS IS IN THE RANGE OF THE SUBNET     *         
* ENTRY: SNIDMASK = SUBNET ID MASK                                    *         
*        IPRKSNID = 128-BIT SUBNET ID FROM KEY OF THE RECORD          *         
*        SNID = 128-BIT SUBNET ID FROM INPUT                          *         
*        BOTH IPRKSNID AND SNID ARE IN 1S COMPLEMENT                  *         
***********************************************************************         
VALIPM   NTR1  BASE=*                                                           
*                                  GET 2 COPIES OF SUBNET IN WORK               
         XC    WORK,WORK                                                        
         MVC   WORK(16),IPRKSNID                                                
         MVC   WORK+16(16),IPRKSNID                                             
         XC    WORK(32),=32X'FF'                                                
*                                  GET SUBNET MIN & MAX                         
         NC    WORK(16),SNIDMASK       SUBNET && MASK = SUBNET MIN              
*                                                                               
         MVC   WORK+32(16),SNIDMASK                                             
*                                                                               
         CLC   V4PREFXC,IPRKSNID   V4 IP ADDR?                                  
         BNE   *+14                                                             
         XC    WORK+44(4),=16X'FF'     INVERSE THE MASK  (V4)                   
         B     *+10                                                             
         XC    WORK+32(16),=16X'FF'    INVERSE THE MASK  (V6)                   
*                                                                               
         OC    WORK+16(16),WORK+32     SUBNET || -MASK = SUBNET MAX             
*                                                                               
*                                  CHECK IF IP ADDR IN THE RANGE                
         MVC   WORK+32(16),SNID                                                 
         XC    WORK+32(16),=16X'FF'    WORK+32 = INPUT IP ADDR                  
*                                                                               
*                                  WORK+00=SUBNET MIN                           
*                                  WORK+16=SUBNET MAX                           
*                                  WORK+32=INPUT IP ADDR                        
*                                                                               
         CLC   WORK+32(16),WORK                                                 
         BL    VIPMNO                  LOWER THAN SUBNET MIN                    
*                                                                               
         CLC   WORK+32(16),WORK+16                                              
         BH    VIPMNO                  HIGHER THAN SUBNET MAX                   
*                                                                               
*        MVC   WTOM,WORK                                                        
*        MVC   WTOM(10),=CL10'IN_RANGE'                                         
*        LA    R3,WTOML                                                         
*        WTO   TEXT=(R3),MF=(E,WTOLIST)                                         
*                                                                               
VIPMOK   SR    RC,RC                                                            
VIPMNO   LTR   RC,RC                                                            
VIPMX    J     EXIT                                                             
*                                                                               
WTOML    DC    AL2(58)                                                          
WTOM     DS    CL58                                                             
WTOLIST  WTO   TEXT=(R1),ROUTCDE=11,MF=L                                        
*                                                                               
V4PREFXC DC    X'FFFFFFFFFFFFFFFFFFFF0000'  IP V4 ADDR PREFIX(1 COMP)           
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* VALIDATE SUBNET ID                                                  *         
* ENTRY: SNIDSTRL = SUBNET ID STRING LENGTH                           *         
*        SNIDSTRV = SUBNET ID STRING VALUE                            *         
* EXIT:  SNID = 128-BIT SUBNET ID (1S COMPLEMENT)                     *         
***********************************************************************         
                                                                                
VALSNID  NTR1  BASE=*                                                           
         LA    RE,5                CHECK FIRST 5 CHAR FOR '.' OR ':'            
         LA    RF,SNIDSTRV                                                      
VSNID10  CLI   0(RF),C'.'                                                       
         BE    VSNID20             V4 SUBNET ID                                 
         CLI   0(RF),C':'                                                       
         BE    VSNID40             V6 SUBNET ID                                 
         AHI   RF,1                                                             
         BCT   RE,VSNID10                                                       
         B     VSNIDER1            INVALID SUBNET ID                            
*                                                                               
VSNID20  EQU   *                                                                
         BRAS  RE,VSNV4                                                         
         BNE   VSNIDX                                                           
         B     VSNID60                                                          
*                                                                               
VSNID40  EQU   *                                                                
         BRAS  RE,VSNV6                                                         
         BNE   VSNIDX                                                           
*                                                                               
VSNID60  XC    SNID,=16X'FF'       1'S COMPLEMENT                               
         B     VSNIDOK                                                          
*                                                                               
VSNIDER1 EQU   *                                                                
         LA    RE,ACRSSNE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNIDNO                                                          
*                                                                               
VSNIDOK  SR    RC,RC                                                            
VSNIDNO  LTR   RC,RC                                                            
VSNIDX   J     EXIT                                                             
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* VALIDATE V4 SUBNET ID                                               *         
* ENTRY: SNIDSTRL = SUBNET ID STRING LENGTH                           *         
*        SNIDSTRV = SUBNET ID STRING VALUE                            *         
* EXIT:  SNID = 128-BIT SUBNET ID                                     *         
***********************************************************************         
                                                                                
VSNV4    NTR1  BASE=*                                                           
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         LA    RF,SNIDSTRV                                                      
         XC    IPWORK(8*4),IPWORK                                               
         XC    FULL,FULL                                                        
*                                                                               
VSNV405  CLI   0(RF),C'.'          VALID CHAR ARE 0..9 OR '.'                   
         BE    VSNV410                                                          
         CLI   0(RF),C'0'                                                       
         BL    VSNV4ER1                                                         
         CLI   0(RF),C'9'                                                       
         BH    VSNV4ER2                                                         
VSNV410  AHI   RF,1                                                             
         BCT   RE,VSNV405                                                       
*                                                                               
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         LA    RF,SNIDSTRV                                                      
         LA    R3,IPWORK                                                        
*                                                                               
         LA    R4,0(RF,RE)                                                      
         BCTR  R4,0                                                             
         CLI   0(R4),C'.'                                                       
         BE    VSNV4ER3            LAST CHAR CAN'T BE '.'                       
*                                                                               
VSNV420  LA    R1,0                                                             
         LR    R4,RF                                                            
VSNV422  CLI   0(RF),C'.'                                                       
         BE    VSNV430                                                          
         AHI   RF,1                                                             
         AHI   R1,1                                                             
         BCT   RE,VSNV422                                                       
VSNV430  LTR   R1,R1               1-3 DIGIT FOR EACH NUMBER                    
         BZ    VSNV4ER4                                                         
         CHI   R1,3                                                             
         BH    VSNV4ER5                                                         
*                                  RIGHT-ALIGNED INTO THE FIELD                 
         LA    R5,4(R3)                                                         
         SR    R5,R1                                                            
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R5),0(R4)                                                    
*                                                                               
         AHI   RF,1                                                             
         AHI   R3,L'IPWORK                                                      
         LTR   RE,RE                                                            
         BZ    *+8                                                              
         BCT   RE,VSNV420                                                       
*                                                                               
         LA    RF,IPWORK                                                        
         SR    R3,RF               MUST BE 4 FIELDS FOR V4 SUBNET ID            
         CHI   R3,4*L'IPWORK                                                    
         BNE   VSNV4ER6                                                         
*                                  NOW 4 NUMBERS ARE IN 4 FULLWORD              
         LA    R3,IPWORK                                                        
         LA    R5,FULL                                                          
         LA    RE,4                                                             
*                                                                               
VSNV450  PACK  DUB,0(4,R3)         PACK, CONVERT TO BINARY                      
         CVB   RF,DUB                                                           
         CHI   RF,X'FF'                                                         
         BH    VSNV4ER7            CAN'T > 255                                  
         STC   RF,0(R5)                                                         
         AHI   R3,4                                                             
         AHI   R5,1                                                             
         BCT   RE,VSNV450                                                       
*                                                                               
         MVC   SNID(12),V4PREFIX                                                
         MVC   SNID+12(4),FULL                                                  
         B     VSNV4OK                                                          
*                                                                               
VSNV4OK  SR    RC,RC                                                            
VSNV4NO  LTR   RC,RC                                                            
         J     EXIT                                                             
*                                                                               
VSNV4ER1 EQU   *                                                                
         LA    RE,ACRSV4E1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER2 EQU   *                                                                
         LA    RE,ACRSV4E2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER3 EQU   *                                                                
         LA    RE,ACRSV4E3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER4 EQU   *                                                                
         LA    RE,ACRSV4E4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER5 EQU   *                                                                
         LA    RE,ACRSV4E5                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER6 EQU   *                                                                
         LA    RE,ACRSV4E6                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER7 EQU   *                                                                
         LA    RE,ACRSV4E7                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
         DC    0D                                                               
V4PREFIX DC    X'00000000000000000000FFFF'    IP V4 ADDRESS PREFIX              
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* VALIDATE V6 SUBNET ID                                               *         
* ENTRY: SNIDSTRL = SUBNET ID STRING LENGTH                           *         
*        SNIDSTRV = SUBNET ID STRING VALUE                            *         
* EXIT:  SNID = 128-BIT SUBNET ID                                     *         
***********************************************************************         
                                                                                
VSNV6    NTR1  BASE=*                                                           
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         LA    RF,SNIDSTRV                                                      
*                                                                               
VSNV605  CLI   0(RF),C':'          VALID CHAR ARE 0..9, A..F OR ':'             
         BE    VSNV610                                                          
         CLI   0(RF),C'A'                                                       
         BL    VSNV6ER1                                                         
         CLI   0(RF),C'F'                                                       
         BNH   VSNV610                                                          
         CLI   0(RF),C'0'                                                       
         BL    VSNV6ER1                                                         
         CLI   0(RF),C'9'                                                       
         BH    VSNV6ER1                                                         
VSNV610  AHI   RF,1                                                             
         BCT   RE,VSNV605                                                       
*                                                                               
         LA    RF,SNIDSTRV         SUBNET ID                                    
         CLI   0(RF),C':'                                                       
         BNE   *+12                                                             
         CLI   1(RF),C':'                                                       
         BNE   VSNV6ER2            CAN'T HAVE LEADING SINGLE ':'                
*                                                                               
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         BCTR  RE,0                                                             
         AR    RF,RE               LAST CHAR                                    
         CLI   0(RF),C':'                                                       
         BNE   *+14                                                             
         BCTR  RF,0                                                             
         CLI   0(RF),C':'          2ND CHAR                                     
         BNE   VSNV6ER2            CAN'T HAVE TRAILING SINGLE ':'               
*                                                                               
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         BCTR  RE,0                                                             
         LA    RF,SNIDSTRV                                                      
*                                                                               
         SR    R0,R0               # OF FIELDS                                  
         SR    R1,R1               # OF '::'                                    
         CLC   0(2,RF),=C'::'                                                   
         BE    *+8                                                              
         AHI   R0,1                                                             
*                                                                               
VSNV620  CLC   0(2,RF),=C'::'                                                   
         BNE   *+12                                                             
         AHI   R1,1                                                             
         B     VSNV625                                                          
*                                                                               
         CLI   0(RF),C':'                                                       
         BNE   VSNV625                                                          
         AHI   R0,1                : FOLLOWED BY A CHAR, 1 FIELD                
*                                                                               
VSNV625  AHI   RF,1                                                             
         BCT   RE,VSNV620                                                       
*                                                                               
         LTR   R1,R1                                                            
         BNZ   *+16                                                             
         CHI   R0,8                                                             
         BNE   VSNV6ER3            MUST BE 8 FIELD WHEN NO '::'                 
         B     VSNV630                                                          
*                                                                               
         CHI   R1,1                                                             
         BH    VSNV6ER3            CAN'T HAVE MORE THAN 1 '::'                  
*                                  '::' = AT LEAST 2 FIELDS OF 0'S              
         MHI   R1,2                                                             
         AR    R1,R0                                                            
         CHI   R1,8                                                             
         BH    VSNV6ER4            CAN'T HAVE MORE THAN 8 FIELDS                
*                                                                               
*                                  R0 = # FIELD EXCLUDE '::'                    
VSNV630  LR    R6,R0                                                            
         LA    R3,IPWORK                                                        
         ZIC   R4,SNIDSTRL         SUBNET ID LENGTH                             
         LA    R5,SNIDSTRV         SUBNET ID                                    
         MVC   0(32,R3),=32C'0'    PADDED W/ 0'S                                
*                                                                               
VSNV635  CLC   0(2,R5),=C'::'                                                   
         BE    VSNV650                                                          
         CLI   0(R5),C':'                                                       
         BNE   *+10                                                             
         AHI   R5,1                                                             
         BCTR  R4,0                                                             
*                                                                               
         LR    RE,R5                                                            
VSNV640  CLI   0(R5),C':'                                                       
         BE    VSNV643                                                          
         AHI   R5,1                                                             
         BCT   R4,VSNV640                                                       
*                                                                               
VSNV643  LR    RF,R5                                                            
         SR    RF,RE                                                            
         LTR   RF,RF               1-4 DIGIT FOR EACH NUMBER                    
         BZ    VSNV6ER5                                                         
         CHI   RF,4                                                             
         BH    VSNV6ER5                                                         
*                                  RIGHT-ALIGNED INTO THE FIELD                 
         LA    R1,4(R3)                                                         
         SR    R1,RF                                                            
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(RE)                                                    
*                                                                               
         AHI   R3,L'IPWORK                                                      
         BCTR  R6,0                                                             
         LTR   R4,R4                                                            
         BZ    VSNV6X                                                           
         B     VSNV635                                                          
*                                                                               
VSNV650  LTR   R6,R6                                                            
         BZ    VSNV6X              NO MORE INPUT FIELD LEFT                     
         AHI   R5,2                BUMP PASS '::'                               
         AHI   R4,-2                                                            
         LA    R3,IPWORK+32                                                     
         LR    RE,R6                                                            
         MHI   RE,L'IPWORK                                                      
         SR    R3,RE               NEXT NON-ZERO FIELDS                         
         B     VSNV635                                                          
*                                                                               
VSNV6X   GOTO1 AHEXIN,PARM,IPWORK,SNID,32                                       
         B     VSNV6OK                                                          
*                                                                               
VSNV6OK  SR    RC,RC                                                            
VSNV6NO  LTR   RC,RC                                                            
         J     EXIT                                                             
*                                                                               
VSNV6ER1 EQU   *                                                                
         LA    RE,ACRSV6E1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
VSNV6ER2 EQU   *                                                                
         LA    RE,ACRSV6E2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
VSNV6ER3 EQU   *                                                                
         LA    RE,ACRSV6E3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
VSNV6ER4 EQU   *                                                                
         LA    RE,ACRSV6E4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
VSNV6ER5 EQU   *                                                                
         LA    RE,ACRSV6E5                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
                                                                                
***********************************************************************         
* GET PROGRAM AUTHORISATION FROM SYSTEM ELEMENTS                                
***********************************************************************         
GETAUT   NTR1  BASE=*                                                           
*                                                                               
         XC    UIDPAUTH,UIDPAUTH                                                
         XC    PIDPAUTH,PIDPAUTH                                                
         XC    PGMAUTH,PGMAUTH                                                  
         L     R0,AUIDSYS                                                       
         BRAS  RE,SETEXPEL         GET EXTENDED ELEMENT                         
         LA    RE,EXPIDEL          NEW ELEMENT                                  
         USING CTSYSD,RE                                                        
         MVC   UIDPAUTH,CTSYSALL   SET PROGRAM AUTH FROM ID REC                 
         ZIC   R1,PGMCODE                                                       
         SLL   R1,1                                                             
         CLI   CTSYSLEN,16                                                      
         BNH   *+14                                                             
         LA    RE,CTSYSPGM-2(R1)                                                
         MVC   UIDPAUTH,0(RE)                                                   
         L     R0,APIDSYS                                                       
         BRAS  RE,SETEXPEL         GET EXTENDED ELEMENT                         
         LA    RE,EXPIDEL          NEW ELEMENT                                  
         USING CTSYSD,RE                                                        
         MVC   PIDPAUTH,CTSYSALL   SET PROGRAM AUTH FROM PASSWORD               
         ZIC   R1,PGMCODE                                                       
         SLL   R1,1                                                             
         CLI   CTSYSLEN,16                                                      
         BNH   *+14                                                             
         LA    RE,CTSYSPGM-2(R1)                                                
         MVC   PIDPAUTH,0(RE)                                                   
*                                                                               
         MVC   PGMAUTH,PIDPAUTH                                                 
         NC    PGMAUTH,UIDPAUTH                                                 
         OC    PGMAUTH,PGMAUTH                                                  
         BZ    GAUTERR1                                                         
         B     GAUTOK                                                           
*                                                                               
GAUTERR1 EQU   *                                                                
         LA    RE,ACRSAUE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GAUTNO                                                           
*                                                                               
GAUTOK   SR    RC,RC                                                            
GAUTNO   LTR   RC,RC                                                            
         J     EXIT                                                             
         DROP  RE                                                               
         EJECT                                                                  
*----------------------------------------------------------------------         
* SETEXPEL                                                                      
*----------------------------------------------------------------------         
SETEXPEL NTR1                                                                   
         LR    R1,R0               R0=A(SYSTEM AUTHORIZATION ELEMENT)           
         MVC   EXPIDEL(80),0(R1)   COPY TO MAX OF ELEMENT                       
         USING CTSYSD,R1                                                        
         TM    5(R1),X'80'         NEW FORMAT?                                  
         BZ    SETEXPLX            NO, EXIT                                     
*                                                                               
         LA    RE,256              INITIALISE ALL SLOTS TO DEF PGM AUTH         
         LA    RF,EXPIDEL+16                                                    
         MVC   0(2,RF),CTSYSALL                                                 
         LA    RF,2(RF)                                                         
         BCT   RE,*-10                                                          
*                                                                               
         SR    RE,RE                                                            
         ZIC   RF,CTSYSLEN                                                      
         SH    RF,=H'16'                                                        
         BNP   SETEXPLM            NO PROGRAM, EXIT                             
         D     RE,=F'3'            GET # OF PROGRAMS, NOT 0                     
         LTR   RE,RE               ANY REMAINDER?                               
         BNZ   SETEXPLX            SHOULDN'T BE ANY                             
*                                                                               
         LA    R3,CTSYSPGM         POINT TO FIRST ENTRY                         
         LA    R4,EXPIDEL+16                                                    
SETEXPLP ZIC   RE,0(R3)            GET THE PROGRAM #                            
         BCTR  RE,0                -1 FOR OFFSET                                
         SLL   RE,1                                                             
         AR    RE,R4               ADDRESS INTO EXPIDEL                         
         MVC   0(2,RE),1(R3)       COPY AUTHORIZATION CODE FOR PROG             
         LA    R3,3(R3)            NEXT ENTRY                                   
         BCT   RF,SETEXPLP         LOOP UNTIL ALL ARE COPIED                    
SETEXPLM CLI   CTSYSNUM,X'0A'      TEST FOR CONTROL SYSTEM ELEMENT              
         BNE   SETEXPLX                                                         
         CLI   PGMCODE,X'0C'       TEST PROG=MAD                                
         BNE   SETEXPLX                                                         
*                                  IF SO SET MAD=MAX AUTH OVERIDE               
         MVC   EXPIDEL+CTSYSALL-CTSYSD(2),=XL2'FFFF'                            
         LA    R4,EXPIDEL+16                                                    
         LA    RE,X'0C'                                                         
         BCTR  RE,0                                                             
         SLL   RE,1                                                             
         AR    RE,R4                                                            
         MVC   0(2,RE),=XL2'FFFF'                                               
SETEXPLX J     EXIT                                                             
         DROP  R1                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
***********************************************************************         
* GET PERSON ID RECORD VALUES FOR USER AUTHENTICATION                           
***********************************************************************         
GETPER   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
         USING SAPEREC,R2          READ PERSON RECORD                           
         LA    R2,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY                                                  
         MVI   SAPETYP,SAPETYPQ                                                 
         MVI   SAPESUB,SAPESUBQ                                                 
*                                                                               
GPER010  MVC   SAGY,TAGYPER        SET AGENCY USED FOR SECURTIY                 
         OC    SAGY,SAGY                                                        
         BZ    GPER020                                                          
         MVC   ADUAPAID,SAGY                                                    
         MVC   ADUASAID,TAGYSEC                                                 
         OC    ADUASAID,ADUASAID                                                
         BNZ   *+10                                                             
         MVC   ADUASAID,TAGY                                                    
         B     GPER030                                                          
*                                                                               
GPER020  MVC   SAGY,TAGYSEC                                                     
         OC    SAGY,SAGY                                                        
         BNZ   *+10                                                             
         MVC   SAGY,TAGY                                                        
         MVC   ADUASAID,SAGY                                                    
         MVC   ADUAPAID,SAGY                                                    
*                                                                               
GPER030  MVC   SAPEAGY,SAGY                                                     
         OC    ADUAPID,ADUAPID                                                  
         BZ    GPER080                                                          
         CLC   ADUAPID,SPACES                                                   
         BE    GPER080                                                          
         OC    PWDPID,PWDPID                                                    
         BZ    GPER090                                                          
         CLC   PWDPID,SPACES                                                    
         BZ    GPER090                                                          
         CLC   ADUAPID,PWDPID                                                   
         BNE   GPERERR3                                                         
         B     GPER090                                                          
*                                                                               
GPER080  OC    PWDPID,PWDPID                                                    
         BZ    GPERERR2                                                         
         CLC   PWDPID,SPACES                                                    
         BZ    GPERERR2                                                         
         MVC   ADUAPID,PWDPID                                                   
*                                                                               
GPER090  MVC   SAPEPID,ADUAPID                                                  
         GOTO1 ADATCON,PARM,(5,(0)),(2,SAPEDEF)                                 
         XC    SAPEDEF,EFFS        COMPLEMENT DATE                              
         BRAS  RE,RDHISA                                                        
         BNE   GPERERR1                                                         
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),IOAREA                                  
         BNE   GPERERR1                                                         
*                                  NO RECORD FOUND FOR THIS PERSON              
         MVC   EFFDATE,SAPEDEF                                                  
         XC    EFFDATE,EFFS                                                     
         GOTO1 ADATCON,PARM,(2,EFFDATE),(20,ADUADEF)                            
         DROP  R2                                                               
*                                                                               
         LA    R3,IOAREA+(SAPEDATA-SAPEREC)                                     
GPER110  CLI   0(R3),0             TEST E-O-R                                   
         BE    GPER200                                                          
         CLI   0(R3),SANAMELQ      TEST NAME ELEMENT                            
         BE    GPER130                                                          
         CLI   0(R3),SAPERELQ      TEST PERSONNEL DETAILS                       
         BE    GPER140                                                          
         CLI   0(R3),SAAGCELQ                                                   
         BE    GPER150                                                          
         CLI   0(R3),SAPWDELQ                                                   
         BE    GPER160                                                          
         CLI   0(R3),SAPEEELQ      EMAIL ID ELEMENT X'E5'                       
         BE    GPER170                                                          
GPER120  XR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         BXH   R3,RF,GPER110                                                    
*                                                                               
         USING SANAMD,R3           R3=A(NAME ELEMENT)                           
GPER130  XR    RE,RE                                                            
         LA    RF,SANAMES                                                       
         USING SANAMES,RF          RF=A(NAME SUB ELEMENT)                       
*                                                                               
         IC    RE,SANAMELN         COPY FIRST NAME                              
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   ADUAFNA(0),SANAME                                                
         LA    RF,L'SANAMELN+1(RE,RF)  BUMP RF TO NEXT SUB-ELEMENT              
*                                                                               
         TM    SANAMIND,SANAMIMN   TEST MIDDLE NAME PRESENT                     
         BZ    GPER132                                                          
         IC    RE,SANAMELN         COPY MIDDLE NAME                             
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   ADUAMNA(0),SANAME                                                
         LA    RF,L'SANAMELN+1(RE,RF)  BUMP RF TO NEXT SUB-ELEMENT              
*                                                                               
GPER132  IC    RE,SANAMELN         COPY LAST NAME                               
         LA    R1,L'ADUALNA        LIMITED TO OUTPUT LENGTH                     
         CR    R1,RE                                                            
         BH    *+6                                                              
         LR    RE,R1                                                            
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   ADUALNA(0),SANAME                                                
         B     GPER120                                                          
         DROP  RF                                                               
*                                                                               
         USING SAPERD,R3           EXTRACT PERSON DERTAILS                      
GPER140  MVC   ADUAOFF,SAPEROFF                                                 
         MVC   ADUADEP,SAPERDID                                                 
         GOTO1 ADATCON,PARM,(2,SAPERDHI),(20,ADUADHI)                           
         GOTO1 ADATCON,PARM,(2,SAPERDTE),(20,ADUADTE)                           
         B     GPER120                                                          
*                                                                               
         USING SAAGCD,R3           EXTRACT ACCESS GROUP CODE                    
GPER150  SR    RF,RF                                                            
         ICM   RF,3,SAAGCNUM                                                    
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ADUAAGNU,DUB+5(3)                                                
         MVC   ADUAAGCD,SAAGCCOD                                                
         B     GPER120                                                          
*                                                                               
         USING SAPWDD,R3                                                        
GPER160  SR    RF,RF                                                            
         ICM   RF,3,SAPWDNUM                                                    
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ADUAPIN,DUB+5(3)                                                 
         B     GPER120                                                          
*                                                                               
         USING SAPEED,R3                                                        
GPER170  CLC   ADPAPID,=C'04FA'    HARD CODE FOR PRINT PRISMA                   
         BE    GPER180             YES: NEED THE EMAIL                          
         CLC   ADPAPID,=C'04FB'    HARD CODE FOR PRINT/RADIA                    
         BE    GPER180             YES: NEED THE EMAIL                          
         CLC   ADPAPID,=C'0624'    HARD CODE FOR ACC BRAND/AURA                 
         BE    GPER180             YES: NEED THE EMAIL                          
         CLC   ADPAPID,=C'0A14'    HARD CODE FOR CONTROL ARCHIVE                
         BE    GPER180             YES: NEED THE EMAIL                          
         CLC   ADPAPID,=C'0ABC'    HARD CODE FOR CONTROL/BLKCHN                 
         BE    GPER180             YES: NEED THE EMAIL                          
         CLC   ADPAPID,=C'0AFC'    HARD CODE FOR CONTROL/IPA                    
         BE    GPER180             YES: NEED THE EMAIL                          
         CLC   ADPAPID,=C'0AF9'    HARD CODE FOR CONTROL OPTICA                 
         BE    GPER180             YES: NEED THE EMAIL                          
         B     GPER120             ELSE: DON'T WANT THE EMAIL                   
*                                                                               
GPER180  LLC   RF,SAPEELN                                                       
         AHI   RF,-((SAPEEID-SAPEED)+1)                                         
         BM    GPER120                                                          
         CHI   RF,L'ADUAADL3                                                    
         BL    *+8                                                              
         LHI   RF,L'ADUAADL3-1                                                  
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   ADUAADL3(0),SAPEEID                                              
         B     GPER120                                                          
*                                                                               
GPER200  B     GPEROK                                                           
         DROP  R3                                                               
*                                                                               
GPERERR1 LA    RE,ACRSGPE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPERNO                                                           
GPERERR2 LA    RE,ACRSGPE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPERNO                                                           
GPERERR3 LA    RE,ACRSGPE3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPERNO                                                           
GPEROK   SR    RC,RC                                                            
GPERNO   LTR   RC,RC                                                            
GPERX    J     EXIT                                                             
*                                                                               
         LTORG                                                                  
                                                                                
***********************************************************************         
* GET PERSON ID RECORD PIN NUMBER                                               
***********************************************************************         
GETPIN   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         OC    ADUAPID,ADUAPID                                                  
         BZ    GPIN020                                                          
         CLC   ADUAPID,SPACES                                                   
         BNE   GPIN100             PERSONAL ID IS GIVEN                         
*                                                                               
GPIN020  OC    ADUAPWD,ADUAPWD                                                  
         BZ    GPINERR4                                                         
         CLC   ADUAPWD,SPACES                                                   
         BE    GPINERR4            PASSWORD IS NOT GIVEN                        
*                                                                               
GPIN030  LA    R2,IOKEY            GET PERSONAL ID FROM PWD RECORD              
         USING SA0REC,R2                                                        
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ                                                 
         OC    ADUAPAID,ADUAPAID                                                
         BZ    *+14                                                             
         MVC   SA0KAGY,ADUAPAID                                                 
         B     *+10                                                             
         MVC   SA0KAGY,ADUASAID                                                 
         MVC   SA0KCODE,ADUAPWD                                                 
         BRAS  RE,READSA                                                        
         BNE   GPINERR4            NO PWD RECORD FOUND                          
         DROP  R2                                                               
*                                                                               
         LA    R3,IOAREA+(SA0DATA-SA0REC)                                       
GPIN040  CLI   0(R3),0             TEST E-O-R                                   
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R3),SAPALELQ                                                   
         BE    GPIN050                                                          
         XR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GPIN040                                                          
*                                                                               
         USING SAPALD,R3           EXTRACT PERSONAL ID                          
GPIN050  MVC   ADUAPID,SAPALPID                                                 
         DROP  R3                                                               
*                                                                               
         USING SAPEREC,R2          READ PERSON RECORD                           
GPIN100  LA    R2,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY                                                  
         MVI   SAPETYP,SAPETYPQ                                                 
         MVI   SAPESUB,SAPESUBQ                                                 
         OC    ADUAPAID,ADUAPAID                                                
         BZ    *+14                                                             
         MVC   SAPEAGY,ADUAPAID                                                 
         B     *+10                                                             
         MVC   SAPEAGY,ADUASAID                                                 
         MVC   SAPEPID,ADUAPID                                                  
         GOTO1 ADATCON,PARM,(5,(0)),(2,SAPEDEF)                                 
         XC    SAPEDEF,EFFS        COMPLEMENT DATE                              
         BRAS  RE,RDHISA                                                        
         BNE   GPINERR1                                                         
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),IOAREA                                  
         BNE   GPINERR1            NO RECORD FOUND FOR THIS PERSON              
         MVC   EFFDATE,SAPEDEF                                                  
         XC    EFFDATE,EFFS                                                     
         GOTO1 ADATCON,PARM,(2,EFFDATE),(20,ADUADEF)                            
         DROP  R2                                                               
*                                                                               
         LA    R3,IOAREA+(SAPEDATA-SAPEREC)                                     
GPIN110  CLI   0(R3),0             TEST E-O-R                                   
         BE    GPIN200                                                          
         CLI   0(R3),SAAGCELQ                                                   
         BE    GPIN150                                                          
         CLI   0(R3),SAPWDELQ                                                   
         BE    GPIN160                                                          
         CLI   0(R3),SAPERELQ      X'C6' PERSONNEL DETAILS                      
         BE    GPIN165                                                          
         CLI   0(R3),SAPEEELQ      X'E5' PERSON EMAIL                           
         BE    GPIN170                                                          
GPIN120  XR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         BXH   R3,RF,GPIN110                                                    
*                                                                               
         USING SAAGCD,R3           EXTRACT ACCESS GROUP CODE                    
GPIN150  SR    RF,RF                                                            
         ICM   RF,3,SAAGCNUM                                                    
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ADUAAGNU,DUB+5(3)                                                
         MVC   ADUAAGCD,SAAGCCOD                                                
         B     GPIN120                                                          
*                                                                               
         USING SAPWDD,R3                                                        
GPIN160  SR    RF,RF                                                            
         ICM   RF,3,SAPWDNUM                                                    
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ADUAPIN,DUB+5(3)                                                 
         B     GPIN120                                                          
*                                                                               
         USING SAPERD,R3                                                        
GPIN165  OC    SAPERDTE,SAPERDTE   TERMINATION DATE                             
         BZ    GPIN120                                                          
         GOTO1 ADATCON,PARM,(2,SAPERDTE),(20,ADUADTE)                           
         B     GPIN120                                                          
*                                                                               
         USING SAPEED,R3                                                        
GPIN170  CLI   ACTN,ACCPCP         CHANGE PASSWORD ACTION?                      
         BNE   GPIN120             NO: DON'T GRAB EMAIL                         
         LLC   RF,SAPEELN                                                       
         AHI   RF,-SAPEELNQ-1                                                   
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   ADUAADL3(0),SAPEEID EMAIL ADDRESS                                
         B     GPIN120                                                          
*                                                                               
GPIN200  B     GPINOK                                                           
         DROP  R3                                                               
*                                                                               
GPINERR1 LA    RE,ACRSGPE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPINNO                                                           
GPINERR4 LA    RE,ACRSGPE4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPINNO                                                           
*                                                                               
GPINOK   SR    RC,RC                                                            
GPINNO   LTR   RC,RC                                                            
GPINX    J     EXIT                                                             
*                                                                               
         LTORG                                                                  
                                                                                
***********************************************************************         
* GET PERSON PASSWORD RECORD VALUES USER AUTHENTICATION               *         
***********************************************************************         
GETPWD   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    PWDPID,PWDPID                                                    
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
         LA    R2,IOKEY                                                         
         USING SA0REC,R2                                                        
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ                                                 
*                                                                               
GPWD010  MVC   SAGY,TAGYPER        SET AGENCY USED FOR SECURTIY                 
         OC    SAGY,SAGY                                                        
         BZ    GPWD020                                                          
         MVC   ADUAPAID,SAGY                                                    
         MVC   ADUASAID,TAGYSEC                                                 
         OC    ADUASAID,ADUASAID                                                
         BNZ   *+10                                                             
         MVC   ADUASAID,TAGY                                                    
         B     GPWD030                                                          
*                                                                               
GPWD020  MVC   SAGY,TAGYSEC                                                     
         OC    SAGY,SAGY                                                        
         BNZ   *+10                                                             
         MVC   SAGY,TAGY                                                        
         MVC   ADUASAID,SAGY                                                    
         MVC   ADUAPAID,SAGY                                                    
*                                                                               
GPWD030  MVC   SA0KAGY,SAGY                                                     
         MVC   SA0KNUM,TPASSWD                                                  
         BRAS  RE,READSA                                                        
         BNE   GPWDERR2                                                         
         CLC   SA0KEY(SA0LEN-SA0KEY),IOAREA                                     
         BNE   GPWDERR1                                                         
         DROP  R2                                                               
         LA    R3,IOAREA+(SA0DATA-SA0REC)                                       
         MVI   BYTE,C'N'                                                        
GPWD110  CLI   0(R3),0             TEST E-O-R                                   
         BE    GPWDERR3                                                         
         CLI   0(R3),SAPALELQ      TEST PERSON ID ELEMENT                       
         BE    GPWD130                                                          
GPWD120  XR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         BXH   R3,RF,GPWD110                                                    
*                                                                               
         USING SAPALD,R3           EXTRACT PERSON ID ELEMENT                    
GPWD130  MVC   PWDPID,SAPALPID                                                  
*                                                                               
GPWD200  B     GPWDOK                                                           
         DROP  R3                                                               
*                                                                               
GPWDERR1 LHI   RE,ACRSPWE1                                                      
         B     GPWDEX                                                           
GPWDERR2 LHI   RE,ACRSPWE2                                                      
         B     GPWDEX                                                           
GPWDERR3 LHI   RE,ACRSPWE3                                                      
GPWDEX   ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPWDNO                                                           
*                                                                               
GPWDOK   SR    RC,RC                                                            
GPWDNO   LTR   RC,RC                                                            
GPWDX    J     EXIT                                                             
         LTORG                                                                  
         DROP  R4                                                               
                                                                                
***********************************************************************         
* GET PROGRAM LIMIT ACCESS FROM SYSTEM ELEMENTS                       *         
***********************************************************************         
GETLAC   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    RE,PGMLACC                                                       
         ICM   RF,15,=AL4(L'PGMLACC)                                            
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
*                                                                               
         XC    UIDLACC,UIDLACC                                                  
         XC    PIDLACC,PIDLACC                                                  
         XC    PIDLIDC,PIDLIDC                                                  
         XC    WORK,WORK                                                        
         USING CTSYSD,R3                                                        
*&&US                                                                           
         XC    DMCB(8),DMCB                                                     
         MVC   DMCB+4(4),=X'D9000A15'  GET ADDRESS OF CLUNPK                    
         GOTO1 ACALLOV,DMCB                                                     
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   ACLUNPK,0(R1)                                                    
*&&                                                                             
         OC    AUIDSYS,AUIDSYS                                                  
         BZ    GLAC010                                                          
         L     R3,AUIDSYS                                                       
         MVC   UIDLACC,CTSYSLMT                                                 
*&&US*&& GOTO1 ACLUNPK,DMCB,CTSYSLMT,UIDLACC,0                                  
*                                                                               
GLAC010  OC    APIDSYS,APIDSYS                                                  
         BZ    GLAC020                                                          
         L     R3,APIDSYS                                                       
         MVC   PIDLIDC,CTSYSLID                                                 
         MVC   PIDLACC,CTSYSLMT                                                 
*&&US*&& GOTO1 ACLUNPK,DMCB,CTSYSLMT,PIDLACC,0                                  
*                                                                               
GLAC020  MVC   PGMLACC(4),PIDLACC                                               
         OC    PGMLACC(4),PGMLACC                                               
         BNZ   GLAC100                                                          
         MVC   PGMLACC(4),UIDLACC                                               
         OC    PGMLACC(4),PGMLACC                                               
         BNZ   GLAC100                                                          
         MVC   PGMLACC(4),=CL4'    '                                            
*                                                                               
GLAC100  EQU   *                                                                
         OC    PIDLIDC,PIDLIDC                                                  
         BZ    GLACOK                                                           
         MVC   PGMLACC+4(4),=CL4':;;:'                                          
*                                                                               
         XC    PIDLID,PIDLID                                                    
         OC    ARCPACK,ARCPACK                                                  
         BZ    GLACOK                                                           
         GOTO1 ARCPACK,PARM,(C'U',PIDLIDC),(X'80',PIDLID)                       
         LA    R2,IOKEY                                                         
         USING SATLREC,R2                                                       
         XC    SATLKEY,SATLKEY                                                  
         MVI   SATLTYP,SATLTYPQ                                                 
         MVI   SATLSUB,SATLSUBQ                                                 
         OC    ADUAPAID,ADUAPAID                                                
         BZ    *+14                                                             
         MVC   SATLAGY,ADUAPAID                                                 
         B     *+10                                                             
         MVC   SATLAGY,ADUASAID                                                 
         MVC   SATLSYS,SYSCODE                                                  
         MVC   SATLLID,PIDLID                                                   
         DROP  R2                                                               
         GOTO1 AOFFLAL,PARM,(1,ACOMFACS),IOKEY,AIOAREA                          
         CLI   0(R1),0                                                          
         BNE   GLACOK                                                           
         L     RF,8(R1)                                                         
         LA    RE,PGMLACC+5                                                     
         LA    R0,240                                                           
         CLI   0(RF),0                                                          
         BE    GLAC210                                                          
*                                                                               
GLAC200  EQU   *                                                                
         OC    0(2,RF),0(RF)                                                    
         BZ    GLAC210                                                          
         MVC   0(1,RE),0(RF)                                                    
         CLI   0(RE),0                                                          
         BNE   *+8                                                              
         MVI   0(RE),C';'                                                       
         LA    RF,1(RF)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,GLAC200                                                       
*                                                                               
GLAC210  EQU   *                                                                
         MVC   0(3,RE),=CL3';;:'                                                
         B     GLACOK                                                           
*                                                                               
GLACOK   SR    RC,RC                                                            
GLACNO   LTR   RC,RC                                                            
         J     EXIT                                                             
         DROP  R3                                                               
         LTORG                                                                  
                                                                                
***********************************************************************         
* GENERAL ACCESS INFORMATION CALL                                               
* FACPAK IS CONNECTED TO PROGRAM                                                
* FASECRET INIT HAS BEEN CALLED                                                 
* SECRET BLOCK AT ASECBLOC                                                      
*                                                                               
* R8=A(PARAMETER LIST)   - ACCPARMD                                             
* R7=A(ACCESS DATA AREA) - ACCDATAD                                             
*                                                                               
* EXIT:                                                                         
* ADUC - CONTAINS STRING OF DESIRED ACCESS INFORMATION                          
*        FORMAT XX="XXX"                                                        
*               PX="27"  DAYS UNTIL PASSWORD EXPIRES                            
***********************************************************************         
GEACIN   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    PEXPIRE,PEXPIRE                                                  
         XC    PWARNED,PWARNED                                                  
         XC    PACSFLG,PACSFLG                                                  
         XC    PLCDATE,PLCDATE                                                  
         XC    PLCTIME,PLCTIME                                                  
         XC    PLCFLAG,PLCFLAG                                                  
*----------------------------------                                             
* CONTROL ACCESS RECORD                                                         
*----------------------------------                                             
         LA    R2,IOKEY                                                         
         USING CT5REC,R2                                                        
         L     R3,AUTL                                                          
         USING UTLD,R3                                                          
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ    C'5'                                         
         MVC   CT5KALPH,TAGY       AGENCY ID                                    
         CLC   TAGYSEC,SPACES                                                   
         BNH   *+10                                                             
         MVC   CT5KALPH,TAGYSEC    SECURITY AGENCY ID                           
         CLC   TAGYPER,SPACES                                                   
         BNH   *+10                                                             
         MVC   CT5KALPH,TAGYPER    PERSON SECURITY AGENCY ID                    
         BRAS  RE,READSA                                                        
         BNE   GEACERR1                                                         
         DROP  R3                                                               
*                                                                               
         LA    R2,IOAREA                                                        
         LA    R3,CT5DATA                                                       
GEAC010  CLI   0(R3),0             END OF RECORD                                
         BE    GEAC100                                                          
         CLI   0(R3),CTAADELQ      X'B9' AGENCY ACCESS DETAILS                  
         BE    GEAC020                                                          
GEAC012  SR    R1,R1                                                            
         IC    R1,1(R3)                                                         
         AR    R3,R1                                                            
         B     GEAC010                                                          
*                                                                               
         USING CTAADD,R3           X'B9' AGENCY ACCESS DETAILS ELEMENT          
GEAC020  MVC   PEXPIRE,CTAADPTO    PASSWORD TIMEOUT IN DAYS                     
         MVC   PWARNED,CTAADPTW    PASSWORD WARNING IN DAYS                     
         MVC   PACSFLG,CTAADFLG    ACCESS CONTROLS FLAG                         
         B     GEAC012                                                          
         DROP  R2,R3                                                            
                                                                                
*----------------------------------                                             
* SECURITY PERSON PASSWORD RECORD                                               
*----------------------------------                                             
GEAC100  LA    R2,IOKEY            READ PERSON PASSWORD RECORD                  
         USING SA0REC,R2                                                        
         L     R3,AUTL                                                          
         USING UTLD,R3                                                          
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ    C'0'                                         
         MVC   SA0KAGY,TAGY        AGENCY ID                                    
         CLC   TAGYSEC,SPACES                                                   
         BNH   *+10                                                             
         MVC   SA0KAGY,TAGYSEC     SECURITY AGENCY ID                           
         CLC   TAGYPER,SPACES                                                   
         BNH   *+10                                                             
         MVC   SA0KAGY,TAGYPER     PERSON SECURITY AGENCY ID                    
         MVC   SA0KNUM,TPASSWD                                                  
         BRAS  RE,READSA                                                        
         BNE   GEACERR2                                                         
         DROP  R3                                                               
*                                                                               
         LA    R2,IOAREA                                                        
         LA    R3,SA0DATA                                                       
GEAC110  CLI   0(R3),0             TEST E-O-R                                   
         BE    GEAC200                                                          
         CLI   0(R3),SAPWHELQ      X'E4' PASSWORD HISTORY ELEMENT               
         BE    GEAC120                                                          
GEAC112  SR    R1,R1                                                            
         IC    R1,1(R3)                                                         
         AR    R3,R1                                                            
         B     GEAC110                                                          
*                                                                               
         USING SAPWHD,R3           X'E4' PASSWORD HISTORY ELEMENT               
GEAC120  CLC   PLCDATE,SAPWHDTE                                                 
         BH    GEAC112                                                          
         BL    *+14                                                             
         CLC   PLCTIME,SAPWHTME                                                 
         BH    GEAC112                                                          
         MVC   PLCDATE,SAPWHDTE                                                 
         MVC   PLCTIME,SAPWHTME                                                 
         MVC   PLCFLAG,SAPWHFLG                                                 
         B     GEAC112                                                          
                                                                                
*----------------------------------                                             
* FINISH AND BUILD USER CONTROL DATA                                            
*----------------------------------                                             
GEAC200  LA    R5,ADUC                                                          
         XC    ADUC,ADUC                                                        
*                                                                               
* PX= DAYS UNTIL PASSWORD EXPIRES IF IN WARNING PERIOD                          
*                                                                               
         MVC   0(4,R5),=C'PX=N'                                                 
         TM    PACSFLG,CTAADPRQ    NON-PPS DOES NOT EXPIRE                      
         BZ    GEACOK                                                           
         CLI   PEXPIRE,0           NO EXPIRE DATE                               
         BE    GEACOK                                                           
         MVI   3(R5),C'0'          PASSWORD EXPIRED                             
         OC    PLCDATE,PLCDATE                                                  
         BZ    GEACOK                                                           
         CLC   PLCDATE,=X'CA21'    OLD ADMIN RESET DATE - JAN01/2001            
         BE    GEACOK                                                           
         TM    PLCFLAG,SAPWHEXP    AUTOMATIC EXPIRE?                            
         BO    GEACOK                                                           
         GOTO1 ADATCON,PARM,(5,0),(0,TODAY0)                                    
         GOTO1 ADATCON,PARM,(2,PLCDATE),(0,WORK)                                
         XC    PARM+8(4),PARM+8    SET UP PARAMETER 3 FOR ADDAY                 
         IC    R1,PEXPIRE                                                       
         BCTR  R1,0                                                             
         STC   R1,PARM+11                                                       
         L     RF,ACOMFACS                                                      
         L     RF,CADDAY-COMFACSD(RF)                                           
         GOTO1 (RF),PARM,(C'D',WORK),(0,WORK+6)                                 
         CLC   TODAY0,WORK+6                                                    
         BH    GEACOK                                                           
         L     RF,ACOMFACS                                                      
         L     RF,CPERVERT-COMFACSD(RF)                                         
         GOTO1 (RF),PARM,TODAY0,WORK+6                                          
*                                                                               
         SR    R0,R0                                                            
         IC    R0,PWARNED          PASSWORD WARNING PERIOD IN DAYS              
         MVI   3(R5),C'N'          PASSWORD NOT EXPIRED,BUT NO WARNING          
         CH    R0,PARM+8           IN WARNING PERIOD?                           
         BL    GEACOK              . NO                                         
*                                                                               
         LA    R5,3(R5)                                                         
         EDIT  (B2,PARM+8),(3,(R5)),ZERO=NOBLANK,ALIGN=LEFT                     
         LA    R5,1(R5)                                                         
*                                                                               
         B     GEACOKX                                                          
         DROP  R2,R3                                                            
                                                                                
*----------------------------------                                             
* ERRORS AND EXIT                                                               
*----------------------------------                                             
GEACERR1 LA    RE,ACRSPWE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GEACNO                                                           
*                                                                               
GEACERR2 LA    RE,ACRSPWE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GEACNO                                                           
*                                                                               
GEACOK   AHI   R5,4                BUMP R5 FOR NEXT FIELD                       
GEACOKX  SR    RC,RC                                                            
GEACNO   LTR   RC,RC                                                            
GEACX    J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*&&US                                                                           
***********************************************************************         
* SYSTEM SERVICE CALL. US VERSION                                     *         
* FACPAK IS CONNECTED TO PROGRAM AND SWITCHED TO SYSTEM               *         
* FASECRET INIT HAS BEEN CALLED                                       *         
* SECRET BLOCK AT ASECBLOC                                            *         
*                                                                     *         
* R8=A(PARAMETER LIST)   - ACCPARMD                                   *         
* R7=A(ACCESS DATA AREA) - ACCDATAD                                   *         
*                                                                     *         
* ENTRY:                                                              *         
* ADADATA   - A(INPUT DATA BUFFER LENGTH)                             *         
* ADADATA+4 - A(INPUT DATA BUFFER)                                    *         
*                                                                     *         
* EXIT:                                                               *         
* ADADATA   - A(RETURN DATA BUFFER LENGTH)                            *         
* ADADATA+4 - A(RETURN DATA BUFFER)                                   *         
*                                                                     *         
***********************************************************************         
                                                                                
SSCALL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   SYSCODE,X'02'             SPOT                                   
         BE    SSCALL02                                                         
         CLI   SYSCODE,X'03'             NET                                    
         BE    SSCALL02                                                         
         CLI   SYSCODE,X'04'             PRINT                                  
         BE    SSCALL04                                                         
         CLI   SYSCODE,X'0D'             SPOT TRAFFIC                           
         BNE   SSCALLX                                                          
*                                                                               
SSCALL02 XC    DMCB(8),DMCB                                                     
         MVC   DMCB+4(4),=X'D9000A14'    GET ADDRESS OF CLPACK                  
         GOTO1 ACALLOV,DMCB                                                     
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   ACLPACK,0(R1)                                                    
*                                                                               
SSCALL04 XC    DMCB(8),DMCB                                                     
         MVC   DMCB+4(4),=X'D9000A38'    GET ADDRESS OF OFFICER                 
         GOTO1 ACALLOV,DMCB                                                     
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   AOFFICER,0(R1)                                                   
*                                                                               
         NI    INDICS,X'FF'-INDIMED      RESET MEDIA INDICATOR                  
*                                                                               
         ICM   RF,15,ADADATA                                                    
         ICM   R2,15,0(RF)               GET INPUT DATA LENGTH                  
         ICM   R3,15,4(RF)               GET INPUT DATA ADDRESS                 
*                                                                               
         CLI   SYSCODE,X'04'             PRINT                                  
         BNE   *+14                                                             
         MVC   SVMEDIA,0(R3)             PRINT MEDIA                            
         B     SSCALL08                                                         
*                                                                               
         ICM   RF,15,=V(MEDGET)          MUST BE IN THE LINK                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         A     RF,RELO                                                          
         GOTO1 (RF),DMCB,(0(R3),ADUAUAID),ADATAMGR,SVMEDIA                      
         CLI   DMCB+8,X'FF'                                                     
         BNE   *+8                                                              
         OI    INDICS,INDIMED            MEDIA INVALID                          
*                                                                               
SSCALL08 XC    KEY,KEY                                                          
         AHI   R3,1                      BUMP INPUT ADDRESS                     
         AHI   R2,-1                     ADJUST STRING LENGTH                   
*                                                                               
*----------------------------------------                                       
* READ CLIENT RECORD & MAKE OFFICER CALL                                        
*----------------------------------------                                       
SSCALL10 TM    INDICS,INDIMED            MEDIA INVALID?                         
         BO    SSCALLNO                  YES, MARK CLIENTS WITH A NO            
*                                                                               
         LR    R1,R3                     SPACE OUT CLIENT                       
         LHI   RF,3                      OLD SSCALL SUPPORTS 3 BYTES            
         CLI   ACTN,ACCSSRV              SYSTEM SERVICE CALL                    
         BE    *+8                                                              
         LHI   RF,5                      NEW CALL ITS 5 TO SUPPORT UK           
SSCALL12 CLI   0(R1),0                                                          
         BNE   *+8                                                              
         MVI   0(R1),C' '                                                       
         LA    R1,1(R1)                                                         
         BCT   RF,SSCALL12                                                      
*                                                                               
         CLI   SYSCODE,X'04'             PRINT                                  
         BE    SSCALL20                                                         
*                                                                               
* SPOT, NET, STRAFFIC                                                           
*                                                                               
         MVC   KEY+1(1),SVMEDIA                                                 
         GOTO1 ACLPACK,DMCB,(R3),KEY+2                                          
*                                                                               
         MVC   KEYSAVE,KEY                                                      
         GOTO1 ADATAMGR,DMCB,=C'DMRDHI',=C'SPTDIR',KEY,KEY                      
         CLC   KEY(13),KEYSAVE                                                  
         BNE   SSCALLNO                                                         
*                                                                               
         GOTO1 (RF),(R1),=C'GETREC',=C'SPTFILE',KEY+14,AIOAREA,DMWORK           
         BNE   SSCALLNO                                                         
*                                                                               
         L     RF,AIOAREA                                                       
         USING CLTHDRD,RF                                                       
*                                        SET UP OFFICER CALL                    
         XC    WORK,WORK                                                        
         LA    R1,WORK                                                          
         USING OFFICED,R1                                                       
*                                                                               
         MVI   OFCSYS,C'S'                                                      
         L     RE,ATWA                                                          
         MVC   OFCAUTH,6(RE)                                                    
         MVC   OFCLMT(4),6(RE)                                                  
         MVC   OFCAGY,ADUAUAID                                                  
         MVC   OFCOFC,COFFICE                                                   
         MVC   OFCCLT,0(R3)                                                     
         OC    OFCCLT,=C'   '                                                   
         MVC   OFCSAGMD,KEY+1                                                   
         MVC   OFCACCSC(3),CACCESS                                              
         MVI   OFCACCSM,X'FF'            SUPPRESS MARKET ACCESS                 
         MVC   OFCSECD,ASECBLOC                                                 
         B     SSCALL50                                                         
         DROP  R1,RF                                                            
*                                                                               
* PRINT                                                                         
*                                                                               
C        USING PCLTRECD,KEY                                                     
SSCALL20 MVC   C.PCLTKAGY,ADUAUAID       AGENCY ALPHA                           
         MVC   C.PCLTKMED,SVMEDIA        PRINT MEDIA                            
         MVI   C.PCLTKRCD,X'02'          RECORD CODE                            
         MVC   C.PCLTKCLT,0(R3)          CLIENT                                 
*                                                                               
         MVC   KEYSAVE,KEY                                                      
         GOTO1 ADATAMGR,DMCB,=C'DMRDHI',=C'PRTDIR',KEY,KEY                      
         CLC   KEY(25),KEYSAVE                                                  
         BNE   SSCALLNO                                                         
*                                                                               
         GOTO1 (RF),(R1),=C'GETREC',=C'PRTFILE',KEY+27,AIOAREA,DMWORK           
         BNE   SSCALLNO                                                         
         DROP  C                                                                
*                                                                               
         L     RF,AIOAREA                                                       
         USING PCLTRECD,RF                                                      
*                                        SET UP OFFICER CALL                    
         XC    WORK,WORK                                                        
         LA    R1,WORK                                                          
         USING OFFICED,R1                                                       
*                                                                               
         L     RE,ATWA                                                          
         MVI   OFCSYS,C'P'                                                      
         MVC   OFCAUTH,6(RE)                                                    
         MVC   OFCLMT(4),6(RE)                                                  
         MVC   OFCAGY,PCLTKAGY                                                  
         MVC   OFCOFC,PCLTOFF                                                   
         MVC   OFCCLT,PCLTKCLT                                                  
         OC    OFCCLT,=3C' '                                                    
         MVC   OFCPMED,PCLTKMED                                                 
         MVI   OFCACCSM,X'FF'            SUPPRESS MARKET ACCESS                 
         MVC   OFCSECD,ASECBLOC                                                 
         DROP  R1,RF                                                            
*                                                                               
SSCALL50 GOTO1 AOFFICER,DMCB,(C'N',WORK),ACOMFACS                               
*                                                                               
         MVI   BYTE,C'Y'                 ASSUME ACCESS ALLOWED                  
         CLI   0(R1),0                                                          
         BE    *+8                                                              
SSCALLNO MVI   BYTE,C'N'                                                        
*                                                                               
         LHI   R1,3                      OLD SSCALL SUPPORTS 3 BYTES            
         CLI   ACTN,ACCSSRV              SYSTEM SERVICE CALL                    
         BE    *+8                                                              
         LHI   R1,5                      NEW CALL ITS 5 TO SUPPORT UK           
*                                                                               
         AR    R3,R1                     AFTER CLIENT                           
         MVC   0(1,R3),BYTE              PUT ACCESS VALUE Y/N                   
*                                                                               
         MVC   KEY,KEYSAVE               RESTORE PREV KEY IN CASE NF            
         LA    R3,1(R3)                  BUMP TO NEXT CLIENT                    
         AHI   R1,1                      ADD ONE TO LENGTH FOR Y/N              
         SR    R2,R1                     CLIENT LENGTH FROM TOTAL               
         LTR   R2,R2                     ANYTHING LEFT?                         
         BP    SSCALL10                                                         
*                                                                               
SSCALLX  SR    RC,RC                                                            
         LTR   RC,RC                                                            
         J     EXIT                                                             
         LTORG                                                                  
*&&                                                                             
         EJECT                                                                  
*&&UK                                                                           
***********************************************************************         
* SYSTEM SERVICE CALL. UK VERSION                                     *         
* FACPAK IS CONNECTED TO PROGRAM AND SWITCHED TO SYSTEM               *         
* FASECRET IS NOT USED                                                *         
*                                                                     *         
* R8=A(PARAMETER LIST)   - ACCPARMD                                   *         
* R7=A(ACCESS DATA AREA) - ACCDATAD                                   *         
*                                                                     *         
* ENTRY:                                                              *         
* ADADATA   - A(INPUT DATA BUFFER LENGTH)                             *         
* ADADATA+4 - A(INPUT DATA BUFFER)                                    *         
*                                                                     *         
* EXIT:                                                               *         
* ADADATA   - A(RETURN DATA BUFFER LENGTH)                            *         
* ADADATA+4 - A(RETURN DATA BUFFER)                                   *         
*                                                                     *         
***********************************************************************         
                                                                                
SSCALL   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         ICM   RF,15,ADADATA                                                    
         ICM   R2,15,0(RF)         GET INPUT DATA LENGTH                        
         ICM   R3,15,4(RF)         GET INPUT DATA ADDRESS                       
*                                                                               
         NI    INDICS,X'FF'-INDIMED                                             
*                                                                               
         L     RF,AIOAREA          INITIALISE LIMACC BLOCK                      
         USING LIMACCD,RF          ONLY DONE ONCE (SEE SC004)                   
         XC    LABLK(LABLKL),LABLK CLEAR BLOCK                                  
         MVI   LASYS,4                                                          
         L     R1,AUTL                                                          
         MVC   LAAGY,TAGYPER-UTLD(R1)                                           
         L     R1,ATWA                                                          
         MVC   LALIMACC,TWAACCS-TWAD(R1)                                        
         DROP  RF                                                               
         GOTO1 ALIMACC,DMCB,(C'I',(RF)),ACOMFACS                                
         BE    SSCALL04                                                         
         OI    INDICS,INDIMED      SECURITY LOCKOUT TREAT AS BAD MEDIA          
         B     SSCALL08                                                         
*                                                                               
SSCALL04 LA    R4,KEY                                                           
         USING DMED,R4                                                          
         XC    MEDKEY,MEDKEY                                                    
         MVC   MEDKAM,UIDSYSEL+CTSYSAGB-CTSYSD (TAGYB NO GOOD HERE)             
         MVI   MEDKTYP,MEDKPASQ                                                 
         MVC   MEDKCODE,0(R3)                                                   
         MVC   KEYSAVE,KEY                                                      
         GOTO1 ADATAMGR,DMCB,=C'DMREAD',=C'MEDDIR',KEY,KEY                      
         CLI   DMCB+8,0                                                         
         BE    *+8                                                              
         OI    INDICS,INDIMED      MEDIA INVALID                                
*                                                                               
         OC    MEDKAM,MEDDNUM      COPY MEDIA NUM TO AGENCY/MEDIA BYTE          
         MVC   SVMEDSTA,MEDDSTAT   SAVE MEDIA STATUS BYTE                       
         DROP  R4                                                               
*                                                                               
         USING DCLI,R4                                                          
         MVI   CLIKTYP,CLIKTYPQ                                                 
*                                                                               
SSCALL08 AHI   R3,1                BUMP INPUT ADDRESS                           
         AHI   R2,-1               ADJUST STRING LENGTH                         
*                                                                               
SSCALL10 TM    INDICS,INDIMED      MEDIA INVALID?                               
         BO    SSCALLNO            YES, MARK CLIENTS WITH A NO                  
*                                                                               
         LR    R1,R3               SPACE OUT CLIENT                             
         LHI   RF,5                ALWAYS 5 BYTE CLIENT FOR UK                  
SSCALL12 CLI   0(R1),0                                                          
         BNE   *+8                                                              
         MVI   0(R1),C' '                                                       
         LA    R1,1(R1)                                                         
         BCT   RF,SSCALL12                                                      
*                                                                               
         MVC   CLIKCLI,0(R3)       ASSUME 3 BYTE CLIENT                         
         CLC   3(2,R3),=C'  '                                                   
         BE    SSCALL12            YES                                          
         MVC   WORK(4),1(R3)       NO, MUST BE 5 BYTES XNNNN                    
         NC    WORK(4),=C'0000'                                                 
         CLC   WORK(4),=C'0000'                                                 
         BNE   SSCALLNO            NOT NNNN SO NOT VALID                        
         PACK  DUB,1(4,R3)                                                      
         CVB   R1,DUB                                                           
         STCM  R1,3,CLIKCLI+1      COMPRESS TO XNN                              
*                                                                               
SSCALL12 MVC   KEYSAVE,KEY                                                      
         GOTO1 ADATAMGR,DMCB,=C'DMREAD',=C'MEDDIR',KEY,KEY                      
         CLI   DMCB+8,0                                                         
         BNE   SSCALLNO                                                         
                                                                                
* CALL LIMACC TO VALIDATE LIMIT ACCESS                                          
                                                                                
         XC    WORK,WORK                                                        
         MVC   WORK(4),CLIDCAGY                                                 
         MVC   WORK+4(3),CLIKCLI                                                
         MVI   BYTE,0              CHECK CLIAGY/BAGY/ACC1/ACC2/CLI              
         TM    SVMEDSTA,MEDCACCQ   IF CRE AGY CAN BE AT PRODUCT LEVEL           
         BO    *+8                                                              
         OI    BYTE,X'80'          DON'T CHECK IT AT CLIENT LEVEL               
         TM    SVMEDSTA,MEDBACCQ   IF BUY AGY CAN BE AT PRODUCT LEVEL           
         BO    *+8                                                              
         OI    BYTE,X'40'          DON'T CHECK IT AT CLIENT LEVEL               
         GOTO1 ALIMACC,DMCB,(C'T',AIOAREA),(BYTE,WORK)                          
*                                                                               
         MVI   5(R3),C'Y'          ASSUME ACCESS ALLOWED                        
         BE    SSCALL20            LIMACC RETURNS CC EQ IF OK                   
*                                                                               
SSCALLNO MVI   5(R3),C'N'                                                       
*                                                                               
SSCALL20 MVC   KEY,KEYSAVE         RESTORE PREVIOUS KEY IN CASE NF              
         AHI   R3,6                NEXT CLIENT CODE                             
         AHI   R2,-6               ADJUST STRING LENGTH                         
         LTR   R2,R2                                                            
         BP    SSCALL10                                                         
         DROP  R4                                                               
*                                                                               
SSCALLX  SR    RC,RC                                                            
         LTR   RC,RC                                                            
         XIT1  ,                                                                
         LTORG                                                                  
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
* SET UP USER CONTROL DATA                                            *         
*                                                                     *         
* R8=A(PARAMETER LIST)   - ACCPARMD                                   *         
* R7=A(ACCESS DATA AREA) - ACCDATAD                                   *         
*                                                                     *         
* ENTRY:                                                              *         
*                                                                     *         
* EXIT:                                                               *         
*                                                                     *         
***********************************************************************         
SETUC    NTR1  BASE=*                                                           
         LA    R2,ADUC                                                          
         LA    R4,UCVER                                                         
         LA    R5,3                                                             
         LA    R3,3                                                             
         GOTOR GETFLD                                                           
         LA    R2,1(R2)                                                         
         LA    R4,ADPAPID                                                       
         LA    R5,4                                                             
         LA    R3,4                                                             
         GOTOR GETFLD                                                           
         LA    R2,1(R2)                                                         
         LA    R4,ADUAUAID                                                      
         LA    R5,2                                                             
         LA    R3,2                                                             
         GOTOR GETFLD                                                           
         LA    R2,1(R2)                                                         
         CLC   UCVER,=CL3'000'                                                  
         BNE   SETU010                                                          
         MVC   ADUASAID,ADUAUAID                                                
         MVC   ADUAPAID,ADUAUAID                                                
         B     SETU020                                                          
SETU010  LA    R4,ADUASAID                                                      
         LA    R5,2                                                             
         LA    R3,2                                                             
         GOTOR GETFLD                                                           
         LA    R2,1(R2)                                                         
SETU020  LA    R4,WORK                                                          
         XC    WORK,WORK                                                        
         LA    R5,5                                                             
         LA    R3,5                                                             
         GOTOR GETFLD                                                           
         GOTOR CONVNUM                                                          
         MVC   UIDNUM,HALF                                                      
         LA    R2,1(R2)                                                         
         XC    WORK,WORK                                                        
         LA    R4,WORK                                                          
         LA    R5,5                                                             
         LA    R3,5                                                             
         GOTOR GETFLD                                                           
         GOTOR CONVNUM                                                          
         MVC   PIDNUM,HALF                                                      
         LA    R2,1(R2)                                                         
         XC    WORK,WORK                                                        
         LA    R4,WORK                                                          
         LA    R5,6                                                             
         LA    R3,6                                                             
         GOTOR GETFLD                                                           
         GOTOR CONVNUM                                                          
         MVC   AGRNUM,HALF                                                      
         LA    R2,1(R2)                                                         
         LA    R4,ADPASEN                                                       
         LA    R5,2                                                             
         LA    R3,2                                                             
         GOTOR GETFLD                                                           
         GOTO1 AHEXIN,PARM,ADPASEN,SESYSN,2                                     
         LA    R2,1(R2)                                                         
         LA    R4,WORK                                                          
         LA    R5,7                                                             
         LA    R3,7                                                             
         GOTOR GETFLD                                                           
         MVC   ADVID,WORK                                                       
         LA    R2,1(R2)                                                         
         LA    R4,ADPAAUTH                                                      
         LA    R5,4                                                             
         LA    R3,4                                                             
         GOTOR GETFLD                                                           
         LA    R2,1(R2)                                                         
         LA    R4,ADPALACC                                                      
         LA    R5,4                                                             
         LA    R3,4                                                             
         GOTOR GETFLD                                                           
         LA    R2,1(R2)                                                         
*                                                                               
         CLC   PIDNUM,=H'4096'     DDS PERSON NUMBERS ARE LOW VALUES            
         JNL   EXIT                 MUST OVERRIDE IF NECESSARY                  
*&&UK*&& MVC   ADUAPAID,=C'#E'                                                  
*&&US*&& MVC   ADUAPAID,=C'#N'                                                  
         J     EXIT                                                             
*                                                                               
*----------------------------------------------------------------------         
* GET FIELD                                                                     
*----------------------------------------------------------------------         
GETFLD   EQU   *                                                                
         LTR   R5,R5                                                            
         BZR   RE                                                               
         LTR   R3,R3                                                            
         BZR   RE                                                               
GFLD010  EQU   *                                                                
         CLI   0(R2),C','                                                       
         BE    GFLD030                                                          
         MVC   0(1,R4),0(R2)                                                    
         LA    R4,1(R4)                                                         
         LA    R2,1(R2)                                                         
         BCT   R5,GFLD020                                                       
         BR    RE                                                               
GFLD020  EQU   *                                                                
         BCT   R3,GFLD010                                                       
         BR    RE                                                               
GFLD030  EQU   *                                                                
         BR    RE                                                               
*                                                                               
*----------------------------------------------------------------------         
* CONVERT NUMBER TO BINARY                                                      
*----------------------------------------------------------------------         
CONVNUM  EQU   *                                                                
         XC    HALF,HALF                                                        
         LA    R0,5                                                             
         XR    R1,R1                                                            
         LA    RF,WORK                                                          
         CLI   0(RF),0                                                          
         BE    CNEXIT                                                           
CNLOOP   CLI   0(RF),0                                                          
         BE    CNPACK                                                           
         LA    R1,1(R1)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,CNLOOP                                                        
CNPACK   SR    RF,RF                                                            
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         PACK  DUB,WORK(0)                                                      
         CVB   RF,DUB                                                           
         STH   RF,HALF                                                          
CNEXIT   BR    RE                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
***********************************************************************         
* PARSE WEB USERNAME (PERSON@USER)                                              
***********************************************************************         
PARSUSR  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         ICM   RF,15,ADADATA                                                    
         ICM   R2,15,0(RF)         GET INPUT DATA LENGTH                        
         ICM   R3,15,4(RF)         GET INPUT DATA ADDRESS                       
*                                                                               
         MVC   ADUAPID,SPACES                                                   
         MVC   ADUAUID,SPACES                                                   
*                                                                               
         XR    R1,R1                                                            
         LA    RE,ADUC                                                          
PU010    CLI   0(RE),C'@'          LOOK FOR PID/USERID SEPARATOR                
         BE    PU020                                                            
         LA    RE,1(,RE)                                                        
         AHI   R1,1                                                             
         CHI   R1,L'ADUAPID                                                     
         BNH   PU010                                                            
         B     PUNOX               MISSING @, NOT VALID PID/USERID              
*                                                                               
PU020    AHI   R1,-1                                                            
         BM    PUNOX                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ADUAPID(0),ADUC     SAVE PID                                     
*                                                                               
         XR    R1,R1                                                            
         LA    RE,1(,RE)                                                        
         ST    RE,FULL                                                          
PU030    CLI   0(RE),C' '          LOOK FOR PID/USERID SEPARATOR                
         BNH   PU040                                                            
         LA    RE,1(,RE)                                                        
         AHI   R1,1                                                             
         CHI   R1,L'ADUAUID                                                     
         BNH   PU030                                                            
         B     PUNOX               NOT VALID PID/USERID                         
*                                                                               
PU040    L     RE,FULL                                                          
         AHI   R1,-1                                                            
         BM    PUNOX                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ADUAUID(0),0(RE)    SAVE USER ID                                 
*                                                                               
PUOKX    CR    RB,RB               EXIT EQUAL                                   
         J     EXIT                                                             
PUNOX    LTR   RB,RB               EXIT NOT EQUAL (NOT ZERO)                    
         J     EXIT                                                             
                                                                                
                                                                                
***********************************************************************         
* SET ACCESS VALUES FROM INPUT FIELDS                                           
***********************************************************************         
SETVALS  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTO1 AHEXIN,PARM,ADPASEN,SESYSN,2  FACPAK SYSTEM SE #                 
*                                                                               
         LA    R4,ADUAUIN          USER ID NUMBER                               
         BAS   RE,SETCNVH                                                       
         MVC   UIDNUM,HALF                                                      
*                                                                               
         LA    R4,ADUAPIN          PERSON ID # (PIN) PASSWORD NUMBER            
         BAS   RE,SETCNVH                                                       
         MVC   PIDNUM,HALF                                                      
*                                                                               
         LA    R4,ADUAAGNU         ACCESS GROUP NUMBER                          
         BAS   RE,SETCNVH                                                       
         MVC   AGRNUM,HALF                                                      
*                                                                               
         CLC   PIDNUM,=H'4096'     DDS PERSON NUMBERS ARE LOW VALUES            
         BNL   SV010                MUST OVERRIDE IF NECESSARY                  
*&&UK*&& MVC   ADUAPAID,=C'#E'                                                  
*&&US*&& MVC   ADUAPAID,=C'#N'                                                  
*                                                                               
SV010    BRAS  RE,GETLACC          LIMIT ACCESS VALUE                           
         BNE   SVALNOX                                                          
*                                                                               
SVALOKX  CR    RB,RB               EXIT EQUAL                                   
         J     EXIT                                                             
SVALNOX  LTR   RB,RB               EXIT NOT EQUAL (NOT ZERO)                    
         J     EXIT                                                             
                                                                                
*----------------------------------------------------------------------         
* SET HEX NUMBER FROM CHARACTER                                                 
*   ON ENTRY R4=A(CHARACTER VALUE)                                              
*----------------------------------------------------------------------         
SETCNVH  LA    R0,5                MAX 5 DIGITS FIT IN A HALFWORD               
         XC    HALF,HALF                                                        
*                                                                               
         LA    RF,WORK             MAKE SURE SOMETHING EXITS                    
         CLI   0(R4),C' '                                                       
         BNH   SETCNEX                                                          
*                                                                               
         XR    R1,R1                                                            
SETCN10  CLI   0(R4),0             FIND END OF DATA                             
         BE    SETCN20                                                          
         LA    R1,1(R1)            CALCULATE LENGTH                             
         LA    RF,1(R4)                                                         
         BCT   R0,SETCN10                                                       
*                                                                               
SETCN20  SR    RF,RF               CONVERT VALUE TO HALFWORD HEX                
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         PACK  DUB,0(0,R4)                                                      
         CVB   RF,DUB                                                           
         STH   RF,HALF                                                          
*                                                                               
SETCNEX  BR    RE                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
***********************************************************************         
* GET AND SET PROGRAM LIMIT ACCESS FROM SYSTEM ELEMENTS                         
***********************************************************************         
GETLACC  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BRAS  RE,SETSYSEL               GET SYS ELS AND LACC VALUES            
         BNE   GLACNOX                                                          
*                                                                               
         XC    PGMLACC,PGMLACC                                                  
         XC    UIDLACC,UIDLACC                                                  
         XC    PIDLACC,PIDLACC                                                  
         XC    PIDLIDC,PIDLIDC                                                  
         XC    WORK,WORK                                                        
*                                                                               
         USING CTSYSD,R3                                                        
         OC    AUIDSYS,AUIDSYS           USER ID SYSTEM ELEMENT                 
         BZ    GLA010                                                           
         L     R3,AUIDSYS                                                       
         MVC   UIDLACC,CTSYSLMT                                                 
*                                                                               
GLA010   OC    APIDSYS,APIDSYS           PID SYSTEM ELEMENT                     
         BZ    GLA020                                                           
         L     R3,APIDSYS                                                       
         MVC   PIDLACC,CTSYSLMT                                                 
*                                                                               
GLA020   OC    DACNUM,DACNUM             DATA ACCESS?                           
         BZ    GLA030                                                           
         BRAS  RE,GETLAS                 SET DATA ACCESS IN PIDLACC             
*                                                                               
GLA030   MVC   PGMLACC(4),UIDLACC        USE USER ID LIMIT ACCESS               
         OC    PIDLACC(4),PIDLACC        UNLESS THERE IS PID LIMIT ACC          
         BZ    GLACOKX                                                          
         MVC   PGMLACC(4),PIDLACC        THEN USE THE PID LIMIT ACCESS          
*                                                                               
GLACOKX  CR    RB,RB               EXIT EQUAL                                   
         J     EXIT                                                             
GLACNOX  LTR   RB,RB               EXIT NOT EQUAL (NOT ZERO)                    
         J     EXIT                                                             
         DROP  R3                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
***********************************************************************         
* SET SYSTEM ELEMENTS                                                           
***********************************************************************         
SETSYSEL NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    DACNUM,DACNUM       INIT DATA ACCESS GROUP NUMBER                
*                                                                               
         LA    R2,IOKEY            SET ID RECORD LIMIT ACCESS                   
         USING CTIREC,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ    RECORD TYPE C'I'                             
         MVC   CTIKNUM,UIDNUM                                                   
         GOTO1 ADATAMGR,PARM,=C'DMREAD ',=C'CTFILE ',IOKEY,IOAREA               
         BNE   SSYSER1                                                          
         L     R2,AIOAREA                                                       
         LA    R1,AUIDSYS          AND SAVE SYSTEM ELEMENT                      
         BRAS  RE,GETSYSEL                                                      
         BNE   SSYSER2                                                          
         XC    UIDSYSEL,UIDSYSEL                                                
         ICM   R1,15,AUIDSYS                                                    
         SR    RF,RF                                                            
         IC    RF,1(R1)                                                         
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   UIDSYSEL(0),0(R1)   COPY IN USERID SYSTEM ELEMENT                
         LA    RF,UIDSYSEL                                                      
         STCM  RF,15,AUIDSYS                                                    
*                                  SET PERSON ID RECORD LIMIT ACCESS            
         LA    R2,IOKEY                                                         
         USING SA0REC,R2                                                        
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ                                                 
         CLC   ADUAPAID(2),=C'  '                                               
         BNH   *+14                                                             
         MVC   SA0KAGY,ADUAPAID    SEC AGENCY FOR PERSON IF AVAILABLE           
         B     *+10                                                             
         MVC   SA0KAGY,ADUASAID    SEC AGENCY                                   
         MVC   SAGY,SA0KAGY                                                     
         MVC   SA0KNUM,PIDNUM                                                   
         GOTO1 ADATAMGR,PARM,=C'DMREAD ',=C'CTFILE ',IOKEY,AIOAREA              
         BNE   SSYSER3                                                          
         L     R2,AIOAREA                                                       
         LA    R1,APIDSYS          AND SAVE SYSTEM ELEMENT                      
         BRAS  RE,GETSYSEL                                                      
         BNE   SSYS020                                                          
         XC    PIDSYSEL,PIDSYSEL                                                
         ICM   R1,15,APIDSYS                                                    
         SR    RF,RF                                                            
         IC    RF,1(R1)                                                         
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PIDSYSEL(0),0(R1)   COPY IN PERSON SYSTEM ELEMENT                
         LA    RF,PIDSYSEL                                                      
         STCM  RF,15,APIDSYS                                                    
*                                                                               
SSYS020  LA    R3,IOAREA+(SA0DATA-SA0REC)                                       
SSYS040  CLI   0(R3),0                                                          
         BE    SSYSER1                                                          
         CLI   0(R3),SAPALELQ                                                   
         BE    SSYS050                                                          
         XR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     SSYS040                                                          
*                                                                               
         USING SAPALD,R3           EXTRACT PERSONAL ID                          
SSYS050  MVC   ADUAPID,SAPALPID                                                 
         DROP  R3                                                               
*                                                                               
         USING SAPEREC,R2          READ PERSON RECORD                           
         LA    R2,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY                                                  
         MVI   SAPETYP,SAPETYPQ                                                 
         MVI   SAPESUB,SAPESUBQ                                                 
         MVC   SAPEAGY,SAGY                                                     
         MVC   SAPEPID,ADUAPID                                                  
*                                                                               
         GOTO1 ADATCON,PARM,(5,(0)),(2,SAPEDEF)                                 
         XC    SAPEDEF,EFFS        COMPLEMENT DATE                              
         GOTO1 ADATAMGR,PARM,=C'DMRDHI ',=C'CTFILE ',IOKEY,AIOAREA              
         BNE   SSYSER1                                                          
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),IOAREA                                  
         BNE   SSYSER1                                                          
*                                                                               
         LA    R3,IOAREA+(SAPEDATA-SAPEREC)                                     
SSYS060  CLI   0(R3),0                                                          
         BE    SSYSOKX                                                          
         CLI   0(R3),SALACELQ                                                   
         BE    SSYS070                                                          
         XR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     SSYS060                                                          
*                                                                               
         USING SALACD,R3           EXTRACT DATA ACCESS GROUP NUMBER             
SSYS070  MVC   DACNUM,SALACNUM                                                  
         DROP  R3                                                               
*                                                                               
SSYSOKX  CR    RB,RB               EXIT EQUAL                                   
         J     EXIT                                                             
*                                                                               
SSYSER1  LHI   RE,51                                                            
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         J     SSYSNOX                                                          
*                                                                               
SSYSER2  LHI   RE,52                                                            
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         J     SSYSNOX                                                          
*                                                                               
SSYSER3  LHI   RE,53                                                            
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         J     SSYSNOX                                                          
*                                                                               
SSYSNOX  LTR   RB,RB               EXIT NOT EQUAL (NOT ZERO)                    
         J     EXIT                                                             
         DROP  R2                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
***********************************************************************         
* GET LIMIT ACCESS VALUE FROM DATA ACCESS SYSTEM ELEMENTS                       
* RETURN IN PIDLACC, ELSE CC .NE. IF ELEMENT NOT FOUND                          
***********************************************************************         
GETLAS   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,IOKEY            GET DATA ACCESS GROUP RECORD DATA            
         USING SALAREC,R2                                                       
         XC    SALAKEY,SALAKEY     BUILD DATA ACCESS GROUP KEY                  
         MVI   SALATYP,SALATYPQ                                                 
         MVI   SALASUB,SALASUBQ                                                 
         MVC   SALAAGY,SAGY        SEC AGENCY                                   
         MVC   SALAAGN,DACNUM                                                   
         GOTO1 ADATAMGR,PARM,=C'DMREAD ',=C'CTFILE ',IOKEY,AIOAREA              
         BNE   GETLASNO                                                         
         L     R2,AIOAREA                                                       
*                                                                               
         LA    R1,FULL                                                          
         BRAS  RE,GDASYSEL         GET DATA ACCESS SYSTEM RECORD                
         BNE   GETLASNO                                                         
         ICM   R3,15,FULL                                                       
         BZ    GETLASNO                                                         
*                                                                               
         USING SALASD,R3                                                        
         OC    SALASALL,SALASALL                                                
         BZ    GETLASNO                                                         
         MVC   PIDLACC,SALASALL    SET DEFAULT ALL PROGRAM VALUE                
*                                                                               
*        *** PROGRAM LEVEL DATA ACCESS NOT SUPPORTED ***                        
*                                                                               
GETLASOK SR    RC,RC               EXIT CC .EQ.                                 
GETLASNO LTR   RC,RC               EXIT CC .NE.                                 
         J     EXIT                                                             
         LTORG                                                                  
         DROP  R2,R3                                                            
         EJECT                                                                  
                                                                                
***********************************************************************         
* GET A(SYSTEM ELEMENT) FOR AN ID/AUTHORIZATION RECORD                          
* ON ENTRY R2=A(RECORD),0(R1)=A(ELEMENT ADDRESS),SYSCODE=SYSTEM NUMBER          
***********************************************************************         
GETSYSEL MVI   BYTE,CTSYSELQ       X'21' SYSTEM ELEMENT                         
         J     *+8                                                              
GDASYSEL MVI   BYTE,SALASELQ       X'CC' DATA ACCESS SYSTEM ELEMENT             
         SR    R0,R0                                                            
         LA    RF,CTIDATA-CTIREC(R2)                                            
GSYS010  CLI   0(RF),0             TEST E-O-R                                   
         JE    GSYSNOX                                                          
         CLC   0(1,RF),BYTE                                                     
         JNE   *+14                                                             
         CLC   SYSCODE,CTSYSNUM-CTSYSD(RF)                                      
         JE    GSYSOKX                                                          
         IC    R0,1(RF)                                                         
         AR    RF,R0                                                            
         J     GSYS010                                                          
*                                                                               
GSYSOKX  ST    RF,0(R1)            RETURN FOUND ELEMENT ADDRESS                 
         CR    RB,RB               EXIT EQUAL (ZERO)                            
         BR    RE                                                               
GSYSNOX  XC    0(4,R1),0(R1)       RETURN ZERO IF NOT FOUND                     
         LTR   RB,RB               EXIT NOT EQUAL (NOT ZERO)                    
         BR    RE                                                               
                                                                                
***********************************************************************         
* FORGOT PASSWORD ACTION                                                        
***********************************************************************         
FORGOTPW NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    WORK,WORK                                                        
         GOTO1 ADATCON,PARM,(5,0),(20,WORK)                                     
*                                                                               
         TM    PACSFLG,CTAADPRQ    PPS?                                         
         BNO   FPWERR3             NO: CAN'T USE THIS OPTION                    
         CLC   ADUAADL3,SPACES     EMAIL ADDRESS DEFINED                        
         BNH   FPWERR1             NO EMAIL ADDRESS DEFINED                     
         CLC   ADUADTE,SPACES      PERSON TERMINATED                            
         BNH   FPW005              NO: CONTINUE                                 
         CLC   ADUADTE,WORK        PERSON TERMINATED YET?                       
         BNH   FPWERR4             YES: PERSON HAS BEEN TERMINATED              
*                                                                               
FPW005   ICM   RF,15,=X'0AFFFFFF'                                               
         GOTO1 ASWITCH,PARM,(RF),0                                              
         CLI   4(R1),0             SWITCH TO CONTROL SYSTEM                     
         BNE   FPWERR2                                                          
*                                                                               
         XC    IOKEY,IOKEY                                                      
         LA    R2,IOKEY                                                         
         USING SA0REC,R2           GET PASSWORD/SYSTEM/ZERO RECORD              
         MVI   SA0KTYP,SA0KTYPQ                                                 
         MVC   SA0KAGY,ADUAPAID    PERSON SECURITY AGENCY                       
         MVC   SA0KNUM,PIDNUM      PERSON NUMBER                                
         GOTO1 ADATAMGR,PARM,=C'DMREAD ',=C'CTFILE ',IOKEY,IOAREA               
         BNE   FPWERR3             RECORD NOT FOUND                             
*                                                                               
         LA    R2,IOAREA                                                        
         LA    R3,SA0DATA                                                       
FPW010   CLI   0(R3),0                                                          
         BE    FPW040                                                           
         CLI   0(R3),SAPWHELQ      X'E4' PASSWORD HISTORY                       
         BE    FPW030                                                           
FPW020   LLC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     FPW010                                                           
*                                                                               
         USING SAPWHD,R3                                                        
FPW030   TM    SAPWHFLG,SAPWHFOR   ALREADY HAVE A FORGOT PASSWORD?              
         BZ    FPW020              NO: KEEP LOOKING                             
         MVI   0(R3),X'FF'         YES: MARK IT FOR DELETION                    
         B     FPW020                                                           
*                                                                               
FPW040   GOTO1 AHELLO,PARM,(C'D',=C'CTFILE '),(X'FF',SA0REC),0,0                
*                                                                               
         XC    WORK,WORK                                                        
         LA    R3,WORK                         BUILD NEW ELEMENT                
         MVI   SAPWHEL,SAPWHELQ                X'E4'                            
         MVI   SAPWHLN,SAPWHLNQ+L'SAPWHPWD     MAXIMUM ELEM LENGTH              
         GOTO1 ADATCON,PARM,(5,0),(2,SAPWHDTE) DATE                             
         TIME  BIN                             AND                              
         STCM  R0,7,SAPWHTME                   TIME                             
         OI    SAPWHFLG,SAPWHEXP+SAPWHFOR      FORGOTTEN PASSWORD               
*                                                                               
         ICM   RF,15,=V(PWDGEN)                                                 
         JZ    *+2                                                              
         A     RF,RELO                                                          
         GOTO1 (RF),PARM,SAPWHPWD  RANDOM 10 CHARACTER PASSWORD                 
         MVC   ADNPWD(10),SAPWHPWD                                              
*                                                                               
         GOTO1 AHELLO,PARM,(C'P',=C'CTFILE '),SA0REC,WORK,0                     
         CLI   12(R1),0                                                         
         BNE   FPWERR3                                                          
*                                                                               
         GOTO1 ADATAMGR,PARM,=C'DMWRT  ',=C'CTFILE ',IOKEY,IOAREA               
         BNE   FPWERR3                                                          
*                                                                               
         XC    IOKEY,IOKEY         READ IN PERSON RECORD                        
         LA    R2,IOKEY                                                         
         USING SAPEREC,R2                                                       
         MVI   SAPETYP,SAPETYPQ    C'F'                                         
         MVI   SAPESUB,SAPESUBQ    X'04'                                        
         MVC   SAPEAGY,ADUAPAID    SECURITY AGENCY                              
         MVC   SAPEPID,ADUAPID                                                  
         GOTO1 ADATCON,PARM,(5,(0)),(2,SAPEDEF)                                 
         XC    SAPEDEF,EFFS        COMPLEMENT DATE                              
         GOTO1 ADATAMGR,PARM,=C'DMRDHI ',=C'CTFILE ',IOKEY,IOAREA               
         BNE   FPWERR3             NO RECORD FOUND FOR THIS PERSON              
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),IOAREA                                  
         BNE   FPWERR3             NO RECORD FOUND FOR THIS PERSON              
*                                                                               
         LA    R2,IOAREA                                                        
         LA    R3,SAPEDATA                                                      
FPW050   CLI   0(R3),0                                                          
         BE    FPW100                                                           
         CLI   0(R3),SALLOELQ      X'04' LAST LOG ON                            
         BE    FPW070                                                           
         CLI   0(R3),SANAMELQ      X'  ' NAME                                   
         BE    FPW080                                                           
FPW060   LLC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     FPW050                                                           
*                                                                               
         USING SALLOD,R3                                                        
FPW070   NI    SALLOFLG,X'FF'-SALLOMLC UNLOCK PID                               
         TM    SALLOFLG,SALLOFPW       FIRST TIME FORGOT PASSWORD?              
         BZ    *+8                     YES: LEAVE PID UNLOCKED                  
         OI    SALLOFLG,SALLOMLC       NO:  LOCK THE PID                        
         OI    SALLOFLG,SALLOFPW       FORGOT PASSWORD                          
         XC    SALLOCNT,SALLOCNT       RESET VIOLATION ATTEMPTS                 
         B     FPW060                                                           
*                                                                               
         USING SANAMD,R3           R3=A(NAME ELEMENT)                           
FPW080   XR    RE,RE                                                            
         LA    RF,SANAMES                                                       
         USING SANAMES,RF          RF=A(NAME SUB ELEMENT)                       
*                                                                               
         IC    RE,SANAMELN         COPY FIRST NAME                              
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   ADUAFNA(0),SANAME                                                
         LA    RF,L'SANAMELN+1(RE,RF)  BUMP RF TO NEXT SUB-ELEMENT              
*                                                                               
         TM    SANAMIND,SANAMIMN   TEST MIDDLE NAME PRESENT                     
         BZ    FPW085                                                           
         IC    RE,SANAMELN         COPY MIDDLE NAME                             
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   ADUAMNA(0),SANAME                                                
         LA    RF,L'SANAMELN+1(RE,RF)  BUMP RF TO NEXT SUB-ELEMENT              
*                                                                               
FPW085   IC    RE,SANAMELN         COPY LAST NAME                               
         LA    R1,L'ADUALNA        LIMITED TO OUTPUT LENGTH                     
         CR    R1,RE                                                            
         BH    *+6                                                              
         LR    RE,R1                                                            
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   ADUALNA(0),SANAME                                                
         B     FPW060                                                           
         DROP  RF                                                               
*                                                                               
FPW100   GOTO1 ADATAMGR,PARM,=C'DMWRT  ',=C'CTFILE ',IOKEY,IOAREA               
         BNE   FPWERR3                                                          
*                                                                               
         BRAS  RE,SNDEMAIL          EMAIL TEMP PASSWORD                         
*                                                                               
         ICM   RF,15,=X'01FFFFFF'                                               
         GOTO1 ASWITCH,PARM,(RF),0  SWITCH BACK TO SERVICE SYS                  
         CLI   4(R1),0                                                          
         BNE   FPWERR2                                                          
         B     FPWOK                                                            
*                                                                               
FPWERR1  LHI   RE,ACRSFPW1          NO EMAIL ADDRESS                            
         B     FPWERR                                                           
FPWERR2  LHI   RE,ACRSFPW2          SYSTEM SWITCH ERROR                         
         B     FPWERR                                                           
FPWERR3  ICM   RF,15,=X'01FFFFFF'                                               
         GOTO1 ASWITCH,PARM,(RF),0                                              
         LHI   RE,ACRSFPW3          RECORD PROCESSING ERROR                     
         B     FPWERR                                                           
FPWERR4  LHI   RE,ACRSFPW4          PID HAS BEEN TERMINATED                     
*                                                                               
FPWERR   ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     FPWNO                                                            
*                                                                               
FPWOK    SR    RC,RC                                                            
FPWNO    LTR   RC,RC                                                            
         J     EXIT                                                             
         DROP  R2,R3                                                            
         LTORG                                                                  
                                                                                
***********************************************************************         
* SEND EMAIL                                                                    
***********************************************************************         
SNDEMAIL NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVI   PARM+0,C'L'         LIST                                         
         MVI   PARM+1,C'L'         LOWERCASE                                    
         MVI   PARM+2,X'1'         SERVICE                                      
         MVC   PARM+3(1),CULANG                                                 
         GOTO1 ADICTATE,PARM,,DATI,DATO                                         
*                                                                               
         GOTO1 ADATCON,PARM,(5,0),(20,TODAY20)                                  
*                                                                               
         XC    WORK,WORK                                                        
         LA    R4,WORK                                                          
         USING SMTPD,R4                                                         
*                                                                               
         LAY   R1,TOFLD                                                         
         ST    R1,SMTPTO           TO:                                          
         LAY   R1,FROMFLD                                                       
         ST    R1,SMTPFROM         FROM:                                        
         LAY   R1,SUBFLD                                                        
         ST    R1,SMTPSUB          SUBJECT:                                     
         LA    R1,EMLSUM                                                        
         ST    R1,SMTPDATA         BODY                                         
         LA    R1,=C'*SMTPMAIL*'                                                
         ST    R1,SMTPVRLN         VARIABLE LENGTH                              
         LA    R1,SMTPOPT                                                       
         ST    R1,SMTPOPTS         HTML                                         
*                                                                               
         L     R1,SMTPTO           TO: EMAIL ADDRESS                            
         MVC   0(L'TOFLD,R1),TEXTSPCS                                           
         MVC   0(L'ADUAADL3,R1),ADUAADL3                                        
         MVI   L'TOFLD(R1),X'FF'                                                
*                                                                               
         L     R1,SMTPFROM         FROM:                                        
         MVC   0(L'FROMFLD,R1),FROMFLDC                                         
         MVI   L'FROMFLD(R1),X'FF'                                              
*                                                                               
         L     R1,SMTPSUB          SUBJECT:                                     
         MVC   0(L'SUBFLD,R1),TEXTSPCS                                          
         MVC   0(L'SR@PASSR,R1),SR@PASSR                                        
         MVI   L'SUBFLD(R1),X'FF'                                               
*                                                                               
         LAY   R1,EMAILS1                                                       
         MVC   0(L'SR@EMNL1,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL1,R1),SR@EMNL1                                        
*                                                                               
         LAY   R1,EMAILS2                                                       
         MVC   0(L'SR@EMNL2,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL2,R1),SR@EMNL2                                        
*                                                                               
         LAY   R1,EMAILS3                                                       
         MVC   0(L'SR@EMNL3,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL3,R1),SR@EMNL3                                        
*                                                                               
         LAY   R1,EMAILS4                                                       
         MVC   0(L'SR@EMNL4,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL4,R1),SR@EMNL4                                        
*                                                                               
         LAY   R1,EMAILS5                                                       
         MVC   0(L'SR@EMNL5,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL5,R1),SR@EMNL5                                        
*                                                                               
         LAY   R1,EMAILS6                                                       
         MVC   0(L'SR@EMNL6,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL6,R1),SR@EMNL6                                        
*                                                                               
         LAY   R1,EMAILS7                                                       
         MVC   0(L'SR@EMNL7,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL7,R1),SR@EMNL7                                        
*                                                                               
         LAY   R1,EMAILS8                                                       
         MVC   0(L'SR@EMNL8,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL8,R1),SR@EMNL8                                        
*                                                                               
         LAY   R1,EMAILS9                                                       
         MVC   0(L'SR@EMNL9,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNL9,R1),SR@EMNL9                                        
*                                                                               
         LAY   R1,EMAILSA                                                       
         MVC   0(L'SR@EMNLA,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMNLA,R1),SR@EMNLA                                        
*                                                                               
         LAY   R1,EMLS610E                                                      
*&&UK                                                                           
         MVC   0(L'EMLS610E,R1),TEXTSPCS                                        
         MVC   0(L'SR@MOLUK,R1),SR@MOLUK                                        
         CLI   CUCTRY,CTRYGBRQ       UK address                                 
         JE    SNDMFP17                                                         
         MVC   0(L'EMLS610E,R1),TEXTSPCS                                        
         MVC   0(L'SR@MOLDE,R1),SR@MOLDE                                        
         CLI   CUCTRY,CTRYGERQ       German address                             
         JE    SNDMFP17                                                         
*&&                                                                             
*&&US                                                                           
         MVC   0(L'EMLS610E,R1),TEXTSPCS                                        
         MVC   0(L'SR@MOLCA,R1),SR@MOLCA                                        
         CLI   CUCTRY,CTRYCANQ       Canadian address                           
         JE    SNDMFP17                                                         
*&&                                                                             
         MVC   0(L'EMLS610E,R1),TEXTSPCS                                        
         MVC   0(L'AUADDR,R1),AUADDR Default is US address                      
*                                                                               
SNDMFP17 LAY   R1,EMLS625E           Find us here...                            
         MVC   0(L'EMLS625E,R1),TEXTSPCS                                        
         MVC   0(L'SR@FUSAT,R1),SR@FUSAT                                        
*                                                                               
         LAY   R1,EMLS620E           Put year in copyright                      
         MVC   0(L'EMLS620E,R1),TODAY20                                         
*                                                                               
         LAY   R1,EMAIL285           Move in pwd reset user req line            
         MVC   0(L'EMAIL285,R1),TEXTSPCS                                        
         MVC   EMAILFNA,TEXTSPCS                                                
         MVC   EMAILLNA,TEXTSPCS                                                
         MVC   0(L'SR@EMPR1,R1),SR@EMPR1                                        
         MVC   EMAILFNA,ADUAFNA                                                 
         MVC   EMAILLNA,ADUALNA                                                 
*                                                                               
         LAY   R1,EMAIL286           Move in pwd reset temp pwd line            
         MVC   0(L'EMAIL286,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMPR2,R1),SR@EMPR2                                        
         MVI   L'SR@EMPR2(R1),C':'                                              
         MVC   L'SR@EMPR2+3(10,R1),ADNPWD                                       
*                                                                               
         LAY   R1,EMAIL287           Move in message text                       
         MVC   0(L'EMAIL287,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMPR3,R1),SR@EMPR3                                        
*                                                                               
         LAY   R1,EMAIL288           Move in message text                       
         MVC   0(L'EMAIL288,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMPR4,R1),SR@EMPR4                                        
*                                                                               
         LAY   R1,EMAIL289           Move in message text                       
         MVC   0(L'EMAIL289,R1),TEXTSPCS                                        
         MVC   0(L'SR@EMPR5,R1),SR@EMPR5                                        
*                                                                               
         GOTO1 AJESMAIL,(R4)                                                    
*                                                                               
SEEMX    J     EXIT                                                             
         DROP  R4                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
FROMFLDC DC    CL60'DoNotReply@mediaocean.com',X'FF'                            
*                                                                               
SMTPOPT  DC    CL10'*HTML*****'                                                 
         DC    X'FF'                                                            
*                                                                               
AUADDR   DC    C'MEDIAOCEAN |  120 BROADWAY  | NEW YORK, NY 10271'              
*                                                                               
TEXTSPCS DC    CL160' '                                                         
*                                                                               
DATI     DS    0X                                                               
         DCDDL SR#PASSR,30         Password Reset Requested                     
         DCDDL SR#EMPR1,80         PASSWORD RESET EMAIL LINE 1 NAME             
         DCDDL SR#EMPR2,30         PASSWORD RESET EMAIL LINE 2 PASSWORD         
         DCDDL SR#EMPR3,80         PASSWORD RESET EMAIL LINE 3                  
         DCDDL SR#EMPR4,80         PASSWORD RESET EMAIL LINE 4                  
         DCDDL SR#EMPR5,80         PASSWORD RESET EMAIL LINE 5                  
         DCDDL SR#EMNL1,80         STANDARD EMAIL LINE 1                        
         DCDDL SR#EMNL2,80         STANDARD EMAIL LINE 2                        
         DCDDL SR#EMNL3,80         STANDARD EMAIL LINE 3                        
         DCDDL SR#EMNL4,80         STANDARD EMAIL LINE 4                        
         DCDDL SR#EMNL5,80         STANDARD EMAIL LINE 5                        
         DCDDL SR#EMNL6,80         STANDARD EMAIL LINE 6                        
         DCDDL SR#EMNL7,80         STANDARD EMAIL LINE 7                        
         DCDDL SR#EMNL8,80         STANDARD EMAIL LINE 8                        
         DCDDL SR#EMNL9,80         STANDARD EMAIL LINE 9                        
         DCDDL SR#EMNLA,80         STANDARD EMAIL LINE 10                       
*&&UK*&& DCDDL SR#MOLDE,80         MEDIAOCEAN DE                                
*&&UK*&& DCDDL SR#MOLUK,80         MEDIAOCEAN UK                                
*&&US*&& DCDDL SR#MOLCA,80         MEDIAOCEAN CA                                
         DCDDL SR#FUSAT,18         FIND US AT                                   
DATIX    DC    X'00'                                                            
*                                                                               
EMLSUM   DS    0H                   SUMMARY EMAIL                               
*                                                                               
EMLS05   DC    AL2(EMLS05L-2)                                                   
         DC    C'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 '                 
         DC    C'Transitional//EN" '                                            
         DC    C'"http://www.w3.org/TR/xhtml11/DTD/xhtml1-transitional'         
         DC    C'.dtd">'                                                        
EMLS05L  EQU   *-EMLS05                                                         
*                                                                               
EMLS10   DC    AL2(EMLS10L-2)                                                   
         DC    C'<html xmlns="http://www.w3.org/1999/xhtml">'                   
EMLS10L  EQU   *-EMLS10                                                         
*                                                                               
EMLS15   DC    AL2(EMLS15L-2)                                                   
         DC    C'<head>'                                                        
EMLS15L  EQU   *-EMLS15                                                         
*                                                                               
EMLS20   DC    AL2(EMLS20L-2)                                                   
         DC    C'<title>'                                                       
         DC    C'This is the title'                                             
EMLS20L  EQU   *-EMLS20                                                         
*                                                                               
EMLS25   DC    AL2(EMLS25L-2)                                                   
         DC    C'</title>'                                                      
EMLS25L  EQU   *-EMLS25                                                         
*                                                                               
EMLS30   DC    AL2(EMLS30L-2)                                                   
         DC    C'<meta http-equiv="Content-Type" content="text/html;'           
         DC    C' charset=UTF-8" />'                                            
EMLS30L  EQU   *-EMLS30                                                         
*                                                                               
EMLS35   DC    AL2(EMLS35L-2)                                                   
         DC    C'<meta name="viewport" content="width=device-width; '           
         DC    C'initial-scale=1; maximum-scale=1.0"/>'                         
EMLS35L  EQU   *-EMLS35                                                         
*                                                                               
EMLS40   DC    AL2(EMLS40L-2)                                                   
         DC    C'</head>'                                                       
EMLS40L  EQU   *-EMLS40                                                         
*                                                                               
EMLS45   DC    AL2(EMLS45L-2)                                                   
         DC    C'<body bgcolor="#ffffff">'                                      
EMLS45L  EQU   *-EMLS45                                                         
*                                                                               
EMLS50   DC    AL2(EMLS50L-2)                                                   
         DC    C'<!-- Outer Wrap -->'                                           
EMLS50L  EQU   *-EMLS50                                                         
*                                                                               
EMLS55   DC    AL2(EMLS55L-2)                                                   
         DC    C'<table width="100%" border="0" cellspacing="0" '               
         DC    C'cellpadding="0" bgcolor="#ffffff" '                            
         DC    C'style="table-layout:fixed;">'                                  
EMLS55L  EQU   *-EMLS55                                                         
*                                                                               
EMLS60   DC    AL2(EMLS60L-2)                                                   
         DC    C'<tr>'                                                          
EMLS60L  EQU   *-EMLS60                                                         
*                                                                               
EMLS65   DC    AL2(EMLS65L-2)                                                   
         DC    C'<td>'                                                          
EMLS65L  EQU   *-EMLS65                                                         
*                                                                               
EMLS70   DC    AL2(EMLS70L-2)                                                   
         DC    C'<!-- top shadow -->'                                           
EMLS70L  EQU   *-EMLS70                                                         
*                                                                               
EMLS75   DC    AL2(EMLS75L-2)                                                   
         DC    C'<table width="100%" border="0" cellspacing="0" '               
         DC    C'cellpadding="0">'                                              
EMLS75L  EQU   *-EMLS75                                                         
*                                                                               
EMLS80   DC    AL2(EMLS80L-2)                                                   
         DC    C'<tr>'                                                          
EMLS80L  EQU   *-EMLS80                                                         
*                                                                               
EMLS85   DC    AL2(EMLS85L-2)                                                   
         DC    C'<td height="10">'                                              
EMLS85L  EQU   *-EMLS85                                                         
*                                                                               
EMLS90   DC    AL2(EMLS90L-2)                                                   
         DC    C'</tr>'                                                         
EMLS90L  EQU   *-EMLS90                                                         
*                                                                               
EMLS95   DC    AL2(EMLS95L-2)                                                   
         DC    C'</table>'                                                      
EMLS95L  EQU   *-EMLS95                                                         
*                                                                               
EMLS100  DC    AL2(EMLS100L-2)                                                  
         DC    C'<!-- header -->'                                               
EMLS100L EQU   *-EMLS100                                                        
*                                                                               
EMLS105  DC    AL2(EMLS105L-2)                                                  
         DC    C'<table width="100%" bgcolor="#ffffff" border="0" '             
         DC    C'cellspacing="0" cellpadding="0">'                              
EMLS105L EQU   *-EMLS105                                                        
*                                                                               
EMLS110  DC    AL2(EMLS110L-2)                                                  
         DC    C'<tr>'                                                          
EMLS110L EQU   *-EMLS110                                                        
*                                                                               
EMLS115  DC    AL2(EMLS115L-2)                                                  
         DC    C'<td>'                                                          
EMLS115L EQU   *-EMLS115                                                        
*                                                                               
EMLS120  DC    AL2(EMLS120L-2)                                                  
         DC    C'<a href="http://mediaocean.com">'                              
EMLS120L EQU   *-EMLS120                                                        
*                                                                               
EMLS125  DC    AL2(EMLS125L-2)                                                  
         DC    C'<img src="http://info.mediaocean.com/rs/331-XPM-231/'          
         DC    C'images/Mediaocean-header-email.gif" alt="Mediaocean"'          
         DC    C' style="-ms-interpolation-mode: bicubic; max-width: '          
         DC    C'100%; display: block;">'                                       
EMLS125L EQU   *-EMLS125                                                        
*                                                                               
EMLS130  DC    AL2(EMLS130L-2)                                                  
         DC    C'</a>'                                                          
EMLS130L EQU   *-EMLS130                                                        
*                                                                               
EMLS135  DC    AL2(EMLS135L-2)                                                  
         DC    C'</td>'                                                         
EMLS135L EQU   *-EMLS135                                                        
*                                                                               
EMLS140  DC    AL2(EMLS140L-2)                                                  
         DC    C'</tr>'                                                         
EMLS140L EQU   *-EMLS140                                                        
*                                                                               
EMLS145  DC    AL2(EMLS145L-2)                                                  
         DC    C'</table>'                                                      
EMLS145L EQU   *-EMLS145                                                        
*                                                                               
EMLS150  DC    AL2(EMLS150L-2)                                                  
         DC    C'<!-- end: header -->'                                          
EMLS150L EQU   *-EMLS150                                                        
*                                                                               
EMLS155  DC    AL2(EMLS155L-2)                                                  
         DC    C'<!-- body -->'                                                 
EMLS155L EQU   *-EMLS155                                                        
*                                                                               
EMLS160  DC    AL2(EMLS160L-2)                                                  
         DC    C'<table width="100%" border="0" cellspacing="0" '               
         DC    C'cellpadding="0">'                                              
EMLS160L EQU   *-EMLS160                                                        
*                                                                               
EMLS165  DC    AL2(EMLS165L-2)                                                  
         DC    C'<tr>'                                                          
EMLS165L EQU   *-EMLS165                                                        
*                                                                               
EMLS170  DC    AL2(EMLS170L-2)                                                  
         DC    C'<td height="10">'                                              
EMLS170L EQU   *-EMLS170                                                        
*                                                                               
EMLS175  DC    AL2(EMLS175L-2)                                                  
         DC    C'</td>'                                                         
EMLS175L EQU   *-EMLS175                                                        
*                                                                               
EMLS180  DC    AL2(EMLS180L-2)                                                  
         DC    C'</tr>'                                                         
EMLS180L EQU   *-EMLS180                                                        
*                                                                               
EMLS185  DC    AL2(EMLS185L-2)                                                  
         DC    C'</table>'                                                      
EMLS185L EQU   *-EMLS185                                                        
*                                                                               
EMLS190  DC    AL2(EMLS190L-2)                                                  
         DC    C'<!-- tape check module -->'                                    
EMLS190L EQU   *-EMLS190                                                        
*                                                                               
EMLS195  DC    AL2(EMLS195L-2)                                                  
         DC    C'<table width="800" bgcolor="#ffffff" border="0" '              
         DC    C'cellspacing="0" cellpadding="0" '                              
         DC    C'style="font-family: Calibri, sans-serif; '                     
         DC    C'font-size:13px; color:#4E4D4C; '                               
EMLS195L EQU   *-EMLS195                                                        
*                                                                               
EMLS200  DC    AL2(EMLS200L-2)                                                  
         DC    C'background-color:#D9D9CD; '                                    
         DC    C'-webkit-border-radius: 3px; '                                  
         DC    C'-moz-border-radius: 3px; '                                     
         DC    C'border-radius: 3px;">'                                         
EMLS200L EQU   *-EMLS200                                                        
*                                                                               
EMLS205  DC    AL2(EMLS205L-2)                                                  
         DC    C'<tr>'                                                          
EMLS205L EQU   *-EMLS205                                                        
*                                                                               
EMLS210  DC    AL2(EMLS210L-2)                                                  
         DC    C'<td height="20" colspan="3" style="font-size:1px; '            
         DC    C'border-collapse:collapse; margin:0; padding:0;">'              
EMLS210L EQU   *-EMLS210                                                        
*                                                                               
EMLS215  DC    AL2(EMLS215L-2)                                                  
         DC    C'<img height="20" alt="spacer" '                                
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS215L EQU   *-EMLS215                                                        
*                                                                               
EMLS220  DC    AL2(EMLS220L-2)                                                  
         DC    C'</td>'                                                         
EMLS220L EQU   *-EMLS220                                                        
*                                                                               
EMLS225  DC    AL2(EMLS225L-2)                                                  
         DC    C'</tr>'                                                         
EMLS225L EQU   *-EMLS225                                                        
*                                                                               
EMLS230  DC    AL2(EMLS230L-2)                                                  
         DC    C'<tr>'                                                          
EMLS230L EQU   *-EMLS230                                                        
*                                                                               
EMLS235  DC    AL2(EMLS235L-2)                                                  
         DC    C'<td width="20">'                                               
EMLS235L EQU   *-EMLS235                                                        
*                                                                               
EMLS240  DC    AL2(EMLS240L-2)                                                  
         DC    C'<img height="1" width="20" alt="spacer" '                      
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS240L EQU   *-EMLS240                                                        
*                                                                               
EMLS245  DC    AL2(EMLS245L-2)                                                  
         DC    C'</td>'                                                         
EMLS245L EQU   *-EMLS245                                                        
*                                                                               
EMLS250  DC    AL2(EMLS250L-2)                                                  
         DC    C'<td valign="top" width="360" '                                 
         DC    C'style="font-family: Calibri, sans-serif; '                     
         DC    C'font-size:30px; color:#4E4D4C; line-height:36px;">'            
EMLS250L EQU   *-EMLS250                                                        
*                                                                               
EMLS255  DC    AL2(EMLS255L-2)                                                  
         DC    C'<div>'                                                         
EMLS255E DS    CL80                                                             
         DC    C'</div>'                                                        
EMLS255L EQU   *-EMLS255                                                        
*                                                                               
         DC    AL2(EMLS261L)                                                    
EMLS261  DS    CL160                                                            
EMLS261L EQU   *-EMLS261                                                        
*                                                                               
         DC    AL2(EMLS262L)                                                    
EMLS262  DS    CL160                                                            
EMLS262L EQU   *-EMLS262                                                        
*                                                                               
EMLS270  DC    AL2(EMLS270L-2)                                                  
         DC    C'<p style="color:#4E4D4C; font-size:13px; '                     
         DC    C'text-decoration:none; line-height:16px;">'                     
EMLS270L EQU   *-EMLS270                                                        
*                                                                               
EMLS285  DC    AL2(EMLS285L-2)                                                  
         DC    C'<br>'                                                          
EMAIL285 DS    CL80                                                             
EMAILFNA DS    CL20                                                             
         DC    C' '                                                             
EMAILLNA DS    CL20                                                             
         DC    C'.'                                                             
EMLS285L EQU   *-EMLS285                                                        
*                                                                               
EMLS286  DC    AL2(EMLS286L-2)                                                  
         DC    C'<br>'                                                          
EMAIL286 DS    CL160                                                            
EMLS286L EQU   *-EMLS286                                                        
*                                                                               
EMLS287  DC    AL2(EMLS287L-2)                                                  
         DC    C'<br>'                                                          
EMAIL287 DS    CL80                                                             
EMLS287L EQU   *-EMLS287                                                        
*                                                                               
EMLS288  DC    AL2(EMLS288L-2)                                                  
EMAIL288 DS    CL80                                                             
EMLS288L EQU   *-EMLS288                                                        
*                                                                               
EMLS289  DC    AL2(EMLS289L-2)                                                  
EMAIL289 DS    CL80                                                             
EMLS289L EQU   *-EMLS289                                                        
*                                                                               
EMLS295  DC    AL2(EMLS295L-2)                                                  
         DC    C'</p>'                                                          
EMLS295L EQU   *-EMLS295                                                        
*                                                                               
EMLS300  DC    AL2(EMLS300L-2)                                                  
         DC    C'</td>'                                                         
EMLS300L EQU   *-EMLS300                                                        
*                                                                               
EMLS305  DC    AL2(EMLS305L-2)                                                  
         DC    C'<td width="20">'                                               
EMLS305L EQU   *-EMLS305                                                        
*                                                                               
EMLS310  DC    AL2(EMLS310L-2)                                                  
         DC    C'<img height="1" width="20" border="0" alt="spacer" '           
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS310L EQU   *-EMLS310                                                        
*                                                                               
EMLS315  DC    AL2(EMLS315L-2)                                                  
         DC    C'</td>'                                                         
EMLS315L EQU   *-EMLS315                                                        
*                                                                               
EMLS320  DC    AL2(EMLS320L-2)                                                  
         DC    C'</tr>'                                                         
EMLS320L EQU   *-EMLS320                                                        
*                                                                               
EMLS325  DC    AL2(EMLS325L-2)                                                  
         DC    C'<tr>'                                                          
EMLS325L EQU   *-EMLS325                                                        
EMLS330  DC    AL2(EMLS330L-2)                                                  
         DC    C'<td height="30" colspan="3" style="font-size:1px; '            
         DC    C'border-collapse:collapse; margin:0; padding:0;">'              
EMLS330L EQU   *-EMLS330                                                        
*                                                                               
EMLS335  DC    AL2(EMLS335L-2)                                                  
         DC    C'<img height="30" width="20" border="0" alt="spacer" '          
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS335L EQU   *-EMLS335                                                        
*                                                                               
EMLS340  DC    AL2(EMLS340L-2)                                                  
         DC    C'</td>'                                                         
EMLS340L EQU   *-EMLS340                                                        
*                                                                               
EMLS345  DC    AL2(EMLS345L-2)                                                  
         DC    C'</tr>'                                                         
EMLS345L EQU   *-EMLS345                                                        
*                                                                               
EMLS350  DC    AL2(EMLS350L-2)                                                  
         DC    C'</table>'                                                      
EMLS350L EQU   *-EMLS350                                                        
*                                                                               
EMLS355  DC    AL2(EMLS355L-2)                                                  
         DC    C'<!-- no background module -->'                                 
EMLS355L EQU   *-EMLS355                                                        
*                                                                               
EMLS360  DC    AL2(EMLS360L-2)                                                  
         DC    C'<table width="800" bgcolor="#ffffff" border="0" '              
         DC    C'cellspacing="0" cellpadding="0" style="font-family: '          
EMLS360L EQU   *-EMLS360                                                        
*                                                                               
EMLS365  DC    AL2(EMLS365L-2)                                                  
         DC    C'Calibri, sans-serif; font-size:10px; color:#4E4D4C; '          
         DC    C'background-color:#ffffff; -webkit-border-radius: 3px;'         
         DC    C' -moz-border-radius: 3px; border-radius: 3px;">'               
EMLS365L EQU   *-EMLS365                                                        
*                                                                               
EMLS370  DC    AL2(EMLS370L-2)                                                  
         DC    C'<tr>'                                                          
EMLS370L EQU   *-EMLS370                                                        
*                                                                               
EMLS375  DC    AL2(EMLS375L-2)                                                  
         DC    C'<td rowspan="3" width="30">'                                   
EMLS375L EQU   *-EMLS375                                                        
*                                                                               
EMLS380  DC    AL2(EMLS380L-2)                                                  
         DC    C'<img height="1" width="30" border="0" alt="spacer" '           
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS380L EQU   *-EMLS380                                                        
*                                                                               
EMLS385  DC    AL2(EMLS385L-2)                                                  
         DC    C'</td>'                                                         
EMLS385L EQU   *-EMLS385                                                        
*                                                                               
EMLS390  DC    AL2(EMLS390L-2)                                                  
         DC    C'<td>'                                                          
EMLS390L EQU   *-EMLS390                                                        
*                                                                               
EMLS395  DC    AL2(EMLS395L-2)                                                  
         DC    X'50'                                                            
         DC    C'nbsp;'                                                         
EMLS395L EQU   *-EMLS395                                                        
*                                                                               
EMLS400  DC    AL2(EMLS400L-2)                                                  
         DC    C'</td>'                                                         
EMLS400L EQU   *-EMLS400                                                        
*                                                                               
EMLS405  DC    AL2(EMLS405L-2)                                                  
         DC    C'<td rowspan="3" width="30">'                                   
EMLS405L EQU   *-EMLS405                                                        
*                                                                               
EMLS410  DC    AL2(EMLS410L-2)                                                  
         DC    C'<img height="1" width="30" border="0" alt="spacer" '           
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS410L EQU   *-EMLS410                                                        
*                                                                               
EMLS415  DC    AL2(EMLS415L-2)                                                  
         DC    C'</td>'                                                         
EMLS415L EQU   *-EMLS415                                                        
*                                                                               
EMLS420  DC    AL2(EMLS420L-2)                                                  
         DC    C'</tr>'                                                         
EMLS420L EQU   *-EMLS420                                                        
*                                                                               
EMLS425  DC    AL2(EMLS425L-2)                                                  
         DC    C'<tr>'                                                          
EMLS425L EQU   *-EMLS425                                                        
*                                                                               
EMLS430  DC    AL2(EMLS430L-2)                                                  
         DC    C'<td style="vertical-align:top;">'                              
EMLS430L EQU   *-EMLS430                                                        
*                                                                               
EMLS435  DC    AL2(EMLS435L-2)                                                  
         DC    C'<p>'                                                           
EMLS435L EQU   *-EMLS435                                                        
*                                                                               
EMLS440  DC    AL2(EMLS440L-2)                                                  
EMAILS1  DS    CL80                                                             
EMAILS2  DS    CL80                                                             
EMLS440L EQU   *-EMLS440                                                        
*                                                                               
EMLS445  DC    AL2(EMLS445L-2)                                                  
EMAILS3  DS    CL80                                                             
EMAILS4  DS    CL80                                                             
EMLS445L EQU   *-EMLS445                                                        
*                                                                               
EMLS450  DC    AL2(EMLS450L-2)                                                  
EMAILS5  DS    CL80                                                             
         DC    C'</p>'                                                          
EMLS450L EQU   *-EMLS450                                                        
*                                                                               
EMLS455  DC    AL2(EMLS455L-2)                                                  
         DC    C'<p>'                                                           
EMLS455L EQU   *-EMLS455                                                        
*                                                                               
EMLS460  DC    AL2(EMLS460L-2)                                                  
EMAILS6  DS    CL80                                                             
EMAILS7  DS    CL80                                                             
EMLS460L EQU   *-EMLS460                                                        
*                                                                               
EMLS465  DC    AL2(EMLS465L-2)                                                  
EMAILS8  DS    CL80                                                             
EMAILS9  DS    CL80                                                             
EMLS465L EQU   *-EMLS465                                                        
*                                                                               
EMLS468  DC    AL2(EMLS468L-2)                                                  
EMAILSA  DS    CL80                                                             
EMLS468L EQU   *-EMLS468                                                        
*                                                                               
EMLS470  DC    AL2(EMLS470L-2)                                                  
         DC    C'</p>'                                                          
EMLS470L EQU   *-EMLS470                                                        
*                                                                               
EMLS475  DC    AL2(EMLS475L-2)                                                  
         DC    C'</td>'                                                         
EMLS475L EQU   *-EMLS475                                                        
*                                                                               
EMLS480  DC    AL2(EMLS480L-2)                                                  
         DC    C'</tr>'                                                         
EMLS480L EQU   *-EMLS480                                                        
*                                                                               
EMLS485  DC    AL2(EMLS485L-2)                                                  
         DC    C'<tr>'                                                          
EMLS485L EQU   *-EMLS485                                                        
*                                                                               
EMLS490  DC    AL2(EMLS490L-2)                                                  
         DC    C'<td height="20" style="font-size:1px; '                        
         DC    C'border-collapse:collapse; margin:0; padding:0;">'              
EMLS490L EQU   *-EMLS490                                                        
*                                                                               
EMLS495  DC    AL2(EMLS495L-2)                                                  
         DC    C'<img height="20" border="0" alt=spacer" '                      
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS495L EQU   *-EMLS495                                                        
*                                                                               
EMLS500  DC    AL2(EMLS500L-2)                                                  
         DC    C'</td>'                                                         
EMLS500L EQU   *-EMLS500                                                        
*                                                                               
EMLS505  DC    AL2(EMLS505L-2)                                                  
         DC    C'</tr>'                                                         
EMLS505L EQU   *-EMLS505                                                        
*                                                                               
EMLS510  DC    AL2(EMLS510L-2)                                                  
         DC    C'</table>'                                                      
EMLS510L EQU   *-EMLS510                                                        
*                                                                               
EMLS515  DC    AL2(EMLS515L-2)                                                  
         DC    C'<!-- end: body -->'                                            
EMLS515L EQU   *-EMLS515                                                        
*                                                                               
EMLS520  DC    AL2(EMLS520L-2)                                                  
         DC    C'<!-- Footer -->'                                               
EMLS520L EQU   *-EMLS520                                                        
*                                                                               
EMLS525  DC    AL2(EMLS525L-2)                                                  
         DC    C'<table width="800" cellspacing="0" cellpadding="0" '           
         DC    C'style="height:78px; font-family: Calibri, '                    
EMLS525L EQU   *-EMLS525                                                        
*                                                                               
EMLS530  DC    AL2(EMLS530L-2)                                                  
         DC    C'sans-serif; font-size:10px; color:#ffffff; '                   
         DC    C'background-color:#4E4D4C; text-align:center; '                 
EMLS530L EQU   *-EMLS530                                                        
*                                                                               
EMLS535  DC    AL2(EMLS535L-2)                                                  
         DC    C'border-bottom:1px solid #4E4D4C; '                             
         DC    C'-webkit-border-radius: 3px; -moz-border-radius: 3px; '         
         DC    C'border-radius: 3px;">'                                         
EMLS535L EQU   *-EMLS535                                                        
*                                                                               
EMLS540  DC    AL2(EMLS540L-2)                                                  
         DC    C'<tr>'                                                          
EMLS540L EQU   *-EMLS540                                                        
*                                                                               
EMLS545  DC    AL2(EMLS545L-2)                                                  
         DC    C'<td rowspan="3" width="30">'                                   
EMLS545L EQU   *-EMLS545                                                        
*                                                                               
EMLS550  DC    AL2(EMLS550L-2)                                                  
         DC    C'<img height="1" width="30" border="0" alt="spacer" '           
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS550L EQU   *-EMLS550                                                        
*                                                                               
EMLS555  DC    AL2(EMLS555L-2)                                                  
         DC    C'</td>'                                                         
EMLS555L EQU   *-EMLS555                                                        
*                                                                               
EMLS560  DC    AL2(EMLS560L-2)                                                  
         DC    C'<td colspan="2" height="15" style="font-size:1px; '            
         DC    C'border-collapse:collapse; margin:0; padding:0;">'              
EMLS560L EQU   *-EMLS560                                                        
*                                                                               
EMLS565  DC    AL2(EMLS565L-2)                                                  
         DC    C'<img height="15" border="0" alt="spacer" '                     
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS565L EQU   *-EMLS565                                                        
*                                                                               
EMLS570  DC    AL2(EMLS570L-2)                                                  
         DC    C'</td>'                                                         
EMLS570L EQU   *-EMLS570                                                        
*                                                                               
EMLS575  DC    AL2(EMLS575L-2)                                                  
         DC    C'<td rowspan="3" width="30">'                                   
EMLS575L EQU   *-EMLS575                                                        
*                                                                               
EMLS580  DC    AL2(EMLS580L-2)                                                  
         DC    C'<img height="1" width="30" border="0" alt="spacer" '           
         DC    C'src="http://go.mediaocean.com/rs/mediaocean/images/'           
         DC    C'spacer.png"/>'                                                 
EMLS580L EQU   *-EMLS580                                                        
*                                                                               
EMLS585  DC    AL2(EMLS585L-2)                                                  
         DC    C'</td>'                                                         
EMLS585L EQU   *-EMLS585                                                        
*                                                                               
EMLS590  DC    AL2(EMLS590L-2)                                                  
         DC    C'</tr>'                                                         
EMLS590L EQU   *-EMLS590                                                        
*                                                                               
EMLS595  DC    AL2(EMLS595L-2)                                                  
         DC    C'<tr style="vertical-align:bottom;">'                           
EMLS595L EQU   *-EMLS595                                                        
*                                                                               
EMLS600  DC    AL2(EMLS600L-2)                                                  
         DC    C'<td style="text-align:left;">'                                 
EMLS600L EQU   *-EMLS600                                                        
*                                                                               
EMLS605  DC    AL2(EMLS605L-2)                                                  
         DC    C'<div>'                                                         
EMLS605L EQU   *-EMLS605                                                        
*                                                                               
EMLS610  DC    AL2(EMLS610L-2)                                                  
EMLS610E DS    CL80                                                             
EMLS610L EQU   *-EMLS610                                                        
*                                                                               
EMLS615  DC    AL2(EMLS615L-2)                                                  
         DC    C'<br />'                                                        
EMLS615L EQU   *-EMLS615                                                        
*                                                                               
EMLS620  DC    AL2(EMLS620L-2)                                                  
         DC    X'50'                                                            
         DC    C'copy'                                                          
EMLS620E DS    CL4                                                              
         DC    C' MEDIAOCEAN'                                                   
EMLS620L EQU   *-EMLS620                                                        
*                                                                               
EMLS625  DC    AL2(EMLS625L-2)                                                  
         DC    C'| '                                                            
EMLS625E DS    CL18                                                             
         DC    C':'                                                             
EMLS625L EQU   *-EMLS625                                                        
*                                                                               
EMLS630  DC    AL2(EMLS630L-2)                                                  
         DC    C'<a style="text-decoration:none; color:#ffffff;" '              
         DC    C'href="https://www.facebook.com/team.mediaocean">'              
         DC    C'FACEBOOK'                                                      
         DC    C'</a>'                                                          
         DC    C' |'                                                            
EMLS630L EQU   *-EMLS630                                                        
*                                                                               
EMLS635  DC    AL2(EMLS635L-2)                                                  
         DC    C'<a style="text-decoration:none; color:#ffffff;" '              
         DC    C'href="https://twitter.com/teammediaocean">'                    
         DC    C'TWITTER'                                                       
         DC    C'</a>'                                                          
         DC    C' |'                                                            
EMLS635L EQU   *-EMLS635                                                        
*                                                                               
EMLS640  DC    AL2(EMLS640L-2)                                                  
         DC    C'<a style="text-decoration:none; color:#ffffff;" '              
         DC    C'href="http://www.linkedin.com/company/mediaocean">'            
         DC    C'LINKEDIN'                                                      
         DC    C'</a>'                                                          
         DC    C' |'                                                            
EMLS640L EQU   *-EMLS640                                                        
*                                                                               
EMLS642  DC    AL2(EMLS642L-2)                                                  
         DC    C'<a style="text-decoration:none; color:#ffffff;" '              
         DC    C'href="http://instagram.com/teammediaocean">'                   
         DC    C'INSTAGRAM'                                                     
         DC    C'</a>'                                                          
EMLS642L EQU   *-EMLS642                                                        
*                                                                               
EMLS645  DC    AL2(EMLS645L-2)                                                  
         DC    C'</div>'                                                        
EMLS645L EQU   *-EMLS645                                                        
*                                                                               
EMLS650  DC    AL2(EMLS650L-2)                                                  
         DC    C'</td>'                                                         
EMLS650L EQU   *-EMLS650                                                        
*                                                                               
EMLS655  DC    AL2(EMLS655L-2)                                                  
         DC    C'<td style="text-align:right;">'                                
EMLS655L EQU   *-EMLS655                                                        
*                                                                               
EMLS660  DC    AL2(EMLS660L-2)                                                  
         DC    C'<a href="http://www.mediaocean.com">'                          
EMLS660L EQU   *-EMLS660                                                        
*                                                                               
EMLS665  DC    AL2(EMLS665L-2)                                                  
         DC    C'<img src="http://info.mediaocean.com/rs/331-XPM-231/'          
         DC    C'images/MO-general-footer-logo.png" alt="MediaOcean" '          
         DC    C'/>'                                                            
EMLS665L EQU   *-EMLS665                                                        
*                                                                               
EMLS670  DC    AL2(EMLS670L-2)                                                  
         DC    C'</a>'                                                          
EMLS670L EQU   *-EMLS670                                                        
*                                                                               
EMLS675  DC    AL2(EMLS675L-2)                                                  
         DC    C'</td>'                                                         
EMLS675L EQU   *-EMLS675                                                        
*                                                                               
EMLS680  DC    AL2(EMLS680L-2)                                                  
         DC    C'</tr>'                                                         
EMLS680L EQU   *-EMLS680                                                        
*                                                                               
EMLS685  DC    AL2(EMLS685L-2)                                                  
         DC    C'</table>'                                                      
EMLS685L EQU   *-EMLS685                                                        
*                                                                               
EMLS690  DC    AL2(EMLS690L-2)                                                  
         DC    C'<!-- end: Footer -->'                                          
EMLS690L EQU   *-EMLS690                                                        
*                                                                               
EMLS695  DC    AL2(EMLS695L-2)                                                  
         DC    C'</td>'                                                         
EMLS695L EQU   *-EMLS695                                                        
*                                                                               
EMLS700  DC    AL2(EMLS700L-2)                                                  
         DC    C'</tr>'                                                         
EMLS700L EQU   *-EMLS700                                                        
*                                                                               
EMLS705  DC    AL2(EMLS705L-2)                                                  
         DC    C'</table>'                                                      
EMLS705L EQU   *-EMLS705                                                        
*                                                                               
EMLS710  DC    AL2(EMLS710L-2)                                                  
         DC    C'<!-- End Inner Wrap -->'                                       
EMLS710L EQU   *-EMLS710                                                        
*                                                                               
EMLS715  DC    AL2(EMLS715L-2)                                                  
         DC    C'</td>'                                                         
EMLS715L EQU   *-EMLS715                                                        
*                                                                               
EMLS720  DC    AL2(EMLS720L-2)                                                  
         DC    C'</tr>'                                                         
EMLS720L EQU   *-EMLS720                                                        
*                                                                               
EMLS725  DC    AL2(EMLS725L-2)                                                  
         DC    C'</table>'                                                      
EMLS725L EQU   *-EMLS725                                                        
*                                                                               
EMLS730  DC    AL2(EMLS730L-2)                                                  
         DC    C'<!-- End Outer Wrap -->'                                       
EMLS730L EQU   *-EMLS730                                                        
*                                                                               
EMLS735  DC    AL2(EMLS735L-2)                                                  
         DC    C'</body>'                                                       
EMLS735L EQU   *-EMLS735                                                        
*                                                                               
EMLS740  DC    AL2(EMLS740L-2)                                                  
         DC    C'</html>'                                                       
EMLS740L EQU   *-EMLS740                                                        
*                                                                               
EMLSTMLL EQU   *-EMLSUM                                                         
         DC    X'FFFF'                                                          
                                                                                
***********************************************************************         
* GET PROGRAM ACCESS CONTROL LIST                                               
***********************************************************************         
GETRAL   NTR1  BASE=*                                                           
         L     RA,ASECBLOC                                                      
         USING SECD,RA                                                          
         LA    RE,ADPAACL                                                       
         ICM   RF,15,=AL4(L'ADPAACL)                                            
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
*                                                                               
         TM    SECINDS,SECIDDS+SECIOLD                                          
         BNZ   GRALOK              DDS/OLD SECURITY = YES                       
         TM    SECINDS,SECIOVAL                                                 
         BZ    GRALOK              NO SECURITY VALUES = YES                     
*                                                                               
         LA    R4,ADPAACL                                                       
         LA    R3,L'ADPAACL                                                     
*                                                                               
         LA    R9,SECRALST                                                      
         USING RALSTD,R9                                                        
*                                                                               
         XR    R5,R5                                                            
         IC    R5,RAACTSL                                                       
         LA    R5,RAACTS(R5)                                                    
         USING RAMIXD,R5           R5=(RECORD/ACTION LIST ENTRY)                
*                                                                               
GRAL010  CLI   RAMIXD,RAMEOL       TEST END-OF-LIST                             
         BE    GRAL100                                                          
         SHI   R3,2                                                             
         BM    GRALNO                                                           
         GOTOR AHEXOUT,PARM,RAMRCD,0(R4),1,=C'TOG'                              
         AHI   R4,2                                                             
*                                                                               
         LA    R2,RAACTS           R2=A(ACTION CODE LIST)                       
         CLI   RAACTSL,0                                                        
         BE    GRAL040                                                          
         XR    R6,R6                                                            
         IC    R6,RAACTSL          R6=L(ACTION CODE LIST)                       
*                                                                               
GRAL020  MVC   BYTE,0(R2)                                                       
         B     GRAL030                                                          
GRAL022  AHI   R2,1                BUMP R1 TO NEXT ACTION CODE                  
         BCT   R6,GRAL020                                                       
         B     GRAL040                                                          
*                                                                               
GRAL030  XR    R0,R0                                                            
         IC    R0,RAACTSL                                                       
         SR    R0,R6               R0=ACTION SEQUENCE NUMBER                    
         GOTOR TESTBIT,RAMACT                                                   
         BNO   GRAL022                                                          
         SHI   R3,2                                                             
         BM    GRALNO                                                           
         GOTOR AHEXOUT,PARM,BYTE,0(R4),1,=C'TOG'                                
         AHI   R4,2                                                             
         B     GRAL022             BUMP R2 TO NEXT LIST ENTRY                   
*                                                                               
GRAL040  SHI   R3,2                                                             
         BM    GRALNO                                                           
         MVC   0(2,R4),=CL2'00'                                                 
         AHI   R4,2                                                             
         XR    RF,RF                                                            
         IC    RF,RAMIXL                                                        
         AR    R5,RF                                                            
         B     GRAL010                                                          
*                                                                               
GRAL100  SHI   R3,2                                                             
         BM    GRALNO                                                           
         MVC   0(2,R4),=CL2'00'                                                 
         AHI   R4,2                                                             
         B     GRALOK                                                           
         DROP  R5                                                               
*                                                                               
GRALOK   SR    RC,RC                                                            
GRALNO   LTR   RC,RC                                                            
         J     EXIT                                                             
         LTORG                                                                  
         DROP  R9                                                               
         DROP  RA                                                               
                                                                                
***********************************************************************         
* NTRY: R1=A(BIT TABLE), R0=CODE                                                
***********************************************************************         
TESTBIT  LR    RF,R0               R1=A(BYTE OF BIT)                            
         SRL   RF,3                                                             
         AR    R1,RF                                                            
                                                                                
         LHI   RF,X'07'            RF=MASK                                      
         NR    RF,R0                                                            
         IC    RF,MASKS(RF)                                                     
                                                                                
         EX    RF,TESTBITM         EX A TM                                      
         BR    RE                                                               
                                                                                
TESTBITM TM    0(R1),0             A TM                                         
         DC    F'0'                                                             
MASKS    DC    X'8040201008040201'                                              
         DC    F'0'                                                             
         LTORG                                                                  
                                                                                
***********************************************************************         
* DSECTS                                                                        
***********************************************************************         
         PRINT OFF                                                              
* SRPCIFF                                                                       
       ++INCLUDE SRPCIFFD                                                       
* SEACSFILE                                                                     
       ++INCLUDE SEACSFILE                                                      
* CTGENFILE                                                                     
       ++INCLUDE CTGENFILE                                                      
* CTGENWEB                                                                      
       ++INCLUDE CTGENWEB                                                       
* FASECRETD                                                                     
       ++INCLUDE FASECRETD                                                      
* FADSECTS                                                                      
       ++INCLUDE FADSECTS                                                       
* FACTRYEQUS                                                                    
       ++INCLUDE FACTRYEQUS                                                     
* DDFLDHDR                                                                      
       ++INCLUDE DDFLDHDR                                                       
* DDSPOOK                                                                       
       ++INCLUDE DDSPOOK                                                        
* DDMASTD                                                                       
       ++INCLUDE DDMASTD                                                        
* DDCOMFACS                                                                     
       ++INCLUDE DDCOMFACS                                                      
* FATABSDEQU                                                                    
       ++INCLUDE FATABSDEQU                                                     
* FATABSDAR                                                                     
       ++INCLUDE FATABSDAR                                                      
* DMSPACED                                                                      
       ++INCLUDE DMSPACED                                                       
* FACIDTABD                                                                     
       ++INCLUDE FACIDTABD                                                      
* FAJESMAILD                                                                    
       ++INCLUDE FAJESMAILD                                                     
         PRINT ON                                                               
* DDACCESSD                                                                     
       ++INCLUDE DDACCESSD                                                      
                                                                                
***********************************************************************         
* LOCAL WORKING STORAGE                                                         
***********************************************************************         
WORKD    DSECT                                                                  
DUB      DS    D                                                                
PARM     DS    8A                                                               
RELO     DS    F                                                                
DMCB     DS    6F                                                               
*                                                                               
APARMS   DS    A                                                                
SRPARMS  DS    8A                                                               
*                                                                               
ASYSFAC  DS    A                                                                
AMSGQIN  DS    A                                                                
ASSB     DS    A                                                                
ATCB     DS    A                                                                
ATCBTASK DS    A                                                                
AUTLTAB  DS    A                                                                
AUTL     DS    A                                                                
ALCM     DS    A                                                                
ATWA     DS    A                                                                
ATIA     DS    A                                                                
ACOMFACS DS    A                                                                
ASELIST  DS    A                                                                
AMAP     DS    A                                                                
ATIOB    DS    A                                                                
ASAVE    DS    A                                                                
SAVELEN  DS    XL4                                                              
SAVESCRN DS    XL1                                                              
ALOAD    DS    A                                                                
AUIDSYS  DS    A                                                                
APIDSYS  DS    A                                                                
*                                                                               
ADATAMGR DS    A                                                                
ADMOD000 DS    A                                                                
AFINDSYS DS    A                                                                
ADATCON  DS    A                                                                
ACALLOV  DS    A                                                                
ASECRET  DS    A                                                                
AHEXOUT  DS    A                                                                
ASWITCH  DS    A                                                                
AHEXIN   DS    A                                                                
AGETIDS  DS    A                                                                
ARCPACK  DS    A                                                                
AOFFLAL  DS    A                                                                
ASCANNER DS    A                                                                
ACLPACK  DS    A                                                                
AOFFICER DS    A                                                                
ALIMACC  DS    0A                  UK ONLY                                      
ACLUNPK  DS    A                   US ONLY                                      
AHELLO   DS    A                                                                
AJESMAIL DS    A                                                                
ADICTATE DS    A                                                                
*                                                                               
FULL     DS    F                                                                
HALF     DS    H                                                                
BYTE     DS    X                                                                
DMWORK   DS    XL64                                                             
*                                                                               
PGMCODE  DS    X                                                                
SYSCODE  DS    X                                                                
USERID   DS    CL10                                                             
UIDNUM   DS    XL2                                                              
PIDNUM   DS    XL2                                                              
AGRNUM   DS    XL2                                                              
DACNUM   DS    XL2                 DATA ACCESS GROUP NUMBER                     
UIDLACC  DS    CL4                                                              
PIDLACC  DS    CL4                 PID LIMIT/DATA ACCESS                        
PIDLIDC  DS    XL2                                                              
PIDLID   DS    CL3                                                              
*                                                                               
DATE     DS    CL12                                                             
DAYTODAY DS    PL1                 PWOS DAY TODAY                               
TIME     DS    PL4                 TIME NOW                                     
TODAY0   DS    CL6                 TODAYS DATE                                  
TODAY20  DS    CL8                 TODAYS DATE yyyymmdd                         
CUCTRY   DS    X                   COUNTRY                                      
CULANG   DS    X                   LANGUAGE                                     
*                                                                               
WORK     DS    CL256                                                            
*                                                                               
RETCODE  DS    XL1                                                              
REASCODE DS    F                                                                
CONTROL  DS    CL8                 GO, SHUTDOWN, OR RESTART                     
*                                                                               
RCOUT    DS    XL8                                                              
ERROR    DS    XL1                                                              
*                                                                               
WTOMSG   DS    CL255                                                            
*                                                                               
TSRSAVE  DS    XL2                 UTL TSVCREQ VALUE SAVE                       
*                                                                               
ACTN     DS    XL1                 ACCPACTN                                     
*                                                                               
SAVETSYS DS    XL1                                                              
*                                                                               
INDICS   DS    XL1                 * INDICATORS *                               
INDIOSP  EQU   X'80'               OVERRIDE SYSTEM/PROGRAM                      
INDIAGY  EQU   X'40'               MAIN AGENCY ACCESS RECORD                    
INDIMED  EQU   X'20'               MEDIA INVALID RETURNED FROM MEDGET           
*                                                                               
*&&UK                                                                           
SVMEDSTA DS    C                   SAVED MEDDSTAT                               
*&&                                                                             
*                                                                               
         DS    0D                                                               
IOKEY    DS    XL(L'SAASKEY)       IO KEY                                       
         DS    0D                                                               
KEY      DS    XL40                                                             
KEYSAVE  DS    XL40                                                             
*                                                                               
AIOAREA  DS    A                                                                
AUTLSAVE DS    A                                                                
ATCBSAVE DS    A                                                                
ASECBLOC DS    A                                                                
ARALST   DS    A                                                                
*                                                                               
ASENTRY  DS    A                   A(SELIST ENTRY)                              
APGMLIST DS    A                   A(PROGRAM LIST)                              
*                                                                               
IPWORK   DS    8F                                                               
SNIDSTRV DS    XL40                SUBNET ID STRING VALUE                       
SNIDSTRL DS    XL1                 SUBNET ID STRING LENGTH                      
SNID     DS    XL16                SUBNET ID                                    
SNIDMASK DS    XL16                SUBNET ID                                    
IPRKSNID DS    XL16                IP SUBNET RECORD KEY                         
SVIPRKEY DS    XL16                SAVED IP SUBNET RECORD KEY                   
SVIPMASK DS    XL16                SAVED IP SUBNET MASK                         
SAGY     DS    CL2                                                              
EFFDATE  DS    XL2                                                              
ALLVALID DS    C                   C'Y' IF 'ALL' IDS COMPAT WITH TERM           
SESYSN   DS    X                   SYSTEM NUMBER                                
IDOSID   DS    CL10                ALPHA USER-ID                                
USERNO   DS    XL2                 NUMERIC USER-ID                              
UIDPAUTH DS    XL2                 USER ID PROGRAM AUTH                         
PIDPAUTH DS    XL2                 PASSWORD PROGRAM AUTH                        
PGMAUTH  DS    XL2                 RESOLVED PROGRAM AUTH                        
ADVID    DS    CL8                 FACPAK ADV ID                                
*                                                                               
PASSREQD DS    XL1                 PASSWORD REQUIRED FOR SYSTEM X'80'           
DDSUSER  DS    CL1                 DDSUSER=Y                                    
SVTSTAT1 DS    CL1                                                              
SVTTYPE  DS    CL1                                                              
SVTVIFLG DS    CL1                                                              
SFLAG    DS    CL1                                                              
*                                                                               
GETOVER  DS    XL1                 GETIDS OUTPUT BLOCK OVERFLOW ERROR           
*                                                                               
PERSONID DS    CL(L'SAPEPID)       PERSONAL ID CODE                             
AGROUPNO DS    CL(L'SAAGCNUM)      PERSON ACCESS GROUP CODE NUMBER              
LGROUPCD DS    CL(L'SALACCOD)      PERSON LIMIT ACCESS GROUP CODE               
LAGVALUE DS    CL(L'SALASALL)      PERSON LIMIT ACCESS GROUP CODE               
*                                                                               
SYSNAME  DS    CL7                 SYSTEM NAME SAVED FROM SCREEN FLD            
SYSNLEN  DS    XL1                 SYSTEM NAME LENGTH                           
*                                                                               
PEXPIRE  DS    CL(L'CTAADPTO)      PASSWORD TIMEOUT IN DAYS                     
PWARNED  DS    CL(L'CTAADPTO)      PASSWORD WARNING IN DAYS                     
PACSFLG  DS    CL(L'CTAADFLG)      ACCESS CONTROLS FLAG                         
PLCDATE  DS    CL(L'SAPWHDTE)      PASSWORD LAST CHANGED DATE                   
PLCTIME  DS    CL(L'SAPWHTME)      PASSWORD LAST CHANGED TIME                   
PLCFLAG  DS    CL(L'SAPWHFLG)      PASSWORD LAST CHANGED FLAG                   
*                                                                               
UCVER    DS    CL3                 ADUC VERSION                                 
*                                                                               
SVMEDIA  DS    X                   SAVED MEDIA                                  
*                                                                               
WEBCNTLS DS    CL3                 WEB CONTROLS                                 
ACCNETID DS    CL40                NET ID                                       
ACCESSCD DS    CL16                ACCESS CODE                                  
PWDPID   DS    CL8                 PID FROM PWD                                 
*                                                                               
DATO     DS    0C                                                               
         DSDDL PRINT=YES                                                        
DATOX    DS    0C                                                               
*                                                                               
SYPAREA  DS    0D                  SYSTEM SERVICE SYSPRG AREA                   
SYPINIT  DS    C                                                                
SYPIND   DS    X                                                                
INSYPR   DS    XL512               SYSTEM SERVICE SYSPRG INPUT                  
         ORG   SYPAREA             SYPR STORAGE ONLY FOR SSRV CALL              
*                                  REDEFINED BELOW FOR OTHER PC CALLS           
         DS    0D                                                               
EXPIDEL  DS    XL528               NEW SYSTEM AUTHORIZATION ELEMENT             
         DS    0D                                                               
UIDSYSEL DS    XL255               UID SYSTEM AUTHORIZATION ELEMENT             
         DS    0D                                                               
PIDSYSEL DS    XL255               PID SYSTEM AUTHORIZATION ELEMENT             
         DS    0D                                                               
PGMLACC  DS    XL255                                                            
         DS    0D                                                               
IOAREA   DS    XL4096                                                           
         DS    0D                                                               
UTLSAVE  DS    XL(TUTLXALN)                                                     
         DS    0D                                                               
TCBSAVE  DS    XL1024                                                           
         DS    0D                                                               
SECBLOC  DS    XL1024                                                           
*                                                                               
TOFLD    DS    CL60                EMAIL TO: FIELD                              
         DS    X                                                                
FROMFLD  DS    CL60                EMAIL FROM: FIELD                            
         DS    X                                                                
SUBFLD   DS    CL70                EMAIL SUBJECT: FIELD                         
         DS    X                                                                
*                                                                               
WORKX    DS    0X                                                               
*                                                                               
* SPGENCLT (US)                                                                 
* PCLTREC  (US)                                                                 
* MEFILMED (UK)                                                                 
* MEFILCLI (UK)                                                                 
* DDOFFICED                                                                     
         PRINT OFF                                                              
*&&US                                                                           
CLTHDRD  DSECT                                                                  
       ++INCLUDE SPGENCLT                                                       
PCLTRECD DSECT                                                                  
       ++INCLUDE PCLTREC                                                        
*&&                                                                             
*&&UK                                                                           
DMED     DSECT                                                                  
       ++INCLUDE MEFILMED                                                       
DCLI     DSECT                                                                  
       ++INCLUDE MEFILCLI                                                       
       ++INCLUDE FALIMACCD                                                      
*&&                                                                             
       ++INCLUDE DDOFFICED                                                      
*                                                                               
       ++INCLUDE SRDDEQUS                                                       
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'041DDACCESS  12/22/20'                                      
         END                                                                    
