*          DATA SET DDMANPRINT AT LEVEL 009 AS OF 05/01/02                      
*CATALP MANPRINT                                                                
         PRINT NOGEN                                                            
         SPACE 1                                                                
MANPRINT CSECT                                                                  
         NBASE 0,**MANP**,=V(REGSAVE),R9,R8                                     
         L     RA,=V(CPRINT)                                                    
         USING DPRINT,RA                                                        
         USING POOLFORM,R2                                                      
         SPACE 1                                                                
NEXTBOOK MVC   TITLE,SPACES                                                     
         MVC   COLHEADS,SPACES                                                  
         MVC   P,SPACES                                                         
         MVC   POOLLINE,=H'0'                                                   
         NI    FIRSTSW,X'0F'                                                    
         MVI   SUPERSW,X'20'       RESET FOR TITLE                              
         MVI   PHASE,0                                                          
         MVI   INCOPT,X'80'        HONOR ++INCLUDE'S                            
         MVI   SECTNUM,C' '                                                     
         MVC   REVDATE,SPACES                                                   
         MVC   CHOSEN(16),SPACES   INCLUDES MOST FLAGS                          
         MVI   XERTEXT,C' '                                                     
         ZAP   PAGE,=P'1'                                                       
         ZAP   FIGNO,=P'0'                                                      
         ZAP   LINE,=P'0'                                                       
         ZAP   PANSEQ,=P'0'                                                     
         MVI   MODE,X'08'                                                       
         SPACE 1                                                                
*                   READ RUN-DECK CONTROL CARD(S)                               
         SPACE 1                                                                
CARD     GOTO1 =V(CARDS),PARA,C,=C'RE00'                                        
         CLC   C(2),=C'/*'                                                      
         BNE   CARD1                                                            
         SPACE 1                                                                
ENDJOB   GOTO1 =V(PANIC),PARA,=C'CLOSE'                                         
         GOTO1 =V(PRINT),PARA,=C'CLOSE'                                         
         EOJ                                                                    
         SPACE 1                                                                
CARDERR  MVC   P(16),=C'** CARD REJECTED'                                       
         MVC   P+18(80),C                                                       
         GOTO1 =V(PRINTER)                                                      
         B     CARD                                                             
         TITLE 'OBLONG-PAGE MANUALS PRINTER FROM PANVALET'                      
CARD1    CLC   C(6),=C'LINES='                                                  
         BNE   CARD2                                                            
         NOP   CARD                                                             
LINESSW  EQU   *-3                                                              
         SPACE 1                                                                
         MVC   DUB(2),=C'00'       CHECK 2 NUMERICS                             
         MVZ   DUB(2),C+6                                                       
         CLC   DUB(2),=C'00'                                                    
         BNE   CARDERR                                                          
         PACK  DUB(2),C+6(2)                                                    
         CP    DUB(2),=P'50'                                                    
         BL    CARDERR                                                          
         CP    DUB(2),=P'64'                                                    
         BH    CARDERR                                                          
         ZAP   MAXLINE,DUB(2)                                                   
         MVI   LINESSW,X'F0'       LOCK THIS RUN TO NEW PAGE DEPTH              
         B     CARD                                                             
         SPACE 1                                                                
CARD2    CLC   C(4),=C'DDS='                                                    
         BE    CARD                                                             
         SPACE 1                                                                
         CLC   C(3),=C'UK='                                                     
         BE    CARD                                                             
         SPACE 1                                                                
         CLC   C(3),=C'US='                                                     
         BE    CARD                                                             
         SPACE 1                                                                
         CLC   C(5),=C'PROD='                                                   
         BNE   CARD7                                                            
         SPACE 1                                                                
         CLI   C+5,C'M'                                                         
         BNE   *+16                                                             
         MVI   CONTOPT,C'Y'                                                     
         MVI   PROD,C'Y'                                                        
         B     CARD                                                             
         SPACE 1                                                                
         CLI   C+5,C'N'                                                         
         BNE   *+16                                                             
         MVI   CONTOPT,C'N'                                                     
         MVI   PROD,C'N'                                                        
         B     CARD                                                             
         SPACE 1                                                                
         CLI   C+5,C'Y'                                                         
         BNE   CARDERR                                                          
         MVI   CONTOPT,C'N'                                                     
         MVI   PROD,C'Y'                                                        
         B     CARD                                                             
         EJECT                                                                  
CARD7    CLC   C(8),=C'CONTLIM='                                                
         BNE   CARD8                                                            
         SPACE 1                                                                
         MVC   CONTLIM,C+8                                                      
         B     CARD                                                             
         SPACE 1                                                                
CARD8    CLC   C(8),=C'FIGNAME='                                                
         BNE   CARD9                                                            
         SPACE 1                                                                
         CLC   C+8(8),SPACES                                                    
         BE    CARDERR                                                          
         MVC   FIGNAME(7),C+8                                                   
         LA    R1,FIGNAME+1                                                     
         LA    R2,FIGNAME-1                                                     
         NI    0(R1),X'BF'         UNCAP IT                                     
         CLI   1(R1),C' '                                                       
         BE    *+12                                                             
         LA    R1,1(R1)                                                         
         B     *-16                                                             
         SR    R1,R2                                                            
         STH   R1,LOFFIGNM                                                      
         B     CARD                                                             
         SPACE 1                                                                
CARD9    CLC   C(8),=C'BOOKEND='                                                
         BNE   CARD10                                                           
         SPACE 1                                                                
         CLC   C+8(10),SPACES                                                   
         BE    CARDERR                                                          
         MVC   ENDPGNAM,C+8                                                     
         B     CARD                                                             
         SPACE 1                                                                
CARD10   CLC   C(10),=C'LSTCLASS=U'                                             
         BE    CARD                IGNORE IT                                    
         SPACE 1                                                                
CARD11   CLC   C(6),=C'ISSUE='                                                  
         BNE   CARD12                                                           
         SPACE 1                                                                
         MVC   CHOSEN,C+6                                                       
         MVC   REVDATE,C+10                                                     
         B     CARD                                                             
         EJECT                                                                  
CARD12   CLC   C(9),=C'CHAPNAME='                                               
         BNE   BOOKTEST                                                         
         SPACE 1                                                                
         CLC   C+9(8),SPACES                                                    
         BE    CARDERR                                                          
         MVC   SECTNAME(7),C+9                                                  
         LA    R1,SECTNAME+1                                                    
         LA    R2,SECTNAME-1                                                    
         NI    0(R1),X'BF'         UNCAP IT                                     
         CLI   1(R1),C' '                                                       
         BE    *+12                                                             
         LA    R1,1(R1)                                                         
         B     *-16                                                             
         SR    R1,R2                                                            
         STH   R1,LOFCHPNM                                                      
         B     CARD                                                             
         SPACE 1                                                                
*                  LOOK FOR BOOKNAME IN DIRECTORY                               
         SPACE 1                                                                
BOOKTEST ZAP   PANSEQ,=P'0'                                                     
         GOTO1 =V(PANIC),PARA,=C'READ',=C'DIRECTORY',C,SAVEDIR                  
         TM    PARA+8,X'10'                                                     
         BZ    PRODTEST                                                         
         SPACE 1                                                                
*                   REPORT MISSING BOOK AT DIR. LEVEL                           
         SPACE 1                                                                
READ0    MVC   P(18),C                                                          
         MVC   P+20(20),=C'** BOOK NOT FOUND **'                                
         GOTO1 =V(PRINTER)                                                      
         B     NEXTBOOK                                                         
         EJECT                                                                  
*                   DO PROD=M, Y, OR N FOR THIS BOOK                            
         SPACE 1                                                                
PRODTEST DS    0H                                                               
*&&UK    START                                                                  
         TRT   C+10(10),INTERTRT                                                
         BZ    PRODTSTR                                                         
         SPACE 1                                                                
         MVI   ULCFLAG,C'Y'                                                     
         ZAP   NHLINES,=P'7'                                                    
*&&UK    END                                                                    
PRODTSTR CLI   CONTOPT,C'Y'        PROD=M                                       
         BE    READSTRT              YES                                        
         SPACE 1                                                                
         CLI   PROD,C'Y'           PROD=Y                                       
         BE    *+8                                                              
         SPACE 1                                                                
         MVI   INCOPT,X'00'        IGNORE ++INCLUDE'S                           
         SPACE 1                                                                
BOOKMSGO MVC   P(12),=C'-BOOK NAME: '                                           
         MVC   P+12(10),SAVEDIR                                                 
         MVC   P+22(7),=C' LEVEL '                                              
         MVC   P+29(3),SAVEDIR+10                                               
         MVC   P+32(7),=C' AS OF '                                              
         MVC   P+39(8),SAVEDIR+26                                               
         MVC   P+47(8),=C' RUN ON '                                             
         COMRG                                                                  
         MVC   P+55(8),0(R1)                                                    
         GOTO1 =V(PRINTER)                                                      
         OI    MODE,X'08'                                                       
         ZAP   LINE,=P'0'                                                       
         B     READSET                                                          
         EJECT                                                                  
*                   MANAGE PHASES FOR PROD=M REQUEST                            
         SPACE 1                                                                
READSTRT MVI   PHASE,1                                                          
         L     R1,=V(PRINT)        FIRST TIME THROUGH PATCH TO NOPRINT          
         MVC   BORROW,0(R1)                                                     
         MVC   0(2,R1),=X'07FE'                                                 
         B     READSET                                                          
         SPACE 1                                                                
ENDBOOK  NI    PARA+8,X'00'        RESET EOB RC                                 
         CLI   PHASE,1                                                          
         BL    NEXTBOOK            ONLY OR FINAL PASS                           
         BH    PRODEND             END OF 2ND PASS                              
         SPACE 1                                                                
         MVI   PHASE,2             START 2ND PASS                               
         L     R1,=V(PRINT)                                                     
         MVC   0(2,R1),BORROW                                                   
         NI    FIRSTSW,X'0F'                                                    
         MVC   TITLE,SPACES                                                     
         ZAP   PAGE,=P'1'                                                       
         ZAP   FIGNO,=P'0'                                                      
         MVC   COLHEADS,SPACES                                                  
         BAS   R6,LINEUP                                                        
         OI    MODE,1              SWITCH TO SMALL-ROMAN PG.NOS                 
         MVI   XERTEXT,C' '                                                     
         CLI   FRONT,C'Y'     IS THERE FRONT MATTER TO PRECEDE CONTENTS         
         BE    READ             YES - GET IT                                    
         BAS   RE,CONTENTS      NO                                              
         B     READ                                                             
         SPACE 1                                                                
PRODEND  BAS   RE,ANYIND           PRODUCE INDEX                                
         MVC   P(10),C                                                          
         GOTO1 =V(PRINTER)                                                      
         NI    FIRSTSW,X'0F'                                                    
         MVC   C(10),ENDPGNAM      READER COMMENTS, BACK COVER                  
         MVI   PHASE,0                                                          
         MVI   XERTEXT,C' '                                                     
         GOTO1 =V(PANIC),PARA                                                   
         TM    PARA+8,X'10'                                                     
         BO    READ0                                                            
         B     READ1ST                                                          
         SPACE 1                                                                
READSET  DS    0H                                                               
*&&US    START                                                                  
         MVI   ULCFLAG,C'Y'                                                     
         ZAP   NHLINES,=P'7'                                                    
*&&US    END                                                                    
         GOTO1 READ,PARA,(INCOPT,=C'READ'),=C'PAN',C,P                          
         EJECT                                                                  
*                   COMMON READ ROUTINE                                         
         SPACE 1                                                                
READ     CLI   SAVEFLAG,C'Y'                                                    
         BNE   READNEXT                                                         
         MVI   SAVEFLAG,C' '                                                    
         MVC   P(80),SAVEDIR                                                    
         B     READON                                                           
         SPACE 1                                                                
READNEXT GOTO1 =V(PANIC),PARA                                                   
READ1ST  TM    PARA+8,X'80'                                                     
         BO    ENDBOOK                                                          
         SPACE 1                                                                
*                   FIRST READ ONLY                                             
         SPACE 1                                                                
         NOP   READON                                                           
FIRSTSW  EQU   *-3                                                              
         OI    FIRSTSW,X'F0'                                                    
         CLC   P(19),=C'*          DATA SET'                                    
         BE    READ                                                             
         SPACE 1                                                                
*                  ALL PAN READS                                                
         SPACE 1                                                                
READON   AP    PANSEQ,=P'1'                                                     
         TR    P(80),TRTABLE                                                    
         CLC   P(6),=C'NOTXER'                                                  
         BNE   *+12                                                             
         MVI   XERTEXT,C' '                                                     
         B     READ                                                             
         SPACE 1                                                                
         CLC   P(7),=C'FILTER='                                                 
         BNE   TESTFILT                                                         
         CLC   P+7(3),=C'OFF'                                                   
         BNE   READFILT                                                         
         MVI   FILTER,C'N'                                                      
         B     READ                                                             
         SPACE 1                                                                
TESTFILT CLI   FILTER,C'Y'                                                      
         BE    READ                                                             
         B     TESTPAGE                                                         
         SPACE 1                                                                
READFILT CLC   P+7(3),=C'DDS='                                                  
         BNE   *+12                                                             
         MVI   FILTER,C'Y'                                                      
         B     READ                                                             
         SPACE 1                                                                
         CLC   P+7(2),=C'US='                                                   
         BNE   *+12                                                             
         MVI   FILTER,C'Y'                                                      
         B     READ                                                             
         SPACE 1                                                                
         CLC   P+7(2),=C'UK='                                                   
         BNE   PRINTOUT                                                         
         MVI   FILTER,C'Y'                                                      
         B     READ                                                             
         EJECT                                                                  
TESTPAGE CLI   P,X'2B'             FMT - START OF TAB RACK                      
         BNE   TESTWIDE              NO                                         
         BAS   R6,DOTABS                                                        
         B     READ                                                             
         SPACE 1                                                                
DOTABS   CLC   P+1(2),=C'00'       XERTOPAN NULL TABRACK                        
         BNE   *+10                                                             
         MVI   XERTEXT,C'P'                                                     
         BR    R6                                                               
         SPACE 1                                                                
         MVI   XERTEXT,C'Y'          YES                                        
         CLC   P+1(2),P+3                                                       
         BER   R6                                                               
         XC    TABRACK,TABRACK                                                  
         LA    R3,P+1                                                           
         LA    R4,TABRACK                                                       
         LA    R2,18               L(TABRACK) IN H'S                            
         SPACE 1                                                                
TABRKLP  CLI   0(R3),X'2B'         END OF TAB RACK                              
         BER   R6                                                               
         SPACE 1                                                                
CHARHEX  PACK  WORK(2),0(2,R3)                                                  
         LH    R1,WORK                                                          
         SRA   R1,4                                                             
         TM    1(R3),X'F0'         LOW-ORDER NUMERIC                            
         BO    *+8                   YES                                        
         AH    R1,=H'9'                                                         
         STH   R1,0(R4)                                                         
         LA    R4,2(R4)                                                         
         LA    R3,2(R3)                                                         
         BCT   R2,TABRKLP          MORE ROOM IN RACK                            
         BR    R6                                                               
         EJECT                                                                  
*                   WIDE-PAGE TESTING                                           
         SPACE 1                                                                
TESTWIDE CLC   P(5),=C'PAGE='                                                   
         BNE   TESTPGMD                                                         
         SPACE 1                                                                
         CLC   P+5(3),=C'END'                                                   
         BNE   *+16                                                             
         CLI   PAGEMODE,C'Y'       END BEFORE START                             
         BE    PAGEEND               NO                                         
         B     READ                                                             
         SPACE 1                                                                
         CLC   P+5(5),=C'START'                                                 
         BNE   PRINTOUT                                                         
         SPACE 1                                                                
         CLI   PAGEMODE,C'Y'       START BEFORE END                             
         BNE   PAGESTRT              NO                                         
         SPACE 1                                                                
         MVI   STARTFLG,C'Y'         YES - SET FLAG                             
         MVC   C+11(58),P+11               SAVE CAPTION                         
         B     PAGEEND                     END CURRENT WIDE PAGE                
         SPACE 1                                                                
TESTPGMD CLI   PAGEMODE,C'Y'                                                    
         BE    PAGELINE                                                         
         SPACE 1                                                                
*                   BIG= SERIES                                                 
         SPACE 1                                                                
         CLC   P(4),=C'BIG='                                                    
         BNE   NOTBIG                                                           
         SPACE 1                                                                
         CLI   PROD,C'Y'           LINE NUMBERS TO SHOW                         
         BNE   PRINTIT0              YES                                        
         SPACE 1                                                                
         BAS   RE,THINKBIG           NO                                         
         B     READ                                                             
         EJECT                                                                  
THINKBIG ST    RE,RETADDR                                                       
         CLC   BIGWORD,SPACES                                                   
         BNE   BIG1                                                             
         MVC   BIGWORD,P+4                                                      
         BAS   R7,FORCEODD    SKIP EVEN PAGE IF IT'S NEXT                       
         B     BIG2                                                             
         SPACE 1                                                                
BIG1     MVC   BIGWORD,P+4                                                      
         NI    MODE,1                                                           
BIG2     LA    R2,BIGWORD                                                       
         LA    R3,BIGWORK+81                                                    
         LA    R4,8                                                             
         CLC   BIGWORD,SPACES                                                   
         BE    BIG5                                                             
         LA    R5,BIGWORD+7                                                     
         SPACE 1                                                                
BIG3     CLI   0(R5),C' '                                                       
         BNE   BIG4                                                             
         LA    R3,5(R3)                                                         
         BCT   R5,BIG3                                                          
         SPACE 1                                                                
BIG4     GOTO1 =V(EXPAND),PARA1,(R2),(72,(R3))                                  
         LA    R2,1(R2)                                                         
         CLI   0(R2),C' '                                                       
         BE    BIG5                                                             
         LA    R3,10(R3)                                                        
         BCT   R4,BIG4                                                          
         SPACE 1                                                                
BIG5     LA    R2,BIGWORK-1        NOW PRINT AND CLEAR                          
         LA    R3,10                                                            
         MVI   SPACING+3,C'1'                                                   
         SPACE 1                                                                
BIG6     MVC   P(80),0(R2)                                                      
         GOTO1 =V(PRINTER)                                                      
         MVC   0(80,R2),SPACES                                                  
         LA    R2,80(R2)                                                        
         BCT   R3,BIG6                                                          
         SPACE 1                                                                
         OI    MODE,X'0A'                                                       
         L     RE,RETADDR                                                       
         BR    RE                                                               
         SPACE 1                                                                
BIGWORD  DC    CL8' '                                                           
         DS    C'  '                                                            
BIGWORK  DC    800C' '                                                          
         EJECT                                                                  
NOTBIG   MVC   BIGWORD,SPACES                                                   
         CLC   P(8),=C'REVERSE='                                                
         BE    READ                                                             
         SPACE 1                                                                
         CLC   P(8),=C'CHAPNUM='                                                
         BNE   SCAN                                                             
         SPACE 1                                                                
         CLI   PROD,C'N'           LINE NUMBERS TO SHOW                         
         BE    PRINTIT0              YES                                        
         SPACE 1                                                                
         TM    P+8,X'F0'           NUMERIC                                      
         BO    DOCHPNUM              YES                                        
         CLI   P+8,C'I'              NO  - A - H                                
         BNL   READ                          NO                                 
         SPACE 1                                                                
DOCHPNUM MVC   ALPHA,P+8                                                        
         BAS   R7,FORCEODD                                                      
         MVC   SECTNUM,ALPHA                                                    
         MVI   ALPHA,C' '                                                       
         ZAP   FIGNO,=P'0'                                                      
         ZAP   PAGE,=P'1'                                                       
         CLI   PHASE,2             PRINTING NOW                                 
         BNE   READ                  NO                                         
         SPACE 1                                                                
         CLC   CHOSEN,SPACES       SELECTIVE PRINTING                           
         BE    READ                  NO                                         
         SPACE 1                                                                
         L     R1,=V(PRINT)                                                     
         LA    R2,CHOSEN                                                        
         LA    R3,3                                                             
         SPACE 1                                                                
         CLC   0(1,R2),SECTNUM                                                  
         BE    NEWCHAP                                                          
         LA    R2,1(R2)                                                         
         BCT   R3,*-14                                                          
         MVC   0(2,R1),=X'07FE'    PREVENT PRINTING                             
         B     READ                                                             
         SPACE 1                                                                
NEWCHAP  MVC   0(2,R1),BORROW      START PRINTING                               
         B     READ                                                             
         EJECT                                                                  
SCAN     CLC   P(8),SPACES         POSSIBLE CC-10 CONTROL LINE                  
         BNE   NOTSCAN               NO                                         
         LA    R2,P+8                                                           
RESCAN   LA    R3,3                                                             
         CLI   0(R2),C' '                                                       
         BNE   *+16                                                             
         LA    R2,1(R2)                                                         
         BCT   R3,*-12                                                          
         B     BADSCAN                                                          
         SPACE 1                                                                
         MVC   SCANWORD(7),0(R2)                                                
         CLC   SCANWORD(6),=C'SPACE '                                           
         BE    SPACESLN                                                         
         SPACE 1                                                                
         CLC   SCANWORD(4),=C'HEAD'                                             
         BE    HEAD                                                             
         SPACE 1                                                                
         CLC   SCANWORD(7),=C'INDEX '''                                         
         BE    DOIXLINE                                                         
         SPACE 1                                                                
         CLC   SCANWORD(7),=C'FIGURE '                                          
         BE    FIGURE                                                           
         SPACE 1                                                                
         CLC   SCANWORD(6),=C'EJECT '                                           
         BE    EJECT                                                            
         SPACE 1                                                                
         CLC   SCANWORD(6),=C'ENDPG '                                           
         BNE   *+12                                                             
         LA    R2,9(R2)                                                         
         B     RESCAN                                                           
         SPACE 1                                                                
         CLC   SCANWORD(7),=C'TITLE '''                                         
         BE    TITLELN                                                          
         SPACE 1                                                                
         CLC   SCANWORD(7),=C'SUPER '''                                         
         BE    SUPER                                                            
         SPACE 1                                                                
         CLC   SCANWORD(6),=C'PRINT '                                           
         BE    READ                IGNORE PRINT S  D  T LINE                    
         SPACE 1                                                                
         CLC   SCANWORD(6),=C'FRONT='                                           
         BE    FRONTLN                                                          
         SPACE 1                                                                
BADSCAN  MVC   SCANWORD(7),SPACES                                               
         B     NOTSCAN                                                          
         EJECT                                                                  
EJECT    BAS   R6,ENDOLDPG                                                      
         B     READ                                                             
         SPACE 3                                                                
FRONTLN  CLI   SCANWORD+6,C'S'                                                  
         BNE   TRYEND                                                           
         SPACE 1                                                                
         CLI   PROD,C'N'           LINE NUMBERS TO SHOW                         
         BE    PRINTIT0              YES                                        
         SPACE 1                                                                
         MVI   FRONT,C'Y'                                                       
         OI    MODE,1              START SMALL-ROMAN                            
         B     READ                                                             
         SPACE 1                                                                
TRYEND   CLI   SCANWORD+6,C'E'                                                  
         BNE   PRINTOUT                                                         
         SPACE 1                                                                
         CLI   PROD,C'N'           LINE NUMBERS TO SHOW                         
         BE    PRINTIT0              YES                                        
         SPACE 1                                                                
         CLI   PHASE,1                                                          
         BH    ENDPHS2                                                          
         SPACE 1                                                                
         BAS   R7,FORCEODD                                                      
         ZAP   FIGNO,=P'0'                                                      
         ZAP   PAGE,=P'1'                                                       
         NI    MODE,X'FE'          END SMALL-ROMAN                              
         B     READ                                                             
         SPACE 1                                                                
ENDPHS2  BAS   RE,CONTENTS                                                      
         B     READ                                                             
         SPACE 3                                                                
SPACESLN CLI   SCANWORD+6,C'1'                                                  
         BL    READ                                                             
         CLI   SCANWORD+6,C'9'                                                  
         BH    READ                                                             
         MVC   P(30),SPACES                                                     
         MVC   SPACING+3(1),SCANWORD+6                                          
         GOTO1 =V(PRINTER)                                                      
         MVI   SPACING+3,C'1'                                                   
         B     READ                                                             
        EJECT                                                                   
FIGURE   CLI   7(R2),X'7D'         APOSTROPHE AFTER FIGURE                      
         BNE   BADSCAN               NO                                         
         BAS   RE,SCANFIG            YES                                        
         CLI   ALPHA,C'F'          FIGURE FIRST ON PAGE                         
         BE    FIGPHASE              YES                                        
         MVI   SPACING+3,C'2'                                                   
         GOTO1 =V(PRINTER)                                                      
         SPACE 1                                                                
FIGPHASE CLI   PHASE,1                                                          
         BE    FIGOUT                                                           
         SPACE 1                                                                
         MVC   SAVEDIR,SPACES                                                   
         MVC   SAVEDIR(7),FIGNAME                                               
         LA    R1,SAVEDIR+1        FOR TRAILING SPACE                           
         AH    R1,LOFFIGNM                                                      
         CLI   SECTNUM,C' '        PGNO. PREFIX                                 
         BE    SETFIGNO              NO                                         
         SPACE 1                                                                
         MVI   DASHFLAG,C'Y'                                                    
         BAS   RE,DOSUPNUM                                                      
         SPACE 1                                                                
SETFIGNO EDIT  (P2,FIGNO),(3,(R1)),ALIGN=LEFT                                   
         LA    R1,1(R1)                                                         
         CLI   0(R1),C' '          FIND END OF FIGNO                            
         BNE   *-8                   NO                                         
         MVI   0(R1),C'.'            YES                                        
         MVC   3(60,R1),INDEX                                                   
         LA    R1,SAVEDIR+79                                                    
         BAS   R7,CENTERER                                                      
         SPACE 1                                                                
FIGOUT   CLI   ALPHA,C'L'          FIGURE AT PAGE BOTTOM                        
         BNE   *+12                  NO                                         
         MVI   SPACING+3,C'1'        YES                                        
         B     *+8                                                              
         MVI   SPACING+3,C'3'                                                   
         SPACE 1                                                                
         GOTO1 =V(PRINTER)                                                      
         CLI   ALPHA,C'L'          LAST ON PAGE                                 
         BNE   *+8                   NO                                         
         BAS   R6,ENDOLDPG           YES - FORCE END                            
         MVI   ALPHA,C' '                                                       
         B     READ                                                             
         EJECT                                                                  
TITLELN  BAS   RE,SCANTITL         SET TITLE                                    
         B     READ                                                             
         SPACE 3                                                                
SUPER    BAS   RE,SCANSUP          TEST AND SET SUPER                           
         CLI   SECTNUM,C' '        IS CHAPNUM GIVEN                             
         BE    DEMOTE                NO                                         
         SPACE 1                                                                
         CLI   PHASE,1                                                          
         BE    SUPSPACE            DO SPACING ONLY                              
         SPACE 1                                                                
         MVC   SAVEDIR,SPACES                                                   
         MVC   SAVEDIR(8),SECTNAME                                              
         LA    R1,SAVEDIR+1                                                     
         AH    R1,LOFCHPNM                                                      
         BAS   RE,DOSUPNUM                                                      
         BAS   R7,CENTERER                                                      
         EX    R1,UPITALL          CAP THE CENTERED TEXT                        
         OI    MODE,X'80'          1ST SUPER ON 1ST LINE OF PAGE                
         GOTO1 =V(PRINTER)                                                      
         MVC   SAVEDIR(60),INDEX                                                
         LA    R1,SAVEDIR+59                                                    
         BAS   R7,CENTERER                                                      
         EX    R1,UPITALL          CAP THE CENTERED TEXT                        
         OI    MODE,X'40'                                                       
         GOTO1 =V(PRINTER)                                                      
         MVI   SPACING+3,C'2'                                                   
         GOTO1 =V(PRINTER)                                                      
         SPACE 1                                                                
SUPSPACE ZAP   LINE,=P'10'                                                      
         CLI   ULCFLAG,C'Y'                                                     
         BE    TITLESET                                                         
         CLI   PROD,C'N'                                                        
         BNE   TITLESET                                                         
         AP    LINE,=P'2'                                                       
         B     TITLESET                                                         
         SPACE 1                                                                
DEMOTE   MVC   LOFTITLE,=H'0'      DEMOTE SUPER TO NEW TITLE                    
TITLESET MVC   TITLE,INDEX         SET SUPER TEXT FOR TITLE USAGE               
         B     READ                                                             
         SPACE 1                                                                
UPITALL  OC    0(0,R2),SPACES                                                   
         EJECT                                                                  
*              CENTERER FOR SUPER OR FIGURE                                     
         SPACE 1                                                                
CENTERER LA    R0,76               LINE WIDTH                                   
         LA    R2,P                PRINT LINE START                             
CENTLP   CLI   0(R1),C' '                                                       
         BNE   *+8                 RIGHT END FOUND                              
         BCT   R1,CENTLP                                                        
         LA    R3,SAVEDIR-1                                                     
         SR    R1,R3               LENGTH OF LINE TO CENTER                     
         SR    R0,R1               SPACES TO SPLIT EVENLY                       
         SRA   R0,1                DIVIDE BY 2                                  
         AR    R2,R0               SET START ON LINE                            
         EX    R1,CENTMOVE                                                      
         BR    R7                                                               
         SPACE 1                                                                
CENTMOVE MVC   0(0,R2),SAVEDIR                                                  
         SPACE 3                                                                
DOIXLINE BAS   RE,SCANINDX         SET INDEX ENTRY                              
         CLI   PROD,C'N'           LINE NUMBERS TO SHOW                         
         BNE   READ                  NO                                         
         MVC   P+9(7),SCANWORD       YES                                        
         MVC   P+16(60),INDEX                                                   
         LA    R2,P+17                                                          
         AR    R2,R4               POSITION TRAILING APOSTROPHE                 
         MVI   0(R2),X'7D'                                                      
         SP    LINE,=P'1'                                                       
         B     PRINTIT0                                                         
         SPACE 3                                                                
HEAD     TM    SCANWORD+4,X'F0'    IS LEVEL NUMERIC                             
         BNO   BADSCAN               NO                                         
         BAS   RE,SCANHEAD           YES - SET HEAD                             
         CLI   ALPHA,C'F'          FIRST LINE ON PAGE                           
         BNE   *+12                                                             
         OI    MODE,X'80'            MAKE HEAD 1ST LINE                         
         B     *+8                                                              
         OI    MODE,X'40'          PUT HEAD WITHIN PAGE BODY                    
         SR    R6,R6                                                            
         NI    SCANWORD+4,X'0F'    LEVEL NUMBER                                 
         IC    R6,SCANWORD+4                                                    
         SLA   R6,1                                                             
         LA    R3,P(R6)                                                         
         MVC   0(60,R3),INDEX                                                   
         GOTO1 =V(PRINTER)                                                      
         MVI   ALPHA,C' '                                                       
         B     READ                                                             
         EJECT                                                                  
SCANINDX ST    RE,RETADDR          INDEX ENTRY                                  
         B     SCAN3                                                            
         SPACE 3                                                                
SCANSUP  ST    RE,RETADDR          SUPER                                        
         BAS   R6,ENDOLDPG                                                      
         MVC   TITLE,SPACES                                                     
         MVC   COLHEADS,SPACES                                                  
         MVI   SUPERSW,X'10'                                                    
         B     SCAN3               SAVE TEXT IN INDEX                           
         SPACE 3                                                                
SCANFIG  ST    RE,RETADDR          FIGURE CAPTION                               
         LA    R2,1(R2)            GET PAST LEADING '                           
         MVI   FIGSTODO,C'Y'                                                    
         MVC   COLHEADS,SPACES                                                  
         AP    FIGNO,=P'1'                                                      
         ZAP   ROOM,=P'7'                                                       
         BAS   R6,TESTROOM         ROOM FOR FIGURE ON THIS PAGE                 
         CP    WORK(2),=P'3'         NO  - TEST FOR END-OF-PAGE FIT             
         MVI   ALPHA,C'L'                                                       
         BNL   SCAN3                         YES                                
         B     SCAN2A                        NO                                 
         SPACE 3                                                                
SCANHEAD ST    RE,RETADDR          PARAGRAPH HEAD                               
         MVC   COLHEADS,SPACES                                                  
         TM    MODE,X'08'          PAGE START PENDING                           
         BO    SCAN2A                YES - SKIP TEST FOR SPACE                  
         SPACE 1                                                                
         ZAP   ROOM,NHLINES                                                     
         LA    R6,SCAN2A           ROOM FOR HEAD ON THIS PAGE                   
TESTROOM ZAP   WORK(2),MAXLINE                                                  
         SP    WORK(2),LINE                                                     
         CP    WORK(2),ROOM                                                     
         BNL   SCAN3                 YES                                        
         BR    R6                                                               
         SPACE 1                                                                
SCAN2A   MVI   ALPHA,C'F'            NO                                         
         BAS   R6,ENDOLDPG         START NEW PAGE                               
         SPACE 1                                                                
SCAN3    MVC   INDEX,SPACES                                                     
         LA    R3,INDEX                                                         
         B     SCAN5                                                            
         EJECT                                                                  
SCANTITL ST    RE,RETADDR          TITLE                                        
         BAS   R6,ENDOLDPG                                                      
         MVC   TITLE,SPACES                                                     
         MVC   LOFTITLE,=H'0'                                                   
         MVC   COLHEADS,SPACES                                                  
         LA    R3,TITLE                                                         
         SPACE 1                                                                
SCAN5    LA    R2,7(R2)            SET MOVE START                               
         LA    R4,60(R2)           SET END-SEARCH START                         
         LA    R5,60               SET SEARCH LIMIT                             
SCANLP   CLI   0(R4),C' '          1ST NON-BLANK TRAILER                        
         BNE   SCAN6                 YES                                        
         BCTR  R4,0                                                             
         BCT   R5,SCANLP                                                        
         B     BADSCAN             NO TEXT FOUND                                
         SPACE 1                                                                
SCAN6    CLI   0(R4),X'7D'         APOSTROPHE                                   
         BE    *+8                   YES                                        
         LA    R4,1(R4)              NO  - INCLUDE IT                           
         SR    R4,R2                                                            
         BNP   BADSCAN                                                          
         CLC   SCANWORD,=C'SUPER '''                                            
         BNE   *+8                                                              
         STH   R4,LOFTITLE                                                      
         BCTR  R4,0                                                             
         EX    R4,SCANMOVE                                                      
         MVC   P,SPACES                                                         
         CLI   PHASE,1                                                          
         BNE   SCANXIT                                                          
         SPACE 1                                                                
         TM    MODE,1              FRONT MATTER                                 
         BO    SCANXIT               YES                                        
         SPACE 1                                                                
         BAS   R1,DOPOOLLN                                                      
         SPACE 1                                                                
SCANXIT  L     RE,RETADDR                                                       
         BR    RE                                                               
         SPACE 1                                                                
SCANMOVE MVC   0(0,R3),0(R2)                                                    
         SPACE 1                                                                
RETADDR  DS    F                   RETURN ADDRESS                               
         DS    CL1                                                              
ROOM     DS    PL1                                                              
         EJECT                                                                  
*                        PUT ENTRY INTO TITLPOOL                                
         SPACE 2                                                                
DOPOOLLN LH    R3,POOLLINE         LAST POOL LINE NUMBER                        
         CH    R3,POOLSIZE         LOWER THAN POOL DEPTH                        
         BNL   POOLFULL              NO - DO ERROR ROUTINE                      
         SPACE 1                                                                
         LA    R5,96                 YES - PROCEED                              
         MR    R4,R3               SET OFFSET FROM A(TITLPOOL)                  
         LA    R3,1(R3)            INCREMENT POOLLINE                           
         STH   R3,POOLLINE         SAVE IT                                      
         L     R2,=A(TITLPOOL)                                                  
         AR    R2,R5               POINT R2 TO NEXT POOL LINE                   
         XC    0(96,R2),0(R2)      CLEAR IT                                     
         CLC   SCANWORD,=C'TITLE '''                                            
         BNE   *+12                                                             
         LA    R5,TITLE                                                         
         B     *+8                                                              
         LA    R5,INDEX                                                         
         MVC   PLTEXT,0(R5)                                                     
         MVC   SRTTXT,0(R2)        MOVE IN SORT-KEY TEXT                        
         OC    SRTTXT,SPACES       MAKE TEXT ALL-CAPS                           
         MVC   PLCHPT,SECTNUM      PG. NO. PREFIX, IF PRESENT                   
         MVC   PLPGNO,PAGE         PG. NO.                                      
         CLC   SCANWORD(7),=C'FIGURE '                                          
         BE    *+14                                                             
         CLC   SCANWORD(7),SPACES                                               
         BNE   OTHERLN             NOT CAPTION FROM WIDE-LINE PAGE              
         OI    PLTYPE,X'40'          YES - MARK CAPTION                         
         MVC   CAPNUM,FIGNO                                                     
         BR    R1                          GET OUT                              
         SPACE 1                                                                
OTHERLN  CLC   SCANWORD,=C'TITLE '''                                            
         BNE   *+10                  NO                                         
         OI    PLTYPE,X'20'          YES - MARK IT                              
         BR    R1                          GET OUT                              
         SPACE 1                                                                
         CLC   SCANWORD,=C'SUPER '''                                            
         BNE   *+10                  NO                                         
         OI    PLTYPE,X'10'                                                     
         BR    R1                          GET OUT                              
         SPACE 1                                                                
         CLC   SCANWORD(4),=C'HEAD'                                             
         BNE   IXMARK                                                           
         CLC   SCANWORD+4(1),CONTLIM    HEADN INTO CONTENTS                     
         BH    IXMARK                    NO                                     
         MVN   PLTYPE,SCANWORD+4         YES - SAVE LEVEL NO.                   
         BR    R1                               RETURN                          
         SPACE 1                                                                
IXMARK   OI    PLTYPE,X'80'                                                     
         BR    R1                                                               
         EJECT                                                                  
*                   COLUMN HEADINGS LINE                                        
         SPACE 1                                                                
NOTSCAN  CLC   P(2),=X'6E6E'       TWO GREATER-THAN'S                           
         BNE   TRYFORM               NO                                         
         SPACE 1                                                                
         CLC   P+2(78),SPACES      NULL LINE                                    
         BNE   *+14                  NO                                         
         MVC   COLHEADS,SPACES       YES                                        
         B     READ                                                             
         SPACE 1                                                                
         CLI   XERTEXT,C'Y'                                                     
         BNE   *+16                                                             
         LA    R4,P                                                             
         LA    R7,79                                                            
         BAS   RE,TRYTABRT                                                      
         MVC   COLHEADS(78),P+2    PUT TEXT INTO COLHEADS                       
         OI    MODE,X'10'          SET NEW COLHEADS BIT                         
         GOTO1 =V(PRINTER)                                                      
         B     READ                                                             
         SPACE 1                                                                
TRYFORM  CLI   XERTEXT,C'Y'                                                     
         BE    XERLINE                                                          
         EJECT                                                                  
*                   U'SCORE FOR ORDINARY-PAGE TEXT LINE                         
         SPACE 1                                                                
NOTXERLN TRT   P(80),USCORE        USCORE CHAR                                  
         BZ    SCREENLN              NO                                         
         SPACE 1                                                                
         TRT   P(80),SEPUSC                                                     
         BNZ   SCREENLN                                                         
         SPACE 1                                                                
         CLI   ULCFLAG,C'Y'        PRINTABLE                                    
         BNE   READ                  NO                                         
         SPACE 1                                                                
         CLI   PHASE,1             PRINTING NOW                                 
         BE    READ                  NO                                         
         SPACE 1                                                                
         MVI   SPACING+3,C'0'                                                   
         GOTO1 =V(PRINTER)                                                      
         B     READ                                                             
         SPACE 1                                                                
*                   TRT TABLE FOR U'SCORE TEST                                  
         SPACE 1                                                                
         DS    0D                                                               
USCORE   DS    0CL256                                                           
         DC    109X'00'                                                         
         DC    X'FF'               USCORE X'6D'                                 
         DC    146X'00'                                                         
         SPACE 1                                                                
SEPUSC   DS    0CL256                                                           
         DC    64X'01'                                                          
         DC    X'00'          40                                                
         DC    44X'01'                                                          
         DC    X'00'          6D                                                
         DC    146X'01'                                                         
         EJECT                                                                  
XERLINE  CLI   PROD,C'Y'           LINE NUMBERED                                
         BNE   PRINTIT0              YES                                        
         SPACE 1                                                                
         TRT   P(80),LINEEND                                                    
         BNZ   WHOLELIN                                                         
         SPACE 1                                                                
         LA    R4,SAVEDIR                                                       
         ST    R4,PARA+12                                                       
         GOTO1 =V(PANIC),PARA      GET REST OF LINE                             
         TM    PARA+8,X'80'                                                     
         BO    ENDBOOK                                                          
         SPACE 1                                                                
         LA    R4,P                                                             
         ST    R4,PARA+12                                                       
         TRT   SAVEDIR(10),LINEEND                                              
         BNZ   XERLINE1                                                         
         MVI   SAVEFLAG,C'Y'                                                    
         MVI   XERTEXT,C' '        NOT XER                                      
         B     NOTXERLN                                                         
XERLINE1 LA    R4,SAVEDIR                                                       
         MVC   P+80(10),SAVEDIR                                                 
         LA    R1,0(R1)                                                         
         SR    R1,R4                                                            
         EX    R1,SHY                                                           
         LA    R1,P+80(R1)                                                      
         SPACE 1                                                                
WHOLELIN CLI   PHASE,1             PRINTING NOW                                 
         BE    PRINTIT               NO - SKIP FORMATTING                       
         SPACE 1                                                                
         MVI   0(R1),C' '          BLANK LINE-END CHAR                          
         LA    R7,0(R1)                                                         
         LA    R4,P                                                             
         SR    R7,R4                                                            
         BNP   READ                                                             
         BCTR  R7,0                                                             
         BAS   RE,TRYTABRT                                                      
         B     SCREENLN                                                         
         SPACE 1                                                                
SHY      TR    P+80(0),TRTABLE                                                  
         SPACE 1                                                                
TABTEST  TRT   0(0,R4),TABCHECK                                                 
         SPACE 1                                                                
TABOUT   MVC   REBUILD(0),1(R1)    EXCLUDE TAB FROM SAVE                        
         SPACE 1                                                                
SPACEIN  MVC   0(0,R1),SPACES      BLANK TAB AND ONWARD                         
         SPACE 1                                                                
TABBACK  MVC   0(0,R1),REBUILD                                                  
         EJECT                                                                  
*                  LOOK FOR TABS USCORES IN XERSTORE'D TEXT                     
         SPACE 1                                                                
TRYTABRT NTR1                                                                   
         SR    R1,R1                                                            
         ST    R4,LINESTRT                                                      
         MVC   USCOFFST,=H'0'                                                   
         SPACE 1                                                                
OTHERTAB EX    R7,TABTEST                                                       
         BZ    NOTABS                                                           
         SPACE 1                                                                
         BCTR  R4,0                                                             
         LR    R5,R1                                                            
         SR    R5,R4               TAB DISP + 1                                 
         SH    R5,USCOFFST                                                      
         ST    R1,SAVEREGS                                                      
         LR    R6,R1                                                            
         SH    R6,=H'4'                                                         
         CR    R6,R4                                                            
         BNH   TABLOOP0                                                         
         TRT   0(4,R6),USCORES                                                  
         BZ    TABLOOP0                                                         
         SPACE 1                                                                
         L     R1,SAVEREGS                                                      
         LH    R4,USCOFFST                                                      
         AH    R4,=H'2'                                                         
         STH   R4,USCOFFST                                                      
         SH    R5,=H'2'                                                         
         SPACE 1                                                                
TABLOOP0 LA    R6,TABRACK                                                       
         LA    R3,18                                                            
         L     R4,LINESTRT         RESET R4 FOR TRT AT TABERROR.                
TABLOOP1 CLC   0(2,R6),=H'0'                                                    
         BE    TABERROR                                                         
         CH    R5,0(R6)                                                         
         BL    TABMOVE             NEXT TAB FOUND                               
         LA    R6,2(R6)              NO - SET FOR NEXT TRY                      
         BCT   R3,TABLOOP1                                                      
         B     TABERROR                                                         
         SPACE 1                                                                
TABMOVE  L     R2,LINESTRT                                                      
         LA    R2,0(R7,R2)         PTR TO LAST TEXT CHAR                        
         SR    R2,R1               L'TEXT' AFTER TAB - 1                        
         EX    R2,TABOUT           SAVE WHAT'S AFTER TAB                        
         LA    R2,1(R2)                                                         
         EX    R2,SPACEIN          BLANK TAB AND ONWARD                         
         BCTR  R2,0                                                             
         L     R1,LINESTRT                                                      
         BCTR  R1,0                                                             
         AH    R1,0(R6)                                                         
         AH    R1,USCOFFST                                                      
         EX    R2,TABBACK          RESTORE FROM SAVE                            
         LA    R7,0(R1,R2)                                                      
         L     R4,LINESTRT                                                      
         SR    R7,R4                                                            
         B     OTHERTAB                                                         
         EJECT                                                                  
TABERROR MVI   0(R1),C' '                                                       
         EX    R7,TABTEST                                                       
         BNZ   *-8                                                              
         SPACE 1                                                                
NOTABS   L     R3,LINESTRT                                                      
         SR    R1,R1                                                            
         EX    R7,TRTREST          ANY USCORES                                  
         BZ    TABUSCEX                                                         
         SPACE 1                                                                
         EX    R7,SAVETEXT                                                      
         STC   R7,LINELEN                                                       
         MVC   P,SPACES                                                         
         SR    R1,R3               DISP TO SUSC IN TEXT LINE                    
         LA    R3,USCORSAV+1(R1)   PTR PAST SUSC IN USCORSAV                    
         LA    R5,P(R1)            PTR TO SUSC LOC IN PRINT LINE                
         CLI   PAGEMODE,C'Y'                                                    
         BNE   *+16                                                             
         CLI   PROD,C'Y'                                                        
         BNE   *+8                                                              
         LA    R5,2(R5)                                                         
         SR    R7,R1               REDUCE SEARCH LENGTH                         
         B     USCORELP                                                         
         SPACE 1                                                                
TRTREST  TRT   0(0,R3),USCORES                                                  
         SPACE 1                                                                
SAVETEXT MVC   USCORSAV(0),0(R3)                                                
         SPACE 1                                                                
USCORELP EX    R7,TRTREST          LOOK FOR EUSC                                
         SPACE 1                                                                
         LR    R6,R1                                                            
         BCTR  R6,0                                                             
         SR    R6,R3                                                            
         EX    R6,USAVE1                                                        
         LA    R2,REBUILD+1(R6)                                                 
         LA    R4,0(R7)                                                         
         SR    R4,R6                                                            
         BM    DOUSTORE                                                         
         EX    R4,USAVE2                                                        
         LA    R4,1(R4)                                                         
         EX    R4,SPACEIN                                                       
DOUSTORE BCTR  R7,0                                                             
         BCTR  R3,0                TO SUSC                                      
         EX    R7,USTORE                                                        
         ZIC   R7,LINELEN                                                       
         SH    R7,=H'2'                                                         
         STC   R7,LINELEN                                                       
         EJECT                                                                  
         MVI   0(R5),X'6D'         USCORE CHAR                                  
         LA    R4,0(R6)                                                         
         BCTR  R4,0                                                             
         LTR   R4,R4                                                            
         BM    MOREUSC                                                          
         EX    R4,UEXTEND                                                       
         SPACE 1                                                                
MOREUSC  LA    R3,1(R6,R3)                                                      
         LA    R5,1(R6,R5)         PTR PAST USCORES IN PRINT LINE               
         LA    R7,USCORSAV(R7)                                                  
         SR    R7,R3                                                            
         BNP   EUSCORE                                                          
         SPACE 1                                                                
         EX    R7,TRTREST                                                       
         BZ    EUSCORE                                                          
         SR    R1,R3               DISP TO SUSC                                 
         LA    R3,1(R1,R3)         POINT PAST IT                                
         SR    R7,R1               LENGTH FOR EUSC SEARCH                       
         LA    R5,0(R1,R5)         PTR IN PRINT LINE                            
         B     USCORELP                                                         
         SPACE 1                                                                
EUSCORE  CLI   ULCFLAG,C'Y'                                                     
         BNE   EUSCOREX                                                         
         SPACE 1                                                                
         CLI   PAGEMODE,C'Y'                                                    
         BNE   USCNORM                                                          
         GOTO1 =V(PRINT),PARA2,P-1,=C'BL00'                                     
         B     EUSCOREX                                                         
         SPACE 1                                                                
USCNORM  MVI   SPACING+3,C'0'                                                   
         GOTO1 =V(PRINTER)                                                      
         MVI   SPACING+3,C'1'                                                   
         SPACE 1                                                                
EUSCOREX L     R1,LINESTRT                                                      
         MVC   0(132,R1),SPACES                                                 
         ZIC   R7,LINELEN                                                       
         EX    R7,RETNTEXT                                                      
TABUSCEX XIT1                                                                   
         SPACE 1                                                                
RETNTEXT MVC   0(0,R1),USCORSAV                                                 
         SPACE 1                                                                
UEXTEND  MVC   1(0,R5),0(R5)                                                    
         SPACE 1                                                                
USAVE1   MVC   REBUILD(0),0(R3)                                                 
         SPACE 1                                                                
USAVE2   MVC   0(0,R2),1(R1)                                                    
         SPACE 1                                                                
USTORE   MVC   0(0,R3),REBUILD                                                  
         EJECT                                                                  
*                   SCREEN FIELD FORMATTING                                     
         SPACE 1                                                                
SCREENLN CLI   ULCFLAG,C'Y'        U/LC PRINTING                                
         BNE   PRINTOUT              NO - SKIP FORMATTING                       
         SPACE 1                                                                
         CLI   PHASE,1             PRINTING NOW                                 
         BE    PRINTOUT              NO - SKIP FORMATTING                       
         SPACE 1                                                                
         LA    R1,P                                                             
         LA    R2,P+79                                                          
         LA    R3,10               LIMIT FOR 1ST *                              
         SPACE 1                                                                
         CLI   0(R1),C'*'                                                       
         BE    TWOSTARS                                                         
         LA    R1,1(R1)                                                         
         BCT   R3,*-12                                                          
         B     PRINTOUT            NO STARTING *                                
         SPACE 1                                                                
TWOSTARS CLI   1(R1),C'*'          SECOND *                                     
         BE    PRINTOUT              YES - NOT SCREEN LINE                      
         SPACE 1                                                                
         LA    R3,10               LIMIT FOR LAST *                             
         CLI   0(R2),C'*'            NO  - FIND END *                           
         BE    FIELDER                                                          
         BCTR  R2,0                                                             
         BCT   R3,*-10             TRY AGAIN                                    
         B     PRINTOUT              NO * IN LAST 10 COLUMNS                    
         SPACE 1                                                                
FIELDER  LA    R1,1(R1)                                                         
         CR    R1,R2                                                            
         BNL   PRINTOUT                                                         
         CLI   0(R1),X'7A'         START OF FIELD                               
         BNE   FIELDER                                                          
         CLI   1(R1),C'-'                                                       
         BNE   FIELDER                                                          
         OI    1(R1),X'0D'                                                      
         LA    R1,1(R1)                                                         
         B     *-16                                                             
         SPACE 3                                                                
PRINTOUT CLI   PROD,C'Y'                                                        
         BE    PRINTIT                                                          
         SPACE 1                                                                
PRINTIT0 UNPK  P+81(5),PANSEQ                                                   
         OI    P+85,X'F0'                                                       
         SPACE 1                                                                
PRINTIT  MVI   SPACING+3,C'1'                                                   
         CLC   P(2),=C'*-'                                                      
         BNE   *+8                                                              
         MVI   P,C'-'                                                           
         GOTO1 =V(PRINTER)                                                      
         B     READ                                                             
         EJECT                                                                  
*              ISSUE 'CONTENTS' AND 'FIGURES' IF PRESENT                        
         SPACE 1                                                                
CONTENTS ST    RE,RETADDR                                                       
         BAS   R7,FORCEODD                                                      
         CLC   POOLLINE,=H'0'      TITLPOOL ENTRIES                             
         BE    CLOSEOUT              NO                                         
         SPACE 1                                                                
         MVC   TITLE(8),=X'C39695A38595A3A2'  CONTENTS U/LC                     
         CLI   SECTNUM,C' '                                                     
         BE    *+10                                                             
         MVC   COLHEADS(8),SECTNAME                                             
         MVC   COLHEADS+15(5),=X'E389A39385'  TITLE U/LC                        
         MVC   COLHEADS+68(4),=X'D7818785'    PAGE  U/LC                        
         OI    MODE,X'10'          NEW COLHEADS                                 
         GOTO1 =V(PRINTER)                                                      
         L     R2,=A(TITLPOOL)                                                  
         LH    R3,POOLLINE                                                      
         SPACE 1                                                                
CONT2    TM    PLTYPE,X'C0'        FIGURE OR INDEX ONLY?                        
         BM    MORECONT              YES                                        
         SPACE 1                                                                
         TM    PLTYPE,X'30'        TITLE OR SUPER                               
         BZ    CONT3                 NO                                         
         SPACE 1                                                                
         ZAP   WORK(2),MAXLINE                                                  
         SP    WORK(2),LINE                                                     
         CP    WORK(2),=P'5'       ROOM FOR IT, SKIPS, AND 2 ENTRIES            
         BNL   CONT2SK               YES - GO SKIP A LINE                       
         BAS   R6,ENDOLDPG           NO - SWITCH TO NEXT PAGE                   
         B     SUPERSW-1                                                        
         SPACE 1                                                                
CONT2SK  GOTO1 =V(PRINTER)                                                      
         SPACE 1                                                                
         TM    PLTYPE,X'20'        TITLE OR SUPER IF MASK IS X'10'              
SUPERSW  EQU   *-3                                                              
         BZ    SKIPLNE                                                          
         SPACE 1                                                                
         CLI   PLCHPT,C' '         CHAPTER NUMBER                               
         BE    SKIPLNE               NO                                         
         LA    R1,P+2                YES                                        
         BAS   RE,TPSECNO          SET IT LEFT-ADJUSTED                         
         SPACE 1                                                                
SKIPLNE  LA    R1,P+5                                                           
         MVI   SPACING+3,C'2'                                                   
         MVI   ALPHA,C'C'          CAP FLAG                                     
         B     CONT4                                                            
         EJECT                                                                  
CONT3    SR    R6,R6               INDENT HEADN LINE TEXT                       
         IC    R6,PLTYPE                                                        
         SLA   R6,1(0)                                                          
         LA    R1,P+5(R6)                                                       
         SPACE 1                                                                
CONT4    MVC   0(60,R1),0(R2)                                                   
         CLI   ALPHA,C'C'                                                       
         BNE   *+14                                                             
         MVI   ALPHA,C' '                                                       
         OC    0(60,R1),SPACES     CAP THE SUPER OR TITLE                       
         BAS   R7,CONTNTLN         ISSUE CONTENTS LINE                          
         SPACE 1                                                                
MORECONT LA    R2,96(R2)                                                        
         BCT   R3,CONT2                                                         
         B     FIGURES                                                          
         SPACE 1                                                                
*              FORMAT CONTENTS OR FIGURES LINE                                  
         SPACE 1                                                                
CONTNTLN LA    R1,P+63             FILLUP PREP                                  
         LA    R0,30                                                            
         LA    R4,2                                                             
         SPACE 1                                                                
FILLUP   CLC   0(2,R1),=C'  '                                                   
         BNE   PGNUMBER                                                         
         MVC   0(2,R1),=C' .'                                                   
         SR    R1,R4                                                            
         BCT   R0,FILLUP                                                        
         SPACE 1                                                                
PGNUMBER EDIT  (P2,PLPGNO),(3,P+69)                                             
         CLI   PLCHPT,C' '         SECTIONAL PAGE NUMBERING                     
         BE    PUTLINE               NO                                         
         SPACE 1                                                                
         LA    R1,P+69                                                          
         CLI   1(R1),C' '                                                       
         BE    *+8                                                              
         BCT   R1,*-8                                                           
         MVI   DASHFLAG,C'Y'                                                    
         BAS   RE,TPSECNO          SET CHAP NUM LEFT ADJUSTED                   
         SPACE 1                                                                
PUTLINE  GOTO1 =V(PRINTER)                                                      
         MVI   SPACING+3,C'1'                                                   
         BR    R7                                                               
         EJECT                                                                  
FIGURES  CLI   FIGSTODO,C'Y'       CAPTIONS                                     
         BNE   ANYIND6               NO                                         
         SPACE 1                                                                
         OI    MODE,X'0A'          CLOSE OUT CONTENTS                           
         GOTO1 =V(PRINTER)                                                      
         MVC   TITLE(8),FIGNAME                                                 
         MVC   LOFTITLE,=H'0'                                                   
         MVC   COLHEADS(8),TITLE                                                
         OI    MODE,X'10'          NEW COLHEADS                                 
         LA    R1,TITLE                                                         
         AH    R1,LOFFIGNM                                                      
         MVI   0(R1),X'A2'                                                      
         GOTO1 =V(PRINTER)                                                      
         L     R2,=A(TITLPOOL)                                                  
         LH    R3,POOLLINE                                                      
         SPACE 1                                                                
FIGTEST  TM    PLTYPE,X'40'        CAPTION                                      
         BZ    NEXTLINE              NO - TRY NEXT                              
         SPACE 1                                                                
         CLI   PLCHPT,C' '         PREFIX                                       
         BNE   PREFIX                YES                                        
         SPACE 1                                                                
         EDIT  (P2,CAPNUM),(3,P)     NO                                         
         B     SETFIG                                                           
         SPACE 1                                                                
PREFIX   CLC   ALPHA,PLCHPT        SAME AS LAST PREFIX                          
         BE    *+16                  YES                                        
         GOTO1 =V(PRINTER)           NO  - SKIP A LINE                          
         MVC   ALPHA,PLCHPT                SAVE NEW PREFIX                      
         SPACE 1                                                                
         MVI   DASHFLAG,C'Y'                                                    
         LA    R1,P+2                                                           
         BAS   RE,TPSECNO                                                       
         EDIT  (P2,CAPNUM),(3,(R1)),ALIGN=LEFT                                  
         SPACE 1                                                                
SETFIG   MVC   P+7(58),0(R2)                                                    
         BAS   R7,CONTNTLN                                                      
         SPACE 1                                                                
NEXTLINE LA    R2,96(R2)                                                        
         BCT   R3,FIGTEST                                                       
         B     ANYIND6                                                          
         EJECT                                                                  
*              SORT AND PRINT THE INDEX                                         
         SPACE 1                                                                
ANYIND   ST    RE,RETADDR                                                       
         BAS   R7,FORCEODD                                                      
         L     R1,=V(PRINT)                                                     
         MVC   0(2,R1),BORROW      RESET SELECTIVE ISSUE                        
         CLC   POOLLINE,=H'0'      TITLPOOL ENTRIES                             
         BE    CLOSEOUT              NO                                         
         SPACE 1                                                                
         MVC   TITLE(5),=X'C9958485A7'  INDEX U/LC                              
         CLI   SECTNUM,C' '        SECTION NUMBERING                            
         BE    ANYIND1               NO                                         
         MVI   SECTNUM,C'I'          YES                                        
         ZAP   PAGE,=P'1'                                                       
ANYIND1  L     R2,=A(TITLPOOL)                                                  
         LH    R3,POOLLINE                                                      
         GOTO1 =V(XSORT),PARA1,(R2),(R3),96,32,61                               
         B     FIRSTIND                                                         
         SPACE 1                                                                
ANYIND2  CLC   ALPHA,SRTTXT                                                     
         BE    ANYIND3                                                          
         GOTO1 =V(PRINTER)         SKIP LINE BEFORE NEW 1ST LETTER              
FIRSTIND MVC   ALPHA,SRTTXT                                                     
         MVC   P(5),SPACES                                                      
         SPACE 1                                                                
ANYIND3  BAS   R7,INDEXLN          ISSUE INDEX LINE                             
         LA    R2,96(R2)                                                        
         BCT   R3,ANYIND2                                                       
         SPACE 1                                                                
*                   END 'CONTENTS' AND 'FIGURES' OR 'INDEX'                     
         SPACE 1                                                                
ANYIND6  OI    MODE,X'0A'                                                       
         GOTO1 =V(PRINTER)                                                      
         MVI   ALPHA,C' '                                                       
         BAS   R7,FORCEODD                                                      
CLOSEOUT MVI   SECTNUM,C' '                                                     
         TM    MODE,1                                                           
         BZ    INDXT                                                            
         XI    MODE,1              RESET FRONT-MATTER BIT                       
         ZAP   FIGNO,=P'0'                                                      
         ZAP   PAGE,=P'1'                                                       
INDXT    L     RE,RETADDR                                                       
         BR    RE                                                               
         EJECT                                                                  
*                   FORMAT INDEX LINE                                           
         SPACE 1                                                                
INDEXLN  MVC   P+5(58),0(R2)                                                    
         LA    R5,P+65             LIMIT FOR SAME-LINE PAGE NUMBERS             
         LA    R6,58               LIMIT FOR FINDING IX-LINE LENGTH             
         LA    R1,P+62             LAST POSSIBLE IX-LINE CHAR                   
         CLI   0(R1),C' '                                                       
         BNE   *+12                END OF IX-LINE TEXT                          
         BCTR  R1,0                                                             
         BCT   R6,*-10                                                          
         BR    R7                  BLANK INDEX LINE                             
         SPACE 1                                                                
         LA    R1,3(R1)            LEAVE TWO TRAILING SPACES                    
IXPGNUM  TM    PLTYPE,X'40'        FIGURE                                       
         BZ    IXNOTFIG              NO                                         
         SPACE 1                                                                
         MVI   0(R1),C'('            YES - TAG IT                               
         MVC   1(3,R1),FIGNAME                                                  
         MVC   4(3,R1),=C'.) '                                                  
         LA    R1,7(R1)              BUMP PAST TAG                              
         SPACE 1                                                                
IXNOTFIG CLI   PLCHPT,C' '         SECTIONAL PAGE NUMBERING                     
         BE    SETIXPG               NO                                         
         BAS   RE,IXSECNO                                                       
         SPACE 1                                                                
SETIXPG  EDIT  (P2,PLPGNO),(3,0(R1)),ALIGN=LEFT                                 
         LA    R1,2(R1)                                                         
         CLI   0(R1),C' '                                                       
         BNE   *+8                                                              
         BCT   R1,*-8                                                           
         LA    R1,1(R1)            POINT PAST PAGE NO.                          
         SPACE 1                                                                
         CLC   CAPTEXT,96(R2)      SAME TEXT ON NEXT INDEX LINE                 
         BNE   PUTLINE               NO                                         
         SPACE 1                                                                
         CR    R1,R5                 YES - ROOM FOR PG. NO.                     
         BH    PUTLINE                       NO                                 
         SPACE 1                                                                
         MVI   0(R1),C','                    YES - AFFIX , FOR NEXT             
         LA    R1,1(R1)                            POINT PAST IT                
         LA    R2,96(R2)           POINT TO MATCHING IX LINE                    
         BCT   R3,IXPGNUM          REDUCE COUNTER AND LOOP                      
         SPACE 1                                                                
         BCTR  R1,0                MATCH BUT POOL EMPTIED                       
         MVI   0(R1),C' '                                                       
         LA    R7,ANYIND6                                                       
         B     PUTLINE                                                          
         EJECT                                                                  
*                   HANDLE SECTION NUMBERS                                      
         SPACE 1                                                                
DOSECNUM ST    RE,SECNORET                                                      
         MVI   DASHFLAG,C'Y'                                                    
         MVC   P-1(1),SECTNUM                                                   
         B     SETCHAPN                                                         
         SPACE 1                                                                
DOSUPNUM ST    RE,SECNORET                                                      
         MVC   P-1(1),SECTNUM                                                   
         B     IXSECNO+14                                                       
         SPACE 1                                                                
IXSECNO  ST    RE,SECNORET                                                      
         MVC   P-1(1),PLCHPT                                                    
         MVI   DASHFLAG,C'Y'                                                    
         TM    P-1,X'F0'           NUMERIC                                      
         BO    ONEDIGIT              YES                                        
         B     SETSUPNO              NO                                         
         SPACE 1                                                                
TPSECNO  ST    RE,SECNORET                                                      
         MVC   P-1(1),PLCHPT                                                    
         SPACE 1                                                                
SETCHAPN TM    P-1,X'F0'           NUMERIC                                      
         BO    ONEDIGIT              YES                                        
         BCTR  R1,0                  NO - BACK POINTER BY 1                     
SETSUPNO NI    P-1,X'0F'                  BLANK ZONE BITS                       
         XR    R6,R6                      ZERO REGISTER                         
         IC    R6,P-1                                                           
         BCTR  R6,0                                                             
         SLA   R6,1                                                             
         LA    R6,DIGTAB(R6)                                                    
         MVC   0(2,R1),0(R6)                                                    
         LA    R1,2(R1)                                                         
         B     DASHED                                                           
         SPACE 1                                                                
ONEDIGIT MVC   0(1,R1),P-1                                                      
         LA    R1,1(R1)                                                         
DASHED   CLI   DASHFLAG,C'Y'                                                    
         BNE   *+16                                                             
         MVI   0(R1),C'-'                                                       
         LA    R1,1(R1)                                                         
         MVI   DASHFLAG,C' '                                                    
         L     RE,SECNORET                                                      
         BR    RE                                                               
         SPACE 1                                                                
SECNORET DS    F                                                                
DIGTAB   DC    C'1011121314151617' CHAPTER NOS A - H                            
DASHFLAG DS    CL2                                                              
         EJECT                                                                  
*                   ERROR ROUTINE FOR TITLPOOL FULL                             
         SPACE 1                                                                
POOLFULL L     R3,=V(PRINT)                                                     
         MVC   0(2,R3),BORROW                                                   
         MVC   P(31),=C'** TITLPOOL FULL - JOB ENDED **'                        
         GOTO1 =V(PRINTER)                                                      
         B     ENDJOB                                                           
         SPACE 1                                                                
*              PAGE ROUTINES                                                    
         SPACE 1                                                                
STFLGTST MVI   PAGEMODE,C'N'                                                    
         CLI   STARTFLG,C'Y'       SAVED START                                  
         BNE   READ                                                             
         MVI   STARTFLG,C' '         YES - RESET FLAG                           
NOTSHT2  MVC   P+11(58),C+11                                                    
         SPACE 1                                                                
PAGESTRT MVI   PAGEMODE,C'Y'                                                    
         MVC   COLHEADS,SPACES                                                  
         CLC   P+11(8),SPACES     FIGURE TITLE?                                 
         BE    PGSTRT0               NO                                         
         SPACE 1                                                                
         MVC   INDEX,P+11            YES - SAVE IT                              
         MVI   FIGFLAG,C'Y'                FLAG IT                              
         MVI   FIGSTODO,C'Y'                                                    
         AP    FIGNO,=P'1'                                                      
         SPACE 1                                                                
PGSTRT0  BAS   R6,ENDOLDPG         START NEW PAGE                               
         CLI   PHASE,1                                                          
         BNE   PAGE1                                                            
         SPACE 1                                                                
         CLI   FIGFLAG,C'Y'                                                     
         BNE   READ                                                             
         SPACE 1                                                                
         MVI   FIGFLAG,C'N'                                                     
         MVC   SCANWORD(7),SPACES                                               
         BAS   R1,DOPOOLLN                                                      
         GOTO1 =V(PRINTER)                                                      
         B     READ                                                             
         SPACE 1                                                                
PAGE1    L     R2,=A(PAGEBLOC)     CLEAR PAGEBLOC                               
         LH    R3,PAGELIM                                                       
         XC    LENRACK,LENRACK                                                  
PGCLEAR  MVC   0(132,R2),SPACES                                                 
         LA    R2,132(R2)                                                       
         BCT   R3,PGCLEAR                                                       
         B     READ                                                             
         EJECT                                                                  
PAGELINE CLI   PHASE,1                                                          
         BNE   PAGLN20                                                          
         GOTO1 =V(PRINTER)                                                      
         B     READ                                                             
         SPACE 1                                                                
PAGLN20  MVC   WORK(2),=2X'F0'     LINE NUMBER                                  
         MVZ   WORK(2),P+1                                                      
         CLC   WORK(2),=2X'F0'                                                  
         BNE   LRTEST                                                           
         SPACE 1                                                                
         PACK  DUB,P+1(2)                                                       
         CVB   R3,DUB                                                           
         CH    R3,PAGELIM                                                       
         BH    LRTEST                                                           
         SPACE 1                                                                
         LTR   R3,R3                                                            
         BZ    LRTEST                                                           
         SPACE 1                                                                
         BCTR  R3,0                                                             
         CLI   XERTEXT,C' '                                                     
         BE    *+14                                                             
         LA    R4,LENRACK(R3)                                                   
         MVC   0(1,R4),P+69                                                     
         MH    R3,=H'132'                                                       
         L     R2,=A(PAGEBLOC)                                                  
         AR    R2,R3                                                            
         CLI   P,C'R'                                                           
         BNE   *+8                                                              
         LA    R2,66(R2)                                                        
         MVC   0(66,R2),P+3                                                     
         SPACE 1                                                                
LRTEST   CLI   PROD,C'N'                                                        
         BNE   READ                                                             
         B     PRINTIT0                                                         
         SPACE 1                                                                
PAGEEND  CLI   PHASE,1             FIRST READ                                   
         BNE   *+8                   NO                                         
         B     TESTCNTD                                                         
         SPACE 1                                                                
         CLI   PROD,C'N'           CARD IMAGES PRINTED                          
         BNE   *+8                          NO                                  
         BAS   R6,ENDOLDPG                  YES                                 
         SPACE 1                                                                
         OI    MODE,X'28'          START WIDE PAGE                              
         TM    PAGE+1,X'10'        ODD (RECTO) PAGE?                            
         BO    *+8                   YES - SKIP HEADING                         
         BAS   R4,CAPTION                    YES                                
         GOTO1 =V(PRINTER)                                                      
         GOTO1 WPSTART,PARA1,P-1,=C'BL01'                                       
WPSTART  L     R2,=A(PAGEBLOC)                                                  
         SR    R3,R3                                                            
         EJECT                                                                  
PGENDLP  MVC   P,SPACES                                                         
         CLI   XERTEXT,C' '                                                     
         BE    NONXERPG                                                         
         LR    R4,R2                                                            
         ZIC   R7,LENRACK(R3)                                                   
         LTR   R7,R7                                                            
         BZ    PUTPGLIN                                                         
         CH    R7,=H'131'                                                       
         BNH   *+8                                                              
         LH    R7,=H'131'                                                       
         BAS   RE,TRYTABRT                                                      
         B     NONXERPG+10                                                      
         SPACE 1                                                                
NONXERPG CLC   0(132,R2),SPACES                                                 
         BE    PUTPGLIN                                                         
         SPACE 1                                                                
         LA    R4,P                                                             
         CLI   PROD,C'Y'                                                        
         BNE   *+8                                                              
         LA    R4,2(R4)                                                         
         MVC   0(106,R4),0(R2)                                                  
PUTPGLIN GOTO1 =V(PRINT),PARA1                                                  
         LA    R2,132(R2)                                                       
         LA    R3,1(R3)                                                         
         CH    R3,PAGELIM                                                       
         BNH   PGENDLP                                                          
         SPACE 1                                                                
         MVI   PAGEMODE,C'N'                                                    
         TM    PAGE+1,X'10'        ODD (RECTO) PAGE?                            
         BZ    PAGEDONE              NO                                         
         SPACE 1                                                                
         LH    R3,PAGELIM                                                       
         CVD   R3,DUB                                                           
         ZAP   LINE,DUB+6(2)                                                    
         BAS   R4,CAPTION                                                       
         GOTO1 =V(PRINTER)                                                      
         OI    MODE,X'08'                                                       
         B     TESTCNTD                                                         
         SPACE 1                                                                
PAGEDONE BAS   R6,ENDOLDPG                                                      
         B     TESTCNTD                                                         
         EJECT                                                                  
CAPTION  MVC   P,SPACES                                                         
         CLI   FIGFLAG,C'Y'        CAPTION AVAILABLE                            
         BNE   NOTCAPT               NO                                         
         SPACE 1                                                                
         MVC   P(7),FIGNAME        START CAPTION LINE                           
         LA    R1,P+1                                                           
         AH    R1,LOFFIGNM                                                      
         CLI   SECTNUM,C' '        SECTION NUMBER                               
         BE    *+12                  NO                                         
         MVI   DASHFLAG,C'Y'                                                    
         BAS   RE,DOSUPNUM                                                      
         EDIT  (P2,FIGNO),(3,(R1)),ALIGN=LEFT                                   
         LA    R1,1(R1)                                                         
         CLI   0(R1),C' '          FIND END OF FIGNO                            
         BNE   *-8                   NO                                         
         CLI   CTDFLAG,C'Y'        CONTINUED WIDE PAGE                          
         BNE   *+14                  NO                                         
         MVC   1(8,R1),=X'4DC39695A37D845D'  (CONT'D) U/LC                      
         LA    R1,9(R1)                                                         
         MVI   0(R1),C'.'            YES                                        
         MVC   3(58,R1),INDEX                                                   
         B     *+10                                                             
         SPACE 1                                                                
NOTCAPT  MVC   P(58),TITLE                                                      
         SPACE 1                                                                
         EDIT  (P2,PAGE),(3,P+99)                                               
         CLI   SECTNUM,C' '                                                     
         BE    CAPXIT              NO SECTION PREFIX                            
         SPACE 1                                                                
         LA    R1,P+100                                                         
         CLI   1(R1),C' '                                                       
         BE    *+8                                                              
         BCT   R1,*-8                                                           
         BAS   RE,DOSECNUM         SET CHAP NUM LEFT ADJUSTED                   
         SPACE 1                                                                
CAPXIT   OI    MODE,X'04'                                                       
         CLI   ULCFLAG,C'Y'                                                     
         BE    *+10                                                             
         OC    P(98),SPACES                                                     
         BR    R4                                                               
         EJECT                                                                  
TESTCNTD MVI   CTDFLAG,C' '                                                     
         MVI   PAGEMODE,C'N'                                                    
         CLI   STARTFLG,C'Y'                                                    
         BE    STARTSVE                                                         
         SPACE 1                                                                
WPCNTDLP GOTO1 =V(PANIC),PARA                                                   
         TM    PARA+8,X'80'                                                     
         BO    ENDREADW                                                         
         AP    PANSEQ,=P'1'                                                     
         SPACE 1                                                                
         CLC   P+9(6),=C'EJECT '                                                
         BE    WPCNTDLP                                                         
         SPACE 1                                                                
         CLC   P+9(6),=C'SPACE '                                                
         BE    WPCNTDLP                                                         
         SPACE 1                                                                
         CLI   XERTEXT,C'Y'                                                     
         BNE   NONXER                                                           
         SPACE 1                                                                
         CLI   P,X'2B'                                                          
         BNE   *+12                                                             
         BAS   R6,DOTABS                                                        
         B     WPCNTDLP                                                         
         CLI   P,X'1E'                                                          
         BE    WPCNTDLP                                                         
         CLI   P,X'06'                                                          
         BE    WPCNTDLP                                                         
         SPACE 1                                                                
NONXER   CLC   P(80),SPACES                                                     
         BE    WPCNTDLP                                                         
         SPACE 1                                                                
         CLC   P(10),=C'PAGE=START'                                             
         BE    SHEET1                                                           
         SPACE 1                                                                
         MVI   FIGFLAG,C'N'          NO                                         
         B     READON+6                                                         
         SPACE 1                                                                
STARTSVE MVI   STARTFLG,C' '                                                    
         CLC   C+11(8),SPACES      SAVED CAPTION                                
         BNE   NOTSHT2               YES                                        
         SPACE 1                                                                
SHEET2   MVI   CTDFLAG,C'Y'          NO  - DO 2ND SHEET CAPTION                 
         MVI   PAGEMODE,C'Y'                                                    
         B     PAGE1                                                            
         SPACE 1                                                                
SHEET1   CLC   P+11(8),SPACES      NEW CAPTION                                  
         BNE   PAGESTRT              YES                                        
         B     SHEET2                NO                                         
         SPACE 1                                                                
ENDREADW CLI   CONTOPT,C'Y'                                                     
         BE    ENDBOOK                                                          
         B     NEXTBOOK                                                         
         EJECT                                                                  
*              ROUTINE TO PRINT A LINEUP PATTERN                                
         SPACE 1                                                                
LINEUP   GOTO1 =V(PRINT),PARA1,SPACES-1,=C'AC01'                                
         MVI   P,C'X'                                                           
         MVC   P+1(109),P                                                       
         GOTO1 =V(PRINT),PARA1,P-1,=C'BL02'                                     
         MVC   P+80(15),SPACES                                                  
         ZAP   LINE,=P'0'                                                       
         MVI   BIGWORD,C'.'                                                     
         MVC   P+4(8),=CL8'.'                                                   
         BAS   RE,THINKBIG                                                      
         MVC   P+4(8),=CL8'ODD'                                                 
         BAS   RE,THINKBIG                                                      
         MVC   P+4(8),=CL8'PAGE'                                                
         BAS   RE,THINKBIG                                                      
         MVC   TITLE(12),=C'END ODD PAGE'                                       
         MVC   WORK(1),SECTNUM                                                  
         MVI   SECTNUM,C' '                                                     
         GOTO1 =V(PRINTER)                                                      
         MVC   TITLE(15),=C'START EVEN PAGE'                                    
         GOTO1 =V(PRINTER)                                                      
         MVC   SECTNUM,WORK                                                     
         MVC   P+4(8),=CL8'.'                                                   
         BAS   RE,THINKBIG                                                      
         MVC   P+4(8),=CL8'EVEN'                                                
         BAS   RE,THINKBIG                                                      
         MVC   P+4(8),=CL8'PAGE'                                                
         BAS   RE,THINKBIG                                                      
         MVC   BIGWORD,SPACES                                                   
         MVC   TITLE(15),SPACES                                                 
         ZAP   PAGE,=P'0'                                                       
         BR    R6                                                               
         EJECT                                                                  
ENDOLDPG TM    MODE,X'08'          IS START PAGE PENDING.                       
         BOR   R6                    YES - GET OUT.                             
         SPACE 1                                                                
         OI    MODE,X'0A'                    NO  - END OLD, SET START           
         GOTO1 =V(PRINTER)                                                      
         BR    R6                                                               
         SPACE 2                                                                
FORCEODD BAS   R6,ENDOLDPG                                                      
         MVC   TITLE,SPACES                                                     
         MVC   COLHEADS,SPACES                                                  
         MVC   LOFTITLE,=H'0'                                                   
         CLI   PHASE,0                                                          
         BER   R7                                                               
         SPACE 1                                                                
         CLI   CONTOPT,C'Y'        PROD=M                                       
         BNER  R7                    NO - DON'T FORCE ODD                       
         SPACE 1                                                                
         TM    PAGE+1,X'10'        EVEN-ODD                                     
         BOR   R7                    ODD NOW - GET OUT                          
         MVC   P,SPACES                                                         
         GOTO1 =V(PRINTER)                                                      
         OI    MODE,X'02'                                                       
         GOTO1 =V(PRINTER)                                                      
         BR    R7                                                               
         EJECT                                                                  
*              WORK SPACE                                                       
         SPACE 1                                                                
DUB      DS    D                                                                
PARA     DS    6F                                                               
PARA1    DS    6F                                                               
PARA2    DS    6F                                                               
SAVEREGS DS    6F                                                               
C        DS    CL80                                                             
SAVEDIR  DS    CL80                                                             
INDEX    DS    CL60                                                             
WORK     DS    CL32                                                             
LENRACK  DS    CL54                                                             
ENDPGNAM DC    CL10'ENDPAGES'                                                   
FIGNAME  DC    X'C68987A499854040' FIGURE IN U/LC                               
SECTNAME DC    X'C3888197A3859940' CHAPTER U/LC                                 
PAGELIM  DC    H'54'                                                            
POOLLINE DC    H'0'                                                             
POOLSIZE DC    H'800'    CHANGED FROM 400 12/83 (PD) (SEE TITLPOOL)             
LOFFIGNM DC    H'6'                                                             
LOFCHPNM DC    H'7'                                                             
USCOFFST DC    H'0'                                                             
CHOSEN   DC    CL3' '    CLEARED (L16) BY NEXTBOOK                              
SCANWORD DS    CL5                                                              
         DS    CL2                                                              
ALPHA    DC    C' '                                                             
FIGSTODO DC    C' '                                                             
FIGFLAG  DC    C'N'                                                             
FILTER   DC    C'N'                                                             
FRONT    DC    C'N'                                                             
PAGEMODE DC    C'N'      END OF CLEARING BY NEXTBOOK                            
CONTOPT  DC    C'N'                                                             
BORROW   DS    CL2                                                              
PHASE    DC    X'00'                                                            
INCOPT   DC    X'80'                                                            
FIGNO    DC    PL2'0'                                                           
CONTLIM  DC    C'2'                                                             
CTDFLAG  DC    C' '                                                             
STARTFLG DC    C' '                                                             
LINELEN  DC    X'00'                                                            
XERTEXT  DC    C' '                                                             
SAVEFLAG DC    C' '                                                             
PANSEQ   DC    PL3'0'                                                           
         EJECT                                                                  
LINESTRT DS    F                                                                
TABRACK  DS    XL40                                                             
REBUILD  DC    CL160' '                                                         
USCORSAV DC    CL160' '                                                         
LINEEND  DS    0CL256                                                           
         DC    6X'00'                                                           
         DC    X'06'          RCR - 06                                          
         DC    23X'00'                                                          
         DC    X'1E'          CRE - 1E                                          
         DC    225X'00'                                                         
         SPACE 1                                                                
TABCHECK DS    0CL256                                                           
         DC    5X'00'                                                           
         DC    X'05'          HT  - 05  XEROX PTB                               
         DC    51X'00'                                                          
         DC    X'39'          IT  - 39  XEROX TAB                               
         DC    198X'00'                                                         
         SPACE 1                                                                
USCORES  DS    0CL256                                                           
         DC    34X'00'                                                          
         DC    X'22'          BUS - 22                                          
         DC    X'23'          WUS - 23                                          
         DC    220X'00'                                                         
         SPACE 1                                                                
INTERTRT DS    0CL256                                                           
         DC    96X'00'                                                          
         DC    X'60'     DASH                                                   
         DC    29X'00'                                                          
         DC    X'7E'     EQUAL SIGN                                             
         DC    129X'00'                                                         
         SPACE 1                                                                
TRTABLE  DS    0CL256                                                           
         DC    X'000102030405060708090A0B0C0D0E0F'                              
         DC    X'101112131415161718191A1B1C1D1E1F'                              
         DC    X'202122232425262728292A2B2C2D2E2F'                              
         DC    X'303132333435363738393A3B3C3D3E3F'                              
         DC    X'404042434445464748494A4B4C4D4E4F'                              
         DC    X'505152535455565758595A5B5C5D5E40'                              
         DC    X'60616263646566676869406B6C6D6E6F'                              
         DC    X'707172737475767778797A7B7C7D7E7F'                              
         DC    X'808182838485868788898A8B8C8D8E8F'                              
         DC    X'909192939495969798999A9B9C9D9E9F'                              
         DC    X'A0A1A2A3A4A5A6A7A8A9AAABACADAEAF'                              
         DC    X'B0B1B2B3B4B5B6B7B8B9BABBBCBDBEBF'                              
         DC    X'C0C1C2C3C4C5C6C7C8C960CBCCCDCECF'                              
         DC    X'D0D1D2D3D4D5D6D7D8D9DADBDCDDDE40'                              
         DC    X'E0E1E2E3E4E5E6E7E8E9EAEBECEDEEEF'                              
         DC    X'F0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF'                              
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
       ++INCLUDE DDDPOOLLN                                                      
       ++INCLUDE DDDMANPRNT                                                     
         EJECT                                                                  
PAGEBLOC CSECT                                                                  
         DS    64CL132                                                          
         SPACE 1                                                                
TITLPOOL CSECT                                                                  
         DS    800CL96         CHANGED FROM 400 12/83 - PD                      
** CHANGE POOLSIZE WHEN L(TITLPOOL) IS CHANGED **                               
         SPACE 1                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'009DDMANPRINT05/01/02'                                      
         END                                                                    
