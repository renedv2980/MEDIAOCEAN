*          DATA SET SPREPI202  AT LEVEL 130 AS OF 03/04/21                      
*CATALP SPI202                                                                  
         TITLE 'SPREPI202 - INVOICE MATCHING REPORT'                            
***********************************************************************         
*                                                                               
* REQUEST OPTIONS                                                               
*                                                                               
* QOPT1   Y=PRINT FILM REPORTS                                                  
*         N=SUPPRESS FILM REPORTS                                               
*         F=ONLY FILM REPORTS                                                   
*         E=ONLY IF ERRORS                                                      
*         X=ONLY FILM REPORTS AND ONLY IF ERRORS                                
*         O=SAME AS E BUT OVERRIDES MATCH=NO ON I2 REPORT                       
* QOPT2   Y=SORT BUYS BY EST-LIN                                                
* QOPT3   SPACE CONTROL                                                         
* QOPT4   S=PRINT ONLY SUMMARIES                                                
*         D=PRINT ONLY DISCREPANT MATCHES BUT ALL SUMMARIES                     
*         A=PRINT ONLY DISCREPANT SUMMARIES                                     
*         B=PRINT ONLY DISCREPANT MATCHES AND ONLY DISC SUMMARIES               
*         1=DO ONLY SPECIALS   (JWT SPECIAL FEATURE)                            
*         2=RE-RATE SPECIALS                                                    
*         3=ONLY + RE-RERATE                                                    
* QOPT5 - N=SUPPRESS POSTING OF AFFIDS                                          
*         Y=FORCE POSTING OF AFFIDS                                             
*         P=FORCE POSTING OF AFFIDS EVEN IF PARTIAL MATCHING                    
* QOPT6 - (QOPT5+1) =DAYPART FILTER                                             
* QOPT7 - (QOPT5+2)  =>COSTSUP  Y=SUPPRESS COSTS, A=SUPPRESS COSTS,             
*                    ROTATION, INTERVAL CHECKING, AND BIG ERRORS                
* COL57   NETPAK MEDIA FILTER (N,C,S,ETC)                                       
* COL58(4) - PARTIAL MATCH DATA TYPES                                           
*  **NOTE - THE FOLLOWING OPTIONS ARE IN QSTAUTO AND QENDAUTO                   
* COL32   Z=Z5 REQUEST                                                          
* COL33   Y=RESPONSE COUNT MODE                                                 
*         NOTE- RESPONSE MODE STOPS DEMOS AND SPECIAL REP TOTALS                
* COL34   N=DONT SHOW MATCHED DETAIL ITEMS                                      
* QBOOK1  ACN NUMBER (LEN 5)                                                    
* Q2USER+0(1) - LETTER OPTION                                                   
* Q2USER+1(1) - CALENDAR OPTION - C = CALENDAR, B = BROADCAST                   
* Q2USER+2(1) - INTEGRATION OPTION - I=MATCH ON INT, O=MATCH ONLY INT           
* Q2USER+3(3) - SPECIAL REP (QREP GETS CREAMED BY QREQCONT)                     
*             - REP MOVED TO RQREP FOR FILCON                                   
*                                                                               
***********************************************************************         
                                                                                
***********************************************************************         
*                                                                               
*         NOTE - USE OF BUY-LINE RERATED DEMOS RATHER THAN AFFIDS               
*                IS IN LIMBO. MAY NEED CODE AT ACHD4 TO USE BUYREC              
*                DATA RATHER THAT INVOICE.                                      
*                                                                               
***********************************************************************         
* USER    JIRA       DATE                  CHANGE LOG                 *         
* ---- ----------  -------- ----------------------------------------- *         
* AKAT SPEC-46696  02/22/21 CARRY AND DISPLAY 4 BYTE DEMO VALUES      *         
* AKAT SPEC-45362  07/06/20 HONOR NEW STW ESTIMATES ON I2 FIELD ON I2N*         
* AKAT SPEC-36674  11/16/19 2 DECIMAL IMPRESSIONS SUPPORT             *         
* AKAT SPEC-21468  10/31/18 ADD EFFECTIVE DATE FOR SEPARATION PROFILE *         
* AKAT SPEC-24481  06/05/18 INCREASE CONTRACT ID BUFFER               *         
* AKAT SPEC-15915  09/07/17 TURN OFF RCWRITE FOR COMSCORE PASS 1      *         
* AKAT SPEC-14419  07/19/17 SUPPORT OVERNIGHT COMSCORE REQUESTS       *         
* AKAT SPEC-8274   03/31/17 "NOT CLEARED" TOTS TO MIRROR NPAY PAYABLES*         
* AKAT SPEC-10980  03/15/17 SUPPORT COMSCORE DEMO LOOKUPS FOR 17.1.5  *         
* AKAT MOXSYS-150  10/03/16 SUPPORT COMSCORE DEMOS                    *         
* AKAT MOSTK-62    03/21/16 NEW -CM BAND SUPPORT FOR IHEART RADIO     *         
* AKAT DSSUP-7115  03/14/16 FIX SEPARATION FLAG ERROR WITH ADDED VALUE*         
***********************************************************************         
* NAME   DATE   LEVEL                    COMMENTS                               
* ----   ----   -----   -----------------------------------------------         
* AKAT  NOV0315  118  - HONOR 3AM BROADCAST TIME STARTING DEC/2015              
* AKAT  AUG0814  113  - DISABLE MGA RFEPORT                                     
* AKAT  OCT0313  112  - CALL BLDMGN INSTEAD OF BLDMGA                           
* AKAT  AUG0513  111  - REPORT DIGITAL STATIONS AS -DV AND -SM                  
* AKAT  MAR0612  110  - SUPPORT NEW NAGATIVE REP FILTER FOR GROUPM              
* AKAT  FEB2512  109  - SUPPORT FOR I2 DELIVERY SECTION REMOVED                 
* AKAT  FEB1813  108  - SUPPORT FOR BANDS -D AND -S                             
* AKAT  FEB0813  107  - FIX REMATCH BUG                                         
* AKAT  OCT0112  106  - FIX BUY-ID BUG                                          
* AKAT  SEP1012  105  - FIX PRD SUBSTITUTION BUG                                
* AKAT  AUG2112  104  - REPORT INVOICE REP FOR NET UNORDERED SPOTS              
* AKAT  DEC1411  102  - COST TOLERANCE & PRODUCT SUBSTITUTION FEATURE           
* AKAT  SEP1511  101  - FIX BOOKTYPE BUG                                        
* AKAT  AUG1811  100  - FIX 2-BYTE BOOKTYPE BUG FOR DEMO LOOKUPS                
* AKAT  JUL2911  099  - SUPPORT FOR NEW XAUTOPAY CLEAR BY REP/BUY               
*                     - EXPAND BUFFERS VIA GETMAIN CALL                         
*                     - FIX BUY ID BUG WHEN PROCESSING SYSCODES                 
* AKAT  MAR0311  095  - CML BROADCAST DAY FIX FOR NO COMMERCIAL TIMES           
* AKAT  JUL1410  089  - CML BROADCAST DAY FIX FOR 6AM                           
* AKAT  JUN0310  088  - NEW CMML TIME CHECK & PROFILE FOR BROADCAST DAY         
*                     - SUPPORT FOR THE NEW CHECK COMML LEN ON I2C PROF         
*                     - FLAG INV WITH CENTERCUT EVEN IF NOT MATCHING            
* AKAT  JAN2710  087  - TWO-BYTE BUYLINE SUPPORT                                
* AKAT  DEC2109  086  - DONT CUT OFF EST WHEN REPORTING UNORD PIGGY             
* AKAT  SEP0109  085  - FULL AD-ID SUPPORT                                      
* AKAT  AUG2009  082  - FLAG WHEN "IGNORE FILMCODE" SET ON INV DETAIL           
* AKAT  JUN1209  080  - DON'T CHECK DEMOS WHEN REMATCHING!                      
* AKAT  SEP2208  069  - NEW "SORT I2 BY INV DATE/TIME" FEATURE                  
* AKAT  SEP1508  068  - SUPPORT NEW HDEF AND CENTERCUT COMMERCIALS              
*                     - AND NEVER SET FCRDBUYS,TO A C'S'                        
* AKAT  JUL2808  067  - DON'T DEFUALT TO MASTER RECORD'S BOOKTYPE!              
* AKAT  JUL2408  066  - DON'T ADD AUTOPAY RECS IF POST AFFIDS=N!                
***********************************************************************         
         PRINT NOGEN                                                            
SPI202   CSECT                                                                  
         NMOD1 0,SPI202                                                         
*                                                                               
         LA    R8,2048(RB)                                                      
         LA    R8,2048(R8)                                                      
         USING SPI202+4096,R8      **2ND BASE REG                               
         L     RA,0(R1)                                                         
         LA    R9,1(RA)                                                         
         LA    R9,4095(R9)                                                      
         USING SPWORKD,RA,R9                                                    
         LA    RC,SPACEND                                                       
         USING IMRWORK,RC                                                       
         MVC   PATCH,*+10                                                       
         B     *+24                                                             
PATCHER  DC    20X'00'             PATCH AREA                                   
*                                                                               
         CLI   MODE,PROCBUY                                                     
         BE    PRBUY                                                            
         CLI   MODE,CBHFRST        FIRST FOR CABLE HEAD                         
         BE    CBHF                                                             
         CLI   MODE,STAFRST                                                     
         BE    STAF                                                             
         CLI   MODE,STALAST                                                     
         BE    STAL                                                             
         CLI   MODE,MKTLAST                                                     
         BE    MKTL                                                             
         CLI   MODE,CBHLAST        LAST FOR CABLE HEAD                          
         BE    CBHL                                                             
         CLI   MODE,ESTFRST                                                     
         BE    ESTF                                                             
         CLI   MODE,ESTLAST                                                     
         BE    ESTL                                                             
         CLI   MODE,PRDFRST                                                     
         BE    PRDF                                                             
         CLI   MODE,PRDLAST                                                     
         BE    PRDL                                                             
         CLI   MODE,CLTFRST                                                     
         BE    CLTF                                                             
         CLI   MODE,REQLAST        AT REQL                                      
         BE    ESTF                MAY HAVE TO DO DATES, ETC                    
         CLI   MODE,CLTLAST        ALSO AT CLTL                                 
         BE    ESTF                                                             
         CLI   MODE,RUNFRST                                                     
         BNE   *+12                                                             
         BRAS  RE,RUNF                                                          
         B     EXIT                                                             
         CLI   MODE,RUNLAST                                                     
         BE    RUNL                                                             
         CLI   MODE,REQFRST                                                     
         BE    REQF                                                             
*                                                                               
EXIT     DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
**********************************************************************          
*        MKT LAST                                                               
**********************************************************************          
MKTL     DS    0H                                                               
         NI    CBLHOPT,X'FF'-CBLHHDQ                                            
         B     EXIT                                                             
**********************************************************************          
*        RUN LAST                                                               
**********************************************************************          
RUNL     DS    0H                                                               
         MVI   PAGSW,C'S'                                                       
         GOTO1 AIRSUM   TAKE CARE OF ANY LEFT UNPRINTED SUMMARY                 
*                                                                               
         L     R6,VMASTC           A(DDMASTD)                                   
         USING MASTD,R6                                                         
         OC    MCREMPQK,MCREMPQK   SOON?                                        
         BNZ   RUNL10              NOT ZERO = SOON = SKIP CLOSE                 
         DROP  R6                                                               
*                                                                               
         MVC   WORK(80),SPACES                                                  
         MVC   WORK(2),=C'/*'      END REQUEST                                  
         L     R1,=A(IPRQFIL)                                                   
         LA    R0,WORK                                                          
         PUT   (1),(0)                                                          
         CLOSE (IPRQFIL)                                                        
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         B     EXIT                                                             
*                                                                               
*=================================================================*             
* UNLOCK DATA LOCKED BY OFFLINE APPLICATION                       *             
*=================================================================*             
*                                                                               
RUNL10   DS    0H                                                               
*                                                                               
         CLI   PSTOPT,C'U'        OVERRODE UPDATING DUE TO PRD/EST ALL?         
         BNE   *+8                NO                                            
         BRAS  RE,EMAIL           YES - SEND AN E-MAIL                          
         CLI   COMSCORE,C'1'      COMSCORE PASS 1?                              
         BE    EXIT               YES - DO NOT UNLOCK!                          
         CLI   SVQOPT5,C'P'                                                     
         BE    RUNL12                                                           
         CLI   SVQOPT5,C'Y'                                                     
         BNE   EXIT                                                             
*                                                                               
RUNL12   XC    DMCB(4),DMCB                                                     
         MVC   DMCB+4(3),=X'D9000A'                                             
         MVI   DMCB+7,QLOCKET                                                   
         L     RF,ACOMFACS                                                      
         L     RF,(CCALLOV-COMFACSD)(RF)                                        
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB                                                          
*                                                                               
*        NOTE LKUPKEY WAS SET AT REQF * DON'T HAVE REQUEST HERE                 
*                                                                               
         CLI   NETPSW,C'Y'         IF NETPAK                                    
         BE    UNLOCK3             SKIP BUYS FOR NETPAK                         
*                                                                               
L        USING LKKEYD,LKUPKEY                                                   
         MVC   L.LOCKRTY,=C'BU'    UNLOCK BUYS                                  
UNLOCK2  GOTO1 (RF),DMCB,('LKUNLKQ',LKUPKEY),ACOMFACS                           
         CLI   4(R1),2             TEST TABLE BUSY                              
         BE    UNLOCK2                                                          
*                                                                               
UNLOCK3  MVC   L.LOCKRTY,=C'NV'    UNLOCK INVOICES                              
UNLOCK4  GOTO1 (RF),DMCB,('LKUNLKQ',LKUPKEY),ACOMFACS                           
         CLI   4(R1),2             TEST TABLE BUSY                              
         BE    UNLOCK4                                                          
*                                                                               
         CLI   NETPSW,C'Y'         IF NETPAK                                    
         BNE   EXIT                SPOT DONE                                    
*                                                                               
         MVC   L.LOCKRTY,=C'UN'    UNLOCK UNITS FOR NETPAK                      
         MVC   L.LOCKNCLT,L.LOCKCLT                                             
         MVC   L.LOCKNNET,L.LOCKSTA                                             
         XC    L.LOCKCLR,L.LOCKCLR                                              
UNLOCK6  GOTO1 (RF),DMCB,('LKUNLKQ',LKUPKEY),ACOMFACS                           
         CLI   4(R1),2             TEST TABLE BUSY                              
         BE    UNLOCK6                                                          
         B     EXIT                                                             
         DROP  L                                                                
         EJECT                                                                  
*                                                                               
**********************************************************************          
*                                                                               
*        REQF - REQUEST FIRST                                                   
*                                                                               
*        NOTE- IF QCLT=ALL DO THIS AT CLIENT FIRST                              
*                                                                               
**********************************************************************          
*                                                                               
REQF     DS    0H                                                               
         BAS   RE,REQFPR                                                        
*                                                                               
         CLI   COMSCORE,X'40'      COMSCORE REQUEST?                            
         BNH   REQF000             NO                                           
*                                                                               
         CLI   COMSCORE,C'1'       COMSCORE PASS 1?                             
         BNE   *+8                 NO                                           
         MVI   RCWRITE,C'N'        YES - NO UPDATING                            
*                                                                               
         CLI   COMSCORE,C'2'       COMSCORE PASS 2?                             
         BNE   *+8                 NO                                           
         MVI   RCWRITE,C'Y'        YES - RESET RCWRITE TO Y (DEFAULT)           
*                                                                               
REQF000  MVI   SVMMPROC,C'N'       HAVE NOT PROCESSED MM                        
         MVI   BFRINSW,C'N'        SET BUFFERIN NOT INITIALIZED                 
         L     R6,VMASTC           A(DDMASTD)                                   
         USING MASTD,R6            MASTD DSECT                                  
         OC    ABUFFER,ABUFFER     IS BUFFER ALLOCATED ALREADY?                 
         BNZ   REQF00              YES                                          
*&&DO                                                                           
         L     R0,=A(BUFFLOV)      BUFFER LENGTH FOR OVERNIGHT                  
         L     R6,VMASTC           A(DDMASTD)                                   
         USING MASTD,R6            MASTD DSECT                                  
         OC    MCREMPQK,MCREMPQK   SOON?                                        
         BZ    *+8                 NO                                           
         L     R0,=A(BUFLSOON)     YES - LENGTH OF BUFFER FOR SOON              
         ST    R0,BUFFLEN          BUFFER LENGTH                                
*                                                                               
         GETMAIN  RU,LV=(0),LOC=24                                              
         LTR   RF,RF               ANY ERRORS?                                  
         BZ    *+6                 NO                                           
         DC    H'0'                YES - DEATH                                  
         ST    R1,ABUFFER          A(BUFFER)                                    
         L     R0,BUFFLEN          BUFFER LENGTH                                
         AR    R1,R0               ADD BUFFER LENGTH                            
         ST    R1,ABUFFX           A(END OF BUFFER)                             
                                                                                
         OC    ABUFFER,ABUFFER     BUFFER PRESENT?                              
         BNZ   *+6                 YES                                          
         DC    H'0'                NO - DEATH                                   
*&&                                                                             
REQF00   OC    MCREMPQK,MCREMPQK   SOON?                                        
         BZ    EXIT                NOT ZERO = SOON = SAVE LOCK                  
         DROP  R6                  DROP MASTD USING                             
*                                                                               
         CLC   QAGY,=C'S5'         IF STW TEST ID                               
         BNE   *+8                                                              
         MVI   QOPT5,C'Y'          FORCE TO UPDATE                              
*                                                                               
         CLI   QOPT5,C' '          NO POST AFFID ENTERED IN REQUEST             
         BNE   *+8                                                              
         MVI   QOPT5,C'N'          THEN FORCE TO N FOR SOON -                   
*                                  DON'T WANT TO USE PROFILE FOR SOON           
         CLI   QOPT5,C'Y'          IF NO POSTING FOR SOON REQUEST               
         BE    *+16                                                             
         CLI   QOPT5,C'P'          OR PARTIAL POSTING                           
         BE    *+8                                                              
         MVI   RCWRITE,C'N'        THEN NO UPDATING                             
*                                                                               
         MVC   SVQOPT5,QOPT5       SAVE QOPT5 FOR RUNL                          
*                                                                               
         XC    LKUPKEY,LKUPKEY     SAVE LOCK KEY FOR LATER                      
L        USING LKKEYD,LKUPKEY                                                   
         L     R1,UTL                                                           
         MVC   L.LOCKSE,4(R1)                                                   
         MVC   L.LOCKAGY,AGENCY                                                 
         MVC   L.LOCKRTY,=C'BU'    UNLOCK BUYS                                  
         MVC   L.LOCKMED,QMED                                                   
         MVC   L.LOCKCLT,QCLT                                                   
         MVC   L.LOCKSTA,QSTA                                                   
         CLI   L.LOCKSTA+4,C' '                                                 
         BH    *+8                                                              
         MVI   L.LOCKSTA+4,C'T'                                                 
         DROP  L                                                                
*                                                                               
         B     EXIT                                                             
*                                                                               
REQFPR   NTR1                                                                   
*                                                                               
         MVC   RQREP,SPACES                                                     
         CLC   QREP,=C'  Z'        Z5 REQUEST USES QREP                         
         BE    REQF1                                                            
         CLI   QCONTREQ,C'*'                                                    
         BE    REQF1                                                            
         MVC   RQREP,QREP                                                       
REQF1    CLC   Q2USER+3(3),SPACES  SPECIAL REP AS OF 4/11/00                    
         BNH   *+10                QREP GETS CREAMED BY QCONTREQ                
         MVC   RQREP,Q2USER+3      MOVE FOR FILCON TO USE                       
*                                                                               
         MVI   CQSW,C'A'           'ALL CLIENT' SWITCH (OR EQUIV)               
         CLC   QCLT,=C'ALL'                                                     
         BE    REQF2                                                            
         CLI   QCLT,C'*'           OFFICE                                       
         BE    REQF2                                                            
         CLI   QCLT,C'$'           CLIENT GROUP                                 
         BE    REQF2                                                            
         MVI   CQSW,0                                                           
*                                                                               
REQF2    DS    0H                                                               
         CLI   CQSW,C'A'           IF 'ALL' CLIENTS                             
         BNE   REQF3                                                            
         CLI   MODE,REQLAST        AND AT REQL                                  
         BNE   REQF3                                                            
         MVI   RCREQREP,C'Y'                                                    
         GOTO1 REQREP,DMCB                                                      
         MVI   RCREQREP,C'N'       RESET NOT TO PRINT REQUEST                   
*                                                                               
REQF3    DS    0H                                                               
         MVI   MEDPRDSW,0          DO MEDPRDRD ONLY ONCE FOR REQ                
         CLC   QCBLNET,=C'ALL'     CABLE NET SHOULD NOT BE ALL                  
         BNE   *+10                                                             
         MVC   QCBLNET,SPACES      (SPACES MEANS ALL)                           
*                                                                               
         OC    PAGE,PAGE           IF PAGE IS NULL (2 PRINTOUT BUG?)            
         BNZ   *+8                                                              
         MVI   PAGE+1,1            START AT 1                                   
*                                                                               
         MVI   REQLSW,C'N'                                                      
         XC    HOMEMKT,HOMEMKT                                                  
*                                                                               
         MVI   CANADSW,C'N'                                                     
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'      TEST CANADA                       
         BNE   *+8                                                              
         MVI   CANADSW,C'Y'                                                     
*                                                                               
         MVI   NEWSW,C'Y'          **SET NEW MODE SWITCHES**                    
         MVI   NEWIDSW,C'N'                                                     
         L     RF,ADAGY                                                         
         CLI   AGYPROF+14-AGYHDR(RF),C'Y'                                       
         BNE   *+8                                                              
         MVI   RQGETNAM,C'Y'       ACTIVATE BUYER/BILLER NAME                   
*                                                                               
         MVC   BYTE,QPGR           SAVE QPGR - NOT TO BE MADE UPPERCASE         
         MVC   HALF(1),QMGR        QMGR IS HEX WITH 2 CHA MGROUPS               
         OC    QPROG(26),SPACES    ENSURE PROPER ALPHA-NUMERICS                 
         MVC   QPGR,BYTE           RESTORE - LOWER CASE ON PURPOSE!             
         MVC   QMGR,HALF                                                        
         CLI   QEST,C' '                                                        
         BNE   *+10                                                             
         MVC   QEST,=C'NO '                                                     
         MVI   FCRDBUYS,C'Y'                                                    
***      CLC   RQREP,SPACES                                                     
***      BNH   *+8                                                              
***      MVI   FCRDBUYS,C'S'                                                    
*****>>  BRAS  RE,EMAIL            SEN AN E-MAIL                                
*                                                                               
         L     R6,VMASTC           A(DDMASTD)                                   
         USING MASTD,R6                                                         
         MVC   NETPSW,MCNETPAK     NETPAK SWITCH                                
*                                                                               
         CLI   NETPSW,C'Y'         IF NETPAK                                    
         BNE   REQF3A                                                           
         L     RE,MCSSB                                                         
         OI    SSBSTAT2-SSBD(RE),SSBSROLC  RECOVER OFF-LINE COPIES              
         DROP  R6                                                               
*                                                                               
         MVC   MEDFILT,QAREA+56    SET STATION TYPE                             
         CLC   =C'ALL',QSTA        STA/PRD/EST CANNOT ALL BE 'ALL'              
         BNE   REQF3A                                                           
         CLC   =C'ALL',QPRD                                                     
         BNE   REQF3A                                                           
         CLC   =C'NO ',QEST                                                     
         BNE   REQF3A                                                           
         MVC   P(56),=C'** PRODUCT AND STATION CAN NOT BE ALL WITH ESTIX        
               MATE NO **'                                                      
         GOTO1 REPORT                                                           
         GOTO1 AENDREQ                                                          
*                                                                               
REQF3A   DS    0H                                                               
         CLI   QRERATE,C' '        UNLESS HAVE REQUESTED RERATE OPTION          
         BH    *+8                                                              
         MVI   QRERATE,C'I'        RERATE TYPE = INVOICE                        
*                                                                               
         MVI   CANNET,C'N'         CANADIAN NETWORK SWITCH                      
         CLI   QMED,C'N'                                                        
         BNE   REQF3B                                                           
         L     RF,ADAGY                                                         
         CLI   CANADSW,C'Y'        TEST CANADA                                  
         BNE   REQF3B                                                           
         MVI   CANNET,C'Y'         SET CANADIAN NETWORK                         
         MVC   QMKT,=C'0000'       BUYS IN MARKET 0000                          
*                                                                               
REQF3B   DS    0H                                                               
* IF THERE IS AN ACN NUMBER GET THE MARKET NUMBER                               
         MVI   ACNFLAG,0                                                        
         CLC   AGY,=C'CK'          TEST COKEAT                                  
         BNE   REQF3L              NO - IGNORE                                  
         MVC   SVBUYID,SPACES      FOR COKE IS ACN NUMBER                       
         CLI   QBOOK1,C' '         NO ACN NUMBER                                
         BNH   REQF3L                                                           
         CLC   =C'ALL',QSTA                                                     
         BE    REQF3D                                                           
         BRAS  RE,VALACN           VALIDATE ACN NUMBER                          
         B     REQF6                                                            
*                                                                               
REQF3D   MVC   P(44),=C'STATION CANNOT BE ''ALL'' WITH AN ACN NUMBER'           
         GOTO1 REPORT                                                           
         GOTO1 AENDREQ                                                          
*                                                                               
REQF3L   DS    0H                                                               
         CLC   =C'ALL',QSTA                                                     
         BE    REQF6                                                            
         CLI   QSTA,C' '                                                        
         BE    REQF6                                                            
         CLI   QSTA+4,C'/'         LOCAL CABLE                                  
         BE    REQF4                                                            
         CLI   QSTA,C'0'                                                        
         BNL   REQF6                                                            
*                                  FOR SPECIFIC STATION REQ                     
REQF4    DS    0H                                                               
         MVI   KEY,C'0'            READ STATION REC                             
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'S'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(5),QSTA                                                    
         CLI   QSTA+4,C'/'         LOCAL CABLE                                  
         BNE   *+8                                                              
         MVI   KEY+6,C'T'          IS T ON FILE                                 
         MVC   KEY+7(2),QAGY                                                    
*                                                                               
         MVC   KEY+9(3),QCLT                                                    
         CLI   CQSW,C'A'           IF CLIENT=ALL                                
         BNE   *+10                                                             
         MVC   KEY+9(3),CLT        USE CURENT CLIENT                            
*                                                                               
         GOTO1 READSTA                                                          
         L     R6,ADSTAT                                                        
         USING STAREC,R6                                                        
*                                                                               
         XC    SVOLDMK1(4),SVOLDMK1  SAVE ANY OLD MKT NUMBERS                   
         CLC   STAKLEN,=H'256'                                                  
         BL    *+16                                                             
         MVC   SVOLDMK1,STOLDMK1                                                
         MVC   SVOLDMK2,STOLDMK2                                                
*                                                                               
         MVC   WORK,SPACES                                                      
         MVC   WORK(5),STAKCALL                                                 
         CLI   WORK+4,C'/'                                                      
         MVC   WORK+5(3),QCBLNET                                                
         GOTO1 MSPACK,DMCB,SMKT,WORK,BMKTSTA                                    
*                                                                               
         CLI   CANNET,C'Y'         UNLESS CANADIAN NET (MKT=0000)               
         BE    REQF6                                                            
         CLI   QMKT,C'0'           OR ALREADY THERE                             
         BNL   REQF6               SET MARKET CODE FROM STATION REC             
         MVC   QMKT,SMKT                                                        
         DROP  R6                                                               
*                                                                               
REQF6    DS    0H                  ADDS INTERFACE- REMOVED!                     
         MVC   PSEUDOPT,QAREA+32   PSEUDO MODE                                  
         CLI   PSEUDOPT,C' '       BLANK                                        
         BH    *+8                                                              
         MVI   PSEUDOPT,C'N'       ==> N                                        
         CLI   PSEUDOPT,C'Y'       AND Y                                        
         BNE   *+8                                                              
         MVI   PSEUDOPT,C'R'       ==> R                                        
         CLI   PSEUDOPT,C'M'       AND M                                        
         BNE   *+8                                                              
         MVI   PSEUDOPT,C'P'       ==> P (MCT)                                  
         CLI   PSEUDOPT,C'R'       IF RESPONSE                                  
         BNE   *+10                                                             
         MVC   QBOOK1,SPACES       SUPPRESS DEMOS                               
*                                                                               
         CLI   QBOOK1+3,C'-'       IS BOOK 'ACT-' FROM MM                       
         BNE   *+8                                                              
         MVI   QBOOK1+3,C' '       THEN BLANK OUT OR GETS WRONG DEMOS           
*                                                                               
         LA    R5,MGADWRK          BUILD MAKEGOOD ANALYSIS CONTROL BLK          
         USING MGABLKD,R5                                                       
         XC    MGABLKD(MGALNQ),MGABLKD                                          
         MVC   MGATABLN,=Y(L'MGATBL)                                            
         L     RF,=A(MGATBL)                                                    
         ST    RF,MGATAB                                                        
         MVC   MGAACOM,ACOMFACS                                                 
         MVC   MGAIO,=A(MGAIOW)                                                 
         MVC   MGABUY,ADBUY                                                     
         MVC   MGMSUNPK,MSUNPK                                                  
         MVC   MGUNTIME,UNTIME                                                  
         DROP  R5                                                               
*                                                                               
         XC    WORK,WORK           AGENCY LEVEL I2N PROF                        
         MVC   WORK(4),=C'SI2N'                                                 
         NI    WORK,X'BF'            MAKE SYS LOWER CASE                        
         MVC   WORK+4(2),AGY                                                    
         GOTO1 GETPROF,DMCB,(X'C0',WORK),WORK+40,DATAMGR                        
         CLI   WORK+43,C'Y'        NO EST=NO FOR UPDATIVE I2S                   
         BNE   REQF8                                                            
         CLC   QEST,=C'NO '        IF EST = NO                                  
         BNE   REQF8                                                            
         CLI   QOPT5,C'N'          AND REQUEST IS UPDATIVE                      
         BE    REQF8                                                            
         MVC   QEST,=C'ALL'        FORCE TO RUN AS EST=ALL                      
*                                                                               
REQF8    CLC   QAGY,=C'MC'         FOR LCI                                      
         BNE   REQF9                                                            
         MVC   WORK(4),QSTART                                                   
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 DATCON,DMCB,(0,WORK),(3,WORK+6)                                  
         CLC   WORK+6(2),=X'6604' NO UPDATIVE I2S FOR LCI<APR/02                
         BNL   REQF9                                                            
         MVI   RCWRITE,C'N'        THEN NO UPDATING                             
*                                                                               
REQF9    CLC   QAGY,=C'DU'         FOR MEDIAVEST                                
         BNE   REQF10                                                           
         CLI   QAREA+31,C'Z'       TEST A Z5 RUN                                
         BNE   REQF10                                                           
         CLI   NETPSW,C'Y'         IF NETPAK                                    
         BNE   REQF10                                                           
         MVC   QPRD,=C'POL'        ALWAYS POL                                   
         MVC   QEST,=C'NO '        ALWAYS EST=NO                                
         CLI   SVQAREA,C' '                                                     
         BNH   REQF9X                                                           
         CLC   QAREA(41),SVQAREA   SKIP DUPS -CHECK THRU MONTH                  
         BNE   REQF9X              OTHER DATA CHANGES LATER                     
         MVC   SVQAREA,QAREA       SAVE MODIFIED REQ FOR NEXT COMPARE           
         GOTO1 AENDREQ             DON'T BOTHER WITH DUPS                       
         DC    H'0'                                                             
REQF9X   MVC   SVQAREA,QAREA       SAVE MODIFIED REQ FOR NEXT COMPARE           
*                                                                               
REQF10   DS    0H                                                               
REQFX    B     EXIT                                                             
SVQAREA  DC    CL41' '                                                          
         EJECT                                                                  
**********************************************************************          
*        CLIENT FIRST                                                           
**********************************************************************          
CLTF     DS    0H                  FIRST FOR CLT                                
         CLC   QCLT,=C'ALL'                                                     
         BNE   CLTF02                                                           
         BAS   RE,REQFPR           FOR CLIENT=ALL DO REQF HERE                  
*                                                                               
CLTF02   DS    0H                                                               
         BRAS  RE,CFRST                                                         
         B     EXIT                                                             
         EJECT                                                                  
**********************************************************************          
*     REQLAST- MOST OF THE CODE HERE DEALS WITH REPORTING INVOICES              
*     THAT WERE SKIPPED OVER BECAUSE THERE WERE NO RELATED BUYS.                
*                                                                               
*     THERE ARE UNDOUBTEDLY SOME LAPSES INVOLVING CABLE NET                     
*     PROCESSING, PARTICULARLY IN CHECKING QSTA+4 FOR A / RATHER                
*     THAN THE STATION IN THE KEY FOR X'E8' (US ONLY NOT CANADA)                
*                                                                               
**********************************************************************          
REQL     MVI   REQLSW,C'Y'                                                      
         MVC   SAVEMODE,MODE       SAVE OFF THE MODE AS IT CAN CHANGE           
         CLI   NETPSW,C'Y'         IF NETPAK                                    
         BNE   REQL6                                                            
         BAS   RE,NETPROC                                                       
**NOOP   B     REQL10              **NOOP                                       
*                                                                               
REQL6    DS    0H                                                               
*                                  IF A ONE STATION REQUEST                     
*                                  AND NO BUY DATA, SPONSOR MAY NOT             
*                                  HAVE GIVEN ME CONTROL TO READ INVOIC         
*                                                                               
         CLC   QPROG(2),=C'U1'     TEST PAY PROG TA                             
         BE    REQL30              THEN SKIP CHECK FOR RNOS                     
*                                                                               
         CLI   QSTA+4,C'/'         FOR LOCAL CABLE                              
         BNE   REQL6B                                                           
         MVI   QCNALL,C'Y'                                                      
         CLI   QCBLNET,C' '        NO NETWORK                                   
         BNH   REQL6D                                                           
         CLC   QCBLNET(3),=C'ALL'  MEANS ALL                                    
         BE    REQL6D                                                           
*                                                                               
REQL6B   DS    0H                                                               
         MVI   QCNALL,C'N'                                                      
REQL6D   DS    0H                                                               
         CLC   QSTA(3),=C'ALL'     'ALL' STATIONS GETS DIFFERENT                
         BE    REQL10              TREATMENT                                    
         CLI   QMGR,C' '           BYPASS IF MKT GRPS                           
         BNE   REQL10                                                           
         CLI   RACTSW,0                                                         
         BNE   REQL50                                                           
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'S'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(5),QSTA                                                    
         CLI   QSTA+4,C'/'         / AND BLANK                                  
         BH    *+8                                                              
         MVI   KEY+6,C'T'          ARE T ON FILE                                
         MVC   KEY+7(2),QAGY                                                    
*                                                                               
         MVC   KEY+9(3),QCLT                                                    
         CLI   CQSW,C'A'           IF CLIENT=LAST                               
         BNE   *+10                                                             
         MVC   KEY+9(3),CLT        USE CURRENT CLIENT                           
*                                                                               
         GOTO1 READSTA                                                          
         L     R6,ADSTAT                                                        
         MVC   WORK(4),MKT                                                      
         TM    ACNFLAG,FNDMKT      FOUND MKT IN STATION EQ RECORD               
         BO    REQL6F                                                           
         MVC   WORK(4),SMKT-STAREC(R6)                                          
         CLI   QMKT,C'0'           IF SPECIFIC MARKET REQ                       
         BL    *+10                                                             
         MVC   WORK(4),QMKT        USE IT                                       
         MVC   MKT,WORK                                                         
REQL6F   DS    0H                                                               
         MVC   WORK+4(5),QSTA                                                   
         MVC   WORK+9(3),QCBLNET   CABLE NETWORK                                
         MVI   WORK+12,C' '                                                     
         GOTO1 MSPACK,DMCB,WORK,WORK+4,BMKTSTA                                  
         MVC   STA,WORK+4                                                       
         MVC   BIGSTA(8),WORK+4                                                 
         CLI   QSTA+4,C'/'         TEST CABLEPAK                                
         BE    REQL8               YES, LEAVE AS NNNN/XXX                       
*                                                                               
         MVI   BIGSTA+4,C'-'                                                    
         CLI   STA+4,C'D'          DIGITAL?                                     
         BNE   *+14                NO                                           
         MVC   BIGSTA+5(2),=C'DV'  YES - MOVE IN "DV"                           
         B     REQL8               DONE                                         
         CLI   STA+4,C'S'          STREAMING?                                   
         BNE   *+14                NO                                           
         MVC   BIGSTA+5(2),=C'SM'  YES - MOVE IN "SM"                           
         B     REQL8               DONE                                         
         CLI   STA+4,C'C'          STREAMING?                                   
         BNE   *+14                NO                                           
         MVC   BIGSTA+5(2),=C'CM'  YES - MOVE IN "CM"                           
         B     REQL8               DONE                                         
*                                                                               
         CLI   QMED,C'R'                                                        
         BNE   *+18                                                             
         MVC   BIGSTA+5(1),STA+4                                                
         MVI   BIGSTA+6,C'M'                                                    
         B     REQL8                                                            
         CLI   QMED,C'T'                                                        
         BNE   *+14                                                             
         MVC   BIGSTA+5(2),=C'TV'                                               
         B     REQL8                                                            
         MVC   BIGSTA+5(1),QMED                                                 
*                                                                               
REQL8    DS    0H                                                               
         MVI   KEY,C'0'            GET MARKET                                   
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'M'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),MKT                                                     
         MVC   KEY+6(2),QAGY                                                    
         GOTO1 READMKT                                                          
*                                                                               
         CLC   QPRD,=C'ALL'                                                     
         BNE   REQL8D                                                           
         MVI   BPRD,X'FF'          ALL PRODUCTS                                 
         MVC   PRD,=C'ALL'                                                      
         MVC   PRDNM,SPACES                                                     
*                                                                               
REQL8D   MVI   MODE,STALAST        RESET MODE SO HEADLINES WILL PRINT           
         LA    RF,STAFM2                                                        
         BAS   RE,NTR1                                                          
         LA    RF,STALM2           (RESETS HOMEMKT)                             
         BAS   RE,NTR1                                                          
*                                                                               
         CLI   RACTSW,0                                                         
         BNE   REQL50                                                           
         B     REQL40                                                           
*                                                                               
REQL10   DS    0H                  TRY FOR INVOICES FOR STATIONS                
*                                  WITH NO BUYS                                 
         MVC   SVQEST,QEST         SAVE REAL QEST                               
*                                                                               
         CLI   I2XPROF+1,C'Y'      PROFILE 'NO BUY' OPTION                      
         BE    REQL10B                                                          
         TM    CBLHOPT,CBLHALLQ    SET TO REP NETS SEPARATELY                   
         BO    REQL30              THEN SKIP CHECK                              
         CLI   QSTA+4,C'/'         BUT ALWAYS DO FOR CABLE/NET???               
         BNE   REQL30                                                           
*                                                                               
REQL10B  DS    0H                                                               
         CLC   =C'ALL',QSTA        ONLY IF STATION=ALL                          
         BE    REQL11                                                           
         CLI   QCNALL,C'Y'        OR CABLE NET = ALL                            
         BNE   REQL30                                                           
*                                                                               
REQL11   DS    0H                                                               
         CLI   QSTA+4,C'/'         UNLESS CABLENET                              
         BE    *+12                                                             
         CLI   QSTA,C'0'           SKIP IF SPECIFIC MKT GROUP REQ               
         BNL   REQL30              (MGR WOULD BE IN QSTA)                       
         MVI   QBYID,C' '          SUPPRESS ID OPTION                           
         CLC   QPRD,=C'ALL'                                                     
         BNE   REQL11B                                                          
         MVI   BPRD,X'FF'          ALL PRODUCTS                                 
         MVC   PRD,=C'ALL'                                                      
         MVC   PRDNM,SPACES                                                     
REQL11B  DS    0H                                                               
         MVI   PIGCTL,C'B'         AND PIGGIES                                  
         CLC   QEST,=C'ALL'                                                     
         BNE   *+10                                                             
         MVC   QEST,=C'NO '        AND ESTS                                     
         XC    SVSTN,SVSTN                                                      
         MVI   INVCKSW,C'Y'        SET DOING INVOICE CHECK                      
         MVC   SVTRACE,RCTRACE                                                  
*                                                                               
         XC    XKEY,XKEY                                                        
         XC    KEY,KEY                                                          
         LA    R7,KEY                                                           
         USING INVKEY,R7                                                        
         MVI   INVKEY,X'0B'                                                     
         MVC   INVKAM,BAGYMD                                                    
         CLI   QSTA+4,C'/'         FOR CABLENET                                 
         BNE   REQL12                                                           
         CLI   CANADSW,C'Y'        ONLY FOR US NOT CANADA                       
         BE    REQL12                                                           
*                                  LOOK ONLY AT CABLE OPERATORS                 
         MVI   INVKSTA,X'E8'       STARTING POINT FOR 'ALL'                     
         CLC   =C'ALL',QSTA                                                     
         BE    REQL12                                                           
         MVC   WORK,=C'0000'       ELSE START AT RIGHT OPERATOR                 
         MVC   WORK+4(5),QSTA                                                   
         MVC   WORK+9(3),SPACES                                                 
         GOTO1 MSPACK,DMCB,WORK,WORK+4,BMKTSTA                                  
         MVC   INVKSTA,BMKTSTA+2                                                
*                                                                               
REQL12   DS    0H                                                               
****************SKIP READING OF OLD INVOICES*************************           
***********************************************************************         
*        NINV REC READ                                                          
***********************************************************************         
         SPACE 2                                                                
RQL20    DS    0H                                                               
         MVC   RCTRACE,SVTRACE     RESTORE TRACE                                
         XC    SVIKEY,SVIKEY                                                    
         LA    R7,XKEY                                                          
         USING SNVKEYD,R7                                                       
         MVI   SNVKTYPE,SNVKTYPQ                                                
         MVI   SNVKSUB,SNVKSUBQ                                                 
         MVC   SNVKAM,BAGYMD                                                    
         MVC   SNVKCLT,BCLT                                                     
*                                                                               
         CLI   QSTA+4,C'/'         FOR CABLENET                                 
         BNE   RQL22                                                            
         CLI   CANADSW,C'Y'        ONLY FOR US NOT CANADA                       
         BE    RQL22                                                            
*                                  LOOK ONLY AT CABLE OPERATORS                 
         MVI   SNVKSTA,X'E8'       STARTING POINT FOR 'ALL'                     
         CLC   =C'ALL',QSTA                                                     
         BE    RQL22                                                            
         MVC   WORK,=C'0000'       ELSE START AT RIGHT OPERATOR                 
         MVC   WORK+4(5),QSTA                                                   
         MVC   WORK+9(3),SPACES                                                 
         GOTO1 MSPACK,DMCB,WORK,WORK+4,BMKTSTA                                  
         MVC   SNVKSTA,BMKTSTA+2                                                
*                                                                               
RQL22    DS    0H                                                               
         MVC   XKEYSAVE,XKEY                                                    
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR',XKEY,XKEY                     
         B     RQL22D                                                           
*                                                                               
RQL22B   DS    0H                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRSEQ',=C'XSPDIR',XKEY,XKEY                     
*                                                                               
RQL22D   DS    0H                                                               
         CLC   SVIKEY(10),XKEY     IF SAME AS PREV THRU MOS, SKIP               
         BE    RQL22B              SKIP, DON'T NEED IT NOW                      
         MVC   SVIKEY,XKEY         SAVE INVOICE KEY                             
         CLC   XKEY(5),XKEYSAVE    TEST THRU CLIENT                             
         BNE   REQL30              NO, DONE                                     
         MVC   HALF,SNVKMOS                                                     
         XC    HALF,=X'FFFF'       COMPLEMENT                                   
         CLC   HALF,BQENDP         END DATE                                     
         BH    RQL22B                                                           
         CLC   HALF,BQSTARTP       START DATE                                   
         BL    RQL22B                                                           
*                                                                               
         MVC   FULL(3),SNVKSTA                                                  
         CLI   CANADSW,C'Y'        ONLY FOR US NOT CANADA                       
         BE    REQL12J                                                          
         CLI   SNVKSTA,X'E8'       FOR CABLE NET                                
         BL    REQL12J                                                          
         CLI   QCBLNET,C' '        OK IF NOT 'ALL'                              
         BNH   *+14                                                             
         CLC   QCBLNET,=C'ALL'     OK IF NOT 'ALL'                              
         BNE   REQL12J                                                          
         NI    FULL+2,X'80'        ELSE CLEAR OUT NET BEFORE COMPARE            
         MVC   DUB(3),BMKTSTA+2                                                 
         NI    DUB+2,X'80'                                                      
         CLC   FULL(3),DUB                                                      
         BNE   REQL30                                                           
*                                                                               
REQL12J  DS    0H                                                               
         CLC   FULL(3),SVSTN                                                    
         BE    RQL22B                                                           
*                                                                               
         MVC   SVSTN,FULL                                                       
         MVC   WORK(3),FULL                                                     
         GOTO1 BINSRCH,STNLPARS,WORK                                            
         CLI   0(R1),1             TEST FOUND                                   
         BNE   RQL22B              YES- BYPASS                                  
*                                                                               
         MVC   SVKEY,KEY                                                        
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'S'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   WORK+10(20),SPACES                                               
         GOTO1 MSUNPK,DMCB,(X'80',WORK-2),FULL,WORK+10                          
         CLI   WORK+10+4,C' '                                                   
         BH    *+8                                                              
         MVI   WORK+10+4,C'T'                                                   
*                                                                               
         CLI   CANADSW,C'Y'        ONLY FOR US NOT CANADA                       
         BE    *+16                                                             
         CLI   WORK,X'E8'         LOCAL CABLE?                                  
         BL    *+8                                                              
         MVI   WORK+10+4,C'/'      MSUNPK FORGETS THE /                         
*                                                                               
         MVC   KEY+2(5),WORK+10                                                 
         CLI   KEY+6,C'/'                                                       
         BH    *+10                                                             
         MVC   KEY+6(1),QMED                                                    
         MVC   KEY+7(2),QAGY                                                    
*                                                                               
         MVC   KEY+9(3),QCLT                                                    
         CLI   CQSW,C'A'           IF CLIENT=ALL                                
         BNE   *+10                                                             
         MVC   KEY+9(3),CLT        USE CURRENT CLIENT                           
                                                                                
         GOTO1 READSTA                                                          
         L     R6,ADSTAT                                                        
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   REQL12K             NO                                           
         CLI   QCOMPARE,X'40'      ANY STATION TYPE FILTER?                     
         BNH   REQL12K             NO                                           
         CLC   QCOMPARE,SPTYPE-STAREC(R6)      MATCH ON STA TYPE?               
         BNE   RQL22B              NO, NEXT INVOICE                             
*                                                                               
REQL12K  CLC   =C'ALL',QMKT        UNLESS ALL MARKETS                           
         BE    REQL13                                                           
         CLI   QMKT,C' '                                                        
         BNH   REQL13                                                           
         CLC   QMKT,SMKT-STAREC(R6)  TEST STATION IN REQD MARKET                
         BNE   RQL22B                NO, NEXT INVOICE                           
*                                                                               
REQL13   DS    0H                                                               
         MVC   WORK(4),MKT                                                      
         TM    ACNFLAG,FNDMKT      FOUND MKT IN STATION EQ RECORD               
         BO    *+10                                                             
         MVC   WORK(4),SMKT-STAREC(R6)                                          
         GOTO1 MSPACK,DMCB,WORK,WORK+10,BMKTSTA                                 
         MVC   STA,WORK+10                                                      
         MVC   BIGSTA,WORK+10                                                   
         CLI   BIGSTA+4,C'/'       TEST CABLE PAK                               
         BE    REQL14              YES, LEAVE AS NNNN/XXX                       
*                                                                               
         MVI   BIGSTA+4,C'-'                                                    
         CLI   STA+4,C'D'          DIGITAL?                                     
         BNE   *+12                NO                                           
         MVI   BIGSTA+5,C'D'       YES - MOVE IN "D"                            
         B     REQL14              DONE                                         
         CLI   STA+4,C'S'          STREAMING?                                   
         BNE   *+12                NO                                           
         MVI   BIGSTA+5,C'S'       YES - MOVE IN "S"                            
         B     REQL14              DONE                                         
         CLI   STA+4,C'C'          STREAMING?                                   
         BNE   *+12                NO                                           
         MVI   BIGSTA+5,C'C'       YES - MOVE IN "C"                            
         B     REQL14              DONE                                         
*                                                                               
         CLI   QMED,C'R'                                                        
         BNE   *+18                                                             
         MVC   BIGSTA+5(1),STA+4                                                
         MVI   BIGSTA+6,C'M'                                                    
         B     REQL14                                                           
         CLI   QMED,C'T'                                                        
         BNE   *+14                                                             
         MVC   BIGSTA+5(2),=C'TV'                                               
         B     REQL14                                                           
         MVC   BIGSTA+5(1),QMED                                                 
*                                                                               
REQL14   DS    0H                                                               
         MVI   KEY,C'0'            GET MARKET                                   
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'M'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),MKT                                                     
         TM    ACNFLAG,FNDMKT      FOUND MKT IN STATION EQ RECORD               
         BO    *+10                                                             
         MVC   KEY+2(4),SMKT-STAREC(R6)                                         
         MVC   KEY+6(2),QAGY                                                    
         GOTO1 READMKT                                                          
*                                                                               
         MVC   KEY,SVKEY                                                        
         MVI   MODE,STALAST        RESET MODE SO HEADLINES WILL PRINT           
         LA    RF,STAF00                                                        
         BAS   RE,NTR1                                                          
*                                                                               
         GOTO1 AINVBLD             GET INVOICES                                 
         BRAS  RE,ERRTST                                                        
         BNE   REQL50                                                           
         CLC   AFINV,ALINV         TEST ANY INVOICES                            
         BNL   REQL28                                                           
*                                                                               
         LA    RF,STAL0                                                         
         BAS   RE,NTR1                                                          
*                                                                               
REQL28   DS    0H                                                               
         CLI   XKEY,0              IF DOING NEW INVOICES                        
         BE    REQL29                                                           
         MVC   XKEY,SVIKEY                                                      
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'XSPDIR',XKEY,XKEY                     
         B     RQL22B                                                           
*                                                                               
REQL29   DS    0H                                                               
         MVC   KEY,SVIKEY          RESTORE INVOICE KEY                          
         GOTO1 HIGH                                                             
         B     RQL22B              NEXT STATION                                 
*                                                                               
REQL30   DS    0H                                                               
         CLI   I2XPROF+1,C'Y'      PROFILE 'NO BUY' OPTION                      
         BNE   *+20                                                             
         CLC   QEST,=C'NO '        IF WE SWITCHED QEST TO LOOK FOR INV          
         BNE   *+10                   WITH NO BUYS - MOVE BACK                  
         MVC   QEST,SVQEST                                                      
*                                                                               
         CLI   RACTSW,0            WAS THERE ANY ACTIVITY?                      
         BNE   REQL50                                                           
         DROP  R7                                                               
*                                                                               
REQL40   CLI   SAVEMODE,REQLAST    **NO DATA** MESSAGE ONLY                     
         BNE   REQL50                AT REQLAST                                 
         CLI   CQSW,C'A'           BUT DON'T BOTHER IF 'ALL' CLIENTS            
         BE    REQL50                                                           
*                                                                               
         MVI   PAGSW,0                                                          
         MVI   SKIPSPEC,C'Y'                                                    
         MVI   FORCEHED,C'P'                                                    
         MVC   HEAD7,SPACES        CLEAR PAYEE NAME                             
         MVC   HEAD8,SPACES                                                     
         MVC   P(80),QAREA                                                      
         MVC   P+85(21),=C'**NO DATA GENERATED**'                               
         GOTO1 AIRPRT                                                           
*                                                                               
REQL50   DS    0H                                                               
*REQL50   CLI   SAVEMODE,REQLAST    REALLY REQUEST LAST MODE?                   
***      BNE   *+8                 NO - DON'T FREE BUFFER STORAGE YET           
***      BRAS  RE,FREEBUFF                                                      
         B     EXIT                                                             
NTR1     NTR1                                                                   
*                                                                               
         BR    RF                                                               
***********************************************************************         
*        PRD FIRST                                                              
***********************************************************************         
PRDF     DS    0H                                                               
         CLC   =C'ALL',QEST        UNLESS EST=ALL                               
         BE    EXIT                                                             
         MVI   NUDONE,C'N'         RESET NETNU SWITCH                           
         B     EXIT                                                             
***********************************************************************         
*        PRD LAST                                                               
***********************************************************************         
PRDL     DS    0H                                                               
         CLI   NETPSW,C'Y'         IF NETPAK                                    
         BNE   EXIT                                                             
         CLC   =C'ALL',QEST        AND NOT EST=ALL                              
         BE    EXIT                                                             
         BAS   RE,NETPROC          NETPAK PROCESS                               
         B     EXIT                                                             
***********************************************************************         
*        EST LAST                                                               
***********************************************************************         
ESTL     DS    0H                                                               
         CLI   NETPSW,C'Y'         IF NETPAK                                    
         BNE   EXIT                                                             
         CLC   =C'ALL',QEST        AND EST=ALL                                  
         BNE   EXIT                                                             
         BAS   RE,NETPROC          NETPAK PROCESS                               
         B     EXIT                                                             
***********************************************************************         
*        EST FIRST                                                              
***********************************************************************         
ESTF     DS    0H                                                               
         CLI   MODE,CLTLAST        IF HERE AT CLTLAST                           
         BNE   ESTF1                                                            
         CLI   CQSW,C'A'            DO NOTHING UNLESS 'ALL' CLIENTS             
         BNE   EXIT                                                             
*                                                                               
ESTF1    DS    0H                                                               
*                                                                               
         CLI   MEDPRDSW,0          A FIRST TIME SW FOR DATES AND PRD RD         
         BNE   ESTF35                                                           
         MVI   MEDPRDSW,1                                                       
*                                  DATES                                        
         MVC   WORK(12),QSTART                                                  
         MVI   MONSW,C'M'                                                       
         CLI   QSTART+4,C' '                                                    
         BE    ESTF2                                                            
         MVI   MONSW,C' '                                                       
         CLI   QEND,C' '                                                        
         BNE   *+10                                                             
         MVC   WORK+6(6),WORK                                                   
         GOTO1 GETBROAD,DMCB,WORK,WORK+12                                       
         GOTO1 DATCON,DMCB,WORK+12,(2,BRDMON)                                   
         B     ESTF6                                                            
*                                                                               
ESTF2    DS    0H                                                               
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 MOBILE,DMCB,(1,WORK),(1,WORK+12)                                 
         MVC   BRDMON,WORK+12                                                   
*                                  CALENDAR VS BROADCAST                        
         MVC   BYTE,Q2USER+1       TRY REQUEST FIRST                            
         CLI   BYTE,C' '                                                        
         BH    ESTF3                                                            
         MVC   BYTE,PROGPROF+9     THEN I2 PROFILE                              
*                                                                               
ESTF3    DS    0H                                                               
         CLI   BYTE,C'C'           TEST CALENDAR MONTH                          
         BNE   ESTF5                                                            
         GOTO1 (RF),(R1),,(3,WORK+12)     GET CALENDAR MONTH START-END          
*                                                                               
*        NOTE- SHOULD BRDMON BE RESET HERE? IT NEVER HAS BEEN.                  
*                                                                               
***      B     *+10                PATCH TO TRY IT.                             
***      MVC   BRDMON,WORK+12                                                   
*                                                                               
ESTF5    DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,WORK+12),WORK                                     
         GOTO1 (RF),(R1),(2,WORK+14),WORK+6                                     
ESTF6    DS    0H                                                               
         MVC   WORK+12(12),WORK                                                 
*                                  MONLIST MUST START WITH MONDAY               
         GOTO1 GETDAY,DMCB,WORK,FULL                                            
         LLC   R2,DMCB                                                          
         BCTR  R2,R0                                                            
         LCR   R2,R2                                                            
         GOTO1 ADDAY,DMCB,WORK+12,WORK+12,(R2)                                  
         GOTO1 MOBILE,(R1),(54,WORK+12),(5,MONLST)                              
*                                                                               
         MVI   MULTIMON,C'N'                                                    
         CLI   DMCB,6              IF MORE THAN 6 WEEKS                         
         BNH   *+8                                                              
         MVI   MULTIMON,C'Y'       SET DOING MULTIPLE MONTHS                    
*                                                                               
         CLI   DMCB,53                                                          
         BNH   ESTF7                                                            
*                                                                               
         MVC   P(80),QAREA                                                      
         MVC   P2(42),=C'**REQ PERIOD EXCEEDS ONE YEAR - BYPASSED**'            
         GOTO1 REPORT                                                           
***      BRAS  RE,FREEBUFF                                                      
         GOTO1 AENDREQ                                                          
*                                                                               
ESTF7    DS    0H                                                               
         MVC   QSTART(12),WORK                                                  
         GOTO1 MEDPRDRD,DMCB,(RA)                                               
ESTF8    DS    0H                                                               
*                             MEDDATE WILL SET BQSTARTP AND BQENDP              
         GOTO1 MEDDATE,DMCB,(RA)                                                
*                                                                               
         GOTO1 DATCON,DMCB,(2,BQSTARTP),DUB  GET PREVIOUS WEEK START            
         GOTO1 ADDAY,(R1),DUB,DUB,-7         FOR OOW CHECK LESS 7 DAYS          
         GOTO1 DATCON,(R1),DUB,(2,SVIDFILT)                                     
         MVC   SVIDFILT+2(2),BQENDP                                             
         CLC   BQSTARTP,BRDMON     IF START DATE = START OF MONTH               
         BNE   ESTF9                                                            
         MVC   PREVWKP,SVIDFILT    PREVIOUS WEEK                                
*                                                                               
ESTF9    DS    0H                  PROCESS OPTIONS                              
         OC    PROGPROF,PROGPROF                                                
         BNZ   *+10                                                             
         MVC   PROGPROF,DFLTPROF                                                
*                                  POSTING OPT                                  
         MVC   PSTOPT,PROGPROF+1                                                
         CLI   QOPT5,C' '                                                       
         BE    *+10                                                             
         MVC   PSTOPT,QOPT5                                                     
         CLI   I0PROF+1,C'Y'       TEST IF POSTING OK FOR RADIO                 
         BE    ESTF10              YES                                          
         CLI   QMED,C'R'           NO, NO POSTING FOR RADIO                     
         BNE   ESTF10                                                           
         MVI   PSTOPT,C'N'                                                      
*                                                                               
ESTF10   CLC   QAGY,=C'MC'         LCINY                                        
         BNE   ESTF12                                                           
         CLI   RCWRITE,C'N'        NON UPDATIVE                                 
         BNE   *+8                                                              
         MVI   PSTOPT,C'N'         SET TO NOT POST                              
*                                                                               
ESTF12   OC    I2APROF+9(2),I2APROF+9  EFFECTIVE DATE FOR POST LOCK             
         BZ    ESTF14                                                           
         LLC   R1,I2APROF+9                                                     
         CLI   I2APROF+9,80          IF YEAR < 80 ADD 100 FOR CENTURY           
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,I2APROF+9                                                     
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2APROF+9   IS MONTH OF REQ AFTER EFF DATE               
         BH    ESTF14              YES - CONTINUE                               
         MVI   PSTOPT,C'L'         EQUAL OR BEFORE = NO POST AFFIDS             
*                                                                               
ESTF14   DS    0H                  TIME LEEWAY                                  
         XC    TIMOPT1(4),TIMOPT1                                               
         MVC   TIMOPT1+1(1),PROGPROF   BEFORE AND AFTER                         
         MVC   TIMOPT2+1(1),PROGPROF   AFTER ONLY                               
         CLI   I2XPROF+13,0        TEST ANY SPECIAL FOR AFTER                   
         BE    ESTF16              NO                                           
         MVC   TIMOPT2+1(1),I2XPROF+13                                          
         CLI   I2XPROF+13,255      255=0                                        
         BNE   *+8                                                              
         MVI   TIMOPT2+1,0                                                      
*                                                                               
ESTF16   OC    I2ZPROF+8(2),I2ZPROF+8    EFFECTIVE DATE FOR NEW LEEWAY          
         BZ    ESTF18                                                           
         LLC   R1,I2ZPROF+8                                                     
         CLI   I2ZPROF+8,80          IF YEAR < 80 ADD 100 FOR CENTURY           
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,I2ZPROF+8                                                     
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2ZPROF+8   IS MONTH OF REQ BEFORE EFF DATE              
         BL    ESTF18              YES THEN DON'T USE THIS LEEWAY               
         MVC   TIMOPT1+1(1),I2ZPROF+7  BEFORE AND AFTER USE NEW LEEWAY          
         MVC   TIMOPT2+1(1),I2ZPROF+7                                           
*                                                                               
         CLI   I2ZPROF+14,0        TEST ANY SPECIAL FOR AFTER                   
         BE    ESTF18              NO - THEN USE REG LEEWAY                     
         MVC   TIMOPT2+1(1),I2ZPROF+14                                          
         CLI   I2ZPROF+14,255      255=0                                        
         BNE   *+8                                                              
         MVI   TIMOPT2+1,0                                                      
*                                                                               
ESTF18   MVI   LENLWAY,C'N'                                                     
         OC    I2BPROF+11(2),I2BPROF+11  HAVE YEAR/MON FOR LEN LEEWAY?          
         BZ    ESTF19                    NO                                     
         LLC   R1,I2BPROF+11                                                    
         CLI   I2BPROF+11,80       IF YEAR < 80 ADD 100 FOR CENTURY             
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,I2BPROF+11                                                    
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2BPROF+11  IS MONTH OF REQ BEFORE EFF DATE              
         BL    ESTF19              YES THEN DON'T                               
         MVI   LENLWAY,C'Y'        HONOR LENGTH LEEWAY                          
*                                                                               
ESTF19   MVC   COSTTOL,I2CPROF+10  COST TOLERANCE                               
         OC    I2CPROF+11(2),I2CPROF+11  EFF DATE FOR COST TOLERANCE?           
         BZ    ESTF19A             NO                                           
         LLC   R1,I2CPROF+11                                                    
         CLI   I2CPROF+11,80       IF YEAR < 80 ADD 100 FOR CENTURY             
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,I2CPROF+11                                                    
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2CPROF+11  IS MONTH OF REQ BEFORE EFF DATE              
         BNL   ESTF19A             NO - HONOR COST TOLERNACE                    
         MVI   COSTTOL,0           YES - DON'T HONOR COST TOLERANCE             
*                                                                               
ESTF19A  OC    I2SPROF+3(2),I2SPROF+3 EFF DATE FOR SEPARATION?                  
         BZ    ESTF19B             NO                                           
         LLC   R1,I2SPROF+3        EFFECTIVE YEAR                               
         CLI   I2SPROF+3,80        YEAR < 80?                                   
         BH    *+8                 NO                                           
         AHI   R1,100              YES - ADD 100 FOR CENTURY                    
         STC   R1,I2SPROF+3        UPDATE EFFECTIVE YEAR                        
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2SPROF+3   IS MONTH OF REQ BEFORE EFF DATE              
         BNL   ESTF19B             NO - HONOR SEPARATION                        
         MVI   INTCPI,0            PRIMARY INTERVAL = 0                         
*                                                                               
ESTF19B  MVC   COSTSUP,QOPT5+2     COST SUPPRESS OPTION                         
         CLI   COSTSUP,C' '                                                     
         BH    *+8                                                              
         MVI   COSTSUP,C'N'                                                     
         MVC   RCSPACNG,PROGPROF+3                                              
         CLI   QOPT3,C' '                                                       
         BE    *+10                                                             
         MVC   RCSPACNG,QOPT3                                                   
         NI    RCSPACNG,X'0F'                                                   
*                                                                               
ESTF20   DS    0H                                                               
         MVI   NOIMR,C'Y'          SET TO SUPPRESS MATCHES                      
         CLI   QOPT4,C'S'          IF SUMMARIES ONLY                            
         BE    ESTF22                                                           
         CLI   QOPT4,C'A'          OR DISCREPANT SUMMARIES ONLY                 
         BE    ESTF22                                                           
         CLI   QOPT1,C'F'          OR FILM REPORTS ONLY                         
         BE    ESTF22                                                           
         CLI   QOPT1,C'X'                                                       
         BE    ESTF22                                                           
         MVI   NOIMR,C'N'                                                       
*                                                                               
ESTF22   DS    0H                                                               
         CLI   NOIMR,C'Y'          IF NO MATCHES                                
         BNE   *+10                                                             
         MVC   QBOOK1,SPACES       THEN NO DEMOS                                
         MVI   SPCONLY,C'N'        SPECIAL ONLY SWITCH                          
         MVI   SPCRRTE,C'N'        RERATE SWITCH                                
         CLI   QOPT4,C' '          NOT ONLY AND NO RE-RATE                      
         BE    ESTF26                                                           
         CLI   QOPT4,C'S'          SUMMARIES OPT                                
         BE    ESTF26                                                           
         CLI   QOPT4,C'A'          DISCREPANT SUMMARIES ONLY                    
         BE    ESTF26                                                           
         CLI   QOPT4,C'D'          DISCREPANCY OPT                              
         BE    ESTF26                                                           
         CLI   QOPT4,C'B'          DISCREPANCY OPT                              
         BE    ESTF26                                                           
         MVI   SPCRRTE,C'Y'                                                     
         CLI   QOPT4,C'2'          NOT ONLY BUT YES RERATE                      
         BE    ESTF26                                                           
         MVI   SPCONLY,C'Y'                                                     
         CLI   QOPT4,C'3'          ONLY AND RERATE                              
         BE    ESTF26                                                           
         MVI   SPCRRTE,C'N'        ONLY BUT NO RERATE (C'1')                    
*                                  EST-LINE CONTROL                             
ESTF26   DS    0H                                                               
         MVC   ESTLOPT,PROGPROF+2                                               
         CLI   QOPT2,C' '                                                       
         BE    *+10                                                             
         MVC   ESTLOPT,QOPT2                                                    
*                                                                               
         XC    ROTPCTL,ROTPCTL     ROTATION PCT FOR BUYLINE                     
         MVC   ROTPCTL+3(1),PROGPROF+4                                          
         XC    ROTPCTW,ROTPCTW     ROTATION PCT FOR WEEK                        
         MVC   ROTPCTW+3(1),I2XPROF+9                                           
*                                                                               
         MVC   COMOPT,PROGPROF+5   COMMENT PRINT OPTION                         
         CLI   NOIMR,C'Y'          IF NO MATCHES                                
         BNE   ESTF28                                                           
         MVI   COMOPT,C'N'         NO COMMENTS                                  
         MVI   PROGOPT,C'N'        AND NO PROGNAMES                             
ESTF28   DS    0H                                                               
         MVC   PAYOPT,PROGPROF+6   PAYEE OPTION                                 
         MVC   ONROPT,PROGPROF+7   OPT TO PRINT ONR'S TOGETHER                  
         CLI   MDETOPT,C'N'        IF NOT SHOWING MATCHED DETAILS               
         BNE   *+8                                                              
         MVI   ONROPT,C'Y'          DO ONR'S TOGETHER                           
         MVI   TAXOPT,C'Y'                                                      
         MVC   SREPOPT,PROGPROF+12   SYND REP = $0 INVS OPT                     
         MVC   DSUMOPT,PROGPROF+10 OPT FOR EXTRA DISCREPANCY SUMMARY            
         CLI   DSUMOPT,0                                                        
         BNE   *+8                                                              
         MVI   DSUMOPT,C'N'        DEFAULT IS NO                                
         CLI   DSUMOPT,C'N'                                                     
         BNE   ESTF30                                                           
         CLI   QOPT4,C'A'          IF REQUEST CALLS FOR SEP DISCREP             
         BNE   *+8                 RPT THEN FORCE DSUMOPT TO Y (IF N)           
         MVI   DSUMOPT,C'Y'                                                     
         CLI   QOPT4,C'B'                                                       
         BNE   *+8                                                              
         MVI   DSUMOPT,C'Y'                                                     
*                                                                               
ESTF30   DS    0H                                                               
         MVC   PDOPT,PROGPROF+11                                                
*                                  SET PARTIAL MATCH OPTS                       
         LA    R4,QAFFIL           USE 4 CHARS HERE                             
         MVI   MISPASS,0           CLEAR BETWEEN REQUESTS!                      
         MVI   UPDERROR,0          CLEAR BETWEEN REQUESTS!                      
         XC    ERRLINES,ERRLINES                                                
         XC    MISLIST,MISLIST                                                  
         MVI   MISMOPT,C'N'                                                     
         CLI   PAYTA,C'Y'                                                       
         BE    ESTF32                                                           
         CLI   0(R4),C' '          NO PARTIAL MATCHES                           
         BE    ESTF32                                                           
         MVI   MISMOPT,C'Y'                                                     
         MVC   MISLIST(4),0(R4)    SET LIST FROM Q                              
         CLI   0(R4),C'*'          * MEANS 'ALL' - USE LIST                     
         BNE   *+10                                                             
         MVC   MISLIST,DFLTLIST                                                 
*                                                                               
ESTF32   DS    0H                                                               
*                                                                               
ESTF35   DS    0H                                                               
         CLI   WIPWSW,C'Y'                                                      
         BNE   ESTF40                                                           
         CLC   =C'ALL',QSTA        NOT IF STATION=ALL                           
         BE    ESTF40                                                           
         CLI   BEST,0              OR MULTI-EST                                 
         BE    ESTF40                                                           
         CLI   BESTEND,0                                                        
         BH    ESTF40                                                           
*                                                                               
         BRAS  RE,CHKPWMKT                                                      
*                                                                               
ESTF40   DS    0H                  ESTF MAY BE CALLED WITH OTHER MODE           
         CLI   MODE,REQLAST                                                     
         BE    REQL                                                             
         CLI   CQSW,C'A'           SKIP REQLAST HERE IF 'ALL' CLIENTS           
         BNE   ESTF50                                                           
         CLI   MODE,CLTLAST        AND CLIENT LAST                              
         BE    REQL                                                             
*                                                                               
ESTF50   DS    0H                                                               
         MVI   NUDONE,C'N'         RESET NETNU SWITCH                           
         B     EXIT                                                             
*                                                                               
DFLTPROF DS    0C                                                               
         DC    AL1(2)              TIME OPT                                     
         DC    C'Y'                POST AFFIDS                                  
         DC    C'Y'                EST-LIN ORDER                                
         DC    C'1'                SPACING                                      
         DC    AL1(0)              ROTATION CHECKING PCT                        
         DC    11X'00'             SPARE                                        
*                                                                               
DFLTLIST DC    C'TCPWAL      '                                                  
*                                                                               
***********************************************************************         
*        CABLE HEAD FIRST                                                       
***********************************************************************         
CBHF     DS    0H                                                               
         CLI   I2ZPROF+4,C'A'      REPORT SEP NET FOR QSTA=ALL OR MGRP?         
         BNE   CBHF05              NO                                           
         CLI   QMGR,C' '           MGROUP REQUEST?                              
         BNE   *+14                YES                                          
         CLC   =C'ALL  ',QSTA      ALL STATION REQ?                             
         BNE   CBHF05              NO                                           
         OI    CBLHOPT,CBLHALLQ    YES - FORCE TO REPORT SEPARATELY             
         OI    CBLHOPT,CBLHSYSQ    THIS IS STA 'ALL' REQ, NOT 'ALL /'!          
         CLI   QBYID,C'Y'          BY CONTRACT ID'S?                            
         BE    CBHF10              YES - NEED TO KEEP RQOPTS_HDEND ON           
         NI    RQOPTS,X'FF'-RQOPTS_HDEND                                        
         B     CBHF10                                                           
*                                                                               
CBHF05   CLI   I2ZPROF+4,C'Y'      REPORT SEP NETWORK FOR QSTA=ALL /            
         BE    *+12                                                             
         CLI   I2ZPROF+4,C'A'      REPORT SEP NETWORK FOR QSTA=ALL /            
         BNE   CBHF10                                                           
         CLC   =C'ALL /',QSTA      AND AN ALL STATION REQ                       
         BNE   CBHF10                                                           
         MVI   QSTA+4,C' '         FORCE TO REPORT SEPARATELY                   
         OI    CBLHOPT,CBLHALLQ    SET TO REP NETS SEPARATELY                   
         NI    CBLHOPT,X'FF'-CBLHHDQ                                            
         CLI   QBYID,C'Y'          BY CONTRACT ID'S?                            
         BE    CBHF10              YES - NEED TO KEEP RQOPTS_HDEND ON           
         NI    RQOPTS,X'FF'-RQOPTS_HDEND                                        
*                                                                               
CBHF10   TM    CBLHOPT,CBLHNHAQ    UNLESS NEW MODE AND CBH AND ALL              
         BO    STAFM                                                            
         B     EXIT                SKIP                                         
*                                  STATION LAST                                 
***********************************************************************         
*        STATION FIRST                                                          
***********************************************************************         
STAF     CLC   =C'ALL',QSTA        ALL STATION REQUEST?                         
         BNE   STAFAB              NO                                           
         CLI   Q2USER+7,C'S'       ALL-SM REQUEST?                              
         BE    STAFAA              YES                                          
         CLI   Q2USER+7,C'D'       ALL-DV REQUEST?                              
         BE    STAFAA              YES                                          
         CLI   Q2USER+7,C'C'       ALL-CM REQUEST?                              
         BNE   STAFAB              NO                                           
*                                                                               
STAFAA   CLI   BIGSTA+4,C'/'       LOCAL CABLE REQUEST?                         
         BE    *+14                YES - BIGSTA+5 CAN HAVE "S" OR "D"!          
         CLC   BIGSTA+5(1),Q2USER+7 IS THIS A DV/SM STATION?                    
         BE    STAFAB              YES - DV/SM SO WE WANT IT                    
         MVI   MODE,STALAST        SKIP THIS STATION                            
         B     EXIT                EXIT - DON'T WANT THIS STATION               
*                                                                               
STAFAB   TM    CBLHOPT,CBLHNHAQ    IF NEW MODE AND CBH REQ AND ALL              
         BO    EXIT                NOTHING AT STAFRST                           
*                                  STATION FIRST                                
STAFM    DS    0H                                                               
         CLI   NETPSW,C'Y'         SKIP FOR NETPAK                              
         BE    EXIT                                                             
STAFM2   DS    0H                                                               
         MVI   SPILSW,C'N'                                                      
*                                  POST TO STATION LIST                         
         MVC   WORK(3),BMKTSTA+2                                                
*                                                                               
         CLI   WORK,X'E8'          AND HAVE A CABLE STATION                     
         BL    STAFM4                                                           
         NI    WORK+2,X'80'        STRIP NETWORK                                
*                                                                               
***      CLI   QMGR,C' '           MGROUP REQUEST                               
***      BNE   STAFM4              DO NOT SET CBLHOPT !                         
*                                                                               
         TM    CBLHOPT,CBLHALLQ    REPORT NETWORKS SEPARATELY                   
         BO    *+8                                                              
         OI    CBLHOPT,CBLHHDQ     SET PROCESSING CABLE - SYSCODE LEVEL         
*                                                                               
STAFM4   GOTO1 BINSRCH,STNLPARS,(1,WORK)                                        
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
STAF00   MVC   SVBUYID,SPACES      CLEAR SVBUYID IN CASE PREVIOUSLY SET         
         CLI   QBYID,C'Y'          IF BY CONTRACT ID'S                          
         BNE   STAF000                                                          
*                                                                               
         SR    RF,RF               GET LENGTH FOR BUY REC ID COMPARE            
         ICM   RF,1,BUYIDLN                                                     
         BNZ   *+8                                                              
         LA    RF,12               DEFAULT IS 12                                
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   SVBUYID,BUYID       SAVE BUYID                                   
*                                                                               
         OC    SVBUYID,SPACES                                                   
         L     R5,BUYLIST          AND ONLY FOR FIRST ID                        
         OC    1(12,R5),SPACES                                                  
         CLC   SVBUYID,1(R5)                                                    
         BNE   STAF0                                                            
*                                                                               
STAF000  L     R0,AIDLIST          CLEAR IDLIST                                 
         LHI   R1,IDLSTL*MAXIDS                                                 
         BAS   R2,EXMVCL                                                        
*                                                                               
         L     RE,AIDLIST                                                       
         MVC   0(12,RE),=C'**UNKNOWN** '   SET TO HANDLE 'NO ID' BUYS           
         LA    RE,IDLSTL(RE)                                                    
         ST    RE,NEXTID                                                        
         MVI   0(RE),X'FF'         SET EOL                                      
         MVI   RNOIDSW,C'N'        NOT YET DOING RNO ID'S                       
*                                                                               
STAF0    DS    0H                                                               
         LA    R0,CLRSTRT3                                                      
         L     R1,=A(IMRWORKX-CLRSTRT3)                                         
         BAS   R2,EXMVCL                                                        
*                                                                               
         L     R0,ABUFFER                                                       
         L     R1,BUFFLEN                                                       
         BAS   R2,EXMVCL                                                        
*                                                                               
         L     R0,AFLTTAB                                                       
         STCM  R0,15,ANXTCFLT         SET STARTING POINT                        
         LHI   R1,FLTTABL                                                       
         BAS   R2,EXMVCL                                                        
*                                                                               
         L     R0,APRDTAB                                                       
         STCM  R0,15,ANXTCPRD         SET STARTING POINT                        
         LHI   R1,PRDTABL                                                       
         BAS   R2,EXMVCL                                                        
*                                                                               
         CLI   NETPSW,C'Y'         SKIP FOR SPOTPAK                             
         BNE   STAF0A                                                           
         L     R0,APATREF          ONLY CLEAR FOR NETPAK                        
         LHI   R1,MGNAMTBL                                                      
         BAS   R2,EXMVCL                                                        
*                                                                               
STAF0A   L     RF,APIGLIST                                                      
         XC    0(256,RF),0(RF)                                                  
*                                                                               
         L     RE,ABUFFER                                                       
         ST    RE,AFBY                                                          
         ST    RE,ANXTBY                                                        
         BCTR  RE,R0                                                            
         ST    RE,ALBY                                                          
         XC    DEMPARS+8(4),DEMPARS+8      CLEAR DEM TAB                        
         XC    SREPPARS+8(4),SREPPARS+8    CLEAR SREP TAB                       
         XC    BUYRPARS+8(4),BUYRPARS+8                                         
*                                                                               
         MVC   ANXTCOM,ACOMTAB                                                  
         XC    TAXTOT,TAXTOT                                                    
         XC    VATTOT,VATTOT                                                    
         XC    PSTTOTS,PSTTOTS                                                  
         XC    EDCOST,EDCOST                                                    
         XC    EDNET,EDNET                                                      
         MVI   EDFLAG,0                                                         
         MVI   ORBSW,0             CLEAR ORBIT SWITCH                           
*                                                                               
         OC    FRSTDEM,FRSTDEM     SAVE DEMO FROM FIRST ESTIMATE                
         BNZ   *+14                                                             
         L     RF,ADEST                                                         
         MVC   FRSTDEM,EDEMOS-ESTHDR(RF)                                        
*                                                                               
         B     EXIT                                                             
*                                                                               
EXMVCL   SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         BR    R2                                                               
         EJECT                                                                  
***********************************************************************         
*        CABLE HEAD LAST                                                        
***********************************************************************         
CBHL     DS    0H                                                               
         CLC   =C'ALL  ',QSTA      ONLY FOR ALL STATIONS                        
         BNE   CBHL10                                                           
         CLI   CANADSW,C'Y'        ONLY FOR US NOT CANADA                       
         BE    CBHL10                                                           
         CLI   BSTA,X'E8'          CABLE STATION CURRENTLY                      
         BL    CBHL10                                                           
         TM    BSTA+2,X'7F'        BUYS BY NETWORK?                             
         BNZ   CBHL20              THEN BIGSTA IS CORRECT                       
**                                                                              
CBHL10   MVC   STA,SLSTATN         RESTORE STALAST VALUES BECAUSE               
         MVC   STAPRINT,SLSTAPRT   THEY MIGHT HAVE BEEN CLOBBERED               
         MVC   BIGSTA,SLBIGSTA     BETWEEN HERE AND STAL                        
*                                                                               
CBHL20   TM    CBLHOPT,CBLHALLQ    ARE WE REALLY DOING ALL/ SEP NTWKS           
         BO    EXIT                PROCESS AT STALAST MODE                      
         TM    CBLHOPT,CBLHNHAQ    UNLESS NEW MODE AND CBH REQ AND ALL          
         BO    STALM                                                            
         B     EXIT                SKIP                                         
***********************************************************************         
*        STATION LAST                                                           
***********************************************************************         
STAL     DS    0H                                                               
         CLI   STA+4,C'D'          DIGITAL?                                     
         BNE   *+8                 NO                                           
         MVI   BIGSTA+6,C'V'       YES - MOVE IN "V"                            
         CLI   STA+4,C'S'          STREAMING?                                   
         BNE   *+8                 NO                                           
         MVI   BIGSTA+6,C'M'       YES - MOVE IN "M"                            
         CLI   STA+4,C'C'          STREAMING?                                   
         BNE   *+10                NO                                           
         MVC   BIGSTA+4(3),=C'-CM' YES - MOVE IN "CM"                           
         MVC   SLSTATN,STA         SAVE STALAST VALUES BECAUSE                  
         MVC   SLSTAPRT,STAPRINT   THEY MIGHT GET LOST BETWEEN HERE             
         MVC   SLBIGSTA,BIGSTA     AND CBLH.                                    
*                                                                               
         TM    CBLHOPT,CBLHNHAQ    IF NEW MODE AND CBH REQ AND ALL              
         BO    EXIT                NOTHING AT STALAST                           
*                                                                               
STALM    DS    0H                                                               
         XC    HOMEMKT,HOMEMKT                                                  
         CLI   NETPSW,C'Y'         SKIP FOR NETPAK                              
         BE    EXIT                                                             
STALM2   DS    0H                                                               
         CLI   SPILSW,C'Y'            TEST SPILL-IN STATION                     
         BE    EXIT                   YES- SKIP                                 
*                                                                               
         L     RF,ADSTAT                                                        
         TM    ACNFLAG,FNDMKT      FOUND MKT IN STATION EQ RECORD               
         BO    *+12                                                             
         LA    RF,SMKT-STAREC(RF)                                               
         B     *+8                                                              
         LA    RF,MKT                                                           
         PACK  DUB,0(4,RF)                                                      
         CVB   R0,DUB                                                           
         STH   R0,HOMEMKT          SET HOME MARKET                              
*                                                                               
STAL0    DS    0H                                                               
         L     RF,ADSTAT                                                        
         USING STAREC,RF                                                        
         MVI   X,C'0'                                                           
         MVC   X+1(16),X                                                        
         MVC   X+2(3),RQREP                                                     
         CLI   Q2USER+6,C'Y'       NEGATIVE FILTER?                             
         BNE   *+10                NO                                           
         MVC   X+2(3),SPACES       YES - DON'T LOOK UP THIS REP!                
         CLC   X+2(3),SPACES       TEST SPECIAL REP REQ                         
         BH    STAL3               YES                                          
         CLI   PAYOPT,C'Y'                                                      
         BNE   STAL4                                                            
         CLC   SPAYREP,=3C'0'                                                   
         BNH   STAL4                                                            
*                                  REP                                          
         MVC   X+2(3),SPAYREP                                                   
STAL3    DS    0H                                                               
         MVI   X,C'R'                                                           
         MVC   X+1(1),STAKMED                                                   
         MVC   X+5(2),STAKAGY                                                   
         L     RF,ADREP                                                         
         CLC   X(15),0(RF)                                                      
         BE    STAL4                                                            
         MVC   WORK(64),KEY                                                     
         MVC   KEY(17),X                                                        
         GOTO1 READREP                                                          
         MVC   KEY(64),WORK                                                     
*                                  STATION ADDR                                 
STAL4    DS    0H                                                               
         L     RF,ADSTAT                                                        
         MVC   X(15),STAKEY                                                     
         MVI   X,C'A'                                                           
         MVC   X+9(3),=3C'0'       CLEAR CLIENT CODE                            
         L     RF,ADSTATAD                                                      
         CLC   X(15),0(RF)                                                      
         BE    STAL6                                                            
         MVC   WORK(64),KEY                                                     
         MVC   KEY(17),X                                                        
         MVI   DMOUTBTS,0          SET NO ERROR ON REC NOT FOUND                
         GOTO1 READSTAD                                                         
         MVI   DMOUTBTS,X'FF'                                                   
         TM    DMCB+8,X'10'        NO ADDRESS RECORD                            
         BZ    STAL4D                                                           
         L     RF,ADSTATAD                                                      
         MVC   0(L'ADDRREC,RF),SPACES                                           
STAL4D   DS    0H                                                               
         MVC   KEY(64),WORK                                                     
STAL6    DS    0H                                                               
         DROP  RF                                                               
*                                                                               
         CLI   INVCKSW,C'Y'        IF DOING INVOICE CHECK PASS                  
         BE    FD16                SKIP SORT,INVBLD, AND MATCH                  
*                                                                               
         L     R7,ALBY                                                          
         LA    R7,1(R7)                                                         
         S     R7,AFBY                                                          
         BNP   STAL8                                                            
         SR    R6,R6                                                            
         LA    R4,BYELEML                                                       
         DR    R6,R4               R7 = NO. OF BYELEMS                          
         LA    R0,BYLEN-BYSDT      KEY LEN                                      
         LA    R1,BYCBLNET-BYELEM  KEY DISP                                     
         CLI   ESTLOPT,C'Y'        OPT TO SORT BY EST-LINE (+CLBNET)            
         BE    STAL7D                                                           
         TM    CBLHOPT,CBLHNHQ     ALSO IF CBH REQ AND NEW MODE                 
         BO    STAL7D              NOTE- CBLNET IMPLIES EST-LIN SORT            
*                                                                               
STAL7    DS    0H                                                               
         LA    R0,BYLEN-BYSDT      KEY LEN                                      
         LA    R1,BYSDT-BYELEM     KEY DISP                                     
*                                                                               
STAL7D   DS    0H                                                               
         ST    R0,DMCB+12                                                       
         ST    R1,DMCB+16                                                       
         GOTO1 XSORT,DMCB,AFBY,(R7),(R4)                                        
*                                                                               
         XC    DATINBH,DATINBH                                                  
*                                                                               
*--------------------------------------------------------------                 
*        GET THE INVOICES                                                       
*--------------------------------------------------------------                 
STAL8    DS    0H                                                               
         GOTO1 AINVBLD                                                          
         BRAS  RE,ERRTST                                                        
         BNE   EXIT                                                             
*--------------------------------------------------------------                 
*        DO THE MATCHING !                                                      
*--------------------------------------------------------------                 
         GOTO1 AMATCH                                                           
*                                                                               
*--------------------------------------------------------------                 
*        BUILD FILM REPORT                                                      
*--------------------------------------------------------------                 
FD16     DS    0H                                                               
         MVC   SVBPRD2,BPRD2       SAVE BPRD2                                   
         L     R5,APIGLIST         LOOP THROUGH PIGLIST                         
         LA    R0,255                                                           
         CLI   PIGCTL,C'S'         IF NOT DOING PIGS SEPARATELY                 
         BE    *+8                 DO ONLY FIRST                                
         LA    R0,1                NOTE- FIRST IS ALWAYS ZERO AND               
         B     FD17B               WILL DO NON-PIGS (OR EVERYTHING              
*                                  IF NOT DOING PIGS SEPARATELY)                
FD17     DS    0H                                                               
         CLI   0(R5),0             TEST BRAND IN LIST                           
         BE    IM11F                                                            
FD17B    DS    0H                                                               
         MVC   PIGFILT,0(R5)       SET PIGGY FILTER                             
         MVC   BPRD2,0(R5)         AND SET BPRD2                                
         MVC   PRDC2,SPACES                                                     
         CLI   BPRD2,0                                                          
         BE    FD18F                                                            
*                                                                               
         L     RF,ADCLT                                                         
         LA    RF,CLIST-CLTHDR(RF)                                              
         LA    R1,220              220 PRODUCTS IN FIRST CLIST                  
*                                                                               
FD18     DS    0H                                                               
         CLI   3(RF),0             EOL                                          
         BNE   *+6                                                              
         DC    H'0'                PRD NOT IN CLTHDR                            
         CLC   BPRD2,3(RF)                                                      
         BE    FD18D                                                            
         LA    RF,4(RF)                                                         
         BCT   R1,FD18                                                          
*                                                                               
         CLI   NETPSW,C'Y'         TEST NETPAK                                  
         BE    *+6                 ONLY CLIST2 FOR NET                          
         DC    H'0'                                                             
*                                                                               
         L     RF,ADCLT                                                         
         LA    RF,CLIST2-CLTHDR(RF)                                             
         LA    R1,35               35 PRODUCTS IN CLIST2                        
FD18A    CLI   3(RF),0             EOL                                          
         BNE   *+6                                                              
         DC    H'0'                PRD NOT IN CLTHDR                            
         CLC   BPRD2,3(RF)                                                      
         BE    FD18D                                                            
         LA    RF,4(RF)                                                         
         BCT   R1,FD18A                                                         
         DC    H'0'                                                             
*                                                                               
FD18D    DS    0H                                                               
         MVC   PRDC2,0(RF)         SET PRD MNEMONIC                             
*                                                                               
FD18F    DS    0H                                                               
         MVI   FILMDONE,C'N'                                                    
         CLI   QOPT1,C'N'          TEST TO SUPPRESS FILM REPORT                 
         BE    FD20                                                             
         CLI   QOPT1,C'Y'          FORCE FILM REPORT                            
         BE    FD18G                                                            
         CLI   QOPT1,C'F'          ONLY FILM REPORT                             
         BE    FD18G                                                            
         CLI   QOPT1,C'E'          FILM REPORT IF ERROR                         
         BE    FD18G                                                            
         CLI   QOPT1,C'O'          FILM REPORT IF ERROR                         
         BE    FD18G                                                            
         CLI   QOPT1,C'X'          ONLY FILM REPORT AND ONLY ERRORS             
         BE    FD18G                                                            
         CLI   TRAFFRPT,C'Y'       ELSE TEST PROFILE                            
         BE    FD18G                                                            
         CLI   TRAFFRPT,C'E'                                                    
         BNE   FD20                                                             
FD18G    DS    0H                                                               
         CLC   QAGY,=C'DU'         FOR DU - SKIP FILM FOR N/CG4/NBC             
         BNE   FD18J               FOR AUG/04 - OLYMPICS TOO BIG                
         CLC   QMED(4),=C'NCG4'                                                 
         BNE   FD18J                                                            
         CLC   QSTA(4),=C'NBC '                                                 
         BNE   FD18J                                                            
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),=X'6808'                                                 
         BNE   FD18J                                                            
         MVI   QOPT1,C'N'          NO FILM REPORT                               
         B     FD20                                                             
*                                                                               
FD18J    MVC   FULL(3),BMKTSTA+2   SAVE REAL BSTA                               
         TM    CBLHOPT,CBLHNHAQ    IF CBH REQ AND NEW MODE                      
         BNO   FD19                AND 'ALL NETS'                               
         CLI   CANADSW,C'Y'        ONLY FOR US NOT CANADA                       
         BE    FD19                AND 'ALL NETS'                               
         CLI   FULL,X'E8'          AND HAVE A CABLE STATION                     
         BL    FD19                                                             
         NI    BMKTSTA+4,X'80'     CLEAR NETWORK - FOR FILM LOOKUP!!            
*                                                                               
FD19     GOTO1 AFILMTOT            FILM REPORT                                  
         MVC   BMKTSTA+2(3),FULL   RESET REAL BSTA                              
         MVI   FILMDONE,C'Y'       SET FILM REPORT DONE                         
         EJECT                                                                  
*--------------------------------------------------------------                 
*        CALL REPORT MODULE                                                     
*--------------------------------------------------------------                 
FD20     DS    0H                                                               
         GOTO1 AICSOLR                                                          
*                                                                               
*--------------------------------------------------------------                 
*        POST AFFIDS - SPOT (NETPAK DONE WHILE REPORTING)                       
*--------------------------------------------------------------                 
FD22     DS    0H                  POST AFFS                                    
         CLI   PIGFILT,0           ALL POSTING DONE ON FIRST PASS               
         BNE   IM8                                                              
         CLI   PSTOPT,C'N'                                                      
         BE    IM8                                                              
         CLI   PSTOPT,C'M'         M MEANS NO POSTING DUE TO BIG INV            
         BE    IM8                                AND UPD SOON                  
         CLI   PSTOPT,C'U'         U MEANS NO POSTING TO PREVENT                
         BE    IM8                                SRUPD00 DUMPS                 
         CLI   PSTOPT,C'X'         X MEANS NO POSTING DUE TO B0 PROF            
         BE    IM8                                                              
         CLI   PSTOPT,C'L'         L MEANS NO POSTING DUE TO I2A LOCK           
         BE    IM8                                                              
         CLI   NETPSW,C'Y'         TEST NETPAK                                  
         BE    IM8                                                              
         GOTO1 APOST               NO, USE ICSPOST                              
*                                                                               
*-----------------------------------------------------------------              
*        CALL MATCHMAKER MODULE - SPREPI2MM                                     
*        MOVED TO AFTER REPORT TO PICK UP HV ERRS                               
*        MOVED TO AFTER POST TO PICK UP BUY UPDATING ERRORS                     
*-----------------------------------------------------------------              
IM8      DS    0H                  CALL MM MODULE                               
         CLI   PSEUDOPT,C'N'       SKIP IF IN PSEUDO MODE                       
         BNE   IM9                                                              
         CLI   PSTOPT,C'N'         NO POSTING = NO MM                           
         BE    IM9                                                              
         CLI   PSTOPT,C'X'         X MEANS NO POSTING DUE TO B0 PROF            
         BE    IM9                                                              
         CLI   PSTOPT,C'L'         L MEANS NO POSTING DUE TO I2A LOCK           
         BE    IM9                                                              
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   IM8A                SPOT ALWAYS CALLS MM MODULE NOW              
         CLI   MKACTV,C'Y'         NETPAK STILL CHECKS PROFILE FOR MM           
         BNE   IM9                                                              
IM8A     GOTO1 =V(SPI2MM),DMCB,(C'I',0)  MATCHMAKER MODULE - INVOICE            
*                                                                               
*--------------------------------------------------------------                 
*        FILM REPORT                                                            
*--------------------------------------------------------------                 
IM9      DS    0H                  FILM REPORT                                  
         CLI   QOPT1,C'N'          TEST TO SUPPRESS FILM REPORT                 
         BE    IM10                                                             
         CLI   QOPT1,C'Y'          FORCE FILM REPORT                            
         BE    IM9G                                                             
         CLI   QOPT1,C'F'          ONLY FILM REPORT                             
         BE    IM9G                                                             
         CLI   QOPT1,C'E'          ONLY IF ERRORS                               
         BE    IM9D                                                             
         CLI   QOPT1,C'O'          ONLY IF ERRORS                               
         BE    IM9D                                                             
         CLI   QOPT1,C'X'          ONLY FILM REPORT AND ONLY IF ERRORS          
         BE    IM9D                                                             
         CLI   IRSKIP,C'Y'         ELSE NO FILM RPT IF NO MATCH RPT             
         BE    IM10                                                             
         CLI   TRAFFRPT,C'Y'       ELSE TEST PROFILE                            
         BE    IM9G                                                             
         CLI   TRAFFRPT,C'E'                                                    
         BNE   IM10                                                             
*                                                                               
IM9D     DS    0H                                                               
         CLI   FILMDSCP,C'Y'                                                    
         BNE   IM10                                                             
*                                                                               
IM9G     DS    0H                                                               
         BRAS  RE,FRPTPRT          PRINT SAVED FILM REPORT                      
*                                                                               
*--------------------------------------------------------------                 
*        LETTERS                                                                
*--------------------------------------------------------------                 
IM10     DS    0H                                                               
* DISABLE LETTER PRINTING - AKAT 7/12/07                                        
*&&DO                                                                           
         TM    SUSTATUS,X'40'      TEST ANY RNO/ONR DISCREPANCY                 
         BZ    IM10B               NO, SKIP LETTER                              
         CLI   LETROPTQ,C'Y'        PRINT LETTER?                               
         BE    IM10A                                                            
         CLC   QPROG(2),=C'IL'     PROG IL IS LETTER PRINT                      
         BNE   IM10B                                                            
*                                  IS LETTER ALREADY DONE FOR STATION?          
IM10A    DS    0H                                                               
         GOTO1 BINSRCH,SLTRPARS,(1,BMKTSTA+2)                                   
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         CLI   SLTRPARS,1          ALREADY IN TABLE?                            
         BNE   IM10B               YES, DON'T DO IT NOW                         
         GOTO1 =V(LETPRNT)                                                      
*&&                                                                             
*                                                                               
*--------------------------------------------------------------                 
*        PUT SUMMARY RECORD                                                     
*--------------------------------------------------------------                 
IM10B    DS    0H                                                               
         CLI   FILMDSCP,C'Y'       IF ANY FILM DISCREPANCY                      
         BNE   IM10D                                                            
         CLI   TRAFDSCP,C'Y'       AND OPTION TO TRACK THEM                     
         BNE   IM10D                                                            
         OI    SUSTATUS,X'80'      SET FILM ERROR                               
*                                                                               
IM10D    DS    0H                                                               
         CLI   HVROTERR,C'Y'       IF ANY H/V ERROR                             
         BNE   IM11                                                             
         CLI   HVERROPT,C'Y'         AND OPTION TO TRACK THEM                   
         BNE   IM11                                                             
         OI    SUSTATUS,X'08'      SET H/V ERROR                                
*                                                                               
IM11     DS    0H                  PUT SUMMARY RECORD TO BUFFALO                
         OC    SUSTA(5),SUSTA      TEST HAVE REAL SUMMARY                       
         BZ    IM11F                                                            
         TM    SUSTATUS,X'02'      TEST TO SKIP THIS ENTRY                      
         BNZ   IM11F                                                            
*                                                                               
         LA    R2,BUFFAPUT                                                      
         GOTO1 =V(BUFFERIN),DMCB,((R2),ABUFFRN2),(0,SUMREC),ACOMFACS            
         CLI   4(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
***      GOTO1 BUFFALO,DMCB,=C'PUT',ABUFFC,SUMREC,0                             
*                                                                               
IM11F    DS    0H                                                               
         GOTO1 =A(PRTMGA)          PRINT MAKEGOOD ANALYSIS                      
*                                                                               
IM11G    DS    0H                                                               
         LA    R5,1(R5)            NEXT PRD                                     
         BCT   R0,FD17                                                          
         MVC   BPRD2,SVBPRD2       RESTORE BPRD2                                
*                                                                               
IM12     DS    0H                                                               
         CLI   QBYID,C'Y'          TEST RUNNING BY CONTRACT ID                  
         BNE   IMREXT                                                           
         OC    BMKTSTA(2),BMKTSTA  NETWORK OK ???                               
         BZ    IM12A                                                            
         OC    HOMEMKT,HOMEMKT     OR IF NO HOME MKT ???                        
         BZ    IM12A                                                            
         CLC   BMKTSTA(2),HOMEMKT  ELSE ONLY DO RNO ID'S FOR HOME MKT           
         BNE   IMREXT                                                           
IM12A    DS    0H                                                               
         CLI   RNOIDSW,C'Y'        TEST ALREADY DOING RNO ID'S                  
         BE    IM13                                                             
         CLI   REQLSW,C'Y'         UNLESS AT REQLAST                            
         BE    IM12D                                                            
         L     R5,BUYLIST          SEE IF AT LAST ID                            
*                                                                               
IM12B    DS    0H                                                               
         OC    1(12,R5),SPACES                                                  
         CLC   SVBUYID,1(R5)                                                    
         BE    *+12                                                             
         LA    R5,13(R5)                                                        
         B     IM12B                                                            
*                                                                               
         CLI   13(R5),0            TEST EOL                                     
         BNE   IMREXT              NO, THIS IS NOT LAST- SO RETURN              
*                                                                               
IM12D    DS    0H                                                               
         L     R5,AIDLIST          SEARCH FOR UNPROCESSED ID'S                  
         STCM  R5,7,NEXTID+1                                                    
*                                                                               
IM13     DS    0H                                                               
         L     R5,NEXTID                                                        
         USING IDLISTD,R5                                                       
*                                                                               
IM13D    DS    0H                                                               
         CLI   0(R5),X'FF'         EOL                                          
         BE    IMREXT              YES-DONE                                     
         OC    IDLMKT,IDLMKT       MUST NOT BE FOR OTHER MKT                    
         BNZ   IM13E                                                            
         TM    IDLSTAT,X'80'  TEST PROCESSED                                    
         BZ    IM20                NO                                           
*                                                                               
IM13E    DS    0H                                                               
         LA    R5,IDLSTL(R5)           YES- NEXT                                
         B     IM13D                                                            
*                                                                               
IM20     DS    0H                                                               
         MVC   SVBUYID,0(R5)       NO-  SET BUYID AND PROCESS                   
         OI    12(R5),X'80'        SET PROCESSED                                
         LA    R5,IDLSTL(R5)       RESET NEXTID                                 
         STCM  R5,7,NEXTID+1                                                    
         MVI   RNOIDSW,C'Y'        SET DOING RNO ID'S                           
         LA    RF,STAF0                                                         
         BAS   RE,NTR1                                                          
         B     STAL0                                                            
         DROP  R5                                                               
*                                                                               
IMREXT   EQU   *                                                                
*                                                                               
         TM    CBLHOPT,CBLHALLQ    ARE WE REALLY DOING ALL/ SEP NTWKS           
         BNO   IMREXX                                                           
         TM    CBLHOPT,CBLHSYSQ    IS THIS A STATION 'ALL  ' REQ?               
         BO    IMREXX              YES                                          
         MVI   QSTA+4,C'/'         PUT BACK FOR NEXT MARKET SO WE               
         OI    CBLHOPT,CBLHHDQ     WON'T PICK UP NON CABLE STATIONS             
         XC    KEY,KEY                                                          
*                                                                               
IMREXX   B     EXIT                                                             
         EJECT                                                                  
**********************************************************************          
*        PROCESS BUY                                                            
**********************************************************************          
PRBUY    DS    0H                                                               
         GOTO1 ABYBLD                                                           
         BRAS  RE,ERRTST                                                        
         B     EXIT                                                             
*                                                                               
**********************************************************************          
*        NETPROC - NETPAK PROCESSING MODULE                                     
**********************************************************************          
NETPROC  DS    0H                                                               
         CLI   NUDONE,C'Y'         SKIP IF ALREADY DONE                         
         BER   RE                                                               
*                                                                               
         NTR1                                                                   
         MVI   NUDONE,C'Y'                                                      
         MVI   NUNETWK,0           USED AS FIRST TIME SWITCH                    
         MVI   MODE,STALAST        SET MODE SO HEAD SPECS WILL WORK             
         CLI   QEND,C' '           IF QEND NOT SET, QUIT NOW BECAUSE            
         BNH   NETPX               NO EST ACTV, BESIDES NETIO DUMPS             
*                                                                               
NETP4    DS    0H                                                               
         LA    RF,STAF00           VARIOUS CLEARS, RESET, ETC.                  
         BAS   RE,NTR1                                                          
         GOTO1 =V(NETNU),DMCB,(C'R',0)                                          
         BRAS  RE,ERRTST                                                        
         BNE   EXIT                                                             
         CLI   NUNETWK,X'FF'       TEST DONE                                    
         BE    NETP10                                                           
*                                                                               
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'S'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),NUNETWK                                                 
         MVI   KEY+6,C'N'                                                       
         MVC   KEY+7(2),QAGY                                                    
         MVC   KEY+9(3),CLT                                                     
         GOTO1 READSTA                                                          
         L     R6,ADSTAT                                                        
         MVC   WORK(4),MKT                                                      
         TM    ACNFLAG,FNDMKT      FOUND MKT IN STATION EQ RECORD               
         BO    *+10                                                             
         MVC   WORK(4),SMKT-STAREC(R6)                                          
         MVC   WORK+4(5),2(R6)                                                  
         GOTO1 MSPACK,DMCB,WORK,WORK+4,BMKTSTA                                  
         MVC   STA,WORK+4                                                       
         MVC   BIGSTA(4),STA                                                    
         MVC   BIGSTA+4(5),SPACES                                               
*                                                                               
         MVI   KEY,C'0'            GET MARKET                                   
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'M'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),MKT                                                     
         TM    ACNFLAG,FNDMKT      FOUND MKT IN STATION EQ RECORD               
         BO    *+10                                                             
         MVC   KEY+2(4),SMKT-STAREC(R6)                                         
         MVC   KEY+6(2),QAGY                                                    
         GOTO1 READMKT                                                          
*                                  POST TO STATION LIST                         
         MVC   WORK(3),BMKTSTA+2                                                
*                                                                               
         TM    CBLHOPT,CBLHNHAQ    IF NEW MODE AND CBH AND ALL                  
         BNO   *+8                                                              
         NI    WORK+2,X'80'        STRIP NETWORK                                
*                                                                               
         GOTO1 BINSRCH,STNLPARS,(1,WORK)                                        
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
         LA    RF,STAL0            FINISH UP NETWORK                            
         BAS   RE,NTR1                                                          
         B     NETP4               NEXT NETWORK                                 
*                                                                               
NETP10   DS    0H                                                               
         CLC   QSTA(3),=C'ALL'     FOR SINGLE STATION REQS                      
         BE    NETP14                                                           
         OC    BMKTSTA,BMKTSTA     HAVE WE ALREADY DONE MATCH?                  
         BNZ   NETP14              (IE WERE THERE ANY BUYS)                     
         L     R6,ADSTAT           NO, TRY NOW                                  
         MVC   WORK(4),MKT                                                      
         TM    ACNFLAG,FNDMKT      FOUND MKT IN STATION EQ RECORD               
         BO    *+10                                                             
         MVC   WORK(4),SMKT-STAREC(R6)                                          
         MVC   WORK+4(5),2(R6)                                                  
         GOTO1 MSPACK,DMCB,WORK,WORK+4,BMKTSTA                                  
         MVC   STA,WORK+4                                                       
         MVC   BIGSTA(4),STA                                                    
         MVC   BIGSTA+4(5),SPACES                                               
         LA    RF,STAL0            FINISH UP NETWORK                            
         BAS   RE,NTR1                                                          
*                                                                               
NETP14   DS    0H                                                               
*                                                                               
NETPX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
**********************************************************************          
*        LITERAL POOL AND ADDRESS CONSTANTS                                     
**********************************************************************          
         LTORG                                                                  
**********************************************************************          
ACONS    DS    0F                                                               
         DC    A(BYBLD)                                                         
         DC    A(INVBLD)                                                        
         DC    A(ICSMATCH)                                                      
         DC    A(ICSPOST)                                                       
         DC    A(ICSOLR)                                                        
         DC    A(CHKROT)                                                        
         DC    A(IRTOTS)                                                        
         DC    A(ACHDEM)                                                        
         DC    A(IRSUM)                                                         
         DC    A(IMRHEAD)                                                       
         DC    V(TIMUNPK)                                                       
         DC    A(IRPRT)                                                         
         DC    V(ICSADDEL)                                                      
         DC    A(COMTAB)                                                        
         DC    A(COMTABX)                                                       
         DC    A(0)                                                             
         DC    A(0)                                                             
         DC    A(IRORB)                                                         
         DC    A(IRSTAT)                                                        
         DC    A(FDEM)                                                          
         DC    V(FILMTOT)                                                       
         DC    V(GETCPAT)                                                       
         DC    V(TSCAN)                                                         
         DC    A(0)                                                             
         DC    A(IDLIST)                                                        
         DC    A(STNLIST)                                                       
         DC    A(STEQREC)                                                       
         DC    A(INOLST)                                                        
         DC    A(PIGLIST)                                                       
         DC    A(FRPTBUF)                                                       
         DC    A(FRPTBUFX)                                                      
         DC    A(IKLIST)                                                        
         DC    A(BUFFRIN)                                                       
         DC    A(BUFFRN2)                                                       
         DC    A(FLTTAB)                                                        
         DC    A(PRDTAB)                                                        
ACONSX   EQU   *                                                                
         EJECT                                                                  
*                                                                               
**********************************************************************          
*        RUN FIRST                                                              
**********************************************************************          
RUNF     NTR1  BASE=*,LABEL=*                                                   
         L     R6,VMASTC           A(DDMASTD)                                   
         USING MASTD,R6                                                         
         OC    MCREMPQK,MCREMPQK   SOON?                                        
         BNZ   RUNF1               NOT ZERO = SOON = SKIP OPEN                  
         DROP  R6                                                               
*                                                                               
         OPEN  (IPRQFIL,(OUTPUT))                                               
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
RUNF1    L     RE,MEDBUFF          SET MEDBLOCK FOR DEMO LOOKUPS                
         USING MEDBLOCK,RE                                                      
         MVC   MEDNUMPE,=F'1'                                                   
         MVI   RQDAYPT,C'Y'                                                     
         MVI   RQEQUIV,C'Y'                                                     
         MVI   MEDEXTDM,4                                                       
         MVC   MEDLCHNK,=F'168'                                                 
         DROP  RE                                                               
         LA    RE,CLRSTRT                                                       
         L     RF,=A(IMRWORKX-CLRSTRT)                                          
         XCEF                                                                   
*                                                                               
         L     R0,=A(BUFFLOV)      BUFFER LENGTH FOR OVERNIGHT                  
         L     R6,VMASTC           A(DDMASTD)                                   
         USING MASTD,R6            MASTD DSECT                                  
         OC    MCREMPQK,MCREMPQK   SOON?                                        
         BZ    *+8                 NO                                           
         L     R0,=A(BUFLSOON)     YES - LENGTH OF BUFFER FOR SOON              
         ST    R0,BUFFLEN          BUFFER LENGTH                                
*                                                                               
         GETMAIN  RU,LV=(0),LOC=24                                              
         LTR   RF,RF               ANY ERRORS?                                  
         BZ    *+6                 NO                                           
         DC    H'0'                YES - DEATH                                  
         ST    R1,ABUFFER          A(BUFFER)                                    
         L     R0,BUFFLEN          BUFFER LENGTH                                
         AR    R1,R0               ADD BUFFER LENGTH                            
         ST    R1,ABUFFX           A(END OF BUFFER)                             
                                                                                
         OC    ABUFFER,ABUFFER     BUFFER PRESENT?                              
         BNZ   *+6                 YES                                          
         DC    H'0'                NO - DEATH                                   
*                                  SET BINSRCH PARS FOR MGR NAME TAB            
         SR    R0,R0                                                            
         L     R1,=A(MGNAMTAB)                                                  
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,MGNAMTBE                                                      
         LA    R4,3                                                             
         LA    R5,MGNAMTBL/MGNAMTBE                                             
         STM   R0,R5,MGTBPARS                                                   
*                                  SET BINSRCH PARS FOR MKT NAME TAB            
         SR    R0,R0                                                            
         L     R1,=A(MKNAMTAB)                                                  
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,26                                                            
         LA    R4,2                                                             
         LA    R5,MKNAMTBL/26                                                   
         STM   R0,R5,MKTBPARS                                                   
*                                  SET BINSRCH PARS FOR SREPS                   
         SR    R0,R0                                                            
         L     R1,=A(SREPTAB)                                                   
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,SREPL                                                         
         LA    R4,2                                                             
         LA    R5,SREPTABL/SREPL                                                
         STM   R0,R5,SREPPARS                                                   
*                                  SET BINSRCH PARS FOR LIST OF                 
* DISABLE LETTER PRINTING - AKAT 7/12/07                                        
*&&DO                                                                           
         SR    R0,R0               STATIONS WITH LETTERS PRINTED                
         L     R1,=A(SLTRTAB)                                                   
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,3                                                             
         LA    R4,3                                                             
         LA    R5,SLTRMAX                                                       
         STM   R0,R5,SLTRPARS                                                   
*&&                                                                             
*                                  SET BINSRCH PARS FOR DEMOTAB                 
         SR    R0,R0                                                            
         L     R1,=A(DEMOTAB)                                                   
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,DTABEL                                                        
         LA    R4,3                                                             
         LA    R5,DEMOTABL/DTABEL                                               
         STM   R0,R5,DEMPARS                                                    
*                                  SET BINSRCH PARS FOR BUYTAB                  
         SR    R0,R0                                                            
         L     R1,=A(BUYRTAB)                                                   
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,BUYRTBEL                                                      
         LA    R4,8                                                             
         LA    R5,BUYRTABL/BUYRTBEL                                             
         STM   R0,R5,BUYRPARS                                                   
*                                  SET BINSRCH PARS FOR FILMTAB                 
         SR    R0,R0                                                            
         L     R1,=A(FLMTAB)                                                    
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,FLMTABEL                                                      
         LA    R4,FLMTABKL                                                      
         LA    R5,MAXFLMS                                                       
         STM   R0,R5,FLMTPARS                                                   
*                                  SET BINSRCH PARS FOR STNLIST                 
         SR    R0,R0                                                            
         L     R1,=A(STNLIST)                                                   
         A     R1,RELO                                                          
         SR    R2,R2                                                            
         LA    R3,3                DATA LENGTH                                  
         LA    R4,3                KEY LENGTH                                   
         LA    R5,MAXSTNS                                                       
         STM   R0,R5,STNLPARS                                                   
*                                                                               
         LAY   R1,ACONS                                                         
         LA    R0,(ACONSX-ACONS)/4                                              
         LA    R2,ABYBLD                                                        
RUNF2    DS    0H                                                               
         L     RF,0(R1)                                                         
         A     RF,RELO                                                          
         ST    RF,0(R2)                                                         
         LA    R1,4(R1)                                                         
         LA    R2,4(R2)                                                         
         BCT   R0,RUNF2                                                         
         MVC   HEADHOOK,AIMRHEAD                                                
*                                                                               
         L     RF,=A(SAVREGS)      SAVE BASE REGS                               
         A     RF,RELO                                                          
         STM   R9,RA,0(RF)                                                      
*                                                                               
         MVI   DASHES,C'-'                                                      
         MVC   DASHES+1(L'DASHES-1),DASHES                                      
         MVI   DOTS,C'.'                                                        
         MVC   DOTS+1(L'DOTS-1),DOTS                                            
         MVC   SAVMAX,MAXLINES                                                  
         MVC   P,SPACES                                                         
         MVI   RCREQREP,C'N'       SET NOT TO PRINT REQUEST                     
*                                                                               
         CLC   RCJOB+4(2),=C'U1'   TEST PAY TA                                  
         BNE   RUNF6                                                            
*                              ALTER REQLST SPECS TO SUPRESS PARTIAL            
*                              MATCH ON TA'S                                    
         L     RF,SPECS                                                         
         LA    RF,500(RF)          ASSUME AT LEAST 500 BYTES IN                 
         LA    RE,200(RF)          SET LIMIT                                    
RUNF5    DS    0H                                                               
         CLC   0(5,RF),=C'5804A'   START OF REQ SPEC ENTRY                      
         BE    RUNF5D                                                           
         LA    RF,1(RF)                                                         
         CR    RF,RE               TEST END                                     
         BL    RUNF5                                                            
         B     RUNF6                                                            
RUNF5D   DS    0H                                                               
         MVI   0(RF),0             SET END OF REQLST SPECS                      
RUNF6    DS    0H                                                               
*                                                                               
         LA    R0,BUFFAINI         INIT BUFFERIN                                
         GOTO1 =V(BUFFERIN),DMCB,((R0),ABUFFRN2),(0,0),ACOMFACS                 
         CLI   4(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OC    VTRPACK,VTRPACK                                                  
         BNZ   RUNF7                                                            
         GOTO1 LOADER,DMCB,=C'T00AFE  ',0                                       
         MVC   VTRPACK,4(R1)                                                    
*                                                                               
RUNF7    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        CLIENT FIRST                                                           
**********************************************************************          
*                                                                               
CFRST    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,=A(DBLOCKA)      CLEAR DBLOCK AREA                            
         A     R4,RELO                                                          
         XC    0(L'DBLOCK,R4),0(R4)                                             
         MVI   NUDONE,C'N'         RESET NETNU SWITCH                           
         XC    STNLPARS+8(4),STNLPARS+8  CLEAR STATION LIST                     
         MVI   INVCKSW,C'N'                                                     
*                                                                               
         MVI   ALLPAID,C'Y'        DEFAULT IS PAID/AUTOPAY                      
         MVI   RACTSW,0                                                         
         CLI   SAVEQAMC,0                                                       
         BE    CLTF20                                                           
*                                                                               
         MVC   WORK+0(2),AGY       AGY,MED,CLT FOR COMPARE                      
         MVC   WORK+2(1),MED                                                    
         MVC   WORK+3(3),CLT                                                    
         CLC   SAVEQAMC,WORK                                                    
*                                                                               
         BNE   CLTF10                                                           
         CLC   QUESTOR,SAVEQSTR                                                 
         BNE   CLTF10                                                           
         CLC   PSEUDOPT,SAVEQRSP   RESPONSE/REGULAR BREAK                       
         BE    CLTF22                                                           
*                                                                               
CLTF10   DS    0H                                                               
*                                  FINISH LAST CLIENT                           
*                                  - TEMPORARILY SWAP OLD AND                   
*                                  - NEW CLTHDRS FOR SUMMARY PRINT              
         L     RF,ABUFFER          SAVE THIS CLIENT HDR                         
         L     RE,ADCLT                                                         
         MVC   HALF,CLEN-CKEY(RE)                                               
         LH    R1,HALF                                                          
         MOVE  ((RF),(R1)),(RE)    SAVE THIS CLIENT HDR                         
*                                                                               
         L     RF,ADCLT                                                         
         L     RE,=A(SAVCLTR)                                                   
         MVC   HALF,CLEN-CKEY(RF)                                               
         LH    R1,HALF                                                          
         MOVE  ((RF),(R1)),(RE)    RESTORE OLD CLIENT HDR                       
*                                                                               
         XC    SAVMEDN,MEDNM       SWAP MEDIA DESC                              
         XC    MEDNM,SAVMEDN                                                    
         XC    SAVMEDN,MEDNM                                                    
*                                                                               
*                                                                               
         GOTO1 AIRSUM             PRINT SUMMARY                                 
*                                                                               
*                                                                               
         L     RF,ADCLT                                                         
         L     RE,ABUFFER                                                       
         MVC   HALF,CLEN-CKEY(RF)                                               
         LH    R1,HALF                                                          
         MOVE  ((RF),(R1)),(RE)    RESTORE THIS CLIENT HDR                      
*                                  RESTORE MEDIA DESC                           
         XC    SAVMEDN,MEDNM                                                    
         XC    MEDNM,SAVMEDN                                                    
         XC    SAVMEDN,MEDNM                                                    
*                                                                               
CLTF20   DS    0H                                                               
         MVC   SAVEQAMC+0(2),AGY   SAVE AGY,MED,CLT                             
         MVC   SAVEQAMC+2(1),MED                                                
         MVC   SAVEQAMC+3(3),CLT                                                
*                                                                               
         MVC   SAVEQSTR,QUESTOR                                                 
         MVC   SAVEQRSP,PSEUDOPT                                                
         L     RF,=A(SAVCLTR)                                                   
         L     RE,ADCLT                                                         
         MVC   HALF,CLEN-CKEY(RE)                                               
         LH    R1,HALF                                                          
         MOVE  ((RF),(R1)),(RE)    SAVE THIS CLIENT HDR                         
*                                                                               
         MVC   SAVMEDN,MEDNM       SAVE MEDIA DESC                              
*                                                                               
CLTF22   DS    0H                                                               
         L     RE,ADCLT                                                         
         MVC   SVTRACLT,CMCLTCOD-CLTHDR(RE)  SAVE TRAFFIC OVERD CLT             
*                                  PRINT REQ HERE                               
         MVI   RCREQREP,C'N'                                                    
         CLI   PROGPROF+8,C'S'     TEST SUPPRESS REQ DETAILS                    
         BE    CLTF22B                                                          
         CLI   CQSW,C'A'           TEST SUPPRESS REQ DETAILS                    
         BE    CLTF22B                                                          
         MVI   RCREQREP,C'Y'                                                    
         GOTO1 REQREP,DMCB                                                      
         MVI   RCREQREP,C'N'                                                    
*                                                                               
CLTF22B  DS    0H                                                               
         MVI   RCSUBPRG,0                                                       
         CLI   QBOOK1,C' '                                                      
         BE    *+8                                                              
         MVI   RCSUBPRG,1                                                       
*                                  ***PIGYBACK CONTROLS***                      
         MVI   BPRD2,0                                                          
         XC    PRD2,PRD2                                                        
         MVI   PIGCTL,C'B'         PRESET PIG CONTROL FOR BOTH                  
         CLC   =C'YES',QENDAUTO    2ND PROD AT Q + 34                           
         BE    CLTF24              YES = INCLUDE PIGGIES                        
         CLC   =C'ALL',QENDAUTO                                                 
         BNE   CLTF22C                                                          
         CLI   NETPSW,C'Y'         ***FOR NETPAK                                
         BE    CLTF24              TREAT 'ALL' AS 'YES'                         
         MVI   PIGCTL,C'S'         ELSE, ALL= SEPARATE                          
         B     CLTF24                                                           
CLTF22C  DS    0H                                                               
         CLC   =C'NO ',QENDAUTO    NO = NO PIGS                                 
         BE    CLTF22D                                                          
         CLI   QENDAUTO,C' '       BLANK = NO = NO PIGS                         
         BNE   CLTF22F                                                          
CLTF22D  DS    0H                                                               
         MVI   PIGCTL,C'N'         NO PIGS                                      
         B     CLTF24                                                           
CLTF22F  DS    0H                  GET PRD CODE                                 
         L     RF,ADCLT                                                         
         LA    RF,CLIST-CLTHDR(RF)                                              
         LA    R1,220              220 PRODS IN CLIST                           
CLTF23   DS    0H                                                               
         CLC   0(3,RF),QENDAUTO                                                 
         BE    CLTF23B                                                          
         CLI   0(RF),0                                                          
         BE    CLTF24                                                           
         LA    RF,4(RF)                                                         
         BCT   R1,CLTF23                                                        
*                                                                               
         CLI   NETPSW,C'Y'         TEST NETPAK                                  
         BE    *+6                 ONLY CLIST2 FOR NET                          
         DC    H'0'                                                             
*                                                                               
         L     RF,ADCLT                                                         
         LA    RF,CLIST2-CLTHDR(RF)                                             
         LA    R1,35               35 PRODUCTS IN CLIST2                        
CLTF23A  CLC   0(3,RF),QENDAUTO                                                 
         BE    CLTF23B                                                          
         CLI   0(RF),0             END OF CLIST2?                               
         BE    *+12                YES - MUST BE AN OVERFLOW PRD                
         LA    RF,4(RF)                                                         
         BCT   R1,CLTF23A                                                       
*                                                                               
         MVC   PRD2,QENDAUTO                                                    
         MVI   PIGCTL,C'1'         SINGLE PIG PRD                               
         B     CLTF24                                                           
*                                                                               
CLTF23B  DS    0H                                                               
         MVC   BPRD2,3(RF)                                                      
         MVC   PRD2,0(RF)          SET 3 CHARACTER PRODUCT                      
         MVI   PIGCTL,C'1'         SINGLE PIG PRD                               
*                                                                               
CLTF24   DS    0H                                                               
         MVI   PAYTA,C'N'                                                       
         CLC   QPROG(2),=C'U1'     TEST PAY PROG TA                             
         BNE   CLTF25                                                           
         MVI   PAYTA,C'Y'          SET TA SWITCH                                
*                                                                               
         MVC   PAYGN,X                       PAY GROSS OR NET                   
*                                  GET PROGPROF                                 
         OC    PROGPROF,PROGPROF   ALREADY HAVE (U1 SET UP)                     
         BNZ   CLTF25                                                           
         MVC   WORK+2(2),=C'U2'    ELSE USE U2                                  
         GOTO1 GETPROF,DMCB,WORK,PROGPROF,DATAMGR                               
*                                                                               
CLTF25   DS    0H                                                               
         MVI   SPOTPROF+8,1        ENSURE MONDAY SCHEME DESPITE                 
*                                  SPOTPROF SETTING                             
         MVI   RQBRDMON,C'N'       NOT BROADCAST (=CALENDAR)                    
         MVI   SPOTPROF+2,2                                                     
*                                                                               
         CLI   Q2USER+1,C'C'       REQ OTPION FIRST                             
         BE    CLTF25D                                                          
         CLI   Q2USER+1,C'B'                                                    
         BE    CLTF25C                                                          
         CLI   PROGPROF+9,C'C'     THEN I2 PROFILE                              
         BE    CLTF25D                                                          
*                                                                               
CLTF25C  DS    0H                                                               
         MVI   RQBRDMON,C'Y'       SET FOR BROADCAST                            
         MVI   SPOTPROF+2,0                                                     
*                                                                               
CLTF25D  DS    0H                                                               
         MVI   CENTS,C'Y'          ALWAYS SHOW PENNIES                          
*                                                                               
         XC    FNPROF,FNPROF       FILM TRANSLATION PROFILE                     
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'S0FN'                                                 
         MVC   WORK+4(2),AGY                                                    
         MVC   WORK+6(1),MED                                                    
         MVC   WORK+7(3),CLIENT                                                 
         L     RF,ADCLT                                                         
         LA    RF,COFFICE-CLTHDR(RF)                                            
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),0(RF)                                                 
         GOTO1 GETPROF,DMCB,(X'C0',WORK),FNPROF,DATAMGR                         
*                                                                               
         XC    I2ZPROF,I2ZPROF       I2Z PROFILE                                
         MVC   WORK(4),=C'SI2Z'                                                 
         NI    WORK,X'BF'            MAKE SYS LOWER CASE FOR PAGE A             
         GOTO1 (RF),(R1),,I2ZPROF                                               
*                                                                               
         MVI   MTRADE,C'N'           DEFAULT TO NO MTRADE                       
         L     RE,ADCLT              A(CLIENT RECORD)                           
         TM    COPT4-CLTHDR(RE),COP4TRD TRADE=T?                                
         BZ    CLTF25D1              NO                                         
         MVC   WORK(4),=C'SB1S'      B1S PROFILE                                
         NI    WORK,X'BF'            MAKE SYS LOWER CASE FOR PAGE A             
         GOTO1 (RF),(R1),,WORK+16    READ B1S PROFILE                           
         MVC   MTRADE,WORK+22        USING MTRADE FEATURE FIELD                 
*                                                                               
CLTF25D1 CLI   NETPSW,C'Y'         ONLY FOR NETPAK                              
         BNE   CLTF25E                                                          
         CLI   I2ZPROF+6,C'Y'      READ I2 PROF AT SUB MEDIA?                   
         BNE   CLTF25E                                                          
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BE    CLTF25E                                                          
         MVC   WORK(4),=C'S0I2'                                                 
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,PROGPROF                                              
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
CLTF25E  XC    MKPROF,MKPROF           MATCHMAKER PROFILE                       
         MVC   WORK(4),=C'S0MK'                                                 
         GOTO1 (RF),(R1),,MKPROF                                                
         CLI   NETPSW,C'Y'             DIFFERENT PROFILE FOR NET                
         BNE   CLTF25F                                                          
         MVC   MKPROF+3(1),MKPROF+7    IF NET USE THIS ONE                      
*                                                                               
         CLC   QAGY,=C'DU'         IF MEDIAVEST                                 
         BNE   CLTF25F                                                          
         CLC   QPRD,=C'POL'        AND REQUEST IS NOT FOR POL                   
         BNE   *+14                                                             
         CLC   QEST,=C'NO '        AND EST NO                                   
         BE    CLTF25F                                                          
         MVI   MKPROF+3,C'N'       THEN NO MM !!                                
*                                                                               
CLTF25F  MVI   B0AFFDEL,C'Y'       ALLOW PAID AFFID DELETES                     
         CLI   NETPSW,C'Y'             NOT FOR NETPAK                           
         BE    CLTF26                                                           
         MVC   WORK(4),=C'S0B0'                                                 
         GOTO1 (RF),(R1),,WORK+30                                               
         MVC   B0AFFDEL,WORK+34                                                 
*                                                                               
CLTF26   DS    0H                                                               
         XC    I2IPROF,I2IPROF         INTEGRATION PROFILE                      
         CLI   NETPSW,C'Y'             ONLY FOR NETPAK                          
         BNE   CLTF26T                                                          
         MVC   WORK(4),=C'SI2I'                                                 
         NI    WORK,X'BF'                                                       
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2IPROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
         CLI   Q2USER+2,C'I'       MATCH ON INTEGRATION - IN REQUEST            
         BNE   *+10                                                             
         MVC   I2IPROF,=C'YN'      THEN SET PROFILE                             
         CLI   Q2USER+2,C'O'       MATCH ON INTEGRATION ONLY                    
         BNE   *+10                                                             
         MVC   I2IPROF,=C'NY'      THEN SET PROFILE                             
*                                                                               
CLTF26T  XC    TRAFPROF,TRAFPROF       TRAFFIC PROFILE                          
         MVC   WORK(4),=C'S0TI'                                                 
         CLI   I2ZPROF+6,C'Y'      READ TI PROF AT SUB MEDIA?                   
         BNE   CLTF26U                                                          
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   CLTF26X                                                          
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         B     CLTF26X                                                          
********************************** HARD CODE TO GET RID OF                      
CLTF26U  CLC   =C'TH',QAGY         FOR TH (ZENYA) AND                           
         BE    CLTF26V                                                          
         CLC   =C'G7',QAGY         FOR G7 (GSTX) AND                            
         BE    CLTF26V                                                          
         CLC   =C'H7',QAGY         FOR H7 (MSNYA) AND                           
         BE    CLTF26V                                                          
         CLC   =C'JW',QAGY         FOR JW ONLY - USE SUB MEDIA                  
         BNE   CLTF26X                                                          
CLTF26V  CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   CLTF26X                                                          
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
*=============================================================                  
CLTF26X  GOTO1 (RF),(R1),,TRAFPROF                                              
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
         CLI   TRAFRCLO,C' '       RECALL DATE OPTION                           
         BH    *+8                                                              
         MVI   TRAFRCLO,C'N'       DEFAULTS TO N                                
*                                                                               
         XC    T0PROF,T0PROF           T0 PROFILE                               
         MVC   WORK(4),=C'S0T0'                                                 
         GOTO1 (RF),(R1),,T0PROF                                                
*                                                                               
         XC    I2SPROF,I2SPROF       I2S PROFILE (SEPARATION)                   
         MVC   WORK(4),=C'SI2S'                                                 
         NI    WORK,X'BF'          MAKE SYS LOWER CASE FOR PAGE A               
         CLI   I2ZPROF+6,C'Y'      READ I2S PROF AT SUB MEDIA?                  
         BNE   *+18                                                             
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2SPROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
         XC    I2XPROF,I2XPROF       I2X PROFILE                                
         MVC   WORK(4),=C'SI2X'                                                 
         NI    WORK,X'BF'          MAKE SYS LOWER CASE FOR PAGE A               
         CLI   I2ZPROF+6,C'Y'      READ I2X PROF AT SUB MEDIA?                  
         BNE   *+18                                                             
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2XPROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
         XC    I2NPROF,I2NPROF       I2N PROFILE                                
         MVC   WORK(4),=C'SI2N'                                                 
         NI    WORK,X'BF'          MAKE SYS LOWER CASE FOR PAGE A               
         CLI   I2ZPROF+6,C'Y'      READ I2N PROF AT SUB MEDIA?                  
         BNE   *+18                                                             
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2NPROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
         MVC   PROFSTW,I2NPROF+11  SAVE "STW ESTIMATES ON I2" FIELD             
*                                                                               
         XC    I2APROF,I2APROF       I2A PROFILE                                
         MVC   WORK(4),=C'SI2A'                                                 
         NI    WORK,X'BF'          MAKE SYS LOWER CASE FOR PAGE A               
         CLI   I2ZPROF+6,C'Y'      READ I2A PROF AT SUB MEDIA?                  
         BNE   *+18                                                             
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2APROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
         XC    I2BPROF,I2BPROF       I2B PROFILE                                
         MVC   WORK(4),=C'SI2B'                                                 
         NI    WORK,X'BF'          MAKE SYS LOWER CASE FOR PAGE A               
         CLI   I2ZPROF+6,C'Y'      READ I2B PROF AT SUB MEDIA?                  
         BNE   *+18                                                             
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2BPROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
         XC    I2CPROF,I2CPROF       I2C PROFILE                                
         MVC   WORK(4),=C'SI2C'                                                 
         NI    WORK,X'BF'          MAKE SYS LOWER CASE FOR PAGE A               
         CLI   I2ZPROF+6,C'Y'      READ I2B PROF AT SUB MEDIA?                  
         BNE   *+18                                                             
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2CPROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
         CLI   I2ZPROF+15,C'Y'     REREAD I2Z PROF BY SUBMEDIA                  
         BNE   CLTF27                                                           
         MVC   WORK(4),=C'SI2Z'                                                 
         NI    WORK,X'BF'            MAKE SYS LOWER CASE FOR PAGE A             
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2ZPROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
CLTF27   XC    I2PPROF,I2PPROF       I2P PROFILE - AUTOPAY                      
         MVC   WORK(4),=C'SI2P'                                                 
         NI    WORK,X'BF'          MAKE SYS LOWER CASE FOR PAGE A               
         GOTO1 (RF),(R1),,I2PPROF                                               
*                                                                               
         XC    I2YPROF,I2YPROF       I2Y PROFILE                                
         MVC   WORK(4),=C'SI2Y'                                                 
         NI    WORK,X'BF'          MAKE SYS LOWER CASE FOR PAGE A               
         CLI   I2APROF+8,C'Y'      READ I2Y PROF AT SUB MEDIA?                  
         BNE   *+18                                                             
         CLI   MEDFILT,C' '        ANY SUB-MEDIA                                
         BNH   *+10                                                             
         MVC   WORK+6(1),MEDFILT   THEN USE SUB MEDIA                           
         GOTO1 (RF),(R1),,I2YPROF                                               
         MVC   WORK+6(1),MED       RESET REAL MEDIA                             
*                                                                               
         XC    I0PROF,I0PROF         I0 PROFILE                                 
         MVC   WORK(4),=C'S0I0'                                                 
         GOTO1 (RF),(R1),,I0PROF                                                
         MVC   BUYIDLN,I0PROF+2    LENGTH FOR BUY REC ID COMPARE                
*                                                                               
         XC    STPROF,STPROF         ST PROFILE                                 
         MVC   WORK(4),=C'S0ST'                                                 
         GOTO1 (RF),(R1),,STPROF                                                
*                                                                               
         XC    WORK+30(16),WORK+30   DAR PROFILE                                
         MVC   WORK(4),=C'SDAR'                                                 
         NI    WORK,X'BF'            MAKE SYS LOWER CASE FOR PAGE A             
         GOTO1 (RF),DMCB,(X'A0',WORK),WORK+30,,,WORK+46                         
         MVC   DARREP,WORK+36        SAVE TRADE REP FOR 2                       
*                                                                               
         XC    WORK,WORK             CLEAR WORK                                 
         MVC   WORK(4),=C'S0A0'      READ THE A0 PROFILE                        
         MVC   WORK+4(2),AGY         AGENCY                                     
         MVC   WORK+7(3),=X'FFFFFF'  FAKE CLT OR WILL RETURN MED LEVEL          
         MVI   WORK+10,C'*'          READ OFFICE LEVEL IF THERE IS ONE          
         L     RF,ADCLT              CLIENT RECORD                              
         LA    RF,COFFICE-CLTHDR(RF) OFFICE                                     
         MVC   WORK+11(1),0(RF)      MOVE OFFICE INTO PROFILE                   
         GOTO1 GETPROF,DMCB,WORK,WORK+16                                        
         MVC   A0GROSSN,WORK+16      PAY BY GROSS OR NET                        
*                                                                               
*-------------------------------------------------------------------            
*        SET SOME VALUES BASED ON PROFILE SETTINGS                              
*-------------------------------------------------------------------            
         CLI   QAREA+31,C'Z'       TEST A Z5 RUN                                
         BNE   CLTF27A                                                          
         CLI   I2APROF+1,C'Y'      SUPPRESS FILM REP FROM Z5/Z7                 
         BNE   CLTF27A                                                          
         MVI   QOPT1,C'N'          SUPPRESS FILM REP                            
*                                                                               
CLTF27A  CLI   CANADSW,C'Y'        ONLY FOR US NOT CANADA                       
         BE    CLTF27AB                                                         
         NI    RQOPTS,X'FF'-RQOPTS_HDEND                                        
         MVI   CBLHOPT,0           SET CABLE HEAD OPTIONS                       
         CLI   QSTA+4,C'/'         CABLE HEAD REQ                               
         BNE   *+8                                                              
         OI    CBLHOPT,CBLHHDQ                                                  
         CLC   QCBLNET,=C'ALL'     ALL NETWORKS                                 
         BE    *+12                                                             
         CLI   QCBLNET,C' '                                                     
         BH    *+12                                                             
         OI    CBLHOPT,CBLHALQ                                                  
         OI    RQOPTS,RQOPTS_HDEND TELL FILCON TO PROCESS SYSCODE LEVEL         
*                                                                               
         OI    CBLHOPT,CBLHNMQ     NEW CBL MODE                                 
         OI    RQOPTS,RQOPTS_POST  FLAG TO INDICATE SPOT POSTING                
*                                                                               
CLTF27AB CLI   I2XPROF,C'Y'    TEST TO CHANGE EST=ALL TO EST=NO                 
         BNE   CLTF27B                                                          
         CLC   =C'ALL',QEST                                                     
         BNE   *+10                                                             
         MVC   QEST(3),=C'NO '                                                  
*                                                                               
CLTF27B  DS    0H                                                               
         MVC   MDETOPT,I2XPROF+15   MATCHED DETAILS OPTION                      
         CLI   QAREA+33,C' '       TEST REQUEST CARD OVERRIDE                   
         BE    *+10                                                             
         MVC   MDETOPT,QAREA+33                                                 
         MVC   PROGOPT,I2XPROF+10  PROGRAM NAME OPTION                          
         CLI   PROGOPT,C' '                                                     
         BH    *+8                                                              
         MVI   PROGOPT,C'N'                                                     
         MVC   SEQNOPT,I2XPROF+12  SPOT SEQUENCE NUMBER OPT                     
         MVC   HVERROPT,I2XPROF+8  H/V TRACK                                    
         MVI   BIGOPT,X'80'        SET BIG ERROR MESSAGE OPTION                 
         CLI   I2XPROF+7,C'M'      MATCH ERRORS                                 
         BE    CLTF28                                                           
         MVI   BIGOPT,X'C0'        MATCH AND H/V                                
         CLI   I2XPROF+7,C'R'                                                   
         BE    CLTF28                                                           
         MVI   BIGOPT,X'A0'        MATCH AND FILM                               
         CLI   I2XPROF+7,C'F'                                                   
         BE    CLTF28                                                           
         MVI   BIGOPT,X'E0'        MATCH AND H/V AND FILM                       
         CLI   I2XPROF+7,C'A'                                                   
         BE    CLTF28                                                           
         MVI   BIGOPT,0                                                         
*                                                                               
CLTF28   DS    0H                                                               
         CLI   I2XPROF+11,C'Y'     BIG CLEARED MESSAGE                          
         BNE   *+8                                                              
         OI    BIGOPT,X'01'                                                     
*                                                                               
         CLI   INTCOPT,0           ENSURE INTCOPT SET                           
         BNE   *+8                                                              
         MVI   INTCOPT,C'N'                                                     
*                                                                               
         MVC   MISSOPT,I2YPROF+0   MISSED SPOT OPTION                           
         MVC   MCOMOPT,I2YPROF+1   MONTHLY COMMENT OPTION                       
         MVC   STAXOPT,I2YPROF+2   STATION TAX OPTION                           
         MVC   RNAMOPT,I2YPROF+4   REP NAME WITH TOTALS                         
         MVC   SNAMOPT,I2YPROF+5   PRINT STATION NAME                           
         MVC   SAFFOPT,I2YPROF+6   PRINT STATION AFFILIATION                    
         MVC   DEFDCHG,I2YPROF+9   DEFERRED DATE CHANGE                         
***      MVC   OPTMGA,I2YPROF+10   PRINT MAKEGOOD ANALYSIS                      
         MVI   OPTMGA,C'N'         FORCE MGA OFF                                
         MVC   SPAGOPT,I2YPROF+11  MATCHED, ONR, AND RNO ON SEP PAGES           
*                                                                               
* DISABLE LETTER PRINTING - AKAT 7/12/07                                        
*&&DO                                                                           
         MVC   LETROPT,I2YPROF+12  LETTER WITH MATCH REPORT                     
         MVC   LETROPTQ,LETROPT    REQUEST LEVEL LETTER OPTION                  
         CLI   Q2USER,C' '                                                      
         BNH   *+10                                                             
         MVC   LETROPTQ,Q2USER     LETTER OPTION                                
         CLI   LETROPTQ,C'Y'       IF DOING LETTER SKIP ALL OTHER               
         BNE   *+8                 PRINTING, SUMMARIES AS WELL                  
         MVI   QOPT4,C'S'          (THIS OPT MEANS SUMMARIES ONLY,BUT           
*                                  THEY ARE SUPPRESSED IN IRSUM)                
CLTF29   DS    0H                                                               
         CLC   QPROG(2),=C'IL'     IF DOING LETTERS SEP SKIP ALL OTHER          
         BNE   *+8                 PRINTING, SUMMARIES AS WELL                  
         MVI   QOPT4,C'S'          (THIS OPT MEANS SUMMARIES ONLY,BUT           
*&&                                                                             
         MVI   MSROPT,C'N'         NO MSR STATUS RECS                           
         CLC   =C'NO',QEST         IF EST=NO                                    
         BE    CLTF32                                                           
         CLC   =C'POL',QPRD        OR IF PRD=POL                                
         BE    CLTF32              (NOTE-MAY BE SET OFF ELSEWHERE ALSO)         
*                                                                               
         MVC   MSROPT,I2YPROF+13   MATCHING STATUS RECORD                       
*                                                                               
CLTF32   DS    0H                                                               
         CLI   I2YPROF+8,C'Y'      TWO PRINTER OPTION                           
         BNE   *+8                                                              
         MVI   RCWHATPR,1          INITALIZE TO FIRST PRINTER                   
         CLI   RCWHATPR,2          ALSO IF WAS ON PRINTER 2                     
         BL    *+8                                                              
         MVI   RCWHATPR,1          INITALIZE TO FIRST PRINTER                   
*                                  DO WE NEED TO CHECK FOR PW MKT FIX?          
         L     RF,ADCLT            TEST IF A PW CLIENT                          
         MVI   WIPWSW,C'N'                                                      
         OC    CPWPCT-CLTHDR(3,RF),CPWPCT-CLTHDR(RF)                            
         BZ    *+8                                                              
         MVI   WIPWSW,C'Y'                                                      
*                                                                               
         MVC   SVCOPT1,COPT1-CLTHDR(RF)                                         
         MVC   SVCOPT4,COPT4-CLTHDR(RF)                                         
*                                                                               
         CLI   I2APROF+11,C'N'     DO NOT POST AFFIDS FOR MCT                   
         BNE   CFRST34                                                          
         CLI   PSEUDOPT,C'P'                                                    
         BNE   CFRST34                                                          
         MVI   QOPT5,C'N'          THEN FORCE TO N FOR MCT REQUESTS             
*                                                                               
CFRST34  DS    0H                                                               
CFRSTX   DS    0H                  CALL SPMEDGETBY WITH NO BUYREC TO            
         L     RE,ADBUY            SET 2-DECIMAL OPTION PROPERLY                
         MVI   0(RE),0                                                          
         GOTO1 MEDGETBY,DMCB,(RA),0                                             
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        VALACN - VALIDATE THE ACN NUMBER                                       
**********************************************************************          
*                                                                               
VALACN   NTR1  BASE=*,LABEL=*                                                   
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING STEKEY,R6                                                        
         MVC   STEKTYP,=X'0D44'                                                 
         MVC   STEKAGMD,BAGYMD                                                  
         MVC   KEY+3(2),BCLT       USE CURRENT CLIENT                           
         CLI   CQSW,C'A'           IF CLIENT=ALL                                
         BE    VALACN05                                                         
         GOTO1 CLPACK,DMCB,QCLT,KEY+3   ELSE REQ CLIENT                         
*                                                                               
VALACN05 DS    0H                                                               
         MVC   KEY+5(5),QSTA       STA                                          
         CLI   QSTA,C'0'           LOCAL CABLE                                  
         BL    *+8                                                              
         MVI   KEY+9,C' '          THEN THERE IS NO 'T'                         
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    VALACN08                                                         
         MVC   KEY,KEYSAVE         RESET TO KEY WE ARE LOOKING FOR              
         MVC   KEY+3(2),=X'FFFF'   AND CHECK FOR CLIENT ALL                     
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   ACNERR                                                           
VALACN08 L     R6,ADSTEQ                                                        
         ST    R6,AREC                                                          
         GOTO1 GET                                                              
*                                                                               
         LA    R6,24(R6)                                                        
*                                                                               
         USING STEEL02,R6                                                       
VALACN10 CLI   0(R6),0                                                          
         BE    ACNERR                                                           
         CLI   0(R6),2                                                          
         BNE   VALACN20                                                         
         CLC   STEACN,QBOOK1       TEST ACN NUMBER                              
         BE    VALACN30                                                         
VALACN20 LLC   R1,1(R6)                                                         
         AR    R6,R1                                                            
         B     VALACN10                                                         
*                                                                               
ACNERR   MVC   P(18),=C'INVALID ACN NUMBER'                                     
         GOTO1 REPORT                                                           
***      BRAS  RE,FREEBUFF                                                      
         GOTO1 AENDREQ                                                          
*                                                                               
VALACN30 EDIT  STEACNMK,MKT,FILL=0                                              
         MVC   QMKT,MKT                                                         
         OI    ACNFLAG,FNDMKT                                                   
         MVC   SVBUYID(5),QBOOK1  SET ACN NUMBER                                
         MVC   QBOOK1(5),SPACES                                                 
         DROP  R6                                                               
VALACNX  XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*============================================================*                  
* FOR PW CLIENT, FIND THE MARKET WITH BUYS IN CASE OF MKTFIX *                  
*============================================================*                  
         SPACE 1                                                                
CHKPWMKT NTR1  BASE=*,LABEL=*                                                   
         XC    KEY,KEY                                                          
         MVC   KEY(1),BAGYMD       A/M                                          
         MVC   KEY+1(2),BCLT       CLIENT                                       
         MVC   KEY+3(1),BPRD       PRODUCT                                      
         MVC   KEY+4(5),BMKTSTA    MKT/STA                                      
         MVC   KEY+9(1),BEST       ESTIMATE                                     
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE     IF FOUND, USE THIS MKT                       
         BE    CHKPWX                                                           
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE                                      
         OC    SVOLDMK1,SVOLDMK1                                                
         BZ    CHKPWX                                                           
         MVC   KEY+4(2),SVOLDMK1   TRY FIRST OLD MKT                            
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BE    CHKPW2                                                           
*                                                                               
         MVC   KEY,KEYSAVE         RESTORE                                      
         OC    SVOLDMK2,SVOLDMK2                                                
         BZ    CHKPWX                                                           
         MVC   KEY+4(2),SVOLDMK2   TRY 2ND OLD MARKET                           
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BNE   CHKPWX              IF NOT FOUND USE CURRENT MARKET              
*                                                                               
CHKPW2   DS    0H                                                               
         SR    R0,R0                                                            
         ICM   R0,3,KEY+4          READ NEW MKT RECORD                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(4),DUB                                                      
*                                                                               
         MVC   KEYSAVE,KEY                                                      
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'M'                                                         
         MVC   KEY+1(1),MED                                                     
         MVC   KEY+2(4),WORK                                                    
         MVC   KEY+6(2),AGENCY                                                  
         GOTO1 READMKT                                                          
         MVC   KEY,KEYSAVE                                                      
*                                                                               
         MVC   BMKTSTA(5),KEY+4        SAVE THIS MKT/STA                        
         MVC   QMKT,WORK                                                        
*                                                                               
CHKPWX   XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        FRPTPRT PRINT SAVED FILM REPORT                                        
**********************************************************************          
FRPTPRT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   QBOOK1,C' '         IF DEMOS REQUESTED                           
         BNE   FRP1                PROCESS FILM REPORT TO GET DEMOS             
         CLI   FILMDONE,C'Y'       - ALREADY BUILT TABLE                        
         BE    FRP2                                                             
*                                                                               
FRP1     MVC   FULL(3),BMKTSTA+2   SAVE REAL BSTA                               
         TM    CBLHOPT,CBLHNHAQ    IF CBH REQ AND NEW MODE                      
         BNO   FRP1A               AND 'ALL NETS'                               
         CLI   CANADSW,C'Y'        ONLY FOR US NOT CANADA                       
         BE    FRP1A               AND 'ALL NETS'                               
         CLI   FULL,X'E8'          AND HAVE A CABLE STATION                     
         BL    FRP1A                                                            
         NI    BMKTSTA+4,X'80'     CLEAR NETWORK - FOR FILM LOOKUP!!            
*                                                                               
FRP1A    GOTO1 AFILMTOT            FILM REPORT                                  
         MVC   BMKTSTA+2(3),FULL   RESET REAL BSTA                              
*                                                                               
FRP2     L     R6,AFRPTBUF                                                      
         CLI   0(R6),X'FF'         IF NO LINES SKIP REPORT                      
         BE    FRP30                                                            
         CLI   0(R6),0                                                          
         BE    FRP30                                                            
*                                                                               
         CLI   NOIMR,C'Y'          IF NO IMR                                    
         BE    FRP3                                                             
         CLI   IRSKIP,C'Y'         OR IF THIS ONE NOT PRINTED                   
         BE    FRP3                                                             
         CLI   TRAFSEP,C'Y'        OR IF ON SEPARATE PAGE                       
         BNE   *+8                                                              
FRP3     DS    0H                                                               
         MVI   FORCEHED,C'P'       NEED HEADLINES                               
         MVI   PAGSW,0                                                          
         MVI   LNEED,14            ALLOW ROOM                                   
         GOTO1 AIRPRT                                                           
*                                                                               
         MVC   P+45(23),=C'**FILM USAGE ANALYSIS**'                             
         MVC   P2+47(19),DASHES                                                 
         MVI   SPACING,2                                                        
         GOTO1 AIRPRT                                                           
         MVI   PAGSW,C'F'                                                       
         GOTO1 AIMRHEAD                                                         
         GOTO1 AIRPRT                                                           
*                                                                               
FRP4     DS    0H                                                               
         CLI   0(R6),X'FF'         END                                          
         BE    FRP20                                                            
         CLI   0(R6),0             END                                          
         BE    FRP20                                                            
         MVC   SPACING,0(R6)                                                    
         MVC   LNEED,1(R6)                                                      
         LLC   R5,2(R6)            NO OF LINES                                  
         LA    R6,3(R6)                                                         
         LA    R3,P                                                             
*                                                                               
FRP6     DS    0H                                                               
         LLC   R4,0(R6)            LENGTH OF LINE +1                            
         AHI   R4,-2                                                            
         BM    FRP8                                                             
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),1(R6)                                                    
*                                                                               
FRP8     DS    0H                                                               
         LA    R3,132(R3)                                                       
         LA    R6,2(R6)            NEXT LINE                                    
         AR    R6,R4                                                            
         BCT   R5,FRP6                                                          
*                                                                               
         GOTO1 AIRPRT                                                           
         B     FRP4                NEXT SET OF LINES                            
*                                                                               
FRP20    DS    0H                                                               
         CLI   AFRPTBUF,0          TEST OVERFLOW                                
         BE    FRP30                                                            
         MVC   P(30),=C'**FILM PRINT BUFFER OVERFLOW**'                         
         GOTO1 AIRPRT                                                           
*                                                                               
FRP30    DS    0H                                                               
         MVI   PAGSW,0                                                          
FRPX     XIT1                                                                   
         LTORG                                                                  
*                                                                               
FREEBUFF NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R1,ABUFFER          A(BUFFER)                                    
         L     R0,BUFFLEN          LENGTH OF BUFFER                             
*                                                                               
         FREEMAIN RC,A=(1),LV=(0)  FREE STORAGE                                 
         LTR   RF,RF               ANY ERRORS?                                  
         BZ    *+6                 NO                                           
         DC    H'0'                YES - DEATH                                  
         XC    ABUFFER,ABUFFER     CLEAR A(BUFFER)                              
         J     EXIT                EXIT                                         
         LTORG                                                                  
**********************************************************************          
*        PRTMGA - PRINT MAKEGOOD ANALYSIS                                       
**********************************************************************          
PRTMGA   NMOD1 0,**PRTMGA                                                       
         LA    RC,SPACEND                                                       
         CLI   OPTMGA,C'Y'         MGA OPTION ON?                               
         BNE   PMGX                                                             
         CLI   BEST,0              SKIP UNLESS BY ESTIMATE                      
         BE    PMGX                                                             
         LA    R6,MGADWRK                                                       
         USING MGABLKD,R6                                                       
         OC    MGACNT,MGACNT       ANY TABLE ENTRIES?                           
         BZ    PMGX                                                             
*                                                                               
         MVI   MGAACT,MGAQTOT      DO MGA TOTALS                                
         GOTO1 VBLDMGN,MGABLKD                                                  
         CLI   MGAERR,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   NOIMR,C'Y'          IF NO IMR                                    
         BE    PMG2                                                             
         CLI   IRSKIP,C'Y'         OR IF THIS ONE NOT PRINTED                   
         BE    PMG2                                                             
         B     *+8                                                              
PMG2     DS    0H                                                               
         MVI   FORCEHED,C'P'       NEED HEADLINES                               
         MVI   PAGSW,0                                                          
         MVI   LNEED,14            ALLOW ROOM                                   
         GOTO1 AIRPRT                                                           
*                                                                               
         MVC   P+46(21),=C'**MAKEGOOD ANALYSIS**'                               
         MVC   P2+48(17),DASHES                                                 
         MVI   SPACING,2                                                        
         GOTO1 AIRPRT                                                           
         MVI   PAGSW,C'M'                                                       
         GOTO1 AIMRHEAD                                                         
         GOTO1 AIRPRT                                                           
*                                                                               
PMG4     DS    0H                                                               
         LH    R2,MGACNT                                                        
         L     R3,MGATAB                                                        
*                                                                               
PMG8     DS    0H                                                               
         MVC   MGAENTRY,0(R3)                                                   
         MVI   MGAACT,MGAQPRNT                                                  
         LA    R4,X                USE X FOR PRINT LINE                         
         MVC   X(132),SPACES                                                    
         USING MGLINED,R4                                                       
         ST    R4,MGALINE                                                       
         GOTO1 VBLDMGN,MGABLKD                                                  
*                                                                               
         MVC   P(MGLMSCST-MGLINED),MGLINED   FIXED FIELDS                       
         LA    R5,P+MGLTIME+13-MGLINED                                          
*                                                                               
         CLI   COSTSUP,C'Y'        SUPRESSING COSTS?                            
         BE    PMG10                                                            
         MVC   00(8,R5),MGLMSCST    MISSED COST                                 
         MVC   09(8,R5),MGLMGCST    MGD COST                                    
         LA    R5,20(R5)                                                        
*                                                                               
PMG10    DS    0H                                                               
         CLI   QBOOK1,C' '          ANY DEMOS?                                  
         BNH   PMG12                                                            
         MVC   00(8,R5),MGLMSRTG    MISSED RTG                                  
         MVC   09(8,R5),MGLMGRTG    MGD RTG                                     
         LA    R5,20(R5)                                                        
*                                                                               
PMG12    DS    0H                                                               
         CLI   MGLSTA,C' '         OTHER STATION?                               
         BNH   PGM14                                                            
         MVC   0(2,R5),=C'**'                                                   
         MVC   2(8,R5),MGLSTA                                                   
         B     PGM16                                                            
*                                                                               
PGM14    DS    0H                                                               
         MVC   0(14,R5),MGLPGMNM   PROGRAM                                      
*                                                                               
PGM16    DS    0H                                                               
         GOTO1 AIRPRT                                                           
         LA    R3,MGERECL(R3)      NEXT ENTRY                                   
         BCT   R2,PMG8                                                          
*                                                                               
         L     R0,=A(MGATBL)       CLEAR MGA TABLE                              
         LHI   R1,L'MGATBL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         XC    MGACNT,MGACNT       AND CLEAR COUNT                              
*                                                                               
PMGX     DS    0H                                                               
         MVI   PAGSW,0                                                          
         XIT1                                                                   
         DROP  R4,R6                                                            
*                                                                               
         LTORG                                                                  
**********************************************************************          
         TITLE 'BYBLD - ICS BUYREC BUFFER MODULE'                               
**********************************************************************          
BYBLD    NMOD1 0,BYBLD                                                          
         USING BYELEMD,R7                                                       
         USING REGELEM,R8                                                       
         LA    RC,SPACEND                                                       
         L     R6,ADBUY                                                         
         USING BUYREC,R6                                                        
*                                                                               
         MVI   ORBCNT,0                                                         
         L     R7,ANXTBY                                                        
*                                                                               
         GOTO1 =A(TSTREC),DMCB,RR=RELO                                          
         BNE   NXTREC                                                           
*                                                                               
         CLI   OPTMGA,C'Y'         IF DOING MKGD ANALYSIS                       
         BNE   BYBLD4                                                           
         CLI   BEST,0              SKIP UNLESS BY ESTIMATE                      
         BE    BYBLD4                                                           
         LA    R5,MGADWRK          BUILD MGA TABLE                              
         USING MGABLKD,R5                                                       
         MVI   MGAACT,MGAQBLN      BUILD LINE FROM ONE BUY                      
*                   SET TO APPEND AND FILTER OD DATES AND PRD'S                 
         OI    MGAOPT,MGOPENTB+MGOFLTDT+MGOFLTPR                                
         MVC   MGSFLTDT,BQSTARTP                                                
         MVC   MGEFLTDT,BQENDP                                                  
         MVC   MGFLTPRD,BPRD       PROD FILTER                                  
         MVC   MGFLTPG,BPRD2       PIG FILTER                                   
         CLI   PIGCTL,C'B'         IF DOING BOTH PIGS AND NON-PIGS              
         BNE   *+8                                                              
         MVI   MGFLTPG,X'FE'       SAY SO                                       
         XC    X,X                 DEMO LIST FOR BLDMGN                         
         MVC   X(3),FRSTDEM        ONLY FIRST DEMO FOR REQ                      
         LA    RF,X                                                             
         ST    RF,MGADEM                                                        
         ST    RF,MGABRDEM                                                      
         GOTO1 VBLDMGN,MGABLKD                                                  
         CLI   MGAERR,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R5                                                               
*                                                                               
BYBLD4   DS    0H                  SET FLAG IF COS2 ELEMENT ON BUYLINE          
         NI    EDFLAG,X'FF'-EDC2YES    NEED FOR EARNED DISCOUNT                 
         LA    R8,BDELEM                                                        
BYBLD6   CLI   0(R8),0                                                          
         BE    BYBLD10                                                          
         CLI   0(R8),X'71'         COS2 ELEMENT PRESENT                         
         BNE   *+12                                                             
         OI    EDFLAG,EDC2YES                                                   
         B     BYBLD10                                                          
         LLC   R1,1(R8)                                                         
         AR    R8,R1                                                            
         B     BYBLD6                                                           
*                                                                               
BYBLD10  DS    0H                                                               
         LA    R8,BDELEM                                                        
NXTEL    BAS   RE,GETEL                                                         
         GOTO1 =A(PROCEL)                                                       
         CLI   BYSDT,0             NO DATE MEANS BUY NOT ACCEPTED               
         BE    NXTEL                                                            
NXTEL2   LA    R7,BYELEML(R7)                                                   
         C     R7,ABUFFX                                                        
         BNH   NXTEL                                                            
         MVI   ERROR,BUFERR                                                     
         OI    BUFFERR,BERRBUY     BUY RECORD OVERFLOW                          
         B     BYEXT                                                            
LSTEL    DS    0H                                                               
NXTREC   DS    0H                                                               
         C     R7,ANXTBY                                                        
         BE    NXTREC6                                                          
*                                  ADD TO BUY REC TAB                           
*                                  FIRST CHECK FOR COMMENTS                     
         XC    FULL,FULL                                                        
         CLI   ESTLOPT,C'Y'        COMMENTS ONLY IF EST-LIN ORDER               
         BNE   NXTREC5                                                          
         CLI   PROGOPT,C'N'        TEST DOING PROGRAM NAMES                     
         BE    NXR9                                                             
         CLI   BDPROGRM,C' '       TEST ANY PROGRAM                             
         BNH   NXR9                                                             
         CLI   ANXTCOM,X'FF'       TEST COMM AREA FULL                          
         BE    NXTREC5B                                                         
         LA    RE,BDPROGRM+L'BDPROGRM-1   GET LENGTH OF NAME                    
         CLI   0(RE),C' '                                                       
         BH    *+8                                                              
         BCT   RE,*-8                                                           
         LA    R0,BDPROGRM-4                                                    
         SR    RE,R0               RE HAS LENGTH +3                             
         L     RF,ANXTCOM                                                       
         LA    R0,0(RE,RF)                                                      
         C     R0,ACOMTABX         TEST WILL FIT                                
         BL    NXR8                                                             
         MVI   0(RF),0                                                          
         MVI   ANXTCOM,X'FF'                                                    
         B     NXTREC5B                                                         
*                                                                               
NXR8     DS    0H                                                               
         ST    RF,FULL              SAVE ADDR OF FIRST 'COMMENT'                
         MVI   0(RF),X'66'         SIMULATE COMMENT ELEM                        
         STC   RE,1(RF)            ELEM LENGTH                                  
         MVI   2(RF),0                                                          
         AHI   RE,-4                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   3(0,RF),BDPROGRM                                                 
         LA    RF,4(RF,RE)                                                      
         ST    RF,ANXTCOM                                                       
*                                                                               
NXR9     DS    0H                                                               
         CLI   MISSOPT,C'Y'        MISSED/MAKEGOOD OPTION                       
         BNE   NXR10                                                            
         OC    BDMGDATE,BDMGDATE   IS BUY A MAKEGOOD?                           
         BZ    NXR10                                                            
         CLI   BDMGDATE,X'C0'      OF THE OLD SCHOOL?                           
         BH    NXR10                                                            
         CLI   ANXTCOM,X'FF'       TEST COMM AREA FULL                          
         BE    NXTREC5B                                                         
         L     RF,ANXTCOM                                                       
         LA    R0,24(RF)           NEED 24 BYTES                                
         C     R0,ACOMTABX         TEST WILL FIT                                
         BL    NXR9D                                                            
         MVI   0(RF),0                                                          
         MVI   ANXTCOM,X'FF'                                                    
         B     NXTREC5B                                                         
*                                                                               
NXR9D    DS    0H                                                               
         OC    FULL,FULL                                                        
         BNZ   *+8                                                              
         ST    RF,FULL             SAVE ADDR OF FIRST 'COMMENT'                 
         LA    RE,24(RF)           ELEM LENGHT                                  
         ST    RE,ANXTCOM                                                       
         MVI   0(RF),X'66'         SIMULATE COMMENT ELEM                        
         MVI   1(RF),24            ELEM LENGTH                                  
         MVI   2(RF),0                                                          
         MVC   3(21,RF),SPACES                                                  
         MVC   3(10,RF),=C'MG FOR L0/'                                          
         LA    R4,12(RF)                                                        
*                                  FIND PKG ELEM FOR LINE NUMBER                
         LA    R8,BDELEM                                                        
*                                                                               
NXR9F    DS    0H                                                               
         CLI   0(R8),X'05'                                                      
         BE    NXR9J                                                            
         CLI   0(R8),0                                                          
         BE    NXR9L                                                            
NXR9H    DS    0H                                                               
         LLC   R0,1(R8)                                                         
         AR    R8,R0                                                            
         B     NXR9F                                                            
NXR9J    DS    0H                                                               
         CLI   PKGIND-PKGELEM(R8),X'18'  MG SLAVE?                              
         BE    *+12                      YES                                    
         CLI   PKGIND-PKGELEM(R8),8    MG SLAVE                                 
         BNE   NXR9H                                                            
         LA    R4,11(RF)                                                        
         LLC   R0,PKGLINES-PKGELEM(R8)                                          
         TM    PKGIND,X'10'        2-BYTE BUYLINE NUMBER?                       
         BZ    *+8                 NO                                           
         ICM   R0,3,PKGLINES-PKGELEM(R8)                                        
         EDIT  (R0),(3,0(R4)),ALIGN=LEFT                                        
         AR    R4,R0                                                            
         MVI   0(R4),C'/'                                                       
*                                                                               
NXR9L    DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,BDMGDATE),(7,DUB)                                 
         MVC   1(5,R4),DUB                                                      
         LA    R4,6(R4)                                                         
         LLC   R0,BDMGSPOT         SPOT NUMBER                                  
         CHI   R0,1                                                             
         BNH   NXR10                                                            
         MVI   0(R4),C'-'                                                       
         EDIT  (R0),(3,1(R4)),ALIGN=LEFT                                        
*                                                                               
NXR10    DS    0H                                                               
         CLI   COMOPT,C'N'                                                      
         BE    NXTREC5                                                          
         CLI   ANXTCOM,X'FF'       TEST COM AREA FULL                           
         BE    NXTREC5B                                                         
         LA    R8,BDELEM                                                        
*                                                                               
NXTREC2  DS    0H                                                               
         CLI   0(R8),X'66'                                                      
         BE    NXTREC4                                                          
         CLI   0(R8),0                                                          
         BE    NXTREC5                                                          
NXTREC3  DS    0H                                                               
         LLC   R0,1(R8)                                                         
         AR    R8,R0                                                            
         B     NXTREC2                                                          
NXTREC4  DS    0H                                                               
         GOTO1 =A(TSTCOM),RR=RELO    TEST COMMENT OK                            
         BNE   NXTREC3                                                          
         CLI   ANXTCOM,X'FF'                                                    
         BE    NXTREC5B                                                         
         L     RF,ANXTCOM                                                       
         OC    FULL,FULL                                                        
         BNZ   *+8                                                              
         ST    RF,FULL             SAVE A(FIRST COM)                            
         LLC   RE,1(R8)                                                         
         LA    R0,0(RF,RE)                                                      
         C     R0,ACOMTABX                                                      
         BL    NXTREC4B                                                         
         MVI   0(RF),0                                                          
         MVI   ANXTCOM,X'FF'       TABLE FULL                                   
         B     NXTREC5B                                                         
NXTREC4B DS    0H                                                               
         BCTR  RE,R0                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(R8)                                                    
         CLI   MCOMSW,C'Y'         IF A MONTHLY COMMENT                         
         BNE   NXTREC4D            FIX IT                                       
         CLI   1(R8),7             SKIP ELEM IF NOT MORE THAT *MON              
         BNH   NXTREC3                                                          
         AHI   RE,-7               SKIP *MON PREFIX                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   3(0,RF),7(R8)                                                    
         LA    RE,4(RE)                                                         
         STC   RE,1(RF)            SET NEW LENGTH                               
         BCTR  RE,R0                                                            
*                                                                               
NXTREC4D DS    0H                                                               
         LA    RF,1(RF,RE)                                                      
         ST    RF,ANXTCOM                                                       
         B     NXTREC3                                                          
*                                                                               
NXTREC5  DS    0H                                                               
         OC    FULL,FULL                                                        
         BZ    NXTREC5B                                                         
         L     RF,ANXTCOM                                                       
         MVI   0(RF),0             END OF COMMENTS FOR 1 BUYLIN                 
         LA    RF,1(RF)                                                         
         ST    RF,ANXTCOM                                                       
NXTREC5B DS    0H                                                               
         XC    WORK,WORK                                                        
         LA    R3,WORK                                                          
         USING BUYRTABD,R3                                                      
         MVC   BUYRPRD,BPRD                                                     
         MVC   BUYREST,BUYKEST                                                  
         MVC   BUYRLINE,BUYKBUY                                                 
         TM    BUYRCNTL,BUYRLN2    2-BYTE BUYLINE?                              
         BNZ   *+14                YES                                          
         MVI   BUYRLINE,0          CONVERT 1-BYTE TO 2-BYTE                     
         MVC   BUYRLINE+1(1),BUYKBUY                                            
         MVC   BUYRDA,KEY+14                                                    
         MVC   BUYRCOM,FULL                                                     
         GOTO1 BINSRCH,BUYRPARS,(1,(R3))                                        
         OC    BUYRPARS(4),BUYRPARS                                             
         BNZ   NXTREC6                                                          
         MVI   ERROR,BUFERR                                                     
         OI    BUFFERR,BERRCOM     BUY COMMENTS TABLE OVERFLOW                  
         B     BYEXT                                                            
         DROP  R3                                                               
NXTREC6  DS    0H                                                               
*                                  ADD DEMO TO DEMTAB                           
         CLI   QBOOK1,C' '                                                      
         BE    NXTREC7                                                          
         CLI   HBDEMC,0            **NOOP**                                     
         BC    0,NXTREC7           **NOOP**                                     
*                                                                               
         LA    R4,X                                                             
         USING DTABD,R4                                                         
         XC    X,X                                                              
         L     R6,ADEST                                                         
         MVC   DTABCOD,EDEMOS-ESTHDR(R6)                                        
*                                                                               
         CLC   ELEN-ESTHDR(2,R6),=AL2(ESTHDRLN) HAVE COMESCORE DEMOS?           
         BL    *+12                NO                                           
         LA    RE,ENONTDMS-ESTHDR(R6) YES - RE = A(COMSCORE DEMOS)              
         ST    RE,DMCB+16          PASS COMSCORE DEMOS IN P5                    
*                                                                               
         GOTO1 DEMOCON,DMCB,DTABCOD,(2,DTABNAM),(C'S',ADBLOCK),        X        
               (SPOTPROF+9,SPUSRNMS)                                            
         GOTO1 BINSRCH,DEMPARS,(1,DTABD)                                        
         DROP  R4                                                               
NXTREC7  DS    0H                                                               
NXTREC9  DS    0H                                                               
         ST    R7,ANXTBY                                                        
         BCTR  R7,R0                                                            
         ST    R7,ALBY                                                          
         B     BYEXT                                                            
         EJECT                                                                  
*                   FIND BUY ELEMENT                                            
         SPACE 3                                                                
GETEL    SR    R0,R0                                                            
GE2      IC    R0,RLEN                                                          
         AR    R8,R0                                                            
         CLI   RCODE,0                                                          
         BE    LSTEL                                                            
         CLI   RCODE,6                                                          
         BL    GE2                                                              
         CLI   RCODE,14                                                         
         BH    GE2                                                              
*                                  FOR POOL GET ELEM COUNT BY DATE              
         CLI   BUYKEY+3,X'FF'                                                   
         BNE   GE2C                                                             
         CLC   OLDDAT,RDATE                                                     
         BE    GE2B                                                             
         MVC   OLDDAT,RDATE                                                     
         MVI   SPTCNT,0                                                         
*                                                                               
GE2B     EQU   *                                                                
         TM    RSTATUS,X'80'       MINUS                                        
         BNZ   GE2C                                                             
         IC    R1,SPTCNT                                                        
         LA    R1,1(R1)                                                         
         STC   R1,SPTCNT                                                        
*                                                                               
GE2C     DS    0H                                                               
         CLC   RDATE,BQSTARTP      SPOT DATE VS START DATE                      
         BNL   GE2W                OK IF NOT LOW                                
         CLI   BUYKEY+3,X'FF'      ELSE, FOR POOL BUYS ONLY                     
         BNE   GE2                                                              
         CLC   BQSTARTP,BRDMON     IF START DATE = START OF MONTH               
         BNE   GE2                                                              
         CLC   RDATE,PREVWKP       PICK UP SPOTS IN LAST                        
         BL    GE2                 WEEK OF PREV MONTH                           
         LLC   R2,BDSEDAY          IF OUT-OF-WEEK                               
         SRDL  R2,4                (FOR OUT OF WEEK START DAY                   
         SRL   R3,28               IS HIGHER THAN END)                          
         CR    R2,R3                                                            
         BNH   GE2                                                              
*                                  AND IF NOT MATCHED IN PREV MONTH             
         LR    R2,R8                                                            
GE2D     DS    0H                                                               
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0             EOR                                          
         BE    GE2W                YES, SPOT IS OK                              
         CLI   0(R2),6             ANOTHER SPOT ELEM                            
         BL    GE2D                                                             
         CLI   0(R2),14                                                         
         BNH   GE2W                MEANS LAST SPOT NOT MATCHED                  
         CLI   0(R2),X'10'         AFFID ELEM                                   
         BNE   GE2D                                                             
         USING AFFELEM,R2                                                       
         CLC   ADATE,BRDMON        TEST MATCHED IN PREV MONTH                   
         BL    GE2                 YES, SKIP                                    
         DROP  R2                                                               
*                                                                               
GE2W     DS    0H                                                               
         CLC   RDATE,BQENDP                                                     
         BH    GE2                 OUT OF PERIOD-HIGH                           
         CLI   BUYKEY+3,X'FF'      TEST POL                                     
         BER   RE                                                               
*                                                                               
         TM    RSTATUS,X'80'       SKIP MINUS SPOT                              
         BNZ   GE2                                                              
         BR    RE                                                               
*                                                                               
BYEXT    EQU   *                                                                
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        PROCESS BUY ELEMENT                                                    
**********************************************************************          
*                                                                               
         DS    0D                                                               
PROCEL   NMOD1 0,PROCEL                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         ST    R8,LASTELAD         SAVE A(ELEM)                                 
         XC    BYELEM(BYELEML),BYELEM                                           
         CLI   BUYKEY+3,X'FF'                                                   
         BE    PR20                                                             
*                                                                               
*------- NON-POOL ROUTINES ------- GET NO. OF SPOTS ------------------          
*                                                                               
PR10     LR    R2,R8                                                            
         SR    R3,R3                                                            
         SR    R5,R5                                                            
         OI    BYSTAT,X'40'                                                     
         B     PR11A                                                            
PR11     LLC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    PR12                                                             
         CLI   0(R2),6             TEST SPOT ELEM                               
         BL    PR11                                                             
         CLI   0(R2),15                                                         
         BH    PR11                                                             
         CLC   RDATE,2(R2)         TEST DATES EQUAL                             
         BNE   PR12                                                             
PR11A    SR    R5,R5                                                            
         IC    R5,7(R2)                                                         
         TM    6(R2),X'80'         TEST MINUS SPOT                              
         BZ    *+6                                                              
         LCR   R5,R5                                                            
         AR    R3,R5                                                            
         ST    R2,LASTELAD         SAVE A(LAST ELEM FOR THIS DATE)              
         OC    GROSS(8),GROSS      CONSIDER ZERO SPOT AS PAID                   
         BNZ   *+12                                                             
         CLI   PROGPROF+13,C'N'    IF PROFILE OPTION ON                         
         BNE   PR11                                                             
         OC    4(2,R2),4(R2)       TEST PAID                                    
         BNZ   *+16                                                             
         NI    BYSTAT,X'BF'        UNPAID                                       
         MVI   ALLPAID,C'N'        FLAG TO AUTOPAY                              
         B     PR11                                                             
*                                  ADD TO PAID TOTALS                           
         L     R1,GROSS                                                         
         A     R1,TAXAMT                                                        
         A     R1,VATAMT                                                        
         LA    RF,(NPROVS-1)*4                                                  
         A     R1,PSTAMTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   *-8                                                              
         MR    R0,R5               X SPOTS                                      
         A     R1,PDGRS                                                         
         ST    R1,PDGRS                                                         
         L     R1,NET                                                           
         A     R1,TAXAMT                                                        
         A     R1,VATAMT                                                        
         LA    RF,(NPROVS-1)*4                                                  
         A     R1,PSTAMTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   *-8                                                              
         MR    R0,R5               X SPOTS                                      
         A     R1,PDNET                                                         
         ST    R1,PDNET                                                         
         B     PR11                                                             
*                                                                               
PR12     TM    RSTATUS,X'C0'       SKIP MINUS OR MINUSED SPOT                   
         BNZ   PREXT                                                            
         LTR   R3,R3               TEST ANY SPOTS LEFT                          
         BNP   PREXT               NO - EXIT                                    
         STC   R3,BYNOWK                                                        
         STC   R3,BYUNACH                                                       
*                                                                               
         L     R1,TAXAMT           ADD TAX INTO TOTAL                           
         MR    R0,R3               X NO. OF SPOTS                               
         A     R1,TAXTOT                                                        
         ST    R1,TAXTOT                                                        
*                                                                               
         L     R1,VATAMT           ADD VAT INTO TOTAL                           
         MR    R0,R3               X NO. OF SPOTS                               
         A     R1,VATTOT                                                        
         ST    R1,VATTOT                                                        
*                                                                               
         LA    RF,(NPROVS-1)*4     ADD PSTS INTO TOTALS                         
PR12C    DS    0H                                                               
         L     R1,PSTAMTS(RF)                                                   
         MR    R0,R3               X NO. OF SPOTS                               
         A     R1,PSTTOTS(RF)                                                   
         ST    R1,PSTTOTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   PR12C                                                            
*                                                                               
         MVC   BYCOST,GROSS                                                     
         MVC   BYNET,NET                                                        
         MVC   BYPRD,BUYKEY+3                                                   
         MVC   BYPRD2,PGPRD                                                     
         MVC   BYPRDNT,PRD         3 CHAR PRODUCT FOR NET                       
         MVC   BYPRD2NT,PRD2       3 CHAR PRODUCT2 FOR NET                      
         B     PR30                                                             
*                                                                               
*------- POOL ROUTINES ----------- GET NO. OF SPOTS ------------------          
*                                                                               
PR20     CLI   RLEN,10             TEST ALLOCATED                               
         BNE   PR21                YES                                          
         TM    RSTATUS,X'04'       HIATUS                                       
         BNZ   PREXT                                                            
         CLI   BPRD,X'FF'                                                       
         BNE   PREXT                                                            
         MVI   FULL,X'FF'          SET PRD = 'POL'                              
         MVI   FULL+1,0                                                         
         B     PR22                                                             
PR21     DS    0H                                                               
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL(1),RPPRD                                                    
         CLI   RLEN,18                                                          
         BNE   *+10                                                             
         MVC   FULL+1(1),RPPRD+4                                                
         SPACE 2                                                                
         CLI   BPRD,0                                                           
         BE    PR21D                                                            
         CLI   BPRD,X'FF'                                                       
         BE    PR21D                                                            
         CLC   BPRD,FULL                                                        
         BNE   PREXT                                                            
PR21D    DS    0H                                                               
         CLI   BPRD2,0             TEST SPECIFIC PIGGY                          
         BE    PR21F                                                            
         CLC   BPRD2,FULL+1        TEST RIGHT ONE                               
         BE    PR22                                                             
         B     PREXT                                                            
PR21F    DS    0H                                                               
         CLI   PIGCTL,C'N'         TEST EXCLUDING PIGS                          
         BNE   PR21G                                                            
         CLI   FULL+1,0                                                         
         BNE   PREXT                                                            
         B     PR22                                                             
PR21G    DS    0H                  SET PRD IN PIGLIST                           
         LLC   RF,FULL+1                                                        
         A     RF,APIGLIST                                                      
         MVC   0(1,RF),FULL+1                                                   
         SPACE 2                                                                
PR22     DS    0H                                                               
         OI    BYSTAT,X'02'        SET IS A POL SPOT                            
         MVI   BYNOWK,1            1 SPOT/ELEM                                  
         MVI   BYUNACH,1                                                        
         MVC   BYPRD(2),FULL       PRDS                                         
         IC    R0,BDTIME                                                        
         MVI   BDTIME,0            SET BDTIME TO 0                              
         TM    BDSTAT,X'80'        TEST NPW IN COST                             
         BZ    PR22B                                                            
         IC    R3,RPCOST           YES - SAVE NPW                               
         NI    RPCOST,X'03'                                                     
         OI    RPCOST,X'04'        SET NPW TO 1 FOR GETRATE                     
PR22B    DS    0H                                                               
         CLI   CANNET,C'Y'         IF CANADIAN NETWORK                          
         BNE   PR22D                                                            
**NOP**  OC    RPCOST,RPCOST       TEST NOP BECAUSE CANADIAN NETWORK            
**NOP**  BNZ   PR22D               NOW HAS COST OVERRIDES                       
**                                                                              
         MVI   BDPURP,X'FD'        TELL GETRATE TO GET COSTS                    
**                                                                              
PR22D    DS    0H                                                               
         XC    VATAMT,VATAMT                                                    
         XC    PSTAMTS,PSTAMTS                                                  
         LA    RF,X                 AREA FOR GETRATE XCHG DATA                  
         ST    RF,DMCB+12                                                       
         L     RE,ADAGY                                                         
*                                                                               
         CLI   CANADSW,C'Y'        IF CANADA                                    
         BNE   *+8                                                              
         MVI   DMCB+12,C'C'        SPECIFY CANADIAN CURRENCY                    
*                                                                               
         XC    SPOTS,SPOTS                                                      
         NI    EDFLAG,X'FF'-EDCOS2 HAVEN'T ADDED TO TOTS YET                    
         TM    SVCOPT4,COP4TRD     CLIENT TRADE=T                               
         BNO   PR22D2                                                           
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),=X'6901'    IS I2 MOS => JAN/05                          
         BL    PR22D2              IF NOT SKIP COS2 TRADE=T                     
PR22D1   XC    WORK(3),WORK                                                     
         GOTO1 VRCPACK,DMCB,(C'U',BDREP),WORK                                   
         CLC   DARREP,WORK         IS IT DAR TRADE REP?                         
         BNE   PR22D2                                                           
         OI    EDFLAG,EDTOTS+EDCOS2  - ADDED TO TOTS + PRINT THEM               
*                                                                               
*              GET ACTUAL COST FIRST FOR TOTALS                                 
         GOTO1 GETRATE,DMCB,(X'FF',SPOTS),ADBUY,(C'Z',(R8))                     
*                                                                               
         ICM   RF,15,GROSS         GROSS COST                                   
         CLI   A0GROSSN,C'N'       PAY BY NET?                                  
         BNE   *+8                 NO                                           
         ICM   RF,15,NET           YES - NET COST                               
         ICM   RE,15,TAX           TAX                                          
         STCM  RE,15,BYTAX         TAX AMOUNT FOR XAUTOPAY                      
         SR    RF,RE               GET TRUE COST (TAX WAS ADDED IN)             
         STCM  RF,15,BYXAPYGN      PAY TRUE COST FOR XAPY                       
*                                                                               
         CLI   MTRADE,C'Y'         MTRADE CLIENT?                               
         BNE   *+10                NO                                           
         MVC   BYGCOST1,GROSS      GROSS COST1 FOR MTRADE                       
*                                                                               
         ICM   RF,15,GROSS         TOTAL UP ACTUAL COST                         
         ICM   R1,15,EDCOST                                                     
         AR    RF,R1                                                            
         STCM  RF,15,EDCOST                                                     
         ICM   RF,15,NET           TOTAL UP ACTUAL NET                          
         ICM   R1,15,EDNET                                                      
         AR    RF,R1                                                            
         STCM  RF,15,EDNET                                                      
         MVC   WORK(L'GROSS+L'NET),GROSS   SAVE VALUES                          
*                                                                               
*              BUT MATCH WITH COST 2                                            
         MVC   SPOTS(4),=C'COS2'   USE COST2 $ TO MATCH ON                      
*                                                                               
PR22D2   GOTO1 GETRATE,DMCB,(X'FF',SPOTS),ADBUY,(C'Z',(R8))                     
*                                                                               
         TM    EDFLAG,EDCOS2       WE HAVE EARNED DISC COST2                    
         BNO   PR22D3                                                           
         CLC   GROSS(L'GROSS+L'NET),WORK IS COST=COST2                          
         BNE   PR22D3                                                           
         TM    EDFLAG,EDC2YES      EVEN THO = COST THERE IS A COS2              
         BO    PR22D3                         ELEMENT ON BUYLINE                
         OI    BYSTAT2,BYSTCS2Q    NO COS2=NO MATCH                             
*                                                                               
         ICM   RF,15,GROSS         SUBTRACT BAD COST OUT                        
         ICM   R1,15,EDCOST                                                     
         SR    R1,RF                                                            
         STCM  R1,15,EDCOST                                                     
         ICM   RF,15,NET                                                        
         ICM   R1,15,EDNET                                                      
         SR    R1,RF                                                            
         STCM  R1,15,EDNET                                                      
         XC    GROSS(L'GROSS+L'NET),GROSS  AND CLEAR                            
*                                                                               
PR22D3   XC    TAXAMT,TAXAMT       CLEAR TAX AMOUNT                             
         CLI   CANADSW,C'Y'        CANADA?                                      
         BNE   PR22E               NO                                           
         MVC   VATAMT,X+XGSTAMT-XGROSS    GST AMOUNT                            
         MVC   BYTAX,VATAMT        GST TAX                                      
         GOTO1 =A(GETPST),RR=RELO  GET PST AMOUNTS                              
*                                                                               
         CLI   TAXOPT,C'Y'         TAX OPTION?                                  
         BNE   PR23                NO                                           
         CLI   CANNET,C'Y'         CANADIAN NETWORK                             
         BNE   PR23                NO                                           
         TM    RSTATUS,X'C0'       0 TAX FOR MINUS/MINUSED                      
         BNZ   PR23                                                             
         BRAS  RE,CANTAX           DO SPECIAL TAX                               
         B     PR23                                                             
*                                                                               
PR22E    CLI   TAXOPT,C'Y'         TAX OPTION?                                  
         BNE   PR23                NO                                           
         OC    BDNTAX,BDNTAX                                                    
         BZ    PR23                                                             
*                                                                               
         XC    SPOTS,SPOTS                                                      
         TM    SVCOPT4,COP4TRD     CLIENT TRADE=T                               
         BNO   PR22E2                                                           
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),=X'6901'    IS I2 MOS => JAN/05                          
         BL    PR22E2              IF NOT SKIP COS2 TRADE=T                     
         GOTO1 VRCPACK,DMCB,(C'U',BDREP),WORK                                   
         CLC   DARREP,WORK         IS IT DAR TRADE REP?                         
         BNE   PR22E2                                                           
         MVC   SPOTS(4),=C'COS2'   USE COST2 $ TO MATCH ON                      
*                                  EXTRACT TAX FROM BUY                         
PR22E2   MVC   DUB(4),NET                                                       
         MVC   DUB+5(2),BDNTAX                                                  
         XC    BDNTAX,BDNTAX       COMPUTE COST WITHOUT TAX                     
         GOTO1 GETRATE,DMCB,(X'FF',SPOTS),ADBUY,(C'Z',(R8))                     
*                                                                               
         L     RF,DUB                                                           
         S     RF,NET                                                           
         ST    RF,TAXAMT                                                        
         OC    BYTAX,BYTAX         TAX ALREADY SET FOR COS2?                    
         BNZ   *+8                 YES - USE TAX FROM GROSS/NET!                
         STCM  RF,15,BYTAX         TAX AMOUNT FOR SPOT AUTOPAY                  
         MVC   BDNTAX,DUB+5                                                     
*                                                                               
PR23     MVC   BYCOST,GROSS                                                     
         MVC   BYNET,NET                                                        
         STC   R0,BDTIME                                                        
*                                                                               
         TM    BDSTAT,X'80'        TEST NPW IN COST  (POL RADIO)                
         BNZ   PR25                YES                                          
*                                                                               
         MVC   BYSPT,SPTCNT                                                     
*                                  ADD TO TAX TOTAL                             
         L     RF,TAXAMT                                                        
         A     RF,TAXTOT                                                        
         ST    RF,TAXTOT                                                        
*                                  ADD TO VAT TOTAL                             
         L     RF,VATAMT                                                        
         A     RF,VATTOT                                                        
         ST    RF,VATTOT                                                        
*                                  ADD PSTS INTO TOTALS                         
         LA    RF,(NPROVS-1)*4                                                  
PR23A2   DS    0H                                                               
         L     R1,PSTAMTS(RF)                                                   
         A     R1,PSTTOTS(RF)                                                   
         ST    R1,PSTTOTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   PR23A2                                                           
*                                                                               
PR23A4   DS    0H                                                               
         CLI   PROGPROF+13,C'N'    OPTION TO TREAT 0 SPOTS AS PAID              
         BE    PR23A6                                                           
         OC    GROSS(8),GROSS      CONSIDER ZERO SPOT AS PAID                   
         BNZ   PR23A6                                                           
         OC    TAXAMT,TAXAMT       TAX ZERO AS WELL                             
         BZ    PR23B                                                            
PR23A6   DS    0H                                                               
         OC    RPAY,RPAY                                                        
         BZ    PR23D                                                            
*                             ADD TO PAID TOTALS                                
         L     R1,PDGRS                                                         
         A     R1,GROSS                                                         
         A     R1,TAXAMT                                                        
         A     R1,VATAMT                                                        
         LA    RF,(NPROVS-1)*4                                                  
         A     R1,PSTAMTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   *-8                                                              
         ST    R1,PDGRS                                                         
         L     R1,PDNET                                                         
         A     R1,NET                                                           
         A     R1,TAXAMT                                                        
         A     R1,VATAMT                                                        
         LA    RF,(NPROVS-1)*4                                                  
         A     R1,PSTAMTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   *-8                                                              
         ST    R1,PDNET                                                         
*                                                                               
PR23B    DS    0H                                                               
         OI    BYSTAT,X'40'                                                     
PR23D    DS    0H                                                               
         TM    RSTATUS,X'C0'       SKIP MINUS/MINUSED SPOT                      
         BZ    PR30                                                             
         CLI   MISSOPT,C'Y'        UNLESS SHOWING THEM                          
         BNE   PREXT                                                            
         TM    RSTATUS,X'80'       BUT ALWAYS SKIP MINUS                        
         BNZ   PREXT                                                            
         TM    RSTATUS,X'02'       TEST MADE GOOD                               
         BZ    *+12                                                             
         OI    BYSTAT2,BYSTMDGQ                                                 
         B     *+8                                                              
         OI    BYSTAT2,BYSTPREQ    SET IS PREEMPTED                             
*                                                                               
*                                  GET MGA CODE FOR THIS ELEM                   
***      CLI   OPTMGA,C'Y'                                                      
***      BNE   PR24                                                             
         CLI   BEST,0              SKIP UNLESS BY EST                           
         BE    PR24                                                             
         LA    R5,MGADWRK                                                       
         USING MGABLKD,R5                                                       
         MVI   MGAACT,MGAQTRNS                                                  
         ST    R8,MGAELEM                                                       
         GOTO1 VBLDMGN,MGABLKD                                                  
         MVC   BYMGAMSC,MGAENTRY+MGECODE-MGENTRYD                               
         DROP  R5                                                               
*                                                                               
PR24     DS    0H                                                               
         B     PR30                                                             
*                                                                               
PR25     DS    0H                  NPW IN COST - (POL RADIO)                    
         STC   R3,RPCOST           RESTORE NPW                                  
         MVC   DUB(3),RPCOST       SAVE COST                                    
         NI    DUB,X'03'           STRIP 6 BITS                                 
         SR    R3,R3                                                            
         LR    R2,R8                                                            
         OI    BYSTAT,X'40'                                                     
         B     PR25D                                                            
*                                                                               
PR25B    DS    0H                                                               
         LLC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    PR25F                                                            
         CLI   0(R2),11                                                         
         BL    PR25B                                                            
         CLI   0(R2),12                                                         
         BH    PR25B                                                            
*                             COUNT SPOTS WITH SAME DATE,COST,ALLOC             
*                                                                               
         CLC   RDATE,2(R2)         DATE                                         
         BNE   PR25F                                                            
*                                                                               
         MVC   BYTE,RSTATUS                                                     
         XC    BYTE,6(R2)                                                       
         TM    BYTE,X'20'                                                       
         BNZ   PR25F               COST OVERRIDE STATUS NOT =                   
*                                                                               
         MVC   DUB+3(3),7(R2)                                                   
         NI    DUB+3,X'03'                                                      
         CLC   DUB(3),DUB+3                                                     
         BNE   PR25F               COST NOT =                                   
*                                                                               
         CLC   RLEN,1(R2)          ELEM LENTGH                                  
         BNE   PR25F                                                            
         CLI   RLEN,10                                                          
         BE    PR25D                                                            
         CLC   RPPRD,10(R2)        TEST SAME PRD ALLOC                          
         BNE   PR25F                                                            
         CLI   RLEN,14                                                          
         BE    PR25D                                                            
         CLC   14(1,R8),14(R2)     2N PRD                                       
         BNE   PR25F                                                            
*                                                                               
PR25D    DS    0H                                                               
         LLC   R5,7(R2)            NPW                                          
         SRL   R5,2                                                             
         TM    6(R2),X'80'         NEG ELEM                                     
         BZ    *+6                                                              
         LCR   R5,R5                                                            
         AR    R3,R5                                                            
*                                                                               
         ST    R2,LASTELAD         ADDR OF LAST USED ELEM                       
*                                                                               
         CLI   PROGPROF+13,C'N'    OPTION TO TREAT 0 SPOTS AS PAID              
         BE    *+14                                                             
         OC    GROSS(8),GROSS      TREAT ZERO SPOT AS PAID                      
         BZ    PR25E                                                            
         OC    4(2,R2),4(R2)                                                    
         BNZ   *+12                                                             
         NI    BYSTAT,X'BF'        SET UNPAID                                   
         B     PR25E                                                            
*                                                                               
*                                  ADD TO PAID TOTALS                           
         L     R1,GROSS                                                         
         A     R1,TAXAMT                                                        
         A     R1,VATAMT                                                        
         LA    RF,(NPROVS-1)*4                                                  
         A     R1,PSTAMTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   *-8                                                              
         MR    R0,R5               X SPOTS                                      
         A     R1,PDGRS                                                         
         ST    R1,PDGRS                                                         
         L     R1,NET                                                           
         A     R1,TAXAMT                                                        
         A     R1,VATAMT                                                        
         LA    RF,(NPROVS-1)*4                                                  
         A     R1,PSTAMTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   *-8                                                              
         MR    R0,R5               X SPOTS                                      
         A     R1,PDNET                                                         
         ST    R1,PDNET                                                         
*                                                                               
*                                                                               
PR25E    DS    0H                                                               
         B     PR25B                                                            
*                                                                               
PR25F    DS    0H                                                               
         LTR   R3,R3               TEST ANY SPOTS LEFT                          
         BP    *+14                                                             
         XC    BYELEM(BYELEML),BYELEM                                           
         B     PREXT                                                            
*                                                                               
         STC   R3,BYNOWK                                                        
         STC   R3,BYUNACH                                                       
*                                  ADD TAX INTO TOTAL                           
         L     R1,TAXAMT                                                        
         MR    R0,R3               X NO. OF SPOTS                               
         A     R1,TAXTOT                                                        
         ST    R1,TAXTOT                                                        
*                                  ADD VAT INTO TOTAL                           
         L     R1,VATAMT                                                        
         MR    R0,R3               X NO. OF SPOTS                               
         A     R1,VATTOT                                                        
         ST    R1,VATTOT                                                        
*                                  ADD PSTS INTO TOTALS                         
         LA    RF,(NPROVS-1)*4                                                  
PR26     DS    0H                                                               
         L     R1,PSTAMTS(RF)                                                   
         MR    R0,R3               X NO. OF SPOTS                               
         A     R1,PSTTOTS(RF)                                                   
         ST    R1,PSTTOTS(RF)                                                   
         AHI   RF,-4                                                            
         BNM   PR26                                                             
*                                                                               
*        COMMON ROUTINES - POL AND NON-POL                                      
*                                                                               
PR30     DS    0H                                                               
*                                                                               
         OC    RPAY,RPAY           TEST PAID                                    
         BNZ   PR30A               YES                                          
         MVI   ALLPAID,C'N'        FLAG TO AUTOPAY IF NOT PAID ALREADY          
         B     PR31                NO = NO PROBLEM                              
*                                                                               
PR30A    CLI   B0AFFDEL,C'N'       ALLOW UPDATE AFFIDS FOR PAID SPOTS?          
         BNE   PR31                                                             
         MVI   PSTOPT,C'X'         SET TO X = NO POSTING/B0 MESSAGE             
*                                                                               
PR31     MVC   BYDISK,KEY+14     DISK ADDR                                      
         TM    CBLHOPT,CBLHNHQ   IF CBH REQ AND NEW MODE SET CBLNET             
         BNO   PR32                                                             
         MVC   BYCBLNET,BUYKEY+8   LAST BYTE OF STATION                         
         NI    BYCBLNET,X'7F'      7 BITS ONLY - MAY BE NULLS                   
*                                                                               
PR32     DS    0H                                                               
         MVC   BYSDT,RDATE         SET DATE                                     
         MVC   BYBKTYPE,BKTYPE     BOOK TYPE                                    
         GOTO1 CVMIN,DMCB,BDPROG,BYSTIM   TIMES                                 
         MVC   BYDAY,BDDAY                                                      
         TM    BDSTAT2,X'80'       IF DAILY SKED                                
         BNZ   PR36                                                             
         CLI   RCODE,7             OR OTO                                       
         BE    PR36                                                             
         CLI   RCODE,12                                                         
         BNE   PR37                                                             
*                                  FOR OTO'S SET BYDAY TO SINGLE DAY            
PR36     EQU   *                                                                
         CLC   RDATE,DATINBH       CHECK SAME AS BEFORE                         
         BE    PR36B                                                            
         MVC   DATINBH,RDATE                                                    
         GOTO1 DATCON,DMCB,(2,RDATE),DUB                                        
         GOTO1 GETDAY,(R1),DUB,FULL                                             
*                                                                               
         LLC   R4,DMCB             DAY OF WEEK                                  
         LA    R3,X'80'                                                         
         SRL   R3,1                                                             
         BCT   R4,*-4                                                           
         STC   R3,DAYOTH                                                        
PR36B    MVC   BYDAY,DAYOTH                                                     
         MVC   BYEDT,BYSDT         END DATE = START                             
         IC    R0,DMCB             DAY OF WEEK                                  
         LR    R1,R0                                                            
         SLL   R0,4                                                             
         OR    R0,R1                                                            
         STC   R0,BYSEDAY          SET START-END DAY                            
*                                                                               
         LA    R3,1                FOR OTO NO. OF DAYS =1                       
         TM    BDSTAT2,X'80'       IF NOT DAILY SKED                            
         BNZ   PR39                                                             
         CLC   BYDAY,BYTE2         AND OTO DATE = START DAY OF ROTATOR          
         BNE   PR39                                                             
         MVC   BYDAY,BDDAY         USE FULL ROTATOR                             
PR37     EQU   *                                                                
*                                  COMPUTE NO. OF DAYS                          
         SR    R3,R3                                                            
         IC    R4,BDDAY                                                         
         LA    R0,7                                                             
PR38     SRDL  R4,1                                                             
         SRL   R5,31                                                            
         AR    R3,R5                                                            
         BCT   R0,PR38                                                          
PR39     LLC   R2,BYNOWK                                                        
         MR    R2,R2               X NO. PER WK                                 
         MVC   FULL,BYSTIM                                                      
         L     R4,FULL                                                          
         SRDL  R4,16                                                            
         SRL   R5,16                                                            
         SR    R5,R4               END - START                                  
         BP    *+6                                                              
         LPR   R5,R5                                                            
         MR    R2,R5               X MINUTES                                    
         STC   R3,BYAMPW+1                                                      
         SRL   R3,8                                                             
         STC   R3,BYAMPW                                                        
         MVC   BYEST,BUYKEY+9                                                   
         MVC   BYLIN,BUYKBUY                                                    
         TM    BUYRCNTL,BUYRLN2    2-BYTE BUYLINE?                              
         BNZ   *+14                YES                                          
         MVI   BYLIN,0             CONVERT 1-BYTE TO 2-BYTE                     
         MVC   BYLIN+1(1),BUYKBUY                                               
                                                                                
         MVC   BYLEN,BDSEC                                                      
*                                                                               
         CLI   BDMGDATE,X'C1'      TEST HAVE MGA CODE FOR BUY                   
         BL    *+10                                                             
         MVC   BYMGAMGC,BDMGDATE                                                
*                                                                               
         MVC   BYCOPY,HCOPY                                                     
         MVC   BYDEMVR(9),HBDEMVR  SET ALL DEMOS                                
         MVC   BYPROGRM,BDPROGRM         SAVE FIRST LETTER OF PROGRAM           
         CLC   BDPROGRM(9),=C'AUTO - I4'    CORRECT FOR OLD I4 BUG              
         BE    PR40                                                             
         CLI   BDPROG+21,0         TEST SPECIAL (-S)                            
         BNE   *+8                                                              
         OI    BYSTAT,X'80'                                                     
*                                                                               
PR40     DS    0H                                                               
         CLC   BYDAY,BDDAY         IS IT A SINGLE DAY OTO?                      
         BNE   PR40J               YES, DON'T USE BYSEDAY                       
         MVC   BYSEDAY,BDSEDAY     NO, SET BYSEDAY, BYEDT, ETC                  
         CLI   BDSEDAY,0           TEST PRESENT                                 
         BH    PR40H                                                            
         MVC   BYTE,BYDAY          NO, FIGURE THEM OUT                          
         GOTO1 SETSEDAY                                                         
         MVC   BYSEDAY,BYTE        START/END DAY RETURNED IN BYTE               
PR40H    DS    0H                                                               
         MVC   BYEDT,BYSDT         SET END DATE=START                           
         LLC   R0,BYSEDAY          CALC DAYS IN ROTATOR                         
         LR    R5,R0                                                            
         SR    R4,R4                                                            
         SLDL  R4,28                                                            
         SRL   R5,28                                                            
         SR    R5,R4               R5 HAS NUMBER OF DAYS                        
         BE    PR40J               TO ADD TO GET TO END DATE                    
         BP    *+8                                                              
         AHI   R5,7                IF END LESS START ADD 7 DAYS                 
*                                                                               
         GOTO1 DATCON,DMCB,(2,BYSDT),DUB                                        
         GOTO1 ADDAY,(R1),DUB,DUB,(R5)                                          
         GOTO1 DATCON,(R1),DUB,(2,BYEDT)                                        
*                                                                               
PR40J    DS    0H                                                               
         CLC   BYEDT,BQENDP        IF OUT OF WEEK BUY EXTENDS PAST              
         BNH   PR40L               END OF PERIOD, SKIP BUY                      
*                                  IF MATCHED IN NEXT MONTH                     
         LR    R2,R8               (NO LONGER 'DEFERRED')                       
PR40J4   DS    0H                                                               
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0             EOR                                          
         BE    PR40L               YES, SPOT IS OK                              
         CLI   0(R2),6             ANOTHER SPOT ELEM                            
         BL    PR40J4                                                           
         CLI   0(R2),14                                                         
         BNH   PR40L               MEANS LAST SPOT NOT MATCHED                  
         CLI   0(R2),X'10'         AFFID ELEM                                   
         BNE   PR40J4                                                           
         USING AFFELEM,R2                                                       
         CLC   ADATE,BQENDP        TEST MATCHED IN NEXT MONTH                   
         BNH   PR40L               NO, SPOT OK                                  
         MVI   BYSDT,0             YES, SKIP SPOT                               
*                                  AND SUBTRACT FROM PAID AND TAX TOTS          
         LLC   RF,BYNOWK           NUMBER OF SPOTS                              
         TM    BYSTAT,X'40'        TEST SPOT PAID                               
         BZ    PR40K                                                            
         L     R1,GROSS                                                         
         A     R1,TAXAMT                                                        
         A     R1,VATAMT                                                        
         LA    RE,(NPROVS-1)*4                                                  
         A     R1,PSTAMTS(RE)                                                   
         AHI   RE,-4                                                            
         BNM   *-8                                                              
         MR    R0,RF               X SPOTS                                      
         LCR   R1,R1                                                            
         A     R1,PDGRS                                                         
         ST    R1,PDGRS                                                         
         L     R1,NET                                                           
         A     R1,TAXAMT                                                        
         A     R1,VATAMT                                                        
         LA    RE,(NPROVS-1)*4                                                  
         A     R1,PSTAMTS(RE)                                                   
         AHI   RE,-4                                                            
         BNM   *-8                                                              
         MR    R0,RF               X SPOTS                                      
         LCR   R1,R1                                                            
         A     R1,PDNET                                                         
         ST    R1,PDNET                                                         
PR40K    DS    0H                                                               
         L     R1,TAXAMT                                                        
         MR    R0,RF               X SPOTS                                      
         LCR   R1,R1                                                            
         A     R1,TAXTOT                                                        
         ST    R1,TAXTOT                                                        
*                                                                               
         L     R1,VATAMT                                                        
         MR    R0,RF               X SPOTS                                      
         LCR   R1,R1                                                            
         A     R1,VATTOT                                                        
         ST    R1,VATTOT                                                        
*                                  ADD PSTS INTO TOTALS                         
         LA    RE,(NPROVS-1)*4                                                  
PR40K4   DS    0H                                                               
         L     R1,PSTAMTS(RE)                                                   
         MR    R0,RF               X NO. OF SPOTS ---GEESH WAS R3 BUG           
         LCR   R1,R1                                                            
         A     R1,PSTTOTS(RE)                                                   
         ST    R1,PSTTOTS(RE)                                                   
         AHI   RE,-4                                                            
         BNM   PR40K4                                                           
*                                                                               
         B     PREXT                                                            
         DROP  R2                                                               
*                                                                               
PR40L    DS    0H                                                               
         OC    BYSREP,BDREP                                                     
         BZ    PR41                                                             
         MVI   SREPSW,C'Y'         SET HAVE SREPS                               
*                                  TEST SKIP SYND TEST                          
         CLI   SREPOPT,C'N'                                                     
         BE    PR41                                                             
         L     RF,ADREP                                                         
         CLI   RSYND-REPREC(RF),C'S'                                            
         BE    PR42                                                             
PR41     DS    0H                                                               
         TM    BDCIND2,X'04'       BDCIND IS A CHARACTER                        
         BZ    PR41A                                                            
         CLI   BDCIND,BDCNTP       TEST NTP SPOT                                
         BNE   PR42B                                                            
         B     PR41B                                                            
PR41A    TM    BDCIND,X'FE'        TEST NTP SPOT                                
         BNZ   PR42B                                                            
PR41B    TM    SVCOPT1,COP1GMI     CLIENT MARKED GMI CLIENT                     
         BO    PR42                                                             
         CLC   QAGY,=C'DF'         DANCER ONLY                                  
         BNE   PR42B                                                            
PR42     DS    0H                                                               
         OI    BYSTAT,X'20'                                                     
PR42B    DS    0H                                                               
         CLI   BDMGDATE,0                                                       
         BE    *+8                                                              
         OI    BYSTAT,X'04'        MAKE-GOOD                                    
         L     R0,GROSS                                                         
         LTR   R0,R0                                                            
         BNM   PR43                                                             
         LPR   R0,R0                                                            
         ST    R0,DUB                                                           
         MVC   BYCOST,DUB                                                       
         L     R0,NET                                                           
         LPR   R0,R0                                                            
         ST    R0,DUB                                                           
         MVC   BYNET,DUB                                                        
         OI    BYSTAT,X'01'                                                     
PR43     DS    0H                                                               
         CLI   CENTS,C'Y'                                                       
         BE    PR44                                                             
*                                                                               
         MVC   DUB(4),BYCOST                                                    
         L     R0,DUB                                                           
         LA    RF,100                                                           
         BAS   RE,PRDIV                                                         
         ST    R1,DUB                                                           
         MVC   BYCOST,DUB                                                       
*                                                                               
         MVC   DUB(4),BYNET                                                     
         L     R0,DUB                                                           
         LA    RF,100                                                           
         BAS   RE,PRDIV                                                         
         ST    R1,DUB                                                           
         MVC   BYNET,DUB                                                        
*                                                                               
PR44     DS    0H                                                               
         L     RF,ADSTAT                                                        
         CLC   BDNTAX,SNEWTAX-STAREC(RF)    TEST TAX %= STATION TAX %           
         BE    *+8                                                              
         OI    BYSTAT2,BYSTTNEQ                                                 
*                                  SET FILM NUMBERS                             
         CLI   TRAFMBF,C'Y'        TEST OPTION                                  
         BE    *+12                                                             
         CLI   TRAFMBF,C'B'                                                     
         BNE   PR45H                                                            
         LR    RF,R8               LOOK FOR FILM ASSIGN ELEMS                   
         B     PR45D                                                            
*                                                                               
PR45     DS    0H                                                               
         CLI   0(RF),0             EOR                                          
         BE    PR45H                                                            
         CLI   0(RF),6             ON ANY NEW SPOT ELEM                         
         BL    PR45D                                                            
         CLI   0(RF),14                                                         
         BNH   PR45H               DONE WITH THIS SPOT                          
         CLI   0(RF),X'18'         TRAFFIC ELEM                                 
         BNE   PR45D                                                            
         USING TRACID,RF                                                        
         MVC   BYFILM(4),TRACCSQ   FILM 1 AND FILM 2                            
         B     PR45H                                                            
         DROP  RF                                                               
*                                                                               
PR45D    DS    0H                                                               
         LLC   R0,1(RF)                                                         
         AR    RF,R0                                                            
         B     PR45                                                             
*                                                                               
PR45H    DS    0H                                                               
*                                  ORBIT LOGIC                                  
*                                                                               
*                                  FIND ORBIT ELEM                              
         LA    R2,BDELEM                                                        
PR52     DS    0H                                                               
         LLC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),X'67'                                                      
         BE    PR53                                                             
         CLI   0(R2),0                                                          
         BE    PREXT               NO ORBIT ELEM                                
         B     PR52                                                             
*                                                                               
PR53     DS    0H                                                               
         USING ORBELEM,R2                                                       
         MVI   ORBSW,C'Y'          SET HAVE ORBITS                              
         OI    BYSTAT,X'10'        SET ORBIT MASTER                             
         IC    RF,ORBCNT                                                        
         LA    RF,1(RF)                                                         
         STC   RF,ORBCNT                                                        
         STC   RF,BYORBNO          ORBIT LINK NO.                               
         XC    BYSTIM(4),BYSTIM    NO TIMES FNO ORBIT MASTER                    
         GOTO1 DATCON,DMCB,(2,BYSDT),X                                          
         MVC   HALF,BYSDT                                                       
         MVC   WORD(1),BYSEDAY     SAVE MASTER BYSEDAY                          
*                                                                               
         LA    R6,ORBDAY           FIRST SHOW                                   
         LLC   R4,ORBLEN                                                        
         AR    R4,R2               POINT TO END OF ELEM                         
*                                                                               
PR56     DS    0H                                                               
         LA    R3,ORBTIME-ORBDAY(R6)                                            
         GOTO1 CVMIN,DMCB,(R3),FULL                                             
         MVC   BYELEML(BYELEML,R7),0(R7)    COPY LAST ELEM                      
         LA    R7,BYELEML(R7)                                                   
*                                                                               
         NI    BYSTAT,X'EF'        SET OFF ORB MASTER                           
         OI    BYSTAT,X'08'        SET ON ORB SLAVE                             
         MVC   BYDAY,0(R6)         DAY                                          
*                                                                               
         MVC   BYTE,0(R6)          GET START/END DAYS AND END DATE              
         GOTO1 SETSEDAY                                                         
         MVC   BYSEDAY,BYTE                                                     
*                                                                               
         LLC   RF,BYSEDAY                                                       
         SRL   RF,4                RF HAS START DAY                             
         LLC   RE,WORD             MASTER SEDAY                                 
         SRL   RE,4                                                             
         SR    RF,RE                                                            
         BNM   *+8                                                              
         AHI   RF,7                DEAL WITH OUT-OF-WEEKS                       
         ST    RF,DMCB+8           NO OF DAYS TO GET TO START DATE              
         GOTO1 ADDAY,DMCB,X,DUB                                                 
         GOTO1 DATCON,(R1),DUB,(2,BYSDT)                                        
*                                                                               
         LLC   RF,BYSEDAY          CALC DAYS IN ROTATOR                         
         SR    RE,RE                                                            
         SLDL  RE,28                                                            
         SRL   RF,28                                                            
         SR    RF,RE               RF HAS NUMBER OF DAYS                        
         ST    RF,DMCB+8           TO ADD TO GET TO END DATE                    
         GOTO1 ADDAY,DMCB,DUB,DUB                                               
         GOTO1 DATCON,(R1),DUB,(2,BYEDT)                                        
*                                                                               
PR58     DS    0H                                                               
         MVC   BYSTIM(4),FULL      START-END TIMES                              
         LA    RF,ORBDEM-ORBDAY(R6)                                             
         OC    0(2,RF),0(RF)                                                    
         BZ    PR58A                                                            
         MVC   BYDEMV+2(2),0(RF)   ORBITS ARE 2 BYTE DEMO VALUES                
         NI    BYDEMV+2,X'3F'      TURN OFF OVRD/2-DEC FLAGS                    
         TM    0(RF),X'80'         DEMO OVERRIDE?                               
         BZ    *+8                 NO                                           
         OI    BYDEMV,X'80'        YES, SET DEMO OVERRIDE ON HOB                
         TM    0(RF),X'40'         2-DECIMAL DEMO?                              
         BZ    *+8                 NO                                           
         OI    BYDEMV,X'40'        YES, SET 2-DECIMAL DEMO ON HOB               
*                                                                               
PR58A    LA    R6,16(R6)                                                        
         CR    R6,R4               TEST END OF ELEM                             
         BL    PR56                                                             
*                                  DONT RESTORE R7 + R8                         
PREXT    EQU   *                                                                
         L     R8,LASTELAD                                                      
         XIT1  REGS=(R7,R8)                                                     
         SPACE 2                                                                
PRDIV    DS    0H                                                               
         SR    R1,R1                                                            
         SRDL  R0,31                                                            
         DR    R0,RF                                                            
         LTR   R1,R1                                                            
         BM    *+8                                                              
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
         BR    RE                                                               
         EJECT                                                                  
*****************************************************************               
*        ROUTINE FOR CANADIAN NETWORK TAX                                       
*****************************************************************               
CANTAX   NTR1                                                                   
         LA    R2,BDELEM                                                        
         XR    R0,R0                                                            
*                                                                               
CANTAX4  CLI   0(R2),0             END OF RECORD?                               
         BE    CANTAXX             YES - NO TAX                                 
         CLI   0(R2),X'69'         TAX ELEMENT?                                 
         BE    CANTAX6             YES                                          
         ICM   R0,1,1(R2)          HAVE ELEMENT LENGTH?                         
         BZ    CANTAXX             NO                                           
         AR    R2,R0               YES - BUMP LENGTH                            
         B     CANTAX4             TEST FOR X'69' ELEMENT                       
*                                                                               
CANTAX6  MVC   TAXAMT,2(R2)        TAX IN DOLLARS AND CENTS                     
         ICM   RE,15,BYTAX         HAVE GST                                     
         A     RE,TAXAMT           ADD IN NETWORK TAX                           
         STCM  RE,15,BYTAX         TOTAL TAX THUS FAR                           
*                                                                               
CANTAXX  XIT1                                                                   
*                                                                               
*        CONVERT MIL TIMES TO MINS                                              
*                                                                               
CVMIN    NTR1                                                                   
         SPACE 2                                                                
         LM    R2,R3,0(R1)         R2 = INPUT, R3=OUTPUT                        
         LA    R0,2                                                             
         MVC   DUB(4),0(R2)                                                     
         OC    DUB+2(2),DUB+2      IF END TIME ZERO                             
         BNZ   *+10                                                             
         MVC   DUB+2(2),DUB        SET END = START                              
         LA    R2,DUB                                                           
*                                                                               
CVMIN2   DS    0H                                                               
         LH    R5,0(R2)                                                         
         CHI   R5,600                                                           
         BNL   *+8                                                              
         AHI   R5,2400                                                          
         SR    R4,R4                                                            
         D     R4,=F'100'                                                       
         MHI   R5,60                                                            
         AR    R4,R5               R4 = MINUTES                                 
         STC   R4,1(R3)                                                         
         SRL   R4,8                                                             
         STC   R4,0(R3)                                                         
         LA    R2,2(R2)                                                         
         LA    R3,2(R3)                                                         
         BCT   R0,CVMIN2                                                        
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        SETSEDAY - ROUTINE TO SET START-END DAY FROM DAY ROTATOR               
*                   ON INPUT BYTE HAS ROTATOR, ON OUTPUT HAS                    
*                   START DAY IN HIGH NIBBLE, END IN LOW,                       
***********************************************************************         
         SPACE 2                                                                
SETSEDAY NMOD1 0,SETSED                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         LA    RF,SEDLST                                                        
         LA    R3,7                                                             
         LA    R5,SEDLST-1                                                      
*                                                                               
SSED4    DS    0H                                                               
         LLC   RE,0(RF)                                                         
         EX    RE,SEDTM            IS DAY ACTIVE?                               
         BZ    SSED6                                                            
         LR    RE,RF               YES                                          
         SR    RE,R5                                                            
         LTR   R0,R0               IS IT THE FIRST?                             
         BNZ   *+6                                                              
         LR    R0,RE               SET AS FIRST                                 
         LR    R1,RE               LASTEST IS LAST                              
*                                                                               
SSED6    DS    0H                                                               
         LA    RF,1(RF)                                                         
         BCT   R3,SSED4                                                         
*                                                                               
         SLL   R0,4                                                             
         OR    R0,R1               GET INTO 8 BITS                              
         STC   R0,BYTE             RETURN IN BYTE                               
*                                                                               
SSEDX    DS    0H                                                               
         XIT                                                                    
*                                                                               
SEDLST   DC    X'40201008040201'                                                
SEDTM    TM    BYTE,0                                                           
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                   TEST COMMENT USABLE                                         
*                   R8 POINTS TO COMMENT ELEM                                   
***********************************************************************         
TSTCOM   NMOD1 0,TSTCOM                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   MCOMSW,C'N'         SET COMMENT IS NOT A MONTHLY                 
         CLI   MCOMOPT,C'Y'                                                     
         BNE   TSTCOMY                                                          
         LR    R2,R8                                                            
         USING COMELEM,R2                                                       
         CLI   CMDATA,C'*'         TEST STARTS WITH *MON                        
         BNE   TSTCOMY             NO, OK                                       
         LA    RF,TCMONTAB                                                      
         LA    R0,12                                                            
*                                                                               
TCOM04   DS    0H                                                               
         CLC   CMDATA+1(3),0(RF)                                                
         BE    TCOM06                                                           
         LA    RF,4(RF)                                                         
         BCT   R0,TCOM04                                                        
         B     TSTCOMY                                                          
*                                                                               
TCOM06   DS    0H                                                               
         MVI   MCOMSW,C'Y'         SET IS A MONTHLY COMMENT                     
         XC    DUB,DUB             BUILD YYMMDD IN DUB                          
         MVC   DUB(1),BDSTART      USE BDSTART YEAR                             
         CLC   3(1,RF),BDSTART+1   UNLESS MONTH LOWER THAT START MONTH          
         BNL   TCOM07                                                           
         LLC   R1,BDSTART          ELSE USE NEXT YEAR                           
         LA    R1,1(R1)                                                         
         STC   R1,DUB                                                           
*                                                                               
TCOM07   DS    0H                                                               
         MVC   DUB+1(1),3(RF)      SET MONTH                                    
         MVI   DUB+2,15            15TH OF MONTH                                
*                                                                               
         GOTO1 DATCON,DMCB,(3,DUB),(2,DUB)                                      
         CLC   DUB(2),BQSTARTP     TEST RESULT WITHIN REQ START/END             
         BL    TSTCOMN                                                          
         CLC   DUB(2),BQENDP                                                    
         BH    TSTCOMN                                                          
         DROP  R2                                                               
*                                                                               
TSTCOMY  CR    RD,RD                                                            
         B     TSTCOMX                                                          
TSTCOMN  LTR   RD,RD                                                            
TSTCOMX  XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
TCMONTAB DS    0X                                                               
         DC    C'JAN',AL1(1)                                                    
         DC    C'FEB',AL1(2)                                                    
         DC    C'MAR',AL1(3)                                                    
         DC    C'APR',AL1(4)                                                    
         DC    C'MAY',AL1(5)                                                    
         DC    C'JUN',AL1(6)                                                    
         DC    C'JUL',AL1(7)                                                    
         DC    C'AUG',AL1(8)                                                    
         DC    C'SEP',AL1(9)                                                    
         DC    C'OCT',AL1(10)                                                   
         DC    C'NOV',AL1(11)                                                   
         DC    C'DEC',AL1(12)                                                   
         EJECT                                                                  
***********************************************************************         
*        PROCDEM - BUY RECORD DEMO ROUTINE                                      
*                  NOTE- WORK REGISTERS TAKEN FROM BYBLD                        
***********************************************************************         
*                                                                               
PROCDEM  NMOD1 0,PROCDEM                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         XC    X,X                                                              
         MVC   X+1(1),BAGYMD                                                    
         MVC   X+2(2),BCLT                                                      
         MVC   X+4(3),PRD                                                       
         MVC   X+7(1),BUYKEST                                                   
         L     R5,ADEST                                                         
         CLC   X(13),0(R5)                                                      
         BE    PD10                                                             
         MVC   WORK(64),KEY                                                     
         MVC   KEY,X                                                            
         GOTO1 READ                                                             
         GOTO1 GETEST                                                           
         MVC   KEY(64),WORK                                                     
         GOTO1 HIGH                RESTORE SEQ READ                             
PD10     DS    0H                                                               
         MVI   HCOPY,0                                                          
         CLI   TRAFFRPT,C'Y'       TEST DOING FILM USE REPORT                   
         BE    *+12                                                             
         CLI   TRAFFRPT,C'E'                                                    
         BNE   *+10                                                             
         MVC   HCOPY,ECOPY-ESTHDR(R5)   SAVE TRAF COPY CODE                     
         CLI   QBOOK1,C' '          IF DEMOS NOT NEEDED                         
         BE    PROCDEMX            HERE ONLY FOR COPY CODE                      
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BE    PROCDEMX            YES - HERE ONLY FOR COPY CODE                
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    PROCDEMX            YES - HERE ONLY FOR COPY CODE                
         XC    HBDEMS,HBDEMS                                                    
         LA    R2,BUYREC+24                                                     
PD12     DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    PD15                                                             
         CLI   0(R2),2                                                          
         BE    PD14                                                             
         LLC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PD12                                                             
PD14     DS    0H                                                               
         LLC   R0,1(R2)                                                         
         SHI   R0,NDEMNO-NDELEM                                                 
         SRL   R0,3                R0 = NO. OF DEMOS                            
         LTR   R0,R0                                                            
         BZ    PD15                                                             
         LA    R2,NDEMNO-NDELEM(R2)                                             
*                                                                               
         USING ESTHDR,R5           ESTIMATE RECORD USING                        
*                                                                               
PD14B    DS    0H                                                               
         MVC   WORK(3),0(R2)                                                    
         CLI   WORK+2,0            IS THIS BUY DEMO A COMSCORE DEMO?            
         BNE   PD14B1              NO                                           
         CLI   EDEMOS+2,0          PRIMARY ESTIMATE DEMO COMSCORE?              
         BNE   PD14C               NO                                           
         LLC   R1,EDEMOS+1         PRIMARY DEMO INDEX INTO ENONTDMS             
         BCTR  R1,0                -1                                           
         MHI   R1,8                *8                                           
         L     RE,VNONTNMS         NON-TRADITIONAL DEMO NAMES ON EST            
         AR    RE,R1               INDEX TO PRIMARY DEMO NAME ON EST            
*                                                                               
         LLC   R1,WORK+1           DEMO INDEX INTO NTDDMONM                     
         BCTR  R1,0                -1                                           
         MHI   R1,9                *9                                           
         L     RF,VPOL50EL         A(X'50' ELEMENT) FROM BUY RECORD             
         LA    RF,2(R1,RF)         INDEX TO DEMO NAME ON BUY RECORD             
         CLC   0(8,RE),0(RF)       DEMO NAMES MATCH?                            
         BE    PD14D               YES                                          
         B     PD14C               NO                                           
*                                                                               
PD14B1   CLC   WORK(3),EDEMOS-ESTHDR(R5)   TEST 1ST BUY EST DEMO                
         BE    PD14D                                                            
         CLC   WORK(3),DCLIST      TEST 1ST REQ DEMO                            
         BE    PD14D                                                            
*                                                                               
PD14C    DS    0H                                                               
         LA    R2,8(R2)                                                         
         BCT   R0,PD14B                                                         
         B     PD15                                                             
*                                                                               
PD14D    BRAS  RE,SETDEMV          GET SCALED VALUE OF DEMO                     
*                                                                               
PD14E    CLC   WORK(3),EDEMOS-ESTHDR(R5)   TEST 1ST BUY EST DEMO                
         BNE   PD14F                                                            
         MVC   HBDEMV,FULL         DEMO VALUE                                   
         TM    4(R2),X'80'                                                      
         BZ    *+8                                                              
         OI    HBDEMV,X'80'        SET BUYER OVERRIDE                           
         OI    HBDEMSW,X'80'       SET HAVE BUY EST DEMO                        
*                                  GET RELATIVE DEMO NUMBER                     
PD14F    DS    0H                                                               
         LA    RF,DCLIST                                                        
PD14G    DS    0H                                                               
         CLC   WORK(3),0(RF)                                                    
         BE    PD14N                                                            
         OC    0(3,RF),0(RF)       EOL                                          
         BZ    PD14N                                                            
         LA    RF,4(RF)                                                         
         B     PD14G                                                            
*                                                                               
PD14N    DS    0H                                                               
         MVC   0(3,RF),WORK                                                     
         CLI   HBDEMC,0                                                         
         BNE   PD14O                                                            
         LA    RE,DCLIST-4                                                      
         SR    RF,RE                                                            
         SRL   RF,2                                                             
         STC   RF,HBDEMC       HOLD RELATIVE DEMO NUMBER                        
*                                                                               
PD14O    DS    0H                                                               
         CLC   WORK(3),DCLIST                                                   
         BNE   PD14P                                                            
         MVC   HBDEMVR,FULL                                                     
         TM    4(R2),X'80'                                                      
         BZ    *+8                                                              
         OI    HBDEMVR,X'80'        SET BUYER OVERRIDE                          
         OI    HBDEMSW,X'40'       SET HAVE REQ DEM                             
*                                                                               
PD14P    DS    0H                                                               
         TM    HBDEMSW,X'C0'       TEST HAVE BOTH DEMOS                         
         BO    PD15                                                             
         B     PD14C               TRY ANOTHER DEMO                             
PD15     DS    0H                                                               
PROCDEMX XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*             TEST BUY RECORD                                                   
***********************************************************************         
TSTREC   NMOD1 0,TSTREC                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLC   KEY+4(2),BUYMSTA   TEST SPILL IN PASSIVE                         
         BE    TR0                 NO- OK                                       
         MVI   SPILSW,C'Y'         YES- SET SPILL SWITCH                        
         B     TRNO                AND BYPASS                                   
TR0      DS    0H                                                               
         CLI   QOPT5+1,C' '        TEST DAYPART FILTER                          
         BNH   TR0C                                                             
         CLC   BDDAYPT,QOPT5+1                                                  
         BNE   TRNO                                                             
*                                                                               
TR0C     DS    0H                                                               
         TM    BDCIND2,X'04'       TEST BDCIND IS CHARACTER?                    
         BZ    TR0D                                                             
         TM    BDCIND2,BDC2NEG                                                  
         BO    TR0E                                                             
         B     TR1                                                              
*                                                                               
TR0D     TM    BDCIND,X'01'        TEST NEGATIVE BUY                            
         BZ    TR1                 NO                                           
TR0E     OC    BDCOST,BDCOST       YES - IS COST 0                              
         BZ    TRNO                YES - BYPASS                                 
TR1      DS    0H                                                               
         TM    BUYRCNTL,X'80'       TEST DELETED RECORD                         
         BNZ   TRNO                                                             
         MVI   SPTCNT,0                                                         
         MVI   PGPRD,0                                                          
         XC    OLDDAT,OLDDAT                                                    
         CLI   BUYKEY+3,X'FF'                                                   
         BE    TR6                                                              
         CLI   BPRD,0                                                           
         BE    *+14                                                             
         CLC   BPRD,BUYKEY+3       TEST RIGHT ACTIVE BRAND                      
         BNE   TRNO                                                             
*                                  SEARCH FOR PIGGYBACK ELEM                    
         LA    R2,BDELEM                                                        
TR2      DS    0H                                                               
         CLI   0(R2),4                                                          
         BE    TR3                                                              
         CLI   0(R2),0                                                          
         BE    TR3B                                                             
         LLC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     TR2                                                              
TR3      DS    0H                                                               
         MVC   PGPRD,2(R2)         SAVE PASSIVE PRD                             
TR3B     DS    0H                                                               
         CLI   BPRD2,0             TEST SPECIFIC PIG                            
         BE    TR3C                                                             
         CLC   BPRD2,PGPRD         TEST RIGHT ONE                               
         BE    TR4                                                              
         B     TRNO                                                             
TR3C     DS    0H                                                               
         CLI   PIGCTL,C'N'         TEST TO EXCLUDE PIGS                         
         BNE   TR3D                                                             
         CLI   PGPRD,0                                                          
         BNE   TRNO                                                             
         B     TR4                                                              
TR3D     DS    0H                  SET PRD IN PIGLIST                           
         LLC   RF,PGPRD                                                         
         A     RF,APIGLIST                                                      
         MVC   0(1,RF),PGPRD                                                    
*                                                                               
*                                  GO TO GETRATE ONCE FOR NON-POOL RECS         
TR4      IC    R0,BDTIME                                                        
         MVI   BDTIME,0            SET BDTIME TO 0                              
         ST    RE,FULL                                                          
         LA    RF,X                 AREA FOR GETRATE XCHG DATA                  
         ST    RF,DMCB+12                                                       
         L     RE,ADAGY                                                         
         CLI   CANADSW,C'Y'       IF CANADA                                     
         BNE   *+8                                                              
         MVI   DMCB+12,C'C'        SPECIFY CANADIAN CURRENCY                    
         XC    WORK,WORK           BUILD DUMMY ELEM IN WORK                     
         MVI   WORK,6                                                           
         MVI   WORK+1,10                                                        
         MVC   WORK+2(2),BQSTARTP                                               
         MVI   WORK+7,1            1 SPOT                                       
         GOTO1 GETRATE,DMCB,(X'FF',SPOTS),ADBUY,(C'Z',WORK)                     
         XC    TAXAMT,TAXAMT                                                    
         CLI   CANADSW,C'Y'        CANADA?                                      
         BNE   TR4C                NO                                           
         MVC   VATAMT,X+20         VAT AMOUNT AT XCHG AREA +20                  
         MVC   BYTAX,VATAMT        GST TAX                                      
         GOTO1 =A(GETPST),RR=RELO  GET PST AMOUNTS                              
         B     TR5                 DONE WITH CANADIAN TAXES                     
*                                                                               
TR4C     CLI   TAXOPT,C'Y'         TEST TAX OPTION                              
         BNE   TR5                                                              
         OC    BDNTAX,BDNTAX                                                    
         BZ    TR5                                                              
*                                                                               
TR4D     MVC   DUB(4),NET          EXTRACT TAX FROM BUY                         
         MVC   DUB+5(2),BDNTAX     SAVE BDNTAX                                  
         XC    BDNTAX,BDNTAX       RECOPMUTE COST WITHOUT TAX                   
*                                                                               
         GOTO1 GETRATE,DMCB,(X'FF',SPOTS),ADBUY,(C'Z',WORK)                     
*                                                                               
         L     RF,DUB                                                           
         S     RF,NET                                                           
         ST    RF,TAXAMT           GET TAX AMOUNT                               
         STCM  RF,15,BYTAX         TAX AMOUNT FOR SPOT AUTOPAY                  
         MVC   BDNTAX,DUB+5        RESTORE BDNTAX                               
*                                                                               
TR5      L     RE,FULL                                                          
         STC   R0,BDTIME                                                        
*                                  GET HIGHEST DAY OF ROTATOR                   
TR6      LLC   R0,BDDAY                                                         
         LA    R1,1                                                             
         SRA   R0,1                                                             
         BZ    *+12                                                             
         SLL   R1,1                                                             
         B     *-12                                                             
         STC   R1,BYTE2            =HIGHEST DAY OF ROTATOR                      
*                                                                               
         LR    R0,RE                                                            
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    TR6A                YES - ONLY GET COPY CODE IF NEEDED           
         MVI   DIGITAL,C'N'        DEFAULT TO NO DIGITAL                        
         CLI   BIGSTA+4,C'/'       LOCAL CABLE REQUEST?                         
         BE    TR6AA               YES - BIGSTA+5 CAN HAVE "S" OR "D"!          
         CLI   BIGSTA+5,C'D'       DIGITAL?                                     
         BE    TR6AAA              YES                                          
         CLI   BIGSTA+5,C'S'       STREAMING?                                   
         BE    TR6AAA              YES                                          
         CLI   BIGSTA+5,C'C'       STREAMING?                                   
         BNE   *+8                 NO                                           
TR6AAA   MVI   DIGITAL,C'Y'        DIGITAL REQUEST                              
*                                                                               
TR6AA    CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BE    TR6A                YES                                          
         CLI   QBOOK1,C' '         IF DOING DEMOS                               
         BNE   TR6B                NEED PROCDEM                                 
TR6A     CLI   TRAFFRPT,C'Y'       OR IF NEED TRAFFIC COPY CODE                 
         BE    TR6B                                                             
         CLI   TRAFFRPT,C'E'                                                    
         BNE   TR6D                                                             
*                                                                               
TR6B     GOTO1 =A(PROCDEM),RR=RELO                                              
*                                                                               
TR6D     CLI   SPCONLY,C'Y'        TEST DOING SPECIALS ONLY                     
         BNE   TR6F                                                             
         CLI   BDPROG+21,0         SPECIAL                                      
         BNE   TRNO                                                             
*                                                                               
TR6F     DS    0H                  LOOK FOR VARIOUS ELEMENTS                    
         MVI   BKTYPE,0            INIT TO NO BOOKTYPE                          
         LA    R8,BDELEM                                                        
*                                                                               
TR6G     DS    0H                                                               
         CLI   0(R8),X'66'         COMMENT                                      
         BE    TR6I                                                             
         CLI   0(R8),X'24'         BOOK TYPE ELEM                               
         BE    TR6I4                                                            
         CLI   0(R8),0                                                          
         BE    TR6K                                                             
TR6H     DS    0H                                                               
         LLC   RF,1(R8)                                                         
         AR    R8,RF                                                            
         B     TR6G                                                             
*                                                                               
TR6I     DS    0H                                                               
         CLC   =C'MATCH=NO',3(R8)                                               
         BE    TRNO                                                             
         B     TR6H                                                             
*                                                                               
TR6I4    DS    0H                                                               
         MVC   BKTYPE,DLUBKTYP-DLUELEM(R8)  SAVE BOOK TYPE                      
         B     TR6H                                                             
*                                                                               
TR6K     DS    0H                                                               
         CLI   PAYTA,C'Y'          TEST PAY TA                                  
         BNE   TR7                 NO                                           
         CLI   QREP+3,C'S'        IF NOT SPEC REP TA                            
         BE    TR7                                                              
         OC    BDREP,BDREP         SKIP BUYS ASSIGNED TO SPEC REP               
         BNZ   TRNO                                                             
         B     TR7B                                                             
*                                                                               
TR7      DS    0H                                                               
         CLC   RQREP,SPACES                                                     
         BNH   TR7B                                                             
         GOTO1 VRCPACK,DMCB,(C'P',RQREP),HALF                                   
         CLI   Q2USER+6,C'Y'       NEGATIVE FILTER?                             
         BNE   TR7A                NO                                           
         CLC   HALF,BDREP          REP MATCHES?                                 
         BE    TRNO                YES - FILTER OUT!                            
         B     TR7B                                                             
*                                                                               
TR7A     CLC   HALF,BDREP          TEST RIGHT REP                               
         BNE   TRNO                                                             
TR7B     DS    0H                                                               
         OC    BDREP,BDREP                                                      
         BZ    TRYES                                                            
*                                  READ SPECIAL REP (FOR SYNDICATION)           
         L     RF,ADSTAT                                                        
         MVC   WORK(64),KEY                                                     
         MVI   X,C'0'                                                           
         MVC   X+1(16),X                                                        
         MVI   X,C'R'                                                           
         MVC   X+1(1),STAKMED-STAREC(RF)                                        
         MVC   X+5(2),STAKAGY-STAREC(RF)                                        
         GOTO1 VRCPACK,DMCB,(C'U',BDREP),X+2                                    
*                                                                               
         L     RF,ADREP                                                         
         CLC   X(15),0(RF)                                                      
         BE    TR8                                                              
         MVC   KEY(17),X                                                        
         GOTO1 READREP                                                          
TR8      DS    0H                                                               
         MVC   KEY(64),WORK                                                     
*                                                                               
TRYES    DS    0H                                                               
         GOTO1 =A(PDTF)            RESTORE OOW DEFERRAL DATES                   
         CR    RD,RD                                                            
         B     TSTRECX                                                          
*                                                                               
TRNO     LTR   RD,RD                                                            
TSTRECX  XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        GETPST - GET PST AMOUNTS FROM EXCHANGE AREA                            
*                                                                               
*        NOTE - DISPLACEMENTS ARE HARD CODED BECAUSE                            
*        INCLUDING SPXCHAREA CAUSES DUPLICATE TAGS                              
**********************************************************************          
*                                                                               
GETPST   NMOD1 0,GETPST                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         ICM   R3,15,BYTAX         CANADIAN TAX THUS FAR                        
         XC    PSTAMTS,PSTAMTS                                                  
         LA    RF,X+XGSTAMTX+4-XGROSS   PST'S AFTER GST'S                       
         LA    RE,PSTAMTS                                                       
         LA    R1,NPROVS                                                        
*                                                                               
GPST2    MVC   0(4,RE),8(RF)       SET VALUE IN PSTAMTS                         
         ICM   R2,15,0(RE)         PST VALUE                                    
         AR    R3,R2               ADD PST TO GST                               
         LA    RF,16(RF)           NEXT PROVINCE                                
         LA    RE,4(RE)                                                         
         BCT   R1,GPST2                                                         
         STCM  R3,15,BYTAX         PST ADDED TO GST                             
*                                                                               
GPSTX    XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
         TITLE 'INVBLD - ICS INVOICE BUFFER MODULE'                             
**********************************************************************          
INVBLD   NMOD1 0,INVBLD                                                         
         LA    RC,SPACEND                                                       
         USING IELEMD,R8                                                        
*                                                                               
         MVI   ESTINV,C'N'                                                      
         MVI   NETINV,C'Y'                                                      
         MVI   IDNUM,0                                                          
         MVI   RSET,0                                                           
         MVI   RSETQ,0                                                          
         MVI   RSETSW,0                                                         
         MVI   FILMDSCP,C'N'                                                    
         XC    IBTOT,IBTOT                                                      
         XC    SAVIKEY,SAVIKEY                                                  
         L     RE,AINOLST                                                       
         LHI   RF,INOLSTL*MAXINOS                                               
         XCEF                                                                   
         XC    SVIHDEL,SVIHDEL                                                  
         XC    FLMTPARS+8(4),FLMTPARS+8   CLEAR FILM TABLE                      
*                                                                               
         L     R8,ALBY                                                          
         LA    R8,1(R8)                                                         
         ST    R8,AFINV                                                         
*                                                                               
*****************************************************************               
*        PROCESS INVOICES                                                       
*****************************************************************               
         BCTR  R8,R0                                                            
         ST    R8,ALINV                                                         
*                                                                               
         MVI   DIGITAL,C'N'        DEFAULT TO NO DIGITAL                        
         LA    RE,IELI2LEN         IELEM LENGTH                                 
         LA    RF,INOLSTL          LENGTH WITHOUT DIGITAL INFO                  
         CLI   BIGSTA+4,C'/'       LOCAL CABLE REQUEST?                         
         BE    IB07                YES - BIGSTA+5 CAN HAVE "S" OR "D"!          
         CLI   BIGSTA+5,C'D'       DIGITAL?                                     
         BE    IB06                YES                                          
         CLI   BIGSTA+5,C'S'       STREAMING?                                   
         BE    IB06                YES                                          
         CLI   BIGSTA+5,C'C'       STREAMING?                                   
         BNE   *+16                NO                                           
IB06     LA    RE,IELI3LEN         IELEM LENGTH FOR DIGITAL/STREAMING           
         LA    RF,INOLSTL2         LENGTH WITH DIGITAL INFO                     
         MVI   DIGITAL,C'Y'        DIGITAL REQUEST                              
IB07     STH   RE,IELMLEN          IELEM LENGTH                                 
         STH   RF,INOLSTQ          LENGTH OF INVOICE TABLE                      
*                                                                               
         BRAS  RE,GOGETSNV         NOW TRY FOR SNV'S                            
*                                                                               
         XC    HOLDS,HOLDS                                                      
         CLC   ALINV,AFINV         TEST ANY INVOICES                            
         BH    *+8                 YES                                          
         MVI   NETINV,C'N'         NO - NOT A NET INV                           
*                                                                               
*        PASS THRU FILM TAB AND CHECK FOR COMML ERRORS                          
*              AND TO GET LATER ADDED FILM SEQ NUMBERS                          
*                                                                               
*        SET WHAT PROFILES ARE ON FOR COMML ERRORS TO CHECK                     
*                                                                               
         MVI   FLMCHK,0            SET CHECKING COMML ERRORS                    
         MVI   CMLPRD,0                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         GOTO1 SETCMML,DMCB,I2BPROF+3,('FLMCFLT',FLMCHK)                        
         GOTO1 (RF),DMCB,I2BPROF,('FLMCPRD',FLMCHK)                             
         GOTO1 (RF),DMCB,I2BPROF+6,('FLMCTIM',FLMCHK)                           
         GOTO1 (RF),DMCB,I2BPROF+13,(C'Y',CMLPRD)                               
         GOTO1 (RF),DMCB,I2CPROF+7,('FLMCLEN',FLMCHK)                           
*                                                                               
IB08     CLI   TRAFRCLO,C'Y'       RECALL ERROR A DISCREPANCY?                  
         BNE   *+8                 NO                                           
         OI    FLMCHK,FLMCRR       SET CHECKING RECALL RELEASE                  
*                                                                               
*        NOTE- FLMTAB IS IN ORDER BY FILM CODE                                  
*              SO THIS CODE IS NOT REALLY INEFFICIENT                           
*                                                                               
         L     R6,AFLMTAB          FILM TABLE                                   
         USING FLMTABD,R6                                                       
         ICM   R0,15,FLMTPARS+8 NO. OF ENTRIES                                  
         BZ    IB12                                                             
*                                                                               
IB11     DS    0H                                                               
         OC    FLMCOD,SPACES       MAKE UPPER CASE                              
         GOTO1 GETFLM,DMCB,FLMTABD                                              
         LA    R6,FLMTABEL(R6)     NEXT ENTRY                                   
         BCT   R0,IB11                                                          
***                                                                             
* SORT BECAUSE GETFLM MAY HAVE CHANGED SOME FLMSEQ'S                            
***                                                                             
         MVC   DMCB+4(4),FLMTPARS+8                                             
         GOTO1 XSORT,DMCB,AFLMTAB,,FLMTABEL,FLMTABKL,0                          
*                                                                               
         BRAS  RE,ADDCNTR          ADD CENTERCUT ENTRIES                        
*                                                                               
****     CLI   TRAFRCLO,C'Y'       IF RECALL/RELEASE ERROR                      
****     BE    IB11C               IS DISCREPANT                                
****     CLI   TRAFIDSC,C'Y'       OR INVALID FILM                              
****     BNE   IB12                                                             
*                                  NOW CHECK VS INVOICES                        
IB11C    DS    0H                                                               
         L     R8,AFINV                                                         
*                                                                               
IB11D    C     R8,ALINV                                                         
         BNL   IB12                                                             
         CLI   IFILM,0             TEST ANY FILM                                
         BE    IB11I               NO - FILM ERROR CAN NEVER BE SET             
***      TM    ISTAT2,X'02'        TEST TO IGNORE FILM ERRORS                   
***      BNZ   IB11G                                                            
*                                                                               
         L     R6,AFLMTAB                                                       
         USING FLMTABD,R6                                                       
         L     R7,FLMTPARS+8                                                    
*                                                                               
IB11E    DS    0H                                                               
         CLC   FLMIDNO,IINVID      TEST FROM RIGHT INVOICE/RSET                 
         BNE   IB11F                                                            
         CLC   FLMICOD,IFILM       1ST FILM                                     
         BE    IB11E4                                                           
         CLI   IFILM2,0            TEST ANY 2ND FILM                            
         BE    IB11F                                                            
         CLC   FLMICOD,IFILM2      2ND FILM                                     
         BNE   IB11F                                                            
*                                                                               
IB11E4   DS    0H                                                               
*                                                                               
*        CHECK AND SET INVALID FILM                                             
*                                                                               
         OC    FLMSEQ,FLMSEQ       IS IT A VALID FILM?                          
         BNZ   *+12                                                             
         OI    ISTAT,ISTINVF       NO, SET INVALID BIT                          
         B     IB11H               AND SET FILM DISCREPANCY!                    
         CLI   I2ZPROF+1,C'N'      MATCH FILMS FOR LOCAL CABLE                  
         BNE   *+12                                                             
         CLI   BIGSTA+4,C'/'       LOCAL CABLE                                  
         BE    IB11E4A             YES THEN DON'T CHECK FILMS                   
*                                                                               
*        CHECK AND SET INVALID RECALL/RELEASE DATES FOR COMML                   
*                                                                               
         CLC   IDAT,FLMRCL         TEST VS RECALL DATE                          
         BNH   *+8                                                              
         OI    ISTAT2,ISTRCRL      SET NO GOOD FOR MATCH                        
         CLC   IDAT,FLMRLSE        AND RELEASE DATE                             
         BNL   *+8                                                              
         OI    ISTAT2,ISTRCRL                                                   
*                                                                               
*        CHECK AND SET INVALID PRODUCT FOR COMML                                
*                                                                               
IB11E4A  CLI   FLMPRDS,X'FF'       CHECK FILM VALID FOR PRD                     
         BE    IB11E19             ALL PRDS VALID                               
*                                                                               
         MVC   FULL(1),IPRD        1 CHAR PRODUCT FOR SPOT                      
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   *+10                NO                                           
         MVC   FULL(3),IPRDNT      3 CHAR PRODUCT FOR SPOT                      
         BAS   RE,VALFPRD                                                       
*                                                                               
         MVC   FULL(1),IPRD2       1 CHAR PIGGY FOR SPOT                        
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   *+10                NO                                           
         MVC   FULL(3),IPRD2NT     3 CHAR PIGGY FOR SPOT                        
         CLI   FULL,0              HAVE PIGGY?                                  
         BE    *+8                 NO                                           
         BAS   RE,VALFPRD          YES - CHECK THAT TOO!                        
*                                                                               
         TM    ISTAT,ISTPRDF       INVALID FILM FOR PRODUCT?                    
         BNZ   IB11E19             YES                                          
         TM    FLMSTAT,FLMSSBRD    HAVE SUBSTITUTION BRANDS?                    
         BZ    IB11E19             NO                                           
         OI    ISTAT4,IST4SBRD     INVOICE HAS SUBSTITUTION BRANDS              
*                                                                               
IB11E19  CLC   FLMLENTH,ILEN       MATCH ON LENGTH?                             
         BE    *+8                 YES                                          
         OI    ISTAT4,IST4LENF     NO - FLAG AS INVAID COMML LEN                
*                                                                               
         BRAS  RE,IB11E20          CHECK COMMERCIAL TIMES                       
*                                                                               
*        CHECK AND SET INVALID MATCHING FLIGHT DATES FOR COMML                  
*                                                                               
         TM    FLMSTAT,FLMSFLTS    ARE THERE MATCHING DATES                     
         BNO   IB11E40                                                          
*                                                                               
         OI    ISTAT3,IST3FLTS     SET MATCHING DATES EXIST                     
         MVC   SVKEY(5),FLMSEQ     SAVE OFF THE KEY                             
         OC    FLMCPTR,FLMCPTR     IS THIS A CENTRCUT POINTER?                  
         BZ    *+10                NO                                           
         MVC   SVKEY(2),FLMCPTR    YES - THIS IS THE REAL SEQ NUM               
*                                                                               
         USING FLTTABD,R2                                                       
         L     R2,AFLTTAB                                                       
         B     *+8                                                              
IB11E32  LA    R2,FLTTABEL(R2)                                                  
         OC    0(5,R2),0(R2)       ANY MORE                                     
         BNZ   *+6                                                              
         DC    H'0'                MUST BE THERE                                
***      CLC   FLMSEQ(L'FLMSEQ+L'FLMIDNO+L'FLMICOD),FLTSEQ                      
         CLC   SVKEY(L'FLMSEQ+L'FLMIDNO+L'FLMICOD),FLTSEQ                       
         BNE   IB11E32                                                          
*                                                                               
         LA    R0,6                6 SETS OF DATES                              
         LA    R1,FLTMPER1                                                      
*                                                                               
IB11E34  OC    0(4,R1),0(R1)       ARE THERE DATES?                             
         BZ    IB11E36             NO, TRY NEXT SET                             
*                                                                               
         CLC   IDAT,0(R1)          TEST VS MATCHING START DATE                  
         BNL   *+8                                                              
         B     IB11E36                                                          
*                                                                               
         CLC   IDAT,2(R1)          AND MATCHING END DATE                        
         BNH   IB11E40             PASSED CHECK - CONTINUE                      
*                                                                               
IB11E36  LA    R1,4(R1)            TRY NEXT PERIOD                              
         BCT   R0,IB11E34                                                       
         OI    ISTAT3,IST3FLTF     SET NO GOOD FOR MATCH                        
         DROP  R2                                                               
*                                                                               
* NEXT FILM OR INVOICE ENTRY                                                    
*                                                                               
IB11E40  DS    0H                                                               
         CLI   IFILM2,0            IF NO 2ND FILM                               
         BE    IB11G               DONE                                         
*                                                                               
IB11F    DS    0H                                                               
         LA    R6,FLMTABEL(R6)     NEXT ENTRY                                   
         BCT   R7,IB11E                                                         
*                                                                               
*        FILM ERRORS                                                            
*                                                                               
IB11G    DS    0H                                                               
         CLI   I2CPROF+5,C'Y'      PRD, FLT, TIM, REL, INV = FILM ERR?          
         BNE   IB11I               NO                                           
         TM    FLMCHK,FLMCRR       ARE WE CHECKING RR DATES                     
         BZ    *+12                NO                                           
         TM    ISTAT2,X'04'        FILM DATES OK?                               
         BNZ   IB11H               NO - ERROR                                   
*                                                                               
         TM    FLMCHK,FLMCFLT      ARE WE CHECKING FLIGHT DATES?                
         BZ    *+12                NO                                           
         TM    ISTAT3,IST3FLTF     FLIGHT OK?                                   
         BNZ   IB11H               NO - ERROR                                   
*                                                                               
         TM    FLMCHK,FLMCTIM      ARE WE CHECKING MATCH TIMES                  
         BZ    *+12                NO                                           
         TM    ISTAT3,IST3TIMF     FILM MATCHING TIMES OK?                      
         BNZ   IB11H               NO - ERROR                                   
*                                                                               
         TM    FLMCHK,FLMCPRD      ARE WE CHECKING MATCH PRD?                   
         BZ    *+12                NO                                           
         TM    ISTAT,ISTPRDF       TEST FILM PRODUCTS OK                        
         BNZ   IB11H               YES - ALL OK                                 
*                                                                               
         TM    FLMCHK,FLMCLEN      ARE WE CHECKING MATCH LEN?                   
         BZ    IB11I               NO                                           
         TM    ISTAT4,IST4LENF     TEST FILM LENGTH OK                          
         BZ    IB11I               YES - ALL OK                                 
*                                                                               
IB11H    MVI   FILMDSCP,C'Y'       FLAG FILM DISCREPANCY                        
*                                                                               
IB11I    AH    R8,IELMLEN          NEXT INVOICE ITEM                            
         B     IB11D                                                            
         DROP  R6                                                               
*                                                                               
*        DEAL WITH IDS                                                          
*                                                                               
IB12     DS    0H                                                               
         CLI   QBYID,C'Y'          IF DOING CONTRACT ID'S                       
         BNE   IB75                                                             
         OI    NEXTID,X'80'        SET HAVE BUILT ID LIST                       
         L     R5,AIDLIST          SET THIS BUYID PROCESSED                     
*                                                                               
IB71     DS    0H                                                               
         CLI   0(R5),X'FF'         EOL                                          
         BE    IB75                                                             
         CLC   SVBUYID,0(R5)                                                    
         BE    *+12                                                             
         LA    R5,IDLSTL(R5)                                                    
         B     IB71                                                             
         OI    12(R5),X'80'        SET PROCESSED                                
*                                                                               
IB75     DS    0H                  SET STATION EQUIVS IN IDLIST                 
         CLI   QBYID,C'Y'          ONLY IF BY ID                                
         BNE   IB76                                                             
         L     R4,AIDLIST                                                       
IB75D    DS    0H                                                               
         CLI   0(R4),X'FF'         EOL                                          
         BE    IB76                                                             
         BAS   RE,GETSTEQ          GET STATION EQUIV (SET IDLMKT)               
         LA    R4,IDLSTL(R4)                                                    
         B     IB75D                                                            
*                                                                               
IB76     DS    0H                                                               
         L     R1,FLMTPARS+12      SET END OF FILM TABLE                        
         M     R0,FLMTPARS+8                                                    
         A     R1,AFLMTAB                                                       
         MVI   0(R1),X'FF'                                                      
*                                                                               
INEXT    EQU   *                                                                
         J     EXIT                                                             
         EJECT                                                                  
*                                                                               
VALFPRD  NTR1                                                                   
*                                                                               
         USING FLMTABD,R6                                                       
         LA    R2,FLMPRDS                                                       
         MVI   FULL+3,1            CHECKING FLMPRDS                             
         LA    R1,9                FOR SPOT CHECK 9 HEX PRDS                    
         LA    RF,0                FOR 1 BYTE EXECUTED COMPARE                  
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   IB11E5              NO                                           
         LA    R1,3                FOR NET CHECK 3 HEX PRDS                     
         LA    RF,2                FOR 3 BYTE EXECUTED COMPARE                  
*                                                                               
IB11E5   EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   FULL(0),0(R2)       MATCH ON PRODUCT?                            
         BE    INEXT               YES                                          
         LA    R2,1(R2,RF)         NO - BUMP ENTRY AND CHECK NEXT PRD           
         BCT   R1,IB11E5                                                        
*                                                                               
         CLI   FULL+3,2            JUST CHECKED FPRDLIST?                       
         BE    IB11E10             YES, SET INVALID PRD                         
*                                                                               
         TM    FLMSTAT,FLMSPRD     HAVE MORE PRDS TO CHECK?                     
         BZ    IB11E10             NO, SET INVALID PRD                          
*                                                                               
         MVC   SVKEY(5),FLMSEQ     SAVE OFF THE KEY                             
         OC    FLMCPTR,FLMCPTR     IS THIS A CENTRCUT POINTER?                  
         BZ    *+10                NO                                           
         MVC   SVKEY(2),FLMCPTR    YES - THIS IS THE REAL SEQ NUM               
*                                                                               
         USING FPRDTABD,R3                                                      
         L     R3,APRDTAB          MORE PRDS BUFFER                             
*                                                                               
IB11E5A  OC    0(5,R3),0(R3)       ANY MORE BUFFERED PRODUCT LISTS?             
         BNZ   *+6                 YES                                          
         DC    H'0'                NO - DEATH                                   
         CLC   SVKEY(FLMTABKL),FPRDSEQ     DO THE KEYS MATCH?                   
         BE    IB11E5B             YES - WE HAVE OUR EXTENDED PRD LIST          
         LLC   R0,FPRDLEN          BUFFER LENGTH                                
         AR    R3,R0               BUMP TO NEXT ENTRY                           
         B     IB11E5A                                                          
*                                                                               
IB11E5B  MVI   FULL+3,2            CHECKING FPRDLIST                            
         LA    R2,FPRDLIST         PRODUCT LIST                                 
         LLC   R1,FPRDLEN          ENTRY LENGTH                                 
         SHI   R1,FPRTABKL+1       MINUS KEY AND LENGTH                         
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   IB11E5              NO, R1=NUMBER OF PRODUCTS IN ENTRY           
         SR    R0,R0                                                            
         D     R0,=F'3'            NEED TO DIVIDE BY 3 TO GET # OF PRDS         
         B     IB11E5              R1=NUMBER OF PRODUCTS IN ENTRY               
         DROP  R3,R6                                                            
*                                                                               
IB11E10  OI    ISTAT,ISTPRDF       INVALID FILM FOR PRODUCT                     
         B     INEXT                                                            
***********************************************************************         
* SETCMML - TESTS COMMERCIAL PROFILE SETTINGS ON THE I2B AND SETS A   *         
*           FLAG IF THE PROFILE IS ON AND THE EFF YEAR/MONTH FALL     *         
*           WITHIN THE REQUEST PERIOD                                 *         
* INPUT   - P1 - A(I2B PROFILE) WE ARE TESTING                        *         
*           P2 - HOB = FLAG BIT(S) TO TURN ON                         *         
*           P2 - A(FLAG) TO SET THOSE BITS                            *         
***********************************************************************         
SETCMML  NTR1                                                                   
         L     R2,0(R1)                                                         
         CLI   0(R2),C'Y'         HONOR THIS PROFILE SETTING?                   
         BNE   SCXIT              NO, EXIT                                      
         OC    1(2,R2),1(R2)      EFF DATE SET FOR THIS PROFILE?                
         BZ    SC10               NO, SET THE FLAG                              
         LLC   R3,1(R2)           YEAR                                          
         CLI   1(R2),80           YEAR > 80?                                    
         BH    *+8                YES                                           
         AHI   R3,100             NO - ADD 100 FOR CENTURY                      
         STC   R3,1(R2)           REPLACE IT IN PROFILE                         
         CLC   WORK(2),1(R2)      REQUEST END BEFORE EFF DATE?                  
         BL    SCXIT              YES - DON'T HONOR PROFILE                     
*                                                                               
SC10     L     R2,4(R1)           FLAG TO SET                                   
         OC    0(1,R2),4(R1)      SET THE FLAG                                  
*                                                                               
SCXIT    B     INEXT                                                            
**********************************************************************          
*        GETSTEQ - GET STATION EQUIV REC                                        
**********************************************************************          
GETSTEQ  NTR1                                                                   
         XC    X,X                                                              
         LA    R5,X                                                             
         USING STEKEY,R5                                                        
         MVC   STEKTYP,=X'0D44'                                                 
         MVC   STEKAGMD,BAGYMD                                                  
         MVC   STEKCLT,BCLT                                                     
         MVC   STEKSTA,STA                                                      
*                                                                               
         L     R2,ADSTEQ                                                        
         CLC   STEKEY,0(R2)        TEST HAVE STEQ RECORD ALREADY                
         BE    GETSQ4                                                           
*                                                                               
         MVC   WORK,KEY                                                         
         MVC   KEY,X                                                            
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    GETSQ2              GOT ONE                                      
*                                                                               
         MVC   KEY,KEYSAVE         RESET TO KEY WE ARE LOOKING FOR              
         MVC   KEY+3(2),=X'FFFF'   AND CHECK FOR CLIENT ALL                     
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   GETSQ8              IF NO STEQ REC- DONE                         
*                                                                               
GETSQ2   ST    R2,AREC                                                          
         GOTO1 GET                                                              
         MVC   KEY,WORK            RESTORE SEQ                                  
         GOTO1 HIGH                                                             
*                                                                               
GETSQ4   DS    0H                                                               
         PACK  WORK(3),1(5,R4)     MGR NUMBER                                   
         LA    R2,24(R2)                                                        
*                                                                               
GETSQ5   DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    GETSQX              NO MKT TO SET                                
         CLI   0(R2),X'03'         MGR ELEM                                     
         BNE   GETSQ6                                                           
         CLC   WORK(2),3(R2)          TEST FOR THIS ID NUMBER                   
         BNE   GETSQ6                                                           
         CLC   0(1,R4),2(R2)       TEST MGR SCHEME                              
         BNE   GETSQ6                                                           
*                             NOTE- USES FIRST MARKET WITHIN A MGR.             
*                                   IS THIS OK???                               
*                                                                               
         MVC   IDLMKT-IDLISTD(2,R4),5(R2)   SET MKT NUMBER                      
         B     GETSQX                                                           
*                                                                               
GETSQ6   DS    0H                                                               
         LLC   R0,1(R2)            NEXT ELEM                                    
         AR    R2,R0                                                            
         B     GETSQ5                                                           
*                                                                               
GETSQ8   DS    0H                                                               
         MVC   KEY,WORK            RESTORE SEQ                                  
         GOTO1 HIGH                                                             
*                                                                               
GETSQX   DS    0H                                                               
         L     R2,ADBUY            RESTORE AREC                                 
         ST    R2,AREC                                                          
         B     INEXT                                                            
**********************************************************************          
*        GETFLM- GET FILM RECORD FOR TABLE ENTRY                                
**********************************************************************          
GETFLM   NTR1                                                                   
         L     R6,0(R1)            A(FLMTAB ENTRY)                              
         USING FLMTABD,R6                                                       
*                                                                               
         LR    RF,R6               IF THIS CODE SAME AS LAST                    
         SHI   RF,FLMTABEL                                                      
         C     RF,AFLMTAB                                                       
         BL    GF02                                                             
         CLC   FLMCOD,FLMCOD-FLMTABD(RF)                                        
         BNE   GF02                                                             
         CLC   FLMCOD,SPACES                                                    
         BNH   GF02                                                             
         TM    FLMCHK,FLMCFLT      IF CHECKING FLIGHTS NEED IN FLTTAB           
         BO    GF02                                                             
         TM    FLMSTAT-FLMTABD(RF),FLMSPRD   HAVE EXTENDED PRD LIST?            
         BO    GF02                YES, NEED A NEW KEY FOR PRD TABLE            
         TM    FLMSTAT-FLMTABD(RF),FLMSSBRD  HAVE SUBSTITUTION BRANDS?          
         BO    GF02                YES, NEED A NEW KEY FOR PRD TABLE            
*                                                                               
         MVC   FLMADID,FLMADID-FLMTABD(RF)  USE PREVIOUS AD-ID                  
         MVC   FLMHDEF,FLMHDEF-FLMTABD(RF)  USE PREVIOUIS HDEF                  
         MVC   FLMCNTR,FLMCNTR-FLMTABD(RF)  USE PREVIOUS CENTERCUT              
         MVC   FLMRCL,FLMRCL-FLMTABD(RF)    USE PREVIOUS RECALL DATE            
         MVC   FLMRLSE,FLMRLSE-FLMTABD(RF)  AND RELEASE DATE                    
         MVC   FLMSEQ,FLMSEQ-FLMTABD(RF)    AND SEQ NUMBER                      
         MVC   FLMPRDS,FLMPRDS-FLMTABD(RF)  AND PRDS                            
         MVC   FLMSTIME,FLMSTIME-FLMTABD(RF)  AND ST TIME                       
         MVC   FLMETIME,FLMETIME-FLMTABD(RF)  AND END TIME                      
         MVC   FLMLENTH,FLMLENTH-FLMTABD(RF)    AND LEN                         
         MVC   FLMSTAT,FLMSTAT-FLMTABD(RF)  AND STATUS                          
         NI    FLMSTAT,X'FF'-FLMSFLTS-FLMSPRD                                   
         B     GFX                                                              
*                                                                               
GF02     XC    FLMRLSE,FLMRLSE     CLEAR RECALL/RELEASE DATES                   
         MVC   FLMRCL,=X'FFFF'                                                  
*                                                                               
         CLI   TRAFRCLO,C'N'       TEST CHECKING RECALL DATES                   
         BNE   GF04                DO FILE READ                                 
*                                                                               
         OC    FLMADID,FLMADID     OR IF NO ADID                                
         BZ    GF04                                                             
         CLC   FLMCOD,SPACES       OR IF NO REG COMML CODE                      
         BNH   GF04                                                             
*                                                                               
         OC    FLMSEQ,FLMSEQ       OR IF NO SEQ NO IN INVOICE                   
         BNZ   GFX                                                              
*                                                                               
GF04     CLC   FLMCOD,SPACES       IF NO REGULAR COMML CODE                     
         BNH   GF06                TRY READING BY AD-ID                         
*                                                                               
         XC    KEY,KEY             READ FOR FILM                                
         MVC   KEY(2),=X'0A21'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         OC    KEY+3(2),SVTRACLT   USE TRAFFIC OVERRIDE CLIENT                  
         BNZ   *+10                IF ANY                                       
         MVC   KEY+3(2),BCLT                                                    
         MVC   KEY+5(8),FLMCOD     FILM CODE                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   GFX                                                              
         B     GF08                                                             
*                                                                               
GF06     DS    0H                  ACCESS COMML DATA BY AD-ID                   
         OC    FLMADID,FLMADID                                                  
         BZ    GF07                                                             
         XC    KEY,KEY             READ FOR FILM                                
         MVC   KEY(2),=X'0AC1'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         OC    KEY+3(2),SVTRACLT   USE TRAFFIC OVERRIDE CLIENT                  
         BNZ   *+10                IF ANY                                       
         MVC   KEY+3(2),BCLT                                                    
         MVC   KEY+5(8),FLMADID    PACKED ADID CODE                             
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   GFX                                                              
         B     GF08                                                             
*                                                                               
GF07     DS    0H                  ACCESS COMML DATA BY AD-ID                   
         OC    FLMHDEF,FLMHDEF                                                  
         BZ    GFX                                                              
         XC    KEY,KEY             READ FOR HIGH DEF                            
         MVC   KEY(2),=X'0AC2'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         OC    KEY+3(2),SVTRACLT   USE TRAFFIC OVERRIDE CLIENT                  
         BNZ   *+10                IF ANY                                       
         MVC   KEY+3(2),BCLT                                                    
         MVC   KEY+5(8),FLMHDEF    PACKED HIGHDEF                               
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   GFX                                                              
*                                                                               
GF08     MVC   AREC,ADBUY                                                       
         GOTO1 GET                                                              
         USING CMLRECD,R5                                                       
         L     R5,AREC                                                          
*                                                                               
         CLC   FLMCOD,SPACES       IF FOUNND BY AD-ID                           
         BH    *+10                                                             
         MVC   FLMCOD,CMLKCML      FILL IN 8 CHAR COMML                         
         MVC   FLMETIME,=X'FFFF'   INIT RECALL TIME                             
*                                                                               
         LA    R5,24(R5)                                                        
         CLI   0(R5),0                                                          
         BNE   *+6                                                              
         DC    H'0'                BAD FILM REC                                 
*                                                                               
GF10     CLI   0(R5),0                                                          
         BE    GF45                                                             
         CLI   0(R5),X'10'         CMML DATA ELEM                               
         BE    GF12                                                             
         CLI   0(R5),X'20'         CMML PRD LIST - SPOT                         
         BE    GF15                                                             
         CLI   0(R5),X'A0'         AD-ID ELEMENT                                
         BE    GF20                                                             
         CLI   0(R5),X'29'         CMML PRD LIST - NETPAK                       
         BE    GF25                                                             
         CLI   0(R5),X'B0'         MATCHING TIMES AND DATES                     
         BE    GF30                                                             
         CLI   0(R5),X'24'         HDEF & CENTERCUT                             
         BE    GF35                                                             
         CLI   0(R5),X'B1'         PRODUCT SUBSTITUTION                         
         BE    GF40                                                             
*                                                                               
GF11     LLC   R0,1(R5)                                                         
         AR    R5,R0                                                            
         B     GF10                                                             
*                                                                               
GF12     DS    0H                                                               
         USING CMLDTAEL,R5                                                      
         TM    CMLSTAT,X'80'       SOFT DELETE?                                 
         BNZ   GFX                 YES - DON'T PROCESS THIS RECORD              
         MVC   FLMSEQ,CMLSEQ+1     SET SEQ NUMBER                               
         MVC   FLMLENTH,CMLSLN     SET FILM LENGTH                              
         CLI   TRAFRCLO,C'N'       TEST CHECKING RECALL DATES                   
         BE    GF11                DO SKIP CONVERTS                             
         GOTO1 DATCON,DMCB,(3,CMLRCL),(2,FLMRCL)                                
         GOTO1 (RF),(R1),(3,CMLRLSE),(2,FLMRLSE)                                
         B     GF11                                                             
*                                                                               
GF15     DS    0H                                                               
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BE    GF11                YES - ONLY USE BINARY PRD FOR SPOT           
         USING CMLPRDEL,R5         SPOTPAK - HEX PRDS                           
         XC    FLMPRDS,FLMPRDS                                                  
         MVI   FLMPRDS,X'FF'       DEFAULT TO ALL PRDS                          
         LLC   R1,1(R5)                                                         
         AHI   R1,-3               CODE+LEN+1 FOR EX                            
         BM    GF11                ELEM TOO SHORT                               
         LR    R3,R1                                                            
         CHI   R1,8                                                             
         BNH   *+8                                                              
         LA    R1,8                MAX 9 PRDS (-1 FOR EX)                       
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   FLMPRDS(0),2(R5)       SAVE PRDS                                 
         B     GF25A                                                            
*                                                                               
GF20     DS    0H                                                               
         USING CMLADIEL,R5                                                      
         CLC   FLMADID,SPACES                                                   
         BH    *+10                                                             
         MVC   FLMADID,CMLADIDP    SET 8 CHAR PACKED AD-ID                      
         B     GF11                                                             
*                                                                               
GF25     DS    0H                                                               
         USING CMLMPREL,R5         NETPAK - CHAR PRDS                           
         XC    FLMPRDS,FLMPRDS                                                  
         MVI   FLMPRDS,X'FF'       DEFAULT TO ALL PRDS                          
         LLC   R1,1(R5)                                                         
         AHI   R1,-3               CODE+LEN+1 FOR EX                            
         BM    GF11                ELEM TOO SHORT                               
         LR    R3,R1                                                            
         CHI   R1,8                                                             
         BNH   *+8                                                              
         LA    R1,8                MAX 3 PRDS (-1 FOR EX)                       
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   FLMPRDS(0),2(R5)       SAVE PRDS                                 
*                                                                               
GF25A    CHI   R3,R8               <= MAX PRDS FLMPRDS CAN HANDLE?              
         BNH   GF11                YES                                          
         OI    FLMSTAT,FLMSPRD     NO - ENTRY HAS MORE PRDS TO CHECK            
         SHI   R3,9                ALREADY MOVED 9 CHARS TO FLMSPRD             
*                                                                               
         ICM   R1,15,ANXTCPRD      HAVE MORE PRD TABLE?                         
         BNZ   *+6                 YES                                          
         DC    H'0'                NO - WE MUST HAVE IT!                        
*                                                                               
         USING FPRDTABD,R1                                                      
         MVC   FPRDSEQ(FPRTABKL),FLMSEQ                                         
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FPRDLIST(0),11(R5)                                               
         AHI   R3,FPRTABKL+1+1     ENTRY LENGTH                                 
         STC   R3,FPRDLEN                                                       
         AR    R1,R3                                                            
         L     R3,ADSTEQ           NEXT BUFFER                                  
         SHI   R3,5                LEAVE 5 NULLS TO INDICATE LAST ENTRY         
         CR    R1,R3               ARE WE 5 BYTES AWAY FROM NEXT BUFF?          
         BNH   *+6                 YES                                          
         DC    H'0'                NO - PRD TABLE TOO SMALL                     
         STCM  R1,15,ANXTCPRD      SET FOR NEXT ENTRY                           
         B     GF11                                                             
*                                                                               
GF30     DS    0H                                                               
         USING CMLMATEL,R5         EXTRA MATCHING DATES/TIMES                   
*                                                                               
         MVC   FLMSTIME(4),CMLMSTIM    START AND END TIMES                      
         NI    FLMSTAT,X'FF'-FLMSDLY   CHECK TIMES DAILY                        
         TM    CMLMFLAG,CMLMFDAY                                                
         BNO   *+8                                                              
         OI    FLMSTAT,FLMSDLY                                                  
*                                                                               
         NI    FLMSTAT,X'FF'-FLMSFLTS  ARE THEIR FLIGHT DATES                   
         OC    CMLMPER1(24),CMLMPER1                                            
         BZ    GF11                                                             
         OI    FLMSTAT,FLMSFLTS                                                 
*                                                                               
*        MOVE FLIGHTS TO FLTTAB                                                 
*                                                                               
         USING FLTTABD,R1                                                       
         ICM   R1,15,ANXTCFLT         NEXT SPOT IN TABLE                        
         MVC   FLTSEQ(L'FLTSEQ+L'FLTIDNO+L'FLTICOD),FLMSEQ                      
         MVC   FLTMPER1,CMLMPER1   SAVE THEM ALL                                
         MVC   FLTMPER2,CMLMPER2                                                
         MVC   FLTMPER3,CMLMPER3                                                
         MVC   FLTMPER4,CMLMPER4                                                
         MVC   FLTMPER5,CMLMPER5                                                
         MVC   FLTMPER6,CMLMPER6                                                
         LA    R1,FLTTABEL(R1)                                                  
         C     R1,APRDTAB          NEXT BUFFER                                  
         BL    *+6                                                              
         DC    H'0'                FLT TABLE TOO SMALL                          
         STCM  R1,15,ANXTCFLT         SET FOR NEXT ENTRY                        
         B     GF11                                                             
         DROP  R1                                                               
*                                                                               
GF35     DS    0H                                                               
         USING CMLXDTEL,R5                                                      
         CLC   FLMHDEF,SPACES                                                   
         BH    *+10                                                             
         MVC   FLMHDEF,CMLXHDPK    SET 8 CHAR HIGHDEF                           
         CLC   FLMCNTR,SPACES                                                   
         BH    *+10                                                             
         MVC   FLMCNTR,CMLXCCPK    SET 8 CHAR CENTERCUT                         
         B     GF11                                                             
*                                                                               
         USING CMLPRSUB,R5         PRODUCT SUBSTITUTION DSECT                   
GF40     CLI   I2CPROF+13,C'Y'     CHECK SUBSTITUTION PRODUCTS?                 
         BNE   GF11                NO - DON'T BOTHER                            
***                                                                             
* THE NEXT 4 INSTRUCTIONS COVERS CML DATES WHERE THE START DATE IS              
* BEFORE OR ON THE REQ START & THE END DATE IS ON OR AFTER THE REQ END          
***                                                                             
         CLC   CMLPRSDT,BQSTART    START DATE AFTER REQUEST START?              
         BH    *+14                YES                                          
         CLC   CMLPREDT,BQEND      END DATE AFTER REQUEST END?                  
         BNL   GF40A               YES - ACCEPT THIS ELEMENT                    
***                                                                             
* IF THE CML START/END DATE FALLS WITHIN THE REQ PERIOD - ACCEPT                
***                                                                             
         CLC   CMLPRSDT,BQSTART    START DATE >= REQUEST START?                 
         BL    *+14                NO - START DATE NOT IN REQ PERIOD            
         CLC   CMLPRSDT,BQEND      START DATE <= REQUEST END?                   
         BNH   GF40A               YES - START DATE IN REQ PERIOD               
         CLC   CMLPREDT,BQSTART    END DATE >= REQUEST START?                   
         BL    GF11                NO - IGNORE THIS ELEMENT                     
         CLC   CMLPREDT,BQEND      END DATE AFTER REQUEST END?                  
         BH    GF11                YES - IGNORE THIS ELEMENT                    
*                                                                               
GF40A    TM    FLMSTAT,FLMSSBRD    FIRST TIME IN?                               
         BNZ   GF41                NO                                           
         OI    FLMSTAT,FLMSSBRD    SUBSTITUTION BRANDS                          
*                                                                               
         ICM   R1,15,ANXTCPRD      HAVE MORE PRD TABLE?                         
         BNZ   *+6                 YES                                          
         DC    H'0'                NO - WE MUST HAVE IT!                        
*                                                                               
         USING FPRDTABD,R1         SUBSTITUTION PRD TABLE                       
         MVC   FPRDSEQ(FPRTABKL),FLMSEQ KEY                                     
         LA    RF,FPRDBPRD         PRODUCT ENTRIES START HERE                   
         ST    RF,FULL             SAVE A(NEXT PRD ENTRY)                       
         DROP  R1                  DROP                                         
*                                                                               
GF41     GOTO1 DATCON,DMCB,(3,CMLPRSDT),(2,WORK)                                
         GOTO1 DATCON,DMCB,(3,CMLPREDT),(2,WORK+2)                              
         L     RF,FULL             A(PRD ENTRY)                                 
         MVC   0(1,RF),CMLPRSCD    SAVE BINARY PRODUCT                          
         MVC   1(4,RF),WORK        SAVE START/END DATES                         
         LA    RF,5(RF)            BUMP TO NEXT ENTRY                           
         ST    RF,FULL             SAVE A(NEXT PRD ENTRY)                       
         B     GF11                PROCESS NEXT COMMERCIAL ELEMENT              
         DROP  R5                  DROP USINGS                                  
*                                                                               
GF45     TM    FLMSTAT,FLMSSBRD    SUBSTITUTION BRANDS?                         
         BZ    GFX                 NO                                           
*                                                                               
         ICM   R1,15,ANXTCPRD      SUBSTITUTION BRANDS TABLE                    
         USING FPRDTABD,R1         SUBSTITUTION BRANDS TABLE DSECT              
*                                                                               
         L     R3,ADSTEQ           NEXT BUFFER                                  
         SHI   R3,5                LEAVE 5 NULLS TO INDICATE LAST ENTRY         
         L     RF,FULL             A(END OF ENTRY WE BUILT)                     
         CR    RF,R3               ARE WE 5 BYTES AWAY FROM NEXT BUFF?          
         BNH   *+6                 YES                                          
         DC    H'0'                NO - PRD TABLE TOO SMALL                     
         STCM  RF,15,ANXTCPRD      SET FOR NEXT ENTRY                           
         SR    RF,R1               GET ELEMENT LENGTH                           
         STC   RF,FPRDLEN          ELEMENT LENGTH                               
         DROP  R1                  DROP SUBSTITUTION PRD TABLE DSECT            
*                                                                               
GFX      B     INEXT                                                            
         DROP  R6                                                               
***********************************************************************         
*                              ADDCNTR                                          
*                              -------                                          
* LOOP THROUGH THE FILM TABLE AND READ THE X'0AC3' CENTERCUT PASSIVE            
* KEY FOR EACH AD-ID WE FIND. FOR EACH CENTERCUT PASSIVE, WE WILL               
* ADD AN ENTRY TO THE FILM TABLE WITH ALL THE INFO FROM THE ORIGINAL            
* FILM TABLE ENTRY (WHERE WE GOT THE AD-ID FROM) EXCEPT...                      
* 1) SAVE OFF THE FLMSEQ FROM THE ORIGINAL ENTRY IN A NEW FIELD FLMCPTR         
* 2) REPLACE FLMSEQ WITH THE SEQ NUM FROM THE CENTERCUT PTR CMML REC            
* 3) CLEAR THE FILMCODE, AD-ID, HIGH-DEF AND CENTERCUT FIELDS                   
* 4) REPLACE THOSE FIELDS WITH THE INFO FROM THE NEW CMML RECORD                
***********************************************************************         
ADDCNTR  NTR1                                                                   
*                                                                               
         L     R6,AFLMTAB          FILM TABLE                                   
         USING FLMTABD,R6                                                       
         ICM   R0,15,FLMTPARS+8    NO. OF ENTRIES                               
         BZ    SCX                                                              
*                                                                               
SC000    CHI   R0,1                LAST ENTRY?                                  
         BNE   *+10                                                             
         MVC   SVKEY(5),FLMSEQ     SAVE OFF THE KEY OF LAST ENTRY               
         LA    R6,FLMTABEL(R6)     NEXT ENTRY                                   
         BCT   R0,SC000                                                         
*                                                                               
         L     R6,AFLMTAB          FILM TABLE                                   
*                                                                               
SC00     OC    FLMADID,FLMADID     HAVE AD-ID?                                  
         BZ    SC50                NO - GET NEXT FILM TABLE ENTRY               
         OC    FLMCPTR,FLMCPTR     IS THIS A CENTERCUT ENTRY?                   
         BNZ   SC50                YES - IGNORE                                 
*                                                                               
         XC    KEY,KEY             READ FOR CENTERCUT                           
         MVC   KEY(2),=X'0AC3'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         OC    KEY+3(2),SVTRACLT   USE TRAFFIC OVERRIDE CLIENT                  
         BNZ   *+10                IF ANY                                       
         MVC   KEY+3(2),BCLT                                                    
         MVC   KEY+5(8),FLMADID    PACKED AD-ID MAY BE A CENTERCUT              
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(13),KEYSAVE     FOUND ONE?                                   
         BNE   SC50                NO, PROCESS NEXT FILM TABLE ENTRY            
*                                                                               
         MVC   AREC,ADBUY                                                       
*                                                                               
         GOTO1 GET                                                              
*                                                                               
         USING CMLRECD,R5                                                       
         L     R5,AREC             A(COMMERCIAL RECORD)                         
         XC    WORK,WORK                                                        
         LA    RF,WORK             ADD A FILM TABLE ENTRY                       
         MVC   WORK(FLMTABEL),FLMSEQ          COPY ENTRY                        
         MVC   FLMCPTR-FLMSEQ(2,RF),0(RF)     SAVE FLMSEQ                       
         XC    FLMCOD-FLMSEQ(32,RF),FLMCOD-FLMSEQ(RF)                           
         MVC   FLMCOD-FLMSEQ(8,RF),CMLKCML    FILL IN 8 CHAR COMML              
         DROP  R5                                                               
*                                                                               
         LA    R5,24(R5)           A(FIRST ELEMENT)                             
         CLI   0(R5),0                                                          
         BNE   *+6                                                              
         DC    H'0'                BAD FILM REC                                 
*                                                                               
SC05     CLI   0(R5),0             END OF RECORD?                               
         BE    SC07                YES                                          
         CLI   0(R5),X'10'         CMML DATA ELEM?                              
         BE    SC06                YES                                          
         CLI   0(R5),X'A0'         AD-ID ELEMENT?                               
         BE    SC06A               YES                                          
         CLI   0(R5),X'24'         HDEF & CENTERCUT ELEM?                       
         BE    SC06B               YES                                          
SC05A    LLC   R1,1(R5)                                                         
         AR    R5,R1                                                            
         B     SC05                                                             
***********************************************************************         
*           WE ARE ADDING A NEW FILM TABLE ENTRY FOR CENTERCUT        *         
*                     THE PROCEDURE IS AS FOLLOWS                     *         
*                     ---------------------------                     *         
* 1) COPY THE EXISTING FILM TABLE ENTRY                               *         
* 2) COPY FLMSEQ FROM THE KEY TO FLMCPTR SO WE CAN FIND THE RIGHT     *         
*    FLIGHT DATE AND PRODUCT TABLES                                   *         
* 3) REPLACE FLMSEQ WITH THE SEQ NUM FROM THE CENTERCUT PTR CMML REC  *         
* 4) CLEAR THE FILMCODE, AD-ID, HIGH-DEF AND CENTERCUT FIELDS         *         
* 5) REPLACE THOSE FIELDS WITH THE INFO FROM THE NEW CMML RECORD      *         
***********************************************************************         
         USING CMLDTAEL,R5                                                      
SC06     MVC   0(2,RF),CMLSEQ+1    NEW SEQUENCE NUMBER                          
         B     SC05A                                                            
         DROP  R5                                                               
*                                                                               
SC06A    DS    0H                                                               
         USING CMLADIEL,R5                                                      
         MVC   FLMADID-FLMSEQ(8,RF),CMLADIDP  SET 8 CHAR PACKED AD-ID           
         B     SC05A                                                            
         DROP  R5                                                               
*                                                                               
SC06B    DS    0H                                                               
         USING CMLXDTEL,R5                                                      
         MVC   FLMHDEF-FLMSEQ(8,RF),CMLXHDPK  SET 8 CHAR HIGHDEF                
         MVC   FLMCNTR-FLMSEQ(8,RF),CMLXCCPK  SET 8 CHAR CENTERCUT              
         B     SC05A                                                            
         DROP  R5                                                               
*                                                                               
SC07     MVC   SVKEY+5(5),FLMSEQ   SAVE OFF CURRENT KEY                         
         GOTO1 BINSRCH,FLMTPARS,(1,WORK)                                        
*                                                                               
         L     R8,AFINV            A(FIRST INVOICE ELEMENT)                     
*                                                                               
SC07A    C     R8,ALINV            PROCESSED THE LAST INVOICE?                  
         BNL   SC07D               YES - DONE                                   
         CLC   FLMIDNO,IINVID      MATCH ON INTERNAL INVOICE NUMBER?            
         BNE   SC07C               NO                                           
         CLC   FLMICOD,IFILM       MATCH ON 1ST FILM?                           
         BE    SC07B               YES - TEST CENTERCUT                         
         CLI   IFILM2,0            HAVE 2ND FILM?                               
         BE    SC07C               NO                                           
         CLC   FLMICOD,IFILM2      MATCH ON 2ND FILM?                           
         BNE   SC07C               NO                                           
SC07B    OI    ISTAT4,IST4CNTR     YES - FLAG AS CENTERCUT!                     
*                                                                               
SC07C    AH    R8,IELMLEN          NEXT INVOICE ITEM                            
         B     SC07A                                                            
*                                                                               
SC07D    L     R6,AFLMTAB          FILM TABLE                                   
*                                                                               
SC08     CLC   FLMSEQ(5),SVKEY+5   KEY WE JUST PROCESSED?                       
         BE    SC50                YES                                          
         LA    R6,FLMTABEL(R6)     NEXT ENTRY                                   
         B     SC08                                                             
*                                                                               
SC50     CLC   FLMSEQ(5),SVKEY     JUST PROCESSED LAST TABLE ENTRY?             
         BE    SCX                 YES, DONE                                    
         LA    R6,FLMTABEL(R6)     NEXT ENTRY                                   
         B     SC00                                                             
*                                                                               
SCX      B     INEXT                                                            
         DROP  R6                                                               
         LTORG                                                                  
         TITLE 'ICSMATCH - ICS MATCHING MODULE'                                 
**********************************************************************          
*        MATCHING MODULE                                                        
**********************************************************************          
ICSMATCH NMOD1 0,ICSMATCH                                                       
         LA    RC,SPACEND                                                       
         USING BYELEMD,R7                                                       
         USING IELEMD,R8                                                        
*---------------------------------------------------------------------          
*        CHECK INTERVALS                                                        
*---------------------------------------------------------------------          
         MVI   SECSEPER,C'N'       SET TO NO SECONDARY SEPARATION ERROR         
         BRAS  RE,CHKINT           NOTE- CHKINT MAY SORT FOR                    
*                                  DEFERRED DATE CHANGE CODE                    
*---------------------------------------------------------------------          
*        LOOP THROUGH INVOICE DETAILS AND CHECK SPOTS FOR MATCH                 
*---------------------------------------------------------------------          
*                                                                               
         MVI   REMFLAG,0                                                        
**       CLI   NETPSW,C'Y'         FOR NETPAK ONLY FOR NOW                      
**       BNE   MM20                                                             
         CLI   I2APROF+12,C'Y'     REMATCH FEATURE                              
         BE    MM10                                                             
         CLI   I2APROF+12,C'P'     REMATCH IF PAID                              
         BNE   MM20                                                             
MM10     OI    REMFLAG,REMACT      REMATCH IS ACTIVE                            
         OI    REMFLAG,REMFRST     MAKE FIRST PASS THRU MATCHED                 
*                                                                               
MM20     MVI   MISPASS,0                                                        
MM30     DS    0H                                                               
         XC    AMORB,AMORB                                                      
         L     R8,AFINV                                                         
MM40     C     R8,ALINV                                                         
         BH    MM200                                                            
         OC    IBY,IBY             SKIP IF ALREADY MATCHED                      
         BNZ   MM90                                                             
*                                                                               
         TM    REMFLAG,REMFRST     REMATCH FIRST PASS                           
         BNO   MM50                                                             
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   *+14                NO                                           
         OC    IMATDATE,IMATDATE   REMATCH IF WAS MATCHED BEFORE                
         B     *+10                OR WAIT FOR 2ND PASS                         
         OC    IMATSDAT,IMATSDAT   REMATCH IF WAS MATCHED BEFORE                
         BZ    MM90                OR WAIT FOR 2ND PASS                         
*                                                                               
MM50     L     R7,AFBY                                                          
         MVI   OLDMFLD,X'FF'                                                    
         MVI   RMLST,X'FF'                                                      
         MVC   RMLST+1(L'RMLST-1),RMLST                                         
MM60     C     R7,ALBY                                                          
         BH    MM75                                                             
         MVI   RMCALL,C'N'         NOT A REMATCH CALL                           
         BAS   RE,MATCH                                                         
         TM    MSW,X'C0'                                                        
         BM    MM120               GOOD MATCH                                   
         BO    MM130               BUY ALREADY MATCHED                          
*                                                                               
         TM    REMFLAG,REMFRST     REMATCH FIRST PASS + NO MATCH                
         BO    MM90                SKIP TO NEXT INVOICE DETAIL                  
*                                                                               
MM70     LA    R7,BYELEML(R7)                                                   
         B     MM60                                                             
MM75     CLI   OLDMFLD,X'FF'                                                    
         BE    MM100                                                            
*                                  GOOD MATCH                                   
MM80     DS    0H                                                               
         MVC   IBY,OLDMBY          SET BUY REFERENCE                            
*                                                                               
         TM    REMFLAG,REMFRST     REMATCH FIRST PASS + MATCH                   
         BO    *+10                IMIS MAY ALREADY BE SET BY REMATCH           
         MVC   IMIS,MISPASS        SET MISMATCH FIELD                           
*                                                                               
         SR    R7,R7                                                            
         ICM   R7,7,OLDMBY                                                      
         A     R7,AFBY                                                          
         BCTR  R7,R0                                                            
         LLC   R0,BYUNACH                                                       
         BCTR  R0,R0                                                            
         STC   R0,BYUNACH          POST NEW UNACHIEVED COUNTER                  
         TM    BYSTAT,X'08'        TEST ORBIT SLAVE                             
         BZ    MM90                                                             
         BAS   RE,MORB                                                          
         L     RF,AMORB            A(ORBIT MASTER) - SET IN MATCH               
         LA    RF,BYUNACH-BYELEM(RF)                                            
         IC    RE,0(RF)                                                         
         BCTR  RE,R0                                                            
         STC   RE,0(RF)            POST NEW UNACHIEVED COUNTER                  
*                                  BUMP TO NEW INVOICE                          
MM90     AH    R8,IELMLEN                                                       
         B     MM40                                                             
*---------------------------------------------------------------------          
*        REMATCHING  - BEST MATCH? - THIS IS OLD REMATCHING (NOT I2A)           
*---------------------------------------------------------------------          
MM100    DS    0H                                                               
         LA    R3,RMLST                                                         
         LA    R4,L'MFLD                                                        
         LA    R5,RMLSTX                                                        
MM110    CLI   0(R3),X'FF'                                                      
         BE    MM90                                                             
         BAS   RE,RMTCH                                                         
         TM    RMSW,X'80'          TEST HAVE REMATCHED                          
         BZ    MM115                                                            
         MVC   IBY,7(R3)           SET NEW BUY REFERENCE                        
         B     MM90                                                             
MM115    BXLE  R3,R4,MM110                                                      
         B     MM90                                                             
*                                                                               
MM120    DS    0H                  KEEP BEST MFLD                               
         TM    MSW,X'20'           TEST FORCED TO ACCEPT THIS MATCH             
         BNZ   MM125                                                            
         CLC   OLDMFLD,MFLD                                                     
         BNH   MM70                                                             
         MVC   OLDMFLD,MFLD                                                     
         B     MM70                                                             
*                                                                               
MM125    DS    0H                  FORCE TO ACCEPT                              
         MVC   OLDMFLD,MFLD        SET MATCH DATA                               
         B     MM80                AND STOP SEARCH                              
*                                                                               
*                                  BUILD LIST OF ALREADY MATCHED                
*                                  'POTENTIAL' MATCHES                          
MM130    CLI   OLDMFLD,X'FF'                                                    
         BNE   MM70                HAVE GOOD MATCH                              
         LA    R3,RMLST                                                         
         LA    R4,L'MFLD                                                        
         LA    R5,RMLSTX                                                        
*                                  KEEP LIST IN 'GOOD MATCH' ORDER              
MM140    CLC   MFLD,0(R3)                                                       
         BL    MM150                                                            
         BXLE  R3,R4,MM140                                                      
         B     MM70                                                             
MM150    SR    R5,R3                                                            
         EX    R5,MMVC1            MOVE END OF LIST TO WORK                     
         SR    R5,R4                                                            
         BNP   MM155                                                            
         EX    R5,MMVC2            MOVE WORK BACK IN                            
MM155    MVC   0(L'MFLD,R3),MFLD                                                
         B     MM70                                                             
*                                                                               
*---------------------------------------------------------------------          
*        NEED ANOTHER PASS ?   FOR I2A REMATCH OR PARTIAL MATCHING              
*---------------------------------------------------------------------          
MM200    DS    0H                                                               
*                                                                               
         TM    REMFLAG,REMFRST     DID WE JUST DO OUR FIRST PASS?               
         BNO   MM210                                                            
         NI    REMFLAG,X'FF'-REMFRST                                            
         NI    REMFLAG,X'FF'-(REMNOFLM+REMFOUND)                                
         B     MM30                GO BACK FOR MORE!                            
*                                                                               
MM210    CLI   MISMOPT,C'Y'        NO 2ND PASS                                  
         BNE   MMEXT                                                            
         CLI   MISPASS,0                                                        
         BNE   MM220                                                            
         MVC   MISPASS,MISLIST     DO FIRST REPEAT                              
         B     MM30                                                             
MM220    DS    0H                                                               
*                                  DO NEXT REPEAT PASS                          
         LA    RF,MISLIST                                                       
MM230    DS    0H                                                               
         CLC   MISPASS,0(RF)                                                    
         BE    MM240                                                            
         LA    RF,1(RF)                                                         
         B     MM230                                                            
MM240    DS    0H                                                               
         CLI   1(RF),C' '          EOL                                          
         BNH   MMEXT                                                            
         MVC   MISPASS,1(RF)                                                    
         B     MM30                                                             
*                                                                               
MMEXT    J     EXIT                                                             
MMVC1    MVC   W(0),0(R3)                                                       
MMVC2    MVC   L'MFLD(0,R3),W                                                   
         EJECT                                                                  
*---------------------------------------------------------------------          
*        MATCH ROUTINE - COMPARE INVOICE DETAIL TO SPOT DETAIL                  
*---------------------------------------------------------------------          
*                                                                               
MATCH    NTR1                                                                   
         XC    MFLD,MFLD                                                        
*                                                                               
         TM    REMFLAG,REMFRST     FIRST PASS IS TO TRY TO REMATCH              
         BNO   MT10                                                             
         BRAS  RE,REMATCH          LOOK FOR UNIT LAST MATCHED TO THIS           
*                                                                               
*------- NO MATCH FOR ...  -------------------------------------------          
*                                                                               
MT10     CLI   NETPSW,C'Y'         IS IT NETPAK?                                
         BE    *+12                                                             
         TM    BYSTAT2,BYSTCS2Q    NO COS2=NO MATCH-SPOT ONLY                   
         BO    MTEXT                                                            
*                                                                               
         CLI   BYPRD,X'FF'         NO MATCH FOR UNALLOCATED                     
         BE    MTEXT                                                            
         CLC   BYPRDNT,=C'POL'     NO MATCH FOR UNALLOCATED                     
         BE    MTEXT                                                            
         TM    BYSTAT,X'10'        DO NOT MATCH ORBIT MASTER                    
         BNZ   MTEXT                                                            
         TM    BYSTAT2,BYSTMISQ    DON'T MATCH MISSED SPOTS                     
         BNZ   MTEXT                                                            
*                                                                               
*------- CMML MATCHING DATES AND RECALL RELEASE DATES ----------------          
*                                                                               
         TM    FLMCHK,FLMCFLT      TEST CHECKING FLIGHT DATES                   
         BNO   MT16                                                             
         TM    ISTAT2,X'02'        SET TO IGNORE FILM ERRORS?                   
         BO    *+12                YES                                          
         TM    ISTAT3,IST3FLTF     MATCHING FLIGHT DATES INVALID                
         BO    MTEXT                                                            
*                                                                               
* IF MATCHING DATES EXIST THEN SKIP RECALL/RELEASE CHECK                        
*                                                                               
         TM    ISTAT3,IST3FLTS     MATCHING FLIGHT DATES EXIST                  
         BO    MT20                                                             
*                                                                               
MT16     CLI   I2ZPROF+1,C'N'      MATCH FILMS FOR LOCAL CABLE                  
         BNE   *+12                                                             
         CLI   BIGSTA+4,C'/'       LOCAL CABLE                                  
         BE    MT20                YES THEN DON'T CHECK FILMS                   
*                                                                               
         TM    FLMCHK,FLMCRR       TEST CHECKING RECALL RELEASE                 
         BNO   MT20                                                             
         TM    ISTAT2,X'02'        SET TO IGNORE FILM ERRORS?                   
         BO    MT20                YES                                          
         TM    ISTAT2,ISTRCRL      YES, ANY RECALL/RELEASE ERROR?               
         BNZ   MTEXT                                                            
*                                                                               
*------- CMML PRODUCT CODES ------------------------------------------          
*                                                                               
MT20     TM    FLMCHK,FLMCPRD      TEST CHECKING COMML PRODUCTS                 
         BNO   MT25                                                             
         TM    ISTAT2,X'02'        SET TO IGNORE FILM ERRORS?                   
         BO    MT25                YES                                          
         TM    ISTAT,ISTPRDF       YES, TEST FILM PRD ERROR?                    
         BNZ   MTEXT                                                            
*                                                                               
*------- CMML TIMES --------------------------------------------------          
*                                                                               
MT25     TM    FLMCHK,FLMCTIM      TEST CHECKING COMML TIMES                    
         BNO   MT26                                                             
         TM    ISTAT2,X'02'        SET TO IGNORE FILM ERRORS?                   
         BO    MT26                YES                                          
         TM    ISTAT3,IST3TIMF     YES, ALSO TEST FILM TIME ERROR?              
         BNZ   MTEXT                                                            
*                                                                               
*------- CMML LENGTH -------------------------------------------------          
*                                                                               
MT26     TM    FLMCHK,FLMCLEN      TEST CHECKING COMML LEN                      
         BNO   MT30                                                             
         TM    ISTAT2,X'02'        SET TO IGNORE FILM ERRORS?                   
         BO    MT30                YES                                          
         TM    ISTAT4,IST4LENF     YES, TEST FILM LEN ERROR?                    
         BNZ   MTEXT                                                            
*                                                                               
*------- MISSING OR INVALID FILM  ------------------------------------          
*                                                                               
MT30     CLI   TRAFIDSC,C'Y'       INVALID FILM A DISCREPANCY?                  
         BNE   MT60                NO                                           
         CLI   MISPASS,C'F'        BYPASS FILM MATCHING?                        
         BE    MT60                YES                                          
*                                                                               
         CLI   I2CPROF,C'Y'        SKIP INV OR MISSING CHECK                    
         BNE   MT35                                                             
         TM    ISTAT2,X'02'        IF SET TO IGNORE FILM ERRORS                 
         BO    MT60                                                             
*                                                                               
MT35     TM    REMFLAG,REMNOFLM    SKIP FILM STUFF ON REMATCH                   
         BO    MT60                                                             
*                                                                               
         CLI   I2ZPROF+1,C'N'      MATCH FILMS FOR LOCAL CABLE                  
         BNE   MT40                                                             
         CLI   BIGSTA+4,C'/'       LOCAL CABLE                                  
         BE    MT60                YES THEN DON'T MATCH FILMS                   
*                                                                               
MT40     OC    TRAF9YR(2),TRAF9YR  EFFECTIVE DATE FOR FILM MATCH?               
         BZ    MT50                                                             
         LLC   R1,TRAF9YR                                                       
         CLI   TRAF9YR,80          IF YEAR < 80 ADD 100 FOR CENTURY             
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,TRAF9YR                                                       
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),TRAF9YR     IS MONTH OF REQ BEFORE EFF DATE              
         BL    MT60                YES THEN DON'T MATCH FILMS                   
*                                                                               
MT50     TM    ISTAT2,X'02'        SET TO IGNORE FILM ERRORS?                   
         BO    MT60                YES                                          
         TM    ISTAT,ISTINVF       YES, IS FILM INVALID?                        
         BNZ   MTEXT                                                            
         CLI   IFILM,0             OR MISSING?                                  
         BE    MTEXT                                                            
*                                                                               
*------- DATE --------------------------------------------------------          
*                                                                               
MT60     DS    0H                                                               
         CLI   MISPASS,0           ON LATER PASSES                              
         BE    MT62                                                             
         CLI   BYUNACH,0           SKIP ALREADY MATCHED BUYS                    
         BE    MTEXT                                                            
MT62     DS    0H                                                               
         CLI   MISPASS,C'W'        BYPASS WEEK TEST                             
         BE    MT70                                                             
         CLI   MISPASS,C'D'        BYPASS DATE TEST                             
         BE    MT70                                                             
         CLC   IDAT,BYSDT                                                       
         BL    MT64                                                             
         CLC   IDAT,BYEDT                                                       
         BH    MT64                                                             
         B     MT70                                                             
*                                                                               
MT64     TM    REMFLAG,REMFOUND    TRYING TO REMATCH                            
         BNO   MTEXT               NO - THEN NO MATCH                           
*                                                                               
         MVI   REMPART,C'W'        WAS PARTIAL MATCH FOR WEEK                   
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MT66                NO - TRY DAY                                 
         MVC   IMIS,REMPART        SET  - SKIPPED DATA                          
         B     MT70                YES - OK TO CONTINUE                         
*                                                                               
MT66     MVI   REMPART,C'D'        WAS PARTIAL MATCH FOR DAY                    
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MTEXT               NO - STILL NO MATCH                          
         MVC   IMIS,REMPART        SET - SKIPPED DATA                           
*                                                                               
*------- LENGTH ------------------------------------------------------          
*                                                                               
MT70     DS    0H                                                               
         CLI   MISPASS,C'L'        BYPASS LENGTH TEST                           
         BE    MT80                                                             
         TM    ISTAT3,IST3ISPT     IGNORE SPOT LENGTH FOR MATCHING?             
         BO    MT80                YES                                          
         CLC   ILEN,BYLEN                                                       
         BE    MT80                                                             
*                                                                               
         CLI   LENLWAY,C'Y'        HONOR LENGTH LEEWAY?                         
         BNE   MT75                NO                                           
         CLC   BYLEN,ILEN          IS BUY LEN BEFORE INV LEN?                   
         BL    MT70A               YES - DON'T LOOK AT LEEWAY BEFORE            
         LLC   R1,BYLEN            SPOT LENGTH                                  
         LLC   R2,I2BPROF+9        LEEWAY BEFORE                                
         SR    R1,R2               (SPOT LENGTH - LEEWAY BEFORE) > 0?           
         BNP   MT80                NO, MATCH THIS SPOT                          
         STC   R1,BYTE                                                          
         CLC   BYTE,ILEN           LENGTH <= INVOICE LENGTH?                    
         BNH   MT80                YES - MATCH THIS SPOT                        
*                                                                               
MT70A    CLC   BYLEN,ILEN          IS BUY LEN AFTER INV LEN?                    
         BH    MT75                YES - DON'T LOOK AT LEEWAY AFTER             
         LLC   R1,BYLEN            SPOT LENGTH                                  
         LLC   R2,I2BPROF+10       LEEWAY AFTER                                 
         AR    R1,R2               SPOT LENGTH + LEEWAY AFTER                   
         CHI   R1,255              >= 255?                                      
         BNL   MT80                YES - MATCH THIS SPOT                        
         STC   R1,BYTE                                                          
         CLC   BYTE,ILEN           LENGTH >= INVOICE LENGTH?                    
         BNL   MT80                YES, MATCH THIS SPOT                         
*                                                                               
MT75     TM    REMFLAG,REMFOUND    TRYING TO REMATCH                            
         BNO   MTEXT               NO - THEN NO MATCH                           
*                                                                               
         MVI   REMPART,C'L'        WAS PARTIAL MATCH FOR LENGTH                 
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MTEXT               NO - NO MATCH                                
         MVC   IMIS,REMPART        SET - SKIPPED DATA                           
*                                                                               
*------- ESTIMATE ----------------------------------------------------          
*                                                                               
MT80     DS    0H                                                               
         CLI   IEST,0              IF HAVE ESTIMATE                             
         BE    MT84                                                             
         CLC   IEST,BYEST          IT EST MUST MATCH                            
         BNE   MTEXT                                                            
         B     MT90                                                             
*                                                                               
MT84     DS    0H                  NO EST ON INV ITEM                           
         CLI   I2XPROF+2,C'Y'      TEST TO REJECT                               
         BNE   MT90                NO                                           
         CLC   =C'NO ',QEST        YES- SKIP IF NOT EST=NO                      
         BNE   MTEXT                                                            
*                                                                               
*------- PRODUCT -----------------------------------------------------          
*                                                                               
MT90     DS    0H                                                               
         CLI   MISPASS,C'P'        BYPASS PRD TEST                              
         BE    MT100                                                            
         CLI   IPRD,X'FF'          POL INV SPOT                                 
         BNE   MT90X               NO                                           
         CLI   NETPSW,C'Y'         IS IT NETPAK?                                
         BNE   MT100               NO, DON'T TEST POL IN SPOT                   
         CLI   IPRD2NT,0           HAVE PIGGY?                                  
         BNE   MT100               YES                                          
         CLI   CMLPRD,C'Y'         MATCH UNIT AGAINST CMML PRD LIST?            
         BNE   MT100               NOPE                                         
***                                                                             
* WE WILL ATTEMPT TO MATCH THE UNIT'S PRODUCT AGAINST ANY OF THE                
* PRODUCTS ON THE COMMERCIAL RECORD AS PER THE I2B PROFILE                      
***                                                                             
         L     R6,AFLMTAB          FILM TABLE BUFFER                            
         USING FLMTABD,R6                                                       
         ICM   R0,15,FLMTPARS+8    HAVE ANY FILM TABLE ENTRIES?                 
         BZ    MT92                NOPE                                         
*                                                                               
MT90AA   CLC   FLMIDNO,IINVID      FROM RIGHT INVOICE/RSET?                     
         BNE   MT90AB              NO                                           
         CLC   FLMICOD,IFILM       MATCH ON 1ST FILM?                           
         BE    MT90AC              YES                                          
         CLI   IFILM2,0            ANY 2ND FILM?                                
         BE    MT90AB              NO                                           
         CLC   FLMICOD,IFILM2      MATCH ON 2ND FILM?                           
         BE    MT90AC              YES                                          
*                                                                               
MT90AB   LA    R6,FLMTABEL(R6)     NEXT ENTRY                                   
         BCT   R0,MT90AA                                                        
         B     MT92                                                             
*                                                                               
MT90AC   LA    R2,FLMPRDS          POINT TO FILM PRD LIST                       
         LA    R1,3                3 FOR THIS ENTRY                             
         CLI   0(R2),X'FF'         CML REC SET FOR ALL PRD?                     
         BE    MT100               YES - MATCH ANY UNIT PRD                     
*                                                                               
MT90A    CLC   BYPRDNT,0(R2)       MATCH UNIT PRD?                              
         BE    MT100               YES                                          
         AHI   R2,3                NEXT FILM PRD                                
         BCT   R1,MT90A                                                         
*                                                                               
         TM    FLMSTAT,FLMSPRD     HAVE MORE PRDS TO CHECK?                     
         BZ    MT92                NO                                           
*                                                                               
         MVC   SVKEY(5),FLMSEQ     SAVE OFF THE KEY                             
         OC    FLMCPTR,FLMCPTR     IS THIS A CENTRCUT POINTER?                  
         BZ    *+10                NO                                           
         MVC   SVKEY(2),FLMCPTR    YES - THIS IS THE REAL SEQ NUM               
*                                                                               
         USING FPRDTABD,R3                                                      
         L     R3,APRDTAB          MORE PRDS BUFFER                             
*                                                                               
MT90B    OC    0(5,R3),0(R3)       ANY MORE BUFFERED PRODUCT LISTS?             
         BNZ   *+6                 YES                                          
         DC    H'0'                NO - DEATH                                   
         CLC   SVKEY(FLMTABKL),FPRDSEQ     DO THE KEYS MATCH?                   
         BE    MT90C               YES - WE HAVE OUR EXTENDED PRD LIST          
         LLC   R0,FPRDLEN          BUFFER LENGTH                                
         AR    R3,R0               BUMP TO NEXT ENTRY                           
         B     MT90B                                                            
*                                                                               
MT90C    LA    R2,FPRDLIST         PRODUCT LIST                                 
         LLC   R1,FPRDLEN          ENTRY LENGTH                                 
         SHI   R1,FPRTABKL+1       MINUS KEY AND LENGTH                         
         SR    R0,R0                                                            
         D     R0,=F'3'            NEED TO DIVIDE BY 3 TO GET # OF PRDS         
*                                                                               
MT90D    CLC   BYPRDNT,0(R2)       MATCH UNIT PRD?                              
         BE    MT100               YES                                          
         AHI   R2,3                NEXT FILM PRD                                
         BCT   R1,MT90D                                                         
         B     MT92                                                             
         DROP  R3,R6                                                            
*                                                                               
MT90X    CLI   NETPSW,C'Y'         IS IT NETPAK?                                
         BNE   MT91                NO                                           
         CLC   IPRDNT(6),BYPRDNT   MATCH ON 3 CHAR PRD/PRD2?                    
         BE    MT100               YES                                          
         MVC   WORK(3),BYPRD2NT                                                 
         MVC   WORK+3(3),BYPRDNT                                                
         CLC   IPRDNT(6),WORK      TRY REVERSE ORDER                            
         BE    MT100                                                            
         B     MT92                                                             
*                                                                               
MT91     CLC   IPRD(2),BYPRD                                                    
         BE    MT100                                                            
         MVC   WORK(1),BYPRD2                                                   
         MVC   WORK+1(1),BYPRD                                                  
         CLC   IPRD(2),WORK        TEST REVERSE ORDER                           
         BE    MT100                                                            
*                                                                               
         TM    ISTAT4,IST4SBRD     HAVE SUBSTITUTION BRANDS ON INVOICE?         
         BZ    MT92                NO                                           
         CLI   IPRD2,0             PIGGY ON INVOICE?                            
         BNE   MT92                YES                                          
         CLI   BYPRD2,0            PIGGY ON BUY?                                
         BNE   MT92                YES                                          
*                                                                               
         L     R3,APRDTAB          SUBSTITUTION BRANDS TABLE                    
         USING FPRDTABD,R3         SUBSTITUTION BRANDS TABLE DSECT              
         XR    R1,R1               CLEAR R1                                     
*                                                                               
MT91A    OC    0(5,R3),0(R3)       ANY MORE SUBSTITUTION BRANDS?                
         BZ    MT92                NO                                           
         CLC   FPRDIDNO,IINVID     RIGHT INVOICE?                               
         BNE   MT91B               NO                                           
         CLC   FPRDICOD,IFILM      MATCH ON 1ST FILM?                           
         BE    MT91C               YES                                          
         CLI   IFILM2,0            HAVE A 2ND FILM?                             
         BE    MT91B               NO                                           
         CLC   FPRDICOD,IFILM2     MATCH ON 2ND FILM?                           
         BE    MT91C               YES                                          
*                                                                               
MT91B    IC    R1,FPRDLEN          ENTRY LENGTH                                 
         AR    R3,R1               BUMP TO NEXT ENTRY                           
         B     MT91A               TEST NEXT ENTRY                              
*                                                                               
MT91C    IC    R1,FPRDLEN          ENTRY LENGTH                                 
         SHI   R1,FPRTABKL+1       MINUS KEY AND LENGTH                         
         XR    R0,R0               CLEAR R0                                     
         D     R0,=F'5'            DIVIDE BY 5 TO GET # OF PRDS ENTRIES         
*                                                                               
         LA    RF,FPRDBPRD         START OF PRD LIST                            
         DROP  R3                  DROP SUBSTITUTION PRD DSECT USING            
*                                                                               
         USING FPRDBPRD,RF         SUBSTITUTION PRD AND DATES                   
MT91D    CLC   BYPRD,FPRDBPRD      MATCH ON BUY PRODUCT?                        
         BNE   MT91E               NO                                           
         CLC   BYSDT,FPRDSDAT      BUY DATE BEFORE START DATE?                  
         BL    MT91E               YES - NEXT ENTRY                             
         CLC   BYEDT,FPRDEDAT      DATE AFTER BUY END DATE                      
         BNH   MT100               NO - FALLS WITHIN PERIOD                     
MT91E    LA    RF,5(RF)            BUMP TO NEXT ENTRY                           
         BCT   R1,MT91D            CHECK NEXT PRD ENTRY                         
         DROP  RF                  DROP SUBSTITUTION PRD USING                  
*                                                                               
MT92     TM    REMFLAG,REMFOUND    TRYING TO REMATCH                            
         BNO   MTEXT               NO - THEN NO MATCH                           
         MVI   REMPART,C'P'        WAS PARTIAL MATCH FOR PRD                    
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MTEXT               NO - STILL NO MATCH                          
         MVC   IMIS,REMPART        SET PROD SKIP -PARTIAL MATCH                 
*                                                                               
*------- MAKEGOOD ----------------------------------------------------          
*                                                                               
MT100    DS    0H                                                               
         TM    ISTAT,X'04'         INVOICE MG                                   
         BZ    MT105                                                            
         TM    BYSTAT,X'04'        MUST MATCH BUY MG                            
         BNZ   MT110                                                            
         B     MT06                                                             
*                                                                               
MT105    DS    0H                  INVOICE NOT A MG                             
         TM    BYSTAT,X'04'        IF BUY IS A MG                               
         BZ    MT110                                                            
MT06     OI    MTIM,X'02'          GIVE MATCH A POOR SCORE                      
         CLI   I2XPROF+6,C'Y'      TEST OPTION TO NOT MATCH                     
         BE    MTEXT               YES- NO MATCH                                
*                                                                               
*------- COST --------------------------------------------------------          
*                                                                               
MT110    DS    0H                                                               
         CLI   MISPASS,C'C'        BYPASS COST TEST                             
         BE    MT120                                                            
**       CLI   I2IPROF+1,C'Y'      MATCH ONLY ON INTEGRATION SKIP COST          
**       BE    MT120                                                            
         CLI   I2XPROF+3,C'Y'      OPTION TO SKIP COST MATCH                    
         BE    MT120                                                            
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BE    MT112                                                            
         TM    BYSTAT,X'20'        TEST NTP/SYND BUY - SPOT ONLY                
         BZ    MT116               NO                                           
         OC    ICOST,ICOST         YES - MATCH TO ZERO INV                      
         BZ    MT120                                                            
         B     MTEXT                                                            
*                                                                               
MT112    CLI   I2NPROF,C'Y'        BLANK COST DISCREPANT?                       
         BNE   MT116                                                            
         OC    I2NPROF+1(2),I2NPROF+1     EFFECTIVE DATE                        
         BZ    MT114                                                            
         LLC   R1,I2NPROF+1                                                     
         CLI   I2NPROF+1,80        IF YEAR < 80 ADD 100 FOR CENTURY             
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,I2NPROF+1                                                     
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2NPROF+1   IS MONTH OF REQ BEFORE EFF DATE              
         BL    MT116               YES THEN MATCH BLANK COSTS                   
*                                                                               
MT114    TM    BYSTAT,X'20'        TEST DOLLARS  - NET ONLY                     
         BZ    MT118               NO = BLANK COST - DON'T MATCH                
*                                                                               
MT116    TM    ISTAT,X'80'                                                      
         BNZ   MT120               BYPASS MATCH ON COST                         
         CLI   PSEUDOPT,C'N'       OR IF DOING PSEUDO/RESP                      
         BNE   MT120               BYPASS MATCH ON COST                         
         MVC   FULL(1),ISTAT       NEG STATUS MUST BE SAME                      
         XC    FULL(1),BYSTAT                                                   
         TM    FULL,X'01'          NEG STATUS MUST MATCH                        
         BNZ   MT118                                                            
         ICM   RF,15,BYCOST                                                     
         TM    ISTAT2,X'10'        TEST MATCH ON NET                            
         BZ    *+8                                                              
         ICM   RF,15,BYNET                                                      
*                                                                               
         CLM   RF,15,ICOST                                                      
         BE    MT120                                                            
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BE    MT118               YES                                          
         ICM   RE,15,ICOST         INVOICE COST                                 
         SR    RE,RF               DIFFERENCE BETWEEN BUY & INV COST            
         LPR   RE,RE               MAKE DIFFERENCE POSITIVE                     
         LLC   RF,COSTTOL          COST TOLERANCE                               
         CR    RE,RF               DOES COST EXCEED TOLERANCE?                  
         BNH   MT120               NO - WITHIN TOLERANCE - MATCH                
*                                                                               
MT118    TM    REMFLAG,REMFOUND    TRYING TO REMATCH                            
         BNO   MTEXT               NO - THEN NO MATCH                           
*                                                                               
         MVI   REMPART,C'C'        WAS PARTIAL MATCH FOR COST                   
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MTEXT               NO - NO MATCH                                
         MVC   IMIS,REMPART        SET - SKIPPED DATA                           
*                                                                               
*------- DAY OF WEEK -------------------------------------------------          
*                                                                               
MT120    DS    0H                                                               
         CLI   MISPASS,C'D'        BYPASS DATE TEST                             
         BE    MT130                                                            
         CLI   MISPASS,C'A'        BYPASS DAY OF WEEK TEST                      
         BE    MT130                                                            
         IC    R5,BYDAY                                                         
         STC   R5,*+5                                                           
         TM    IDAY,0                                                           
         BZ    MT122               NO MATCH                                     
         B     MT130               MATCHES - GO TO NEXT                         
*                                                                               
MT122    TM    REMFLAG,REMFOUND    TRYING TO REMATCH                            
         BNO   MTEXT               NO - THEN NO MATCH                           
*                                                                               
         MVI   REMPART,C'D'        WAS PARTIAL MATCH FOR DATE                   
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MT124               NO - NO MATCH                                
         MVC   IMIS,REMPART        SET - SKIPPED DATA                           
         B     MT130               AND KEEP GOING                               
*                                                                               
MT124    MVI   REMPART,C'A'        WAS PARTIAL MATCH FOR DAY                    
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MTEXT               NO - NO MATCH                                
         MVC   IMIS,REMPART        SET - SKIPPED DATA                           
*                                                                               
*------- TIME --------------------------------------------------------          
*                                                                               
MT130    DS    0H                                                               
         CLI   MISPASS,C'T'        BYPASS TIME TEST                             
         BE    MT160                                                            
         MVC   FULL,BYSTIM         START AND END TIMES                          
*                                  START OF 600A = 3000                         
         CLC   FULL(2),=H'360'                                                  
         BNE   *+10                                                             
         MVC   FULL(2),=H'1800'                                                 
         MVC   HALF,ITIM                                                        
         CLC   ITIM,FULL           START TIME                                   
         BNL   MT140                                                            
         LH    R5,FULL                                                          
         SH    R5,TIMOPT1          LEEWAY FOR BEFORE                            
         CH    R5,HALF                                                          
         BH    MT135                                                            
         OI    MTIM,1                                                           
         B     MT140                                                            
*                                                                               
MT135    DS    0H                  BEFORE STAT                                 
         CLC   FULL(2),FULL+2      START VS END - IF HIGH TIMES SPAN 6A         
         BNH   MT150               MISS ON TIME                                 
         B     MT145               YES - TRY END TIME                           
MT140    DS    0H                                                               
         CLC   FULL(2),FULL+2      START VS END - IF HIGH TIMES SPAN 6A         
         BH    MT160               INVOICE MUST BE EITHER AFTER                 
*                                  START OR BEFORE END                          
MT145    DS    0H                                                               
         CLC   ITIM,FULL+2         END TIME                                     
         BNH   MT160                                                            
         LH    R5,FULL+2                                                        
         AH    R5,TIMOPT2          LEEWAY FOR AFTER                             
         CH    R5,HALF                                                          
         BL    MT150               MISS ON TIME                                 
         OI    MTIM,1                                                           
         B     MT160                                                            
*                                                                               
MT150    DS    0H                  MIS-MATCH ON TIME                            
         TM    ISTAT,X'02'         TEST TO IGNORE TIME                          
         BZ    MT155               NO- NO MATCH                                 
         OI    MTIM,X'20'          YES- ALLOW MATCH BUT GIVE BAD SCORE          
         B     MT160                                                            
*                                                                               
MT155    TM    REMFLAG,REMFOUND    TRYING TO REMATCH                            
         BNO   MTEXT               NO - THEN NO MATCH                           
*                                                                               
         MVI   REMPART,C'T'        WAS PARTIAL MATCH FOR TIME                   
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MTEXT               NO - NO MATCH                                
         MVC   IMIS,REMPART        SET - SKIPPED DATA                           
*                                                                               
*------- FILM MATCHING -----------------------------------------------          
*                                                                               
MT160    DS    0H                  FILM MATCHING                                
         CLI   TRAFMBF,C'Y'        ONLY IF OPTION IS ON                         
         BE    *+12                                                             
         CLI   TRAFMBF,C'B'                                                     
         BNE   MT170                                                            
         CLI   MISPASS,C'F'        BYPASS FILM MATCHING                         
         BE    MT170                                                            
*                                                                               
         TM    REMFLAG,REMNOFLM    SKIP FILM STUFF ON REMATCH                   
         BO    MT170                                                            
*                                                                               
         OC    TRAF9YR(2),TRAF9YR  EFFECTIVE DATE FOR FILM MATCH?               
         BZ    MT162                                                            
         LLC   R1,TRAF9YR                                                       
         CLI   TRAF9YR,80          IF YEAR < 80 ADD 100 FOR CENTURY             
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,TRAF9YR                                                       
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),TRAF9YR     IS MONTH OF REQ BEFORE EFF DATE              
         BL    MT170               YES THEN DON'T MATCH FILMS                   
*                                                                               
MT162    CLI   I2ZPROF+1,C'N'      MATCH FILMS FOR LOCAL CABLE                  
         BNE   MT164                                                            
         CLI   BIGSTA+4,C'/'       LOCAL CABLE                                  
         BE    MT170               YES THEN DON'T MATCH FILMS                   
*                                                                               
MT164    BAS   RE,MMFFILM1                                                      
         BNE   MT166                                                            
         BAS   RE,MMFFILM2                                                      
         BNE   MT166                                                            
         B     MT170               MATCH - CONTINUE                             
*                                                                               
MT166    TM    REMFLAG,REMFOUND    TRYING TO REMATCH                            
         BNO   MTEXT               NO - THEN NO MATCH                           
*                                                                               
         MVI   REMPART,C'F'        WAS PARTIAL MATCH FOR FILMS                  
         BAS   RE,CHKPART          REQUESTED                                    
         BNE   MTEXT               NO - NO MATCH                                
         MVC   IMIS,REMPART        SET - SKIPPED DATA                           
*                                                                               
*------- BILLBOARD (NETPAK) ------------------------------------------          
*                                                                               
MT170    CLI   I2ZPROF,C'N'        MATCH ON BB                                  
         BE    MT180               SKIP BB MATCH                                
*                                                                               
         TM    BYSTAT2,BYSTBLBQ    IS BUY A BILLBOARD                           
         BZ    MT175               NO                                           
         TM    ISTAT,INVSBLBQ      YES, IS INVOICE                              
         BZ    MTEXT                                                            
         B     MT180                                                            
MT175    DS    0H                                                               
         TM    ISTAT,INVSBLBQ      NO, IS INVOICE                               
         BNZ   MTEXT                                                            
*                                                                               
*------- CABLE NETWORK (SPOT) ----------------------------------------          
*                                                                               
MT180    DS    0H                                                               
         CLI   BYCBLNET,0          IF HAVE BUY CABLE NET                        
         BE    MT190                                                            
         CLI   ICBLNET,0           AND INVOICE                                  
         BE    MT190                                                            
         CLC   BYCBLNET,ICBLNET    THEY MUST AGREE                              
         BNE   MTEXT                                                            
*                                                                               
*------- INTEGRATION (NETPAK) ----------------------------------------          
*                                                                               
*  DO NOT NEED THIS ANYMORE - INT COSTS ARE SET IN BYCOST AND ICOST             
*                                                                               
                                                                                
MT190    DS    0H                                                               
*&&DO                                                                           
         CLI   I2IPROF,C'Y'        MATCH ON INTEGRATION (AND COST)              
         BE    MT195                                                            
         CLI   I2IPROF+1,C'Y'      MATCH ON INTEGRATION ONLY                    
         BNE   MT200                                                            
MT195    CLC   BYINTEG,IINTEG                                                   
         BNE   MTEXT                                                            
*&&                                                                             
*                                                                               
*------- PACKAGE (NETPAK) --------------------------------------------          
*                                                                               
MT200    DS    0H                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   MT210                                                            
         OC    I2ZPROF+11(2),I2ZPROF+11    EFFECTIVE DATE ?                     
         BZ    MT202                                                            
         LLC   R1,I2ZPROF+11                                                    
         CLI   I2ZPROF+11,80          IF YEAR < 80 ADD 100 FOR CENTURY          
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,I2ZPROF+11                                                    
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2ZPROF+11  IS MONTH OF REQ BEFORE EFF DATE              
         BL    MT210               YES THEN SKIP MATCH BY PACKAGE               
*                                                                               
MT202    CLI   I2ZPROF+10,C'P'     MATCH ON PACKAGE IF ONE ON INV               
         BNE   MT204                                                            
         CLI   IPKG,0                                                           
         BE    MT210               NOTHING TO DO IF NOT THERE                   
         B     MT208                                                            
MT204    CLI   I2ZPROF+10,C'Y'     MATCH ON PKG ALWAYS                          
         BNE   MT210                                                            
MT208    CLC   IPKG,BYPKG          SAME PACKAGE                                 
         BNE   MTEXT                                                            
*                                                                               
*------- REP CODE ----------------------------------------------------          
*                                                                               
MT210    CLI   I2APROF+5,C'Y'      MATCH ON REP CODE                            
         BE    MT215                                                            
         CLI   I2APROF+5,C'T'      MATCH ON TRADE REP CODE ONLY                 
         BNE   MT240                                                            
*                                                                               
MT215    OC    I2APROF+6(2),I2APROF+6    EFFECTIVE DATE ?                       
         BZ    MT220                                                            
         LLC   R1,I2APROF+6                                                     
         CLI   I2APROF+6,80          IF YEAR < 80 ADD 100 FOR CENTURY           
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,I2APROF+6                                                     
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2APROF+6   IS MONTH OF REQ BEFORE EFF DATE              
         BL    MT240               YES THEN SKIP MATCH BY REP                   
*                                                                               
MT220    L     R5,AINOLST          GET INVOICE REP FOR DETAIL                   
         XC    HALF,HALF                                                        
         USING INOLSTD,R5                                                       
MT225    CLC   IINVID,INOLNUM      SAME INTERNAL INVOICE NUMBER                 
         BE    MT230                                                            
         AH    R5,INOLSTQ          NEXT INVOICE                                 
         CLI   0(R5),C' '          ANY MORE                                     
         BH    MT225                                                            
         B     MT235               MATCH ON NOTHING THEN                        
MT230    MVC   HALF,INOLREP        REP FOR INVOICE DET IN HALF                  
         DROP  R5                                                               
MT235    CLC   BYSREP,HALF         DO THEY MATCH                                
         BE    MT240               YES, THEN DONE                               
         CLI   I2APROF+5,C'T'      MATCH ON TRADE REP CODE ONLY                 
         BNE   MTEXT               IF NOT THEN DOESN'T MATCH                    
         GOTO1 VRCPACK,DMCB,(C'U',HALF),WORK                                    
         CLC   DARREP,WORK                                                      
         BE    MTEXT               TRADE REP ON INV= NO MATCH                   
         GOTO1 VRCPACK,DMCB,(C'U',BYSREP),WORK                                  
         CLC   DARREP,WORK                                                      
         BE    MTEXT               TRADE REP ON BUY = THEN NO MATCH             
*                                                                               
MT240    DS    0H                                                               
*                                                                               
*------- WE HAVE A MATCH ! -------------------------------------------          
*                                                                               
MT300    DS    0H                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BE    *+10                                                             
         MVC   MAMPW,BYAMPW        PATTERN REF NUMBER FOR NET                   
         MVC   MSTIM,BYSTIM                                                     
         LLC   R5,BYUNACH                                                       
         TM    BYSTAT,X'08'        TEST ORBIT SLAVE                             
         BZ    MT310                                                            
         BAS   RE,MORB             FIND ORBIT MASTER                            
         L     RF,AMORB                                                         
         IC    R5,BYUNACH-BYELEM(RF)                                            
*                                                                               
MT310    DS    0H                                                               
         LCR   R5,R5                                                            
         STC   R5,MUNACH           COMPLEMENT OF UNACHIEVED                     
         OI    MSW,X'80'                                                        
         LTR   R5,R5                                                            
         BNE   MT320                                                            
         OI    MSW,X'40'           BUY ALREADY MATCHED                          
MT320    S     R7,AFBY                                                          
         LA    R7,1(R7)                                                         
         STCM  R7,7,MBY            RELATIVE ADDRESS OF THIS SPOT                
*                                                                               
*------- HANDLE ILLEGAL SEPARATIONS ----------------------------------          
*                                                                               
         TM    ISTAT2,X'40'        TEST FATAL INTERVAL ERROR                    
         BZ    MT350               NO- EXIT                                     
         CLI   RMCALL,C'Y'         SKIP FOR REMATCHING                          
         BE    MT340               NO MATCH                                     
         TM    MSW,X'40'           AND FOR ALREADY MATCHED BUYS                 
         BNZ   MT340               NO MATCH                                     
         CLI   OLDMFLD,X'FF'       DONT BOTHER IF ALREADY HAVE                  
         BNE   MT340               GOOD MATCH                                   
*                                                                               
*                                  FIND FIRST IN INTERVAL                       
         ST    R8,FULL             AND TRY TO REJECT IT INSTEAD                 
MT330    DS    0H                                                               
         SH    R8,IELMLEN                                                       
         C     R8,AFINV                                                         
         BL    MT340               NOT FOUND- LEAVE CURRENT REJECT              
         TM    ISTAT2,X'80'        TEST THIS IS FIRST OF SET                    
         BZ    MT330                                                            
         TM    ISTAT,X'20'         TEST FORCED TO ACCEPT                        
         BNZ   MT340               YES- LEAVE CURRENT AS REJECT                 
         TM    ISTAT2,X'40'        TEST PREV A SEP REJECT                       
         BNZ   MT340               YES- LEAVE CURRENT AS REJECT                 
         OC    IBY,IBY             IS IT MATCHED                                
         BNZ   MT340               YES - LEAVE CURRENT AS REJECT                
         OI    ISTAT2,X'40'        NO- MARK PREV A SEPARATION REJECT            
         L     R8,FULL             RESTORE POINTER                              
         NI    ISTAT2,X'9F'        SET OFF CURRENT FLAGS                        
         OI    MSW,X'20'           FORCE TO ACCEPT THIS MATCH                   
         B     MT350               (BECAUSE CANNOT UNDO RESULTS)                
*                                                                               
MT340    DS    0H                                                               
         MVI   MSW,0               RESET TO NO MATCH                            
*                                                                               
MT350    DS    0H                                                               
         TM    REMFLAG,REMFOUND    REMATCH WAS FOUND                            
         BNO   MTEXT                                                            
***      TM    MSW,X'40'           BUY ALREADY REMATCHED !                      
***      BZ    *+6                                                              
***      DC    H'0'                WILL EVENTUALLY SKIP THIS BUT                
*                                                                               
         OI    MSW,X'20'           SET FORCED TO ACCEPT THIS MATCH              
         OI    ISTAT3,IST3REMD     SET REMATCHED                                
*                                                                               
MTEXT    B     MMEXT                                                            
         EJECT                                                                  
*---------------------------------------------------------------------          
*        CHECK IF WHILE REMATCHING THERE WAS A PARTIAL MATCH REQUESTED          
*        SO WE SHOULD SKIP THE MATCHING CRITERIA IN REMPART                     
*        AND LET THE REMATCH GO THROUGH                                         
*---------------------------------------------------------------------          
*                                                                               
CHKPART  NTR1                                                                   
         LA    RF,MISLIST                                                       
CP10     CLI   0(RF),C' '          EOL                                          
         BNH   CPXNO                                                            
         CLC   REMPART,0(RF)                                                    
         BE    CPXYES                                                           
         LA    RF,1(RF)                                                         
         B     CP10                                                             
*                                                                               
CPXYES   SR    RC,RC               YES MEANS SKIP THIS MATCH CRITERIA           
CPXNO    LTR   RC,RC                                                            
CPX      B     MMEXT                                                            
         EJECT                                                                  
*---------------------------------------------------------------------          
*        REMATCH LOGIC                                                          
*---------------------------------------------------------------------          
*                                                                               
RMTCH    NTR1                                                                   
*                                                                               
         MVI   RMSW,0                                                           
         L     R8,AFINV                                                         
         LH    R4,IELMLEN                                                       
         L     R5,ALINV                                                         
*                                  FIND INV FOR BUY TO BE UNMATCHED             
RM2      CLC   7(3,R3),IBY                                                      
         BE    RM4                 HAVE INV                                     
RM3      BXLE  R8,R4,RM2                                                        
         B     RMEXT                                                            
RM4      MVI   OLDMFLD,X'FF'                                                    
         L     R7,AFBY                                                          
RM5      C     R7,ALBY                                                          
         BH    RM6A                                                             
         MVI   RMCALL,C'Y'         SET IS REMATCH CALL                          
         BAS   RE,MATCH                                                         
         TM    MSW,X'C0'                                                        
         BM    RM7                                                              
RM6      LA    R7,BYELEML(R7)                                                   
         B     RM5                                                              
RM6A     CLI   OLDMFLD,X'FF'                                                    
         BE    RM3                 GET NEW INV                                  
*                                  ACTUAL REMATCH                               
         SR    R7,R7                                                            
         ICM   R7,7,OLDMBY                                                      
         A     R7,AFBY                                                          
         BCTR  R7,R0                                                            
         LLC   R0,BYUNACH                                                       
         BCTR  R0,R0                                                            
         STC   R0,BYUNACH          POST NEW UNACHEIVED COUNTER                  
         TM    BYSTAT,X'08'        TEST ORBIT SLAVE                             
         BZ    RM6B                                                             
         BAS   RE,MORB             FIND ORBIT MASTER                            
         L     RF,AMORB                                                         
         LA    RF,BYUNACH-BYELEM(RF)                                            
         IC    RE,0(RF)                                                         
         BCTR  RE,R0                                                            
         STC   RE,0(RF)            POST NEW UNACHIEVED COUNTER                  
*                                                                               
RM6B     DS    0H                                                               
         MVC   IBY,OLDMBY          SET NEW BUY REFERENCE                        
         OI    RMSW,X'80'                                                       
         B     RMEXT                                                            
*                                  KEEP BEST MFLD                               
RM7      CLC   OLDMFLD,MFLD                                                     
         BNH   RM6                                                              
         MVC   OLDMFLD,MFLD                                                     
         B     RM6                                                              
RMEXT    B     MMEXT                                                            
         EJECT                                                                  
*---------------------------------------------------------------------          
*        MTCH FILM CODES                                                        
*---------------------------------------------------------------------          
*                                                                               
MMFFILM1 DS    0H                  FIRST FILM MATCH                             
         TM    ISTAT2,X'02'        TEST TO IGNORE FILM ERRORS                   
         BNZ   MMFFYES                                                          
         LA    R3,BYFILM                                                        
         LA    R4,IFILM                                                         
         B     MMFFILM                                                          
*                                                                               
MMFFILM2 DS    0H                  2ND FILM MATCH                               
         TM    ISTAT2,X'02'        TEST TO IGNORE FILM ERRORS                   
         BNZ   MMFFYES                                                          
         LA    R3,BYFILM2                                                       
         LA    R4,IFILM2                                                        
*                                                                               
MMFFILM  DS    0H                                                               
         CLI   TRAFMBF,C'B'        TEST BUY SIDE REQUIRED                       
         BNE   MMFF2                                                            
         CLI   0(R4),0             IF HAVE INVOICE FILM                         
         BE    MMFF2                                                            
         OC    0(2,R3),0(R3)       THEN MUST HAVE BUY SIDE                      
         BZ    MMFFNO                                                           
         B     MMFF3                                                            
*                                                                               
MMFF2    DS    0H                                                               
         OC    0(2,R3),0(R3)       IF NO FILM, OK                               
         BZR   RE                                                               
         CLI   0(R4),0             ELSE MUST HAVE 2ND                           
         BE    MMFFNO                                                           
*                                                                               
MMFF3    DS    0H                                                               
         LA    RF,WORK                                                          
         USING FLMTABD,RF                                                       
         MVC   FLMIDNO,IINVID        INVOICE ID/RSET                            
         MVC   FLMSEQ,0(R3)        CMML SEQ                                     
         MVC   FLMICOD,0(R4)       INTERNAL NO.                                 
         LR    R0,RE                                                            
         GOTO1 BINSRCH,FLMTPARS,FLMTABD                                         
         LR    RE,R0                                                            
         CLI   0(R1),1                                                          
         BE    MMFFNO              FILM NOT FOUND MEANS MISMATCH                
         ICM   RF,7,1(R1)                                                       
         BZ    MMFFNO                                                           
*                                                                               
MMFFYES  CR    RE,RE                                                            
         BR    RE                                                               
MMFFNO   LTR   RE,RE                                                            
         BR    RE                                                               
         DROP  RF                                                               
         EJECT                                                                  
*---------------------------------------------------------------------          
*        FIND ORBIT MASTER                                                      
*---------------------------------------------------------------------          
*                                                                               
MORB     NTR1                                                                   
         LR    R4,R7                                                            
         L     R7,AMORB            FIRST LOOK AT ONE I MIGHT HAVE               
         LTR   R7,R7                                                            
         BNZ   MORB6                                                            
MORB2    DS    0H                                                               
         XC    AMORB,AMORB                                                      
         L     R7,AFBY                                                          
MORB4    DS    0H                                                               
         C     R7,ALBY                                                          
         BNH   *+6                                                              
         DC    H'0'                                                             
MORB6    DS    0H                                                               
         TM    BYSTAT,X'10'        TEST ORB MAST                                
         BZ    MORB20                                                           
         CLC   BYEST(3),BYEST-BYELEM(R4)  EST-LIN                               
         BNE   MORB20                                                           
         CLC   BYORBNO,BYORBNO-BYELEM(R4)                                       
         BNE   MORB20                                                           
         CLC   BYSPT,BYSPT-BYELEM(R4)   SPOT NO.                                
         BNE   MORB20                                                           
*                                                                               
         ST    R7,AMORB            A(ORBIT MASTER)                              
         B     MORBX                                                            
*                                                                               
MORB20   DS    0H                                                               
         C     R7,AMORB                                                         
         BE    MORB2                                                            
         LA    R7,BYELEML(R7)                                                   
         B     MORB4                                                            
MORBX    B     MMEXT                                                            
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*---------------------------------------------------------------------          
*        CHECK AND SET INVALID TIMES FOR COMML                                  
*---------------------------------------------------------------------          
*                                                                               
IB11E20  NTR1  BASE=*,LABEL=*                                                   
         USING FLMTABD,R6                                                       
         TM    ISTAT2,X'08'        ITIM CONVERTED TO MILITARY                   
         BO    IB11E21                                                          
         LA    R3,ITIM                                                          
         LA    R4,WORK                                                          
         BRAS  RE,FMTTIM           SETS MILITARY TIME IN DUB                    
         B     *+10                                                             
IB11E21  MVC   DUB,ITIM            SET TIME IN DUB                              
*                                                                               
         MVC   BRDSTIM,=H'500'     BROADCAST START TIME 5AM                     
         MVC   BRDETIM,=H'459'     BROADCAST END TIME 459AM                     
         CLI   CANADSW,C'Y'        CANADIAN?                                    
         BE    IB11E210            YES                                          
         CLC   BRDMON,=X'E77E'     I2 MOS BEFORE DEC/15?                        
         BL    *+16                YES - BROADCAST START TIME = 5AM             
         MVC   BRDSTIM,=H'300'     BROADCAST START TIME 3AM                     
         MVC   BRDETIM,=H'259'     BROADCAST END TIME 259AM                     
*                                                                               
IB11E210 CLC   FLMSTIME,FLMETIME   START TIME <= END TIME?                      
         BNH   IB11E22             YES - DOES NOT CROSS MIDNIGHT                
*                                                                               
* COMML TIMES - HANDLE PERIODS THAT CROSS MIDNIGHT (9P-2A)                      
*                                                                               
         TM    FLMSTAT,FLMSDLY     CHECK TIMES DAILY?                           
         BZ    IB11E21A            NO                                           
         CLC   DUB(2),FLMSTIME     INVOICE ON OR AFTER START TIME?              
         BNL   IB11E30             YES - VALID (COVERS 9P-MIDNIGHT)             
         CLC   DUB(2),FLMETIME     INVOICE ON OR BEFORE END TIME?               
         BNH   IB11E30             VALID (COVERS MIDNIGHT-2A)                   
         B     IB11E28             NO - INVALID!                                
*                                                                               
IB11E21A CLI   I2CPROF+6,C'Y'      COMML TIMES ARE BCAST DAY?                   
         BNE   IB11E21D            NO - CALENDAR TIMES                          
         CLC   IDAT,FLMRLSE        INVOICE DETAIL AIRED ON RELEASE DATE         
         BNE   IB11E21B            NO                                           
         CLC   DUB(2),=H'2400'     INV TIME = 12M?                              
         BE    IB11E30             YES - MIDNIGHT ALWAYS MATCHES                
         CLC   DUB(2),BRDETIM      INV TIME IS BETWEEN 12:01AM-2/4:59AM         
         BNH   IB11E30             YES - ALWAYS MATCHES                         
         CLC   DUB(2),FLMSTIME     INV TIME BEFORE CMML START?                  
         BL    IB11E28             YES - ERROR                                  
*                                                                               
IB11E21B CLC   IDAT,FLMRCL         INVOICE DETAIL AIRED ON RECALL DATE          
         BNE   IB11E30             NO                                           
         CLC   FLMETIME,BRDSTIM    FILM END TIME FROM 12:01AM-2/4:59AM?         
         BNL   IB11E21C            NO                                           
         CLC   DUB(2),BRDSTIM      INV TIME BEFORE 3/5AM?                       
         BNL   IB11E30             NO - 3/5AM-12M IS VALID                      
         CLC   DUB(2),FLMETIME     INV TIME AFTER CMML END?                     
         BH    IB11E28             YES - INVALID!                               
         B     IB11E30             VALID                                        
*                                                                               
IB11E21C CLC   DUB(2),BRDSTIM      INV TIME BEFORE 3/5AM?                       
         BL    IB11E28             YES - INVALID                                
         CLC   DUB(2),FLMETIME     INV TIME AFTER CMML END?                     
         BH    IB11E28             YES - INVALID!                               
         B     IB11E30             VALID                                        
*                                                                               
IB11E21D CLC   IDAT,FLMRLSE        INVOICE DETAIL AIRED ON RELEASE DATE         
         BNE   *+14                NO                                           
         CLC   DUB(2),FLMSTIME     INV TIME BEFORE CMML START?                  
         BL    IB11E28             YES - INVALID!                               
         CLC   IDAT,FLMRCL         INVOICE DETAIL AIRED ON RECALL DATE          
         BNE   IB11E30             NO                                           
         CLC   DUB(2),FLMETIME     INV TIME AFTER CMML END?                     
         BH    IB11E28             YES - INVALID!                               
         B     IB11E30             VALID                                        
*                                                                               
* COMML TIMES - HANDLE PERIODS THAT DO NOT CROSS MIDNIGHT (9A-3P)               
*                                                                               
IB11E22  TM    FLMSTAT,FLMSDLY     CHECK TIMES DAILY                            
         BO    IB11E24                                                          
         CLC   IDAT,FLMRLSE        INVOICE DETAIL AIRED ON RELEASE DATE         
         BNE   IB11E26                                                          
         CLI   I2CPROF+6,C'Y'      COMML TIMES ARE BCAST DAY?                   
         BNE   IB11E24             NO - CALENDAR TIMES                          
         CLC   DUB(2),BRDETIM      INV TIME IS BETWEEN 12:01AM-2/4:59AM         
         BH    IB11E24             NO                                           
         CLC   FLMSTIME,BRDETIM    CML START TIME BEFORE 3/5AM?                 
         BH    IB11E30             NO - INV TIME IS VALID                       
IB11E24  CLC   DUB(2),FLMSTIME     CHECK START TIME                             
         BL    IB11E28                                                          
*                                                                               
IB11E26  TM    FLMSTAT,FLMSDLY     CHECK TIMES DAILY                            
         BO    IB11E27                                                          
         CLC   IDAT,FLMRCL         INVOICE DETAIL AIRED ON RECALL DATE          
         BNE   IB11E30                                                          
         CLI   I2CPROF+6,C'Y'      COMML TIMES ARE BCAST DAY?                   
         BNE   IB11E27             NO - CALENDAR TIMES                          
         OC    FLMSTIME,FLMSTIME   HAVE A START TIME?                           
         BNZ   *+14                YES                                          
         CLC   FLMETIME,=X'FFFF'   ANY FILM END TIME                            
         BE    IB11E30             NO - NO FILM TIMES IS VALID                  
         CLC   FLMETIME,BRDSTIM    FILM END TIME FROM 12:01AM-2/4:59AM?         
         BNL   IB11E26A            NO                                           
         CLC   DUB(2),BRDSTIM      INV TIME BEFORE 3/5AM?                       
         BNL   IB11E30             NO - 3/5AM-12M IS VALID                      
         B     IB11E27             TEST END TIME                                
*                                                                               
IB11E26A CLC   DUB(2),BRDSTIM      INV TIME BEFORE 3/5AM?                       
         BL    IB11E28             YES - INVALID                                
*                                                                               
IB11E27  CLC   DUB(2),FLMETIME     CHECK END TIME                               
         BNH   *+8                                                              
IB11E28  OI    ISTAT3,IST3TIMF     INVALID FILM FOR TIME                        
*                                                                               
IB11E30  J     EXIT                EXIT                                         
         DROP  R6                                                               
         LTORG                                                                  
*---------------------------------------------------------------------          
*        CHKINT - DO INTERVAL CHECKING                                          
*---------------------------------------------------------------------          
*                                                                               
CHKINT   NTR1  BASE=*,LABEL=*                                                   
         CLC   AFINV,ALINV         TEST ANY INVOICES                            
         BNL   CKIX                                                             
         MVI   CKSORTSW,0          SORT MAY HAVE TO BE RE-DONE                  
*                                  FOR DEFFERED SPOT DATE CHANGE                
         XC    CILASTS,CILASTS                                                  
*                                  PREPARE FOR SORT                             
         LH    R4,IELMLEN                                                       
         L     R1,ALINV                                                         
         S     R1,AFINV                                                         
         LA    R1,1(R1)                                                         
         SR    R0,R0                                                            
         DR    R0,R4               R1= NO OF ITEMS                              
         ST    R1,DMCB+4                                                        
         CLI   INTCOPT,C'N'        TEST REALLY DOING INTERVAL CHECKING          
         BE    CKI40               NO                                           
         MVI   BYTE,0                                                           
         CLI   INTCOPT,C'B'        IF CHECKING WITHIN BRAND                     
         BNE   CKI3                                                             
*                                  SORT BY PRD/NET/DATE/TIME                    
         LA    R3,IPRD-IELEM                                                    
*        LA    R2,8                                                             
         LA    R2,ILEN-IPRD+L'ILEN      MAKE THIS SOFT!!                        
         B     CKI3G                                                            
*                                                                               
CKI3     DS    0H                                                               
         TM    CBLHOPT,CBLHNHAQ   IF CBH REQ AND NEW MODE                       
         BNO   CKI3B              AND 'ALL NETS'                                
         LA    R3,ICBLNET-IELEM                                                 
         LA    R2,6                                                             
         B     CKI3G                                                            
*                                                                               
CKI3B    DS    0H                                                               
         MVI   CKSORTSW,1          THIS SORT SHOULD BE OK                       
*                                  FOR DEFERRED SPOT DATE CHANGE TEST           
         L     RF,AINOLST                                                       
         AH    RF,INOLSTQ                                                       
         CLI   0(RF),C' '          IF MULTIPLE INVOICES                         
         BNH   CKI4                                                             
         LA    R3,IDAT-IELEM                                                    
         LA    R2,5                                                             
*                                                                               
CKI3G    DS    0H                                                               
         GOTO1 XSORT,DMCB,AFINV,,(R4),(R2),(R3)                                 
         CLI   COSTSUP,C'A'        IS IT SUPPRESSED?                            
         BE    CKI40                                                            
*                                                                               
CKI4     DS    0H                  SET PRIMARY AND SECNDRY INTERVALS            
         MVC   CIPINT,=H'0'        USE XERO                                     
         SR    RF,RF               IF NOT GIVEN                                 
         ICM   RF,1,INTCPI                                                      
         BZ    *+8                                                              
         STH   RF,CIPINT                                                        
*                                                                               
         MVC   CISINT,=H'0'        SECONDARY                                    
         SR    RF,RF                                                            
         ICM   RF,1,INTCSI                                                      
         BZ    *+8                                                              
         STH   RF,CISINT                                                        
*                                                                               
         L     R8,AFINV                                                         
         BAS   RE,ADDVAL           ADDED VALUE INVOICE?                         
         BNE   CKI33               YES - IGNORE!                                
         B     CKI30                                                            
*                                                                               
CKI5     DS    0H                                                               
         C     R8,ALINV                                                         
         BNL   CKI40                                                            
*                                                                               
         BAS   RE,ADDVAL           ADDED VALUE INVOICE?                         
         BNE   CKI33               YES - IGNORE!                                
*                                                                               
         CLI   INTCOPT,C'B'        IF WITHIN BRAND                              
         BNE   CKI6                                                             
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BE    CKI5A               YES - CHECK AGAINST 3 CHAR PRD               
*                                                                               
         CLC   IPRD,CILPRD         TEST BRAND BREAK                             
         B     *+10                NEW PRD- SET LAST VALUES                     
CKI5A    CLC   IPRDNT,CILNTPRD     TEST BRAND BREAK                             
         BNE   CKI30               NEW PRD- SET LAST VALUES                     
*                                                                               
CKI6     DS    0H                                                               
         CLC   ICBLNET,CILNET      TEST CBL NET BREAK                           
         BNE   CKI30               NEW ONE, SET LAST VALUES                     
         CLC   IDAT(3),CILDAT      TEST NEW DATE                                
         BE    CKI7                                                             
*                                                                               
         CLI   BYTE,C'D'           ALREADY SUBTRACTED                           
         BE    CKI7                                                             
         LH    RF,CILTIM                                                        
         SHI   RF,1440             SUBTRACT 24 HRS                              
         STH   RF,CILTIM           TO HANDLE 6AM STRADDLE                       
         MVI   BYTE,C'D'                                                        
*                                                                               
CKI7     DS    0H                                                               
         SR    RF,RF               GET TIME INTERVAL                            
         ICM   RF,3,ITIM                                                        
         SH    RF,CILTIM                                                        
*                                                                               
         CH    RF,CIPINT           TEST VS PRIMARY                              
         BH    CKI8                                                             
         OC    CIPINT,CIPINT                                                    
         BZ    CKI8                                                             
*                                                                               
         TM    ISTAT,X'20'         WITHIN LIMIT, TEST OK TO ACCEPT              
         BNZ   CKI32               YES                                          
         BAS   RE,CKIDAY           DAY CHECK                                    
         BE    CKI8                OK TO ACCEPT                                 
*                                                                               
         OI    ISTAT2,X'40'        ELSE- SET PRIMARY FLAG                       
         OC    CISINT,CISINT       SEC SEP=0?                                   
         BZ    CKI7A               YES - DON'T CHECK SEC SEP                    
         CH    RF,CISINT           TEST VS SECONDARY                            
         BH    *+12                (MAY BE ZERO)                                
         OI    ISTAT2,X'20'        SET SECONDARY FLAG                           
         MVI   SECSEPER,C'Y'       SET ERROR TO STOP AUTOPAY                    
*                                                                               
CKI7A    ST    R8,FULL             SAVE A(CURRENT IELEM)                        
*                                                                               
CKI7AA   SH    R8,IELMLEN          BACK UP TO PREV INV                          
         C     R8,AFINV            BEFORE FIRST INVOICE?                        
         BNL   *+6                 NO                                           
         DC    H'0'                YES - SOMETHING IS WRONG                     
         BAS   RE,ADDVAL           ADDED VALUE INVOICE?                         
         BNE   CKI7AA              YES - IGNORE!                                
         OI    ISTAT2,X'80'        SET FIRST OF ILLEGAL SET                     
         L     R8,FULL             RESTORE A(CURRENT IELEM)                     
         B     CKI32               DO NOT SET LAST TIME FROM BAD SPOT           
*                                                                               
CKI8     DS    0H                                                               
         CH    RF,CISINT           TEST VS SECONDARY                            
         BH    CKI30                                                            
         OC    CISINT,CISINT                                                    
         BZ    CKI30                                                            
         BAS   RE,CKIDAY           DAY CHECK                                    
         BE    CKI30               OK TO ACCEPT                                 
         OI    ISTAT2,X'20'        SET SECONDARY FLAG                           
         MVI   SECSEPER,C'Y'       SET ERROR TO STOP AUTOPAY                    
*                                                                               
CKI30    DS    0H                  SET LASTS                                    
         TM    ISTAT,X'20'         WITHIN LIMIT, TEST OK TO ACCEPT              
         BNZ   CKI32               YES                                          
         MVC   CILDAT(3),IDAT                                                   
         MVC   CILTIM,ITIM                                                      
         MVI   BYTE,0                                                           
CKI32    DS    0H                                                               
         MVC   CILPRD,IPRD                                                      
         MVC   CILNTPRD,IPRDNT                                                  
         MVC   CILNET,ICBLNET                                                   
*                                                                               
CKI33    AH    R8,IELMLEN                                                       
         B     CKI5                                                             
*                                                                               
CKI40    CLI   CKSORTSW,1          TEST SORT OK FOR DEFERRED SPOT               
         BE    CKI42               DATE CHANGE CODE - YES, DONE                 
         CLI   DEFDCHG,C'Y'        ARE WE DOING DEFERRAL DATE CHG?              
         BNE   CKI42               NO, OK                                       
         L     RF,AINOLST          A(INVOICE LIST)                              
         AH    RF,INOLSTQ          ELSE IF MULTIPLE INVOICES MUST               
         CLI   0(RF),C' '          SORT TO GET INV ITEMS IN                     
         BNH   CKI42               DATE/TIME ORDER                              
*                                                                               
         LH    R4,IELMLEN                                                       
         L     R1,ALINV                                                         
         S     R1,AFINV                                                         
         LA    R1,1(R1)                                                         
         SR    R0,R0                                                            
         DR    R0,R4               R1= NO OF ITEMS                              
         ST    R1,DMCB+4                                                        
         LA    R3,IDAT-IELEM                                                    
         LA    R2,5                                                             
*                                                                               
         GOTO1 XSORT,DMCB,AFINV,,(R4),(R2),(R3)                                 
*                                                                               
CKI42    DS    0H                                                               
CKIX     J     EXIT                                                             
*                                                                               
ADDVAL   CLI   I2APROF+14,C'Y'     SEPARATE ADDED VALUE SECTION?                
         BNE   ADDYES              NO - OK TO SET SEP ERRORS                    
         OC    ICOST,ICOST         $0 INVOICE?                                  
         BNZ   ADDYES              NO - SET SEP ERRORS                          
         CLI   ILEN,5              5,7,10 CAN BE ADDED VALUE OR NOT             
         BE    ADDVAL10                                                         
         CLI   ILEN,7                                                           
         BE    ADDVAL10                                                         
         CLI   ILEN,10                                                          
         BL    ADDNO                                                            
         BH    ADDYES                                                           
ADDVAL10 CLI   I2APROF+15,C'Y'     5,7,10 ARE ADDED VALUE?                      
         BE    ADDNO               YES - DON'T FLAG SEP ERROS!                  
*                                                                               
ADDYES   CR    RE,RE                                                            
         BR    RE                                                               
*                                                                               
ADDNO    LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
*        CKIDAY - IF 2 SPOTS FALL WITHIN INTERVAL-                              
*        IF ON SAME DAY, REJECT                                                 
*        IF ONE DAY APART, REJECT (TIME ADJUSTMENT MADE ABOVE)                  
*        IF MORE THAT ONE DAY APART, ACCEPT                                     
*                                                                               
CKIDAY   NTR1                      DAY CHECK                                    
         CLC   IDAT,CILDAT         IF ON SAME DATE                              
         BE    CKIDNO              REJECT                                       
         OC    CILDAT,CILDAT       DO WE HAVE A SAVED DATE?                     
         BZ    CKIDYES             NO - 1ST INV SKIPPED INT CHECKING!           
*                                  ELSE ACCEPT, UNLESS EXACLTY                  
         GOTO1 DATCON,DMCB,(2,CILDAT),DUB   ONE DAY APART                       
         GOTO1 ADDAY,DMCB,DUB,DUB,1                                             
         GOTO1 DATCON,DMCB,DUB,(2,FULL)                                         
         CLC   FULL(2),IDAT                                                     
         BE    CKIDNO                                                           
*                                                                               
CKIDYES  CR    RE,RE               SET CC =                                     
         B     *+6                                                              
CKIDNO   LTR   RD,RD               SET CC NOT =                                 
         J     EXIT                                                             
*                                                                               
         DROP  R7,R8                                                            
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*---------------------------------------------------------------------          
*        DELETE AFFELEMS AND POST NEW ONES                                      
*---------------------------------------------------------------------          
         TITLE 'ICSPOST - DELETE AFFELEMS AND POST NEW ONES'                    
ICSPOST  NMOD1 0,ICSPOST                                                        
         SPACE 2                                                                
         LA    RC,SPACEND                                                       
         USING IMRWORK,RC                                                       
         USING BYELEMD,R6                                                       
         USING IELEMD,R7                                                        
         SPACE 3                                                                
*                                                                               
         MVI   KEY,0            DONT LEAVE KEY WITH A RANDOM VALUE              
*                               BECAUSE IT MAY GOVERN FILE SELECTION            
         CLI   ORBSW,0             TEST ANY ORBITS                              
         BE    PS9                 NO                                           
*                                  HAVE ORBITS -                                
*                                  - INVS ARE NOW LINKED TO ORBIT               
*                                     SLAVES -MUST BE LINKED TO MASTERS         
         SR    R5,R5                                                            
         L     R7,AFINV                                                         
         B     *+8                                                              
PS4      DS    0H                                                               
         AH    R7,IELMLEN                                                       
         C     R7,ALINV                                                         
         BNL   PS9                                                              
         OC    IBY,IBY                                                          
         BZ    PS4                 NOT MATCHER                                  
         SR    R6,R6                                                            
         ICM   R6,7,IBY                                                         
         A     R6,AFBY                                                          
         BCTR  R6,R0               POINT TO MATCHED BUY                         
         TM    BYSTAT,X'08'        TEST ORBIT SLAVE                             
         BZ    PS4                 NO                                           
*                                                                               
         LTR   R5,R5                                                            
         BZ    PS6                                                              
         BAS   RE,CHKMAST                                                       
         BNE   PS6                                                              
PS5      DS    0H                                                               
         LA    RF,1(R5)                                                         
         S     RF,AFBY                                                          
         STCM  RF,7,IBY            MARK INV MATCHED TO MASTER                   
         B     PS4                                                              
*                                                                               
*                                  SEARCH FOR MASTER                            
PS6      DS    0H                                                               
         L     R5,AFBY                                                          
         B     *+8                                                              
PS6B     DS    0H                                                               
         LA    R5,BYELEML(R5)                                                   
         C     R5,ALBY                                                          
         BL    *+6                                                              
         DC    H'0'                MASTER MUST BE THERE                         
         BAS   RE,CHKMAST                                                       
         BNE   PS6B                                                             
         B     PS5                                                              
*                                                                               
CHKMAST  DS    0H                                                               
         TM    BYSTAT-BYELEM(R5),X'10'                                          
         BNZ   *+8                                                              
         LTR   RE,RE               NOT A MASTER                                 
         BR    RE                                                               
         CLC   BYEST(3),BYEST-BYELEM(R5)                                        
         BNER  RE                                                               
         CLC   BYORBNO,BYORBNO-BYELEM(R5)                                       
         BNER  RE                                                               
         CLC   BYSPT,BYSPT-BYELEM(R5)                                           
         BR    RE                                                               
*                                                                               
PS9      DS    0H                                                               
*                                  INITIALIZE ADDPARS                           
         XC    ADDPARS,ADDPARS                                                  
         USING AFFELEM,R8                                                       
         MVC   ADDPAR1,ADBUY                                                    
         LA    R8,X                                                             
         ST    R8,ADDPAR2                                                       
         L     R2,BUYRPARS+4                                                    
         L     R1,BUYRPARS+8                                                    
         USING BUYRTABD,R2                                                      
         LTR   R1,R1                                                            
         BZ    PSEXT               NO BUYS                                      
         MH    R1,BUYRPARS+14      NO. TIMES LENGTH                             
         A     R1,BUYRPARS+4       PLUS START                                   
         ST    R1,BUYRTX           SET END OF TABLE                             
*                                                                               
         XC    AFFELEM(6),AFFELEM                                               
         MVI   ACODE,X'10'                                                      
         MVI   FLMELEM,0                                                        
         MVI   FLMCODE,X'12'                                                    
         XC    RESPEL(6),RESPEL                                                 
         MVI   RESPCOD,X'17'                                                    
         LA    R0,AFFELEM                                                       
         ST    R0,ADDPAR2                                                       
         B     PNXTREC2                                                         
*                                                                               
PNXTREC  EQU   *                                                                
         LA    R2,BUYRTBEL(R2)                                                  
         C     R2,BUYRTX                                                        
         BNL   PSEXT                                                            
*                                                                               
PNXTREC2 DS    0H                                                               
         L     RE,ADBUY            CLEAR IO                                     
         LA    RF,4000                                                          
         XCEF                                                                   
*                                                                               
         MVC   KEY+14(4),BUYRDA                                                 
         MVC   AREC,ADBUY                                                       
         GOTO1 GET                                                              
*                                                                               
         L     R5,ADBUY                                                         
         USING BUYREC,R5                                                        
         TM    BDSTAT,X'80'        IF RADIO NPW STYLE POL                       
         BNZ   PNXTREC             SKIP POSTING                                 
         MVI   BYTE3,0             CLEAR REC ALTERED SW                         
*                                                                               
         GOTO1 =A(PDTF)            RESTORE OOW DEFERRAL DATES                   
*                                  FIND BUYS FOR THIS EST-LIN                   
         L     R6,AFBY                                                          
PS10     C     R6,ALBY                                                          
         BNL   PS50                DONE WITH RECORD                             
         TM    BYSTAT2,BYSTMISQ    SKIP ALL MISSED SPOTS                        
         BNZ   PS11                                                             
         CLI   BYPRD,X'FF'                                                      
         BE    PS11                BYPASS UNALLOCATED SPOTS                     
         CLC   BYPRDNT,=C'POL'                                                  
         BE    PS11                                                             
         TM    BYSTAT,X'08'        SKIP ORBIT SLAVES                            
         BNZ   PS11                                                             
         MVC   FULL(3),BUYKEY+9                                                 
         TM    BUYRCNTL,BUYRLN2    2-BYTE BUYLINE?                              
         BNZ   *+14                YES                                          
         MVI   FULL+1,0            CONVERT 1-BYTE TO 2-BYTE                     
         MVC   FULL+2(1),BUYKBUY                                                
         CLC   FULL(3),BYEST                                                    
         BNE   PS11                                                             
         TM    CBLHOPT,CBLHNHQ     IF CBH REQ AND NEW MODE                      
         BNO   PS12                                                             
         MVC   BYTE,BUYKEY+8       MUST BE RIGHT NET                            
         NI    BYTE,X'7F'          7 BITS ONLY                                  
         CLC   BYTE,BYCBLNET                                                    
         BE    PS12                                                             
PS11     LA    R6,BYELEML(R6)                                                   
         B     PS10                                                             
PS12     LA    R0,1(R6)                                                         
         S     R0,AFBY                                                          
         ST    R0,FULL             FULL = RELATIVE ADDRESS OF BUY               
         MVC   ADDPAR4(2),BYSDT    DATE                                         
         MVI   ADDPAR3+1,0         SPOT REF. NO.                                
         MVI   ALEN,0              CLEAR LENGTH                                 
         SPACE 2                                                                
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         IC    R0,BYUNACH                                                       
         IC    R1,BYNOWK                                                        
         SR    R1,R0                                                            
         STC   R1,BYTE2            BYTE2 = MATCHED SPOTS FOR THIS BUY           
         BNZ   PS13                GET INVOICES                                 
*                                  NO MATCHED SPOTS                             
         CLI   BUYKEY+3,X'FF'                                                   
         BE    PS18                                                             
         B     PS21B                                                            
*                                                                               
*        FIND INVOICES FOR THIS BUY                                             
*                                                                               
PS13     L     R7,AFINV                                                         
PS14     C     R7,ALINV                                                         
         BL    *+6                                                              
         DC    H'0'                END OF INVOICES SHOULD NOT OCCUR             
         CLC   FULL+1(3),IBY       IS MATCHING INVOICE                          
         BE    PS16                                                             
PS15     AH    R7,IELMLEN                                                       
         B     PS14                                                             
PS16     MVC   ATIME,ITIM                                                       
         MVC   ADATE,IDAT          DATE                                         
         CLI   PSEUDOPT,C'N'       IF PSEUDO/RESP                               
         BE    *+8                                                              
         OI    ATIME,X'40'         SAY SO IN STATUS BITS                        
         MVI   ALEN,6                                                           
         CLI   PSTOPT,C'P'         POST PARTIAL                                 
         BE    PS16B               YES                                          
         CLI   IMIS,0              IS THIS A PARTIAL                            
         BE    PS16B               NO                                           
         MVI   ALEN,0              DELETE AFFID                                 
PS16B    DS    0H                                                               
         CLI   BUYKEY+3,X'FF'                                                   
         BE    PS18                                                             
PS17     IC    R1,ADDPAR3+1        NON-POOL - BUMP REF. NO.                     
         LA    R1,1(R1)                                                         
         STC   R1,ADDPAR3+1                                                     
         B     PS20                                                             
*                                  FOR POOL BYSPT = REF. NO.                    
PS18     MVC   ADDPAR3+1(1),BYSPT                                               
PS20     GOTO1 AADDEL,ADDPARS                                                   
*                                                                               
         CLI   ADDPARS,0           TEST REC ALTERED                             
         BE    *+8                 NO                                           
         MVI   BYTE3,X'FF'                                                      
         CLI   ADDPAR3+3,0                                                      
         BE    PS21A                                                            
         BAS   RE,PRTMSG           PRINT BUY ERROR/OVERFLOW MESSAGE             
         B     PNXTREC                                                          
*                                                                               
PS21A    DS    0H                                                               
         CLI   TRAFPOST,C'Y'       OPT TO POST FILMS                            
         BNE   PS21A8                                                           
         CLI   BUYKEY+3,X'FF'      NO FILM POSTING FOR NON-POL                  
         BNE   PS21A8                                                           
*                                                                               
         LA    R0,FLMELEM          POINT TO FILM ELEM                           
         ST    R0,ADDPAR2                                                       
         MVI   FLMLEN,0            NO FILM ELEM                                 
         XC    FLMNUM(4),FLMNUM    CLEAR FILM CODES                             
         CLI   ALEN,0              IF NO AFFID                                  
         BE    PS21A4                                                           
         CLI   IFILM,0             OR NO FILM CODE                              
         BE    PS21A4                                                           
         LA    R3,IFILM                                                         
         LA    R4,FLMNUM                                                        
         BAS   RE,PSFFILM                                                       
         OC    FLMNUM,FLMNUM       IF EITHER FILM UNDEFINED                     
         BZ    PS21A4              DONT POST                                    
         MVI   FLMLEN,5            ONE FILM                                     
         CLI   IFILM2,0                                                         
         BE    PS21A4                                                           
         LA    R3,IFILM2                                                        
         LA    R4,FLMNUM+2                                                      
         BAS   RE,PSFFILM                                                       
         OC    FLMNUM+2(L'FLMNUM),FLMNUM+2  IF EITHER FILM UNDEFINED            
         BZ    PS21A4              DONT POST                                    
         MVI   FLMLEN,7            TWO FILMS                                    
*                                                                               
PS21A4   DS    0H                                                               
         GOTO1 AADDEL,ADDPARS                                                   
*                                                                               
         CLI   ADDPARS,0           TEST REC ALTERED                             
         BE    *+8                 NO                                           
         MVI   BYTE3,X'FF'                                                      
         CLI   ADDPAR3+3,0                                                      
         BE    PS21A6                                                           
         BAS   RE,PRTMSG           PRINT BUY ERROR/OVERFLOW MSG                 
         B     PNXTREC                                                          
*                                                                               
PS21A6   DS    0H                                                               
         LA    R0,AFFELEM          RESTORE TO AFFELEM                           
         ST    R0,ADDPAR2                                                       
*                                                                               
PS21A8   DS    0H                                                               
*                                                                               
PSRES    DS    0H                  RESPONSE COUNT CODE                          
         CLI   PSEUDOPT,C'R'       ONLY IF RESPONSE REQ                         
         BNE   PS21A9                                                           
         CLI   BUYKEY+3,X'FF'      ONLY FOR POOL                                
         BC    0,PS21A9            **TEMP NOOP**                                
*                                                                               
         LA    R0,RESPEL           POINT TO RESPONSE ELEM                       
         ST    R0,ADDPAR2                                                       
         MVI   RESPLEN,0           NO ELEM                                      
         XC    RESPDPT(4),RESPDPT  CLEAR ELEM                                   
         CLI   ALEN,0              IF NO AFFID                                  
         BE    PSRES4                                                           
         OC    ICOST,ICOST         OR NO RESPONSE COUNT                         
         BZ    PSRES4                                                           
         MVC   RESPNUM,ICOST+2     SET RESP COUNT                               
         MVI   RESPLEN,6           ELEM LENGTH                                  
*                                                                               
PSRES4   DS    0H                                                               
         GOTO1 AADDEL,ADDPARS                                                   
*                                                                               
         CLI   ADDPARS,0           TEST REC ALTERED                             
         BE    *+8                 NO                                           
         MVI   BYTE3,X'FF'                                                      
         CLI   ADDPAR3+3,0                                                      
         BE    PSRES6                                                           
         BAS   RE,PRTMSG           PRINT BUY ERROR/OVERFLOW MSG                 
         B     PNXTREC                                                          
*                                                                               
PSRES6   DS    0H                                                               
         LA    R0,AFFELEM          RESTORE TO AFFELEM                           
         ST    R0,ADDPAR2                                                       
*                                                                               
PS21A9   DS    0H                                                               
         CLI   BUYKEY+3,X'FF'                                                   
         BE    PS11                IF POOL, DONE - GO GET ANOTHER BUY           
         CLC   ADDPAR3+1(1),BYTE2  ARE ALL INVOICES FOUND                       
         BL    PS15                GET ANOTHER INVOICE                          
*                                                                               
*        DELETE ANY REMAINING AFFELEMS                                          
*                                                                               
PS21B    CLI   BYUNACH,0                                                        
         BE    PS11                NONE                                         
         IC    R1,ADDPAR3+1        SET REF. NO. 1 PAST                          
         LA    R1,1(R1)            LAST ELEM I ADDED                            
         STC   R1,ADDPAR3+1        AND LEAVE IT THERE                           
         LLC   R0,BYUNACH                                                       
         MVI   ALEN,0              SET LENGTH TO ZERO                           
         MVI   FLMLEN,0                                                         
         MVI   RESPLEN,0                                                        
*                                                                               
PS22     GOTO1 AADDEL,ADDPARS                                                   
*                                                                               
         CLI   ADDPARS,0           TEST REC ALTERED                             
         BE    *+8                 NO                                           
         MVI   BYTE3,X'FF'                                                      
         CLI   ADDPAR3+3,0                                                      
         BE    *+12                                                             
         BAS   RE,PRTMSG           ADDEL ERROR                                  
         B     PNXTREC                                                          
*                                                                               
         CLI   TRAFPOST,C'Y'       OPT TO POST FILMS                            
         BNE   PS23                                                             
         CLI   BUYKEY+3,X'FF'      NO FILM POSTING FOR NON-POL                  
         BNE   PS23                                                             
*                                                                               
         LA    R4,FLMELEM          POINT TO FILM ELEM                           
         ST    R4,ADDPAR2                                                       
*                                                                               
         GOTO1 AADDEL,ADDPARS                                                   
*                                                                               
         CLI   ADDPARS,0           TEST REC ALTERED                             
         BE    *+8                 NO                                           
         MVI   BYTE3,X'FF'                                                      
         CLI   ADDPAR3+3,0                                                      
         BE    *+12                                                             
         BAS   RE,PRTMSG           ADDEL ERROR                                  
         B     PNXTREC                                                          
*                                                                               
         LA    R4,AFFELEM          RESTORE TO AFFELEM                           
         ST    R4,ADDPAR2                                                       
*                                                                               
PS23     DS    0H                                                               
         CLI   PSEUDOPT,C'R'       RESPONSE COUNT REQ?                          
         BNE   PS24                                                             
         CLI   BUYKEY+3,X'FF'      ONLY IF POOL                                 
         BC    0,PS24              ***TEMP NOOP                                 
*                                                                               
         LA    R4,RESPEL           POINT TO RESP ELEM                           
         ST    R4,ADDPAR2                                                       
*                                                                               
         GOTO1 AADDEL,ADDPARS                                                   
*                                                                               
         CLI   ADDPARS,0           TEST REC ALTERED                             
         BE    *+8                 NO                                           
         MVI   BYTE3,X'FF'                                                      
         CLI   ADDPAR3+3,0                                                      
         BE    *+12                                                             
         BAS   RE,PRTMSG           PRINT BUY ERROR/OVERFLOW MSG                 
         B     PNXTREC                                                          
*                                                                               
         LA    R4,AFFELEM          RESTORE TO AFFELEM                           
         ST    R4,ADDPAR2                                                       
*                                                                               
PS24     BCT   R0,PS22                                                          
         B     PS11                GET ANOTHER BUY                              
PS50     EQU   *                                                                
         CLI   BYTE3,X'FF'         TEST REC ALTERED                             
         BNE   PNXTREC                                                          
***      CLI   RCWRITE,C'Y'                                                     
***      BNE   PNXTREC                                                          
         XC    DMCB,DMCB                                                        
         EJECT                                                                  
*--------------------------------------------------------------------           
*        SPOT DATE CHANGE CODE FOR WESTERN OOW'S                                
*--------------------------------------------------------------------           
*                                                                               
         CLI   DEFDCHG,C'Y'        SET SPOT DATE=AFF DATE FOR OOW'S?            
         BNE   PS54                                                             
         CLI   BUYKEY+3,X'FF'      POL BUYS ONLY                                
         BNE   PS54                                                             
*                                                                               
         LA    R3,BDELEM                                                        
         USING REGELEM,R3                                                       
*                                                                               
PS52B    DS    0H                                                               
         CLI   0(R3),0             EOR                                          
         BE    PS54                                                             
         CLI   0(R3),11            FIND SPOT ELEMS                              
         BL    PS53                                                             
         CLI   0(R3),15                                                         
         BH    PS53                                                             
*                                                                               
         CLC   RDATE,PREVWKP       IN LAST WEEK OF PREV MONTH                   
         BL    PS53                                                             
         CLC   RDATE,BRDMON                                                     
         BNL   PS53                                                             
*                                                                               
         LR    RF,R3                                                            
*                                                                               
PS52D    DS    0H                                                               
         LLC   R1,1(RF)            FIND AFFID ELEM IF ANY                       
         AR    RF,R1                                                            
         CLI   0(RF),16            IF NEXT ELEM ISN'T AFFID                     
         BH    PS53                THERE ISN'T ONE                              
         BL    PS53                                                             
*                                                                               
         CLC   ADATE-AFFELEM(2,RF),BRDMON  MUST BE IN CURRENT MONTH             
         BL    PS53                                                             
         MVC   RDATE,ADATE-AFFELEM(RF)  SET SPOT DATE=AFF DATE                  
         ST    R3,SVSPELM                                                       
         BAS   RE,PSQF             MAKE SURE ELEM ENDS UP IN SEQ                
         B     PS52B                                                            
*                                                                               
PS53     DS    0H                                                               
         LLC   RF,1(R3)            NEXT ELEM                                    
         AR    R3,RF                                                            
         BNE   PS52B                                                            
         DROP  R3                                                               
*                                                                               
PS54     DS    0H                                                               
         CLI   RCWRITE,C'Y'                                                     
         BNE   PNXTREC                                                          
         GOTO1 PUT                                                              
*                                                                               
         B     PNXTREC                                                          
         SPACE 2                                                                
PSEXT    DS    0H                                                               
         J     EXIT                                                             
         EJECT                                                                  
**********************************************************************          
*        PSQF- ELEM SEQUENCE FIX FOR OUT-OF-WEEK DATE CHANGING                  
**********************************************************************          
*                                                                               
PSQF     NTR1                                                                   
         L     R3,SVSPELM          A(SPOT ELEM)                                 
         B     PSQF16                                                           
*                                                                               
PSQF02   DS    0H                                                               
         CLI   0(R3),0             EOR                                          
         BE    PSQF44                                                           
         CLI   0(R3),X'1F'         ELEM AFTER ALL BUYS                          
         BH    PSQF44                                                           
         CLI   0(R3),X'0B'         SPOT ELEMS                                   
         BL    PSQF16                                                           
         CLI   0(R3),X'0F'                                                      
         BH    PSQF16                                                           
*                                                                               
         CLC   RDATE,SVAFFDT       TEST ELEM DATE VS SAVED AFFID                
         BH    PSQF44              IF HIGH, HAVE NEW INSERT POINT               
         BE    PSQF44              ALSO IF EQUAL                                
*                                  IF LOW NEXT ELEM                             
PSQF16   DS    0H                                                               
         LLC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     PSQF02                                                           
*                                                                               
PSQF44   DS    0H                  HAVE NEW ELEM INSERT POINT                   
         L     RF,SVSPELM          A(ORIGINAL ELEM)                             
         MVC   X,0(RF)             SAVE ELEMS OUTSIDE OF REC                    
         LA    R4,X                                                             
*                                                                               
PSQF45   DS    0H                                                               
         GOTO1 RECUP,DMCB,BUYREC,(R4),(R3)    INSERT                            
*                                                                               
         LLC   R0,1(R3)            NEXT INSERT POINT                            
         AR    R3,R0                                                            
*                                                                               
         LLC   R0,1(R4)            NEXT ELEM                                    
         AR    R4,R0                                                            
*                                                                               
         CLI   0(R4),0             EOR                                          
         BE    PSQF50                                                           
         CLI   0(R4),X'10'         COPY SUBSIDIARY ELEMS                        
         BL    PSQF50                                                           
         CLI   0(R4),X'1F'                                                      
         BH    PSQF50                                                           
         B     PSQF45                                                           
*                                                                               
PSQF50   DS    0H                  NOW DELETE FROM ORIGINAL SPOT                
*                                                                               
         L     R4,SVSPELM          A(ORIGINAL ELEM)                             
*                                                                               
PSQF55   DS    0H                                                               
         GOTO1 RECUP,DMCB,BUYREC,(R4)      DELETE                               
*                                                                               
         CLI   0(R4),0             EOR                                          
         BE    PSQF60                                                           
         CLI   0(R4),X'10'         DELETE SUBSIDIARY ELEMS                      
         BL    PSQF60                                                           
         CLI   0(R4),X'1F'                                                      
         BH    PSQF60                                                           
         B     PSQF55                                                           
*                                                                               
PSQF60   DS    0H                                                               
*                                                                               
PSQFX    DS    0H                                                               
         J     EXIT                                                             
         EJECT                                                                  
*********************************************************************           
*        PSSFILM - FILM ELEM SET                                                
*********************************************************************           
*                                                                               
PSFFILM  DS    0H                                                               
         XC    0(2,R4),0(R4)       CLEAR OUTPUT                                 
         ICM   R0,15,FLMTPARS+8                                                 
         BZR   RE                  NO FILMS                                     
         L     RF,AFLMTAB                                                       
         USING FLMTABD,RF                                                       
*                                                                               
PSFF4    DS    0H                                                               
         CLC   FLMIDNO,IINVID      TST FROM RIGHT INVOICE/RSET                  
         BNE   PSFF10                                                           
         CLC   FLMICOD,0(R3)       INTERNAL FILM NO.                            
         BNE   PSFF10                                                           
*                                                                               
         MVC   0(2,R4),FLMSEQ      SET CMML SEQ                                 
         BR    RE                                                               
*                                                                               
PSFF10   DS    0H                                                               
         LA    RF,FLMTABEL(RF)                                                  
         BCT   R0,PSFF4                                                         
         BR    RE                                                               
         DROP  RF                                                               
         SPACE 3                                                                
*                                  PRINT ERROR/OVERFLOW ERROR                   
PRTMSG   NTR1                                                                   
*                                                                               
         MVC   HALF2,BUYKBUY                                                    
         TM    BUYRCNTL,BUYRLN2    2-BYTE BUYLINE?                              
         BNZ   *+14                YES                                          
         MVI   HALF2,0             CONVERT 1-BYTE TO 2-BYTE                     
         MVC   HALF2+1(1),BUYKBUY                                               
*                                                                               
         OI    UPDERROR,UPDERBIG  - SET FLAG FOR I2MM                           
         OC    ERRLINES(2),ERRLINES      - SAVE LINE NUMBERS FOR I2MM           
         BNZ   *+14                                                             
         MVC   ERRLINES(2),HALF2                                                
         B     PRTM0                                                            
         OC    ERRLINES+2(2),ERRLINES+2                                         
         BNZ   *+14                                                             
         MVC   ERRLINES+2(2),HALF2                                              
         B     PRTM0                                                            
         OC    ERRLINES+4(2),ERRLINES+4                                         
         BNZ   *+14                                                             
         MVC   ERRLINES+4(2),HALF2                                              
         B     PRTM0                                                            
*                                                                               
PRTM0    MVC   P(1),MED                                                         
         MVC   P+2(3),CLT                                                       
         MVC   P+6(3),PRD                                                       
         CLI   BUYKPRD,X'FF'                                                    
         BNE   *+10                                                             
         MVC   P+6(3),=C'POL'                                                   
         LLC   R0,BUYKEST                                                       
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+10(3),DUB                                                      
         GOTO1 MSUNPK,DMCB,(X'80',BUYMSTA),WORK,WORK+4                          
         CLI   WORK+4,C'0'          LOCAL CABLE                                 
         BL    *+8                                                              
         MVI   WORK+8,C'/'          NEEDS A /                                   
         MVC   P+15(8),WORK+4                                                   
         MVC   P+25(3),=C'LI='                                                  
         XR    R0,R0                                                            
         ICM   R0,3,HALF2          BUYLINE NUMBER !!                            
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+28(3),DUB                                                      
*                                                                               
         CLI   ADDPAR3+2,1         TEST RECORD OVERFLOW                         
         BNE   PRTM06                                                           
*                                                                               
         MVC   P+32(2),=C'**'                                                   
         MVC   P+35(L'OVFMSG1),OVFMSG1                                          
         MVC   P2+35(L'OVFMSG2),OVFMSG2                                         
         MVC   P3+35(L'OVFMSG3),OVFMSG3                                         
         MVC   P4+35(L'OVFMSG4),OVFMSG4                                         
         MVC   P5+35(L'OVFMSG5),OVFMSG5                                         
         MVC   P6+35(L'OVFMSG6),OVFMSG6                                         
         B     PRTM08                                                           
*                                                                               
PRTM06   DS    0H                  RECORD ERROR                                 
         MVC   P+32(2),=C'**'                                                   
         MVC   P+35(L'BERMSG1),BERMSG1                                          
         MVC   P2+35(L'BERMSG2),BERMSG2                                         
         B     PRTM08                                                           
*                                                                               
PRTM08   DS    0H                                                               
         MVI   FORCEHED,C'P'                                                    
         MVI   SKIPSPEC,C'Y'                                                    
         GOTO1 AIRPRT                                                           
         B     PSEXT                                                            
         SPACE 2                                                                
OVFMSG1  DC    C'BUY RECORD IS TOO LARGE TO HOLD INVOICE DATA.'                 
OVFMSG2  DC    C'THE BUY LINE WILL HAVE TO BE SPLIT INTO TWO'                   
OVFMSG3  DC    C'RECORDS AND THIS MATCH WILL HAVE TO BE RERUN.'                 
OVFMSG4  DC    C'CONTACT DDS IF YOU HAVE ANY QUESTIONS.'                        
OVFMSG5  DC    C'INVOICE DATA HAS NOT BEEN INSERTED INTO THIS'                  
OVFMSG6  DC    C'BUY RECORD.      ---'                                          
         SPACE 2                                                                
BERMSG1  DC    C'BUY RECORD ERROR PREVENTS ADDING OF AFFIDAVIT'                 
BERMSG2  DC    C'DATA. PLEASE CONTACT DDS.'                                     
*                                                                               
         DROP  R6,R7                                                            
         EJECT                                                                  
**********************************************************************          
*                                                                               
*        PDTF        SPOT DATE FIX FOR DEFERRAL DATE CHANGING                   
*                                                                               
*        MODULE RESETS THE SPOT DATE OF ANY DEFERRALL ELEMS                     
*        WHOSE DATE WAS CHANGED DURING AN EARLIER MATCH. THE IDEA IS            
*        TO RESTORE THE FILE TO ITS ORIGINAL STATUS.                            
*                                                                               
*        IT IS USED IN TWO PLACES- HERE AND IN TSTREC                           
*        WHERE THE RECORDS ARE RESTORED FOR BYBLD (BUT NOT WRITTEN              
*        BACK).                                                                 
*                                                                               
**********************************************************************          
*                                                                               
PDTF     NMOD1 0,**PDTF                                                         
         LA    RC,SPACEND                                                       
         DROP  R5                                                               
         L     R6,ADBUY                                                         
         USING BUYREC,R6                                                        
*                                                                               
         CLI   DEFDCHG,C'Y'        DEFERRAL DATE CHANGE?                        
         BNE   PDTFX               NO, FORGET IT.                               
         CLI   BUYKEY+3,X'FF'      POL BUYS ONLY                                
         BNE   PDTFX                                                            
         TM    BDSTAT,X'80'        SKIP IF POL NPW                              
         BNZ   PDTFX                                                            
         TM    BDSTAT2,X'80'       SKIP IF DAILY SKED (PER MEL)                 
         BNZ   PDTFX                                                            
         CLI   PROGPROF+9,C'C'     NOT CALENDAR MONTHS                          
         BE    PDTFX                                                            
         CLC   BQSTARTP,BRDMON     START DATE MUST = START OF MONTH             
         BNE   PDTFX                                                            
*                                                                               
         LLC   R2,BDSEDAY          IS IT AN OUT-OF-WEEK?                        
         SRDL  R2,4                (FOR OUT OF WEEK START DAY                   
         SRL   R3,28               IS HIGHER THAN END)                          
         CR    R2,R3                                                            
         BNH   PDTFX               NO, SKIP IT                                  
*                                  SET VARIOUS DATES                            
         GOTO1 DATCON,DMCB,(2,PREVWKP),WORK                                     
         BCTR  R2,0                                                             
         GOTO1 ADDAY,DMCB,WORK,DUB,(R2)                                         
         GOTO1 DATCON,DMCB,DUB,(2,PREVWKR)    START OF LAST ROTATOR WK          
         GOTO1 ADDAY,DMCB,DUB,DUB,6                                             
         GOTO1 DATCON,DMCB,DUB,(2,PREVWKRX)   END OF LAST ROTATOR WEEK          
*                                                                               
         LA    R8,BDELEM                                                        
         USING REGELEM,R8                                                       
         B     PDTF04                                                           
*                                                                               
PDTF02   DS    0H                                                               
         LLC   R0,RLEN                                                          
         AR    R8,R0                                                            
*                                                                               
PDTF04   DS    0H                                                               
         CLI   0(R8),0             EOR                                          
         BE    PDTFX                                                            
*                                                                               
         CLI   RCODE,0                                                          
         BE    PDTFX                                                            
         CLI   RCODE,X'0B'                                                      
         BL    PDTF02                                                           
         CLI   RCODE,X'0F'                                                      
         BH    PDTF02                                                           
*                                                                               
         CLC   RDATE,BQSTARTP      SPOT DATE VS START DATE                      
         BL    PDTF06                                                           
         CLC   RDATE,PREVWKRX      MUST BE BEFORE LAST ROTATOR WK END           
         BH    PDTF02                                                           
*                                                                               
PDTF06   DS    0H                                                               
         CLC   RDATE,PREVWKP       PICK UP SPOTS IN LAST                        
         BL    PDTF02              WEEK OF PREV MONTH                           
*                                  AND IF NOT MATCHED IN PREV MONTH             
         LR    R2,R8                                                            
PDTF08   DS    0H                                                               
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0             EOR                                          
         BE    PDTF10              YES, SPOT IS OK                              
         CLI   0(R2),X'0B'         ANOTHER SPOT ELEM                            
         BL    PDTF08                                                           
         CLI   0(R2),X'0F'                                                      
         BNH   PDTF10              MEANS LAST SPOT NOT MATCHED                  
         CLI   0(R2),X'10'         AFFID ELEM                                   
         BNE   PDTF08                                                           
         USING AFFELEM,R2                                                       
         CLC   ADATE,BRDMON        TEST MATCHED IN PREV MONTH                   
         BL    PDTF02              YES, SKIP IT                                 
*                                                                               
*                             ELSE WILL BE MATCHED IN CURRENT MONTH             
*                                                                               
         MVC   RDATE,PREVWKR       RESET DATE TO LAST ROTATION WEEK             
         MVI   BYTE3,X'FF'         SET REC IS CHANGED                           
*                                  OF PREVIOUS MONTH                            
         DROP  R2                                                               
*                                                                               
PDTF10   DS    0H                                                               
         B     PDTF02              NEX ELEM                                     
*                                                                               
PDTFX    DS    0H                                                               
         J     EXIT                                                             
         DROP  R8                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
******************************************************************              
         TITLE 'ICSOLR - ICS ON-LINE RECONCILIATION REPORT MODULE'              
******************************************************************              
ICSOLR   NMOD1 0,ICSOLR                                                         
*                                                                               
         LA    R6,1(RB)                                                         
         LA    R6,4095(R6)                                                      
         USING ICSOLR+4096,R6      2N BASE REG                                  
         LA    RC,SPACEND                                                       
         USING BYELEMD,R7                                                       
         USING IELEMD,R8                                                        
*                                                                               
         GOTO1 AIRSTAT             BUCKET TOTALS AND DETERMINE STATUS           
*                                                                               
*-----------------------------------------------------------------              
*        ALWAYS CONVERT TIMES FROM MINUTES TO MILITARY FOR POSTING              
*-----------------------------------------------------------------              
         L     R8,AFINV                                                         
IR004    DS    0H                                                               
         C     R8,ALINV                                                         
         BNL   IR006                                                            
         TM    ISTAT2,X'08'        TEST ALREADY CONVERTED                       
         BNZ   IR004D              YES- SKIP                                    
         OI    ISTAT2,X'08'                                                     
         LA    R3,ITIM                                                          
         LA    R4,WORK                                                          
         BAS   RE,FTIM                                                          
         MVC   ITIM,DUB                                                         
IR004D   DS    0H                                                               
         AH    R8,IELMLEN                                                       
         B     IR004                                                            
*-----------------------------------------------------------------              
IR006    DS    0H                                                               
         CLI   RCWHATPR,0          2 PRINTER MODE?                              
         BE    IR007               NO                                           
*                                                                               
         MVI   RCWHATPR,1          RESET TO PRINTER 1                           
         TM    SUSTATUS,X'F8'      BUT IF NOT PERFECT MATCH                     
         BZ    IR007                                                            
         MVI   RCWHATPR,2          SET TO PRINTER 2                             
*-----------------------------------------------------------------              
*        ORDERED - INVOICE LINES                                                
*-----------------------------------------------------------------              
IR007    DS    0H                                                               
         CLI   IRSKIP,C'Y'         TEST TO SKIP THIS REPORT                     
         BE    IREXT                                                            
         XC    HOLDS,HOLDS                                                      
         XC    ECOUNT,ECOUNT                                                    
         MVI   FORCEHED,C'P'                                                    
         MVI   PAGSW,C'O'                                                       
         MVI   ONRSW,C'R'          SET DOING ORDERED AND RUN                    
*                                                                               
         CLI   QOPT1,C'O'          FILM REPORT IF ERROR                         
         BNE   *+12                AND OVERRIDE MATCH=NO IF FUA ERROR           
         CLI   FILMDSCP,C'Y'                                                    
         BE    *+12                REPORT ALL IF FILM DISC                      
         CLI   MDETOPT,C'N'        IF NOT SHOWING MATCHED DETAILS               
         BE    IR12A               SKIP THIS CODE                               
*                                                                               
         CLI   I2CPROF+3,C'Y'      SORT BY INVOICE DATE/TIME?                   
         BNE   IR10                NO                                           
*                                                                               
         LH    R4,IELMLEN                                                       
         L     R1,ALINV                                                         
         S     R1,AFINV                                                         
         LA    R1,1(R1)                                                         
         SR    R0,R0                                                            
         DR    R0,R4               R1= NO OF ITEMS                              
         ST    R1,DMCB+4                                                        
         LA    R3,IDAT-IELEM                                                    
         LA    R2,5                                                             
*                                                                               
         GOTO1 XSORT,DMCB,AFINV,,(R4),(R2),(R3)                                 
*                                                                               
         L     R8,AFINV                                                         
                                                                                
IR008    DS    0H                                                               
         C     R8,ALINV                                                         
         BNL   IR011                                                            
         SR    R7,R7                                                            
         ICM   R7,7,IBY                                                         
         BZ    IR010                                                            
         A     R7,AFBY                                                          
         BCTR  R7,0                POINT TO MATCHED BUY                         
*                                                                               
         CLI   PIGCTL,C'S'         IF PIGS SEPARATELY                           
         BNE   *+14                                                             
         CLC   PIGFILT,BYPRD2      MUST BE RIGHT PRD                            
         BNE   IR010                                                            
         TM    BYSTAT,X'10'        TEST ORBIT MASTER                            
         BZ    IR009               NO                                           
         CLI   ONROPT,C'Y'         TEST OPT TO PRINT ONR'S SEPARATELY           
         BE    IR010                                                            
         GOTO1 AIRORB                                                           
         B     IR010                                                            
IR009    DS    0H                                                               
         BAS   RE,GETINV           INVOICES                                     
         CLI   ERROR,0                                                          
         BNE   IREXT                                                            
IR010    DS    0H                                                               
         AH    R8,IELMLEN                                                       
         B     IR008                                                            
*-------------------------------------------------------------------            
* NOW LOOP THROUGH BUYS/UNITS AND PROCESS ALL THOSE THAT DON'T MATCH            
* TO AN INVOICE (WE MISSED THESE BUYS WHEN WE PROCESSED INVOICES)               
*-------------------------------------------------------------------            
IR011    L     R7,AFBY             A(FIRST BUY)                                 
         L     R8,AFINV            POINT TO FIRST INVOICE                       
*                                                                               
IR012    C     R7,ALBY             PAST LAST BUY                                
         BL    IR012A              NO                                           
         CLI   ONROPT,C'Y'         PRINT ONR'S SEPARATELY?                      
         BNE   *+12                NO                                           
         CLI   ESTLOPT,C'Y'        SORT BY EST-LINE?                            
         BE    IR12                YES - PRINTING TOTALS LATER                  
         BRAS  RE,IRENDEST         YES - PRINT TOTALS                           
         B     IR12                                                             
*                                                                               
IR012A   LLC   R5,BYNOWK           R5 = ACHIEVED                                
         LLC   R3,BYUNACH          R3 = UNACHIEVED                              
         SR    R5,R3               ANY MATCHES?                                 
         BNZ   IR013               YES - IGNORE THIS BUY                        
         BAS   RE,GETINV           PROCESS THIS UNMATCHED BUY                   
         CLI   ERROR,0             ANY ERROR?                                   
         BNE   IREXT               YES - EXIT                                   
*                                                                               
IR013    LA    R7,BYELEML(R7)      BUMP TO NEXT BUY                             
         B     IR012                                                            
*-----------------------------------------------------------------              
*        ORDERED - INVOICE LINES                                                
*-----------------------------------------------------------------              
IR10     L     R7,AFBY                                                          
*                                                                               
IR11     DS    0H                                                               
         C     R7,ALBY                                                          
         BNL   IR12                                                             
         CLI   PIGCTL,C'S'         IF PIGS SEPARATELY                           
         BNE   IR11A                                                            
         CLC   PIGFILT,BYPRD2      MUST BE RIGHT PRD                            
         BNE   IR11D                                                            
IR11A    DS    0H                                                               
         TM    BYSTAT,X'10'        TEST ORBIT MASTER                            
         BZ    IR11B               NO                                           
         CLI   ONROPT,C'Y'         TEST OPT TO PRINT ONR'S SEPARATELY           
         BE    IR11D                                                            
         GOTO1 AIRORB                                                           
         B     IR11D                                                            
IR11B    DS    0H                                                               
         BAS   RE,GETINV           INVOICES                                     
         CLI   ERROR,0                                                          
         BNE   IREXT                                                            
IR11D    DS    0H                                                               
         LA    R7,BYELEML(R7)                                                   
         B     IR11                                                             
*-----------------------------------------------------------------              
IR12     DS    0H                                                               
         CLI   ONROPT,C'Y'         OPT TO PRINT ONR'S SEPARATELY                
         BNE   IR14                                                             
*                                                                               
         CLI   ESTLOPT,C'Y'                                                     
         BNE   *+8                                                              
         BRAS  RE,IRENDEST                                                      
*                                                                               
IR12A    DS    0H                                                               
         MVI   ONRSW,C'N'          SET DOONG ORDERED NOT RUN                    
         CLI   SPAGOPT,C'Y'        SEPARATE PAGES?                              
         BNE   *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
         GOTO1 REPORT              SKIP A LINE                                  
*                                                                               
         MVC   P+5(69),=C'---------------------O R D E R E D  N O T  R X        
               U N---------------------'                                        
         L     R7,AFBY                                                          
IR12B    DS    0H                                                               
         C     R7,ALBY                                                          
         BH    IR13                                                             
         CLI   PIGCTL,C'S'         IF PIGS SEPARATELY                           
         BNE   IR12C                                                            
         CLC   PIGFILT,BYPRD2      MUST BE RIGHT PRD                            
         BNE   IR12Z                                                            
IR12C    DS    0H                                                               
         CLI   BYUNACH,0                                                        
         BE    IR12Z               MATCHED                                      
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   IR12CA              NO                                           
         CLI   MISSOPT,C'C'        MISSED/MAKEGOOD OPT BUT DON'T PRINT?         
         BNE   IR12CA              NO                                           
         TM    BYSTAT2,BYSTPREQ+BYSTMDGQ  MISSED OR MADE GOOD?                  
         BNZ   IR12Z               YES - DO NOT PRINT THIS LINE!                
*                                                                               
IR12CA   TM    BYSTAT,X'08'        ORBIT SLAVE                                  
         BNZ   IR12Z                                                            
         CLC   P,SPACES                                                         
         BE    IR12D                                                            
         GOTO1 AIRPRT                                                           
IR12D    DS    0H                                                               
         TM    BYSTAT,X'10'                                                     
         BZ    IR12E                                                            
         GOTO1 AIRORB                                                           
         B     IR12Z                                                            
IR12E    DS    0H                                                               
         LLC   R3,BYUNACH                                                       
         B     IR12G                                                            
IR12F    DS    0H                                                               
         GOTO1 AIRPRT              PRINT LAST ONE                               
IR12G    DS    0H                                                               
         BAS   RE,FMTORD                                                        
         LA    R2,P                                                             
         USING LNAD,R2                                                          
         MVC   LNAORD(132),ORDLINW    USE WHOLE LINE                            
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BNE   *+8                 NO                                           
         BRAS  RE,FMTDBUY          YES - FORMAT DIGITAL BUY                     
         MVI   HAVINV,C'N'         TELL FDEM NO INVOICE                         
         GOTO1 AFDEM                                                            
         BCT   R3,IR12F         (NOTE-LAST ONR LINE PRINTS AT 1R12J)            
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   IR12G2                                                           
*                                  POST AND GET COMMENTS                        
         GOTO1 =V(NETNU),DMCB,(C'W',BYELEMD),                          +        
               =X'0000000000000000000000000000'                                 
         B     IR12H               AND PRINT COMMENTS FOR EVERY LINE            
IR12G2   DS    0H                                                               
         LR    R4,R7                                                            
IR12G3   LA    R4,BYELEML(R4)     LOOK AT NEXT ONE                              
         C     R4,ALBY                                                          
         BH    IR12H                                                            
         CLC   BYEST(3),BYEST-BYELEM(R4)  TEST SAME EST-LIN                     
         BNE   IR12H                                                            
         CLC   BYCBLNET,BYCBLNET-BYELEM(R4)  TEST SAME CABLE NET                
         BNE   IR12H                                                            
         CLI   BYUNACH-BYELEM(R4),0    SKIP TOTALLY MATCHED                     
         BE    IR12G3                                                           
         B     IR12J                                                            
IR12H    DS    0H                                                               
         BRAS  RE,IRCOM                                                         
IR12J    DS    0H                                                               
         GOTO1 AIRPRT              PRINT LAST ONE                               
IR12Z    DS    0H                                                               
         LA    R7,BYELEML(R7)                                                   
         B     IR12B                                                            
*                                                                               
IR13     DS    0H                                                               
         CLI   ESTLOPT,C'Y'                                                     
         BNE   IR14                                                             
         BRAS  RE,IRENDEST                                                      
IR14     DS    0H                                                               
         MVC   P,SPACES                                                         
         MVC   P2,SPACES                                                        
         CLI   QBOOK1,C' '                                                      
         BE    IR20                                                             
         OC    OSPTS,OSPTS                                                      
         BZ    IR20                                                             
         CLI   ESTLOPT,C'Y'                                                     
         BE    IR20                                                             
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BE    IR20                YES                                          
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    IR20                YES                                          
         MVI   LNEED,X'80'         FORCE SAME PAGE                              
         LA    R2,P                                                             
         USING LNAD,R2                                                          
         MVC   LNAEDEM+3(3),DASHES                                              
         MVC   LNAADEM+3(3),DASHES                                              
         LA    R2,132(R2)                                                       
         TM    ODEMEST,X'40'       TEST 2-DEC VALUE                             
         BO    IR14A                                                            
         EDIT  ODEMEST,(6,LNAEDEM),1                                            
         B     IR14B                                                            
IR14A    L     R0,ODEMEST                                                       
         N     R0,=X'3FFFFFFF'                                                  
         EDIT  (R0),(6,LNAEDEM),2                                               
*                                                                               
IR14B    TM    ODEMACH,X'40'       TEST 2-DEC VALUE                             
         BO    IR14C                                                            
         EDIT  ODEMACH,(6,LNAADEM),1                                            
         B     IR14D                                                            
IR14C    L     R0,ODEMACH                                                       
         N     R0,=X'3FFFFFFF'                                                  
         EDIT  (R0),(6,LNAADEM),2                                               
*                                                                               
IR14D    GOTO1 AIRPRT                                                           
         B     IR20                                                             
         EJECT                                                                  
*-----------------------------------------------------------------              
*        UNORDERED INVOICE ITEMS                                                
*-----------------------------------------------------------------              
*                                                                               
IR20     DS    0H                                                               
         CLI   ESTINV,C'Y'         IF HAVE EST INV ITEMS                        
         BNE   IR20B                                                            
         CLI   ESTLOPT,C'Y'        SORT ON INVS ON EST                          
         BNE   IR20B                                                            
*                                  SORT INVS ON EST                             
         LH    R4,IELMLEN                                                       
         L     R1,ALINV                                                         
         S     R1,AFINV                                                         
         SR    R0,R0                                                            
         DR    R0,R4               R1= NO OF ITEMS                              
         ST    R1,DMCB+4                                                        
         LA    R3,IEST-IELEM                                                    
         GOTO1 XSORT,DMCB,AFINV,,(R4),1,(R3)                                    
         BNE   IR20F                                                            
*                                                                               
IR20B    CLI   I2ZPROF+3,C'Y'      SORT RNO'S BY INVOICE NUMBER                 
         BNE   IR20F                                                            
         LH    R4,IELMLEN                                                       
         L     R1,ALINV                                                         
         S     R1,AFINV                                                         
         SR    R0,R0                                                            
         DR    R0,R4               R1= NO OF ITEMS                              
         AHI   R1,1                OFF BY ONE                                   
         ST    R1,DMCB+4                                                        
         LA    R3,IINVID-IELEM                                                  
         GOTO1 XSORT,DMCB,AFINV,,(R4),2,(R3)                                    
*                                                                               
IR20F    DS    0H                                                               
         L     R8,AFINV                                                         
         MVI   BYTE2,0                                                          
IR21     C     R8,ALINV                                                         
         BNL   IR23                                                             
*                                                                               
         CLI   PIGCTL,C'S'         IF PIGS SEPARATELY                           
         BNE   IR21A                                                            
         CLC   PIGFILT,IPRD2       ONLY DO RIGHT PRD                            
         BNE   IR22                                                             
IR21A    DS    0H                                                               
         OC    IBY,IBY             TEST ORDERED                                 
         BNZ   IR22                IS ORDERED                                   
*                                                                               
         TM    ISTAT3,IST3AVAL     ADDED VALUE AIRED EVENTS                     
         BO    IR22                DON'T PUT THESE IN RNO THEN                  
*                                                                               
IR21C    CLI   QBYID,C'Y'          SKIP UNORDERED IF RUN BY ID                  
         BNE   IR21D                                                            
         CLC   =C'**UNKNOWN**',SVBUYID                                          
         BNE   IR21F                                                            
         B     IR21X                                                            
*                                                                               
IR21D    CLC   RQREP,SPACES        OR FOR 1 REP                                 
         BNH   IR21H                                                            
         CLI   MTRADE,C'Y'         MTRADE?                                      
         BE    IR21G               YES                                          
*                                                                               
IR21F    CLI   IID,0               TEST INPUT BY ID                             
         BE    IR22                NO, REJECT                                   
         B     IR21X                                                            
*                                                                               
IR21G    L     R5,AINOLST          GET INVOICE REP FOR DETAIL                   
         USING INOLSTD,R5                                                       
IR21G1   CLC   IINVID,INOLNUM      SAME INTERNAL INVOICE NUMBER                 
         BE    IR21G2                                                           
         LA    R5,INOLSTL(R5)      NEXT INVOICE                                 
         CLI   0(R5),C' '          ANY MORE INVOICES?                           
         BH    IR21G1              YES                                          
         B     IR21H               MATCH ON NOTHING THEN                        
*                                                                               
IR21G2   GOTO1 VRCPACK,DMCB,(C'U',INOLREP),WORK                                 
         CLI   Q2USER+6,C'Y'       NEGATIVE FILTER?                             
         BNE   IR21G3              NO                                           
         CLC   RQREP,WORK          NEGATIVE REP MATCHES?                        
         BE    IR22                YES - REJECT                                 
         B     IR21H               NO                                           
*                                                                               
IR21G3   CLC   RQREP,WORK          REP MATCHES?                                 
         BNE   IR22                NO - REJECT                                  
         DROP  R5                  DROP R5                                      
*                                                                               
IR21H    DS    0H                                                               
*                                  IF REQ BY EST                                
         CLC   =C'NO',QEST         THEN INV MUST BE FOR THIS EST                
         BNE   IR21K                                                            
         CLI   QESTEND,C' '        TEST EST FILTER REQ                          
         BE    IR21X               NO- OK                                       
         B     IR22                YES - SKIP ALL UNORDEREDS                    
*                                                                               
IR21K    DS    0H                                                               
         CLI   IEST,0              IS IT AN EST ITEM                            
         BE    IR22                                                             
         CLC   IEST,BEST           IS IT FOR RIGHT EST                          
         BNE   IR22                                                             
*                                                                               
IR21X    DS    0H                                                               
         CLI   SPCONLY,C'Y'        SKIP UNORDEREDS ALSO                         
         BE    IR22                IF SPECIALS ONLY                             
         CLI   QOPT5+1,C' '        OR IF DAYPART FILTER                         
         BH    IR22                                                             
*                                                                               
         CLI   BYTE2,0             FIRST TIME SW                                
         BNE   IR21Z                                                            
         MVI   BYTE2,1                                                          
         CLI   SPAGOPT,C'Y'        SEPARATE PAGES?                              
         BNE   *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
         MVI   PAGSW,0                                                          
         MVI   LNEED,8                                                          
         GOTO1 AIRPRT                                                           
         MVI   PAGSW,C'U'                                                       
         GOTO1 AIMRHEAD                                                         
         GOTO1 AIRPRT                                                           
*                                                                               
IR21Z    BRAS  RE,FMTUNORD         UNMATCHED SPOT                               
         CLI   ERROR,0                                                          
         BNE   IREXT                                                            
*                                                                               
IR22     AH    R8,IELMLEN          NEXT RNO                                     
         B     IR21                                                             
*                                                                               
IR23     EQU   *                                                                
         CLI   QBOOK1,C' '                                                      
         BE    IR30                                                             
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BE    IR30                YES - NO DEMO TOTALS                         
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    IR30                YES - NO DEMO TOTALS                         
         USING DTABD,R2                                                         
         L     R2,DEMPARS+4                                                     
         LA    R3,P+LNBADEM-LNB                                                 
         L     R4,DEMPARS+8                                                     
         LTR   R4,R4                                                            
         BZ    IR30                                                             
         CLI   BYTE2,0             TEST ANY RNO'S                               
         BE    IR23A4              NO                                           
*                                  YES                                          
IR23A    DS    0H                                                               
         MVC   0(6,R3),DASHES                                                   
         LA    RF,132-1(R3)                                                     
*                                                                               
         L     R0,DTABUACH                                                      
         N     R0,=X'3FFFFFFF'                                                  
         TM    DTABUACH,X'40'      TEST 2-DEC VALUE                             
         BO    IR23A2                                                           
         EDIT  (R0),(7,(RF)),1                                                  
         B     IR23A3                                                           
IR23A2   EDIT  (R0),(7,(RF)),2                                                  
*                                                                               
IR23A3   LA    R3,9(R3)                                                         
         A     R2,DEMPARS+12                                                    
         BCT   R4,IR23A                                                         
         MVI   LNEED,X'80'                                                      
         GOTO1 AIRPRT                                                           
         B     IR23B                                                            
*                                                                               
IR23A4   DS    0H                  IF NO RNO'S                                  
         CLC   ECOUNT,=F'1'        BUT MULTIPLE ESTS                            
         BNH   IR30                                                             
*                                  THEN PRINT RNO SECTION FOR DEMO TOTS         
         MVI   PAGSW,0                                                          
         MVI   LNEED,7                                                          
         GOTO1 AIRPRT                                                           
         MVI   PAGSW,C'U'                                                       
         GOTO1 AIMRHEAD                                                         
         GOTO1 AIRPRT                                                           
*                                                                               
         MVC   P+19(20),=C'- -  N  O  N  E  - -'                                
         GOTO1 AIRPRT                                                           
*                                                                               
IR23B    L     R2,DEMPARS+4                                                     
         LA    R3,P+LNBADEM-2-LNB                                               
         L     R4,DEMPARS+8        COUNT                                        
*                                                                               
IR23B2   DS    0H                                                               
         L     R0,DTABUACH                                                      
         N     R0,=X'3FFFFFFF'                                                  
         L     R1,DTABOACH                                                      
         N     R1,=X'3FFFFFFF'                                                  
         AR    R0,R1                                                            
         TM    DTABUACH,X'40'      ONE OF THESE MAY BE F'0'                     
         BO    IR23B4                                                           
         TM    DTABOACH,X'40'      TEST 2-DEC                                   
         BO    IR23B4                                                           
         EDIT  (R0),(7,(R3)),1                                                  
         B     IR23B6                                                           
IR23B4   EDIT  (R0),(7,(R3)),2                                                  
*                                                                               
IR23B6   LA    RF,264(R3)                                                       
         L     R0,DTABEST                                                       
         N     R0,=X'3FFFFFFF'                                                  
         TM    DTABEST,X'40'                                                    
         BO    IR23B8                                                           
         EDIT  (R0),(7,(RF)),1                                                  
         B     IR23B10                                                          
IR23B8   EDIT  (R0),(7,(RF)),2                                                  
*                                                                               
IR23B10  LA    R3,9(R3)                                                         
         A     R2,DEMPARS+12                                                    
         BCT   R4,IR23B2                                                        
*                                                                               
         MVC   P+47(19),=C'TOTAL ACHIEVEMENT ='                                 
         MVI   P2,0                                                             
         MVC   P3+47(17),=C'TOTAL ESTIMATED ='                                  
         GOTO1 AIRPRT                                                           
         SPACE 2                                                                
IR30     DS    0H                                                               
         CLI   SPAGOPT,C'Y'        SEPARATE PAGES?                              
         BNE   *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
         GOTO1 AIRTOTS                                                          
*                                                                               
***      CLI   PSEUDOPT,C'N'       SKIP IF IN PSEUDO MODE                       
***      BNE   IREXT                                                            
***      CLI   PSTOPT,C'N'         NO POSTING = NO MM                           
***      BE    IREXT                                                            
***      CLI   PSTOPT,C'X'         X MEANS NO POSTING DUE TO B0 PROF            
***      BE    IREXT                                                            
***      CLI   PSTOPT,C'L'         L MEANS NO POSTING DUE TO I2A LOCK           
***      BE    IREXT                                                            
***      CLI   MKACTV,C'Y'                                                      
***      BNE   IREXT                                                            
         GOTO1 =V(SPI2MM),DMCB,(C'C',0)  MATCHMAKER MODULE - COMMENTS           
*                                                                               
IREXT    DS    0H                                                               
*&&DO                                                                           
*-----------------------------------------------------------------              
*        CALL MATCHMAKER MODULE - SPREPI2MM                                     
*-----------------------------------------------------------------              
*        MOVED TO AFTER POST TO PICK UP BUY UPDATING ERRS (TOO BIG)             
*-----------------------------------------------------------------              
         CLI   PSEUDOPT,C'N'       SKIP IF IN PSEUDO MODE                       
         BNE   IREXT2                                                           
         CLI   PSTOPT,C'N'         NO POSTING = NO MM                           
         BE    IREXT2                                                           
         CLI   PSTOPT,C'X'         X MEANS NO POSTING DUE TO B0 PROF            
         BE    IREXT2                                                           
         CLI   PSTOPT,C'L'         L MEANS NO POSTING DUE TO I2A LOCK           
         BE    IREXT2                                                           
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   IREXT1              SPOT ALWAYS CALLS MM MODULE NOW              
         CLI   MKACTV,C'Y'         NETPAK STILL CHECKS PROFILE FOR MM           
         BNE   IREXT2                                                           
IREXT1   GOTO1 =V(SPI2MM),DMCB,(C'I',0)  MATCHMAKER MODULE - INVOICE            
*&&                                                                             
*                                                                               
IREXT2   CLI   DIGITAL,C'Y'        DIGITAL REQUEST?                             
         JNE   *+12                NO                                           
         CLI   I2PPROF+8,C'Y'      AUTOPAY DIGITAL?                             
         JNE   EXIT                NO                                           
         BRAS  RE,DOAUTPAY  - MOVED TO AFTER REPORT TO PICK UP HV ERRS          
         J     EXIT                                                             
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FORMAT ORDERED INFO                                                    
*-----------------------------------------------------------------              
*                                                                               
FMTORD   NTR1                                                                   
         CLC   BYCBLNET,LASTNTW    ON CABLE NETWORK BREAK                       
         BE    FO02                                                             
         MVC   LASTNTW,BYCBLNET                                                 
         CLI   BYCBLNET,0                                                       
         BE    FO02                                                             
         MVC   P+5(8),=C'NETWORK='                                              
         XC    DUB,DUB                                                          
         MVC   DUB+2(3),BMKTSTA+2                                               
         NI    DUB+4,X'80'                                                      
         OC    DUB+4(1),BYCBLNET                                                
         GOTO1 MSUNPK,DMCB,(X'80',DUB),WORK,WORK+4                              
         MVC   P+13(3),WORK+9                                                   
         MVI   LNEED,2                                                          
         GOTO1 AIRPRT                                                           
*                                                                               
FO02     DS    0H                                                               
         LA    R2,ORDLINW                                                       
         MVC   ORDLINW,SPACES                                                   
         USING LNAD,R2                                                          
*                                                                               
         TM    BYSTAT,X'08'        TEST ORBIT SLAVE                             
         BZ    FO04                                                             
         MVC   LNADTE-4(3),=C'ORB'                                              
         B     FO06                                                             
*                                                                               
FO04     DS    0H                                                               
         TM    BYSTAT,X'04'        TEST MAKE-GOOD                               
         BZ    *+10                                                             
         MVC   LNADTE-3(2),=C'MG'                                               
         CLI   BYMGAMGC,C' '       IF HAVE MGA CODE                             
         BNH   *+10                                                             
         MVC   LNADTE-3(2),BYMGAMGC USE IT                                      
*                                                                               
FO06     DS    0H                                                               
         TM    BYSTAT2,BYSTPREQ    TEST PRE-EMPTED (ONLY IF MISSOPT=Y)          
         BZ    FO08                                                             
         MVC   LNAIDTE(10),=C'**MISSED**'                                       
         CLI   BYMGAMSC,C' '       IF HAVE MGA CODE                             
         BNH   *+10                                                             
         MVC   LNAIDTE+11(2),BYMGAMSC USE IT                                    
         B     FO12                                                             
*                                                                               
FO08     DS    0H                                                               
         TM    BYSTAT2,BYSTMDGQ    TEST MADE GOOD (ONLY IF MISSOPT=Y)           
         BZ    FO10                                                             
         MVC   LNAIDTE(13),=C'**MADE GOOD**'                                    
         CLI   BYMGAMSC,C' '       IF HAVE MGA CODE                             
         BNH   *+10                                                             
         MVC   LNAIDTE+14(2),BYMGAMSC USE IT                                    
         B     FO12                                                             
*                                                                               
FO10     DS    0H                  TEST DEFERRED                                
         CLI   PROGPROF+9,C'C'     NOT IF CALENDAR MONTHS                       
         BE    FO12                                                             
         CLC   BYEDT,BQENDP        IF SPOT END DATE IS OUTSIDE MONTH            
         BNH   FO12                                                             
         TM    BYSTAT,X'02'        AND ITS A POL SPOT                           
         BZ    FO12                                                             
         CLI   BYUNACH,0           AND ITS NOT MATCHED                          
         BE    FO12                                                             
*                                                                               
         MVC   LNAIDTE(12),=C'**DEFERRED**'  DEFERRED TILL NXT MNTH             
*                                                                               
FO12     DS    0H                  FORMAT DATE                                  
         CLI   I2YPROF+8,C'U'      DISPLAY UNIT DATE                            
         BNE   FO14                                                             
         MVC   DUB(2),BYSDT        SET START AND END DATE IN DUB                
         MVC   DUB+2(2),BYSDT      SET TO SAME SO ONLY PRINTS ONE DATE          
         LA    R3,DUB                                                           
         CLI   BYUDT,0             ANY ADJUSTMENT TO UNIT DATE                  
         BE    FO16                NO THEN PRINT                                
         GOTO1 DATCON,DMCB,(2,BYSDT),DUB                                        
         SR    R3,R3                                                            
         ICM   R3,8,BYUDT          PUT IN HIGH BYTE                             
         SRA   R3,32-8             AND SHIFT TO LOW BYTE KEEPING SIGN           
         GOTO1 ADDAY,DMCB,DUB,DUB,(R3)                                          
         GOTO1 DATCON,DMCB,DUB,(2,DUB+6)                                        
         MVC   DUB(2),DUB+6        SET START AND END DATE IN DUB                
         MVC   DUB+2(2),DUB+6         TO BE FAKE BYSDT AND BYEDT                
         LA    R3,DUB                                                           
         B     FO16                                                             
*                                                                               
FO14     LA    R3,BYSDT                                                         
FO16     LA    R4,LNADTE                                                        
         BAS   RE,FDATO                                                         
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BE    *+12                SHOW SPOT (LINE) NUMBERS                     
         CLI   SEQNOPT,C'Y'        TEST TO SHOW SPOT SEQUENCE NUMS              
         BNE   FO18                                                             
         CLI   BYSPT,1             BYPST PRESENT ONLY FOR POL BUYS              
         BNH   FO18                                                             
         MVC   LNADTE+5(L'LNADTE-5),SPACES   CLEAR 2ND DATE                     
         LA    R4,LNADTE+6                                                      
         MVI   0(R4),C'('                                                       
         EDIT  (B1,BYSPT),(3,1(R4)),ALIGN=LEFT                                  
         AR    R4,R0                                                            
         MVI   1(R4),C')'                                                       
*                                                                               
FO18     DS    0H                                                               
         LA    R3,BYDAY                                                         
         LA    R4,LNADAYS                                                       
         BRAS  RE,FDAY                                                          
*                                                                               
         MVC   WORK(4),BYSTIM                                                   
         LA    R3,BYSTIM                                                        
         LA    R4,LNATIM                                                        
         BAS   RE,FTIM                                                          
*                                                                               
         CLC   WORK(2),WORK+2      START VS. END                                
         BE    FO20                                                             
         MVI   LNATIM+5,C'-'                                                    
         LA    R3,BYETIM                                                        
         LA    R4,LNATIM+6                                                      
         BAS   RE,FTIM                                                          
*                                                                               
FO20     CLI   LNATIM,C'0'                                                      
         BNE   *+8                                                              
         MVI   LNATIM,C' '                                                      
         CLI   LNATIM+6,C'0'                                                    
         BNE   *+8                                                              
         MVI   LNATIM+6,C' '                                                    
*                                                                               
         EDIT  BYLEN,(3,LNALEN)                                                 
*                                                                               
         CLI   NETPSW,C'Y'          NETPAK?                                     
         BNE   FO20A                NO                                          
         MVC   LNAPRD(3),BYPRDNT    MOVE IN 3 CHARACTER PRODUCT                 
         OC    BYPRD2NT,BYPRD2NT    HAVE 3 CHARACTER PRODUCT2?                  
         BZ    FO20B                NO                                          
         MVI   LNAPRD+3,C'-'                                                    
         MVC   LNAPRD+4(3),BYPRD2NT                                             
         B     FO20B                                                            
*                                                                               
FO20A    LA    R3,BYPRD                                                         
         LA    R4,LNAPRD                                                        
         BRAS  RE,FPRD                                                          
*                                                                               
FO20B    CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BNE   FO26                                                             
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   FO21                                                             
         CLI   I2IPROF+1,C'Y'      SKIP IF ONLY INTEGRATION                     
         BE    FO21                                                             
         TM    BYSTAT,X'20'        ACTUAL COST ENTERED                          
         BO    FO21                THEN PRINT IT                                
         B     FO26                OTHERWISE LEAVE BLANK                        
*                                                                               
FO21     MVC   DUB(4),BYCOST        GROSS                                       
         CLI   NETINV,C'Y'                                                      
         BNE   *+10                                                             
         MVC   DUB(4),BYNET         OR NET                                      
         L     R1,DUB                                                           
         TM    BYSTAT,X'01'        TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         CLI   CENTS,C'Y'          TEST HAVE PENNIES                            
         BE    *+8                                                              
         M     R0,=F'100'                                                       
*                                                                               
FO24     CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BE    FO25                COS2 FOR SPOT ONLY                           
         TM    BYSTAT2,BYSTCS2Q    EARNED DISC - NO COS2 ERR                    
         BNO   FO25                                                             
         MVC   LNACOST+2(9),=C'*NO COS2*'  IND MISSING COS2 ON BUYLINE          
         B     FO26                                                             
FO25     EDIT  (R1),(11,LNACOST),2,FLOAT=-                                      
         CLI   STAXOPT,C'Y'        IF SHOWING STATION TAX                       
         BNE   FO26                                                             
         TM    BYSTAT2,BYSTTNEQ    AND THIS BUY TAX NOT EQUAL                   
         BZ    FO26                                                             
         MVI   LNACOST+L'LNACOST,C'T'    TAX NOT EQUAL                          
*                                                                               
FO26     DS    0H                                                               
         EDIT  BYEST,(3,LNAESTL),FILL=0                                         
         XR    R0,R0                                                            
         ICM   R0,3,BYLIN                                                       
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   *+8                                                              
         IC    R0,BYPKG                                                         
         LA    R1,LNAESTL+4                                                     
         EDIT  (R0),(3,(R1)),FILL=0                                             
         MVI   LNAESTL+3,C'-'                                                   
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   FO28                                                             
         TM    BYSTAT2,BYSTBLBQ    TEST BILLBOARD                               
         BZ    *+8                                                              
         MVI   LNAIND,C'B'                                                      
         TM    BYSTAT2,BYSTMIRQ    TEST MIRROR                                  
         BZ    FO30                                                             
         MVI   LNAIND,C'M'                                                      
         MVI   P2+62,C'M'                                                       
         EDIT  BYMIRSEQ,(3,P2+63),FILL=0                                        
         TM    BYSTAT2,BYSTNOAQ    NO AFFID SEEDED                              
         BNO   FO30                DUE TO MIRROR NOT MATCHED                    
         MVC   P2+66(12),=C'**NO AFFID**'                                       
         B     FO30                                                             
*                                                                               
FO28     DS    0H                                                               
         MVI   LNAIND,C' '                                                      
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BE    FO30                                                             
         TM    BYSTAT,X'20'        TEST NTP/SYND BUY- SPOT ONLY                 
         BZ    FO30                                                             
         MVI   LNAIND,C'*'                                                      
FO30     DS    0H                                                               
         OC    BYSREP,BYSREP                                                    
         BZ    FO32                                                             
         GOTO1 VRCPACK,DMCB,(C'U',BYSREP),LNAREP                                
*                                                                               
FO32     SR    R0,R0                                                            
*                                  GET MULTIPLIER FOR COST                      
         CLI   ONROPT,C'Y'         TEST ONR SEPARATE                            
         BE    FO34                YES                                          
*                                  NO                                           
         IC    R0,BYNOWK           USE NO/WK                                    
         TM    BYSTAT,X'18'        FOR NORMAL                                   
         BZ    FO40                                                             
         IC    R0,BYUNACH          USE UNACHOEVED                               
         TM    BYSTAT,X'10'        FOR ORBIT MASTER                             
         BNZ   FO40                                                             
         LLC   RF,BYNOWK                                                        
         SR    RF,R0                                                            
         LR    R0,RF               USE ACHIEVED FOR ORBIT SLAVE                 
         B     FO40                                                             
*-----------------------------------------------------------------              
*        ONR'S SEPARATE                                                         
*-----------------------------------------------------------------              
*                                                                               
FO34     DS    0H                                                               
         CLI   ONRSW,C'R'          TEST DOIND ODERED AND RUN NOW                
         BNE   FO36                NO                                           
*                                  YES                                          
         LLC   R0,BYNOWK           USE ACHIEVED                                 
         LLC   RF,BYUNACH                                                       
         SR    R0,RF                                                            
         B     FO40                                                             
*                                  ORDERED NOT RUN                              
FO36     DS    0H                                                               
         TM    BYSTAT,X'08'                                                     
         BNZ   FO44                BYPASS ORBIT SLAVES                          
         TM    BYSTAT2,BYSTMISQ                                                 
         BNZ   FO44                AND MISSED SPOTS                             
         LA    R0,1                USE 1 FOR NORMAL LINES                       
         TM    BYSTAT,X'10'                                                     
         BZ    FO40                                                             
         IC    R0,BYUNACH          USE UNACHEIVED FOR ORBIT MASTERS             
*                                                                               
FO40     DS    0H                  ADD COST TO TOTALS                           
         MVC   FULL,BYCOST                                                      
         CLI   NETINV,C'Y'         TEST NET INVOICE                             
         BNE   *+10                                                             
         MVC   FULL,BYNET                                                       
         L     R1,FULL                                                          
         TM    BYSTAT,X'01'        TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         CLI   CENTS,C'Y'          TEST HAVE PENNIES                            
         BE    *+8                                                              
         M     R0,=F'100'          SET COST IN R1                               
         MR    R0,R0                                                            
*                                                                               
FO43     A     R1,EGRS                                                          
         ST    R1,EGRS                                                          
*                                                                               
FO44     DS    0H                                                               
         CLI   TRAFMBF,C'Y'        IF MATCHING BY FILM                          
         BE    *+12                                                             
         CLI   TRAFMBF,C'B'                                                     
         BNE   FO50                                                             
         CLI   BYUNACH,0           FOR ONR'S                                    
         BE    FO50                                                             
         OC    BYFILM,BYFILM       SHOW FILM CODE                               
         BZ    FO50                                                             
         MVI   IFCODADI,0                                                       
         TM    BYSTAT2,BYSTADIQ    FILM IS AD-ID                                
         BNO   *+8                                                              
         OI    IFCODADI,X'80'      TELL FOFILM IT'S AD-ID                       
         LA    R3,BYFILM                                                        
         BAS   RE,FOFILM                                                        
         OC    BYFILM2,BYFILM2     ANY 2ND FILEM?                               
         BNZ   FO46                                                             
         MVC   LNAIFILM,TEMPFILM   NO, SHOW FIRST IN NORMAL PLACE               
         B     FO50                                                             
*                                                                               
FO46     DS    0H                       IF HAVE 2ND FILM                        
         MVC   LNAIFILM-13(12),TEMPFILM   SHOW FIRST TO THE LEFT                
         MVI   LNAIFILM-1,C'-'                                                  
         LA    R3,BYFILM2                                                       
         BAS   RE,FOFILM                                                        
         MVC   LNAIFILM,TEMPFILM                                                
*                                                                               
FO50     DS    0H                                                               
         DROP  R2                                                               
         J     EXIT                                                             
         EJECT                                                                  
*-----------------------------------------------------------------              
*              GET MATCHING INVOICES                                            
*-----------------------------------------------------------------              
*                                                                               
GETINV   NTR1                                                                   
         CLI   I2CPROF+3,C'Y'      SORTING ON INVOICE DATE/TIME?                
         BE    *+8                 YES                                          
         L     R8,AFINV                                                         
         LLC   R5,BYNOWK                                                        
         LLC   R3,BYUNACH          R3 = UNACHIEVED                              
         SR    R5,R3               R5 = ACHIEVED                                
         LA    R2,P                                                             
         USING LNAD,R2                                                          
         MVC   ORDLINW,SPACES                                                   
         LTR   R5,R5                                                            
         BZ    GI4                 NO MATCHES                                   
         BAS   RE,FMTORD                                                        
         LR    R1,R7                                                            
         LA    R1,1(R1)                                                         
         S     R1,AFBY             R1 = RELATIVE BUY ADDRESS                    
         STCM  R1,7,SVIBY                                                       
GI2      CLC   SVIBY,IBY                                                        
         BE    GI7                                                              
GI3      AH    R8,IELMLEN                                                       
         C     R8,ALINV                                                         
         BNH   GI2                                                              
*                             HAVE EXHAUSTED INVOICES                           
*                             REPEAT ORDERED INFO FOR UNACHIEVED SPOTS          
GI4      DS    0H                                                               
         LLC   R3,BYUNACH                                                       
         LTR   R3,R3                                                            
         BZ    GI10                     NO UNMATCHED BUYS LEFT                  
         TM    BYSTAT,X'08'        NO ONR'S HERE FOR ORBITS                     
         BNZ   GI10                                                             
         CLI   ONROPT,C'Y'         OPT TO PRINT ONR'S SEPARATELY                
         BE    GI10                                                             
*                                                                               
GI5      EQU   *                                                                
         CLC   ORDLINW,SPACES                                                   
         BNE   *+8                                                              
         BAS   RE,FMTORD                                                        
         CLC   P,SPACES                                                         
         BE    GI5B                                                             
         GOTO1 AIRPRT                                                           
GI5B     DS    0H                                                               
         MVC   LNAORD(132),ORDLINW   USE WHOLE LINE                             
         MVI   HAVINV,C'N'         TELL FDEM NO INVOICE                         
         GOTO1 AFDEM                                                            
         CLI   ERROR,0                                                          
         BNE    GIEXT                                                           
GI6      BCT   R3,GI5                                                           
         B     GI10                     NO UNMATCHED BUYS LEFT                  
         SPACE 3                                                                
GI7      EQU   *                                                                
*                                            FORMAT INVOICE INFO                
         CLC   P,SPACES                                                         
         BE    GI7B                                                             
         GOTO1 AIRPRT                                                           
GI7B     DS    0H                                                               
         MVC   LNAORD(132),ORDLINW   USE WHOLE LINE                             
         LA    R3,IDAT                                                          
         LA    R4,LNAIDTE                                                       
         BRAS  RE,FDATI                                                         
         MVC   HALF(1),IDAY        DAY OF WEEK                                  
         MVI   HALF+1,0            START/END DAYS NOT NEEDED                    
         LA    R3,HALF                                                          
         LA    R4,LNAIDAY                                                       
         BRAS  RE,FDAY                                                          
*                                                                               
         TM    ISTAT3,IST3REMD     TEST REMATCHED                               
         BNO   *+10                                                             
         MVC   LNAIDTE-3(3),=C'RE-'                                             
*                                                                               
         LA    R3,ITIM                                                          
         LA    R4,LNAITIM                                                       
         BAS   RE,FTIM4                                                         
         MVC   ITIM,DUB            PUT MIL. TIME IN INV ELEM                    
         CLI   LNAITIM,C'0'                                                     
         BNE   *+8                                                              
         MVI   LNAITIM,C' '                                                     
*                                                                               
         TM    ISTAT2,X'20'        TEST INTERVAL ERROR - SECONDARY              
         BZ    *+8                                                              
         MVI   LNAITIM-1,C'+'                                                   
         TM    ISTAT2,X'40'        PRIMARY                                      
         BZ    *+8                                                              
         MVI   LNAITIM-1,C'*'                                                   
         TM    ISTAT,X'20'         TEST IGNORE PRIMARY INTVL CHK                
         BZ    *+8                                                              
         MVI   LNAITIM-1,C'='                                                   
*                                                                               
         TM    ISTAT,X'02'         TEST IGNORE TIME FOR MATCH                   
         BZ    *+8                                                              
         MVI   LNAITIM+5,C'T'      MARK WITH 'T' AFTER TIME                     
*                                                                               
         MVC   IFCOD1(16),SPACES   CLEAR TRANSLATED FILM CODES                  
         CLI   TRAFSW,C'Y'         TEST ON TRAFFIC                              
         BNE   GI7B6D                                                           
         CLI   I2CPROF+1,C'Y'      DISP 'NONE' FOR MISSING FILMS?               
         BNE   *+10                NO                                           
         MVC   LNAIFILM(4),=C'NONE' YES - DISPLAY "NONE"                        
*                                                                               
         CLI   IFILM,0             TEST HAVE FILM CODE                          
         BE    GI7B00                                                           
*                                                                               
         MVI   IFCODADI,0          FLAG IS FOR BOTH FILMS                       
         TM    ISTAT3,IST3ADID     INVOICE COMML IS AD-ID                       
         BNO   *+8                                                              
         OI    IFCODADI,X'80'      TELL FFILM                                   
         TM    ISTAT3,IST3HDEF     INVOICE COMML IS HDEF                        
         BNO   *+8                                                              
         OI    IFCODADI,X'40'      TELL FFILM                                   
         TM    ISTAT4,IST4CNTR     INVOICE COMML IS CENTERCUT                   
         BNO   *+8                                                              
         OI    IFCODADI,X'20'      TELL FFILM                                   
*                                                                               
         LA    R3,IFILM            YES                                          
         LA    R4,LNAIFILM                                                      
         BRAS  RE,FFILM                                                         
         MVC   IFCOD1,0(R4)        SAVE FIRST FILM                              
         TM    ISTAT3,IST3ADID+IST3HDEF                                         
         BZ    *+10                                                             
         MVC   IFCOD1,TEMPFILM     HAS PACKED AD-ID/HDEF/CNTRCT TO SEED         
         TM    ISTAT2,X'02'        IGNORE FILM?                                 
         BZ    *+8                 NO                                           
         MVI   LNAITIM+6,C'*'      YES MARK WITH '*' BEFORE FILMCODE            
*                                                                               
GI7B00   CLI   IPRD2,0             HAVE PIGGY?                                  
         BNE   *+12                YES                                          
         CLI   IPRD2NT,0           HAVE PIGGY?                                  
         BE    GI7B01              NO                                           
         CLI   I2CPROF+1,C'Y'      DISP 'NONE' FOR MISSING FILMS?               
         BNE   *+10                NO                                           
         MVC   LNAIFILM+132(4),=C'NONE'  YES - DISPLAY "NONE"                   
*                                                                               
GI7B01   CLI   IFILM2,0            TEST HAVE 2ND FILM                           
         BE    GI7B6B                                                           
         LA    R3,IFILM2                                                        
         MVI   LNAIFILM+131,C'-'                                                
         LA    R4,LNAIFILM+132                                                  
         BRAS  RE,FFILM                                                         
         MVC   IFCOD2,0(R4)        SAVE 2ND FILM                                
         TM    ISTAT3,IST3ADID+IST3HDEF                                         
         BZ    *+10                                                             
         MVC   IFCOD2,TEMPFILM     HAS PACKED AD-ID TO SEED                     
*                                                                               
GI7B6B   DS    0H                                                               
         TM    ISTAT,INVSBLBQ      TEST BILLBOARD                               
         BZ    *+10                                                             
         MVC   12(2,R4),=C'-B'                                                  
*                                                                               
GI7B6D   TM    ISTAT4,IST4SBRD     HAVE SUBSTITUTION BRANDS ON INVOICE?         
         BZ    GI7B6E              NO                                           
         CLC   IPRD,BYPRD          INVOICE AND BUY PRODUCTS MATCH?              
         BNE   GI7B8B              NO                                           
*                                                                               
GI7B6E   CLI   IMIS,0              PARTIAL MATCH?                               
         BE    GI7B20              NO                                           
*                                                                               
         LA    R1,=C'TIME '        SHOW PARTIAL MATCH DATA                      
         CLI   IMIS,C'T'                                                        
         BE    GI7B16                                                           
         LA    R1,=C'DAY '                                                      
         CLI   IMIS,C'A'                                                        
         BE    GI7B16                                                           
         LA    R1,=C'DATE '                                                     
         CLI   IMIS,C'D'                                                        
         BE    GI7B16                                                           
         LA    R1,=C'WEEK '                                                     
         CLI   IMIS,C'W'                                                        
         BE    GI7B16                                                           
         LA    R1,=C'FILM '                                                     
         CLI   IMIS,C'F'                                                        
         BE    GI7B16                                                           
*                                                                               
         CLI   IMIS,C'L'                                                        
         BNE   GI7B8                                                            
         MVC   W(8),SPACES                                                      
         MVC   W(4),=C'LEN='                                                    
         EDIT  ILEN,(3,W+4),ALIGN=LEFT                                          
         LA    R1,W                                                             
         B     GI7B16                                                           
*                                                                               
GI7B8    CLI   IMIS,C'P'                                                        
         BNE   GI7B20                                                           
GI7B8B   MVC   W(8),SPACES                                                      
         MVC   W(4),=C'PRD='                                                    
*                                                                               
         CLI   NETPSW,C'Y'          NETPAK?                                     
         BNE   GI7B9                NO                                          
         MVC   W+4(3),IPRDNT        MOVE IN 3 CHARACTER PRODUCT                 
         MVC   W+8(3),IPRD2NT       MOVE IN 3 CHAR PRD2                         
         LA    R1,W                                                             
         B     GI7B16                                                           
*                                                                               
GI7B9    LA    R3,IPRD                                                          
         LA    R4,W+4                                                           
         BRAS  RE,FPRD                                                          
         LA    R1,W                                                             
         MVI   W+7,C' '                                                         
*                                                                               
GI7B16   LR    RF,R1                RF = START OF DATA TO PRINT                 
         CLI   0(R1),C' '           END OF DATA TO PRINT?                       
         BNH   *+12                 YES                                         
         LA    R1,1(R1)             BUMP                                        
         B     *-12                 FIND END OF DATA                            
*                                                                               
         LA    RE,LNAEDEM+3        PRINT PARTIAL MATCH/SUB BRANDS HERE          
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    *+8                 YES                                          
         LA    RE,LNAICOST         PRINT PARTIAL MATCH/SUB BRANDS HERE          
         MVI   0(RE),C'('          OPEN BRACKETS                                
         MVC   1(L'LNAIFILM-1,RE),SPACES                                        
         SR    R1,RF               L'DATA                                       
         EX    R1,*+8              EXECUTE                                      
         B     *+10                SO IDF DOESN'T COMPLAIN                      
         MVC   1(0,RE),0(RF)       MOVE DATA                                    
         LA    R1,1(RE,R1)         END OF DATA                                  
         MVI   0(R1),C')'          CLOSE BRACKET                                
         B     GI7D                                                             
*                                  COST MAY NOT BE EQUAL                        
*                                  EVEN IF COMPLETE MATCH                       
GI7B20   DS    0H                                                               
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BNE   GI7D                                                             
         CLI   PSEUDOPT,C'R'       OR IF DOING RESPONSES                        
         BE    GI7D                                                             
         CLI   PSEUDOPT,C'P'       OR IF DOING MCP                              
         BE    GI7D                                                             
         CLI   I2IPROF+1,C'Y'      OR IF ONLY INTEGRATION                       
         BE    GI7D                                                             
         LA    RF,BYCOST                                                        
         CLI   NETINV,C'Y'                                                      
         BNE   *+8                                                              
         LA    RF,BYNET                                                         
         CLC   ICOST,0(RF)                                                      
         BE    GI7D                                                             
         MVC   DUB(4),ICOST                                                     
         L     R1,DUB                                                           
         TM    ISTAT,X'01'         TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         CLI   CENTS,C'Y'          TEST HAVE PENNIES                            
         BE    *+8                                                              
         M     R0,=F'100'                                                       
         EDIT  (R1),(9,WORK+1),2,FLOAT=-,ALIGN=LEFT                             
*                                                                               
         LA    RF,WORK                                                          
         MVI   0(RF),C'('                                                       
         AR    RF,R0               R0 = L'COST STRING FROM EDIT                 
         CLI   IMIS,C'C'           PARTIAL MATCH ON COST?                       
         BE    GI7B21              NO                                           
         LA    R1,MISLIST                                                       
         LA    RE,12                                                            
         CLI   0(R1),C'C'          PARTIAL MATCH ON COST?                       
         BE    GI7B21              YES                                          
         AHI   R1,1                BUMP MISLIST                                 
         BCT   RE,*-12                                                          
*                                                                               
         TM    ISTAT,ISTNCOST      IGNORE COST FEATURE ON INVOICE?              
         BZ    GI7B21              NO                                           
         MVI   1(RF),C'N'          YES - SET FLAG                               
         AHI   RF,1                                                             
         AHI   R0,1                                                             
*                                                                               
GI7B21   MVI   1(RF),C')'                                                       
         AHI   R0,1                                                             
         LR    RF,R0                                                            
         CHI   RF,11               LENGTH > 12?                                 
         BNH   *+8                 NOPE                                         
         LA    RF,11               YES - DON'T MOVE MORE THAN 12 BYTES!         
         LA    RE,LNAEDEM+3        PRINT COST TOLERANCE HERE                    
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    *+8                 YES                                          
         LA    RE,LNAIFILM         PRINT COST TOLERANCE HERE                    
         MVC   0(L'LNAIFILM,RE),SPACES                                          
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),WORK                                                     
*                                                                               
GI7D     DS    0H                                                               
         CLI   PSEUDOPT,C'R'       IF DOING RESPONSES                           
         BNE   GI7F                (INSTEAD OF DEMOS)                           
         EDIT  (B4,ICOST),(9,LNAEDEM),COMMAS=YES,ZERO=NOBLANK                   
*                                                                               
GI7F     DS    0H                                                               
         MVI   HAVINV,C'Y'         TELL FDEM HAVE INVOICE                       
         GOTO1 AFDEM                                                            
         CLI   ERROR,0                                                          
         BNE   GIEXT                                                            
*                                                                               
         CLI   NETPSW,C'Y'         ONLY FOR NETPAK                              
         BNE   GI7G                                                             
         CLI   PROGOPT,C'N'        ONLY IF OPTION ON                            
         BE    GI7G                                                             
         GOTO1 GETPGMN,DMCB,IELEMD,LNAIDTE+132   PROGRAM NAME                   
*                                                                               
GI7G     GOTO1 ROTADD,DMCB,ROTPCTW   POST TO WEEKLY ROTATION COUNTERS           
         GOTO1 ROTADD,DMCB,ROTPCTL   AND BUYLINE                                
*                                                                               
         CLI   I2CPROF+3,C'Y'      SORTING ON INVOICE DATE/TIME?                
         BE    GI10                YES - DON'T LOOK AT NEXT INV!                
         BCT   R5,GI3                                                           
         B     GI4                 NO MATCHING INVOICES LEFT                    
         DROP  R2                                                               
*                                                                               
GI10     DS    0H                                                               
         CLC   ORDLINW,SPACES      NO ACTIVITY FOR THIS LINE                    
         BE    GIEXT                                                            
         CLI   NETPSW,C'Y'         EXCEPT FOR NETPAK                            
         BE    *+12                                                             
         CLI   ESTLOPT,C'Y'        MUST BE EST-LINE ORDER                       
         BNE   GI19                                                             
         LA    R2,BYELEML(R7)                                                   
GI10B    DS    0H                                                               
         C     R2,ALBY           TEST AT END                                    
         BNL   GI10B4                                                           
         CLC   BYEST(3),BYEST-BYELEM(R2)  TEST SAME EST/LINE                    
         BE    GI10C                                                            
GI10B4   DS    0H                  END OR NEW EST LINE                          
         CLI   NETPSW,C'Y'       IF NETPAK                                      
         BE    GI10D             POST, GET COMMENTS, AND SKIP ROTATION          
         B     GI11                                                             
GI10C    DS    0H                                                               
         CLI   ONROPT,C'Y'         IF PRINTING ONR'S SEP                        
         BNE   GI10D               MAKE SURE TO DO COMMENTS, ETC                
         CLC   BYUNACH-BYELEM(1,R2),BYNOWK-BYELEM(R2)  TEST MATCHED             
         BE    GI10C4                   NO, IGNORE                              
         TM    BYSTAT-BYELEM(R2),X'18'     IF ITS AN ORBIT LINE                 
         BZ    GI10D                                                            
         CLC   BYORBNO,BYORBNO-BYELEM(R2)  IGNORE ORBNO'S YET TO COME           
         BL    GI10D                                                            
GI10C4   LA    R2,BYELEML(R2)                                                   
         B     GI10B               NEXT SPOT LOOKING FOR END OF LINE            
GI10D    DS    0H                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK, POST AND GET COMMENTS            
         BNE   GI10E                                                            
         LA    RF,IELEMD           PASS INV ELEM                                
         CLI   BYUNACH,0           IF MATCHED                                   
         BE    *+8                                                              
         LA    RF,=X'0000000000000000000000000000'   ELSE A(NULLS)              
         ST    RF,DMCB+4                                                        
         GOTO1 =V(NETNU),DMCB,(C'W',BYELEMD)                                    
         B     GI11E      AND SKIP ROTATION AND DO COMMS FOR EACH LINE          
*                                                                               
GI10E    DS    0H                                                               
         CLC   BYEST(5),BYEST-BYELEM(R2)  TEST LAST FOR WEEK                    
         BNE   GI10F               YES                                          
         CLC   BYCBLNET,BYCBLNET-BYELEM(R2)  TEST SAME CABLE NET                
         BE    GI19                NO                                           
*                                                                               
GI10F    GOTO1 ACHKROT,DMCB,(R7),ROTPCTW - YES- WEEKLY ROTATION CHK             
*                                                                               
         CLC   BYCBLNET,BYCBLNET-BYELEM(R2)  TEST SAME CABLE NET                
         BNE   GI11D               NO - LINE ROTATION CHECK                     
         CLC   BYEST(3),BYEST-BYELEM(R2)   IS THIS LAST FOR EST-LIN             
         BE    GI19                SAME = PRINT LINE AND KEEP GOING             
         B     GI11D               NO= LINE ROTATION CHECK                      
*                                                                               
GI11     GOTO1 ACHKROT,DMCB,(R7),ROTPCTW                                        
*                                                                               
GI11D    GOTO1 ACHKROT,DMCB,(R7),ROTPCTL                                        
*                                                                               
GI11E    BRAS  RE,IRCOM            AND PRINT COMMENTS                           
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BNE   GI11F               NO                                           
         BRAS  RE,FMTDBUY          YES - FORMAT DIGITAL BUY                     
         CLC   BYNOWK,BYUNACH      DID THIS INVOICE MATCH?                      
         BE    GI11F               NO - SKIP PRINTING INV LINE                  
         BRAS  RE,FMTDINV          YES - FORMAT DIGITAL INV                     
         MVC   P3+86(44),WORK      INVOICE DEMO LINE                            
GI11F    GOTO1 AIRPRT                                                           
*                                                                               
         CLI   I2CPROF+3,C'Y'      SORT BY INV TIME/DATE?                       
         BE    GI20                YES                                          
*                                                                               
GI12     C     R2,ALBY                                                          
         BNL   GI13                                                             
         CLC   BYEST,BYEST-BYELEM(R2)                                           
         BE    GI20                                                             
         MVI   SPACING,2                                                        
GI13     BRAS  RE,IRENDEST                                                      
         B     GIEXT                                                            
*                                                                               
GI19     CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BNE   GI20                NO                                           
         BRAS  RE,FMTDBUY          YES - FORMAT DIGITAL BUY                     
         CLC   BYNOWK,BYUNACH      DID THIS INVOICE MATCH?                      
         BE    GI20                NO - SKIP PRINTING INV LINE                  
         BRAS  RE,FMTDINV          YES - FORMAT DIGITAL INV                     
         MVC   P3+86(44),WORK      INVOICE DEMO LINE                            
*                                                                               
GI20     GOTO1 AIRPRT                                                           
*                                                                               
GIEXT    J     EXIT                                                             
*                                                                               
*-----------------------------------------------------------------              
*        ROTADD - ADD TO ROTATION COUNTERS                                      
*-----------------------------------------------------------------              
*                                                                               
ROTADD   NTR1                                                                   
         L     R2,0(R1)                                                         
         USING ROTD,R2                                                          
         OC    ROTPCT,ROTPCT       TEST ANY CHECKING                            
         BZ    ROTADDX                                                          
         CLI   COSTSUP,C'A'        TEST TO SUPPRESS                             
         BE    ROTADDX                                                          
*                                                                               
         L     RF,ROTSPTS                                                       
         LA    RF,1(RF)                                                         
         ST    RF,ROTSPTS                                                       
*                                                                               
         LLC   R0,IDAY             DAY                                          
         LA    R1,6                                                             
         SRA   R0,1                                                             
         BZ    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         SLA   R1,2                                                             
         L     RF,ROTDAYS(R1)                                                   
         LA    RF,1(RF)                                                         
         ST    RF,ROTDAYS(R1)                                                   
*                                                                               
*                                  TIME (HALF HOUR SLOTS)                       
         MVC   HALF,ITIM                                                        
         LH    R1,HALF                                                          
         SR    R0,R0                                                            
         D     R0,=F'100'                                                       
         SLA   R1,1                                                             
         CHI   R0,30                                                            
         BL    *+8                                                              
         LA    R1,1(R1)                                                         
         SLA   R1,2                                                             
         L     RF,ROTTIMS(R1)                                                   
         LA    RF,1(RF)                                                         
         ST    RF,ROTTIMS(R1)                                                   
*                                                                               
ROTADDX  DS    0H                                                               
         J     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
*-----------------------------------------------------------------              
*        HANDLE ORBIT MASTERS                                                   
*-----------------------------------------------------------------              
IRORB    NTR1                                                                   
         CLI   BYUNACH,0                                                        
         BE    IRORBX              BYPASS IF MATCHED                            
         LR    R4,R7               SAVE A(ELEM)                                 
         LLC   R5,BYUNACH          FOR BCT - NO. OF UNACHIEVED SPOTS            
IRORB1   DS    0H                                                               
         BAS   RE,FMTORD                                                        
         LA    R2,P                                                             
         USING LNAD,R2                                                          
         MVC   LNAORD,ORDLINW                                                   
         MVC   LNADAYS,SPACES                                                   
         MVC   LNATIM,SPACES                                                    
         MVC   LNADAYS(22),=C'**MISSING ORBIT SPOT**'                           
         CLC   BYEDT,BQENDP        IF SPOT END DATE IS OUTSIDE MONTH            
         BNH   IRORB1D                                                          
         TM    BYSTAT,X'02'        AND ITS A POL SPOT                           
         BZ    IRORB1D                                                          
         MVC   LNADAYS(23),=C'**DEFERRED ORBIT SPOT**'                          
IRORB1D  DS    0H                                                               
         MVI   HAVINV,C'N'         TELL FDEM NO INVOICE                         
         GOTO1 AFDEM                                                            
         GOTO1 AIRPRT                                                           
*                                  NOW FIND AND PRINT ALL SLAVES                
         L     R7,AFBY                                                          
IRORB2   DS    0H                                                               
         C     R7,ALBY                                                          
         BH    IRORB6                                                           
         CLI   PIGCTL,C'S'         IF PIGS SEPARATELY                           
         BNE   IRORB3                                                           
         CLC   PIGFILT,BYPRD2      MUST BE RIGHT PRD                            
         BNE   IRORB4                                                           
*                                                                               
IRORB3   DS    0H                                                               
         TM    BYSTAT,X'08'        TEST ORBIT SLAVE                             
         BZ    IRORB4                                                           
         CLC   BYEST(3),BYEST-BYELEM(R4)      EST-LIN                           
         BNE   IRORB4                                                           
         CLC   BYORBNO,BYORBNO-BYELEM(R4)                                       
         BNE   IRORB4                                                           
         CLC   BYSPT,BYSPT-BYELEM(R4)                                           
         BNE   IRORB4                                                           
*                                                                               
         OI    BYSTAT,X'01'        SET TO NOT TOTAL DEMS                        
         BAS   RE,FMTORD                                                        
         MVC   LNAORD,ORDLINW                                                   
         MVC   LNACOST,SPACES                                                   
         MVI   HAVINV,C'N'         TELL FDEM NO INVOICE                         
         GOTO1 AFDEM                                                            
         NI    BYSTAT,X'FE'                                                     
         GOTO1 AIRPRT                                                           
*                                                                               
IRORB4   DS    0H                                                               
         LA    R7,BYELEML(R7)                                                   
         B     IRORB2                                                           
IRORB6   DS    0H                                                               
*                                                                               
         LR    R7,R4               RESTPORE A(ORBIT MAST)                       
         GOTO1 AIRPRT                                                           
         BCT   R5,IRORB1                                                        
*                                                                               
IRORBX   DS    0H                                                               
         J     EXIT                                                             
         SPACE 1                                                                
         EJECT                                                                  
*                                                                               
*        DATE FORMAT - ORDERED                                                  
*                                                                               
FDATO    CLC   DATINBH,0(R3)                                                    
         BE    FDATO2                                                           
         ST    RE,FULL                                                          
         MVC   DATINBH,0(R3)                                                    
         GOTO1 DATCON,DMCB,(2,0(R3)),(8,DATCHAH)                                
*                                                                               
         L     RE,FULL                                                          
FDATO2   MVC   0(5,R4),DATCHAH                                                  
         CLC   0(2,R3),2(R3)       IS 2ND DATE THE SAME                         
         BER   RE                  YES - DONE                                   
         CLC   DATINB2H,2(R3)                                                   
         BE    FDATO8                                                           
         ST    RE,FULL                                                          
         MVC   DATINB2H,2(R3)                                                   
         GOTO1 DATCON,DMCB,(2,2(R3)),(8,DATCHA2H)                               
*                                                                               
         L     RE,FULL                                                          
FDATO8   EQU   *                                                                
         MVI   5(R4),C'-'                                                       
         MVC   6(2,R4),DATCHA2H+3                                               
         CLC   DATCHAH(3),DATCHA2H                                              
         BER   RE                                                               
         MVC   6(5,R4),DATCHA2H                                                 
         BR    RE                                                               
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FORMAT TIMES                                                           
*-----------------------------------------------------------------              
*                                                                               
FTIM     DS    0H                                                               
         MVC   DUB(2),0(R3)                                                     
         LH    R1,DUB                                                           
         SR    R0,R0                                                            
         D     R0,=F'60'                                                        
         MHI   R1,100                                                           
         AR    R0,R1                                                            
         CHI   R0,2400                                                          
         BNH   *+8                                                              
         SHI   R0,2400                                                          
         STH   R0,DUB                                                           
         B     FTIM5                                                            
*                                                                               
FTIM4    DS    0H                                                               
         MVC   DUB(2),0(R3)                                                     
*                                                                               
FTIM5    DS    0H                                                               
         LR    R0,RE                                                            
         GOTO1 TIMUNPK,DMCB,DUB,(R4)                                            
         SPACE 1                                                                
         LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FOFILM - FIND ORDERED FILM                                             
*        R3 POINTS TO TRAFFIC SEQ NUMBER                                        
*        TEMPFILM HAS OUTPUT TO PRINT                                           
*-----------------------------------------------------------------              
*                                                                               
FOFILM   NTR1                                                                   
         LA    R2,WORK                                                          
         XC    WORK,WORK                                                        
         USING FLMTABD,R2                                                       
*                                                                               
         MVC   FLMSEQ,0(R3)                                                     
         GOTO1 BINSRCH,FLMTPARS,(2,FLMTABD) READ HIGH                           
         SR    R2,R2                                                            
         ICM   R2,7,1(R1)          DID WE FIND IT?                              
         BZ    FOF06                                                            
         CLI   0(R1),1                                                          
         BE    FOF06                                                            
         CLC   FLMSEQ,WORK+FLMSEQ-FLMTABD                                       
         BNE   FOF06                                                            
         MVC   TEMPFILM,SPACES                                                  
         MVC   TEMPFILM(L'FLMCOD),FLMCOD                                        
         CLC   FLMCOD,FLMADID      HAVE A PACKED COMMERCIAL?                    
         BE    *+12                YES - UNPACK IT!                             
         TM    IFCODADI,X'80'      WANT AD-ID BACK                              
         BNO   FOFILMX                                                          
         OC    FLMADID,FLMADID                                                  
         BZ    FOFILMX                                                          
         GOTO1 VTRPACK,DMCB,(C'U',FLMADID),TEMPFILM                             
         B     FOFILMX                                                          
*                                                                               
FOF06    DS    0H                  FILM NOT IN TABLE                            
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING CMLKEY,R4                                                        
         MVC   CMLPID,=X'0AA1'                                                  
         MVC   CMLPAM,BAGYMD                                                    
         OC    CMLPCLT,SVTRACLT    USE TRAFFIC OVERRIDE CLIENT                  
         BNZ   *+10                IF ANY                                       
         MVC   CMLPCLT,BCLT                                                     
         MVC   CMLPSEQ+1(2),0(R3)                                               
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    FOF10                                                            
         EDIT  (B2,0(R3)),(4,TEMPFILM+2),FILL=0                                 
         MVC   TEMPFILM(2),=C'**'                                               
         MVC   TEMPFILM+6(2),=C'**'                                             
         B     FOFILMX                                                          
*                                                                               
FOF10    DS    0H                                                               
         MVC   AREC,ADBUY                                                       
         GOTO1 GET                                                              
         L     R4,AREC                                                          
*                                                                               
         LA    R2,WORK             ADD TO BINSRCH TABLE                         
         XC    WORK,WORK                                                        
         MVC   FLMADID,SPACES                                                   
         MVC   FLMHDEF,SPACES                                                   
         MVC   FLMCNTR,SPACES                                                   
*                                                                               
         LA    R4,24(R4)                                                        
         CLI   0(R4),0                                                          
         BNE   *+6                                                              
         DC    H'0'                BAD FILM REC                                 
FOF12    DS    0H                                                               
         CLI   0(R4),0                                                          
         BE    FOF16                                                            
         CLI   0(R4),X'A0'         AD-ID ELEMENT                                
         BE    FOF14                                                            
         CLI   0(R4),X'24'         HDEF/CENTERCUT ELEM                          
         BE    FOF15                                                            
FOF13    LLC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         B     FOF12                                                            
*                                                                               
         USING CMLADIEL,R4                                                      
FOF14    DS    0H                                                               
         MVC   FLMADID(L'CMLADIDP),CMLADIDP    PACKED AD-ID                     
         B     FOF13                                                            
         DROP  R4                                                               
*                                                                               
         USING CMLXDTEL,R4                                                      
FOF15    DS    0H                                                               
         MVC   FLMHDEF(L'CMLXHDPK),CMLXHDPK                                     
         MVC   FLMCNTR(L'CMLXHDPK),CMLXCCPK                                     
         B     FOF13                                                            
         DROP  R4                                                               
*                                                                               
         USING CMLRECD,R4                                                       
FOF16    L     R4,ADBUY            POINT BACK TO KEY                            
         MVC   FLMSEQ,0(R3)        SEQ NUM                                      
         MVC   FLMCOD(L'CMLKCML),CMLKCML     TO SET 8 CHAR COMML                
         GOTO1 BINSRCH,FLMTPARS,(1,FLMTABD)  (OK IF TABLE FILLS UP)             
*                                                                               
         MVC   TEMPFILM(L'FLMCOD),FLMCOD                                        
         CLC   FLMCOD,FLMADID      HAVE A PACKED COMMERCIAL?                    
         BE    *+12                YES - UNPACK IT!                             
         TM    IFCODADI,X'80'      WANT AD-ID BACK                              
         BNO   FOFILMX                                                          
         GOTO1 VTRPACK,DMCB,(C'U',FLMADID),TEMPFILM                             
*                                                                               
FOFILMX  J     EXIT                                                             
         DROP  R2,R4                                                            
         EJECT                                                                  
*-----------------------------------------------------------------              
*        GETPGMN - GET NETPAK PROGRAM NAME FOR INVOICE ITEM                     
*-----------------------------------------------------------------              
*                                                                               
GETPGMN  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   WORK(5),BIGSTA                                                   
         L     RF,ADSTAT                                                        
         USING STAREC,RF                                                        
         CLC   SNTISTA,SPACES                                                   
         BNH   GPG05                                                            
         MVC   WORK(4),SNTISTA                                                  
         OC    WORK(5),SPACES                                                   
         DROP  RF                                                               
*                                                                               
GPG05    L     R8,0(R1)            A(IELEMD)                                    
         USING IELEMD,R8                                                        
         L     R5,4(R1)            A(PGM NAME) - OUTPUT                         
*                                                                               
         L     R4,=A(DBLOCKA)          DEBLOCK AREA                             
         A     R4,RELO                                                          
         USING DBLOCK,R4                                                        
         XC    0(L'DBLOCK,R4),0(R4)                                             
*                                                                               
         MVC   DBFILE,=C'NTI'                                                   
         MVC   DBCOMFCS,ACOMFACS                                                
         MVC   DBSELAGY,AGY                                                     
         MVC   DBAREC,ADBUY                                                     
         MVI   DBFUNCT,DBGETDEM                                                 
         MVI   DBSELSRC,C'N'       *??? ALWAYS NTI??                            
*                                                                               
GPG10    DS    0H                                                               
         MVC   DBSELMED,QMED                                                    
         MVC   DBSELDAY,IDAY       DAY OF WEEK                                  
         MVC   DBSELTIM(2),ITIM    TIME OF DAY                                  
         MVC   DBSELTIM+2(2),ITIM                                               
         MVC   DBSELSTA,WORK       NETWORK OR OVERRIDING NTI STA                
         MVI   DBSELSTA+4,C'T'     MAKE SURE BAND SET TO T                      
         GOTO1 DATCON,DMCB,(2,IDAT),DUB                                         
         MVC   DMCB+4(4),GETDAY                                                 
         MVC   DMCB+8(4),ADDAY                                                  
         GOTO1 =V(NETWEEK),DMCB,DUB,RR=RELO   GET WEEK (BOOK)                   
         MVC   DBSELBK(1),DMCB+4   YR                                           
         MVC   DBSELBK+1(1),DMCB+8 MONTH                                        
*                                                                               
         GOTO1 DEMAND,DMCB,DBLOCK,GPGHOOK                                       
         B     GPGX             NOTE-OUTPUT LEFT AS SPACES IF ERROR             
*                                                                               
GPGHOOK  NTR1                      DEMAND HOOK                                  
         OC    VDEFINE,VDEFINE                                                  
         BNZ   GPGH10                                                           
         MVC   DUB,=C'T00A26  '                                                 
         GOTO1 LOADER,DMCB,DUB,0                                                
         MVC   VDEFINE,DMCB+4                                                   
*                                                                               
GPGH10   GOTO1 VDEFINE,DMCB,=C'PROGRAM',DBLOCK,(R5)                             
         B     GPGX                                                             
*                                                                               
GPGX     DS    0H                                                               
         J     EXIT                                                             
         DROP  R4                                                               
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FORMAT TIMES - R3=A(TIME), R4=PRINTABLE, DUB=MILITARY TIME             
*-----------------------------------------------------------------              
*                                                                               
FMTTIM   NTR1  BASE=*,LABEL=*                                                   
         MVC   DUB(2),0(R3)                                                     
         LH    R1,DUB                                                           
         SR    R0,R0                                                            
         D     R0,=F'60'                                                        
         MHI   R1,100                                                           
         AR    R0,R1                                                            
         CHI   R0,2400                                                          
         BNH   *+8                                                              
         SHI   R0,2400                                                          
         STH   R0,DUB                                                           
         B     FMTTIM5                                                          
*                                                                               
FMTTIM4  DS    0H                                                               
         MVC   DUB(2),0(R3)                                                     
*                                                                               
FMTTIM5  DS    0H                                                               
         GOTO1 TIMUNPK,DMCB,DUB,(R4)                                            
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FORMAT UNORDERED INVOICE ITEMS                                         
*-----------------------------------------------------------------              
*                                                                               
FMTUNORD NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R2,P1                                                            
         USING LNBD,R2                                                          
         MVC   LNB,SPACES                                                       
*                                                                               
         TM    ISTAT,X'04'         TEST MAKE-GOOD                               
         BZ    *+10                                                             
         MVC   LNBDTE-3(2),=C'MG'                                               
*                                                                               
         LA    R3,IDAT                                                          
         LA    R4,LNBDTE                                                        
         BRAS  RE,FDATI                                                         
         MVC   HALF(1),IDAY        DAY OF WEEK                                  
         MVI   HALF+1,0            START/END DAYS NOT NEEDED                    
         LA    R3,HALF                                                          
         LA    R4,LNBDAY                                                        
         BRAS  RE,FDAY                                                          
*                                                                               
         LA    R3,ITIM                                                          
         LA    R4,LNBTIM                                                        
         BAS   RE,FTIMUNO                                                       
         MVC   ITIM,DUB            PUT MIL. TIME IN INV ELEM                    
         CLI   LNBTIM,X'F0'                                                     
         BNE   *+8                                                              
         MVI   LNBTIM,X'40'                                                     
*                                                                               
         TM    ISTAT2,X'20'        TEST INTERVAL ERROR - SECONDARY              
         BZ    *+8                                                              
         MVI   LNBTIM-1,C'+'                                                    
         TM    ISTAT2,X'40'        PRIMARY                                      
         BZ    *+8                                                              
         MVI   LNBTIM-1,C'*'                                                    
         TM    ISTAT,X'20'         TEST IGNORE PRIMARY INTVL CHK                
         BZ    *+8                                                              
         MVI   LNBTIM-1,C'='                                                    
*                                                                               
         TM    ISTAT,X'02'         TEST IGNORE TIME FOR MATCH                   
         BZ    *+8                                                              
         MVI   LNBTIM+5,C'T'       MARK WITH 'T' AFTER TIME                     
*                                                                               
         EDIT  ILEN,(3,LNBLEN)                                                  
*                                                                               
         CLI   NETPSW,C'Y'          NETPAK?                                     
         BNE   FMTUN0A              NO                                          
         MVC   LNBPRD(3),IPRDNT     MOVE IN 3 CHARACTER PRODUCT                 
         CLI   IPRD2NT,0            HAVE 3 CHAR PRD2?                           
         BE    FMTUN0B              NO                                          
         MVI   LNBPRD+3,C'-'                                                    
         MVC   LNBPRD+4(3),IPRD2NT  MOVE IN 3 CHAR PRD2                         
         B     FMTUN0B                                                          
*                                                                               
FMTUN0A  LA    R3,IPRD                                                          
         LA    R4,LNBPRD                                                        
         BRAS  RE,FPRD                                                          
*                                                                               
FMTUN0B  CLI   IEST,0              TEST HAVE EST                                
         BE    FMTUN1                                                           
         LLC   R0,IEST                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         LA    RF,LNBPRD+3                                                      
         CLI   1(RF),C' '                                                       
         BNH   *+8                                                              
         LA    RF,LNBPRD+7                                                      
         MVI   0(RF),C'-'                                                       
         UNPK  1(3,RF),DUB                                                      
*                                                                               
FMTUN1   DS    0H                                                               
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BNE   FMTUN1D                                                          
         MVC   DUB(4),ICOST                                                     
         L     R1,DUB                                                           
         TM    ISTAT,X'01'         TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         CLI   CENTS,C'Y'          TEST HAVE PENNIES                            
         BE    *+8                                                              
         M     R0,=F'100'          SET COST IN R1                               
         MVC   HALF,LNBCOST        MAY HAVE PRD/PIGGY/EST                       
*                                                                               
FMTUN1B  EDIT  (R1),(11,LNBCOST),2,FLOAT=-                                      
         CLC   LNBCOST(2),SPACES   DID WE USE THE FIRST 2 BYTES?                
         BH    *+10                YES - COST WINS                              
         MVC   LNBCOST(2),HALF     NO RESTORE EST IF IT WAS THERE               
*                                                                               
         CLI   PSEUDOPT,C'R'       IF DOING RESPONSES                           
         BNE   FMTUN1D                                                          
         EDIT (B4,ICOST),(11,LNBCOST),COMMAS=YES,MINUS=YES,ZERO=NOBLANK         
         CLC   LNBCOST(2),SPACES   DID WE USE THE FIRST 2 BYTES?                
         BH    *+10                YES - COST WINS                              
         MVC   LNBCOST(2),HALF     NO RESTORE EST IF IT WAS THERE               
*                                                                               
FMTUN1D  DS    0H                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   FMTUN1DX                                                         
         CLI   IPKG,0                                                           
         BE    FMTUN1DX                                                         
         LLC   R0,IPKG                                                          
         EDIT  (R0),(3,LNBPKG),FILL=0                                           
*                                                                               
FMTUN1DX DS    0H                                                               
         TM    CBLHOPT,CBLHNHAQ    IF CBH REQ AND NEW MODE                      
         BNO   FMTUN1F             AND 'ALL NETS'                               
*                                  SHOW NETWORK                                 
         XC    DUB,DUB                                                          
         MVC   DUB+2(3),BMKTSTA+2                                               
         NI    DUB+4,X'80'                                                      
         OC    DUB+4(1),ICBLNET                                                 
         GOTO1 MSUNPK,DMCB,(X'80',DUB),WORK,WORK+4                              
         MVC   LNBNTWK,WORK+9                                                   
*                                                                               
FMTUN1F  DS    0H                                                               
         CLI   TRAFSW,C'Y'         TEST ON TRAFFIC                              
         BNE   FMTUN1G                                                          
         CLI   I2CPROF+1,C'Y'      DISP 'NONE' FOR MISSING FILMS?               
         BNE   *+10                NO                                           
         MVC   LNBFILM(4),=C'NONE' YES - DISPLAY "NONE"                         
*                                                                               
         CLI   IFILM,0             TEST HAVE FILM CODE                          
         BE    FMTUN1F1                                                         
*                                                                               
         MVI   IFCODADI,0                                                       
         TM    ISTAT3,IST3ADID     COMML IS AD-ID?                              
         BNO   *+8                                                              
         OI    IFCODADI,X'80'                                                   
         TM    ISTAT3,IST3HDEF     COMML IS HDEF?                               
         BNO   *+8                                                              
         OI    IFCODADI,X'40'                                                   
         TM    ISTAT4,IST4CNTR     INVOICE COMML IS CENTERCUT                   
         BNO   *+8                                                              
         OI    IFCODADI,X'20'      TELL FFILM                                   
*                                                                               
         LA    R3,IFILM                                                         
         LA    R4,LNBFILM                                                       
         BRAS  RE,FFILM                                                         
         TM    ISTAT2,X'02'        IGNORE FILM?                                 
         BZ    *+8                 NO                                           
         MVI   LNBPKG+5,C'*'       YES MARK WITH '*' BEFORE FILMCODE            
         CLI   I2CPROF+5,C'Y'      PRD, FLT, TIM, REL, INV = FILM ERR?          
         BNE   FMTUN1F1            NO                                           
         CLI   12(R4),C'*'         INVALID FILM ERROR                           
         BNE   FMTUN1F1            NO                                           
         MVI   FILMDSCP,C'Y'       YES - FLAG IT!                               
*                                                                               
FMTUN1F1 CLI   IPRD2,0             HAVE PIGGY?                                  
         BNE   *+12                YES                                          
         CLI   IPRD2NT,0           HAVE PIGGY?                                  
         BE    FMTUN1F2            NO                                           
         CLI   I2CPROF+1,C'Y'      DISP 'NONE' FOR MISSING FILMS?               
         BNE   *+10                NO                                           
         MVC   LNBFILM+132(4),=C'NONE'   YES - DISPLAY "NONE"                   
*                                                                               
FMTUN1F2 CLI   IFILM2,0            TEST HAVE 2ND FILM                           
         BE    FMTUN1E                                                          
         LA    R3,IFILM2                                                        
         LA    R4,LNBFILM+132                                                   
         BRAS  RE,FFILM                                                         
         CLI   I2CPROF+5,C'Y'      PRD, FLT, TIM, REL, INV = FILM ERR?          
         BNE   FMTUN1E             NO                                           
         CLI   12(R4),C'*'         INVALID FILM ERROR                           
         BNE   FMTUN1E             NO                                           
         MVI   FILMDSCP,C'Y'       YES - FLAG IT!                               
*                                                                               
FMTUN1E  DS    0H                                                               
         CLI   IFILM,0             TEST HAVE FILM CODE                          
         BE    FMTUN1G                                                          
*                                                                               
         TM    ISTAT,INVSBLBQ      TEST BILLBOARD                               
         BZ    *+10                                                             
         MVC   8(2,R4),=C'-B'                                                   
*                                                                               
         TM    FLMCHK,FLMCFLT      ARE WE CHECKING MATCH DATES                  
         BNO   *+22                                                             
         TM    ISTAT3,IST3FLTF     TEST FILM MATCHING DATES OK                  
         BZ    *+14                                                             
         LA    RF,LNBFILM-2                                                     
         MVC   0(2,RF),=C'F*'                                                   
*                                                                               
         TM    FLMCHK,FLMCTIM      ARE WE CHECKING MATCH TIMES                  
         BNO   *+22                                                             
         TM    ISTAT3,IST3TIMF     TEST FILM MATCHING TIMES OK                  
         BZ    *+14                                                             
         LA    RF,LNBFILM-2                                                     
         MVC   0(2,RF),=C'T*'                                                   
*                                                                               
         TM    FLMCHK,FLMCRR       ARE WE CHECKING RR DATES                     
         BNO   *+22                                                             
         TM    ISTAT2,X'04'        TEST FILM DATES OK                           
         BZ    *+14                                                             
         LA    RF,LNBFILM-2                                                     
         MVC   0(2,RF),=C'R*'                                                   
*                                                                               
         TM    FLMCHK,FLMCPRD      ARE WE CHECKING MATCH TIMES                  
         BNO   *+22                                                             
         TM    ISTAT,ISTPRDF       TEST FILM PRODUCTS OK                        
         BZ    *+14                                                             
         LA    RF,LNBFILM-2                                                     
         MVC   0(2,RF),=C'P*'                                                   
*                                                                               
         TM    FLMCHK,FLMCLEN      ARE WE CHECKING MATCH LEN                    
         BNO   *+22                                                             
         TM    ISTAT4,IST4LENF     TEST FILM LEN OK                             
         BZ    *+14                                                             
         LA    RF,LNBFILM-2                                                     
         MVC   0(2,RF),=C'L*'                                                   
*                                                                               
FMTUN1G  DS    0H                                                               
         CLI   QBOOK1,C' '         TEST DEMO RUN                                
         BE    FMTUN6               NO                                          
         CLI   DIGITAL,C'Y'        DIGITAL REQUEST?                             
         BE    FMTUN6              YES - SUPPRESS DEMO                          
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    FMTUN6              YES - SUPPRESS DEMOS                         
         L     R3,DEMPARS+4                                                     
         LA    R4,W                                                             
         L     R0,DEMPARS+8                                                     
         LTR   R0,R0                                                            
         BNP   FMTUN6                                                           
         XC    W,W                                                              
         XC    FULL,FULL                                                        
*                                                                               
FMTUN2   DS    0H                                                               
         MVC   0(3,R4),0(R3)                                                    
*                                                                               
         CLC   0(3,R3),DCLIST      IF FIRST DEMO FOR REQ                        
         BNE   *+8                                                              
         ST    R4,FULL             SAVE POSITION IN W                           
*                                                                               
         LA    R4,8(R4)                                                         
         A     R3,DEMPARS+12                                                    
         BCT   R0,FMTUN2                                                        
*                                                                               
         OC    W,W                 TEST ANY DEMOS                               
         BZ    FMTUN3                                                           
         GOTO1 AACHDEM,DMCB,IELEM,W,0    (NO BUY RECORD)                        
*                                                                               
FMTUN3   DS    0H                                                               
         L     R4,FULL            POSITION IN W OF 1ST DEMO FOR REQ             
         MVC   IDEMVR,4(R4)       SAVE IN IELEM                                 
         L     R3,DEMPARS+4                                                     
         LA    R4,W                                                             
         L     RE,DEMPARS+8                                                     
         LA    R5,LNBADEM                                                       
         USING DTABD,R3                                                         
FMTUN4   DS    0H                                                               
         L     RF,DTABUACH                                                      
         N     RF,=X'3FFFFFFF'     DROP 2-DEC FLAG                              
         L     R0,4(R4)                                                         
         N     R0,=X'3FFFFFFF'                                                  
         AR    RF,R0                                                            
         TM    4(R4),X'40'                                                      
         BZ    *+8                                                              
         O     RF,=X'40000000'                                                  
         ST    RF,DTABUACH                                                      
*                                                                               
         TM    4(R4),X'40'                                                      
         BO    FMTUN4A                                                          
         EDIT  (R0),(6,(R5)),1                                                  
         B     FMTUN4B                                                          
*                                                                               
FMTUN4A  BCTR  R5,0                                                             
         EDIT  (R0),(7,(R5)),2                                                  
         AHI   R5,1                                                             
*                                                                               
FMTUN4B  LA    R5,9(R5)                                                         
         LA    R4,8(R4)                                                         
         A     R3,DEMPARS+12                                                    
         BCT   RE,FMTUN4                                                        
         DROP  R3                                                               
*                                                                               
FMTUN6   DS    0H                  SHOW INVOICE NUMBER                          
         L     R4,AINOLST                                                       
         USING INOLSTD,R4                                                       
FMTUN7   CLC   IINVID,INOLNUM      SAME INTERNAL INVOICE NUMBER                 
         BE    FMTUN8                                                           
         AH    R4,INOLSTQ          NEXT INVOICE                                 
         CLI   0(R4),C' '          ANY MORE                                     
         BH    FMTUN7                                                           
         B     FMTUN10             JUST SKIP THEN                               
FMTUN8   MVC   LNBINV,INOLINV      INVOICE NUMBER                               
         CLI   DIGITAL,C'Y'        DIGITAL REQUEST?                             
         BNE   *+14                NO                                           
         BRAS  RE,FMTDINV          YES - REPORT INV DEMO LINE                   
         MVC   LNBERRS-1(35),WORK+9  INVOICE DEMO LINE                          
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   FMTUN11             NO                                           
         GOTO1 VRCPACK,DMCB,(C'U',INOLREP),LNBIREP                              
         DROP  R4                                                               
*                                                                               
FMTUN10  DS    0H                                                               
         CLI   NETPSW,C'Y'         ONLY FOR NETPAK                              
         BNE   FMTUN11                                                          
         CLI   PROGOPT,C'N'        ONLY IF OPTION ON                            
         BE    FMTUN11                                                          
         GOTOR GETPGMN,DMCB,IELEMD,LNBDTE+132   PROGRAM NAME                    
*                                                                               
FMTUN11  GOTO1 AIRPRT                                                           
*                                                                               
FMTUNX   EQU   *                                                                
         J     EXIT                                                             
*                                                                               
FTIMUNO  DS    0H                                                               
         MVC   DUB(2),0(R3)                                                     
         LR    R0,RE                                                            
         GOTO1 TIMUNPK,DMCB,DUB,(R4)                                            
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FORMAT PRODUCTS                                                        
*-----------------------------------------------------------------              
*                                                                               
FPRD     NTR1  BASE=*,LABEL=*                                                   
         LR    R0,RE                                                            
         MVC   0(7,R4),SPACES                                                   
         BAS   RE,FPRDC                                                         
         CLI   1(R3),0                                                          
         BE    FPRDX                                                            
         MVI   3(R4),C'-'                                                       
         LA    R3,1(R3)                                                         
         LA    R4,4(R4)                                                         
         BAS   RE,FPRDC                                                         
FPRDX    DS    0H                                                               
         LR    RE,R0                                                            
         J     EXIT                                                             
*                                                                               
FPRDC    DS    0H                                                               
         CLI   0(R3),0                                                          
         BER   RE                                                               
         MVC   0(3,R4),PRD                                                      
         CLC   0(1,R3),BPRD                                                     
         BER   RE                                                               
         L     R1,ADCLT                                                         
         LA    R1,CLIST-CLTHDR(R1)                                              
         LA    RF,220              220 PRODS IN CLIST                           
FPRDC2   DS    0H                                                               
         CLI   3(R1),0                                                          
         BER   RE                                                               
         CLC   0(1,R3),3(R1)                                                    
         BE    FPRDC3                                                           
         LA    R1,4(R1)                                                         
         BCT   RF,FPRDC2                                                        
*                                                                               
         CLI   NETPSW,C'Y'         TEST NETPAK                                  
         BE    *+6                 ONLY CLIST2 FOR NET                          
         DC    H'0'                                                             
*                                                                               
         L     R1,ADCLT                                                         
         LA    R1,CLIST2-CLTHDR(R1)                                             
         LA    RF,35               35 PRODUCTS IN CLIST2                        
FPRDC2A  CLI   3(R1),0                                                          
         BER   RE                                                               
         CLC   0(1,R3),3(R1)                                                    
         BE    FPRDC3                                                           
         LA    R1,4(R1)                                                         
         BCT   RF,FPRDC2A                                                       
         DC    H'0'                                                             
*                                                                               
FPRDC3   DS    0H                                                               
         MVC   0(3,R4),0(R1)                                                    
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        DAY OF WEEK                                                            
*-----------------------------------------------------------------              
*                                                                               
FDAY     NTR1  BASE=*,LABEL=*                                                   
         CLC   DAYINBH,0(R3)       TEST SAME DAY AND START/END                  
         BE    FDAY2                                                            
         ST    RE,FULL                                                          
         GOTO1 CODAY,DMCB,(1(R3),0(R3)),DAYOTH                                  
         MVC   DAYINBH,0(R3)                                                    
         L     RE,FULL                                                          
FDAY2    MVC   0(8,R4),DAYOTH                                                   
         J     EXIT                                                             
*                                                                               
*        DATE FORMAT - INVOICE                                                  
*                                                                               
FDATI    NTR1  BASE=*,LABEL=*                                                   
         CLC   DATINBH,0(R3)                                                    
         BE    FDATI2                                                           
         ST    RE,FULL                                                          
         MVC   DATINBH,0(R3)                                                    
         GOTO1 DATCON,DMCB,(2,0(R3)),(8,DATCHAH)                                
         L     RE,FULL                                                          
FDATI2   MVC   0(5,R4),DATCHAH                                                  
         J     EXIT                                                             
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FFILM - FORMAT FILMS                                                   
*        R3 POINTS TO TRAFFIC SEQ NUMBER                                        
*        R4 POINTS TO OUTPUT LINE TO PRINT TO                                   
*-----------------------------------------------------------------              
*                                                                               
FFILM    NTR1  BASE=*,LABEL=*      FORMAT FILMS                                 
         ICM   R0,15,FLMTPARS+8                                                 
         BZ    FFX                 NO FILMS                                     
         L     R2,AFLMTAB                                                       
         USING FLMTABD,R2                                                       
*                                                                               
FF4      DS    0H                                                               
         CLC   FLMIDNO,IINVID      TST FROM RIGHT INVOICE/RSET                  
         BNE   FF10                                                             
         CLC   FLMICOD,0(R3)       INTERNAL FILM NO.                            
         BNE   FF10                                                             
*                                                                               
***      TM    IFCODADI,X'20'      LOOK FOR CENTERCUT ENTRY?                    
***      BZ    FF4A                NO                                           
***      OC    FLMCPTR,FLMCPTR     YES - IS THIS A CENTERCUT POINTER?           
***      BZ    FF10                NO - KEEP LOOKING FOR CENTERCUT              
***      B     FF4B                                                             
*                                                                               
FF4A     OC    FLMCPTR,FLMCPTR     IS THIS A CENTERCUT POINTER?                 
         BNZ   FF10                YES - IGNORE!                                
*                                                                               
FF4B     MVC   0(8,R4),FLMCOD      SET FILM CODE                                
*                                                                               
         OC    FLMSEQ,FLMSEQ       TEST HAVE CMML SEQ NO                        
         BNZ   *+8                 IE- TEST IF REAL FILM                        
         MVI   12(R4),C'*'         SET NOT REAL FILM                            
*                                                                               
         LA    R5,FLMHDEF                                                       
         TM    IFCODADI,X'40'      INVOICE HAS HDEF ON IT                       
         BO    FF5                 SO PRINT HDEF                                
***      LA    R5,FLMCNTR                                                       
***      TM    IFCODADI,X'20'      MATCHED AS A CENTERCUT ENTRY?                
***      BO    FF5                 YES                                          
         LA    R5,FLMADID                                                       
         TM    IFCODADI,X'80'      INVOICE HAS AD-ID ON IT                      
         BO    FF5                 SO PRINT AD-ID                               
         CLC   FLMCOD,SPACES       IF NO 8 CHAR                                 
         BH    FF6                                                              
FF5      GOTO1 VTRPACK,DMCB,(C'U',0(R5)),0(R4)    12 CHAR AD-ID/HDEF            
*                                                                               
FF6      CLI   PAGSW,C'U'          IF NOT FROM FMTUNORD                         
         BE    FFX                                                              
*                                                                               
         TM    IFCODADI,X'40'      HDEF?                                        
         BO    FF06A               YES                                          
***      TM    IFCODADI,X'20'      MATCHED AS A CENTERCUT ENTRY?                
***      BO    FF06A               YES                                          
         TM    IFCODADI,X'80'      AD-ID?                                       
         BZ    FF07                NO                                           
*                                                                               
FF06A    GOTO1 VTRPACK,DMCB,(C'U',0(R5)),0(R4)    12 CHAR AD-ID/HDEF            
         MVC   TEMPFILM(L'FLMADID),0(R5)  TEMPFILM TO PACKED ADID/HDEF          
*                                                                               
FF07     CLI   TRAFRCLO,C'E'       IF RECALL/RELEASE ERROR                      
         BNE   FFX                 IS NON-DISCRPANT ERROR                       
*                                  JUST FLAG HERE                               
         CLC   IDAT-IELEMD(2,R8),FLMRCL                                         
         BH    FF08                                                             
         CLC   IDAT-IELEMD(2,R8),FLMRLSE                                        
         BNL   FFX                                                              
*                                                                               
FF08     DS    0H                                                               
         MVC   12(2,R4),=C'*R'                                                  
         B     FFX                                                              
*                                                                               
FF10     DS    0H                                                               
         LA    R2,FLMTABEL(R2)                                                  
         BCT   R0,FF4                                                           
*                                                                               
FFX      J     EXIT                                                             
         DROP  R2                                                               
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        REMATCH FEATURE - LOOKS FOR UNIT THAT WAS LAST MATCHED TO              
*        THIS INVOICE DETAIL FIRST AND RETURNS TO MATCH CODE                    
*        POINTING TO UNIT TO SEE IF STILL MATCHES                               
*        R8 POINTS TO INVOICE - R7 TO UNIT                                      
*-----------------------------------------------------------------              
*                                                                               
         USING BYELEMD,R7                                                       
         USING IELEMD,R8                                                        
REMATCH  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         NI    REMFLAG,X'FF'-(REMFOUND+REMNOFLM)                                
*                                                                               
REM10    C     R7,ALBY                                                          
         BH    REMXNO              SAY NO IF CAN'T FIND LAST MATCH              
*                                                                               
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   REM20               NO                                           
         OC    IMATDATE,IMATDATE   WAS NOT MATCHED LAST TIME                    
         BZ    REMXNO                                                           
*                                                                               
         CLC   IMATDATE,BYACTDAT   MATCH ON LAST MATCHED UNIT DATE              
         BNE   REM30                                                            
         CLC   IMATSQH,BYACTSQH    TIME - QUARTER HOURS                         
         BNE   REM30                                                            
         CLC   IMATEST,BYEST       ESTIMATE                                     
         BNE   REM30                                                            
         CLC   IMATSPT,BYSPT       UNIT SEQ NUMBER                              
         BNE   REM30                                                            
         CLC   IMATDP,BYACTDP      DAYPART                                      
         BNE   REM30                                                            
         CLC   IMATPRG,BYACTPRG    PROGRAM                                      
         BE    REM50                                                            
         B     REM30                                                            
*                                                                               
REM20    OC    IMATSDAT,IMATSDAT   WAS NOT MATCHED LAST TIME                    
         BZ    REMXNO                                                           
*                                                                               
         CLC   IMATSEST,BYEST      ESTIMATE                                     
         BNE   REM30                                                            
         CLC   IMATSLIN,BYLIN      LINE                                         
         BNE   REM30                                                            
         CLC   IMATSDAT,BYSDT      DATE                                         
         BNE   REM30                                                            
         CLC   IMATSNUM,BYSPT      SPOT NUMBER WITHIN DATE                      
         BNE   REM30                                                            
         CLC   IMATSORB,BYORBNO    ORBIT LINE NUMBER                            
         BE    REM50                                                            
*                                                                               
REM30    LA    R7,BYELEML(R7)                                                   
         B     REM10                                                            
*                                                                               
REM50    CLI   I2APROF+12,C'P'     REMATCH ONLY IF PAID                         
         BNE   REM60                                                            
         TM    BYSTAT,X'40'        PAID                                         
         BNO   REMXNO                                                           
*                                                                               
REM60    OI    REMFLAG,REMFOUND                                                 
         CLI   I2APROF+13,C'Y'     SKIP FILM MATCH STUFF ON REMATCH             
         BNE   REMYES                                                           
         OI    REMFLAG,REMNOFLM    SET FLAG HERE                                
         B     REMYES              FOUND - RETURN R7 POINT TO UNIT              
*                                                                               
REMXNO   J     EXIT                EXIT W/O RETURNING R7!!                      
REMYES   XIT1  REGS=(R7)                                                        
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*-----------------------------------------------------------------              
*        DO AUTOPAY THINGS                                                      
*-----------------------------------------------------------------              
*                                                                               
DOAUTPAY NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   PSTOPT,C'Y'         POST AFFIDS=Y?                               
         BE    *+12                YES                                          
         CLI   PSTOPT,C'P'         POST AFFIDS=PARTIAL (YES)?                   
         BNE   DAPX                NO - DON'T WRITE AUTOPAY REC!                
         CLC   QUESTOR,=C'!@AUTOPAYSOO'    ALLOW SOON AUTOPAY                   
         BE    DAP20               RECORDS WHEN RUNNING SOON!!!!                
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK -                                 
         BNE   DAP10                                                            
         CLI   QPGR,C' '           TEST PRDGRP REQUEST                          
         BNE   DAPX                YES -SKIP FOR NOW = NO AUTOPAY               
*                                                                               
DAP10    L     R1,VMASTC           A(DDMASTD)                                   
         USING MASTD,R1                                                         
         OC    MCREMPQK,MCREMPQK   SOON?                                        
         BNZ   DAPX                NOT ZERO = SOON = SKIP AUTOPAY               
         DROP  R1                                                               
*                                                                               
DAP20    CLI   PROGPROF+15,C'Y'    AUTOPAY MATCHED INVOICES?                    
         BE    DAP30                                                            
         CLI   PROGPROF+15,C'O'    AUTOPAY MATCHED INVOICES?                    
         BNE   DAPX                ONLY IF NO ONR                               
*                                                                               
DAP30    OC    I2PPROF(2),I2PPROF  EFFECTIVE DATE FOR AUTOPAY?                  
         BZ    DAP40                                                            
         LLC   R1,I2PPROF                                                       
         CLI   I2PPROF,80          IF YEAR < 80 ADD 100 FOR CENTURY             
         BH    *+8                                                              
         AHI   R1,100                                                           
         STC   R1,I2PPROF                                                       
         GOTO1 DATCON,DMCB,(2,BQENDP),(3,WORK)                                  
         CLC   WORK(2),I2PPROF     IS MONTH OF REQ BEFORE EFF DATE              
         BL    DAPX                YES THEN DON'T AUTOPAY                       
*                                                                               
DAP40    CLC   =C'CK',QAGY         FOR COKE                                     
         BNE   DAP50                                                            
         CLI   QAREA+31,C'Z'       TEST A Z5 RUN                                
         BNE   DAPX                SKIP NON Z5 REQUESTS FOR COKE                
         B     DAP70               PROCESS UNSUCCESSFUL MATCHES TOO             
*                                                                               
DAP50    CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   DAP60                                                            
         CLI   PROGPROF+15,C'O'    NO AUTOPAY IF ONRS ?                         
         BNE   DAP70                                                            
         OC    ONRSPTS,ONRSPTS                                                  
         BNZ   DAPX                                                             
         B     DAP70               NETPAK PAYS MATCHED INVOICES                 
*                                                                               
DAP60    CLI   MATSTAT,0           MATCHED? - SPOTPAK                           
         BNE   DAPX                SKIP UNSUCCESSFUL MATCHES                    
*                                                                               
DAP70    GOTO1 =V(SPI2AP)          GENERATE AUTOPAY RECS                        
         TM    APSTATUS,APSREQ     REQUEST ALREADY ADDED?                       
         BO    DAP80                                                            
*                                                                               
         CLC   QUESTOR,=C'!@AUTOPAYSOO'    ALLOW SOON AUTOPAY                   
         BE    DAP80                                                            
*                                                                               
         MVC   WORK(80),QAREA                                                   
         MVC   WORK+61(7),SPACES   DON'T PASS IN QOPTS OR QGRP!                 
         MVC   WORK(2),=C'IP'                                                   
         L     R1,=A(IPRQFIL)                                                   
         LA    R0,WORK                                                          
         PUT   (1),(0)                                                          
         OI    APSTATUS,APSREQ     REQUEST ALREADY ADDED                        
DAP80    DS    0H                                                               
*                                                                               
DAPX     DS    0H                  RESET FOR NEXT MATCH                         
         MVI   ALLPAID,C'Y'        DEFAULT IS PAID/AUTOPAY                      
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FORMAT DEMOS                                                           
*-----------------------------------------------------------------              
*                                                                               
FDEM     NMOD1 0,FDEM                                                           
         LA    RC,SPACEND                                                       
         USING LNAD,R2                                                          
*                                                                               
         CLI   NETPSW,C'Y'         IF NET, SKIP (BYDEMVR NOT NULL NOW)          
         BE    FDEMX               Z7 CREATES NET I2 W/ACT BOOK                 
         CLI   QBOOK1,C' '         TEST DEMO RUN                                
         BE    FDEMX               ND                                           
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BE    FDEMX               YES                                          
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    FDEMX               YES                                          
*                                                                               
         LA    R4,X                                                             
         XC    X,X                                                              
         USING DTABD,R4                                                         
         SR    R0,R0                                                            
         ICM   R0,15,BYDEMV                                                     
         N     R0,=X'3FFFFFFF'     DROP FLAGS                                   
*                                                                               
         TM    BYSTAT,X'01'        FOR UNMATCHED ORBITS                         
         BO    FDEM3               BYPASS ADDING TO TOTALS                      
         TM    BYSTAT2,BYSTMISQ    AND FOR MISSED SPOTS                         
         BNZ   FDEM3                                                            
*                                                                               
         L     R1,ODEMEST                                                       
         N     R1,=X'3FFFFFFF'                                                  
         AR    R1,R0                                                            
         ST    R1,ODEMEST                                                       
         TM    BYDEMV,X'40'        TEST 2-DEC VALUE                             
         BZ    *+8                 NO                                           
         OI    ODEMEST,X'40'                                                    
*                                                                               
         L     R1,EDEMEST                                                       
         AR    R1,R0                                                            
         ST    R1,EDEMEST                                                       
         TM    BYDEMV,X'40'        TEST 2-DEC VALUE                             
         BZ    *+8                                                              
         OI    EDEMEST,X'40'                                                    
*                                                                               
FDEM3    ST    R0,DTABEST                                                       
         TM    BYDEMV,X'40'        TEST 2-DEC                                   
         BZ    *+8                                                              
         OI    DTABEST,X'40'       SET 2-DEC FLAG                               
*                                                                               
         TM    BYDEMV,X'40'        TEST 2-DEC                                   
         BO    FDEM3A                                                           
         EDIT  (R0),(6,LNAEDEM),1                                               
         B     FDEM3B                                                           
FDEM3A   EDIT  (R0),(7,LNAEDEM-1),2                                             
*                                                                               
FDEM3B   TM    BYSTAT,X'80'        TEST SPECIAL                                 
         BZ    FDEM3F                                                           
*                                  SPECIAL -S                                   
         CLC   LNAIND(2),SPACES                                                 
         BNE   *+14                                                             
         MVC   LNAIND(2),=C'-S'                                                 
         B     FDEM3F                                                           
*                                                                               
         LA    RF,LNAIND                                                        
         LA    RE,LNAROT                                                        
FDEM3C   DS    0H                  PUT S IN FIRST AVAILABLE SPOT                
         CLI   0(RF),C' '                                                       
         BE    FDEM3D                                                           
         LA    RF,1(RF)                                                         
         CR    RF,RE                                                            
         BL    FDEM3B                                                           
FDEM3D   DS    0H                                                               
         MVI   0(RF),C'S'                                                       
*                                                                               
FDEM3F   DS    0H                                                               
         CLI   HAVINV,C'Y'         TEST HAVE INVOICE DATA                       
         BNE   FDEM5B              NO                                           
         MVC   IDEMVR,BYDEMVR      SAVE REQ DEMO IN IELEM                       
         ST    R0,FULL             SET EST DEMO AS ACTUAL                       
         TM    BYDEMV,X'40'                                                     
         BZ    *+8                                                              
         OI    FULL,X'40'          SET 2-DEC FLAG                               
***                                                                             
* COMMENTED OUT THE NEXT 4 INSTRUCTIONS BECAUSE THEY DONT DO ANYTHING           
***                                                                             
***      TM    BYSTAT,X'80'        TEST SPECIAL (S)                             
***      BZ    FDEM3G              NO - LOOK UP DEMO                            
***      CLI   SPCRRTE,C'Y'        TEST SPECIAL RERATE OPT                      
***      B     FDEM3G              FORCE TO ALWAYS DO LOOKUP                    
*                                                                               
FDEM3G   XC    W,W                                                              
*                                                                               
         MVC   W(3),DCLIST         ALWAYS DO 1ST REQ DEMO                       
         MVC   W+4(4),BYDEMVR      VALUE TOO                                    
*                                                                               
         CLI   BYDEMC,1                                                         
         BNH   FDEM3H                                                           
*                                                                               
         LLC   RF,BYDEMC           DEMO FOR THIS BUY IF DIFFERENT               
         SLL   RF,2                                                             
         LA    RF,DCLIST-4(RF)                                                  
         MVC   W+8(3),0(RF)                                                     
         MVC   W+12(4),BYDEMV      VALUE TOO                                    
*                                                                               
FDEM3H   OC    W,W                 TEST ANY DEMOS                               
         BZ    FDEM3J                                                           
         LA    R0,BYELEM           BUY ENTRY TO ACHDEM                          
         GOTO1 AACHDEM,DMCB,IELEM,W,(R0)                                        
*                                                                               
FDEM3J   MVC   IDEMVR,W+4          SAVE REQ DEMO IN IELEM                       
*                                                                               
         MVC   FULL,W+4            USE DEMO FOR REQ                             
         CLI   BYDEMC,1            IF SAME AS FOR BUY                           
         BNH   *+10                                                             
         MVC   FULL,W+12           ELSR USE DEMO FOR EST                        
         L     R0,FULL                                                          
         N     R0,=X'3FFFFFFF'     DROP FLAGS                                   
         ST    R0,DTABOACH                                                      
         TM    FULL,X'40'                                                       
         BZ    *+8                                                              
         OI    DTABOACH,X'40'                                                   
*                                                                               
         L     R1,ODEMACH                                                       
         N     R1,=X'3FFFFFFF'                                                  
         AR    R1,R0                                                            
         TM    FULL,X'40'          TEST 2-DEC                                   
         BZ    *+8                                                              
         O     R1,=X'40000000'     SET 2-DEC FLAG                               
         ST    R1,ODEMACH                                                       
*                                                                               
         L     R1,EDEMACH                                                       
         N     R1,=X'3FFFFFFF'                                                  
         AR    R1,R0                                                            
         TM    FULL,X'40'                                                       
         BZ    *+8                                                              
         O     R1,=X'40000000'                                                  
         ST    R1,EDEMACH                                                       
*                                                                               
         TM    FULL,X'40'          TEST 2-DEC                                   
         BO    FDEM5A                                                           
         EDIT  (R0),(6,LNAADEM),1                                               
         B     FDEM5B                                                           
FDEM5A   EDIT  (R0),(7,LNAADEM-1),2                                             
*                                                                               
FDEM5B   TM    BYDEMV,X'80'        TEST OVERRIDE                                
         BZ    FDEM5C                                                           
         CLI   LNAEDEM+6,C' '                                                   
         BH    *+8                                                              
         MVI   LNAEDEM+6,C'*'                                                   
FDEM5C   DS    0H                                                               
         TM    BYSTAT,X'01'        FOR UNMATCHED ORBIT SLAVES                   
         BZ    FDEM5D                                                           
*                                  SET IN ()                                    
         CLI   LNAEDEM+6,C' '                                                   
         BH    *+8                                                              
         MVI   LNAEDEM+6,C')'                                                   
         LA    RF,LNAEDEM+7                                                     
         CLI   0(RF),C' '                                                       
         BNH   *+8                                                              
         BCT   RF,*-8                                                           
         MVI   0(RF),C'('                                                       
         B     FDEMX               DONT TOTAL                                   
*                                                                               
FDEM5D   CLI   BYDEMC,0                                                         
         BE    FDEMX                                                            
         LLC   RF,BYDEMC           RELATIVE DEMO CODE                           
         SLL   RF,2                *4 = DISP INTO DCLIST                        
         LA    RF,DCLIST-4(RF)                                                  
         MVC   DTABCOD,0(RF)                                                    
*                                                                               
         GOTO1 BINSRCH,DEMPARS,DTABD                                            
*                                                                               
         CLI   DEMPARS,1                                                        
         BE    FDEMX                                                            
         L     RF,DEMPARS                                                       
         LTR   RF,RF                                                            
         BZ    FDEMX                                                            
*                                                                               
         MVC   LNADNAM,DTABNAM-DTABD(RF)                                        
         LM    R0,R1,DTABEST-DTABD(RF)                                          
         N     R0,=X'3FFFFFFF'                                                  
         N     R1,=X'3FFFFFFF'                                                  
*                                                                               
         L     RE,DTABEST                                                       
         N     RE,=X'3FFFFFFF'                                                  
         AR    R0,RE                                                            
         TM    DTABEST,X'40'                                                    
         BZ    *+8                                                              
         O     R0,=X'40000000'                                                  
*                                                                               
         CLI   HAVINV,C'Y'         IF NO INVOICE, NO ACH DEM                    
         BNE   FDEMX                                                            
         L     RE,DTABOACH                                                      
         N     RE,=X'3FFFFFFF'                                                  
         AR    R1,RE                                                            
         TM    DTABOACH,X'40'                                                   
         BZ    *+8                                                              
         O     R1,=X'40000000'                                                  
         STM   R0,R1,DTABEST-DTABD(RF)                                          
*                                                                               
FDEMX    J     EXIT                                                             
         DROP  R4,R7                                                            
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        CHECK ROTATION PATTERNS                                                
*-----------------------------------------------------------------              
*                                                                               
CHKROT   NMOD1 0,CHKROT                                                         
         LA    RC,SPACEND                                                       
         L     R8,0(R1)                                                         
         USING BYELEMD,R8                                                       
         L     R2,4(R1)            ROTATION SLOTS                               
         USING ROTD,R2                                                          
         CLC   ROTSPTS,=F'1'                                                    
         BNH   CKRX                                                             
         OC    ROTPCT,ROTPCT                                                    
         BZ    CKRX                                                             
         CLI   COSTSUP,C'A'        TEST TO SUPPRESS ROTATION                    
         BE    CKRX                                                             
*                                  COUNT NO. OF DAYS IN ROT PATTERN             
         SR    R3,R3                                                            
         SR    R4,R4                                                            
         IC    R4,BYDAY                                                         
         LA    R0,7                                                             
CKR2     DS    0H                                                               
         SRDL  R4,1                                                             
         SRL   R5,31                                                            
         AR    R3,R5                                                            
         BCT   R0,CKR2                                                          
*                                                                               
         ST    R3,NDAYS                                                         
*                                  COUNT NO. OF TIME SLOTS                      
         MVC   HALF,BYETIM                                                      
         LH    R1,HALF                                                          
         MVC   HALF,BYSTIM                                                      
         SH    R1,HALF                                                          
         SR    R0,R0                                                            
         D     R0,=F'30'                                                        
         ST    R1,NTIMS                                                         
*                                                                               
         MVI   ROTSW,0                                                          
         MVC   MPDAY,ROTSPTS                                                    
         MVC   MPTIM,ROTSPTS                                                    
         CLC   NDAYS,=F'1'                                                      
         BH    CKR4                                                             
         CLC   NTIMS,=F'1'                                                      
         BNH   CKRX                                                             
         B     CKR6                                                             
CKR4     DS    0H                                                               
         L     R0,ROTSPTS                                                       
         L     RF,NDAYS                                                         
         LR    R1,RF               ADJUST NOW TO FORCE ROUNDING UP              
         SRL   R1,1                                                             
         AR    R0,R1                                                            
         TM    NDAYS+3,X'01'                                                    
         BNZ   *+6                                                              
         BCTR  R0,R0                                                            
         BAS   RE,CKRDIV                                                        
         LTR   R1,R1                                                            
         BP    *+8                                                              
         LA    R1,1                                                             
         ST    R1,MPDAY            MAX PER DAY                                  
*                                                                               
         CLC   ROTPCT,=F'1'        IF NO LEEWAY                                 
         BE    CKR6                DONE                                         
*                                                                               
         L     R0,ROTSPTS                                                       
         L     RF,NDAYS                                                         
         MHI   R0,100                                                           
         BAS   RE,CKRDIV                                                        
         ST    R1,DUB                                                           
         M     R0,ROTPCT                                                        
         LR    R0,R1                                                            
         L     RF,=F'100'                                                       
         BAS   RE,CKRDIV                                                        
         A     R1,DUB                                                           
         LR    R0,R1                                                            
         LA    RF,100                                                           
         BAS   RE,CKRDIV                                                        
*                                                                               
         C     R1,MPDAY                                                         
         BNH   *+8                                                              
         ST    R1,MPDAY                                                         
*                                                                               
CKR6     DS    0H                                                               
         CLC   NTIMS,=F'1'                                                      
         BNH   CKR10                                                            
         L     R0,ROTSPTS                                                       
         L     RF,NTIMS                                                         
         LR    R1,RF               ADJUST NOW TO FORCE ROUNDING UP              
         SRL   R1,1                                                             
         AR    R0,R1                                                            
         TM    NTIMS+3,X'01'                                                    
         BNZ   *+6                                                              
         BCTR  R0,R0                                                            
         BAS   RE,CKRDIV                                                        
         LTR   R1,R1                                                            
         BP    *+8                                                              
         LA    R1,1                                                             
         ST    R1,MPTIM            MAX PER TIME SLOT                            
*                                                                               
         CLC   ROTPCT,=F'1'        IF NO LEEWAY                                 
         BE    CKR10               DONE                                         
*                                                                               
         L     R0,ROTSPTS                                                       
         L     RF,NTIMS                                                         
         MHI   R0,100                                                           
         BAS   RE,CKRDIV                                                        
         ST    R1,DUB                                                           
         M     R0,ROTPCT                                                        
         LR    R0,R1                                                            
         L     RF,=F'100'                                                       
         BAS   RE,CKRDIV                                                        
         A     R1,DUB                                                           
         LR    R0,R1                                                            
         LA    RF,100                                                           
         BAS   RE,CKRDIV                                                        
*                                                                               
         C     R1,MPTIM                                                         
         BNH   *+8                                                              
         ST    R1,MPTIM                                                         
*                                                                               
CKR10    DS    0H                                                               
         LA    R3,ROTDAYS                                                       
         LA    R4,7                                                             
CKR12    DS    0H                                                               
         CLC   MPDAY,0(R3)                                                      
         BL    CKR14                                                            
         LA    R3,4(R3)                                                         
         BCT   R4,CKR12                                                         
         B     CKR16                                                            
CKR14    DS    0H                                                               
         OI    ROTSW,X'80'         HORIZONTAL ERROR                             
*                                                                               
CKR16    DS    0H                                                               
         LA    R3,ROTTIMS                                                       
         LA    R4,48                                                            
CKR18    DS    0H                                                               
         CLC   MPTIM,0(R3)                                                      
         BL    CKR20                                                            
         LA    R3,4(R3)                                                         
         BCT   R4,CKR18                                                         
         B     CKR22                                                            
CKR20    DS    0H                                                               
         OI    ROTSW,X'40'         VERT                                         
*                                                                               
CKR22    DS    0H                                                               
         CLI   ROTSW,0                                                          
         BE    CKRX                                                             
         MVI   HVROTERR,C'Y'                                                    
         LA    R4,P1                                                            
         USING LNAD,R4                                                          
         OC    ROTPCTW,ROTPCTW     UNLESS DOING BOTH WEEKLY                     
         BZ    CKR23               AND BY BUYLINE                               
         OC    ROTPCTL,ROTPCTL     SHOW RESULT IN OLD FORMAT                    
         BNZ   CKR25                                                            
*                                                                               
CKR23    DS    0H                                                               
         LA    R3,LNAROT+1                                                      
         MVC   1(3,R3),=C'*V*'                                                  
         TM    ROTSW,X'80'                                                      
         BZ    *+8                                                              
         MVI   2(R3),C'H'                                                       
         TM    ROTSW,X'C0'                                                      
         BNO   *+10                                                             
         MVC   0(2,R3),=C'*V'                                                   
         B     CKRX                                                             
*                                                                               
CKR25    DS    0H                  NEW FORMAT - IF DOING BOTH                   
         LA    R3,LNAROT                                                        
         LA    R0,ROTPCTW          TEST SHOWING WEEKLY NOW                      
         CR    R2,R0                                                            
         BNE   CKR27                                                            
*                                  YES - JUST DO                                
         MVC   1(4,R3),=C'*VW*'                                                 
         TM    ROTSW,X'80'                                                      
         BZ    *+8                                                              
         MVI   2(R3),C'H'                                                       
         TM    ROTSW,X'C0'                                                      
         BNO   *+10                                                             
         MVC   0(2,R3),=C'*V'                                                   
         B     CKRX                                                             
*                                                                               
CKR27    DS    0H                 SHOWING BUY LINE RESULT NOW                   
         CLI   1(R3),C' '         TEST IF HAVE WEEKLY ERROR                     
         BH    CKR29              FOR LAST WEEK - YES HANDLE SPECIALLY          
*                                 NO- JUST SHOW BUYLINE RESULT                  
         MVC   1(4,R3),=C'*VB*'                                                 
         TM    ROTSW,X'80'                                                      
         BZ    *+8                                                              
         MVI   2(R3),C'H'                                                       
         TM    ROTSW,X'C0'                                                      
         BNO   *+10                                                             
         MVC   0(2,R3),=C'*V'                                                   
         B     CKRX                                                             
*                                                                               
CKR29    DS    0H                  HAVE WEEKLY AND BUYLINE ERROR                
         MVI   3(R3),C'+'          ALWAYS SET INDICATOR FOR BOTH                
         CLI   0(R3),C' '          TEST BOTH H AND V ERRS FOR WEEK              
         BH    CKRX                YES - DONE                                   
*                                  IF HAD ONLY ONE MAY HAVE SHOW OTHER          
         TM    ROTSW,X'40'         TEST VERT ERROR FOR BUY                      
         BZ    CKR29D                                                           
         CLI   2(R3),C'V'          TEST HAD FOR WEEK                            
         BNE   CKR29H              NO MUST SHOW BOTH                            
CKR29D   DS    0H                                                               
         TM    ROTSW,X'80'         TEST HORIZONTAL ERROR FOR BUY                
         BZ    CKR29F                                                           
         CLI   2(R3),C'H'          TEST HAD FOR WEEK                            
         BNE   CKR29H              NO MUST SHOW BOTH                            
CKR29F   DS    0H                                                               
         B     CKRX                                                             
CKR29H   DS    0H                                                               
         MVC   0(3,R3),=C'*VH'                                                  
*                                                                               
CKRX     DS    0H                                                               
         MVI   ROTSW,0                                                          
         XC    ROTDAYS,ROTDAYS                                                  
         XC    ROTTIMS,ROTTIMS                                                  
         XC    ROTSPTS,ROTSPTS                                                  
*                                                                               
         J     EXIT                                                             
         DROP  R2                                                               
*                                                                               
CKRDIV   DS    0H                                                               
         SR    R1,R1                                                            
         SRDL  R0,31                                                            
         DR    R0,RF                                                            
         LTR   R1,R1                                                            
         BM    *+8                                                              
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
         BR    RE                                                               
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        TOTALS                                                                 
*-----------------------------------------------------------------              
*                                                                               
IRTOTS   NMOD1 0,IRTOTS                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVI   PAGSW,C'T'                                                       
         MVI   SPACING,2                                                        
         GOTO1 AIRPRT                                                           
         LA    RF,11               NEED AT LEAST 11 LINES                       
         OC    TAXTOT,TAXTOT                                                    
         BZ    *+8                                                              
         LA    RF,2(RF)            2 MORE FOR TAX                               
         OC    VATTOT,VATTOT                                                    
         BZ    *+8                                                              
         LA    RF,1(RF)            1 MORE FOR VAT                               
*                                                                               
*                                  ONE MORE FOR EACH PST                        
         LA    RE,(NPROVS-1)*4                                                  
IRT2     DS    0H                                                               
         L     R0,PSTTOTS(RE)                                                   
         LTR   R0,R0                                                            
         BZ    *+8                                                              
         LA    RF,1(RF)                                                         
         AHI   RE,-4                                                            
         BNM   IRT2                                                             
*                                                                               
         CLI   PDOPT,C'Y'                                                       
         BNE   *+8                                                              
         LA    RF,3(RF)            3 MORE FOR PAID TOTALS                       
         OC    DEFSPTS,DEFSPTS                                                  
         BZ    *+8                                                              
         LA    RF,1(RF)            1 MORE FOR DEFERRED TOTAL                    
*                                                                               
         MVI   BIGSW,C'N'          SET DO NOT NEED BIG MESSGE                   
         TM    BIGOPT,X'01'        BIG CLEARED MESSAGE FIRST                    
         BZ    IRT3                                                             
         TM    PDSTAT,X'01'        TEST FULLY CLEARED                           
         BZ    IRT3                                                             
         MVI   BIGSW,C'C'                                                       
         B     IRT5B                                                            
IRT3     DS    0H                                                               
         CLI   COSTSUP,C'A'        TEST TO SUPPRESS BIG ERROR MSGS              
         BE    IRT6                                                             
         TM    BIGOPT,X'80'        TEST OPTION FOR MISMATCH                     
         BZ    IRT4                                                             
         CLI   MATSTAT,0                                                        
         BNE   IRT5                                                             
IRT4     DS    0H                                                               
         TM    BIGOPT,X'40'        H/V ROTATION                                 
         BZ    IRT4B                                                            
         CLI   HVROTERR,C'Y'                                                    
         BE    IRT5                                                             
IRT4B    DS    0H                                                               
         TM    BIGOPT,X'20'        FILM ERROR                                   
         BZ    IRT6                                                             
         CLI   FILMDSCP,C'Y'                                                    
         BNE   IRT6                                                             
IRT5     DS    0H                                                               
         MVI   BIGSW,C'Y'                                                       
IRT5B    DS    0H                                                               
         LA    RF,6(RF)            6 MORE FOR BIG MESSAGE                       
IRT6     DS    0H                                                               
         STC   RF,LNEED                                                         
*                                                                               
         MVC   P1+5(60),=C'REPORT TOTALS            SPOTS     GROSS COSX        
               T       NET COST'                                                
         MVC   P2+5(60),=C'-------------            -----     ---------X        
               -       --------'                                                
*                                                                               
         CLI   PSEUDOPT,C'R'       TEST DOING RESPONSES                         
         BNE   *+16                                                             
         MVC   P1+5+66(09),=C'RESPONSES'                                        
         MVC   P2+5+66(09),DASHES                                               
*                                                                               
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BE    *+16                                                             
         MVC   P1+5+35(40),SPACES                                               
         MVC   P2+5+35(40),SPACES                                               
*                                                                               
         LAY   R2,TOTWDS                                                        
         LA    R3,MATSPTS                                                       
         LA    R4,9                                                             
         LA    R6,P3                                                            
         USING LNCD,R6                                                          
IR31     EQU   *                                                                
         TM    0(R2),X'80'         MEANS SKIP IF SPOTS = ZERO                   
         BZ    *+14                                                             
         OC    0(4,R3),0(R3)                                                    
         BZ    IR32B8                                                           
*                                                                               
         MVC   LNCWDS,2(R2)                                                     
*                                                                               
         TM    0(R2),X'20'         CASH/TRADE FOR NET?                          
         BZ    IR131A              NO                                           
         CLI   NETPSW,C'Y'         YES - NETPAK?                                
         BNE   *+14                NO                                           
         OC    0(24,R3),0(R3)      HAVE CASH/TRADE VALUES?                      
         BNZ   IR131B              YES - CONTINUE W/O PRINTING SPOTS            
         MVC   LNCWDS,SPACES                                                    
         B     IR32B8              NO, SKIP                                     
*                                                                               
IR131A   L     R0,0(R3)                                                         
         EDIT  (R0),(5,LNCSPTS)                                                 
         BNZ   *+10                                                             
         MVC   LNCSPTS+1(4),=C'NONE'                                            
*                                                                               
IR131B   CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BNE   IR32A                                                            
         CLI   PSEUDOPT,C'R'       IF DOING RESPONSES                           
         BNE   IR3204                                                           
         TM    0(R2),X'40'         AND ORDERED TYPE LINE                        
         BZ    IR3204                                                           
         MVI   LNCGRS+11,C'-'      '-' TO MARK SLOT                             
         MVI   LNCNET+11,C'-'                                                   
         B     IR32A                                                            
*                                                                               
IR3204   DS    0H                                                               
         L     R0,4(R3)                                                         
         LTR   R0,R0                                                            
         BZ    IR32                                                             
         EDIT  (R0),(14,LNCGRS),2,COMMAS=YES,MINUS=YES                          
*                                                                               
IR32     EQU   *                                                                
         L     R0,8(R3)                                                         
         LTR   R0,R0                                                            
         BZ    IR32A                                                            
         EDIT  (R0),(14,LNCNET),2,COMMAS=YES,MINUS=YES                          
*                                                                               
IR32A    DS    0H                                                               
         CLI   PSEUDOPT,C'R'       RESPONSES?                                   
         BNE   IR32A8                                                           
         L     R0,IGRS             IGRS = RESPONSE COUNT                        
         CLI   1(R2),C'I'          USE FOR INVOICE LINE                         
         BE    IR32A6                                                           
         S     R0,RNOGRS           IGRS - RNOGRS = MATGRS                       
         CLI   1(R2),C'M'          USE FOR MATCHED LINE                         
         BE    IR32A6                                                           
         L     R0,RNOGRS           RNOGRS                                       
         CLI   1(R2),C'R'          USE FOR RNO LINE                             
         BE    IR32A6                                                           
         MVI   LNCRESP+11,C'-'     '-' FOR OTHER LINES                          
         B     IR32A8                                                           
*                                                                               
IR32A6   DS    0H                                                               
         EDIT  (R0),(13,LNCRESP),COMMAS=YES,MINUS=YES,ZERO=NOBLANK              
IR32A8   DS    0H                                                               
         LA    R6,132(R6)                                                       
IR32B8   DS    0H                                                               
         LA    R2,22(R2)                                                        
         LA    R3,12(R3)                                                        
         BCT   R4,IR31                                                          
*                                                                               
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BNE   IR32H               YES, SKIP TAX, CLEARED, ETC                  
*                                                                               
         OC    TAXTOT,TAXTOT                                                    
         BZ    IR32C               NO TAX TO PRINT                              
*                                                                               
         MVI   0(R6),0                                                          
         LA    R6,132(R6)                                                       
         MVC   LNCWDS(19),=C'ORDERED PLUS TAX ($'                               
         LA    R4,LNCWDS+19                                                     
         EDIT  (B4,TAXTOT),(9,0(R4)),2,COMMAS=YES,ALIGN=LEFT                    
         AR    R4,R0                                                            
         MVI   0(R4),C')'                                                       
*                                                                               
         L     R0,OGRS                                                          
         A     R0,TAXTOT                                                        
         EDIT  (R0),(14,LNCGRS),2,COMMAS=YES,MINUS=YES                          
*                                                                               
         L     R0,ONET                                                          
         A     R0,TAXTOT                                                        
         EDIT  (R0),(14,LNCNET),2,COMMAS=YES,MINUS=YES                          
         LA    R6,132(R6)                                                       
*                                                                               
IR32C    DS    0H                                                               
         OC    VATTOT,VATTOT                                                    
         BZ    IRPST               NO VAT TO PRINT                              
*                                                                               
         OC    TAXTOT,TAXTOT       IF HAD NO REGULAR TAX                        
         BNZ   IR32C2                                                           
         MVI   0(R6),0             SKIP A LINE                                  
         LA    R6,132(R6)                                                       
         MVC   LNCWDS(19),=C'ORDERED PLUS GST ($'                               
         LA    R4,LNCWDS+19                                                     
         B     IR32C4                                                           
IR32C2   DS    0H                                                               
         MVC   LNCWDS(11),=C'PLUS GST ($'  INSTEAD OF ORD+TAX+GST               
         LA    R4,LNCWDS+11                                                     
IR32C4   DS    0H                                                               
         EDIT  (B4,VATTOT),(9,0(R4)),2,COMMAS=YES,ALIGN=LEFT                    
         AR    R4,R0                                                            
         MVI   0(R4),C')'                                                       
*                                                                               
         L     R0,OGRS                                                          
         A     R0,TAXTOT                                                        
         A     R0,VATTOT                                                        
         EDIT  (R0),(14,LNCGRS),2,COMMAS=YES,MINUS=YES                          
*                                                                               
         L     R0,ONET                                                          
         A     R0,TAXTOT                                                        
         A     R0,VATTOT                                                        
         EDIT  (R0),(14,LNCNET),2,COMMAS=YES,MINUS=YES                          
         LA    R6,132(R6)                                                       
*                                                                               
IRPST    DS    0H                  PRINT PST AMOUNTS                            
         XC    PSTTOTL,PSTTOTL                                                  
         LA    R5,PSTTOTS                                                       
         LA    RF,NPROVS                                                        
*                                                                               
IRP2     DS    0H                                                               
         OC    0(4,R5),0(R5)       ANY VALUE                                    
         BZ    IRP30                                                            
         LA    R4,NPROVS           GET PROV NUMBER                              
         SR    R4,RF                                                            
         MHI   R4,PRVTABL                                                       
         A     R4,=A(PRVTAB)                                                    
*                                                                               
         MVC   LNCWDS(4),=C'PLUS'                                               
         MVC   LNCWDS+5(8),2(R4)                                                
         LA    R4,LNCWDS+14                                                     
         CLI   0(R4),C' '                                                       
         BH    *+8                                                              
         BCT   R4,*-8                                                           
         MVC   2(2,R4),=C'($'                                                   
         LA    R4,4(R4)                                                         
         EDIT  (B4,0(R5)),(9,0(R4)),2,COMMAS=YES,ALIGN=LEFT                     
         AR    R4,R0                                                            
         MVI   0(R4),C')'                                                       
*                                                                               
         L     R0,PSTTOTL          CUME PST                                     
         A     R0,0(R5)                                                         
         ST    R0,PSTTOTL                                                       
*                                                                               
         L     R0,OGRS                                                          
         A     R0,TAXTOT                                                        
         A     R0,VATTOT                                                        
         A     R0,PSTTOTL          PLUS PST CUME                                
         EDIT  (R0),(14,LNCGRS),2,COMMAS=YES,MINUS=YES                          
*                                                                               
         L     R0,ONET                                                          
         A     R0,TAXTOT                                                        
         A     R0,VATTOT                                                        
         A     R0,PSTTOTL          PLUS PST CUME                                
         EDIT  (R0),(14,LNCNET),2,COMMAS=YES,MINUS=YES                          
         LA    R6,132(R6)                                                       
*                                                                               
IRP30    DS    0H                                                               
         LA    R5,4(R5)            NEXT PROVINCE                                
         BCT   RF,IRP2                                                          
*                                                                               
IR32D    DS    0H                                                               
         CLI   STAXOPT,C'Y'        OPTION TO PRINT STATION TAX %                
         BNE   IR32E                                                            
         L     RF,ADSTAT                                                        
         SR    R0,R0                                                            
         ICM   R0,3,SNEWTAX-STAREC(RF)                                          
         BZ    IR32E                                                            
         MVC   LNCWDS(15),=C'FILE TAX RATE ='                                   
         LA    R4,LNCWDS+16                                                     
         EDIT  (R0),(6,0(R4)),3,ALIGN=LEFT                                      
         AR    R4,R0               GET RID OF TRAILING 00                       
         AHI   R4,-2                                                            
         CLC   0(2,R4),=C'00'                                                   
         BNE   *+14                                                             
         MVC   0(2,R4),SPACES                                                   
         B     *+8                                                              
         LA    R4,2(R4)                                                         
         MVI   0(R4),C'%'                                                       
*                                                                               
IR32E    DS    0H                                                               
         MVI   0(R6),0                                                          
         LA    R6,132(R6)                                                       
         CLI   PDOPT,C'Y'                                                       
         BNE   IR32H                                                            
         MVC   LNCWDS(14),=C'AMOUNT CLEARED'                                    
         EDIT  (B4,PDGRS),(14,LNCGRS),2,COMMAS=YES,MINUS=YES                    
         EDIT  (B4,PDNET),(14,LNCNET),2,COMMAS=YES,MINUS=YES                    
         CLC   PDGRS(8),OGRS                                                    
         BE    IR32F                                                            
         LA    R6,132(R6)                                                       
         MVC   LNCWDS(11),=C'NOT CLEARED'                                       
         L     R0,OGRS                                                          
         S     R0,PDGRS                                                         
         A     R0,TAXTOT           TAX                                          
         A     R0,VATTOT           GST                                          
         A     R0,PSTTOTL          PST                                          
         EDIT  (R0),(14,LNCGRS),2,COMMAS=YES,MINUS=YES                          
         L     R0,ONET                                                          
         S     R0,PDNET                                                         
         A     R0,TAXTOT           TAX                                          
         A     R0,VATTOT           GST                                          
         A     R0,PSTTOTL          PST                                          
         EDIT  (R0),(14,LNCNET),2,COMMAS=YES,MINUS=YES                          
IR32F    DS    0H                                                               
*                                                                               
IR32H    DS    0H                                                               
         CLI   PAYTA,C'Y'          FOR PAY TA PRINT AMOUNT + DIFF               
         BNE   IR34B               AND SKIP SREP TOTALS                         
         CLC   QAMT(4),SPACES                                                   
         BE    IR50                                                             
         B     IR40                                                             
IR34B    DS    0H                                                               
*                                  SPECIAL REP TOTALS                           
         CLI   SREPSW,0            TEST ANY SEPC REPS                           
         BE    IR50                                                             
         OC    SREPPARS+8(4),SREPPARS+8   TABLE MAY BE EMTPY                    
         BZ    IR50                                                             
         CLI   COSTSUP,C'N'        SKIP IF SUPPRESSING COSTS                    
         BNE   IR50                                                             
         CLI   PSEUDOPT,C'R'       OR IF DOING RESPONSES                        
         BE    IR50                                                             
*                                                                               
         LA    RF,P1+70                                                         
         LA    R0,7                                                             
         MVI   0(RF),C'*'                                                       
         LA    RF,132(RF)                                                       
         BCT   R0,*-8                                                           
*                                                                               
         MVC   P1+73(58),=C'SPECIAL     ----GROSS AMOUNT----      -----X        
               NET AMOUNT-----'                                                 
         MVC   P2+73(58),=C'  REP       ORDERED      MATCHED      ORDERX        
               ED      MATCHED'                                                 
         MVC   P3+73(58),=C'-------     -------      -------      -----X        
               --      -------'                                                 
*                                                                               
         L     R2,SREPPARS+4                                                    
         LA    R3,P4+73                                                         
         L     R4,SREPPARS+8                                                    
         LA    RF,11               MAX OF 11 REPS                               
         CLI   RNAMOPT,C'Y'        UNLESS SHOWING NAMES                         
         BNE   *+8                                                              
         LA    RF,5                THEN 5                                       
         CR    R4,RF                                                            
         BNH   IR35                                                             
         LR    R4,RF                                                            
         MVC   P14(17),=C'**TOO MANY REPS**'                                    
*                                                                               
         USING SREPD,R2                                                         
*                                                                               
IR35     DS    0H                                                               
         MVC   1(4,R3),=C'NONE'                                                 
         CLI   SREPCOD,X'FF'                                                    
         BE    IR36                                                             
         MVI   1(R3),C' '                                                       
         GOTO1 VRCPACK,DMCB,(C'U',SREPCOD),2(R3)                                
         CLI   RNAMOPT,C'Y'        REP NAME OPTION                              
         BNE   IR36                                                             
         MVC   132+2(22,R3),SREPNAM                                             
*                                                                               
IR36     DS    0H                                                               
         LA    R5,6(R3)                                                         
         LA    R6,SREPOGRS                                                      
         LA    RF,4                                                             
IR37     DS    0H                                                               
         BAS   RE,SREPEDT                                                       
         LA    R5,13(R5)                                                        
         LA    R6,4(R6)                                                         
         BCT   RF,IR37                                                          
*                                                                               
         A     R2,SREPPARS+12                                                   
         LA    R3,132(R3)                                                       
         CLI   RNAMOPT,C'Y'        IF DOING REP NAMES                           
         BNE   *+8                                                              
         LA    R3,132(R3)          USE 2 LINES                                  
         BCT   R4,IR35                                                          
*                                                                               
         B     IR50                                                             
*                                                                               
IR40     DS    0H                                                               
*                                  PRINT PAY PROG INPUT AND DIFFERENCE          
         LA    R6,P3+70                                                         
         MVC   FULL,QAMT                                                        
         L     R5,FULL                                                          
         EDIT  (R5),(13,19(R6)),2,COMMAS=YES,CR=YES                             
*                                                                               
         MVC   0(18,R6),=C'PAY PROGRAM AMOUNT'                                  
*                                                                               
         LA    R6,132(R6)                                                       
         MVC   8(10,R6),=C'LESS GROSS'                                          
         L     R4,OGRS                                                          
         CLI   PAYGN,C'G'                                                       
         BE    IR43                                                             
         L     R4,ONET                                                          
         MVC   8(10,R6),=C'  LESS NET'                                          
IR43     DS    0H                                                               
         EDIT  (R4),(13,19(R6)),2,COMMAS=YES,CR=YES                             
*                                                                               
         LA    R6,132(R6)                                                       
         MVC   22(09,R6),DASHES                                                 
*                                                                               
         LA    R6,132(R6)                                                       
         MVC   8(10,R6),=C'DIFFERENCE'                                          
         SR    R5,R4                                                            
         EDIT  (R5),(13,19(R6)),2,COMMAS=YES,CR=YES                             
*                                                                               
IR50     DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 AIRPRT                                                           
*                                                                               
         TM    EDFLAG,EDTOTS       NEED TO PRINT EARNED DISCOUNT TOTS           
         BNO   IR50X                                                            
         LA    R6,P                                                             
         MVC   LNCWDS(21),=C'EARNED DISCOUNT TOTAL'                             
         EDIT  (B4,EDCOST),(14,LNCGRS),2,COMMAS=YES,MINUS=YES                   
         EDIT  (B4,EDNET),(14,LNCNET),2,COMMAS=YES,MINUS=YES                    
         GOTO1 AIRPRT                                                           
*                                                                               
IR50X    CLI   BIGSW,C'N'         TEST NEED BIG ERROR MESSAGE                   
         BE    IR59                                                             
*                                  FIRST COMPUTE LENGTH                         
         LA    RF,19                 BIG CLEARED MESSAGE                        
         CLI   BIGSW,C'C'                                                       
         BE    IR51                                                             
*                                                                               
         LA    RF,21                 OTHERS START AT 21                         
         CLI   MATSTAT,0             TEST MISMATCH                              
         BE    *+8                                                              
         LA    RF,24(RF)                                                        
         CLI   HVROTERR,C'Y'       H/V ERROR                                    
         BNE   *+8                                                              
         LA    RF,21(RF)                                                        
         CLI   FILMDSCP,C'Y'       FILM ERROR                                   
         BNE   *+8                                                              
         LA    RF,22(RF)                                                        
*                                                                               
IR51     DS    0H                                                               
         MVI   P1+5,C'*'                                                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P1+6(0),P1+5                                                     
*                                                                               
         LA    RE,P6               BOX IS P1 TO P6                              
         LA    R0,4                                                             
         CLI   BIGSW,C'C'          BUT CLEARED MESSAGE                          
         LA    RE,P5               IS DIFFERENT                                 
         LA    R0,3                                                             
         MVC   0(132,RE),P1                                                     
         LA    R1,P2                                                            
*                                                                               
IR52     DS    0H                                                               
         MVC   5(2,R1),ASTERS                                                   
         LA    RE,5(R1,RF)                                                      
         MVC   0(2,RE),ASTERS                                                   
         LA    R1,132(R1)                                                       
         BCT   R0,IR52                                                          
*                                                                               
         CLI   BIGSW,C'C'          CLEARED MESSAGE                              
         BNE   IR53                                                             
         MVC   P3+9(13),=C'C L E A R E D'                                       
         B     IR57                                                             
*                                                                               
IR53     DS    0H                                                               
         MVC   P3+9(14),=C'E R R O R S  *'                                      
         MVC   P4+9(11),ASTERS                                                  
         LA    R2,P3+26                                                         
*                                                                               
         CLI   MATSTAT,0               TEST MISMATCH                            
         BE    IR54                                                             
         MVC   0(23,R2),=C'MATCHING DISCREPANCIES,'                             
         LA    R2,24(R2)                                                        
*                                                                               
IR54     DS    0H                                                               
         CLI   HVROTERR,C'Y'                                                    
         BNE   IR55                                                             
         MVC   0(20,R2),=C'H/V ROTATION ERRORS,'                                
         LA    R2,21(R2)                                                        
*                                                                               
IR55     DS    0H                                                               
         CLI   FILMDSCP,C'Y'                                                    
         BNE   IR56                                                             
         MVC   0(21,R2),=C'FILM ANALYSIS ERRORS,'                               
         LA    R2,22(R2)                                                        
*                                                                               
IR56     DS    0H                                                               
         AHI   R2,-2                                                            
         MVI   0(R2),C' '          LAST COMMA                                   
IR57     DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 AIRPRT                                                           
*                                                                               
*              PRINT NORMAL (NON-BIG) CONCLUDING MESSAGES                       
IR59     DS    0H                                                               
         LA    R6,P                                                             
*                                                                               
         CLI   MATSTAT,0                                                        
         BNE   IR62J                                                            
         MVC   05(23,R6),=C'**MATCHING SUCCESSFUL**'                            
         LA    R6,132(R6)                                                       
         B     IR63                                                             
IR62J    DS    0H                                                               
         CLI   BIGSW,C'N'          IF DIDN'T PRINT BIG ERROR MSG                
         BE    IR62K               NEED UNSUCCESSFUL MSG NOW                    
         CLI   BIGSW,C'C'                                                       
         BNE   IR63                                                             
IR62K    DS    0H                                                               
         MVC   05(51,R6),=C'**MATCHING UNSUCCESSFUL - THERE ARE DISCREPX        
               ANCIES**'                                                        
*                                                                               
         OC    ISPTS(8),ISPTS                                                   
         BNZ   *+18                                                             
         MVC   31(25,R6),=CL25'NO INVOICE DATA**'                               
         LA    R6,132(R6)                                                       
         B     IR63                                                             
         OC    OSPTS(8),OSPTS                                                   
         BNZ   *+18                                                             
         MVC   31(25,R6),=CL25'NO ORDERED DATA**'                               
         LA    R6,132(R6)                                                       
         B     IR63                                                             
         LA    R6,132(R6)                                                       
*                                                                               
IR63     DS    0H                                                               
         CLI   PSTOPT,C'N'                                                      
         BE    IR63J                                                            
         OC    OSPTS(8),OSPTS                                                   
         BZ    IR63J                                                            
         MVC   05(44,R6),=C'**AFFIDAVIT DATA INSERTED INTO BUY RECORDS*X        
               *'                                                               
*                                                                               
         CLI   PSTOPT,C'L'         OVERRODE POSTING DUE TO I2A LOCK             
         BNE   *+14                                                             
         MVC   05(44,R6),=C'**AFFIDAVIT DATA NOT CHANGED - I2A PROFILE*X        
               *'                                                               
         B     IR63A                                                            
*                                                                               
         CLI   PSTOPT,C'X'         OVERRODE POSTING DUE TO B0 PROFILE           
         BNE   *+14                                                             
         MVC   05(44,R6),=C'**AFFIDAVIT DATA NOT CHANGED - B0 PROFILE *X        
               *'                                                               
         B     IR63A                                                            
*                                                                               
         CLI   PSTOPT,C'U'         OVERRODE UPDATING DUE TO PRD/EST ALL         
         BNE   *+14                REQUEST WITH MULTIPLE PRD/EST ON INV         
         MVC   05(91,R6),=C'**DATA NOT CHANGED - PRD/EST ALL REQUEST CAX        
               NNOT HAVE DIFFERENT PRD/EST ON INVOICE RECORD**'                 
         B     IR63A                                                            
*                                                                               
         CLI   PSTOPT,C'M'         OVERRODE UPDATING DUE TO INVOICE TOO         
         BNE   *+10                BIG FOR UPDATIVE SOON                        
         MVC   05(67,R6),=C'**DATA NOT CHANGED - INVOICE TOO BIG FOR SOX        
               ON - REQUEST OVERNIGHT**'                                        
*                                                                               
IR63A    LA    R6,132(R6)                                                       
*                                                                               
IR63J    DS    0H                                                               
         CLI   ANXTCOM,X'FF'                                                    
         BNE   IR63L                                                            
         MVC   05(63,R6),=C'NOTE- COMMENT BUFFER FULL, COMMENTS NOT PRIX        
               NTED*'                                                           
*                                                                               
IR63L    DS    0H                                                               
IR64     DS    0H                                                               
         GOTO1 AIRPRT                                                           
*                                                                               
IR70     CLI   I2ZPROF+2,C'Y'      PRINT COMPLETE LIST OF INVOICES              
         BNE   IR80                                                             
         CLI   I2ZPROF+5,C'Y'      PRINT INVOICE TOTALS                         
         BE    IR80                THEN SKIP LIST - REDUNDANT                   
*                                                                               
         L     R4,AINOLST                                                       
         USING INOLSTD,R4                                                       
         CLI   0(R4),C' '          TEST ANY INVOICES                            
         BNH   IRTOTX                                                           
*                                                                               
         LA    R2,P                                                             
         MVC   0(8,R2),=C'INVOICES'                                             
         LA    R3,9(R2)                                                         
*                                                                               
IR72     CLI   0(R4),C' '          END OF INVOICE LIST?                         
         BNH   IR77                YES                                          
*                                                                               
         CLI   MTRADE,C'Y'         MTRADE?                                      
         BNE   IR72AA              NO                                           
         CLC   RQREP,SPACES        SPECIAL REP REQUEST?                         
         BNH   IR72AA              NO                                           
         GOTO1 VRCPACK,DMCB,(C'U',INOLREP),WORK                                 
         CLI   Q2USER+6,C'Y'       NEGATIVE FILTER?                             
         BNE   *+18                NO                                           
         CLC   RQREP,WORK          NEGATIVE REP MATCHES?                        
         BE    IR74A               YES - REJECT                                 
         B     IR72AA              PRINT THE INVOICE                            
         CLC   RQREP,WORK          REP MATCHES?                                 
         BNE   IR74A               NO - REJECT                                  
*                                                                               
IR72AA   XC    WORK,WORK                                                        
         MVC   WORK(L'IHDINV),INOLINV                                           
         LA    R5,WORK+L'IHDINV                                                 
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         LA    R1,C'I'                                                          
         TM    INOFLAG,INOINVM     IS THIS INVOICE MANAGER?                     
         BNZ   IR72A               YES                                          
*                                                                               
         LA    R1,C'E'                                                          
         TM    INOFLAG,INOEASI     IS THIS INVOICE ELECTRONIC?                  
         BZ    IR72B               NO                                           
*                                                                               
IR72A    MVI   1(R5),C'('                                                       
         STC   R1,2(R5)                                                         
         MVI   3(R5),C')'                                                       
         LA    R5,3(R5)                                                         
*                                                                               
IR72B    CLI   INOLDAT,0           TEST HAVE DATE                               
         BE    IR73                                                             
         MVI   1(R5),C'-'                                                       
         GOTO1 DATCON,DMCB,(3,INOLDAT),(4,2(R5))                                
         LA    R5,6(R5)                                                         
*                                                                               
IR73     AH    R4,INOLSTQ          BUMP TO NEXT INVOICE                         
         CLI   0(R4),C' '          TEST AT END                                  
         BNH   *+8                 YES, NO SEPARATOR                            
         MVI   1(R5),C','                                                       
         SH    R4,INOLSTQ          BACK TO CURRENT INVOICE                      
         LA    R0,WORK                                                          
         SR    R5,R0               R5 HAS LENGTH -1                             
*                                                                               
         LA    R6,1(R5,R3)                                                      
         LA    RE,130(R2)                                                       
         CR    R6,RE               TEST WILL FIT                                
         BH    IR75                                                             
*                                                                               
IR74     DS    0H                                                               
         LA    R5,1(R5)                                                         
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),WORK                                                     
         LA    R3,1(R3,R5)                                                      
IR74A    AH    R4,INOLSTQ          NEXT INVOICE                                 
         B     IR72                                                             
*                                                                               
IR75     DS    0H                  NEXT LINE                                    
         LA    R0,P2                                                            
         CR    R2,R0                                                            
         BNL   IR76                                                             
         LA    R2,132(R2)                                                       
         CLI   0(R2),C' '          AND ONLY IF NOT USED                         
         BH    IR78                                                             
         LA    R3,9(R2)                                                         
         B     IR74                                                             
*                                                                               
IR76     DS    0H                  NEXT LINE                                    
         LA    R0,P3                                                            
         CR    R2,R0                                                            
         BNL   IR78                                                             
         LA    R2,132(R2)                                                       
         CLI   0(R2),C' '          AND ONLY IF NOT USED                         
         BH    IR78                                                             
         LA    R3,9(R2)                                                         
         B     IR74                                                             
*                                                                               
IR77     DS    0H                                                               
         SH    R4,INOLSTQ          BACK UP TO PREV                              
         CLC   INOLINV,ASTERS      TEST LIST OVERFLOW                           
         BE    IR78                YES                                          
         BCTR  R3,0                BACK UP TO LAST PRINTED INVOICE              
         CLI   0(R3),C','          HAVE A COMMA LEFT OVER?                      
         BNE   IR79                NO                                           
         MVI   0(R3),C' '          YES - CLEAR IT                               
         B     IR79                GO PRINT THE INVOICES                        
*                                                                               
IR78     DS    0H                                                               
         MVC   0(2,R3),=C'++'      MORE INVOICES                                
         DROP  R4                                                               
*                                                                               
IR79     DS    0H                                                               
         GOTO1 AIRPRT                                                           
*                                                                               
* REPORT ADDED VALUE AIRED EVENTS                                               
*                                                                               
IR80     CLI   ADDEDVAL,C'Y'       ANYTHING TO REPORT                           
         BNE   IR85                                                             
         BRAS  RE,PRADDVAL                                                      
*                                                                               
* REPORT INVOICE TOTAL AND MATCHED TOTAL FOR THAT INVOICE                       
*                                                                               
IR85     CLI   I2ZPROF+5,C'Y'      PRINT INVOICE TOTALS                         
         BNE   IRTOTX                                                           
         BRAS  RE,PRINVTOT                                                      
*                                                                               
IRTOTX   DS    0H                                                               
         J     EXIT                                                             
*                                                                               
SREPEDT  DS    0H                                                               
         EDIT  (B4,(R6)),(13,(R5)),2,COMMAS=YES                                 
         BR    RE                                                               
*                                                                               
IRDIV2   DIV   (R0),(RF)           NOTE- RETURNS VIA RE                         
*                                                                               
ASTERS   DC    C'***********'                                                   
         SPACE 2                                                                
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
TOTWDS   DS    0H                                                               
         DC    X'00',CL21'MMATCHED'                                             
         DC    X'00',CL21'OORDERED NOT RUN'                                     
         DC    X'40',CL21'RRUN NOT ORDERED'                                     
         DC    X'00',CL21'XORDERED TOTAL'                                       
         DC    X'40',CL21'IINVOICE TOTAL'                                       
         DC    X'C0',CL21'DDEFERRED SPOTS'                                      
         DC    X'80',CL21'PPARTIAL MATCHES'                                     
         DC    X'20',CL21'CCASH TOTAL'                                          
         DC    X'20',CL21'TTRADE TOTAL'                                         
*-----------------------------------------------------------------              
*        PRINT INVOICE TOTALS                                                   
*-----------------------------------------------------------------              
*                                                                               
PRINVTOT NTR1  BASE=*,LABEL=*                                                   
         L     R4,AINOLST                                                       
         USING INOLSTD,R4                                                       
         CLI   0(R4),C' '          TEST ANY INVOICES                            
         BNH   PITX                                                             
*                                                                               
         GOTO1 AIRPRT                                                           
         MVC   P+5(18),=C'**INVOICE TOTALS**'                                   
         MVC   P2+7(14),DASHES                                                  
         GOTO1 AIRPRT                                                           
         MVC   P+5(56),=C'INVOICE         DETAIL COST    MATCHED COST  X        
                  MATCHED NET'                                                  
         MVI   P2+5,C'-'                                                        
         MVC   P2+6(58),P2+5                                                    
         GOTO1 AIRPRT                                                           
*                                                                               
PIT10    CLI   0(R4),C' '          END OF INVOICE LIST?                         
         BNH   PITX                YES - DONE                                   
*                                                                               
         CLI   MTRADE,C'Y'         MTRADE?                                      
         BNE   PIT10AA             NO                                           
         CLC   RQREP,SPACES        SPECIAL REP REQUEST?                         
         BNH   PIT10AA             NO                                           
         GOTO1 VRCPACK,DMCB,(C'U',INOLREP),WORK                                 
         CLI   Q2USER+6,C'Y'       NEGATIVE FILTER?                             
         BNE   *+18                NO                                           
         CLC   RQREP,WORK          NEGATIVE REP MATCHES?                        
         BE    PIT50               YES - REJECT                                 
         B     PIT10AA             PRINT THE INVOICE                            
         CLC   RQREP,WORK          REP MATCHES?                                 
         BNE   PIT50               NO - REJECT                                  
*                                                                               
PIT10AA  MVC   P+5(L'IHDINV),INOLINV                                            
         LA    R1,C'I'                                                          
         TM    INOFLAG,INOINVM     CAME FROM INVOICE MANAGER?                   
         BNZ   PIT10A              YES                                          
*                                                                               
         LA    R1,C'E'                                                          
         TM    INOFLAG,INOEASI     IS THIS INVOICE ELECTRONIC?                  
         BZ    PIT15               NO                                           
*                                                                               
PIT10A   LA    R3,P+5+L'IHDINV                                                  
         CLI   0(R3),C' '                                                       
         BH    *+8                                                              
         BCT   R3,*-8                                                           
         MVI   1(R3),C'('                                                       
         STC   R1,2(R3)                                                         
         MVI   3(R3),C')'                                                       
*                                                                               
PIT15    EDIT  INOLAMT,(12,P+21),2,MINUS=YES                                    
*                                                                               
         XC    FULL,FULL           TOTAL MATCHED DETAILS                        
         XC    WORD,WORD           TOTAL MATCHED DETAILS                        
         USING IELEMD,R3           INVOICE TABLE                                
         L     R3,AFINV                                                         
PIT20    C     R3,ALINV            LAST INVOICE                                 
         BNL   PIT40                                                            
*                                                                               
         CLC   INOLNUM,IINVID      RIGHT INVOICE                                
         BNE   PIT30                                                            
         OC    IBY,IBY             MATCHED?                                     
         BZ    PIT30               NO                                           
         ICM   R0,15,FULL          MATCHED COST                                 
         ICM   R1,15,ICOST                                                      
         TM    ISTAT,X'01'         TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         AR    R0,R1                                                            
         STCM  R0,15,FULL                                                       
*                                                                               
         SR    R8,R8                                                            
         ICM   R8,7,IBY                                                         
         A     R8,AFBY                                                          
         BCTR  R8,R0               POINT TO MATCHED BUY                         
         ICM   R0,15,WORD          MATCHED COST - NET                           
         ICM   R1,15,BYNET                                                      
         TM    BYSTAT,X'01'        TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         AR    R0,R1                                                            
         STCM  R0,15,WORD                                                       
*                                                                               
PIT30    AH    R3,IELMLEN                                                       
         B     PIT20                                                            
         DROP  R3                                                               
*                                                                               
PIT40    EDIT  (B4,FULL),(12,P+37),2,MINUS=YES                                  
         EDIT  (B4,WORD),(12,P+53),2,MINUS=YES                                  
         GOTO1 AIRPRT                                                           
*                                                                               
PIT50    AH    R4,INOLSTQ          NEXT INVOICE                                 
         B     PIT10                                                            
PITX     J     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
*-----------------------------------------------------------------              
*        PRINT ADDED VALUE AIRED EVENTS REPORT                                  
*-----------------------------------------------------------------              
*                                                                               
PRADDVAL NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         GOTO1 AIRPRT                                                           
*                                                                               
         MVC   P2+5(73),=C'-------------------  ADDED VALUE AIRED EVENTX        
               S ---------------------------'                                   
*                                                                               
         MVC   P3+5(48),=C'DATE    DAY    TIME   LEN   PRODUCT         X        
               COST'                                                            
         MVC   P4+5(48),=C'----    ---    ----   ---   -------         X        
               ----'                                                            
         CLI   NETINV,C'Y'                                                      
         BNE   *+16                                                             
         MVC   P3+45(3),=C'NET'                                                 
         MVC   P4+45(4),DASHES                                                  
*                                                                               
         CLI   PSEUDOPT,C'R'       FOR RESPONSES                                
         BNE   *+16                                                             
         MVC   P3+44(9),=C'RESPONSES'                                           
         MVC   P4+44(9),DASHES                                                  
*                                                                               
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BE    *+16                                                             
         MVC   P3+45(8),SPACES                                                  
         MVC   P4+45(8),SPACES                                                  
*                                                                               
         CLI   I2IPROF+1,C'Y'      MATCH ON INTEGRATION ONLY NO COST            
         BNE   *+16                                                             
         MVC   P3+45(8),=C'   INTEG'                                            
         MVC   P4+45(8),DASHES                                                  
*                                                                               
         CLI   I2IPROF,C'Y'        MATCH ON INTEGRATION AND COST                
         BNE   *+16                                                             
         MVC   P3+45(8),=C'COST+INT'                                            
         MVC   P4+45(8),DASHES                                                  
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   *+16                                                             
         MVC   P3+56(3),=C'PKG'                                                 
         MVC   P4+56(3),DASHES                                                  
*                                                                               
         TM    CBLHOPT,CBLHNHAQ    IF CBH REQ AND NEW MODE                      
         BNO   *+16                AND ALL NETS                                 
         MVC   P3+55(5),=C'NETWK'                                               
         MVC   P4+55(5),DASHES                                                  
*                                                                               
         CLI   TRAFSW,C'Y'                                                      
         BNE   *+22                                                             
         MVC   P2+59(12),DASHES                                                 
         MVC   P3+62(4),=C'FILM'                                                
         MVC   P4+62(12),DASHES                                                 
*                                                                               
         CLI   QBOOK1,C' '                                                      
         BE    PAV08                                                            
         MVC   P2+75(9),=C'DELIVERY-'                                           
*                                                                               
         L     R2,DEMPARS+4        A(DEMOTAB)                                   
         USING DTABD,R2                                                         
         LA    R3,P3+76                                                         
         L     R4,DEMPARS+8        NO. OF DEMS                                  
         LTR   R4,R4                                                            
         BZ    PAV08                                                            
*                                                                               
PAV04    DS    0H                                                               
         CLI   1(R2),0                                                          
         BE    PAV08                                                            
         MVC   0(7,R3),DTABNAM     DEMO NAME                                    
         MVC   132(7,R3),DASHES                                                 
         LA    R3,9(R3)                                                         
         LA    R2,DTABEL(R2)                                                    
         BCT   R4,PAV04                                                         
         DROP  R2                                                               
*                                                                               
PAV08    DS    0H                                                               
         MVC   P2+75(19),DASHES                                                 
         MVC   P3+84(9),=C'INVOICE #'                                           
         MVC   P4+84(10),DASHES                                                 
*                                                                               
         GOTO1 AIRPRT                                                           
*                                                                               
         USING IELEMD,R8           INVOICE TABLE                                
         L     R8,AFINV                                                         
PAV20    C     R8,ALINV            LAST INVOICE                                 
         BNL   PAVX                                                             
*                                                                               
         OC    IBY,IBY             MATCHED?                                     
         BNZ   PAV30               NO                                           
         TM    ISTAT3,IST3AVAL     ADDED VALUE AIRED EVENT                      
         BNO   PAV30                                                            
         BRAS  RE,FMTUNORD         UNMATCHED SPOT                               
*                                                                               
PAV30    AH    R8,IELMLEN                                                       
         B     PAV20                                                            
         DROP  R8                                                               
*                                                                               
PAVX     J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        LOOK UP DEMO ACHEIVEMENTS                                              
*-----------------------------------------------------------------              
ACHDEM   NMOD1 0,ACHDEM                                                         
         DROP  R6                                                               
         LA    RC,SPACEND                                                       
         L     R5,ADBUY                                                         
         USING BUYREC,R5                                                        
         L     R7,0(R1)                                                         
         USING IELEMD,R7                                                        
         MVC   SVPARAM(12),0(R1)    SAVE PARAMETERS                             
         LA    R1,SVPARAM                                                       
         ST    R1,SVR1                                                          
         MVC   SVADBUY,ADBUY                                                    
         MVI   SVNET,0                                                          
         OI    RQOPTS,RQOPTS_POST    FLAG TO INDICATE SPOT POSTING              
*                                                                               
         CLI   ILEN,0              ALSO SKIP IF ILEN=0 (MEDGETBY DUMPS)         
         BNE   ACHD2D                                                           
*                                                                               
         L     RF,4(R1)            A(OUTPUT)                                    
*                                                                               
ACHD2C   DS    0H                                                               
         CLI   1(RF),0             EOL                                          
         BE    ACHDEMX                                                          
         XC    4(4,RF),4(RF)       CLEAR DEMO VALUE                             
         LA    RF,8(RF)                                                         
         B     ACHD2C                                                           
*                                                                               
ACHD2D   DS    0H                                                               
         L     RE,=A(DUMBUY)                                                    
         ST    RE,ADBUY                                                         
         L     R5,ADBUY                                                         
         XC    0(L'DUMBUY,RE),0(RE)                                             
         SPACE 2                                                                
*                                  BUILD DUMMY BUY REC                          
         MVC   BUYKEY(1),BAGYMD                                                 
         MVC   BUYKEY+1(2),BCLT                                                 
         MVI   BUYKEY+3,X'FF'      BUILD A POL RECORD                           
         MVI   BUYRLEN+1,142                                                    
         CLC   QPRD,=C'POL'                                                     
         BE    ACHD3                                                            
         MVC   BUYKEY+3(1),IPRD                                                 
         MVI   BUYRLEN+1,138                                                    
*                                                                               
ACHD3    DS    0H                                                               
         MVC   BUYKEY+4(5),BMKTSTA                                              
         CLI   ICBLNET,0           HAVE CABLE NETWORK?                          
         BE    ACHD3A              NO                                           
         NI    BUYKEY+8,X'80'      TURN OFF NETWORK BITS                        
         OC    BUYKEY+8(1),ICBLNET REPLACE WITH CURRENT NETWORK                 
         MVC   SVNET,SVBUYKEY+8    SAVE OFF THE NETWORK                         
         MVC   SVBUYKEY+8(1),BUYKEY+8   MEDGETBY SHOULD NOT SET SPILL!          
*                                                                               
ACHD3A   MVI   BUYKEY+9,1          EST SHOULD NOT BE ZERO                       
         MVC   BUYKEY+20(2),QAGY                                                
         MVI   BDCODE,1                                                         
         MVI   BDLEN,70                                                         
         MVI   BDWKS,1                                                          
         MVI   BDWKIND,C'O'                                                     
         MVI   BDNOWK,1                                                         
*                                  NDELEM                                       
         LA    R2,BUYREC+94                                                     
         USING NDELEM,R2                                                        
         MVI   NDCODE,2                                                         
         MVI   NDLEN,32                                                         
         MVC   NDBOOK,=X'5A02'                                                  
         MVC   NDEMNO(3),=X'00C901'     HOMES                                   
*                                                                               
         ICM   RF,15,SVPARAM+8     IF WE HAVE BUY RECORD                        
         BZ    ACHD4                                                            
         TM    BYSTAT-BYELEMD(RF),X'80'   AND IS -S SPECIAL                     
         BZ    ACHD4                                                            
         L     RF,SVPARAM+4        NEED TO SET DEMOS                            
         MVC   NDEMNO(3),0(RF)     CODE FOR FIRST                               
         MVC   NDEMRAW(4),4(RF)                                                 
         OC    8(3,RF),8(RF)       DO WE HAVE 2ND DEMO                          
         BZ    ACHD4                                                            
         MVI   NDLEN,40            LONGER ELEM LENGTH                           
         MVC   NDEMNO+8(3),8(RF)     CODE FOR 2ND                               
         MVC   NDEMRAW+8(4),12(RF)                                              
*                                                                               
ACHD4    EQU   *                                                                
         LLC   RF,NDLEN                                                         
         AR    R2,RF               NEXT ELEM POSITION                           
         DROP  R2                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(2,IDAT),(3,BDSTART)                                 
         SPACE 1                                                                
         MVC   BDEND,BDSTART                                                    
         MVC   BDDAY,IDAY                                                       
         MVC   BDSEC,ILEN                                                       
         MVC   BDPROG(2),ITIM                                                   
         MVI   BDPROG+4,C' '                                                    
         MVC   BDPROG+5(17),BDPROG+4                                            
         ICM   RF,15,SVPARAM+8          IF WE HAVE BUY RECORD                   
         BZ    ACHD5                                                            
*                                                                               
         SR    R1,R1                    USE BUY START/END TIMES                 
         ICM   R1,3,BYSTIM-BYELEMD(RF)  MUST CONVERT TO MILITARY                
         SR    R0,R0                                                            
         D     R0,=F'60'                                                        
         MHI   R1,100                                                           
         AR    R0,R1                                                            
         CHI   R0,2400                                                          
         BNH   *+8                                                              
         AHI   R0,-2400                                                         
         STCM  R0,3,BDPROG+0                                                    
*                                                                               
         SR    R1,R1                    END TIME                                
         ICM   R1,3,BYETIM-BYELEMD(RF)                                          
         SR    R0,R0                                                            
         D     R0,=F'60'                                                        
         MHI   R1,100                                                           
         AR    R0,R1                                                            
         CHI   R0,2400                                                          
         BNH   *+8                                                              
         AHI   R0,-2400                                                         
         STCM  R0,3,BDPROG+2                                                    
*                                                                               
         MVC   BDPROGRM(1),BYPROGRM-BYELEMD(RF)  1ST BYTE OF PROGRAM            
         TM    BYSTAT-BYELEMD(RF),X'80'   IF A -S SPECIAL                       
         BZ    *+8                                                              
         MVI   BDPROG+21,0         SET LST BYTE OF PROGRAM TO NULL              
*                                                                               
ACHD5    DS    0H                  REGELEM                                      
         USING REGELEM,R2                                                       
         CLI   BUYKEY+3,X'FF'                                                   
         BE    ACHD6                                                            
         MVI   RCODE,6                                                          
         MVI   RLEN,10                                                          
         MVC   RDATE,IDAT                                                       
         MVI   RNUM,1                                                           
         LA    R2,10(R2)                                                        
         B     ACHD8                                                            
ACHD6    EQU   *                                                                
         MVI   RCODE,11                                                         
         MVI   RLEN,14                                                          
         MVC   RDATE,IDAT                                                       
         MVC   RPPRD,IPRD                                                       
*                                                                               
         TM    SVCOPT1,COP1GMI     GMI CLIENT = NTP                             
         BO    ACHD6A                                                           
         CLC   QAGY,=C'DF'                                                      
         BNE   ACHD7                                                            
ACHD6A   CLI   RPPRD,X'FF'         CAN'T HAVE POL BUY FOR DF -                  
         BNE   ACHD7               IT MAKES GETRATE DUMP-NTP                    
         MVI   RPPRD,X'01'         USE PRD 01 - PER MEL 2/10/00                 
*                                                                               
ACHD7    MVC   RPTIME,ILEN                                                      
         LA    R2,14(R2)                                                        
         DROP  R2                                                               
*                                                                               
ACHD8    DS    0H                                                               
         MVI   0(R2),16                                                         
         MVI   1(R2),6                                                          
         MVC   2(2,R2),IDAT                                                     
         MVC   4(2,R2),ITIM                                                     
         LA    R2,6(R2)                                                         
*                                                                               
ACHD9    ICM   RF,15,SVPARAM+8     IF WE HAVE BUY RECORD                        
         BZ    *+10                NO                                           
         MVC   BKTYPE,BYBKTYPE-BYELEMD(RF)   SAVE BOOK TYPE                     
         CLI   BKTYPE,0            ANY BOOK TYPE?                               
         BE    ACHD9M              NO                                           
         SR    RF,RF               YES - WILL NEED DLUELEM                      
         ICM   RF,3,BUYRLEN        BUMP RECORD LENGTH                           
         LA    RF,6(RF)                                                         
         STCM  RF,3,BUYRLEN                                                     
*                                                                               
         MVI   0(R2),X'24'         BOOK TYPE ELEM                               
         MVI   1(R2),6                                                          
         MVC   2(1,R2),BKTYPE                                                   
         LA    R2,6(R2)                                                         
*                                                                               
ACHD9M   DS    0H                                                               
         L     RE,MEDBUFF          SET UP MEDBLOCK                              
         USING MEDBLOCK,RE                                                      
         MVC   MEDBRAND,IPRD                                                    
         MVC   MEDSPTLN,ILEN                                                    
         LHI   RF,(219*PTBUFFL)                                                 
         CLI   IPRD,X'FF'                                                       
         BE    ACHD10                                                           
         LLC   RF,MEDBRAND         SET UP BRAND DEMOS                           
         BCTR  RF,0                                                             
         MH    RF,PRDBUFLN                                                      
ACHD10   DS    0H                                                               
         A     RF,PRDBUFF                                                       
         XC    28(PTBUFFL-28,RF),28(RF)                                         
         L     R1,SVR1                                                          
         L     R4,4(R1)                                                         
ACHD10B  CLI   1(R4),0             SET DEMO CODES                               
         BE    ACHD10D                                                          
         MVC   28(3,RF),0(R4)                                                   
         LA    RF,3(RF)                                                         
         LA    R4,8(R4)                                                         
         B     ACHD10B                                                          
         SPACE 2                                                                
ACHD10D  DS    0H                                                               
         LA    R4,6                     AFFID DEMOS                             
         OC    SVPARAM+8(4),SVPARAM+8   UNLESS HAVE BUY RECORD                  
         BZ    ACHD11                                                           
         CLI   QRERATE,C'R'             AND DOING REREATED                      
         BNE   ACHD11                                                           
         LA    R4,3                     THEN RERATED                            
ACHD11   DS    0H                                                               
         CLC   QHUT1,=C'NO'                                                     
         BE    *+8                                                              
         LA    R4,1(R4)                  ADJUSTED                               
         XC    KEY,KEY                   FILL IN KEY FOR MEDGETBY FOR           
         MVC   KEY(10),BUYKEY            CANADIAN SOFT DEMOS                    
         GOTO1 MEDGETBY,DMCB,(RA),(R4)                                          
*                                                                               
         L     RE,MEDBUFF          SET UP MEDBLOCK POINTERS                     
         L     R1,SVR1              AND OUTPUT POINTERS                         
         L     R4,4(R1)                                                         
         L     R5,MEDAFRST                                                      
         L     R6,4(R5)                                                         
         USING MEDDATA,R6                                                       
ACHD20   MVC   4(4,R4),MEDBY1                                                   
*                                                                               
         CLI   2(R4),0             COMSCORE DEMO?                               
         BNE   ACHD21              NO                                           
         LLC   R1,1(R4)            DEMO INDEX INTO NTDDMONM                     
         BCTR  R1,0                -1                                           
         MHI   R1,9                *9                                           
         L     RF,VPOL50EL         A(X'50' ELEMENT) FROM BUY RECORD             
         LA    RF,2(R1,RF)         INDEX TO DEMO NAME ON BUY RECORD             
         CLI   0(RF),C'R'          RATING?                                      
         B     ACHD21A             GO TEST CC                                   
*                                                                               
ACHD21   CLI   1(R4),C'R'          RATING?                                      
         BE    ACHD21B             YES                                          
         CLI   1(R4),C'E'          EXTENDED RATING?                             
ACHD21A  BE    ACHD21B             YES                                          
         TM    RQOPTS,RQOPTS_2DECIMP  WANT 2 DECIMAL IMPRESSIONS?               
         B     *+8                 GO TEST CC                                   
ACHD21B  TM    RQOPTS,RQOPTS_2DEC  TEST 2-DEC REQUEST                           
         BZ    ACHD22              NO                                           
         OI    4(R4),X'40'         SET 2-DEC FLAG                               
*                                                                               
ACHD22   LA    R4,8(R4)                                                         
         CLI   1(R4),0                                                          
         BE    ACHDEMX                                                          
         LA    R6,8(R6)                                                         
         B     ACHD20                                                           
ACHDEMX  MVC   ADBUY,SVADBUY                                                    
         CLI   SVNET,0             DID WE CHANGE NETWORK BITS?                  
         BE    *+10                NO                                           
         MVC   SVBUYKEY+8(1),SVNET RESET FOR SPREPI203                          
         J     EXIT                                                             
SVR1     DS    F                                                                
SVPARAM  DS    6F                                                               
SVNET    DS    CL1                                                              
         DROP  R6,R7,RE                                                         
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        PRINT SUMMARY                                                          
*-----------------------------------------------------------------              
*                                                                               
IRSUM    NMOD1 0,IRSUM                                                          
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
***      CLC   SVPROG,=C'IL'      IF SPECIAL LETTER REPORT SKIP SUM             
***      BE    IRSUMX                                                           
*                                  IS WHAT THEY WANT)                           
         CLI   RCWHATPR,1          IF 2 PRINTER MODE                            
         BNH   *+8                                                              
         MVI   RCWHATPR,1          RESET TO FIRST PRINTER FOR SUMMARY           
*                                                                               
         MVC   SAVSPROG,RCSUBPRG                                                
         MVI   RCSUBPRG,10                                                      
         CLI   COSTSUP,C'N'        IF SUPPRESSING COSTS                         
         BE    *+8                                                              
         MVI   RCSUBPRG,11         USE DIFFERENT HEADLINES                      
         CLI   SAVEQRSP,C'Y'       IF DOING RESPONSES                           
         BNE   IRSUM0                                                           
         LLC   RF,RCSUBPRG         BUMP SPROG BY 2                              
         LA    RF,2(RF)                                                         
         STC   RF,RCSUBPRG                                                      
*                                                                               
IRSUM0   DS    0H                                                               
         MVI   PAGSW,C'S'                                                       
         MVI   SUMSW,0                                                          
         MVI   DSUMMSK,0                                                        
         MVI   DSUMSW,0                                                         
*                                                                               
IRSUM1   DS    0H                                                               
         MVI   FORCEHED,C'P'                                                    
         MVC   PAGE,=H'1'                                                       
         XC    LASTSUM,LASTSUM                                                  
*                                                                               
         XC    SUMREC(SUMDL),SUMREC                                             
         LA    R2,P                                                             
         USING SLD,R2                                                           
*                                                                               
         LA    R0,BUFFARDH                                                      
         GOTO1 =V(BUFFERIN),DMCB,((R0),ABUFFRN2),(0,SUMREC),ACOMFACS            
****     GOTO1 BUFFALO,DMCB,=C'HIGH',ABUFFC,SUMREC,0                            
         B     IRSUM2C                                                          
IRSUM2B  DS    0H                                                               
         LA    R0,BUFFASEQ                                                      
         GOTO1 =V(BUFFERIN),DMCB,((R0),ABUFFRN2),(0,SUMREC),ACOMFACS            
***      GOTO1 BUFFALO,DMCB,=C'SEQ',ABUFFC,SUMREC,0                             
IRSUM2C  DS    0H                                                               
         CLI   4(R1),0                                                          
         BE    *+8                                                              
***      TM    DMCB+8,X'80'        END                                          
***      BZ    *+8                                                              
         MVI   SUMREC,X'FF'                                                     
         CLC   SUREG(7),LASTSUM    TEST MONTH BREAK                             
         BE    IRSUM4                                                           
         OC    LASTSUM,LASTSUM                                                  
         BZ    IRSUM3                                                           
*                                                                               
*                                  ADD TO REPORT TOTS                           
IRSUM2D  DS    0H                                                               
         LA    R1,PERSTOTS                                                      
         LA    RF,REPSTOTS                                                      
         LA    R0,10                                                            
IRSUM2E  DS    0H                                                               
         L     RE,0(R1)                                                         
         A     RE,0(RF)                                                         
         ST    RE,0(RF)                                                         
         LA    R1,4(R1)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,IRSUM2E                                                       
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P2,SPACES                                                        
         GOTO1 AIRPRT                                                           
         LA    R5,PERSTOTS                                                      
         BAS   RE,IRSTOTS                                                       
*                                                                               
         CLC   SUREG,LASTSUM                                                    
         BE    IRSUM4                                                           
*                                                                               
         LA    R5,REPSTOTS                                                      
         MVC   SAVPER(14),=C'TOTAL         '                                    
         BAS   RE,IRSTOTS                                                       
*                                                                               
IRSUM3   DS    0H                                                               
         MVI   X,C' '                                                           
         MVC   X+1(134),X                                                       
         MVI   FORCEHED,C'P'                                                    
         OC    SUREG,SUREG                                                      
         BZ    IRSUM4                                                           
         CLI   SUREG,X'FF'         TEST END                                     
         BE    IRSUM12                                                          
*                                  GET MARKET GROUP NAME                        
         GOTO1 BINSRCH,MGTBPARS,SUREG                                           
         CLI   MGTBPARS,0          TEST NOT FOUND                               
         BNE   IRSUM3B                                                          
         L     RF,MGTBPARS                                                      
         MVC   X+00(45),03(RF)                                                  
         MVC   X+45(45),48(RF)                                                  
         MVC   X+90(45),93(RF)                                                  
         B     IRSUM4                                                           
*                                                                               
IRSUM3B  DS    0H                  MGR NAME TABLE OVERFLOW                      
         MVC   X(1),SUREG                                                       
         UNPK  X+1(5),SUREG+1(3)                                                
         MVC   X+5(5),=C' ****'                                                 
*                                                                               
IRSUM4   DS    0H                                                               
         MVC   LASTSUM,SUMD                                                     
         MVC   HEAD4+50(45),X                                                   
         MVC   HEAD5+50(45),X+45                                                
         MVC   HEAD6+50(45),X+90                                                
         MVC   WORK(2),SUMKT                                                    
         MVC   WORK+2(3),SUSTA                                                  
         MVC   BYTE2,QMED          SAVE QMED                                    
         MVC   QMED,SUMED          USE RIGHT MEDIA                              
         GOTO1 MSUNPK,DMCB,(X'80',WORK),SLMKT,WORK+10                           
         MVC   QMED,BYTE2          RESTORE                                      
         MVC   SLSTA,WORK+10                                                    
         CLI   SLSTA,C'0'          LOCAL CABLE                                  
         BL    *+12                                                             
         MVI   SLSTA+4,C'/'        NEEDS A /                                    
         B     IRSUM4A                                                          
         CLI   SLSTA+4,C'D'       DIGITAL?                                      
         BNE   *+8                NO                                            
         MVI   SLSTA+5,C'V'                                                     
         CLI   SLSTA+4,C'S'       STREAMING?                                    
         BNE   *+8                NO                                            
         MVI   SLSTA+5,C'M'                                                     
         CLI   SLSTA+4,C'C'       STREAMING?                                    
         BNE   *+8                NO                                            
         MVI   SLSTA+5,C'M'                                                     
*                                  MKT NAME                                     
IRSUM4A  GOTO1 BINSRCH,MKTBPARS,SUMKT                                           
         CLI   MKTBPARS,0          TEST NOT FOUND                               
         BNE   *+14                                                             
         L     RF,MKTBPARS                                                      
         MVC   SLMNAM,2(RF)                                                     
*                                                                               
         CLI   SUID,C' '           TEST ID PRESENT                              
         BNH   IRSUM6                                                           
         CLI   NETPSW,C'Y'                                                      
         BE    IRSUM5                                                           
         MVC   SLMNAM+132+2(3),=C'ID='                                          
         MVC   SLMNAM+132+5(12),SUID                                            
         B     IRSUM6                                                           
IRSUM5   MVC   SLMNAM+132+2(12),SUID                                            
*                                                                               
IRSUM6   DS    0H                                                               
*        LA    R3,SUPRD1                                                        
*        LA    R4,SLPRD                                                         
*        BAS   RE,GPRD                                                          
*                                                                               
         MVC   SLPRD(7),SPACES                                                  
         MVC   SLPRD(3),SUPRD1                                                  
         CLC   SUPRD2,SPACES        HAVE PRODUCT2?                              
         BNH   IRSUM8               NO, DONE                                    
         MVI   SLPRD+3,C'-'                                                     
         MVC   SLPRD+4(3),SUPRD2                                                
*                                                                               
IRSUM8   DS    0H                                                               
         CLI   DSUMMSK,0           TEST DISCREPANCIES ONLY THIS TIME            
         BE    IRSUM8D             NO                                           
         MVC   BYTE,SUSTATUS       YES- TEST VS STATUS BYTE                     
         NC    BYTE,DSUMMSK                                                     
         BZ    IRSUM11J            SKIP UNWANTED ONES                           
*                                                                               
IRSUM8D  DS    0H                                                               
         MVI   SLSTATUS+2,C'S'                                                  
         TM    SUSTATUS,X'F8'                                                   
         BZ    IRSUM10                                                          
IRSUM9   DS    0H                                                               
         TM    SUSTATUS,X'70'      TEST ACTUAL MISMATCHES                       
         BZ    *+10                                                             
         MVC   SLSTATUS(3),=C'**U'                                              
         TM    SUSTATUS,X'80'      TEST FILM ERR                                
         BZ    *+10                                                             
         MVC   SLSTATUS+4(6),=C'(FILM)'                                         
         TM    SUSTATUS,X'08'      H/V ERROR                                    
         BZ    *+10                                                             
         MVC   SLSTATUS+4(6),=C'(H/V) '                                         
         TM    SUSTATUS,X'88'      TEST FILM AND H/V                            
         BNO   *+10                                                             
         MVC   SLSTATUS+4(7),=C'(F,H/V)'                                        
         CLI   SLSTATUS+4,C' '                                                  
         BNE   IRSUM10                                                          
*                                                                               
         TM    SUSTATUS,X'30'                                                   
         BZ    IRSUM10                                                          
         MVC   SLSTATUS+4(07),=C'-NO INV'                                       
         TM    SUSTATUS,X'20'                                                   
         BO    *+10                                                             
         MVC   SLSTATUS+8(03),=C'ORD'                                           
IRSUM10  DS    0H                                                               
         OC    SUPAGE,SUPAGE                                                    
         BZ    IRSUM11                                                          
         EDIT  (B2,SUPAGE),(4,SLPAGE)                                           
*                                                                               
IRSUM11  DS    0H                                                               
         CLI   SUEST,0                                                          
         BE    IRSUM11B                                                         
         LLC   R0,SUEST                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SLEST(3),DUB                                                     
         CLI   SUEST2,0            TEST 2(D EST                                 
         BE    IRSUM11B                                                         
         MVI   SLEST+3,C'-'                                                     
         LLC   R0,SUEST2                                                        
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SLEST+4(3),DUB                                                   
*                                                                               
IRSUM11B DS    0H                                                               
         EDIT  (B2,SUSPTS),(4,SLSPTS)                                           
         OI    SLSPTS+3,X'F0'                                                   
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BNE   IRSUM11D                                                         
         EDIT  (B4,SUGRS),(13,SLGRS),2,COMMAS=YES,MINUS=YES                     
         EDIT  (B4,SUNET),(13,SLNET),2,COMMAS=YES,MINUS=YES                     
         CLI   SAVEQRSP,C'Y'       RESPONSES                                    
         BNE   IRSUM11C            (NOTE- OVERLAYS PAID)                        
         EDIT  (B4,SURESP),(9,SLRESP),COMMAS=YES                                
         B     IRSUM11D                                                         
IRSUM11C DS    0H                                                               
         OC    SUSPTS,SUSPTS                                                    
         BZ    IRSUM11D                                                         
         TM    SUSTATUS,X'01'                                                   
         BZ    *+10                                                             
         MVC   SLPAID,=C'YES'                                                   
*                                                                               
IRSUM11D DS    0H                                                               
         XC    WORK,WORK                                                        
         TM    SUPER+1,X'1F'       TEST MONTH ONLY                              
         BZ    IRSUM11E                                                         
*                                  BOTH DATES                                   
         GOTO1 DATCON,DMCB,(2,SUPER),(5,WORK)                                   
*                                                                               
         GOTO1 (RF),(R1),(2,SUPER+2),(5,WORK+6)                                 
*                                                                               
         MVI   WORK+5,C'-'                                                      
         CLC   WORK(3),WORK+6                                                   
         BNE   *+16                                                             
         MVC   WORK+6(5),WORK+9                                                 
         MVC   WORK+11(3),=C'   '                                               
         MVC   SLPER,WORK                                                       
         B     IRSUM11F                                                         
*                                  MONTH ONLY                                   
IRSUM11E DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,SUPER+0),(6,SLPER)                                
*                                                                               
*                                                                               
IRSUM11F DS    0H                                                               
         MVC   SAVPER,SLPER             SAVE EXPANDED PEREOD                    
         GOTO1 AIRPRT                                                           
         OC    SUMSW,SUSTATUS      KEEP TRACK OF DISCREPANCY TYPES              
         LA    R3,PERUTOTS                                                      
         TM    SUSTATUS,X'F8'                                                   
         BNZ   *+12                                                             
         LA    R3,PERSTOTS                                                      
         OI    SUMSW,X'02'         SET HAVE FOUND PERFECT MATCHES               
         L     R1,0(R3)                                                         
         LA    R1,1(R1)                                                         
         ST    R1,0(R3)                                                         
         L     R1,4(R3)                                                         
         MVC   HALF,SUSPTS                                                      
         AH    R1,HALF                                                          
         ST    R1,4(R3)                                                         
         L     R1,8(R3)                                                         
         MVC   FULL,SUGRS                                                       
         A     R1,FULL                                                          
         ST    R1,8(R3)                                                         
         L     R1,12(R3)                                                        
         MVC   FULL,SUNET                                                       
         A     R1,FULL                                                          
         ST    R1,12(R3)                                                        
         CLI   SAVEQRSP,C'Y'       IF DOING RESPONSES                           
         BNE   IRSUM11H                                                         
         L     R1,16(R3)                                                        
         MVC   FULL,SURESP         SUM THEM                                     
         A     R1,FULL                                                          
         ST    R1,16(R3)                                                        
         B     IRSUM11J                                                         
*                                                                               
IRSUM11H DS    0H                                                               
         TM    SUSTATUS,X'01'      ELSE TEST PAID                               
         BZ    IRSUM11J                                                         
         L     R1,16(R3)                                                        
         LA    R1,1(R1)                                                         
         ST    R1,16(R3)                                                        
*                                                                               
*                                                                               
IRSUM11J DS    0H                                                               
         B     IRSUM2B                                                          
IRSUM12  DS    0H                                                               
         CLI   DSUMOPT,C'N'                                                     
         BE    IRS20                                                            
         CLI   DSUMOPT,C'S'        TEST DOING TYPES SEPARATELY                  
         BNE   IRS14                                                            
*                                                                               
         CLI   DSUMSW,0                                                         
         BNE   IRS13                                                            
         MVI   DSUMSW,C'M'         MISMATCHES FIRST                             
         MVI   DSUMMSK,X'70'                                                    
         MVC   BYTE,SUMSW          TEST ANY OF THIS TYPE                        
         NC    BYTE,DSUMMSK                                                     
         BZ    *+8                                                              
         B     IRS16                                                            
*                                                                               
IRS13    DS    0H                                                               
         CLI   DSUMSW,C'M'                                                      
         BNE   IRS13B                                                           
         MVI   DSUMSW,C'F'         THEN FILMS                                   
         MVI   DSUMMSK,X'80'                                                    
         MVC   BYTE,SUMSW          TEST ANY OF THIS TYPE                        
         NC    BYTE,DSUMMSK                                                     
         BZ    *+8                                                              
         B     IRS16                                                            
*                                                                               
IRS13B   DS    0H                                                               
         CLI   DSUMSW,C'F'                                                      
         BNE   IRS13D                                                           
         MVI   DSUMSW,C'R'         THEN H/V ROTATIONS                           
         MVI   DSUMMSK,X'08'                                                    
         MVC   BYTE,SUMSW          TEST ANY OF THIS TYPE                        
         NC    BYTE,DSUMMSK                                                     
         BZ    *+8                                                              
         B     IRS16                                                            
*                                                                               
IRS13D   DS    0H                                                               
         B     IRS20               THEN DONE                                    
*                                                                               
IRS14    DS    0H                  TYPES OF DISCREPANCIES NOT SEPARATE          
         CLI   DSUMSW,0                                                         
         BNE   IRS14D                                                           
         TM    SUMSW,X'02'         TEST HAD ANY PERFECT MATCHES                 
         BZ    IRS20               NO- DONE, DONT REPEAT LIST                   
         MVI   DSUMSW,C'A'                                                      
         MVI   DSUMMSK,X'F8'       ALL TYPES TOGETHER                           
         MVC   BYTE,SUMSW          TEST ANY OF THIS TYPE                        
         NC    BYTE,DSUMMSK                                                     
         BZ    *+8                                                              
         B     IRS16                                                            
*                                                                               
IRS14D   DS    0H                                                               
         B     IRS20               DONE                                         
*                                                                               
IRS16    DS    0H                                                               
         B     IRSUM1                                                           
IRS20    DS    0H                                                               
IRSUMX   DS    0H                                                               
         LA    R0,BUFFAINI         INIT BUFFERIN                                
         GOTO1 =V(BUFFERIN),DMCB,((R0),ABUFFRN2),(0,0),ACOMFACS                 
         CLI   4(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
****     GOTO1 BUFFALO,DMCB,=C'RESET',ABUFFC                                    
         XC    MKTBPARS+8(4),MKTBPARS+8                                         
         XC    MGTBPARS+8(4),MGTBPARS+8                                         
         MVI   PAGSW,0                                                          
         MVC   RCSUBPRG,SAVSPROG                                                
         J     EXIT                                                             
         SPACE 3                                                                
IRSTOTS  NTR1                                                                   
         SPACE 2                                                                
         MVC   SLD+45(10),=C'SUCCESSFUL'                                        
         LR    R6,R5                                                            
         BAS   RE,IRSTPRT                                                       
         MVC   SLD+29(14),SAVPER                                                
         GOTO1 AIRPRT                                                           
*                                                                               
         MVC   SLD+45(12),=C'UNSUCCESSFUL'                                      
         LA    R6,20(R5)                                                        
         BAS   RE,IRSTPRT                                                       
         GOTO1 AIRPRT                                                           
*                                                                               
         LR    R4,R5                                                            
         LA    R0,5                                                             
IRST2    DS    0H                                                               
         L     R1,0(R4)                                                         
         A     R1,20(R4)                                                        
         ST    R1,20(R4)                                                        
         LA    R4,4(R4)                                                         
         BCT   R0,IRST2                                                         
*                                                                               
         MVC   SLD+45(5),=C'TOTAL'                                              
         BAS   RE,IRSTPRT                                                       
         MVI   SPACING,2                                                        
         GOTO1 AIRPRT                                                           
*                                                                               
         XC    0(40,R5),0(R5)                                                   
         J     EXIT                                                             
*-----------------------------------------------------------------              
*                                                                               
IRSTPRT  DS    0H                                                               
         LA    R4,SLSTATUS-1                                                    
         EDIT  (B4,0(R6)),(4,0(R4))                                             
         OI    3(R4),C'0'                                                       
         LA    R4,SLSPTS-1                                                      
         EDIT  (B4,4(R6)),(5,0(R4))                                             
         OI    4(R4),C'0'                                                       
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BNER  RE                                                               
*                                                                               
         EDIT  (B4,8(R6)),(14,SLGRS),2,COMMAS=YES,CR=YES                        
         EDIT  (B4,12(R6)),(14,SLNET),2,COMMAS=YES,CR=YES                       
         CLI   SAVEQRSP,C'Y'  IF DOING RESPONSES                                
         BNE   IRSTP4                                                           
         EDIT  (B4,16(R6)),(9,SLRESP),COMMAS=YES                                
         OI    8(R4),C'0'                                                       
         B     IRSTP5                                                           
IRSTP4   DS    0H                                                               
         LA    R4,SLPAID-1                                                      
         EDIT  (B4,16(R6)),(4,0(R4))                                            
         OI    3(R4),C'0'                                                       
IRSTP5   DS    0H                                                               
         BR    RE                                                               
*&&DO                                                                           
*-----------------------------------------------------------------              
GPRD     DS    0H                                                               
         LR    R0,RE                                                            
         MVC   0(7,R4),SPACES                                                   
         BAS   RE,GPRDC                                                         
         CLI   1(R3),0                                                          
         BE    GPRDX                                                            
         MVI   3(R4),C'-'                                                       
         LA    R3,1(R3)                                                         
         LA    R4,4(R4)                                                         
         BAS   RE,GPRDC                                                         
GPRDX    DS    0H                                                               
         LR    RE,R0                                                            
         BR    RE                                                               
         SPACE 2                                                                
GPRDC    DS    0H                                                               
         CLI   0(R3),0                                                          
         BER   RE                                                               
         MVC   0(3,R4),PRD                                                      
         CLC   0(1,R3),BPRD                                                     
         BER   RE                                                               
*                                                                               
         L     R1,ADCLT                                                         
         LA    R1,CLIST-CLTHDR(R1)                                              
         LA    RF,220              220 PRDS IN CLIST                            
*                                                                               
GPRDC2   DS    0H                                                               
         CLI   3(R1),0                                                          
         BER   RE                                                               
         CLC   0(1,R3),3(R1)                                                    
         BE    GPRDC3                                                           
         LA    R1,4(R1)                                                         
         BCT   RF,GPRDC2                                                        
*                                                                               
         CLI   NETPSW,C'Y'         TEST NETPAK                                  
         BE    *+6                 ONLY CLIST2 FOR NET                          
         DC    H'0'                                                             
*                                                                               
         L     R1,ADCLT                                                         
         LA    R1,CLIST2-CLTHDR(R1)                                             
         LA    RF,35               35 PRODUCTS IN CLIST2                        
GPRDC2A  CLI   3(R1),0                                                          
         BER   RE                                                               
         CLC   0(1,R3),3(R1)                                                    
         BE    GPRDC3                                                           
         LA    R1,4(R1)                                                         
         BCT   RF,GPRDC2A                                                       
         DC    H'0'                                                             
*                                                                               
GPRDC3   DS    0H                                                               
         MVC   0(3,R4),0(R1)                                                    
         BR    RE                                                               
*&&                                                                             
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        BUCKET TOTALS AND DETERMINE STATUS OF RECONCILIATION                   
*-----------------------------------------------------------------              
IRSTAT   NMOD1 0,IRSTAT                                                         
         LA    RC,SPACEND                                                       
         USING BYELEMD,R7                                                       
         USING IELEMD,R8                                                        
         MVI   HVROTERR,C'N'                                                    
         XC    MATSPTS(TOTSL),MATSPTS                                           
         MVI   PARTIAL,C'N'                                                     
         MVI   MATSTAT,0                                                        
         MVI   ADDEDVAL,C'N'                                                    
         MVI   PDSTAT,X'01'        PAID STATUS ON                               
         CLC   ALBY,AFBY           BUT IF NO BUYS                               
         BH    *+8                                                              
         MVI   PDSTAT,0            SET IF OFF                                   
*                                  BUYS                                         
         L     R7,AFBY                                                          
IR2      C     R7,ALBY                                                          
         BNL   IR4                                                              
         TM    BYSTAT2,BYSTMISQ    BYPASS MISSED SPOTS                          
         BNZ   IR3Z                                                             
         TM    BYSTAT,X'08'        BYPASS ORBIT SLAVES                          
         BNZ   IR3Z                                                             
*                                                                               
         CLI   PIGCTL,C'S'         IF PIGS SEPARATELY                           
         BNE   IR2D                                                             
         CLC   PIGFILT,BYPRD2      MUST BE RIGHT PIGGY                          
         BNE   IR3Z                                                             
IR2D     DS    0H                                                               
         LLC   R5,BYNOWK                                                        
         LLC   R6,BYUNACH          R6=UNACHIEVED                                
         SR    R5,R6               R5=ACHIEVED                                  
         LTR   R6,R6               IF UNACHIEVED                                
         BZ    IR2F                                                             
*                                  TEST 'DEFERRED'                              
         CLI   PROGPROF+9,C'C'     NOT IF CALENDAR MONTHS                       
         BE    IR2E                                                             
         CLC   BYEDT,BQENDP        IF END DATE NOT OUTSIDE MONTH                
         BNH   IR2E                NOT DEFERRED                                 
         TM    BYSTAT,X'02'        OR IF NOT POL                                
         BNZ   IR2F                                                             
*                                                                               
IR2E     DS    0H                                                               
         OI    MATSTAT,X'80'       HAVE ORDERED NOT RUN                         
         TM    SVCOPT1,COP1GMI     GMI CLIENT = NTP                             
         BO    IR2E1                                                            
         CLC   QAGY,=C'DF'         FOR SAATCH1 PROGRAM EXCHANGE                 
         BNE   IR2F                                                             
IR2E1    CLI   NETPSW,C'Y'         FOR NETPAK - SKIP                            
         BE    IR2F                                                             
         TM    BYSTAT,X'20'        IF NTP AND ORD NOT RUN                       
         BZ    IR2F                (POL ONLY?)                                  
         ORG   *-4                 *** NOOP ***                                 
         B     IR2F                *** NOOP ***                                 
         XC    BYCOST,BYCOST       CLEAR COST                                   
*                                                                               
IR2F     DS    0H                                                               
         XC    WORK,WORK                                                        
         LA    R3,WORK                                                          
         USING SREPD,R3                                                         
         OC    SREPCOD,BYSREP                                                   
         BNZ   *+8                                                              
         MVI   SREPCOD,X'FF'                                                    
         MVC   DUB(4),BYCOST                                                    
         L     R1,DUB                                                           
         TM    BYSTAT,X'01'        TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         CLI   CENTS,C'Y'          TEST HAVE PENNIES                            
         BE    *+8                                                              
         M     R0,=F'100'                                                       
         ST    R1,DUB                                                           
         MR    R0,R5               MATCHED                                      
         ST    R1,FULL                                                          
         MVC   SREPMGRS,FULL                                                    
         A     R1,MATGRS                                                        
         ST    R1,MATGRS                                                        
         L     R1,DUB                                                           
         MR    R0,R6               ONR                                          
         LR    RF,R1                                                            
         A     RF,FULL             ONR + MATCHED                                
         ST    RF,FULL             =ORDERED                                     
         MVC   SREPOGRS,FULL                                                    
         A     R1,ONRGRS                                                        
         ST    R1,ONRGRS                                                        
         MVC   DUB+4(4),BYNET                                                   
         L     R1,DUB+4                                                         
         TM    BYSTAT,X'01'        TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         CLI   CENTS,C'Y'          TEST HAVE PENNIES                            
         BE    *+8                                                              
         M     R0,=F'100'                                                       
         ST    R1,DUB+4                                                         
         MR    R0,R5                                                            
         ST    R1,FULL                                                          
         MVC   SREPMNET,FULL                                                    
*                                                                               
         CLI   MTRADE,C'Y'         MTRADE OPTION?                               
         BNE   IR2FA               NO                                           
         OC    BYSREP,BYSREP       SPECIAL REP?                                 
         BZ    IR2FA               NO                                           
         LR    RF,R1               SAVE R1                                      
         ICM   R1,15,BYGCOST1      GROSS COST1                                  
         TM    BYSTAT,X'01'        NEGATIVE AMOUNT?                             
         BZ    *+6                 NO                                           
         LCR   R1,R1               YES - COMPLIMENT                             
         MR    R0,R5               MULTIPLY BY MATCHED SPOTS                    
         STCM  R1,15,SREPMNET      REP MATCHED NET = 85% OF GROSS COST1         
         LR    R1,RF               RESTORE R1                                   
*                                                                               
IR2FA    A     R1,MATNET                                                        
         ST    R1,MATNET                                                        
         L     R1,DUB+4                                                         
         MR    R0,R6                                                            
         LR    RF,R1                                                            
         A     RF,FULL             ONR + MATCHED                                
         ST    RF,FULL             =ORDERED                                     
         MVC   SREPONET,FULL                                                    
*                                                                               
         CLI   MTRADE,C'Y'         MTRADE OPTION?                               
         BNE   IR2FB               NO                                           
         OC    BYSREP,BYSREP       SPECIAL REP?                                 
         BZ    IR2FB               NO                                           
         LR    RF,R1               SAVE R1                                      
         ICM   R1,15,BYGCOST1      GROSS COST1                                  
         TM    BYSTAT,X'01'        NEGATIVE AMOUNT?                             
         BZ    *+6                 NO                                           
         LCR   R1,R1               YES - COMPLIMENT                             
         MR    R0,R6               MULTIPLY BY UNMATCHED SPOTS                  
         ICM   RE,15,SREPMNET      REP MATCHED NET                              
         AR    R1,RE               ONR + MATCHED = ORDERED                      
         STCM  R1,15,SREPONET      REP ORDERED NET = 85% OF GROSS COST1         
         LR    R1,RF               RESTORE R1                                   
*                                                                               
IR2FB    A     R1,ONRNET                                                        
         ST    R1,ONRNET                                                        
         LR    R0,R5                                                            
         A     R0,MATSPTS                                                       
         ST    R0,MATSPTS                                                       
         LR    R0,R6                                                            
         A     R0,ONRSPTS                                                       
         ST    R0,ONRSPTS                                                       
*                                                                               
         LA    RF,CGRS                 RF = CGRS                                
         ICM   RE,15,BYTRADE           TRADE?                                   
         BZ    IR2G                                                             
         LA    RF,TGRS                                                          
*                                                                               
         L     R1,DUB                                                           
         MR    R0,R6                   ONR GROSS                                
         ICM   R0,15,SREPMGRS          UPDATE CASH/TRADE GROSS                  
         AR    R0,R1                                                            
         AR    R0,RE                   SUBTRACT TRADE FROM CASH                 
         L     R1,CGRS                                                          
         AR    R0,R1                                                            
         ST    R0,CGRS                 UPDATE CASH TOTAL                        
*                                                                               
         SR    R0,R1                                                            
         LR    R1,R0                   CASH VALUE IN R1                         
         MHI   R1,85                   CALCULATE 85%                            
         XR    R0,R0                                                            
         D     R0,=F'100'                                                       
         CHI   R0,50                                                            
         BL    *+8                                                              
         AHI   R1,1                                                             
         L     RF,CNET                                                          
         AR    R1,RF                                                            
         ST    R1,CNET                                                          
*                                                                               
         LCR   RF,RE                   UPDATE TRADE TOTAL                       
         L     R1,TGRS                                                          
         AR    R1,RF                                                            
         ST    R1,TGRS                                                          
*                                                                               
         LCR   R1,RE                   TRADE VALUE IN R1                        
         MHI   R1,85                   CALCULATE 85%                            
         XR    R0,R0                                                            
         D     R0,=F'100'                                                       
         CHI   R0,50                                                            
         BL    *+8                                                              
         AHI   R1,1                                                             
         L     RF,TNET                                                          
         AR    R1,RF                                                            
         ST    R1,TNET                                                          
*                                                                               
IR2G     CLI   PROGPROF+9,C'C'     NOT IF CALENDAR MONTHS                       
         BE    IR2K                                                             
         CLC   BYEDT,BQENDP        IF SPOT END DATE IS OUTSIDE MONTH            
         BNH   IR2K                                                             
         TM    BYSTAT,X'02'        AND ITS A POL SPOT                           
         BZ    IR2K                                                             
         CLI   BYUNACH,0           AND ITS NOT MATCHED                          
         BE    IR2K                                                             
         L     R1,DEFSPTS          ITS A 'DEFERRED'                             
         LA    R1,1(R1)                                                         
         ST    R1,DEFSPTS                                                       
         L     R1,DUB              GROSS                                        
         A     R1,DEFGRS                                                        
         ST    R1,DEFGRS                                                        
         L     R1,DUB+4            NET                                          
         A     R1,DEFNET                                                        
         ST    R1,DEFNET                                                        
*                                                                               
IR2K     DS    0H                                                               
         CLI   SREPSW,0            TEST ANY SREPS PRESENT                       
         BE    IR3                 NO                                           
*                                  ADD TO SREP TOTS                             
         GOTO1 BINSRCH,SREPPARS,(1,SREPD)                                       
         CLI   SREPPARS,1          ALREADY IN TABLE?                            
         BE    IR2M                                                             
         L     RF,SREPPARS         YES, ADD TO TOTALS                           
         MVC   X(16),2(RF)                                                      
         MVC   X+16(16),SREPOGRS                                                
         LM    R0,R3,X+16                                                       
         A     R0,X+0                                                           
         A     R1,X+4                                                           
         A     R2,X+8                                                           
         A     R3,X+12                                                          
         STM   R0,R3,X+16                                                       
         MVC   2(16,RF),X+16                                                    
         B     IR3                                                              
*                                                                               
IR2M     DS    0H                  NEW ENTRY                                    
         CLI   RNAMOPT,C'Y'        IF NEED REP NAME                             
         BNE   IR3                                                              
         CLI   SREPCOD,X'FF'       IF ANY REP THIS SPOT                         
         BE    IR3                                                              
         MVI   X,C'0'              READ REP REC FOR NAME                        
         MVC   X+1(16),X                                                        
         L     R3,SREPPARS                                                      
         MVI   X,C'R'                                                           
         MVC   X+1(1),QMED                                                      
*                                                                               
         GOTO1 VRCPACK,DMCB,(C'U',SREPCOD),X+2                                  
*                                                                               
         MVC   X+5(2),QAGY                                                      
         MVC   KEY(17),X                                                        
         GOTO1 READREP                                                          
         L     RF,ADREP                                                         
         MVC   SREPNAM,RNAME-REPREC(RF)                                         
         DROP  R3                                                               
*                                                                               
IR3      DS    0H                                                               
         TM    BYSTAT,X'40'        TEST PAID                                    
         BNZ   *+8                                                              
         MVI   PDSTAT,0                                                         
*                                                                               
IR3Z     DS    0H                                                               
         LA    R7,BYELEML(R7)                                                   
         B     IR2                                                              
*                                  INVOICES                                     
IR4      CLI   MTRADE,C'Y'         MTRADE CLIENT?                               
         BNE   IR5                 NO                                           
         L     R1,EDCOST           GROSS COST1                                  
         M     R0,=F'85'           CALCULATE 85% OF GROSS                       
         LA    RF,100              RF = 100                                     
         BAS   RE,IRDIV            DIVIDE                                       
         ST    R1,EDNET            NET COST1 = 85% OF GROSS COST1               
*                                                                               
         CLI   SREPSW,0            ANY SPECIAL REPS?                            
         BE    IR5                 NO                                           
         L     R3,SREPPARS+4       A(SREP TABLE)                                
         ICM   R5,15,SREPPARS+8    HAVE ANY TABLE ENTRIES?                      
         BZ    IR5                 NO                                           
*                                                                               
         USING SREPD,R3            SPECIAL REP TABLE DSECT                      
IR4A     CLI   SREPCOD,X'FF'       ANY REP?                                     
         BE    IR4B                NO - SKIP                                    
         ICM   R1,15,SREPMNET      SREPMNET HAS GROSS MATCHED COST1             
         M     R0,=F'85'           R1 = GROSS MATCHED COST1                     
         LA    RF,100              RF = 100                                     
         BAS   RE,IRDIV            CALCULATE 85%                                
         STCM  R1,15,SREPMNET      NOW IT'S NET W/MINIMAL ROUNDING ERR          
*                                                                               
         ICM   R1,15,SREPONET      SREPMNET HAS GROSS ORDERED COST1             
         M     R0,=F'85'           R1 = GROSS ORDERED COST1                     
         LA    RF,100              RF = 100                                     
         BAS   RE,IRDIV            CALCULATE 85%                                
         STCM  R1,15,SREPONET      NOW IT'S NET W/MINIMAL ROUNDING ERR          
*                                                                               
IR4B     A     R3,SREPPARS+12      BUMP TO NEXT TABLE ENTRY                     
         BCT   R5,IR4A             PROCESS NEXT TABLE ENTRY                     
         DROP  R3                  DROP SPECIAL REP TABLE DSECT                 
*                                                                               
IR5      L     R8,AFINV            INVOICES                                     
*                                                                               
IR6      C     R8,ALINV                                                         
         BNL   IR9                                                              
         CLI   PIGCTL,C'S'         IF PIGS SEPARATELY                           
         BNE   IR06F                                                            
         CLC   PIGFILT,IPRD2       ONLY DO RIGHT PRD                            
         BNE   IR8B                                                             
IR06F    DS    0H                                                               
         MVC   DUB(4),ICOST        SET COST                                     
         L     R1,DUB                                                           
         TM    ISTAT,X'01'         TEST NEG                                     
         BZ    *+6                                                              
         LCR   R1,R1                                                            
         CLI   CENTS,C'Y'          TEST HAVE PENNIES                            
         BE    *+8                                                              
         M     R0,=F'100'                                                       
         OC    IBY,IBY             MATCHED -                                    
         BZ    IR6A                NO                                           
         CLI   IMIS,0              TEST PARTIAL MATCH                           
         BE    IR8                 NO - OK                                      
*                                  TOTAL PARTIAL MATCHED                        
         CLI   PSTOPT,C'P'         IF POSTING PARTIAL MATCHES                   
         BE    *+12                TREAT AS SUCCESSFUL                          
         MVI   PARTIAL,C'Y'        OTHERWISE PARTIAL MEANS UNSUCCESSFUL         
         OI    MATSTAT,X'20'                                                    
         LA    RF,PMOGRS                                                        
         TM    ISTAT2,X'10'         TEST NET                                    
         BZ    *+8                                                              
         LA    RF,PMONET                                                        
         L     RE,0(RF)                                                         
         AR    RE,R1                                                            
         ST    RE,0(RF)                                                         
         L     RF,PMSPTS                                                        
         LA    RF,1(RF)                                                         
         ST    RF,PMSPTS                                                        
*                                                                               
         B     IR8                 COUNT AS MATCHES                             
*                                                                               
IR6A     DS    0H                                                               
         CLI   QBYID,C'Y'          SKIP UNORDERED IF RUN BY ID                  
         BNE   IR6A2                                                            
         CLC   =C'**UNKNOWN**',SVBUYID                                          
         BNE   IR6B                                                             
         B     IR7                                                              
*                                                                               
IR6A2    CLC   RQREP,SPACES        OR IF 1 REP REQUEST                          
         BNH   IR6F                                                             
         CLI   MTRADE,C'Y'         MTRADE?                                      
         BE    IR6C                YES                                          
*                                                                               
IR6B     CLI   IID,0               TEST INPUT BY ID                             
         BE    IR8B                NO, REJECT                                   
         B     IR7                                                              
*                                                                               
IR6C     L     R5,AINOLST          GET INVOICE REP FOR DETAIL                   
         USING INOLSTD,R5                                                       
IR6C1    CLC   IINVID,INOLNUM      SAME INTERNAL INVOICE NUMBER                 
         BE    IR6C2               YES                                          
         LA    R5,INOLSTL(R5)      NEXT INVOICE                                 
         CLI   0(R5),C' '          ANY MORE INVOICES?                           
         BH    IR6C1               YES                                          
         B     IR6F                MATCH ON NOTHING THEN                        
*                                                                               
IR6C2    LR    R0,R1               R1 = RNOGRS/RNONET                           
         GOTO1 VRCPACK,DMCB,(C'U',INOLREP),WORK                                 
         LR    R1,R0               RESTORE RNOGRS/RNONET                        
         CLI   Q2USER+6,C'Y'       NEGATIVE FILTER?                             
         BNE   IR6C3               NO                                           
         CLC   RQREP,WORK          NEGATIVE REP MATCHES?                        
         BE    IR8B                YES - REJECT                                 
         B     IR6F                NO                                           
*                                                                               
IR6C3    CLC   RQREP,WORK          REP MATCHES?                                 
         BNE   IR8B                NO - REJECT                                  
         DROP  R5                  DROP R5                                      
*                                                                               
IR6F     DS    0H                                                               
         CLC   =C'NO',QEST                                                      
         BNE   IR6H                                                             
         CLI   QESTEND,C' '        IS IT AN EST FILTER REQUEST                  
         BE    IR7                 NO - OK                                      
         B     IR8B                YES - SKIP ALL UNORDEREDS                    
*                                                                               
IR6H     DS    0H                                                               
*                                  IF REQ BY EST COUNT AS UNORDER               
         CLC   IEST,BEST           ONLY ONES FOR THIS EST                       
         BNE   IR8B                                                             
*                                                                               
IR7      DS    0H                                                               
         CLI   SPCONLY,C'Y'        ALSO SKIP UNORDEREDS                         
         BE    IR8B                IF SPECIALS ONLY                             
         CLI   QOPT5+1,C' '        OR IF DAYPART FILTER                         
         BH    IR8B                                                             
*                                                                               
         CLI   I2APROF+14,C'Y'     SEPARATE ADDED VALUE SECTION                 
         BNE   IR7C                                                             
         OC    ICOST,ICOST         ONLY FOR $0                                  
         BNE   IR7C                                                             
         CLI   ILEN,5              5,7,10 CAN BE ADDED VALUE OR NOT             
         BE    IR7A                                                             
         CLI   ILEN,7                                                           
         BE    IR7A                                                             
         CLI   ILEN,10                                                          
         BL    IR7B                SKIP INVALID <10 LENS IF $0                  
         BH    IR7C                                                             
IR7A     CLI   I2APROF+15,C'Y'     5,7,10 ARE ADDED VALUE IF RNO                
         BNE   IR7C                NO PUT THESE IN RNO THEN                     
*                                                                               
IR7B     MVI   ADDEDVAL,C'Y'       SET HAVE ADDED VALUE TO REPORT               
         OI    ISTAT3,IST3AVAL     SET ADDED VALUE RNO                          
         B     IR8B                YES, THEN NOT RNO - SKIP HERE                
*                                                                               
IR7C     OI    MATSTAT,X'40'       HAVE RUN NOT ORDERED                         
         LA    RF,RNOGRS                                                        
         TM    ISTAT2,X'10'         TEST NET INV                                
         BZ    *+8                                                              
         LA    RF,RNONET                                                        
         L     RE,0(RF)                                                         
         AR    RE,R1                                                            
         ST    RE,0(RF)                                                         
         CLI   I2XPROF+5,C'Y'      TEST TO CALCULATE NET                        
         BNE   IR7F                                                             
         TM    ISTAT2,X'10'        ONLY FOR GROSS INVOICES                      
         BNZ   IR7F                                                             
         LR    R2,R1               SAVE R1                                      
         M     R0,=F'85'           R1 STILL HAS GROSS                           
         LA    RF,100                                                           
         BAS   RE,IRDIV                                                         
         A     R1,RNONET                                                        
         ST    R1,RNONET                                                        
         LR    R1,R2               SAVE R1                                      
*                                                                               
IR7F     L     RF,RNOSPTS                                                       
         LA    RF,1(RF)                                                         
         ST    RF,RNOSPTS                                                       
*                                                                               
IR8      DS    0H                                                               
         LA    RF,INET                                                          
         TM    ISTAT2,X'10'         TEST NET INV                                
         BNZ   *+8                                                              
         LA    RF,IGRS                                                          
         LR    R0,R1                                                            
         A     R0,0(RF)                                                         
         ST    R0,0(RF)                                                         
         CLI   I2XPROF+5,C'Y'      TEST TO CALCULATE NET                        
         BNE   IR8F                                                             
         TM    ISTAT2,X'10'        ONLY FOR GROSS INVOICES                      
         BNZ   IR8F                                                             
         M     R0,=F'85'           R1 STILL HAS GROSS                           
         LA    RF,100                                                           
         BAS   RE,IRDIV                                                         
         A     R1,INET                                                          
         ST    R1,INET                                                          
*                                                                               
IR8F     DS    0H                                                               
         L     R1,ISPTS                                                         
         LA    R1,1(R1)                                                         
         ST    R1,ISPTS                                                         
*                                                                               
IR8B     DS    0H                                                               
         AH    R8,IELMLEN                                                       
         B     IR6                                                              
*                                                                               
IR9      EQU   *                                                                
         LM    R4,R6,ONRSPTS       ONR + MATCHED = ORDERED                      
         A     R4,MATSPTS                                                       
         A     R5,MATGRS                                                        
         A     R6,MATNET                                                        
         STM   R4,R6,OSPTS                                                      
         SPACE 2                                                                
*                                  POST TO SUMMARY                              
         XC    SUMD(SUMDL),SUMD                                                 
         CLI   ADDEDVAL,C'Y'       HAVE ADDED VALUE?                            
         BE    IR9A0               YES, DO NOT GO TO IRSTATX!                   
         OC    OSPTS(16),OSPTS     TEST ANY DATA                                
         BZ    IRSTATX                                                          
*                                                                               
         CLI   PAYTA,C'Y'          TEST OAY TA                                  
         BNE   IR9A0               NO                                           
         CLI   PDSTAT,0            YES - SKIP IF FULLY PAID                     
         BNE   IRSTATX                                                          
*                                                                               
IR9A0    DS    0H                                                               
         MVI   RACTSW,C'Y'         SET HAVE ACTIVITY                            
         MVC   SUSTA,BSTA                                                       
         TM    CBLHOPT,CBLHNHAQ    IF CBH REQ AND NEW MODE                      
         BNO   *+8                 AND 'ALL NETS'                               
         NI    SUSTA+2,X'80'       STRIP NETWORK                                
         MVC   SUMKT,BMKTSTA                                                    
         MVC   SUMED,QMED                                                       
*                                                                               
         CLI   NETPSW,C'Y'                                                      
         BNE   IR9A1                                                            
         CLI   I2IPROF+1,C'Y'      MATCH ON INTEGRATION ONLY NO COST            
         BNE   *+10                                                             
         MVC   SUID(7),=C'INTONLY'                                              
         CLI   I2IPROF,C'Y'        MATCH ON INTEGRATION AND COST                
         BNE   *+10                                                             
         MVC   SUID(8),=C'TIME+INT'                                             
         B     IR9A2                                                            
*                                                                               
IR9A1    CLI   QBYID,C'Y'                                                       
         BNE   *+10                                                             
         MVC   SUID,SVBUYID                                                     
*                                                                               
IR9A2    MVC   SUPRD1,PRD          3 CHARACTER PRODUCT                          
         MVC   SUPRD2,PRDC2        3 CHARACTER PRODUCT2                         
         CLI   NOIMR,C'Y'          IF NOT PRINTING MATCHES                      
         BE    IR90                                                             
         MVC   SUPAGE,PAGE         ZERO PAGE                                    
IR90     DS    0H                                                               
         MVC   SUPER,BQSTARTP        START AND END                              
         CLI   MONSW,C'M'       TEST MONTH                                      
         BNE   IR91                                                             
         MVC   SUPER(2),SUPER+2                                                 
         NI    SUPER+1,X'E0'       CLEAR DAY                                    
IR91     DS    0H                                                               
         MVC   SUREG,BMGR                                                       
         CLC   =C'NO',QEST                                                      
         BE    *+10                                                             
         MVC   SUEST(2),BEST                                                    
         IC    RF,SUMSEQ                                                        
         LA    RF,1(RF)                                                         
         STC   RF,SUMSEQ                                                        
         STC   RF,SUSEQ                                                         
         MVC   SUSPTS,OSPTS+2                                                   
         MVC   SUGRS,OGRS                                                       
         MVC   SUNET,ONET                                                       
         MVC   SURESP,IGRS         RESPONSE COUNT = INVOICE GRS                 
         CLI   I2XPROF+4,C'Y'      TEST TO INCLUDE TAX                          
         BNE   IR91A                                                            
         L     RF,OGRS                                                          
         A     RF,TAXTOT                                                        
         STCM  RF,15,SUGRS                                                      
         L     RF,ONET                                                          
         A     RF,TAXTOT                                                        
         STCM  RF,15,SUNET                                                      
*                                                                               
IR91A    DS    0H                                                               
         OC    SUSTATUS,PDSTAT      PAID STATUS                                 
*                                                                               
IR91B    DS    0H                                                               
         CLI   MATSTAT,0                                                        
         BE    *+8                                                              
         OI    SUSTATUS,X'40'                                                   
         OC    ISPTS,ISPTS                                                      
         BNZ   *+8                                                              
         OI    SUSTATUS,X'20'                                                   
         OC    OSPTS,OSPTS                                                      
         BNZ   *+8                                                              
         OI    SUSTATUS,X'10'                                                   
         TM    SUSTATUS,X'F8'      TEST PERFECT MATCH                           
         BNZ   IR92                NO                                           
         CLI   QOPT4,C'D'          TEST PRINT ONLY DISCREPANCY REPORTS          
         BE    IR91D                                                            
         CLI   QOPT4,C'A'          OR ONLY DISCREPANCY SUMMARY                  
         BE    IR91D                                                            
         CLI   QOPT4,C'B'          OR DISCREPANT REPS AND SUMMARIES             
         BNE   IR92                                                             
IR91D    DS    0H                                                               
         XC    SUPAGE,SUPAGE                                                    
         OI    SUSTATUS,X'02'      SET TO SKIP                                  
IR92     DS    0H                                                               
*                                  DONT ACTUALLY PUT TO BUFFALO YET             
IR9A     EQU   *                                                                
         CLI   ADDEDVAL,C'Y'       HAVE ADDED VALUE?                            
         BE    *+14                YES, DO NOT GO TO IRSTATX!                   
         OC    SUPAGE,SUPAGE                                                    
         BNE   IRSTATX                                                          
*                                  FAKE REPORT INTO SETTING UP                  
*                                  HEADLINES WITHOUT PRINTING                   
*                                  SO THAT I CAN GET MGR NAMES                  
         MVI   FORCEHED,C'N'                                                    
         MVI   LINE,0                                                           
         MVI   FORCEMID,C'Y'                                                    
         MVC   MIDHOOK,HEADHOOK                                                 
         XC    HEADHOOK,HEADHOOK                                                
         MVI   SPACING,0                                                        
         MVC   BYTE,RCSPACNG                                                    
         MVI   RCSPACNG,0                                                       
         CLI   QOPT4,C'A'          IF SUMMARIES ONLY                            
         BE    IR93                                                             
         CLI   QOPT4,C'S'          IF SUMMARIES ONLY                            
         BNE   *+8                                                              
IR93     MVI   PAGSW,C'S'                                                       
         GOTO1 AIMRHEAD                                                         
*        GOTO1 AIRPRT                                                           
         MVC   RCSPACNG,BYTE                                                    
         MVC   HEADHOOK,MIDHOOK                                                 
         XC    MIDHOOK,MIDHOOK                                                  
IRSTATX  DS    0H                                                               
         MVI   IRSKIP,C'N'                                                      
         OC    SUPAGE,SUPAGE                                                    
         BNZ   *+8                                                              
         MVI   IRSKIP,C'Y'         DONT PRINT THIS MATCH                        
*                                                                               
         DROP  R8                                                               
         J     EXIT                                                             
*                                                                               
IRDIV    DIV   (R0),(RF)           NOTE- RETURNS VIA RE                         
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        HEADHOOK ROUTINES                                                      
*-----------------------------------------------------------------              
*                                                                               
IMRHEAD  NMOD1 0,IMRHEAD                                                        
         LM    R9,RA,SAVREGS                                                    
         LA    RC,SPACEND                                                       
         B     IMRH1                                                            
*                                                                               
SAVREGS  DS    2F                                                               
*                                                                               
IMRH1    DS    0H                                                               
         CLI   RACTSW,0            IF NO ACTIVITY                               
**NOOP** BE    IMRHX               SKIP HEADS                                   
         CLI   RCSUBPRG,200        IF LETTER PRINTING                           
         BH    IMRHX               SKIP HEADS                                   
*                                                                               
IMRH10   DS    0H                  NORMAL/RESPONSE/MCT                          
         MVC   DUB(1),PSEUDOPT     TEST PSEUDOPT                                
         CLI   PAGSW,C'S'          BUT IF SUPPARY PAGES                         
         BNE   *+10                                                             
         MVC   DUB(1),SAVEQRSP     TEST SAVED OPT                               
*                                                                               
         CLI   DUB,C'R'             FOR RESPONSES                               
         BNE   IMRH10D                                                          
         MVC   HEAD1+53(8),=C'RESPONSE'   CHANGE HEADLINE                       
         MVI   HEAD2+53,C'-'                                                    
         B     IMRH10F                                                          
*                                                                               
IMRH10D  DS    0H                                                               
         CLI   DUB,C'P'            FOR MCT'S                                    
         BNE   IMRH10F                                                          
         MVC   HEAD1+47(35),=C'MIDFLIGHT CLEARANCE TRACKING REPORT'             
         MVI   HEAD2+47,C'-'                                                    
         MVC   HEAD2+48(34),HEAD2+47                                            
*                                                                               
IMRH10F  DS    0H                                                               
         CLI   PAGSW,C'S'          SUMMARY PAGES                                
         BE    IMRH66                                                           
         CLI   PAGSW,C'O'                                                       
         BNE   IMRH20                                                           
*                                  ORDERED HEADLINES                            
         LA    R2,P11              DROP PRINT LINES DOWN 3                      
         LA    R0,11                                                            
         MVC   396(132,R2),0(R2)                                                
         AHI   R2,-132                                                          
         BCT   R0,*-10                                                          
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
*                                                                               
         CLI   ONRSW,C'N'          DOING ONR SEPARATELY?                        
         BNE   *+14                                                             
         MVC   P1+5(65),=C'---------------------O R D E R E D  N O T  RX        
                U N-----------------'                                           
         B     *+10                                                             
         MVC   P1+5(65),=C'----------------------------O R D E R E D---X        
               ---------------------'                                           
*                                                                               
         MVC   P2+5(65),=C'DATE(S)     DAYS      TIME(S)    LEN PRODUCTX        
                       COST  EST-LIN'                                           
         MVC   P3+5(65),=C'-------     ----      -------    --- -------X        
                       ----  -------'                                           
*                                                                               
         CLI   NETINV,C'Y'                                                      
         BNE   *+16                                                             
         MVC   P2+53(3),=C'NET'                                                 
         MVC   P3+53(4),DASHES                                                  
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BE    *+16                                                             
         MVC   P2+53(8),SPACES                                                  
         MVC   P3+53(8),SPACES                                                  
*                                                                               
         CLI   I2IPROF+1,C'Y'      MATCH ON INTEGRATION ONLY NO COST            
         BNE   *+16                                                             
         MVC   P2+53(8),=C'   INTEG'                                            
         MVC   P3+53(8),DASHES                                                  
*                                                                               
         CLI   I2IPROF,C'Y'        MATCH ON INTEGRATION AND COST                
         BNE   *+16                                                             
         MVC   P2+53(8),=C'COST+INT'                                            
         MVC   P3+53(8),DASHES                                                  
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   *+10                                                             
         MVC   P2+5+62(3),=C'PKG'                                               
*                                                                               
         CLI   ONRSW,C'N'          SKIP INVOICE INFO FOR ONR                    
         BE    IMRH11                                                           
*                                                                               
         MVC   P1+79(17),=C'-----INVOICE-----'                                  
         MVC   P2+79(17),=C'DATE   DAY   TIME'                                  
         MVC   P3+79(17),=C'----   ---   ----'                                  
*                                                                               
         CLI   TRAFSW,C'Y'                                                      
         BNE   IMRH11                                                           
         MVC   P1+79(31),=C'---------I N V O I C E---------'                    
         MVC   P2+98(4),=C'FILM'                                                
         MVC   P3+98(12),DASHES                                                 
*                                                                               
IMRH11   DS    0H                                                               
*                                                                               
         CLI   QBOOK1,C' '                                                      
         BE    IMRH12                                                           
*                                                                               
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BE    IMRH60              YES                                          
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    IMRH60              YES                                          
         MVC   P1+114(18),=C'-----DELIVERY-----'                                
         MVC   P2+114(18),=C'EST    ACH   DEMO '                                
         MVC   P3+114(18),=C'---    --- -------'                                
         B     IMRH60                                                           
*                                                                               
IMRH12   DS    0H                                                               
         CLI   PSEUDOPT,C'R'       FOR RESPONSES                                
         BNE   IMRH60                                                           
         MVC   P2+111(9),=C'RESPONSES'                                          
         MVC   P3+111(9),DASHES                                                 
         B     IMRH60                                                           
*                                                                               
IMRH20   DS    0H                                                               
         CLI   PAGSW,C'U'                                                       
         BNE   IMRH30                                                           
*                                  UNORDERED TOTALS                             
         LA    R2,P10              DROP PRINT LINES DOWN 4                      
         LA    R0,10                                                            
         MVC   528(132,R2),0(R2)                                                
         AHI   R2,-132                                                          
         BCT   R0,*-10                                                          
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
         MVC   P4,SPACES                                                        
         MVI   P1,0                                                             
*                                                                               
         MVC   P2+5(73),=C'---------------------U N O R D E R E D  S P X        
               O T S------------------------'                                   
*                                                                               
         MVC   P3+5(48),=C'DATE    DAY    TIME   LEN   PRODUCT         X        
               COST'                                                            
         MVC   P4+5(48),=C'----    ---    ----   ---   -------         X        
               ----'                                                            
         CLI   NETINV,C'Y'                                                      
         BNE   *+16                                                             
         MVC   P3+45(3),=C'NET'                                                 
         MVC   P4+45(4),DASHES                                                  
*                                                                               
         CLI   PSEUDOPT,C'R'       FOR RESPONSES                                
         BNE   *+16                                                             
         MVC   P3+44(9),=C'RESPONSES'                                           
         MVC   P4+44(9),DASHES                                                  
*                                                                               
         CLI   COSTSUP,C'N'        TEST TO SUPPRESS COSTS                       
         BE    *+16                                                             
         MVC   P3+45(8),SPACES                                                  
         MVC   P4+45(8),SPACES                                                  
*                                                                               
         CLI   I2IPROF+1,C'Y'      MATCH ON INTEGRATION ONLY NO COST            
         BNE   *+16                                                             
         MVC   P3+45(8),=C'   INTEG'                                            
         MVC   P4+45(8),DASHES                                                  
*                                                                               
         CLI   I2IPROF,C'Y'        MATCH ON INTEGRATION AND COST                
         BNE   *+16                                                             
         MVC   P3+45(8),=C'COST+INT'                                            
         MVC   P4+45(8),DASHES                                                  
*                                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   IMRH21                                                           
         MVC   P3+56(3),=C'PKG'                                                 
         MVC   P4+56(3),DASHES                                                  
         MVC   P3+77(3),=C'REP'                                                 
         MVC   P4+77(3),DASHES                                                  
*                                                                               
IMRH21   TM    CBLHOPT,CBLHNHAQ    IF CBH REQ AND NEW MODE                      
         BNO   *+16                AND ALL NETS                                 
         MVC   P3+55(5),=C'NETWK'                                               
         MVC   P4+55(5),DASHES                                                  
*                                                                               
         CLI   TRAFSW,C'Y'                                                      
         BNE   *+22                                                             
         MVC   P2+59(12),DASHES                                                 
         MVC   P3+62(4),=C'FILM'                                                
         MVC   P4+62(12),DASHES                                                 
*                                                                               
         CLI   QBOOK1,C' '                                                      
         BE    IMRH24                                                           
         CLI   DIGITAL,C'Y'                                                     
         BE    IMRH24                                                           
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    IMRH24              YES                                          
         MVC   P2+75(9),=C'DELIVERY-'                                           
*                                                                               
         L     R2,DEMPARS+4        A(DEMOTAB)                                   
         USING DTABD,R2                                                         
         LA    R3,P3+76                                                         
         L     R4,DEMPARS+8        NO. OF DEMS                                  
         LTR   R4,R4                                                            
         BZ    IMRH24                                                           
*                                                                               
IMRH22   DS    0H                                                               
         CLI   1(R2),0                                                          
         BE    IMRH24                                                           
         MVC   0(7,R3),DTABNAM     DEMO NAME                                    
         MVC   132(7,R3),DASHES                                                 
         LA    R3,9(R3)                                                         
IMR23H   DS    0H                                                               
         LA    R2,DTABEL(R2)                                                    
         BCT   R4,IMRH22                                                        
         DROP  R2                                                               
*                                                                               
IMRH24   DS    0H                                                               
         MVC   P2+75(19),DASHES                                                 
         MVC   P3+84(9),=C'INVOICE #'                                           
         MVC   P4+84(10),DASHES                                                 
*                                                                               
         CLI   DIGITAL,C'Y'                                                     
         BNE   IMRH60                                                           
         MVC   P2+94(35),P2+93                                                  
         MVC   P3+95(9),=C'DELIVERED'                                           
         MVC   P4+95(34),P2+93                                                  
         B     IMRH60                                                           
*                                                                               
IMRH30   DS    0H                                                               
         CLI   PAGSW,C'F'                                                       
         BNE   IMRH40                                                           
*                                  FILM REPORT HEADS                            
         LA    R2,P11              DROP PRINT LINES DOWN 3                      
         LA    R0,11                                                            
         MVC   396(132,R2),0(R2)                                                
         AHI   R2,-132                                                          
         BCT   R0,*-10                                                          
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
*                                                                               
         MVC   P2(19),=C'PATTERN DESCRIPTION'                                   
         MVC   P3(19),DASHES                                                    
*                                                                               
         MVC   P1+44(46),=C'  FILM    PATTERN  ACTUAL   PCT   ----SPOTSX        
               ---'                                                             
         MVC   P2+44(46),=C'  CODE    PERCENT  PERCENT  INDX  PATTN ACTX        
               UAL'                                                             
         MVC   P3+44(46),=C'--------  -------  -------  ----  ----- ---X        
               ---'                                                             
*                                                                               
         LA    R5,P1+44+46+3                                                    
         CLI   TRAFCST,C'Y'        TEST DOING COST                              
         BNE   IMRH30B                                                          
         CLI   COSTSUP,C'N'        TEST REQUEST OPT TO SUPPRESS                 
         BNE   IMRH30B                                                          
         MVC   000(17,R5),=C'-----C O S T-----'                                 
         MVC   132(17,R5),=C' PATTN     ACTUAL'                                 
         MVC   264(17,R5),=C'-------   -------'                                 
         LA    R5,17+2(R5)                                                      
*                                                                               
IMRH30B  DS    0H                                                               
         CLI   TRAFDEM,C'Y'        TEST DOING DEMOS                             
         BNE   IMRH32                                                           
         CLI   QBOOK1,C' '                                                      
         BE    IMRH32                                                           
         ICM   R4,15,DEMPARS+8     TEST ANY DEMOS PRESENT                       
         BZ    IMRH32                                                           
         MVC   000(13,R5),=C'---XXXXXXX---'                                     
         MVC   132(13,R5),=C'PATTN  ACTUAL'                                     
         MVC   264(13,R5),=C'-----  ------'                                     
*                                                                               
         L     R2,DEMPARS+4        SET DEMO NAME                                
*                                                                               
IMRH31   DS    0H                                                               
         CLC   DCLIST(3),0(R2)                                                  
         BE    IMRH31B                                                          
         A     R2,DEMPARS+12                                                    
         BCT   R4,IMRH31                                                        
         B     IMRH32                                                           
*                                                                               
IMRH31B  DS    0H                                                               
         MVC   000+3(7,R5),3(R2)                                                
*                                                                               
IMRH32   DS    0H                                                               
         B     IMRH60                                                           
*                                                                               
IMRH40   DS    0H                                                               
         CLI   PAGSW,C'M'          MAKE GOOD ANALYSIS                           
         BNE   IMRH50                                                           
*                                                                               
         LA    R2,P11              DROP PRINT LINES DOWN 3                      
         LA    R0,11                                                            
         MVC   396(132,R2),0(R2)                                                
         AHI   R2,-132                                                          
         BCT   R0,*-10                                                          
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
*                                                                               
         LA    R3,P2                                                            
         USING MGLINED,R3                                                       
         MVC   MGLCODE(2),=C'CD'                                                
         MVC   MGLTYPE(2),=C'TYPE'                                              
         MVC   MGLLINE(3),=C'LIN'                                               
         MVC   MGLDATE(4),=C'DATE'                                              
         MVC   MGLSLN(3),=C'LEN'                                                
         MVC   MGLTIME(4),=C'TIME'                                              
*                                                                               
         MVC   MGLCODE+132(2),DASHES                                            
         MVC   MGLTYPE+132(2),DASHES                                            
         MVC   MGLLINE+132(3),DASHES                                            
         MVC   MGLDATE+132(4),DASHES                                            
         MVC   MGLSLN+132(3),DASHES                                             
         MVC   MGLTIME+132(4),DASHES                                            
*                                                                               
         LA    R3,P1+MGLTIME+13-MGLINED   REST OF FIELDS HERE                   
         CLI   COSTSUP,C'Y'        SUPRESSING COSTS?                            
         BE    IMRH42                                                           
         MVC   000(17,R3),=C'-----C O S T-----'                                 
         MVC   132(17,R3),=C' MISSED  MAKEGOOD'                                 
         MVC   264(17,R3),=C'-------- --------'                                 
         LA    R3,20(R3)                                                        
*                                                                               
IMRH42   DS    0H                                                               
         CLI   QBOOK1,C' '          DEMOS?                                      
         BNH   IMRH43                                                           
         ICM   R4,15,DEMPARS+8                                                  
         BZ    IMRH43                                                           
         MVC   000(17,R3),=C'-----XXXXXXX-----'                                 
         MVC   132(17,R3),=C' MISSED  MAKEGOOD'                                 
         MVC   264(17,R3),=C'-------- --------'                                 
*                                                                               
         L     R2,DEMPARS+4        SET DEMO NAME                                
*                                                                               
IMRH42B  DS    0H                                                               
         CLC   DCLIST(3),0(R2)                                                  
         BE    IMRH42D                                                          
         A     R2,DEMPARS+12                                                    
         BCT   R4,IMRH42B                                                       
         B     IMRH42F                                                          
*                                                                               
IMRH42D  DS    0H                                                               
         MVC   000+5(7,R3),3(R2)                                                
*                                                                               
IMRH42F  DS    0H                                                               
*                                                                               
         LA    R3,20(R3)                                                        
IMRH43   DS    0H                                                               
         MVC   132(7,R3),=C'PROGRAM'                                            
         MVC   264(7,R3),DASHES                                                 
         B     IMRH60                                                           
         DROP  R3                                                               
*                                                                               
IMRH50   DS    0H                                                               
IMRH60   DS    0H                                                               
         MVC   HEAD6+57(9),BIGSTA  OVERWRITE REPORTS STATION                    
         TM    CBLHOPT,CBLHNHAQ    IF CBH REQ AND NEW MODE                      
         BNO   *+10                AND 'ALL NETS'                               
         MVC   HEAD6+62(3),SPACES  CLEAR NETWORK                                
*                                                                               
         CLI   SPCONLY,C'Y'                                                     
         BNE   IMRH60D                                                          
         MVC   HEAD6(17),=C'**SPECIALS ONLY**'                                  
*                                                                               
IMRH60D  DS    0H                                                               
         CLI   SNAMOPT,C'Y'        STATION NAME OPTION                          
         BNE   IMRH60E                                                          
         L     R4,ADSTATAD                                                      
         MVC   HEAD6+67(20),ANAME-ADDRREC(R4)                                   
*                                                                               
IMRH60E  DS    0H                                                               
         CLI   BIGSTA+4,C'/'       FOR LOCAL CABLE                              
         BNE   IMRH60F                                                          
         L     R4,ADSTAT           SHOW OPERATOR NAME                           
         MVC   HEAD6+67(24),SSYSNAME-STAREC(R4)                                 
*                                                                               
IMRH60F  DS    0H                                                               
         LA    R5,HEAD7+49                                                      
         CLI   Q2USER+6,C'Y'       NEGATIVE FILTER?                             
         BE    *+18                YES - NOT REALLY A SPECIAL REP REQ           
         LA    R1,RQREP                                                         
         CLC   RQREP,SPACES        SPECIAL REP REQ                              
         BH    IMRH61              YES                                          
         CLI   PAYOPT,C'Y'                                                      
         BNE   IMRH64                                                           
*                                  SET PAYEE NAME/ADDR                          
         L     R4,ADSTATAD                                                      
         LA    R6,ABIGZIP-ADDRREC(R4)                                           
         LA    R4,A1LINE-ADDRREC(R4)                                            
         L     RF,ADSTAT                                                        
         CLC   SPAYREP-STAREC(3,RF),=3C'0'                                      
         BE    IMRH62                                                           
         CLI   SPAYREP-STAREC(RF),C'A'   MAY BE ALPHA                           
         BL    IMRH62                                                           
         LA    R1,SPAYREP-STAREC(RF)                                            
IMRH61   DS    0H                                                               
         L     R4,ADREP                                                         
         CLC   0(3,R1),REPKREP-REPREC(R4)   DO WE ALREADY HAVE REP              
         BE    IMRH61F                                                          
*                                                                               
         MVI   X,C'0'              READ REP REC FOR NAME                        
         MVC   X+1(16),X                                                        
         MVI   X,C'R'                                                           
         MVC   X+1(1),QMED                                                      
         MVC   X+2(3),0(R1)                                                     
         MVC   X+5(2),QAGY                                                      
         MVC   KEY(17),X                                                        
         GOTO1 READREP                                                          
*                                                                               
IMRH61F  DS    0H                                                               
         MVC   0(6,R5),=C'PAYEE-'                                               
         MVI   132(R5),C'('                                                     
         MVC   132+1(3,R5),REPKREP-REPREC(R4)                                   
         MVI   132+4(R5),C')'                                                   
         MVC   9(22,R5),RNAME-REPREC(R4)                                        
         LA    R5,132(R5)                                                       
         LA    R6,RBIGZIP-REPREC(R4)                                            
         LA    R4,R1LINE-REPREC(R4)                                             
IMRH62   DS    0H                                                               
         CLC   0(24,R4),SPACES        TEST ANY ADDRESS                          
         BNH   IMRH64                                                           
         LA    R5,9(R5)                                                         
         MVC   0(24,R5),0(R4)                                                   
         MVC   132(24,R5),24(R4)                                                
         LA    R5,132+24(R5)                                                    
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         MVI   1(R5),C','                                                       
         MVC   3(3,R5),48(R4)      STATE                                        
         CLI   5(R5),C' '                                                       
         BH    *+6                                                              
         BCTR  R5,R0                                                            
         MVC   8(10,R5),0(R6)       ZIP CODE                                    
         CLC   8(5,R5),=C'CANAD'                                                
         BNE   *+8                                                              
         MVI   13(R5),C'A'                                                      
IMRH64   DS    0H                                                               
         CLI   QBYID,C'Y'          IF SHOWING BUYID                             
         BE    IMRH64B                                                          
         CLI   SAFFOPT,C'Y'        OR AFFILIATION                               
         BNE   IMRH65                                                           
*                                                                               
IMRH64B  DS    0H                                                               
         LA    R5,HEAD6+69         SPOT FOR BUYID NAME/CODE                     
         CLI   HEAD6+67,C' '       UNLESS HAVE STATION NAME HERE                
         BE    IMRH64E                                                          
         LA    RF,HEAD6+67         THEN FLOAT AFTER STA NAME                    
         LA    R5,24(RF)                                                        
IMRH64C  DS    0H                                                               
         CLI   0(R5),C' '                                                       
         BH    IMRH64D                                                          
         BCTR  R5,R0                                                            
         CR    R5,RF                                                            
         BH    IMRH64C                                                          
IMRH64D  DS    0H                                                               
         LA    R5,1(R5)                                                         
IMRH64E  DS    0H                                                               
         CLI   QBYID,C'Y'                                                       
         BNE   IMRH64G                                                          
         MVC   0(12,R5),BUYIDNAM                                                
         LA    R5,11(R5)                                                        
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         MVC   2(12,R5),SVBUYID                                                 
         LA    R5,11(R5)                                                        
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         LA    R5,2(R5)                                                         
*                                                                               
IMRH64G  DS    0H                                                               
         CLI   SAFFOPT,C'Y'        TEST SHOWING AFFILIIATION                    
         BNE   IMRH65                                                           
         L     RF,ADSTAT                                                        
         CLI   SNETWRK-STAREC(RF),C' '   IS THERE ANY?                          
         BNH   IMRH65                                                           
         MVC   1(4,R5),=C'AFF='                                                 
         MVC   5(3,R5),SNETWRK-STAREC(RF)                                       
*                                                                               
IMRH65   DS    0H                                                               
         CLI   BPRD2,0             TEST DOING PIGGY BACK                        
         BE    IMRH66                                                           
         MVC   HEAD4+12(30),SPACES YES- RESET HEADLINE                          
         MVI   HEAD4+12,C'-'                                                    
         MVC   HEAD4+13(3),PRDC2                                                
*                                                                               
IMRH66   DS    0H                                                               
         CLI   QPGR,C' '           TEST DOING PROD GROUPS                       
         BE    IMRH67                                                           
         MVC   HEAD4(38),SPACES                                                 
         MVC   HEAD4(L'PGR1BK),PGR1BK                                           
         MVC   HEAD4+13(L'PGR1),PGR1                                            
         MVC   HEAD4+19(17),PGR1NM                                              
         CLC   PGR1LEN,PGR2LEN     LENS = IS END                                
         BE    IMRH67                                                           
         MVC   HEAD4(L'PGR2BK),PGR2BK                                           
         MVC   HEAD4+13(L'PGR2),PGR2                                            
         MVC   HEAD4+19(17),PGR2NM                                              
         CLC   PGR2LEN,PGR3LEN     LENS = IS END                                
         BE    IMRH67                                                           
         MVC   HEAD4(L'PGR3BK),PGR3BK                                           
         MVC   HEAD4+13(L'PGR3),PGR3                                            
         MVC   HEAD4+19(17),PGR3NM                                              
*                                                                               
IMRH67   DS    0H                  SAVE MGR NAME                                
         OC    BMGR,BMGR                                                        
         BZ    IMRH70                                                           
         MVC   DUB(3),BMGR                                                      
         GOTO1 BINSRCH,MGTBPARS,(1,DUB)                                         
         CLI   MGTBPARS,1          TEST ADDING THIS TIME                        
         BNE   IMRH70              NO                                           
         L     RF,MGTBPARS                                                      
         MVC   03(45,RF),HEAD7     YES- SET NAMES                               
         MVC   48(45,RF),HEAD8                                                  
         MVC   93(45,RF),HEAD9                                                  
         CLI   PAGSW,C'S'          SUMMARY                                      
         BNE   IMRH70                                                           
         MVC   03(12,RF),MGR1BK                                                 
         MVC   16(05,RF),MGR1                                                   
         MVC   23(24,RF),MGR1NM                                                 
         CLC   MGR1LEN,MGR2LEN     LENS = IS END                                
         BE    IMRH70                                                           
         MVC   48(12,RF),MGR2BK                                                 
         MVC   61(05,RF),MGR2                                                   
         MVC   68(24,RF),MGR2NM                                                 
         CLC   MGR2LEN,MGR3LEN     LENS = IS END                                
         BE    IMRH70                                                           
         MVC   93(12,RF),MGR3BK                                                 
         MVC   106(5,RF),MGR3                                                   
         MVC   113(24,RF),MGR3NM                                                
*                                                                               
IMRH70   DS    0H                                                               
*                             SAVE MARKET NAME                                  
         MVC   DUB(2),BMKT                                                      
         GOTO1 BINSRCH,MKTBPARS,(1,DUB)                                         
         CLI   MKTBPARS,1          TEST ADDING THIS TIME                        
         BNE   IMRH71              NO                                           
         L     RF,MKTBPARS                                                      
         MVC   2(24,RF),MKTNM                                                   
*                                                                               
IMRH71   DS    0H                                                               
*                                  SET CLIENT NAME                              
         LA    R2,HEAD3                                                         
         L     RF,ADCLT                                                         
         MVC   0(6,R2),=C'CLIENT'                                               
         MVC   DUB(2),CKEYCLT-CKEY(RF)                                          
         MVC   13(20,R2),CNAME-CKEY(RF)                                         
         IC    R0,CPROF+6-CKEY(RF)                                              
         GOTO1 CLUNPK,DMCB,((R0),DUB),9(R2)                                     
*                                                                               
*                                  SET LIST OF INVOICE NUMBERS                  
         CLI   MULTIMON,C'Y'       SKIP IF MULTIPLE MONTHS                      
         BE    IMRH80                                                           
         CLI   PAGSW,C'S'          SKIP ON SUMMARY LIST                         
         BE    IMRH80                                                           
         L     R4,AINOLST                                                       
         USING INOLSTD,R4                                                       
*                                                                               
IMRH72   DS    0H                                                               
         CLI   0(R4),C' '          TEST ANY INVOICES                            
         BNH   IMRH80                                                           
*                                                                               
         LA    R2,HEAD7                                                         
         MVC   0(49,R2),SPACES                                                  
         MVC   0(8,R2),=C'INVOICES'                                             
         LA    R3,9(R2)                                                         
*                                                                               
IMRH73   CLI   0(R4),C' '          END OF INVOICE LIST?                         
         BNH   IMRH74              YES                                          
         CLI   MTRADE,C'Y'         MTRADE?                                      
         BNE   IMRH73AA            NO                                           
         CLC   RQREP,SPACES        SPECIAL REP REQUEST?                         
         BNH   IMRH73AA            NO                                           
         GOTO1 VRCPACK,DMCB,(C'U',INOLREP),WORK                                 
         CLI   Q2USER+6,C'Y'       NEGATIVE FILTER?                             
         BNE   *+18                NO                                           
         CLC   RQREP,WORK          NEGATIVE REP MATCHES?                        
         BE    IMRH73C             YES - REJECT                                 
         B     IMRH73AA            PRINT THE INVOICE                            
         CLC   RQREP,WORK          REP MATCHES?                                 
         BNE   IMRH73C             NO - REJECT                                  
*                                                                               
IMRH73AA XC    WORK,WORK                                                        
         MVC   WORK(L'IHDINV),INOLINV                                           
         LA    R5,WORK+L'IHDINV                                                 
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         LA    R1,C'I'                                                          
         TM    INOFLAG,INOINVM     CAME FROM INVOICE MANAGER?                   
         BNZ   IMRH73A             YES                                          
*                                                                               
         LA    R1,C'E'                                                          
         TM    INOFLAG,INOEASI     IS THIS INVOICE ELECTRONIC?                  
         BZ    IMRH73A1            NO                                           
*                                                                               
IMRH73A  MVI   1(R5),C'('                                                       
         STC   R1,2(R5)                                                         
         MVI   3(R5),C')'                                                       
         LA    R5,3(R5)                                                         
*                                                                               
IMRH73A1 CLI   INOLDAT,0           TEST HAVE DATE                               
         BE    IMRH73A2                                                         
         MVI   1(R5),C'-'                                                       
         GOTO1 DATCON,DMCB,(3,INOLDAT),(4,2(R5))                                
         LA    R5,6(R5)                                                         
IMRH73A2 AH    R4,INOLSTQ          BUMP TO NEXT INVOICE                         
         CLI   0(R4),C' '          TEST AT END                                  
         BNH   *+8                 YES, NO SEPARATOR                            
         MVI   1(R5),C','                                                       
         SH    R4,INOLSTQ          BACK UP TO CURRENT INVOICE                   
         LA    R0,WORK                                                          
         SR    R5,R0               R5 HAS LENGTH -1                             
*                                                                               
         LA    R6,1(R5,R3)                                                      
         LA    RE,53(R2)           GO OUT TO COLUMN 53                          
         CR    R6,RE               TEST WILL FIT                                
         BH    IMRH73D                                                          
*                                                                               
IMRH73B  DS    0H                                                               
         LA    R5,1(R5)                                                         
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),WORK                                                     
         LA    R3,1(R3,R5)                                                      
IMRH73C  AH    R4,INOLSTQ          NEXT INVOICE                                 
         B     IMRH73                                                           
*                                                                               
IMRH73D  DS    0H                  NEXT LINE                                    
         LA    R0,HEAD8            GO ONLY TO HEAD 8                            
         CR    R2,R0                                                            
         BNL   IMRH74B                                                          
         LA    R2,132(R2)                                                       
         CLI   0(R2),C' '          AND ONLY IF NOT USED                         
         BH    IMRH74B                                                          
         LA    R3,9(R2)                                                         
         B     IMRH73B                                                          
*                                                                               
IMRH74   DS    0H                                                               
         SH    R4,INOLSTQ          BACK UP TO PREV                              
         CLC   INOLINV,=10C'*'     TEST LIST OVERFLOW                           
         BE    IMRH74B                                                          
         BCTR  R3,0                BACK UP TO LAST PRINTED INVOICE              
         CLI   0(R3),C','          HAVE A COMMA LEFT OVER?                      
         BNE   IMRH80              NO                                           
         MVI   0(R3),C' '          YES - CLEAR IT                               
         B     IMRH80              GO PRINT THE INVOICES                        
*                                                                               
IMRH74B  DS    0H                                                               
         MVC   0(2,R3),=C'++'      MORE INVOICES                                
         DROP  R4                                                               
*                                                                               
IMRH80   DS    0H                                                               
         CLI   PAGSW,C'S'          FOR SUMMARY PAGES                            
         BNE   IMRH82                                                           
         LA    RF,=CL25'** DISCREPANCY SUMMARY **'                              
         CLI   DSUMSW,C'A'         ALL TYPES                                    
         BE    IMRH81                                                           
         CLI   DSUMSW,C'M'         MATCHING DISCREPANCIES                       
         BE    IMRH81                                                           
         LA    RF,=CL25'** H/V ERROR SUMMARY **'                                
         CLI   DSUMSW,C'R'         H/V ERRORS                                   
         BE    IMRH81                                                           
         LA    RF,=CL25'** FILM ERROR SUMMARY **'                               
         CLI   DSUMSW,C'F'         FILM ERRORS                                  
         BE    IMRH81                                                           
         B     IMRH84                                                           
*                                                                               
IMRH81   DS    0H                                                               
         MVC   HEAD5(25),0(RF)                                                  
         B     IMRH84                                                           
*                                                                               
IMRH82   DS    0H                  NON-SUMMARY PAGES                            
         CLI   RQGETNAM,C'Y'       SPECIAL NAMES?                               
         BNE   IMRH84                                                           
         MVC   HEAD8+97(5),=C'BUYER'                                            
         MVC   HEAD8+97+9(12),SVBUYNAM                                          
         MVC   HEAD9+97(6),=C'BILLER'                                           
         MVC   HEAD9+97+9(12),SVBILNAM                                          
*                                                                               
IMRH84   DS    0H                                                               
         CLI   QAREA+31,C'Z'       TEST A Z5 RUN                                
         BE    *+12                                                             
         CLI   QSAVE+31,C'Z'                                                    
         BNE   *+10                                                             
         MVC   HEAD4+114(4),=C'(Z5)'                                            
*                                                                               
IMRHX    DS    0H                                                               
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        PRINT MODULE                                                           
*-----------------------------------------------------------------              
*                                                                               
IRPRT    NMOD1 0,IRPRT                                                          
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   FORCEHED,C'P'                                                    
         BE    PRT10                                                            
         TM    LNEED,X'80'                                                      
         BZ    *+12                                                             
         MVI   MAXLINES,99                                                      
         B     PRT10                                                            
         CLI   LNEED,0                                                          
         BE    PRT10                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         IC    RE,LINE                                                          
         IC    RF,LNEED                                                         
         AR    RE,RF                                                            
         STC   RE,BYTE                                                          
         CLC   BYTE,MAXLINES                                                    
         BL    *+8                                                              
         MVI   FORCEHED,C'P'                                                    
*                                                                               
PRT10    DS    0H                                                               
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   PRT10D                                                           
         CLI   RCSUBPRG,50         UNLESS HAVE ALREADY DONE SO                  
         BNL   PRT10D                                                           
         LLC   RF,RCSUBPRG         BUMP SPROG BY 50                             
         LA    RF,50(RF)                                                        
         STC   RF,RCSUBPRG                                                      
PRT10D   DS    0H                                                               
         GOTO1 REPORT                                                           
*                                                                               
IRPRTX   DS    0H                                                               
         MVC   MAXLINES,SAVMAX                                                  
         MVI   LNEED,0                                                          
         J     EXIT                                                             
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*-----------------------------------------------------------------              
*        FORMAT A DEMO BUY LINE FOR DIGITAL REQUESTS                            
*-----------------------------------------------------------------              
FMTDBUY  NTR1  BASE=*,LABEL=*                                                   
         LA    RC,SPACEND                                                       
         USING BYELEMD,R7                                                       
         USING IELEMD,R8                                                        
*                                                                               
         MVC   P2+86(8),=C'BUYLINE:' BUYLINE DATA                               
*                                                                               
FDBUY01  XC    KEY,KEY             CLEAR THE KEY                                
         MVC   KEY+14(4),BYDISK    MOVE IN THE D/A                              
         MVC   AREC,ADBUY          GET THE BUY REC IN ADBUY                     
         GOTO1 GET                 GET THE BUY RECORD                           
*                                                                               
         L     R5,ADBUY            R5 = BUY RECORD                              
         LA    R5,24(R5)           FIRST ELEMENT                                
         XR    R0,R0               CLEAR R0                                     
*                                                                               
FDBUY10  CLI   0(R5),0             END OF RECORD?                               
         JE    EXIT                YES - EXIT                                   
         CLI   0(R5),X'02'         X'02' ELEMENT?                               
         JE    FDBUY20             YES                                          
         IC    R0,1(R5)            ELEMENT LENGTH                               
         AR    R5,R0               BUMP TO NEXT ELEMENT                         
         J     FDBUY10             TEST NEXT ELEMENT                            
*                                                                               
FDBUY20  IC    R0,1(R5)            ELEMENT LENGTH                               
         SHI   R0,NDEMNO-NDELEM    OVERHEAD LEN W/O DEMOS                       
         SRL   R0,3                R0 = NO. OF DEMOS                            
         LTR   R0,R0               HAVE ANY DEMOS?                              
         JZ    EXIT                NO - EXIT                                    
         AHI   R5,NDEMNO-NDELEM    POINT TO FIRST DEMO                          
*                                                                               
         MVC   P2+103(2),=C'I-'    IMPRESSIONS                                  
         MVC   P2+105(4),=C'NONE'  IN CASE WE DON'T FIND IT                     
         MVC   P2+112(2),=C'R-'    RATINGS                                      
         MVC   P2+114(4),=C'NONE'  IN CASE WE DON'T FIND IT                     
*                                                                               
         XC    WORK(3),WORK        CLEAR DEMO CATEGORY                          
         CLC   BYNOWK,BYUNACH      DID THIS INVOICE MATCH?                      
         BE    FDBUY45             NO                                           
         L     R4,AINOLST          A(INVOICE LIST)                              
         USING INOLSTD,R4          INVOICE LIST DSECT                           
FDBUY30  CLC   IINVID,INOLNUM      SAME INTERNAL INVOICE NUMBER                 
         BE    FDBUY40             YES                                          
         AH    R4,INOLSTQ          NEXT INVOICE                                 
         CLI   0(R4),C' '          ANY MORE                                     
         BH    FDBUY30             YES                                          
         J     EXIT                JUST SKIP THEN                               
*                                                                               
FDBUY40  MVC   WORK(3),INOLPDEM    MOVE DEMO TO WORK                            
*                                                                               
FDBUY45  BAS   RE,HAVEDEM          HAVE THE DEMO CATEGORY?                      
         JNE   EXIT                NO - EXIT                                    
         MVC   P2+95(7),INOLDEM    DEMO CATEGORY                                
         MVC   WORK(3),INOLPDEM    MOVE DEMO TO WORK                            
         MVI   WORK+1,C'I'         START WITH IMPRESSIONS                       
         BAS   RE,FINDDEM          FIND THE DEMO                                
         MVC   WORK(3),INOLPDEM    MOVE DEMO TO WORK                            
         MVI   WORK+1,C'R'         NOW DO RATINGS                               
         BAS   RE,FINDDEM          FIND THE DEMO                                
*                                                                               
         J     EXIT                EXIT                                         
         DROP  R4                  DROP INVOICE LIST USING                      
         LTORG                     LTORG                                        
*-----------------------------------------------------------------              
*        IF DEMO CATEGORY DOESN'T EXIST THEN REPORT PRIMARY DEMO                
*-----------------------------------------------------------------              
HAVEDEM  NTR1                                                                   
*                                                                               
         LR    RE,R5               START OF DEMOS                               
         LR    RF,R0               NUMBER OF DEMOS                              
*                                                                               
HVD00    CLC   WORK(3),0(RE)       MATCH ON DEMO CATEGORY?                      
         BE    HVDEQU              YES                                          
         LA    RE,8(RE)            NO - BUMP TO NEXT DEMO CATEGORY              
         BCT   RF,HVD00            LOOP BACK AND CHECK THAT ONE                 
*                                                                               
         CLI   2(R5),0             COMSCORE DEMO?                               
         BNE   HVD05               NO                                           
***                                                                             
* HAVE A COMSCORE DEMO                                                          
* IF PRIMARY DEMO IS  R/XA1824, LOOK FOR XA1824 & RXA1824                       
***                                                                             
         LLC   R1,1(R5)            DEMO INDEX INTO NTDDMONM                     
         BCTR  R1,0                -1                                           
         MHI   R1,9                *9                                           
         L     RF,VPOL50EL         A(X'50' ELEMENT) FROM BUY RECORD             
         LA    RF,2(R1,RF)         INDEX TO DEMO NAME ON BUY RECORD             
         MVC   DOUBLE,0(RF)        DEMO NAME                                    
         CLI   0(RF),C'R'          RATING?                                      
         BNE   *+14                NO                                           
         MVC   DOUBLE(7),1(RF)     YES - WE START WITH IMPRESSION               
         MVI   DOUBLE+7,X'40'      SPACE PAD LAST CHAR OF IMPRESSION            
         MVC   P2+95(7),DOUBLE     DEMO CATEGORY                                
*                                                                               
HVD02A   L     R4,VPOL50EL         A(X'50' ELEMENT) FROM BUY RECORD             
         LA    R4,2(R4)            BUMP PAST ELEMENT CODE & LENGTH              
         LA    R1,20               UP TO 20 DEMOS                               
*                                                                               
HVD02B   CLC   DOUBLE,0(R4)        MATCH ON DEMO NAME?                          
         BE    HVD03               YES                                          
         LA    R4,9(R4)            BUMP TO NEXT DEMO                            
         BCT   R1,HVD02B           TEST NEXT DEMO                               
         B     HVD03A              COMSCORE DEMO NAME NOT FOUND                 
*                                                                               
HVD03    SHI   R1,20               GET INDEX                                    
         LPR   R1,R1               ABSOLUTE VALUE                               
         AHI   R1,1                ADD 1 TO GET COMSCORE INDEX                  
         XC    WORK(3),WORK        CLEAR WORK                                   
         STC   R1,WORK+1           COMSCORE INDEX                               
         BAS   RE,FINDDEM          FIND THE DEMO                                
HVD03A   CLI   DOUBLE,C'R'         DID WE JUST DO RATINGS?                      
         BE    HVDNEQ              YES - DONE                                   
         MVI   DUB,C'R'            RATING                                       
         MVC   DUB+1(7),DOUBLE     REST OF RATING                               
         MVC   DOUBLE,DUB          RATING SET IN DOUBLE                         
         B     HVD02A                                                           
*                                                                               
HVD05    MVC   WORK(3),0(R5)       PRIMARY DEMO                                 
         MVI   WORK+1,C'I'         START WITH IMPRESSIONS                       
         BAS   RE,FINDDEM          FIND THE DEMO                                
         MVC   WORK(3),0(R5)       PRIMARY DEMO                                 
         MVI   WORK+1,C'R'         NOW DO RATINGS                               
         BAS   RE,FINDDEM          FIND THE DEMO                                
*                                                                               
HVD06    LA    R4,X                LOOK UP DEMO NAME                            
         XC    X,X                 CLEAR X                                      
         USING DTABD,R4            DEMO TAB DSECT                               
         MVC   DTABCOD,0(R5)       PRIMARY DEMO CODE ON BUY REC                 
*                                                                               
         GOTO1 BINSRCH,DEMPARS,DTABD                                            
*                                                                               
         CLI   DEMPARS,1           FOUND THE DEMO CODE?                         
         BE    HVD10               NO                                           
         ICM   RF,15,DEMPARS       HAVE A DEMO CODE ENTRY?                      
         BZ    HVD10               NO                                           
         MVC   P2+95(7),DTABNAM-DTABD(RF) DEMO CODE                             
         B     HVD20               HAVE DEMO CODE                               
*                                                                               
HVD10    GOTO1 DEMOCON,DMCB,(1,0(R5)),(2,P2+95),(C'S',ADBLOCK),0                
*                                                                               
HVD20    CLI   P2+95,C'R'          STARTS WITH "R"?                             
         BNE   HVDNEQ              NO - DEMO IS OK                              
         MVC   P2+95(7),P2+96      JUST REPORT THE DEMO CATEGORY                
*                                                                               
HVDNEQ   LTR   RD,RD               SET CC NEQ                                   
         J     EXIT                EXIT                                         
*                                                                               
HVDEQU   CR    RD,RD               SET CC EQU                                   
         J     EXIT                EXIT                                         
*-----------------------------------------------------------------              
*        FIND AND EDIT THE BUYS DEMO                                            
*-----------------------------------------------------------------              
FINDDEM  NTR1                                                                   
*                                                                               
FND00    CLC   WORK(3),0(R5)       MATCH ON DEMO CATEGORY?                      
         BE    FND10               YES                                          
         LA    R5,8(R5)            NO - BUMP TO NEXT DEMO CATEGORY              
         BCT   R0,FND00            LOOP BACK AND CHECK THAT ONE                 
         J     EXIT                NOT FOUND!                                   
*                                                                               
FND10    LR    R2,R5               R2 = DEMO                                    
         BRAS  RE,SETDEMV          GET SCALED VALUE OF DEMO                     
         ICM   R0,15,FULL          DEMO VALUE                                   
         LA    RF,WORK+1           NIELSEN DEMO                                 
         CLI   2(R5),0             COMSCORE DEMO?                               
         BNE   *+8                 NO                                           
         LA    RF,DOUBLE           COMSCORE DEMO NAME IS HERE                   
         LA    R2,P2+114           RATINGS PRINTED HERE                         
         CLI   0(RF),C'R'          RATINGS?                                     
         BE    *+8                 YES                                          
         LA    R2,P2+105           IMPRESSIONS                                  
*                                                                               
FND20    N     R0,=X'3FFFFFFF'     DROP FLAGS                                   
         TM    FULL,X'40'          2-DECIMAL DEMO?                              
         BO    FND30               YES                                          
         EDIT  (R0),(6,0(R2)),1    REPORT AS 1 DECIMAL                          
         J     EXIT                EXIT                                         
*                                                                               
FND30    EDIT  (R0),(7,0(R2)),2    REPORT AS 2 DECIMAL                          
         J     EXIT                EXIT                                         
*-----------------------------------------------------------------              
*        FORMAT A DEMO INV LINE FOR DIGITAL REQUESTS                            
*-----------------------------------------------------------------              
FMTDINV  NTR1  BASE=*,LABEL=*                                                   
         LA    RC,SPACEND                                                       
         USING BYELEMD,R7                                                       
         USING IELEMD,R8                                                        
*                                                                               
         MVC   WORK,SPACES                                                      
         MVC   WORK(8),=C'INVOICE:' INVOICE DATA                                
*                                                                               
         L     R4,AINOLST          A(INVOICE LIST)                              
         USING INOLSTD,R4          INVOICE LIST DSECT                           
FDINV00  CLC   IINVID,INOLNUM      SAME INTERNAL INVOICE NUMBER                 
         BE    FDINV01             YES                                          
         AH    R4,INOLSTQ          NEXT INVOICE                                 
         CLI   0(R4),C' '          ANY MORE                                     
         BH    FDINV00             YES                                          
         B     *+10                JUST SKIP THEN                               
FDINV01  MVC   WORK+9(7),INOLDEM   DEMO CATEGORY                                
         DROP  R4                  DROP INVOICE LIST USING                      
*                                                                               
         MVC   WORK+17(2),=C'I-'   IMPRESSIONS                                  
         CLC   IIDIMP,=X'FFFFFFFF' HAVE ANY VALUE?                              
         BNE   *+14                YES                                          
         MVC   WORK+19(4),=C'NONE' NO - DISPLAY "NONE"                          
         B     FDINV10                                                          
         TM    IIDIMP,X'40'        2 DECIMAL FLAG SET?                          
         BZ    FDINV02             NO                                           
         EDIT  (B3,IIDIMP+1),(6,WORK+19),2,ZERO=NOBLANK,WRK=WORK+44             
         B     FDINV10                                                          
FDINV02  EDIT  (B4,IIDIMP),(6,WORK+19),1,ZERO=NOBLANK,WRK=WORK+44               
*                                                                               
FDINV10  MVC   WORK+26(2),=C'R-'   RATINGS                                      
         CLC   IIDRAT,=X'FFFFFFFF' HAVE ANY VALUE?                              
         BNE   *+14                YES                                          
         MVC   WORK+28(4),=C'NONE' NO - DISPLAY "NONE"                          
         B     FDINV20                                                          
         EDIT  (B4,IIDRAT),(6,WORK+28),2,ZERO=NOBLANK,WRK=WORK+44               
*                                                                               
FDINV20  MVC   WORK+35(2),=C'C-'   CLICKS                                       
         CLC   IIDCLK,=X'FFFFFFFF' HAVE ANY VALUE?                              
         BNE   *+14                YES                                          
         MVC   WORK+37(4),=C'NONE' NO - DISPLAY "NONE"                          
         B     FDINVX              AND EXIT                                     
*                                                                               
         EDIT  (B4,IIDCLK),(7,WORK+37),ALIGN=LEFT,ZERO=NOBLANK,        X        
               WRK=WORK+44                                                      
*                                                                               
FDINVX   J     EXIT                EXIT                                         
         LTORG                     LTORG                                        
*                                                                               
SETDEMV  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         ICM   R0,15,4(R2)         DEMO VALUE                                   
         N     R0,=X'3FFFFFFF'     CLEAR HOB                                    
         SR    R1,R1                                                            
         IC    R1,3(R2)            HUT                                          
         AR    R1,R1               X 2                                          
         MR    R0,R0                                                            
         D     R0,=F'100'                                                       
         AHI   R1,1                                                             
         SRL   R1,1                                                             
         STCM  R1,15,FULL                                                       
*                                                                               
         CLI   2(R2),0             COMSCORE DEMO?                               
         BNE   SETDEMVA            NO                                           
         LLC   R1,1(R2)            DEMO INDEX INTO NTDDMONM                     
         BCTR  R1,0                -1                                           
         MHI   R1,9                *9                                           
         L     RF,VPOL50EL         A(X'50' ELEMENT) FROM BUY RECORD             
         LA    RF,2(R1,RF)         INDEX TO DEMO NAME ON BUY RECORD             
         CLI   0(RF),C'R'          RATING?                                      
         B     SETDEMVB            GO TEST CC                                   
*                                                                               
SETDEMVA CLI   1(R2),C'R'          TEST RATING                                  
         BE    *+8                                                              
         CLI   1(R2),C'E'          OR EXTENDED RATING                           
SETDEMVB BE    SETDEMVC                                                         
         TM    RQOPTS,RQOPTS_2DECIMP  WANT 2 DECIMAL IMPRESSIONS?               
         B     *+8                 GO TEST CC                                   
SETDEMVC TM    RQOPTS,RQOPTS_2DEC  TEST 2-DEC REQUEST                           
         BO    SETDEMV2            YES                                          
*                                                                               
         TM    4(R2),X'40'         1-DEC REQ, TEST 2-DEC VALUE                  
         BZ    SETDEMVX            NO - DONE                                    
         M     R0,=F'2'            SCALE 2-DEC VALUE TO 1 DEC                   
         D     R0,=F'10'                                                        
         AHI   R1,1                                                             
         SRL   R1,1                                                             
         STCM  R1,15,FULL                                                       
         B     SETDEMVX                                                         
*                                                                               
SETDEMV2 OI    FULL,X'40'          ASSUME 2-DEC VALUE                           
         TM    4(R2),X'40'         TEST REALLY 2-DEC VALUE                      
         BO    SETDEMVX            YES -DONE                                    
         MHI   R1,10               ELSE SCALE TO 2-DEC                          
         STCM  R1,15,FULL                                                       
         OI    FULL,X'40'          AND SET FLAG                                 
*                                                                               
SETDEMVX J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
IRENDEST NTR1  BASE=*,LABEL=*                                                   
         OC    EGRS(12),EGRS                                                    
         BZ    IRENDEX                                                          
         LA    R2,P                                                             
         USING LNAD,R2                                                          
         CLI   COSTSUP,C'N'        SUPPRESS COSTS                               
         BNE   *+10                                                             
         MVC   LNACOST+4(7),DASHES                                              
         CLI   QBOOK1,C' '                                                      
         BE    IRENDE2                                                          
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BE    IRENDE2             YES                                          
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    IRENDE2             YES                                          
         MVC   LNAEDEM+1(5),DASHES                                              
         MVC   LNAADEM+1(5),DASHES                                              
IRENDE2  DS    0H                                                               
         LA    R2,P2                                                            
         CLI   COSTSUP,C'N'        SUPPRESS COSTS                               
         BNE   IRENDE3                                                          
         EDIT  EGRS,(11,LNACOST),2,FLOAT=-                                      
IRENDE3  DS    0H                                                               
         CLI   QBOOK1,C' '                                                      
         BE    IRENDE4                                                          
         CLI   DIGITAL,C'Y'        DIGITAL?                                     
         BE    IRENDE4             YES                                          
         CLI   I2CPROF+14,C'Y'     I2 DELIVERY SECTION REMOVED?                 
         BE    IRENDE4             YES                                          
*                                                                               
         L     R0,EDEMEST                                                       
         N     R0,=X'3FFFFFFF'                                                  
         TM    EDEMEST,X'40'       TEST 2-DEC VALUE                             
         BO    IRENDE3A                                                         
         EDIT  EDEMEST,(6,LNAEDEM),1                                            
         B     IRENDE3B                                                         
IRENDE3A EDIT  (R0),(7,LNAEDEM-1),2                                             
*                                                                               
IRENDE3B L     R0,EDEMACH                                                       
         N     R0,=X'3FFFFFFF'                                                  
         TM    EDEMACH,X'40'       TEST 2-DEC VALUE                             
         BO    IRENDE3C                                                         
         EDIT  EDEMACH,(6,LNAADEM),1                                            
         B     IRENDE4                                                          
IRENDE3C EDIT  (R0),(7,LNAADEM-1),2                                             
*                                                                               
IRENDE4  DS    0H                                                               
         CLC   P,SPACES                                                         
         BE    IRENDE5                                                          
         GOTO1 AIRPRT                                                           
IRENDE5  DS    0H                                                               
         XC    EGRS(12),EGRS                                                    
         L     RF,ECOUNT           BUMP COUNT OF ESTS                           
         LA    RF,1(RF)                                                         
         ST    RF,ECOUNT                                                        
IRENDEX  DS    0H                                                               
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
IRCOM    NTR1  BASE=*,LABEL=*                                                   
         CLI   NETPSW,C'Y'         FOR NETPAK                                   
         BNE   IRCOM2                                                           
         L     R4,ACOMTAB          ONLY HAVE COMMENTS FOR THIS UNIT             
         B     IRCOM3                                                           
*                                                                               
IRCOM2   DS    0H                                                               
         LA    R3,WORK                                                          
         USING BUYRTABD,R3                                                      
         MVC   BUYRPRD,BPRD                                                     
         MVC   BUYREST(3),BYEST                                                 
         MVC   BUYRDA,BYDISK                                                    
         GOTO1 BINSRCH,BUYRPARS,(R3)                                            
         CLI   0(R1),1             TEST FOUND                                   
         BE    IRCOMX                                                           
         SR    R3,R3                                                            
         ICM   R3,7,BUYRPARS+1     YES, PICK UP ENTRY                           
         BZ    IRCOMX                                                           
         MVC   FULL,BUYRCOM                                                     
         L     R4,FULL                                                          
         LTR   R4,R4                                                            
         BZ    IRCOMX                                                           
*                                                                               
IRCOM3   LA    R3,P2+15                                                         
         LA    R1,13               DON'T PRINT PAST THE 14TH LINE!              
*                                                                               
IRCOM5   CLI   0(R4),0                                                          
         BE    IRCOMX                                                           
         LLC   R5,1(R4)                                                         
         AHI   R5,-4                                                            
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),3(R4)                                                    
         CR    R3,R1                                                            
         BE    IRCOMX                                                           
         LA    R3,132(R3)                                                       
         LA    R4,4(R5,R4)                                                      
         BCT   R1,IRCOM5           DON'T GO PAST 14TH LINE!                     
*                                                                               
IRCOMX   J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        GOGETSNV CALL GETSNV FOR NEW-STYLE SNV'S                               
**********************************************************************          
GOGETSNV NTR1  BASE=*,LABEL=*                                                   
         MVI   ERROR,0                                                          
         MVI   BUFFERR,0                                                        
         CLI   I2YPROF+9,C'Y'      TEST OPTION TO READ NEW RECORDS              
         BC    0,GOSNVX          ** ALWAYS READ NEW **                          
*                                                                               
         LA    R4,X                                                             
         USING SBLD,R4                                                          
         XC    SBLD(SBLBLEN),SBLD                                               
*                                                                               
         MVI   SBLMODE,C'I'        SET I2 MODE                                  
         MVC   SBLAGYMD,BAGYMD     AGENCY/MEDIA                                 
         MVC   SBLCLT,BCLT         CLIENT                                       
*                                                                               
         CLC   =C'ALL',QSTA        ALL STATION REQUEST?                         
         BNE   GSNV1               NO                                           
         CLI   Q2USER+7,C'S'       ALL-SM REQUEST?                              
         BE    *+12                YES                                          
         CLI   Q2USER+7,C'D'       ALL-DV REQUEST?                              
         BNE   GSNV1               NO                                           
*                                                                               
         CLI   BIGSTA+4,C'/'       LOCAL CABLE REQUEST?                         
         BE    GOSNVX              YES - BIGSTA+5 CAN HAVE "S" OR "D"!          
         CLC   BIGSTA+5(1),Q2USER+7 IS THIS A DV/SM STATION?                    
         BNE   GOSNVX              NO - NOT DV/SM SO WE DON'T WANT IT           
*                                                                               
GSNV1    MVC   SBLSTA,BMKTSTA+2    STATION                                      
         TM    CBLHOPT,CBLHALLQ    IF CBH ALL/ W/NETS SEPARATE                  
         BO    GSNV2               PROC 1 NET AT A TIME                         
         CLI   QCBLNET,C' '        OR ONLY 1 NETWORK                            
         BH    GSNV2                                                            
         TM    CBLHOPT,CBLHNHAQ    IF CBH REQ AND NEW MODE AND                  
         BNO   *+8                 ALL NETS                                     
         NI    SBLSTA+2,X'80'      CLEAR NETWORK                                
GSNV2    TM    CBLHOPT,CBLHNMQ     IF NEW CABLE MODE                            
         BZ    *+8                                                              
         MVI   SBLCMOD,C'Y'        TELL GETSNV                                  
*                                                                               
         CLI   I2IPROF,C'Y'        MATCH ON INTEGRATION AND COST                
         BNE   *+8                                                              
         MVI   SBLINT,C'Y'         RETURN ALL INVOICES W/INTEGRATION            
         CLI   I2IPROF+1,C'Y'      INTEGRATION ONLY                             
         BNE   *+8                                                              
         MVI   SBLINT,C'O'         RETURN ONLY INVOICES W/INTEGRATION           
         MVC   SBLPRD,BPRD         PRD 1                                        
         MVC   SBLPRD2,BPRD2       PRD 2                                        
         MVC   SBLNPRD,PRD         3 CHAR PRD                                   
         MVC   SBLNPRD2,PRD2       3 CHAR PRD2                                  
         MVC   SBLPIGCT,PIGCTL     PASS PIG CONTROL                             
*                                                                               
***      CLI   BPRD2,0             IF NO 2ND PRD                                
***      BNE   GSNV3                                                            
         OC    PRD2,PRD2           IF NO 2ND PRD                                
         BNZ   GSNV3                                                            
         CLI   PIGCTL,C'N'         AND PIG CONTROL IS NOT 'NO'                  
         BE    GSNV3                                                            
         MVI   SBLPRD2,X'FF'       ALLOW ALL PIGS                               
*                                                                               
GSNV3    DS    0H                                                               
         MVC   SBLEST,BEST         EST                                          
*                                                                               
         L     R6,VMASTC           A(DDMASTD)                                   
         USING MASTD,R6                                                         
         OC    MCREMPQK,MCREMPQK   SOON?                                        
         BZ    GSNV3A              ZERO = OV = DON'T SET ALL PRD/EST            
         DROP  R6                                                               
*                                                                               
         CLC   QEST,=C'ALL'        ALL ESTIMATE REQUEST?                        
         BNE   *+8                 NO                                           
         OI    SBLFLAG,SBLESTAL    YES - SET EST ALL REQUEST FLAG               
         CLC   QPRD,=C'ALL'        ALL PRODUCT REQUEST?                         
         BNE   *+8                 NO                                           
         OI    SBLFLAG,SBLPRDAL    YES - SET EST ALL REQUEST FLAG               
*                                                                               
GSNV3A   MVC   SBLMOS,BRDMON       START DATE OF BRD MONTH                      
         MVC   SBLSDAT,BQSTARTP    START                                        
         MVC   SBLEDAT,BQENDP      END                                          
         MVC   SBLBUYID,SVBUYID  CONTRACT/ID                                    
*                                                                               
         MVI   SBLEASI,C'Y'        EASI/NOEASI CONTROL                          
         CLC   =C'EASI',QUESTOR                                                 
         BE    GSNV4                                                            
         MVI   SBLEASI,C'N'                                                     
         CLC   =C'NOEASI',QUESTOR                                               
         BE    GSNV4                                                            
         MVI   SBLEASI,C'B'        BOTH                                         
*                                                                               
GSNV4    DS    0H                                                               
         MVI   SBLMCT,C'Y'         MCT CONTROL                                  
         CLI   PSEUDOPT,C'P'                                                    
         BE    *+8                                                              
         MVI   SBLMCT,C'N'                                                      
*                                                                               
         MVI   SBLRESP,C'Y'        RESPONSE CONTROL                             
         CLI   PSEUDOPT,C'R'                                                    
         BE    *+8                                                              
         MVI   SBLRESP,C'N'                                                     
*                                                                               
         MVC   SBLAIKL,AIKLIST     SET A(INVOICE KEY LIST)                      
         MVC   SBLACOM,ACOMFACS    A(COMFACS)                                   
         MVC   SBLABSRC,BINSRCH    A(BINSRCH)                                   
         MVC   SBLARCUP,RECUP      A(RECUP)                                     
         MVC   SBLARCPK,VRCPACK    A(RCPACK)                                    
         MVC   SBLATRPK,VTRPACK    A(TRPACK)                                    
         MVC   SBLAIO,ADBUY        BUY REC FOR IO AREA                          
         L     RF,ALINV                                                         
         LA    RF,1(RF)                                                         
         ST    RF,SBLAITB          CURRENT SLOT IN INVOICE TABLE                
         MVC   SBLAITBX,ABUFFX     A(END OF TABLE AREA)                         
         MVC   SBLAPGL,APIGLIST    A(PIGGY BACK LIST)                           
         LA    RF,FLMTPARS         FILM TAB BINSRCH PARMS                       
         ST    RF,SBLAFTBP                                                      
         CLI   NETPSW,C'Y'         FOR NETPAK - NO IDS                          
         BE    *+10                                                             
         MVC   SBLAIDL,AIDLIST     A(ID LIST)                                   
         MVC   SBLNETP,NETPSW      PASS NETPAK FLAG                             
         MVC   SBLAINOL,AINOLST    A(INOLST)                                    
         MVI   SBLMXIDS,MAXIDS     MAXIMUM ID'S                                 
         MVC   SBLMXINB,=AL2(MAXINOS)   MAX INVOICES FOR INOLST                 
         MVC   SBLILEN,IELMLEN     INVOICE ELEMENT LENGTH                       
         CLI   QPGR,C' '           TEST PRDGRP REQUEST                          
         BE    GOSNV15             NO                                           
         CLC   =C'POL',QPRD        TEST POL REQUEST                             
         BNE   GOSNV15             NO                                           
         MVC   SBLPRDGR,SVPRDADR   PASS FOR PGRP                                
*                                                                               
GOSNV15  DS    0H                                                               
         GOTO1 =V(GETSNV),DMCB,SBLD                                             
*                                  TEST OVERFLOWS/ERRORS                        
**       TM    SBLSTAT,SBLUDERR    ALL PRD/EST ERROR?                           
**       BZ    *+12                NO                                           
**       MVI   PSTOPT,C'U'         YES - FLAG TO PREVENT SRUPD00 DUMPS          
**       MVI   RCWRITE,C'N'                                                     
*                                                                               
         CLI   DIGITAL,C'Y'        DIGITAL REQUEST?                             
         BNE   GOSNV18             NO                                           
*                                                                               
         L     R5,AINOLST          A(INVOICE TABLE)                             
         USING INOLSTD,R5          INVOICE LIST DSECT                           
*                                                                               
GOSNV16  CLI   0(R5),C' '          END OF INVOICE LIST?                         
         BNH   GOSNV18             YES - DONE                                   
         OC    INOLPDEM,INOLPDEM   HAVE A DEMO CATEGORY?                        
         BZ    GOSNV17             NO - BUMP TO NEXT INVOICE                    
*                                                                               
         GOTO1 DEMOCON,DMCB,(1,INOLPDEM),(2,INOLDEM),(C'S',ADBLOCK),0           
*                                                                               
GOSNV17  AH    R5,INOLSTQ          NEXT INVOICE                                 
         B     GOSNV16             CHECK NEXT INVOICE                           
         DROP  R5                  DROP INVOICE LIST USING                      
*                                                                               
GOSNV18  MVC   SVINVCT,SBLINVC     SAVE HIGHEST INV SEQ NUMBER                  
         TM    SBLSTAT,SBLINVQ     FOUND ANY INVOICE ITEMS?                     
         BZ    GOSNV20             NO                                           
*                                                                               
         MVI   NETINV,C'N'         SET NET SWITCH                               
         TM    SBLSTAT,SBLNETQ     NET INVOICE?                                 
         BZ    *+8                 NO                                           
         MVI   NETINV,C'Y'         YES                                          
*                                                                               
GOSNV20  TM    SBLSTAT,SBLITOVQ+SBLFTOVQ+SBLIDOVQ                               
         BZ    GOSNV20A            OVERFLOW ERROR?                              
         MVI   ERROR,BUFERR        YES                                          
         TM    SBLSTAT,SBLITOVQ    INVOICE TABLE OVERFLOW?                      
         BZ    *+8                 NO                                           
         OI    BUFFERR,BERRINV     YES - FLAG THE ERROR                         
         TM    SBLSTAT,SBLFTOVQ    FILM TABLE OVERFLOW?                         
         BZ    *+8                 NO                                           
         OI    BUFFERR,BERRFLM     YES - FLAG THE ERROR                         
         TM    SBLSTAT,SBLIDOVQ    CONTRACT ID TABLE OPVERFLOW?                 
         BZ    *+8                 NO                                           
         OI    BUFFERR,BERRCID     YES - FLAG THE ERROR                         
         B     GOSNVX              EXIT                                         
*                                                                               
GOSNV20A L     RF,SBLIEND          END OF TABLE                                 
         BCTR  RF,0                BACK UP ONE BYTE                             
         ST    RF,ALINV            FOR ALINV                                    
         DROP  R4                                                               
***                                                                             
* LOOP THROUGH ALL THE INVOICES AND SET 3 CHARACTER PRODUCTS                    
***                                                                             
         CLI   NETPSW,C'Y'         NETPAK?                                      
         BNE   GOSNVX              NO                                           
*                                                                               
         L     R8,AFINV            FIRST INVOICE                                
*                                                                               
GOSNV21  C     R8,ALINV            PROCESSED ALL THE INVOICES?                  
         BNL   GOSNVX              YES                                          
*                                                                               
         CLI   IPRDNT,0            HAVE 3 CHARACTER PRODUCT?                    
         BNE   GOSNV50             YES, NO NEED TO GET FROM CLIST               
         CLI   IPRD,0              HAVE BINARY PRODUCT?                         
         BNE   *+6                 YES                                          
         DC    H'0'                NO - FATAL ERROR                             
*                                                                               
         LA    R3,IPRD             BINARY PRD                                   
         LA    R4,IPRDNT           3 CHAR PRD                                   
         LA    R2,2                2 CLISTS TO LOOK THROUGH                     
*                                                                               
GOSNV25  L     R1,ADCLT            A(CLIENT RECORD)                             
         LA    R1,CLIST-CLTHDR(R1) CLIST                                        
         LA    RF,220              220 PRDS IN CLIST                            
*                                                                               
GOSNV30  CLI   3(R1),0             END OF LIST?                                 
         BE    GOSNV45             YES - DID NOT FIND THIS 3 CHAR PRD           
         CLC   0(1,R3),3(R1)       MATCH ON BINARY PRODUCT?                     
         BE    GOSNV40             YES - SET 3 CHAR PRODUCT                     
         LA    R1,4(R1)            BUMP                                         
         BCT   RF,GOSNV30          CHECK NEXT PRD IN CLIST                      
*                                                                               
         L     R1,ADCLT            A(CLIENT RECORD)                             
         LA    R1,CLIST2-CLTHDR(R1) CLIST2                                      
         LA    RF,35               35 PRODUCTS IN CLIST2                        
*                                                                               
GOSNV35  CLI   3(R1),0             END OF LIST?                                 
         BE    GOSNV45             YES - DID NOT FIND THIS 3 CHAR PRD           
         CLC   0(1,R3),3(R1)       MATCH ON BINARY PRODUCT?                     
         BE    GOSNV40             YES - SET 3 CHAR PRODUCT                     
         LA    R1,4(R1)            BUMP                                         
         BCT   RF,GOSNV35          CHECK NEXT PRD IN CLIST2                     
         DC    H'0'                DEATH IF NOT FOUND                           
*                                                                               
GOSNV40  MVC   0(3,R4),0(R1)       3 CHARACTER PRODUCT                          
*                                                                               
GOSNV45  LA    R3,1(R3)            POINT TO IPRD2                               
         CLI   0(R3),0             HAVE IPRD2?                                  
         BE    GOSNV50             NO                                           
         LA    R4,3(R4)            YES - POINT TO IPRD2NT                       
         BCT   R2,GOSNV25          SET PIGGY 3-CHAR PRODUCT                     
*                                                                               
GOSNV50  AH    R8,IELMLEN          NEXT INVOICE ITEM                            
         B     GOSNV21             NEXT INVOICE                                 
*                                                                               
GOSNVX   CLI   ERROR,0             SET CC                                       
         J     INEXT               EXIT                                         
***********************************************************************         
* SEND AN E-MAIL REGARDING BAD I2 REQUEST                             *         
***********************************************************************         
EMAIL    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLC   QPROG(2),=C'U1'                                                  
         BE    EMAILX                                                           
*                                                                               
         L     R3,ADCONLST                                                      
         USING SPADCONS,R3                                                      
         GOTOR VSMTP,DMCB,('SMTPAINI',JESMAIL)                                  
***      CLI   FCRDBUYS,C'S'                                                    
***      BNE   EMAIL00                                                          
***      GOTOR VSMTP,DMCB,('SMTPAPRS',TOWHO2),(L'SUBJECT2,SUBJECT2)             
***      B     EMAIL01                                                          
*                                                                               
EMAIL00  GOTOR VSMTP,DMCB,('SMTPAPRS',TOWHO),(L'SUBJECT,SUBJECT)                
*                                                                               
         XC    P,P                                                              
         MVC   P(L'LINE1),LINE1                                                 
         GOTOR VSMTP,DMCB,('SMTPAPTL',P)                                        
*                                                                               
EMAIL01  L     R6,VMASTC                                                        
         USING MASTD,R6                                                         
*                                                                               
         XC    P,P                                                              
         MVC   P(3),=C'ID='                                                     
         MVC   P+3(L'MCUSERID),MCUSERID   USER-ID                               
         LA    R4,P+3+L'MCUSERID                                                
         CLI   0(R4),C' '                                                       
         BH    *+8                                                              
         BCT   R4,*-8                                                           
         MVI   1(R4),C','                                                       
*                                                                               
         L     RE,MCAEXTRA                                                      
         MVC   4(5,R4),=C'NAME='                                                
         MVC   9(L'MCFNAME,R4),MCFNAME-MCEXTRA(RE)                              
         LA    R4,9+L'MCFNAME(R4)                                               
         CLI   0(R4),C' '                                                       
         BH    *+8                                                              
         BCT   R4,*-8                                                           
         CLI   MCMNAME-MCEXTRA(RE),C' '                                         
         BNH   EMAIL10                                                          
         MVC   2(1,R4),MCMNAME-MCEXTRA(RE)                                      
         MVI   3(R4),C'.'                                                       
         LA    R4,3(R4)                                                         
*                                                                               
EMAIL10  MVC   2(L'MCLNAME,R4),MCLNAME-MCEXTRA(RE)                              
         LA    R4,2+L'MCLNAME(R4)                                               
         CLI   0(R4),C' '                                                       
         BH    *+8                                                              
         BCT   R4,*-8                                                           
         MVI   1(R4),C','                                                       
*                                                                               
         MVC   4(10,R4),=C'REPORT ID='                                          
         MVC   15(3,R4),MCREMPQK+2                                              
         MVI   18(R4),C','                                                      
         XR    RF,RF                                                            
         ICM   RF,3,MCREMPQK+5                                                  
         EDIT  (RF),(4,19(R4)),ALIGN=LEFT                                       
         OC     P(80),SPACES                                                    
*                                                                               
         GOTOR VSMTP,DMCB,('SMTPAPTL',P)                                        
         MVC   P(80),QAREA                                                      
         GOTOR VSMTP,DMCB,('SMTPAPTL',P)                                        
         MVC   P(80),QAREA2                                                     
         GOTOR VSMTP,DMCB,('SMTPAPTL',P)                                        
*                                                                               
         GOTOR VSMTP,DMCB,('SMTPASND',0)                                        
         GOTOR VSMTP,DMCB,('SMTPAEND',0) DETACH SMTP                            
         DROP  R3,R6                                                            
*                                                                               
EMAILX   J     EXIT                                                             
*                                                                               
JESMAIL  DC    CL8'JESMAIL '                                                    
TOWHO    DC    C'INT_CLIACC@MEDIAOCEAN.COM,AKATZ@MEDIAOCEAN.COM:'               
SUBJECT  DC    C'BAD I2 REQUEST, PLEASE ASK USER TO REQ PRD/EST SPECIFI+        
               C OR OV I2'                                                      
LINE1    DC    C'REQUEST FOR ALL PRD/EST REQ NOT VALID DUE TO MULTIPLE +        
               PRD/EST ON INVOICE.'                                             
***                                                                             
* THIS IS FOR WHEN FCRDBUYS,C'S'                                                
***                                                                             
*&&DO                                                                           
TOWHO2   DC    C'AKAT@MEDIAOCEAN.COM,MHER@MEDIAOCEAN.COM:'                      
SUBJECT2 DC    C'QREP SET!'                                                     
*&&                                                                             
         LTORG                                                                  
*                                                                               
ERRTST   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   ERROR,0                                                          
         JE    ERRTSTEQ                                                         
*                                                                               
         CLI   ERROR,BUFERR                                                     
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   P(39),=C'** BUFFER OVERFLOW ON STATION          **'              
         MVC   P+30(9),BIGSTA                                                   
         MVC   P2+30(9),DASHES                                                  
         MVC   P3(49),=C'** RE-REQUEST - LIMITING PERIOD AND/OR PRODUCTX        
                **'                                                             
         MVC   P4(80),QPROG                                                     
*                                                                               
         TM    BUFFERR,BERRBUY     BUY OVERFLOW?                                
         BZ    *+10                NO                                           
         MVC   P5(12),=C'BUY OVERFLOW'                                          
         TM    BUFFERR,BERRCOM     BUY COMMENT TABLE OVERFLOW?                  
         BZ    *+10                NO                                           
         MVC   P5(20),=C'BUY COMMENT OVERFLOW'                                  
         TM    BUFFERR,BERRINV     INV OVERFLOW (SBLITOVQ)?                     
         BZ    *+10                NO                                           
         MVC   P5(12),=C'INV OVERFLOW'                                          
         TM    BUFFERR,BERRFLM     INV FILM TABLE OVERFLOW (SBLFTOVQ)?          
         BZ    *+10                NO                                           
         MVC   P5(13),=C'FILM OVERFLOW'                                         
         TM    BUFFERR,BERRCID     CONTRACT ID OVERFLOW (SBLIDOVQ)?             
         BZ    *+10                NO                                           
         MVC   P5(20),=C'CONTRACT ID OVERFLOW'                                  
*                                                                               
         MVI   FORCEHED,C'P'                                                    
         GOTO1 AIRPRT                                                           
***      BRAS  RE,FREEBUFF                                                      
*                                  END REQUEST TO PREVENT DUMP                  
         GOTO1 AENDREQ             DON'T BOTHER WITH REQUEST                    
*                                                                               
ERRTSTNE LTR   RD,RD               SET CC NEQ                                   
         J     EXIT                EXIT                                         
*                                                                               
ERRTSTEQ CR    RD,RD               SET CC EQU                                   
         J     EXIT                EXIT                                         
         LTORG                                                                  
*-----------------------------------------------------------------              
*        BUFFERS AND STUFF                                                      
*-----------------------------------------------------------------              
IMRWKC   CSECT                                                                  
         PRINT GEN                                                              
BUFFRIN  BUFFD TYPE=D,                                                 X        
               KEYLEN=4,                                               X        
               COMLEN=20,                                              X        
               FILE=BUFFWK                                                      
*                                                                               
BUFFRN2  BUFFD TYPE=D,                                                 X        
               KEYLEN=33,                                              X        
               COMLEN=18,                                              X        
               FILE=BUFFWK1                                                     
*                                                                               
***      BUFF  LINES=500,COMMENT=18,FLAVOR=DATA,KEYLIST=(29,A)                  
         PRINT NOGEN                                                            
*                                                                               
BUFLSOON EQU   1800000             1.80 MB BUFFER FOR BUYS/INV SOON             
BUFFLOV  EQU   3650000             3.65 MB BUFFER FOR BUYS/INV OV               
*                                                                               
DEMOTAB  DS    0D                                                               
DEMOTABL EQU   8*DTABEL                                                         
         ORG   *+DEMOTABL                                                       
         DC    X'0000'                                                          
*                                                                               
*                                                                               
*                                                                               
MGNAMTAB DS    0D                  DOUBLES AS PATTERN REF# TABLE                
MGNAMTBE EQU   138                                                              
MGNAMTBL EQU   200*MGNAMTBE                                                     
         ORG   *+MGNAMTBL                                                       
         DC    X'0000'                                                          
         SPACE 2                                                                
MKNAMTAB DS    0D                                                               
MKNAMTBL EQU   1000*26                                                          
         ORG   *+MKNAMTBL                                                       
         DC    X'0000'                                                          
* DISABLE LETTER PRINTING - AKAT 7/12/07                                        
*&&DO                                                                           
SLTRTAB  DS    0D                                                               
SLTRMAX  EQU   500                                                              
         ORG   *+SLTRMAX*3                                                      
*&&                                                                             
SREPTAB  DS    0D                                                               
SREPTABL EQU   20*SREPL                                                         
         ORG   *+SREPTABL                                                       
BUYRTAB  DS    0D                                                               
BUYRTABL EQU   1000*BUYRTBEL                                                    
         ORG   *+BUYRTABL                                                       
*                                                                               
IMRWKC   CSECT                                                                  
*                                                                               
***MAXIDS   EQU   138                 138 ID'S (SAME AS SPONSOR)                
MAXIDS   EQU   200                 138 ID'S (SAME AS SPONSOR)                   
IDLIST   DS    0D                                                               
         DS    CL(IDLSTL*MAXIDS)                                                
*                                                                               
MAXSTNS  EQU   2400                ROOM FOR 2000 STATIONS                       
STNLIST  DS    0D                                                               
         DS    CL(3*MAXSTNS)                                                    
*                                                                               
DUMBUY   DS    CL200               AREA FOR DUMMY BUY RECORD                    
*                                                                               
PRVTAB   DS    0F                                                               
         DC    C'BCHST-BC  '                                                    
         DC    C'ALPST-AL  '                                                    
         DC    C'SAPST-SA  '                                                    
         DC    C'MAPST-MA  '                                                    
         DC    C'ONHST-ON  '                                                    
         DC    C'PQQST     '                                                    
         DC    C'NBHST-NB  '                                                    
         DC    C'NSHST-NS  '                                                    
         DC    C'PEPST-PEI '                                                    
         DC    C'NFHST-NF  '                                                    
         DC    X'FF'                                                            
PRVTABL  EQU   10                                                               
*                                                                               
FLMTABL  EQU   MAXFLMS*FLMTABEL    SEE FLMTABD IN SPSNVBLK                      
FLMTAB   DS    0D                                                               
         ORG   *+FLMTABL                                                        
         DC    X'0000'                                                          
*                                                                               
FLTTABL  EQU   (MAXFLMS-500)*FLTTABEL    SEE FLTTABD IN SPSNVBLK                
FLTTAB   DS    0D                                                               
         ORG   *+FLTTABL                                                        
         DC    X'0000000000'                                                    
*                                                                               
PRDTABL  EQU   (MAXFLMS-750)*FPRTABEL    SEE FPRDTABD IN SPSNVBLK               
PRDTAB   DS    0D                                                               
         ORG   *+PRDTABL                                                        
         DC    X'0000000000'                                                    
*                                                                               
         DS    0D                                                               
STEQREC  DS    CL1000                                                           
*                                                                               
COMTAB   DS    0D                                                               
         DS    15000C                                                           
COMTABX  EQU   *                                                                
*                                                                               
MAXINOS  EQU   650                 MAXIMUM INVOICES FOR INOLST                  
INOLST   DS    0D                  (512 MAX INVOICES FOR DIGITAL)               
         ORG   *+INOLSTL*MAXINOS                                                
         DC    X'0000'                                                          
*                                                                               
IKLIST   DS    0D                  INVOICE KEY LIST FOR MATCHMAKER              
         ORG   *+L'SNVKEY*MAXINOS                                               
         DC    X'0000'                                                          
*                                                                               
PIGLIST  DS    XL256                                                            
*                                                                               
         DS    0D                                                               
SPADWK   DS    XL(SPADINTL)                                                     
*                                                                               
         DS    0D                                                               
         DC    CL8'*MGATAB*'                                                    
MGATBL   DS    XL(200*MGERECL)     MG ANALYSIS TABLE - 200 MAX                  
*                                                                               
         DS    0D                                                               
MGAIOW   DS    XL(2000)            MG ANALYSIS - IO WORK AREA                   
*                                                                               
         DS    0D                                                               
DBLOCKA  DS    XL256               AREA FOR DBLOCK                              
*                                                                               
         DS    0D                                                               
SAVCLTR  DS    XL1500              SAVE ARE FOR CLIENT RECORD                   
*** ++INCLUDE DEDBLOCK                                                          
         PRINT OFF                                                              
       ++INCLUDE DEDBLOCK                                                       
         PRINT ON                                                               
*                                                                               
FRPTBUF  DS    0D                  PRINT LINE BUFFER FOR FILM RPT               
         DS    100000X                                                          
FRPTBUFX EQU   *                                                                
         DC    X'0000'                                                          
         EJECT                                                                  
*                                                                               
IPRQFIL  DCB   DDNAME=IPRQFIL,DSORG=PS,RECFM=FB,BLKSIZE=3200,          X        
               LRECL=80,MACRF=PM                                                
*                                                                               
       ++INCLUDE SPREPI2WKN                                                     
         PRINT ON                                                               
       ++INCLUDE DDBUFFD                                                        
         PRINT OFF                                                              
       ++INCLUDE SPREPWORKD                                                     
       ++INCLUDE SPGENAGY                                                       
       ++INCLUDE SPGENCLT                                                       
       ++INCLUDE SPGENPRD                                                       
       ++INCLUDE SPGENEST                                                       
       ++INCLUDE SPGENBUY                                                       
       ++INCLUDE SPGENSTA                                                       
       ++INCLUDE SPGENSTEQ                                                      
       ++INCLUDE SPGENREP                                                       
       ++INCLUDE SPGENADD                                                       
       ++INCLUDE SPGENMKT                                                       
       ++INCLUDE SPGENSNV                                                       
       ++INCLUDE SPTRCMML                                                       
       ++INCLUDE SPREPMODES                                                     
       ++INCLUDE SPMEDBLOCK                                                     
       ++INCLUDE DDMASTD                                                        
       ++INCLUDE FASSB                                                          
       ++INCLUDE SPADINTD                                                       
       ++INCLUDE DDCOMFACSD                                                     
       ++INCLUDE DDCOREQUS                                                      
       ++INCLUDE DDSMTPD                                                        
       ++INCLUDE FALOCKUPD                                                      
LKKEYD   DSECT                                                                  
         ORG   LOCKKEY                                                          
LOCKMED  DS    CL1                                                              
LOCKCLT  DS    CL3                                                              
LOCKSTA  DS    CL5                                                              
*                                                                               
         ORG   LOCKKEY                                                          
LOCKNCLT DS    CL3                                                              
LOCKNNET DS    CL4                                                              
LOCKCLR  DS    CL2                                                              
*                                                                               
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'130SPREPI202 03/04/21'                                      
         END                                                                    
