*          DATA SET EZMOD      AT LEVEL 188 AS OF 12/10/19                      
*CATALP EZMOD                                                                   
         TITLE 'EASI - CENTRAL INVOICE PROCESSING MODULE'                       
*                                                                               
***********************************************************************         
*                                                                     *         
*        THE MODULE IS PASSED THE INDEX OF A WORKER FILE              *         
*        ENTRY CONTAINING AN EASI SYSTEM 'BATCH' - I.E. A             *         
*        SET OF INVOICES FOR THE SAME AGENCY/OFFICE AND               *         
*        STATION.                                                     *         
*                                                                     *         
*        IT SCANS THE BATCH, LOOKS UP                                 *         
*        ADVERTISER, PRODUCT AND COMMERCIAL INFORMATION               *         
*        AND CODES, HANDLES THE DATA FIELDS THAT REQUIRE              *         
*        EDITING AND/OR CONVERSION AND SETS THE DATA IN               *         
*        A FIXED FORMAT IN EZBLOCKD.                                  *         
*                                                                     *         
*        ALL THE DATA IS PRESERVED IN ITS ORIGINAL UNEDITED           *         
*        FORMAT, BUT MANY FIELDS ARE ALSO CONVERTED TO                *         
*        MORE USEFUL, STANDARD FORMATS.                               *         
*                                                                     *         
*        CONTROL IS PASSED TO THE CALLER'S PROCESSING ROUTINE         *         
*        AT EZHOOK. THE MODE SETTINGS INDICATE WHAT LEVEL OF          *         
*        DATA IS TO BE PROCESSED AND WHAT PARTS OF THE                *         
*        DSECT HAVE BEEN FILLED OUT. FOR EXAMPLE, EZSPTP              *         
*        WILL BE PASSED FOR EACH INDIVIDUAL SPOT DETAIL               *         
*        AND DATA AT THE INVOICE, SCHEDULE LINE AND SPOT              *         
*        DETAIL LEVELS WILL BE THERE                                  *         
*                                                                     *         
*        ERRORS ARE RETURNED TO THE CALLER'S ERROR ROUTINE            *         
*        AT EZERRHK (WHICH MAY BE THE SAME AS EZHOOK) WITH            *         
*        THE MODE EZERRP. THE ERROR CODE, LEVEL, RECORD AND           *         
*        FIELD NAME AND ERROR MESSAGE ARE SET.                        *         
*                                                                     *         
***********************************************************************         
*                                                                     *         
*  THIS SHOULD BE LINKED USING LINK BOOKS                             *         
*  LKT23010 FOR ONLINE MODULE, LKSPZ502 FOR OFFLINE                   *         
*                                                                     *         
***********************************************************************         
*                                                                               
***********************************************************************         
*                                                                     *         
* LEV 108   MAY07/03 STATION EQUIVALENCY MEDIA USED FOR GETPROF       *         
*                                                                     *         
* LEV 104   MAR13/02 REP INVOICES AND CALENDAR FLAG                   *         
* LEV 103   FEB25/02 ADD MOVE IN TRAFFIC UTL                          *         
* LEV 102   FEB22/02 ADD TELL MSG FOR EQUAL COMML SEQ #               *         
* LEV 101   SEP04/01 FIX BLANKS IN SOME COMMLS                        *         
* LEV 100   MAY24/01 CK IF SECOND PRODUCT                             *         
* LEV 99    MAY21/01 FIX BAD CML2 & ADD STRIP 1ST CHARACTER FROM CMMLS*         
*                    FOR ACBO IF 9 CHARATER COMML                     *         
* LEV 98    MAY10/01 ALLOW FOR NETS WITH BLANK                        *         
* LEV 97    MAY09/01 FIX NETWORK SEARCH BAD REGISTER                  *         
* LEV 91    APR09/01 IGNORE STA TYP, ONLY CONVERT ABC/CBS/NBC.FOX/WBN *         
*                     UPN TO CALENDAR, ALL ELSE TO BROAD              *         
* LEV 90    FEB23/01 FIX MGRP SORTED I2'S & MSNYA EST CK              *         
* LEV 89    FEB15/01 FIX EMAIL AND ADD H7 VARY MGRP CODES             *         
* LEV 88    FEB07/01 ADD H7 - MINDSHARE TO EST REQUIRED               *         
* LEV 87    JAN29/01 FIX SENDING NOTES                                *         
* LEV 86    JAN12/01 FIX EZTRFTBL, PUT IN SOON CODE                   *         
* LEV 85    SEP08/00 CK TIME ALL NUMERIC                              *         
* LEV 84    JUN30/00 FIX BAD MOS DATE INTO GETBROAD                   *         
* LEV 83    JUN23/00 FIX PASSIVE DISK ADDRESS                         *         
* LEV 82    APR14/00 FIND P/B CMML IF GETTING PRODUCT FROM CMML       *         
* LEV 81    MAR15/00 NEED TO CK EZIHMON BETTER, FIX MONTHLY           *         
*                    FIX FCIH350 PROBLEM WITH X'FA'                   *         
* LEV 80    NOV15/99 ALLOW 2000 DATES                                 *         
* LEV 79    NOV02/99 ALLOW PRD ERRORS IN COMMLS IF EZCMLOPT=I         *         
* LEV 78    SEP09/99 ADD PST CANADIAN TAX AND INTEGRATION CHARGE      *         
*                        EZITPST/EZITBPST     EZSPINT/EZSPBINT        *         
*                    AND ADD CODE FOR NEW TIME PRECEDED BY T          *         
* LEV 77    AUG19/99 SET UP FDMJW(FR) SAME AS JW                      *         
*                    ERROR OUT INVOICE IF BROADCAST MONTH IS BAD      *         
* LEV 76    AUG11/99 FOR NETPAK USE EITHER BROAD/CAL DATES            *         
*                    IF BLANK INVOICE DATE, USE BATCH DATE            *         
* LEV 75    JUL27/99 VALIDATE INVOICE DATE                            *         
* LEV 74    JUL19/99 CHANGE INVOICE PERIOD DATES TO UNIMPORTANT       *         
*                    ADD DATES TO SPOT TRAFFIC COMMERCIAL             *         
* LEV 73    JUN15/99 REJECT BAD DATES, BUT BYPASS UNIMPORTANT ONES    *         
* LEV 72    MAY03/99 REJECT BAD DATES                                 *         
* LEV 71    APR22/99 CK AMTS FOR RIDICULOUS AMOUNTS                   *         
* LEV 70    APR06/99 CK CK 2-6 CMLS. CK EZMCTREQ FOR MID-FLT-CLEAR    *         
* LEV 69    MAR09/99 ALLOW FOR CMMLS WITH 'N-' AS PREFIX              *         
* LEV 68    FEB04/99 FIX ADDED COMML USING TELECASTER KEY             *         
* LEV 67    APR27/98 TAKE OUT EXTRA SE                                *         
* LEV 66    APR20/98 ADD TRAFFIC SE                                   *         
* LEV 65    APR17/98 BYPASS DATE CHECKING FOR JWT                     *         
* LEV 64    APR09/98 SAME RULES FOR JWT AS COKE - REQUIRES EST        *         
* LEV 63    MAR03/98 READ TELECASTER NO NEW PASSIVE PTR FOR COMMLS    *         
* LEV 62    OCT20/97 FIX DUP BAD CLT ERR                              *         
* LEV 61    SEP30/97 ADD FORCE CLIENT CODE IF COKEAT & SOURCE=LIPA    *         
* LEV 60    JUL01/97 FIX COKE - STOP ZERO ESTIMATES                   *         
* LEV 59    JUN26/97 ADD COKE - ALLOW BAD PROD MATCH FOR COMMLS       *         
* LEV 58    JUN20/97 ADD COKE VERIFY ESTIMATE REC AND DATES           *         
* LEV 57    FEB13/97 CLEAR EZIHLADT AND EZIHLPRT FIELDS               *         
* LEV 56    AUG13/96 FIX CATAL EZMOD AND CHANGE EZBLOCK               *         
* LEV 55    MAY18/96 USE BATCH AS INVOICE DATE IF NO INVOICE DATE     *         
* LEV 54    JAN27/95 MORE NWK                                         *         
* LEV 53    AUG12/94 FIX ADDING NOT RUN SPOTS TO TOTALS               *         
* LEV 52    JUL15/94 NWK                                              *         
* LEV 51    MAY19/94 FIX SCHED DATES                                  *         
* LEV 50    MAR15/94 MORE FOR STRAFFIC                                *         
* LEV 49    MAR07/94 FOR EZPROF 4 COMML CONVERSION OPT I CK LEN = 8   *         
* LEV 48    FEB17/94 TAKE OUT TRAF DCB, ADD UTL FIX, EZPROPT          *         
* LEV 47    NOV16/93 PUT ADDED COMMLS TO FILE, TABLE ADDED CODES      *         
* LEV 46    OCT04/93 FIX COMML BAD PRD ERR - COMML SENT TO INVOICE    *         
* LEV 45    AUG16/93 FIX ERROR MSGS                                   *         
* LEV 44    MAY18/93 FORCE ERROR IF SPOT DETAIL SPOT LEN = 0          *         
* LEV 43    APR15/93 FIX BSNY CONSOLODATED CLIENT BUG                 *         
* LEV 42    OCT27/92 FIX CONVERT SPOTS EZITBSPT AND ADD EZITBGST      *         
* LEV 41    OCT16/92 USE TRAFFIC LINKED CLIENT/PRODUCT CODES          *         
* LEV 40    APR01/92 FIX SHOW BAD TIME IF SPOT NOT RUN                *         
* LEV 39    MAR10/92 FIX ADVERTISER NAME OVERRIDE                     *         
* LEV 38    FEB26/92 ALLOW ANY COMMERCIAL PRODUCT FOR PROD POL        *         
* LEV 37    FEB19/92 SET UP FOR PASSED EZCONSE & FIX GETPROF          *         
* LEV 36    JAN10/92 FIX EZIHBEST-PULLED FROM AGENCY WHEN OVERRIDE 0  *         
* LEV 35    DEC05/91 FIX COMML LOOK UP AND OPTIONS, AND PREV MPL OPN  *         
* LEV 34    SEP30/91 FIX EDIT BINARY PRODUCT NOT FOUND                *         
* LEV 33    SEP10/91 FIX EDIT STATION FOR NET                         *         
* LEV 32    MAR18/91 FIX BAD USING SVPLTENT ADDR ONLINE               *         
* LEV 31    FEB22/91 PUT *'S IN FOR NULL TIME                         *         
* LEV 30    JUL25/90 BYPASS ALL MPL FILE ACCESS                       *         
* LEV 29    JUN07/90 FIX DROPPING SPOT PRODS                          *         
* LEV 28    APR26/90 FIX CLEARING STD TOP AND BOT COMMENTS            *         
* LEV 27    JAN30/90 FIX LKCML30 TO LKCML80 & BLK HCMLDATA            *         
* LEV 26    JAN23/90 FORCE EST OVERRIDE                               *         
* LEV 25    JAN03/90 EZCMLOPT OPTNS  A = ADD MISSING CMLS TO TRAF/INV *         
*                                    I = ADD MISSING CML TO INV ONLY  *         
*                                    Y = MUST USE ONLY EXISTING CMLS  *         
*                       (DEFAULT)    N = DON'T USE CMLS AT ALL        *         
* LEV 22-24 NOV17/89 FORCE INV HDR 12 BYTE OVERRIDE CK UTL ADR        *         
* LEV 20-21 NOV16/89 CK BINSRCH ADDR - ALLOW TO RUN ONLINE            *         
* LEV 19    OCT31/89 ADD CASHVAL FOR SALES TAX                        *         
*                                                                     *         
***********************************************************************         
*                                                                               
         PRINT NOGEN                                                            
EZMOD    CSECT                                                                  
         NMOD1 EZMODDL,**EZMOD,RR=R2                                            
         LA    RA,COMSUBS                                                       
         USING COMSUBS,RA                                                       
         USING EZMODD,RC                                                        
         ST    R2,RELO                                                          
         L     R9,0(R1)                                                         
         USING EZBLOCKD,R9                                                      
         ST    RC,SAVWORK          SAVE WORK AREA ADDRESS                       
*EZBREG   EQU   R9                  NAME FOR EZBLOCKD REGISTER                  
EZBREG   EQU   9,,,,GR32                                                        
*                                  SET ADDRESSES                                
         L     R8,EZCOMFCS         A(COMFACS)                                   
         USING COMFACSD,R8                                                      
         MVC   CALLOV,CCALLOV                                                   
         MVC   CASHVAL,CCASHVAL                                                 
         MVC   GETPROF,CGETPROF                                                 
         MVC   ADDAY,CADDAY                                                     
         MVC   GETDAY,CGETDAY                                                   
         MVC   DATVAL,CDATVAL                                                   
         MVC   DATCON,CDATCON                                                   
         MVC   HEXOUT,CHEXOUT                                                   
         MVC   PARSNIP,CPARSNIP                                                 
         MVC   DATAMGR,CDATAMGR                                                 
         MVC   SCANNER,CSCANNER                                                 
         DROP  R8                                                               
*                                                                               
         OC    CASHVAL,CASHVAL     TEST CASHVAL IN COMFACS                      
         BNZ   *+16                                                             
         L     RF,=V(CASHVAL)                                                   
         A     RF,RELO                                                          
         ST    RF,CASHVAL                                                       
*                                                                               
         OC    DATVAL,DATVAL       TEST DATVAL IN COMFACS                       
         BNZ   *+16                                                             
         L     RF,=V(DATVAL)                                                    
         A     RF,RELO                                                          
         ST    RF,DATVAL                                                        
*                                                                               
         OC    CALLOV,CALLOV       TEST HAVE CALL OVERLAY                       
         BZ    EZM8                                                             
*                                                                               
         MVC   DMCB+4(4),=X'D9000A0F'  DAYUNPK                                  
         GOTO1 CALLOV,DMCB,0                                                    
         MVC   DAYUNPK,DMCB                                                     
         MVC   DMCB+4(4),=X'D9000A03'  DAYPAK                                   
         GOTO1 CALLOV,DMCB,0                                                    
         MVC   DAYPAK,DMCB                                                      
         MVC   DMCB+4(4),=X'D9000A14'  CLPACK                                   
         GOTO1 CALLOV,DMCB,0                                                    
         MVC   CLPACK,DMCB                                                      
         MVC   DMCB+4(4),=X'D9000A15'  CLUNPK                                   
         GOTO1 CALLOV,DMCB,0                                                    
         MVC   CLUNPK,DMCB                                                      
         MVC   DMCB+4(4),=X'D9000A0E'  TIMVAL                                   
         GOTO1 CALLOV,DMCB,0                                                    
         MVC   TIMVAL,DMCB                                                      
         MVC   DMCB+4(4),=X'D9000A11'  UNTIME                                   
         GOTO1 CALLOV,DMCB,0                                                    
         MVC   UNTIME,DMCB                                                      
         MVC   DMCB+4(4),=X'D9000AFE'  TRPACK                                   
         GOTO1 CALLOV,DMCB,0                                                    
         MVC   TRPACK,DMCB                                                      
         B     EZM9                                                             
*                                                                               
EZM8     DS    0H                                                               
         L     RF,=V(CLPACK)                                                    
         A     RF,RELO                                                          
         ST    RF,CLPACK                                                        
         L     RF,=V(CLUNPK)                                                    
         A     RF,RELO                                                          
         ST    RF,CLUNPK                                                        
         L     RF,=V(DAYPAK)                                                    
         A     RF,RELO                                                          
         ST    RF,DAYPAK                                                        
         L     RF,=V(DAYUNPK)                                                   
         A     RF,RELO                                                          
         ST    RF,DAYUNPK                                                       
         L     RF,=V(TIMVAL)                                                    
         A     RF,RELO                                                          
         ST    RF,TIMVAL                                                        
         L     RF,=V(UNTIME)                                                    
         A     RF,RELO                                                          
         ST    RF,UNTIME                                                        
*                                                                               
EZM9     DS    0H                  ROUTINES NOT CORE-RESIDENT                   
         L     RF,=V(NUMVAL)                                                    
         A     RF,RELO                                                          
         ST    RF,NUMVAL                                                        
         L     RF,=V(BINSRCH)                                                   
         LTR   RF,RF                                                            
         BZ    *+8                                                              
         A     RF,RELO                                                          
         ST    RF,BINSRCH                                                       
         L     RF,=V(GETBROAD)                                                  
         A     RF,RELO                                                          
         ST    RF,GETBROAD                                                      
*                                                                               
         OC    EZARECTB,EZARECTB   TEST USER SET REC TABLE                      
         BNZ   *+16                                                             
         L     RF,=V(EZRECTAB)                                                  
         A     RF,RELO                                                          
         ST    RF,EZARECTB                                                      
*                                                                               
         L     RF,=A(FLDCVT)                                                    
         A     RF,RELO                                                          
         ST    RF,AFLDCVT                                                       
         L     RF,=A(LKCML)                                                     
         A     RF,RELO                                                          
         ST    RF,ALKCML                                                        
         L     RF,=A(ERRTAB)                                                    
         A     RF,RELO                                                          
         ST    RF,AERRTAB                                                       
*                                                                               
         MVI   PM1,C' '                                                         
         MVI   SPACES,C' '                                                      
         MVC   SPACES+1(L'SPACES-1),SPACES                                      
*                                                                               
         MVC   CALLRD,4(RD)        SAVE BACK NMOD LINK                          
*                                                                               
* NOT USING CLIENT OR PRODUCT LOOK-UP *                                         
*                                                                               
*                                                                               
         XC    WORK,WORK                                                        
         MVI   FDELIM,X'5E'        FIELD DELIM - SEMI-COLON                     
         MVI   RDELIM,X'15'        RECORD DELIM - COLON                         
         MVI   DMIBTS,0           SET DATAMGR CONTROLS                          
         MVI   DMOBTS,X'FF'                                                     
*                                                                               
         CLI   EZWRKIOF,C'Y'                                                    
         BNE   EZM10                                                            
         BRAS  RE,FAKEIND                                                       
         LAY   RF,WRKEZKEY                                                      
         CLC   SVWKRIND(L'WRKEZKEY),0(RF)      TEST SAME INDEX                  
         B     *+10                                                             
EZM10    CLC   EZWKRIND,SVWKRIND   TEST SAME INDEX                              
         BNE   EZM11               NO- CLEAR CONTROLS                           
*                                                                               
* MAX RECORD LENGTH IS 472 FOR NOW                                              
*                                                                               
         CLC   RFCURPOS,=F'472'                                                 
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OC    RFCURPOS,RFCURPOS   YES-TEST A CONTINUATION                      
         BNZ   EZM20               YES- SKIP SOME INITIALIZATION                
*                                                                               
EZM11    DS    0H                  SET BATCH DATA                               
         CLI   EZWRKIOF,C'Y'                                                    
         BNE   EZM12                                                            
         LAY   RF,WRKEZKEY                                                      
         MVC   SVWKRIND(L'WRKEZKEY),0(RF)                                       
         B     *+10                                                             
EZM12    MVC   SVWKRIND,EZWKRIND                                                
*                                                                               
         LA    RF,EZWKRIND                                                      
         USING EZWKRIXD,RF                                                      
         MVC   EZBTSTN(4),EZWISTN  STATION                                      
         MVI   EZBTSTN+4,C'-'                                                   
         MVC   EZBTSTN+5(1),EZWIMED                                             
         MVI   EZBTSTN+6,C' '                                                   
         CLI   EZWIMED,C'T'                                                     
         BNE   *+8                                                              
         MVI   EZBTSTN+6,C'V'                                                   
         CLI   EZWIMED,C'R'                                                     
         BNE   *+8                                                              
         MVI   EZBTSTN+6,C'M'                                                   
         DROP  RF                                                               
*                                                                               
*        L     RF,EZWKRBUF         64 BYTE REC 0 IN BUFFER                      
         LA    RF,EZWKRIND                                                      
         USING W_RECD,RF                                                        
*        MVC   EZBTBRTM,W_AGERT TIME                                            
         GOTO1 DATCON,DMCB,(2,W_AGELD),(3,EZBTBRDT)   RECEIVED DATE             
         DROP  RF                                                               
*                                                                               
         MVI   RFFLDNO,0                                                        
         MVI   RFCNTL,0                                                         
         MVI   RFCNTL2,0                                                        
         MVC   RECSWS,SPACES                                                    
*                                                                               
         L     RF,EZWKRREC                                                      
         LA    RE,4                                                             
         ST    RE,RFCURPOS         SET STARTING POS IN FIRST REC                
         LH    RE,0(RF)                                                         
         ST    RE,ENDWFREC         SET EOR                                      
         BAS   RE,TRCWKR           TRACE WORKER FILE RECORDS                    
*                                                                               
         LA    R6,EZWKRIND         SET STATION FOR WKR FILE KEY                 
         USING EZWKRIXD,R6                                                      
         MVC   WFSTATN(4),EZWISTN  STATION                                      
         MVC   WFSTATN+4(1),EZWIMED  MEDIA                                      
         DROP  R6                                                               
*                                                                               
         XC    SADVDATA,SADVDATA   CLEAR SAVES                                  
         XC    SPRDDATA,SPRDDATA                                                
         XC    SCMLINFO,SCMLINFO                                                
         MVI   SVLKSTAT,0                                                       
         MVI   SVADVERR,0                                                       
*                                                                               
         L     R1,EZPRTAB                                                       
         SR    R2,R2                                                            
         LHI   R3,PRTABDLQ                                                      
         LHI   R4,PRKEYLQ                                                       
         SR    RE,RE               CALCULATE MAX ENTRIES                        
         LH    RF,EZPRTABL         = TABLE LENGTH                               
         LHI   R0,PRTABDLQ                                                      
         DR    RE,R0                / ENTRY LENGTH                              
         LR    R5,RF                                                            
         SR    R0,R0               SET BINSRCH PARS FOR PRODUCT TABLE           
         STM   R0,R5,BSPPARS                                                    
*                                                                               
         SR    R0,R0               SET BINSRCH PARS FOR CMML TABLE              
         L     R1,EZCMTAB                                                       
         SR    R2,R2                                                            
         LA    R3,CMTABDL                                                       
         LA    R4,CMKEYL                                                        
         SR    RE,RE               CALCULATE MAX ENTRIES                        
         LH    RF,EZCMTABL         = TABLE LENGTH                               
         D     RE,=A(CMTABDL)      / ENTRY LENGTH                               
         LR    R5,RF                                                            
         STM   R0,R5,BSCPARS                                                    
*                                                                               
         XC    EZRECSEQ,EZRECSEQ   RESET REC COUNT                              
         XC    EZINVSEQ,EZINVSEQ   AND INVOICE COUNT                            
         MVI   EZRNFRPT,C'N'       CLEAR REPEAT SW                              
*                                                                               
EZM20    DS    0H                                                               
         BAS   RE,GETFLD                                                        
         BAS   RE,TRCRET           TRACE RETURNS                                
*                                                                               
         TM    RFCNTL,X'80'        TEST EOFILE                                  
         BNZ   EZM70                                                            
*                                                                               
         TM    RFCNTL,X'40'        TEST END OF A RECORD                         
         BZ    EZM24                                                            
         LH    RF,EZRECSEQ         BUMP RECORD COUNT                            
         LA    RF,1(RF)                                                         
         STH   RF,EZRECSEQ                                                      
         CLI   BADRCD,C'Y'         YES- TEST VALID RECORD TYPE                  
         BE    EZM20                                                            
         CLI   SKIPSW,C'Y'         TEST SKIPPING OVER INVOICE                   
         BE    EZM20                                                            
         GOTO1 AFLDCVT             YES-DO FIELD CONVERTS AND LOOKUPS            
*        BAS   RE,SETPROC          SET PROC MODES                               
         BRAS  RE,SETPROC          SET PROC MODES                               
         B     EZM20               NEXT FIELD                                   
*                                                                               
*                                  HANDLE FIELD                                 
*                                  ------------                                 
*                                                                               
EZM24    DS    0H                                                               
         CLI   RFFLDNO,1           FLD 1 IS RECORD TYPE                         
         BNE   EZM30                                                            
*                                                                               
         BAS   RE,SETRECQ          SET INTERNAL RECORD CODE                     
         BAS   RE,SETLAST          SET LAST MODES                               
         BAS   RE,CLRFLDS          CLEAR APPROPRIATE FIELDS                     
         B     EZM20                                                            
*                                                                               
EZM30    DS    0H                                                               
         CLI   SKIPSW,C'Y'         IF BYPASSING INVOICE                         
         BE    EZM20               SKIP FIELD                                   
         CLI   BADRCD,C'Y'         TEST HAVE VALID RECORD TYPE                  
         BE    EZM20                                                            
         BAS   RE,PROCFLD          PROCESS A REAL FIELD                         
         B     EZM20                                                            
*                                                                               
EZM70    DS    0H                  EOFILE                                       
         BAS   RE,SETSEQ           SET CMML SEQ FOR LAST ADV                    
         MVI   RECTYPE,X'FF'                                                    
         BAS   RE,SETLAST          SET LAST MODES                               
*                                                                               
         XC    RFCURPOS,RFCURPOS                                                
*                                                                               
EQXIT    CR    RB,RB                                                            
         J     EXIT                                                             
NEQXIT   LTR   RB,RB                                                            
EXIT     XIT1                                                                   
*                                                                               
*        GETFLD- RETURN A SINGLE FIELD                                          
*                                                                               
GETFLD   NTR1                                                                   
         XC    RFDATA,RFDATA                                                    
         MVI   RFLEN,0                                                          
*                                                                               
         TM    RFCNTL2,X'01'       TEST NEED TO SEND EOR                        
         BZ    GETF10                                                           
         NI    RFCNTL2,X'FE'                                                    
         OI    RFCNTL,X'40'        SET EOR                                      
         B     GETFX               RETURN                                       
*                                                                               
GETF10   DS    0H                                                               
         TM    RFCNTL2,X'02'       TEST NEED TO SEND END OF FILE                
         BZ    GETF14                                                           
         NI    RFCNTL2,X'FD'                                                    
         OI    RFCNTL,X'80'        SET END OF FILE                              
         B     GETFX               RETURN                                       
*                                                                               
GETF14   DS    0H                                                               
         TM    RFCNTL,X'40'        AFTER EOR                                    
         BZ    *+8                                                              
         MVI   RFFLDNO,0           RESET FIELD NUMBER                           
*                                                                               
         TM    RFCNTL2,X'04'       TEST NEED NEW WKF REC                        
         BNZ   GETF60              YES- GET IT                                  
*                                                                               
GETF16   DS    0H                                                               
         L     R3,RFCURPOS                                                      
*                                                                               
         CLC   RFCURPOS,=F'472'                                                 
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         A     R3,EZWKRREC                                                      
         SR    R2,R2               BYTE COUNTER                                 
*                                                                               
GETF20   DS    0H                                                               
         L     RF,EZWKRREC GET END OF REC                                       
         A     RF,ENDWFREC         RELOCATE                                     
         CR    R3,RF               TEST AT END OF PHYS REC                      
         BL    GETF26                                                           
*                                  YES                                          
         LTR   R2,R2               ANY FIELD TO HANDLE                          
         BZ    GETF24                                                           
         OI    RFCNTL2,X'05'       YES- SET DO EOR AND NEED NEW REC             
         B     GETF44              AND RETURN THIS FIELD                        
*                                                                               
GETF24   DS    0H                  NO FIELD TO HANDLE                           
         CLI   RFFLDNO,0           HAVE THERE BEEN ANY FLDS                     
         BE    GETF60              NO- JUST GET NEW RECORD                      
*                                                                               
         TM    RFCNTL,X'40'        TEST HAVE DONE EOR                           
         BNZ   GETF60              YES - JUST GET NEW RECORD                    
*                                                                               
         OI    RFCNTL,X'40'        SEND EOR NOW                                 
         OI    RFCNTL2,X'04'       AND SET TO GET NEW REC                       
         B     GETFX                                                            
*                                                                               
GETF26   DS    0H                                                               
         CLC   RDELIM,0(R3)           TEST HAVE RECORD DELIM                    
         BNE   GETF30                                                           
*                                                                               
         LA    R3,L'RDELIM(R3)      BUMP PAST RECORD DELIMITER                  
*        ST    R3,RFCURPOS                                                      
         LR    RF,R3                                                            
         S     RF,EZWKRREC                                                      
         ST    RF,RFCURPOS         SET RELOCATBLE VALUE                         
*                                                                               
         LTR   R2,R2               TEST HAVE FIELD TO HANDLE                    
         BZ    GETF28                                                           
*                                                                               
         OI    RFCNTL2,X'01'       SET TO DO EOR LATER                          
         B     GETF44              RETURN FIELD                                 
*                                                                               
GETF28   DS    0H                  NO FIELD TO HANDLE                           
         CLI   RFFLDNO,0           HAVE THERE BEEN ANY FLDS                     
         BE    GETF20              NO- IGNORE                                   
*                                                                               
         OI    RFCNTL,X'40'        SEND EOR                                     
         B     GETFX                                                            
*                                                                               
GETF30   DS    0H                                                               
         CLC   FDELIM,0(R3)           TEST HAVE FIELD DELIM                     
         BE    GETF40                                                           
*                                  NO DELIMITER, CONTINUE                       
*                                                                               
* SPECIAL CODE FOR OVERRIDE CODES FIELD IN '31' INVOICE HEADER *                
*                                                                               
         CLI   RECTYPE,EZIHEQ      THIS AN INVOICE HEADER                       
         BNE   GETF34                                                           
         CLI   RFFLDNO,1           JUST DO FIELD 1                              
*        BNE   GETF34                                                           
         BNE   GETF33                                                           
*                                                                               
         LA    R2,12               SET LENGTH                                   
         LR    R4,R3               SET START OF FIELD                           
*                                                                               
         LA    R3,12+L'FDELIM(,R3)                                              
         LR    RF,R3                                                            
         S     RF,EZWKRREC                                                      
         ST    RF,RFCURPOS         SET RELOCATBLE VALUE                         
         B     GETF54                                                           
*                                                                               
GETF33   DS    0H                                                               
         CLI   RFFLDNO,36                                                       
         BNE   GETF34                                                           
*                                                                               
         LA    R2,12               SET LENGTH                                   
         LR    R4,R3               SET START OF FIELD                           
*                                                                               
         LA    R3,12+L'FDELIM(,R3)                                              
         LR    RF,R3                                                            
         S     RF,EZWKRREC                                                      
         ST    RF,RFCURPOS         SET RELOCATBLE VALUE                         
         B     GETF54                                                           
*                                                                               
GETF34   DS    0H                                                               
         LTR   R2,R2               IF HAVE NO DATA YET                          
         BP    GETF36                                                           
         CLI   0(R3),C' '          IGNORE LEADING BLANKS                        
         BNH   GETF38                                                           
         LR    R4,R3               SAVE A(FIRST NON-BLANK)                      
*                                                                               
GETF36   DS    0H                                                               
         LA    R2,1(R2)            BUMP FIELD LENGTH                            
GETF38   DS    0H                                                               
         LA    R3,1(R3)            NEXT POS                                     
         B     GETF20                                                           
*                                                                               
GETF40   DS    0H                                                               
         LA    R3,L'FDELIM(R3)      BUMP PAST FIELD DELIM                       
         LR    RF,R3                                                            
         S     RF,EZWKRREC                                                      
         ST    RF,RFCURPOS         SET RELOCATBLE VALUE                         
*                                                                               
GETF44   DS    0H                                                               
         LTR   R2,R2                                                            
         BNP   GETF54                                                           
*                                  STRIP TRAILING BLANKS                        
         LA    R5,0(R2,R4)                                                      
         BCTR  R5,R0               R5 AT LAST BYTE                              
*                                                                               
GETF46   DS    0H                                                               
         CLI   0(R5),C' '                                                       
         BH    GETF50                                                           
         BCTR  R2,R0               DECR LENGTH                                  
         BCT   R5,GETF46           PREVIOUS BYTE                                
*                                                                               
GETF50   DS    0H                                                               
         CH    R2,=H'255'                                                       
         BNH   GETF54                                                           
         OI    RFCNTL,X'20'        SET FIELD ERROR                              
         LA    R2,255                                                           
*                                                                               
GETF54   DS    0H                                                               
         NI    RFCNTL,X'3F'        CLEAR END CONTROLS                           
         ZIC   RF,RFFLDNO          BUMP FIELD NUMBER                            
         LA    RF,1(RF)                                                         
         STC   RF,RFFLDNO                                                       
         STC   R2,RFLEN            SET FIELD LENGTH                             
*                                                                               
         CLI   RECTYPE,EZSPEQ      BROADCAST DETAIL?                            
         BNE   GETF55                                                           
         CLI   RFFLDNO,25          NET INTEGRATION COST?                        
         BNE   GETF55                                                           
*                                                                               
* 04/26/2013 - H7 AND FR DON'T WANT THEIR INVOICES MARKED "INT-ONLY"            
* IF INTEGRATION COST FIELD IS POPULATED BY ZEROES                              
*                                                                               
         CLC   EZAGY,=AL2(AGYALPH_H7)                                           
         BE    GETF55                                                           
         CLC   EZAGY,=AL2(AGYALPH_FR)                                           
         BE    GETF55                                                           
*                                                                               
         LTR   R2,R2               ANYTHING THERE?                              
         BZ    GETF55              NO                                           
         OI    EZIHFLG,EZIHIPQ     TURN ON INTEGRATION CHARGE FLAG              
*                                                                               
GETF55   DS    0H                                                               
         LTR   R2,R2                                                            
         BNP   GETF56                                                           
         BCTR  R2,R0                                                            
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   RFDATA(0),0(R4)                                                  
*                                                                               
GETF56   DS    0H                                                               
         B     GETFX                                                            
*                                                                               
GETF60   DS    0H                  GET NEXT WKF RECORD                          
         NI    RFCNTL2,X'FB'       SET OFF NEED REC SWITCH                      
*                                                                               
         CLI   EZWRKIOF,C'Y'                                                    
         BNE   GETF61                                                           
*                                                                               
         LAY   R6,EZWRKIOB                                                      
         USING WRKIOB,R6                                                        
*                                                                               
         MVI   WRKIACTN,WRKIAGET                                                
         GOTO1 EZWRKIO,(R6)                                                     
         CLI   WRKIERRS,WRKIEEOF                                                
         BE    GETF64                                                           
         CLI   WRKIERRS,0                                                       
         BE    GETF62                                                           
         DC    H'0'                                                             
         DROP  R6                                                               
*                                                                               
GETF61   GOTO1 DATAMGR,DMCB,=C'READ',EZWKRFIL,EZWKRIND,EZWKRREC,       X        
               EZWKRBUF                                                         
*                                                                               
         TM    DMCB+8,X'80'        TEST EOF                                     
         BNZ   GETF64                                                           
         CLI   DMCB+8,0            OTHER ERROR                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
GETF62   DS    0H                                                               
         L     RF,EZWKRREC         SET STARTING POS                             
         CLI   0(RF),X'FF'         TEST AT LAST RECORD                          
         BE    GETF64                                                           
         LA    RE,4                                                             
         ST    RE,RFCURPOS                                                      
         LH    RE,0(RF)            GET EOR                                      
         ST    RE,ENDWFREC                                                      
         BAS   RE,TRCWKR           TRACE WORKER FILE RECORD                     
         B     GETF16                                                           
*                                                                               
GETF64   DS    0H                  END OF FILE                                  
         TM    RFCNTL,X'40'        TEST HAVE SENT EOR                           
         BNZ   GETF66                                                           
         OI    RFCNTL,X'40'        SET EOR NOW                                  
         OI    RFCNTL2,X'02'       AND DO EOFILE AFTER                          
         B     GETFX                                                            
*                                                                               
GETF66   DS    0H                                                               
         OI    RFCNTL,X'80'        SET EOFILE                                   
*                                                                               
GETFX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        CLRFLDS - CLEAR APPROPRIATE FIELDS AT NEW RECORD                       
*                                                                               
CLRFLDS  NTR1                                                                   
         CLI   RECTYPE,EZSNEQ      STATION                                      
         BE    CLF20                                                            
         CLI   RECTYPE,EZPYEQ      PAYEE                                        
         BE    CLF24                                                            
         CLI   RECTYPE,EZIDBQ      IM 76 RECORD                                 
         BE    CLF26                                                            
         CLI   RECTYPE,EZAGEQ      AGENCY                                       
         BE    CLF30                                                            
         CLI   RECTYPE,EZSTEQ      STANDARD COMMENT TOP                         
         BE    CLF50                                                            
         CLI   RECTYPE,EZSBEQ      STANDARD COMMENT BOTTOM                      
         BE    CLF60                                                            
         CLI   RECTYPE,EZIHEQ      INVOICE                                      
         BNE   CLF10                                                            
*                                                                               
         LH    RF,EZINVSEQ         BUMP INVOICE COUNT                           
         LA    RF,1(RF)                                                         
         STH   RF,EZINVSEQ                                                      
         LH    RF,EZRECSEQ         BUMP RECORD COUNT                            
         LA    RF,1(RF)                                                         
         STH   RF,EZHDRSEQ         SAVE INV HDR SEQ #                           
         B     CLF34                                                            
*                                                                               
CLF10    DS    0H                                                               
         CLI   SKIPSW,C'Y'         IF BYPASSING INVOICE                         
         BE    CLFX                SKIP LOWER LEVELS                            
         CLI   RECTYPE,EZSLEQ      SCHEDULE LINE                                
         BE    CLF40                                                            
         CLI   RECTYPE,EZSPEQ      SPOT DETAIL                                  
         BE    CLF44                                                            
         CLI   RECTYPE,EZRREQ      RECONCILIATION                               
         BE    CLF46                                                            
         B     CLFX                                                             
*                                                                               
CLF20    XC    EZSNFRST(EZSNDLEN),EZSNFRST             STATION                  
         B     CLF32                                                            
*                                                                               
CLF24    XC    EZPYFRST(EZPYDLEN),EZPYFRST             PAYEE                    
         B     CLF34                                                            
*                                                                               
CLF26    DS    0H                                                               
         LA    R1,EZBLOCKD                                                      
         AHI   R1,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,R1                                                        
         XC    EZIMFRST(EZIMLEN),EZIMFRST              IM 76 RECORD             
         DROP  R1                                                               
         B     CLFX                                                             
*                                                                               
CLF30    XC    EZAGFRST(EZAGDLEN),EZAGFRST             AGENCY                   
         CLI   RECTYPSV,EZIDBQ     AGY PRECEDED BY 76?                          
         BE    CLF32               YES - DON'T CLEAR IDB RECORD                 
         LA    R1,EZBLOCKD                                                      
         AHI   R1,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,R1                                                        
         XC    EZIMFRST(EZIMLEN),EZIMFRST              IM 76 RECORD             
         DROP  R1                                                               
*                                                                               
* CLEAR TOP AND BOTTOM COMMENTS FOR STATION AND AGENCY *                        
*                                                                               
CLF32    DS    0H                                                               
*                                                                               
CLF34    LA    RE,EZIHFRST                             INVOICE                  
         LA    RF,EZIHDLEN                                                      
         XCEFL                                                                  
*                                                                               
         XC    EZIHEXT(EZIHEXTL),EZIHEXT                                        
         LA    RE,EZBLOCKD                                                      
         AHI   RE,EZIHEX2-EZBLOCKD                                              
         LA    RF,EZIHEX2L                                                      
         XCEFL                                                                  
*                                                                               
         LA    R1,EZBLOCKD                                                      
         AHI   R1,EZIHPTTS-EZBLOCKD                                             
         LHI   R0,EZIHPTNQ                                                      
         ZAP   0(8,R1),=P'0'                                                    
         LA    R1,8(R1)                                                         
         BCT   R0,*-10                                                          
*                                                                               
         MVI   SCTOPSW,C'Y'        SET HAVE HAD INVOICE SINCE                   
         MVI   SCBOTSW,C'Y'        LAST STANDARD COMMENTS                       
         XC    EZICFRST(EZICDLEN),EZICFRST             INV CMNT TOP             
         XC    EZIBFRST(EZIBDLEN),EZIBFRST             INV CMNT BOTTOM          
         XC    EZITFRST(EZITDLEN),EZITFRST             INV TOTALS               
*                                                                               
         LA    R1,EZBLOCKD                                                      
         AHI   R1,EZITPSCH-EZBLOCKD                                             
         LHI   R0,11                                                            
         ZAP   0(8,R1),=P'0'                                                    
         LA    R1,8(R1)                                                         
         BCT   R0,*-10                                                          
*                                                                               
         MVI   SKIPSW,C'N'                             RESET SKIP SW            
*                                                                               
CLF40    XC    EZSLFRST(EZSLDLEN),EZSLFRST             LINE                     
*                                                                               
CLF44    XC    EZSPFRST(256),EZSPFRST                  SPOT DETAIL              
         XC    EZSPFRST+256(EZSPDLEN-256),EZSPFRST+256                          
*                                                                               
         LAY   RE,EZSPXTNT                                                      
         XC    0(EZSPXLQ,RE),0(RE)       DETAIL EXTENTION                       
*                                                                               
CLF46    XC    EZRRFRST(EZRRDLEN),EZRRFRST             RECON                    
         B     CLFX                                                             
*                                                                               
CLF50    DS    0H                  TOP STANDARD CMMNTS                          
         CLI   SCTOPSW,C'Y'        TEST HAVE HAD INVOICE SINCE LAST             
         BNE   CLFX                                                             
         MVI   SCTOPSW,C'N'                                                     
         LA    RE,EZSTFRST         CLEAR TOP STANDARD CMMNTS                    
         LA    RF,EZSTDLEN                                                      
         XCEFL                                                                  
         XC    SCTOPPTR,SCTOPPTR   RESET LINE POINTER                           
         B     CLFX                                                             
*                                                                               
CLF60    DS    0H                  BOTTOM STANDARD CMMNTS                       
         CLI   SCBOTSW,C'Y'        TEST HAVE HAD INVOICE SINCE LAST             
         BNE   CLFX                                                             
         MVI   SCBOTSW,C'N'                                                     
         LA    RE,EZSBFRST         CLEAR BOTTOM STANDARD CMMNTS                 
         LA    RF,EZSBDLEN                                                      
         XCEFL                                                                  
         XC    SCBOTPTR,SCBOTPTR   RESET LINE POINTER                           
         B     CLFX                                                             
*                                                                               
CLFX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        SETRECQ - SET INTERNAL 1-BYTE RECORD CODE                              
*                                                                               
SETRECQ  NTR1                                                                   
         MVC   RECTYPSV,RECTYPE                                                 
         MVI   RECTYPE,C' '                                                     
         CLI   RFLEN,2             LENGTH MUST BE 2                             
         BNE   SRQ90                                                            
*                                                                               
         L     R4,EZARECTB         TABLE OF RECORDS                             
         USING EZRDD,R4                                                         
*                                                                               
SRQ2     DS    0H                                                               
         CLI   EZRDRCD,X'FF'       EOL                                          
         BE    SRQ90                                                            
         CLC   EZRDRCD,RFDATA                                                   
         BE    SRQ4                                                             
         LA    R4,EZRDDL(R4)       NEXT ENTRY                                   
         B     SRQ2                                                             
*                                                                               
SRQ4     DS    0H                                                               
         MVI   FLDHDR,0                                                         
         MVC   FLDHDR+1(3),EZRDFRST    SET FIRST FIELD ADDRESS                  
         L     RF,FLDHDR               MUST RELOCATE                            
         A     RF,RELO                                                          
         ST    RF,FLDHDR                                                        
         MVC   FLDFRST,FLDHDR          SAVE FIRST FIELD                         
         MVC   RECTYPE,EZRDRCQ         SET INTERNAL REC CODE                    
         MVI   BADRCD,C'N'                                                      
         B     SRQX                                                             
*                                                                               
SRQ90    DS    0H                                                               
         MVI   BADRCD,C'Y'         SET BAD RECORD CODE                          
         MVI   EZERRCD,EZERRRTP                                                 
         SR    R2,R2               SET NO FIELD ADDR                            
         BAS   RE,SETERR                                                        
*                                                                               
SRQX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        SETLAST - SET LAST MODES FOR CALLER                                    
*                  (SET AT NEW REC)                                             
*                                                                               
SETLAST  NTR1                                                                   
         CLI   RECTYPE,EZSNEQ      STATION RECORD                               
         BE    SETL4                                                            
         CLI   RECTYPE,EZPYEQ      PAYEE RECORD                                 
         BE    SETL4                                                            
         CLI   RECTYPE,EZAGEQ      AGENCY RECORD                                
         BE    SETL4                                                            
         CLI   RECTYPE,X'FF'       END OF FILE                                  
         BNE   SETL20                                                           
*                                                                               
SETL4    DS    0H                                                               
         CLI   SPRSW,C'Y'          TEST HAVE HAD SPOT                           
         BNE   SETL6                                                            
         MVI   SPRSW,C'N'          SET OFF                                      
         MVI   EZMODE,EZSPTL       LAST FOR SPOT                                
         BAS   RE,HOOK                                                          
*                                                                               
SETL6    DS    0H                                                               
         CLI   SLRSW,C'Y'          TEST HAVE HAD SCHEDULE                       
         BNE   SETL8                                                            
         MVI   SLRSW,C'N'          SET OFF                                      
         MVI   EZMODE,EZSCHL       LAST FOR LINE                                
         BAS   RE,HOOK                                                          
*                                                                               
SETL8    DS    0H                                                               
         CLI   IHRSW,C'Y'          TEST HAVE HAD INVOICE                        
         BNE   SETL10                                                           
*                                                                               
         OC    EZIHTSPN,EZIHTSPN   ANY SPOTS IN THIS INVOICE?                   
         BNZ   *+8                 YES                                          
         NI    EZIHFLG,X'FF'-EZIHINTQ    NO - TURN OFF INT-ONLY FLAG            
*                                                                               
         MVI   IHRSW,C'N'          SET OFF                                      
         MVI   EZMODE,EZINVL       LAST FOR INVOICE                             
         BAS   RE,HOOK                                                          
*                                                                               
SETL10   DS    0H                                                               
         CLI   RECTYPE,X'FF'       IF AT END OF FILE                            
         BNE   SETLX                                                            
         MVI   EZMODE,EZBATL       LAST FOR BATCH                               
         BAS   RE,HOOK                                                          
         B     SETLX                                                            
*                                                                               
SETL20   DS    0H                                                               
         CLI   RECTYPE,EZIHEQ      HAVE NEW INVOICE                             
         BNE   SETL40                                                           
*                                                                               
         CLI   SPRSW,C'Y'          TEST HAVE HAD SPOT                           
         BNE   SETL26                                                           
         MVI   SPRSW,C'N'          SET OFF                                      
         MVI   EZMODE,EZSPTL       LAST FOR SPOT                                
         BAS   RE,HOOK                                                          
*                                                                               
SETL26   DS    0H                                                               
         CLI   SLRSW,C'Y'          TEST HAVE HAD SCHEDULE LINE                  
         BNE   SETL28                                                           
         MVI   SLRSW,C'N'          SET OFF                                      
         MVI   EZMODE,EZSCHL       LAST FOR LINE                                
         BAS   RE,HOOK                                                          
*                                                                               
SETL28   DS    0H                                                               
         CLI   IHRSW,C'Y'          TEST HAVE HAD INVOICE                        
         BNE   SETL30                                                           
*                                                                               
         OC    EZIHTSPN,EZIHTSPN   ANY SPOTS IN THIS INVOICE?                   
         BNZ   *+8                 YES                                          
         NI    EZIHFLG,X'FF'-EZIHINTQ    NO - TURN OFF INT-ONLY FLAG            
*                                                                               
         MVI   EZMODE,EZINVL       LAST FOR INVOICE                             
         BAS   RE,HOOK                                                          
*                                                                               
SETL30   DS    0H                                                               
         MVI   IHRSW,C'Y'          SET HAVE INVOICE                             
         B     SETLX                                                            
*                                                                               
SETL40   DS    0H                                                               
         CLI   RECTYPE,EZSLEQ      HAVE NEW SCHEDULE LINE                       
         BE    SETL40B                                                          
         CLI   RECTYPE,EZIBEQ      OR INVOICE COMMENT (BOTTOM)                  
         BE    SETL40B                                                          
         CLI   RECTYPE,EZSCEQ      OR SCHEDULE COMMENT                          
         BNE   SETL60                                                           
*                                                                               
SETL40B  DS    0H                                                               
         CLI   SPRSW,C'Y'          TEST HAVE HAD SPOT                           
         BNE   SETL46                                                           
         MVI   SPRSW,C'N'          SET OFF                                      
         MVI   EZMODE,EZSPTL       LAST FOR SPOT                                
         BAS   RE,HOOK                                                          
*                                                                               
SETL46   DS    0H                                                               
         CLI   SLRSW,C'Y'          TEST HAVE HAD SCHEDULE LINE                  
         BNE   SETL48                                                           
         MVI   EZMODE,EZSCHL       LAST FOR LINE                                
         BAS   RE,HOOK                                                          
*                                                                               
SETL48   DS    0H                                                               
         CLI   RECTYPE,EZSLEQ                                                   
         BNE   *+8                                                              
         MVI   SLRSW,C'Y'          SET HAV SCHEDULE LINE                        
         B     SETLX                                                            
*                                                                               
SETL60   DS    0H                                                               
         CLI   RECTYPE,EZSPEQ      HAVE SPOT                                    
         BNE   SETLX                                                            
*                                                                               
         CLI   SPRSW,C'Y'          TEST HAVE HAD SPOT                           
         BNE   SETL66                                                           
         MVI   EZMODE,EZSPTL       LAST FOR SPOT                                
         BAS   RE,HOOK                                                          
*                                                                               
SETL66   DS    0H                                                               
         MVI   SPRSW,C'Y'          SET HAVE SPOT                                
*                                                                               
SETLX    XIT1                                                                   
*                                                                               
*        PROCFLD - PROCESS A FIELD                                              
*                                                                               
PROCFLD  NTR1                                                                   
         L     R4,FLDHDR                                                        
         USING EZFDD,R4                                                         
*                                                                               
         CLI   EZFDD,X'00'         TEST UNUSED FIELD                            
         BE    PRF6                YES - SKIP IT                                
*                                                                               
         CLI   EZFDD,X'FF'         TEST EXCESS FIELD                            
         BE    PRFX                YES - IGNORE                                 
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,EZFDDSP        DISP INTO EZBLOCK                            
         LA    RF,EZBLOCKD(RF)     POINT TO FIELD SPACE                         
*                                                                               
         CLI   RECTYPE,EZSTEQ      TEST HAVE TOP STANDARD CMMNT                 
         BNE   PRF4                                                             
         LH    RE,SCTOPPTR         ADD LINE POINTER                             
         CH    RE,=Y(EZSTDLEN)     TEST TOO MANY                                
         BL    PRF3                                                             
*                                                                               
PRF2     DS    0H                                                               
         MVI   EZERRCD,EZERRSCO    STANDARD COMMENT OVERFLOW                    
         SR    R2,R2               SET NO FIELD ADDR                            
         BAS   RE,SETERR                                                        
         B     PRF6                                                             
*                                                                               
PRF3     DS    0H                                                               
         AR    RF,RE                                                            
         LA    RE,L'EZSTCOM(RE)    BUMP LINE POINTER                            
         STH   RE,SCTOPPTR                                                      
         B     PRF5                                                             
*                                                                               
PRF4     DS    0H                                                               
         CLI   RECTYPE,EZSBEQ      TEST HAVE BOTTOM STANDARD CMMNT              
         BNE   PRF5                                                             
         LH    RE,SCBOTPTR         ADD LINE POINTER                             
         CH    RE,=Y(EZSBDLEN)     TEST TOO MANY                                
         BNL   PRF2                                                             
         AR    RF,RE                                                            
         LA    RE,L'EZSBCOM(RE)    BUMP LINE POINTER                            
         STH   RE,SCBOTPTR                                                      
*                                                                               
PRF5     DS    0H                                                               
         ZIC   R1,EZFDLEN          CLEAR FIELD                                  
         BCTR  R1,R0                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         XC    0(0,RF),0(RF)                                                    
*                                                                               
         CLI   RFLEN,0             TEST ANY DATA                                
         BE    PRF6                NO - SKIP MOVE                               
*                                                                               
         IC    R1,RFLEN            USE DATA LENGTH                              
         CLC   RFLEN,EZFDLEN       UNLESS TOO LONG                              
         BNH   *+8                                                              
         IC    R1,EZFDLEN          THEN USE FIELD LENGTH                        
*                                                                               
         BCTR  R1,R0                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),RFDATA                                                   
*                                                                               
         CLC   RFLEN,EZFDLEN       TEST FIELD TOO LONG                          
         BNH   PRF6                                                             
         SR    R2,R2                                                            
         ICM   R2,3,EZFDDSP       SET R2 TO FIELD FOR ERROR ROUT                
         AR    R2,EZBREG                                                        
         MVI   EZERRCD,EZERRFLN                                                 
         BAS   RE,SETERR                                                        
*                                                                               
PRF6     DS    0H                                                               
         LA    R4,EZFDDL(R4)       BUMP TO NEXT FIELD HEADER                    
         ST    R4,FLDHDR                                                        
*                                                                               
PRFX     DS    0H                                                               
         XIT1                                                                   
         DROP  RB,R4                                                            
*                                                                               
         LTORG                                                                  
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
*        COMSUBS - CODE AND DATA ADDRESSABLE FROM ALL CSECTS                    
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
*                                                                               
COMSUBS  DS    0H                                                               
*                                  COMMON DATA                                  
GETREC   DC    CL8'GETREC'                                                      
PUTREC   DC    CL8'PUTREC'                                                      
ADDREC   DC    CL8'ADDREC'                                                      
DMREAD   DC    CL8'DMREAD'                                                      
DMADD    DC    CL8'DMADD'                                                       
DMWRT    DC    CL8'DMWRT'                                                       
DMRDHI   DC    CL8'DMRDHI'                                                      
DMRSEQ   DC    CL8'DMRSEQ'                                                      
*                                                                               
SPTDIR   DC    CL8'SPTDIR'                                                      
SPTFIL   DC    CL8'SPTFIL'                                                      
*                                                                               
*        TSTANY - TEST ANYTHING IN FIELD AT R2                                  
*                  CC NON-ZERO = MEANS ERROR                                    
*                                                                               
TSTANY   DS    0H                                                               
         CLI   0(R2),C' '                                                       
         BNH   TSTANY4                                                          
*                                                                               
         CR    RE,RE               HAVE DATA- RETURN CC =                       
         BR    RE                                                               
*                                                                               
TSTANY4  DS    0H                                                               
         MVI   EZERRCD,EZERRMIS    MISSING FIELD ERROR                          
*                                                                               
SETERR   NTR1                                                                   
SETERRB  DS    0H                  NON-NTR'D ENTRY POINT                        
         BAS   RE,GETERRF          GET FIELD NAME                               
         BAS   RE,GETERRM          AND MESSGE                                   
         MVI   EZMODE,EZERRP       SET ERROR MODE                               
         BAS   RE,HOOK             TELL USER'S ERROR PROC                       
         LTR   RE,RE               RETURN CC NOT =                              
         XIT1                                                                   
*                                                                               
*        GETERRF - GET ERROR FIELD NAME AND RECORD NAME                         
*                                                                               
GETERRF  NTR1                                                                   
         MVC   EZERRREC,SPACES                                                  
         MVC   EZERRFLD,SPACES                                                  
         MVC   EZERRDTA,SPACES                                                  
         XC    ERRFLDD,ERRFLDD                                                  
*                                                                               
         CLI   EZERRCD,EZERRRTP    FOR BAD RECORD TYPE                          
         BE    GERFX               SKIP FIELD NAME                              
         STCM  R2,15,EZERRFAD      SET A(FIELD IN ERROR)                        
         LTR   R2,R2               IF ZERO, SKIP                                
         BZ    GERFX                                                            
*                                                                               
         SR    R2,EZBREG           GET FIELD DISP                               
         STH   R2,ERRFLDD                                                       
         AR    R2,EZBREG           RESTORE DATA ADDRESS                         
*                                  GET RECORD DESCRIPTOR                        
         L     R3,EZARECTB                                                      
         USING EZRDD,R3                                                         
*                                                                               
GERF2    DS    0H                                                               
         CLI   0(R3),X'FF'         EOL                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   EZRDRCQ,RECTYPE                                                  
         BE    GERF4                                                            
         LA    R3,EZRDDL(R3)                                                    
         B     GERF2                                                            
*                                                                               
GERF4    DS    0H                                                               
         MVC   EZERRREC,EZRDNAM   SET RECORD NAME                               
*                                                                               
         CLI   EZERRCD,EZERRFLN                                                 
         NOP   GERFX                                                            
*                                                                               
*                                  NOW SEARCH FOR FIELD                         
         ICM   R3,7,EZRDFRST       A(FIRST FIELD)                               
         A     R3,RELO             MUST RELOCATE                                
         USING EZFDD,R3                                                         
*                                                                               
GERF6    DS    0H                                                               
         CLI   0(R3),X'FF'         EOL                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   ERRFLDD,EZFDDSP     SEARCH BASED ON DISPLACEMENT                 
         BE    GERF8                                                            
         LA    R3,EZFDDL(R3)                                                    
         B     GERF6                                                            
*                                                                               
GERF8    DS    0H                                                               
         MVC   EZERRFLD,EZFDNAM    SET FIELD NAME                               
*                                                                               
         MVC   EZERRDTA,SPACES                                                  
         ZIC   RF,EZFDLEN          DATA LENGTH                                  
         CHI   RF,L'EZERRDTA                                                    
         BNH   *+8                                                              
         LHI   RF,L'EZERRDTA                                                    
         BCTR  RF,R0                                                            
         EX    RF,GERFMVC                                                       
*                                                                               
GERFX    XIT1                                                                   
*                                                                               
GERFMVC  MVC   EZERRDTA(0),0(R2)   SET ERROR DATA                               
         DROP  R3                                                               
*                                                                               
*        GETERRM - GET ERROR MESSAGE AND LEVEL                                  
*                                                                               
GETERRM  NTR1                                                                   
         L     R3,AERRTAB                                                       
         MVC   EZERRMSG,SPACES                                                  
         MVI   EZERRLEV,0                                                       
*                                                                               
GERM2    DS    0H                                                               
         CLI   0(R3),X'FF'         EOL                                          
         BE    GERMX                                                            
*                                                                               
         CLC   EZERRCD,0(R3)                                                    
         BE    GERM4                                                            
         LA    R3,ERRTABL(R3)                                                   
         B     GERM2                                                            
*                                                                               
GERM4    DS    0H                                                               
         MVC   EZERRLEV,1(R3)                                                   
         MVC   EZERRMSG,2(R3)                                                   
         OC    EZERRLVR,1(R3)      'OR' UP ERROR - RECORD                       
         OC    EZERRLVI,1(R3)                    - INVOICE                      
         OC    EZERRLVB,1(R3)                    - BATCH                        
*                                                                               
GERMX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        HOOK - CALL USER ROUTINE                                               
*                                                                               
HOOK     DS    0H                                                               
         CLI   EZMODE,EZBATL                                                    
         JNE   HOOK01                                                           
         TM    EZFLAG,EZFBATLQ     DO WE WANT BATLAST MODE?                     
         JO    HOO                 NO, PROCEED AS USUAL                         
*                                                                               
HOOK01   CLI   SKIPSW,C'Y'         BYPASS IF SKIPPING OVER INVOICE              
         BER   RE                                                               
*                                                                               
HOO      NTR1                                                                   
         MVC   SVEZMODE,EZMODE     SAVE MODE                                    
         BAS   RE,TRCHOOK                                                       
         L     RF,EZHOOK           A(HOOK)                                      
         L     RE,CALLRD           BACK NMOD LINK                               
         LR    R0,RE               SET R0 SO USER CAN EXIT                      
         LM    R1,RC,24(RE)        CALLER'S R1-RC                               
         BASR  RE,RF                                                            
*                                                                               
         L     RD,4(RD)                                                         
         LM    RE,RC,12(RD)                                                     
*                                                                               
         CLC   SVEZMODE,EZMODE     TEST CALLER CHANGED MODE                     
         BER   RE                  NO- RETURN                                   
         CLI   EZMODE,EZINVL       DID HE ASK TO SKIP INVOICE                   
         BNER  RE                  NO- RETURN                                   
         MVI   SKIPSW,C'Y'         YES- SET SKIP SWITCH                         
         BR    RE                                                               
*                                                                               
*        SET LAST USED CMML SEQ                                                 
*                                                                               
SETSEQ   CLI   NEWCMLSW,C'Y'       TEST HAVE ADDED ANY CMMLS                    
         BNER  RE                                                               
         OC    SADVCMML,SADVCMML   IF HAVE CMML SEQ FOR LAST CLT                
         BZR   RE                                                               
         CLC   SADVCMML,=3X'FF'                                                 
         BER   RE                                                               
*                                  SET CMML MASTER RECORD                       
SSQ      NTR1                                                                   
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING CMLRECD,R6                                                       
         MVC   CMLKID,=X'0A21'                                                  
         MVC   CMLKAM,EZBAGYMD                                                  
         MVC   CMLKCLT,SADVBIN     CLIENT CODE                                  
         OC    SADVBINC,SADVBINC   CONSOLODATED CLIENT CODE?                    
         BZ    *+10                                                             
         MVC   CMLKCLT,SADVBINC    USE CONSOLODATED CLIENT CODE                 
*                                                                               
         ZIC   R0,EZTRFTBL                                                      
         L     R2,EZTRFTBL                                                      
         LA    R2,0(,R2)                                                        
*                                                                               
SSQ10    OC    0(5,R2),0(R2)       END OF COMML SEQ TABLE                       
         BZ    SSQ15                                                            
         CLC   0(2,R2),CMLKCLT     THIS THE CLIENT                              
         BE    SSQ30                                                            
         LA    R2,5(,R2)                                                        
         BCT   R0,SSQ10                                                         
*                                                                               
SSQ15    DC    H'0'                                                             
*                                                                               
SSQ30    BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BE    SSQ40                                                            
         DC    H'0'                MASTER CMML REC MUST BE THERE                
*                                                                               
SSQ40    BAS   RE,GET                                                           
*                                                                               
         L     R6,EZAREC                                                        
         CLC   CMLSEQ+1(2),SADVCMML   HAS IT CHANGED?                           
         BL    SSQ50                                                            
         BE    SSQX                                                             
*                                                                               
         DC    H'0'                                                             
*                                                                               
SSQ50    DS    0H                                                               
         XC    CMLSEQ,CMLSEQ                                                    
         MVC   CMLSEQ+1(2),SADVCMML   SET HIGHEST                               
*                                                                               
         MVC   2(3,R2),SADVCMML   SET HIGHEST IN TABLE AS WELL                  
         DROP  R6                                                               
*                                                                               
         MVC   DATADISP,=AL2(24)   TRFFIL                                       
         L     R6,EZAREC                                                        
         MVI   ELCODE,X'F1'        ACTIVITY                                     
         BRAS  RE,GETEL                                                         
         BNE   SSQ60                                                            
*                                                                               
         USING ACTVD,R6                                                         
         GOTO1 DATCON,DMCB,(5,0),(3,ACTVCHDT)                                   
         DROP  R6                                                               
*                                                                               
SSQ60    DS    0H                                                               
         BAS   RE,PUT              UPDATE COMMERCIAL SEQ MASTER                 
*                                                                               
         TM    EZTRACE,X'10'       TEST TRACING ADDED CMMLS                     
         BZ    SSQ80                                                            
*                                                                               
         L     R6,EZAREC                                                        
         MVC   P,SPACES                                                         
         MVC   P+20(10),=C'MASTER CML'                                          
         GOTO1 HEXOUT,DMCB,0(R6),P+35,13,=C'N'                                  
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
         LA    R6,24(R6)                                                        
         GOTO1 HEXOUT,DMCB,0(R6),P+35,20,=C'N'                                  
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
SSQ80    DS    0H                                                               
         L     RE,EZUTL                                                         
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
         MVC   4(1,RE),EZSPOTSE    RESTORE SPOT SYSTEM NUMBER                   
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
SSQX     XIT1                                                                   
*                                                                               
*                                                                               
*                                                                               
*        TRCRET- ROUTINE TO TRACE GETFLD RETURNS                                
*                                                                               
TRCRET   DS    0H                                                               
         TM    EZTRACE,X'80'       TEST TRACING FIELDS                          
         BZR   RE                                                               
*                                                                               
TRCRETN  NTR1                                                                   
         MVC   P,SPACES                                                         
         GOTO1 HEXOUT,DMCB,RFCNTL,P,1,=C'N'                                     
         GOTO1 HEXOUT,DMCB,RFCNTL2,P+3,1,=C'N'                                  
         EDIT  (B1,RFFLDNO),(3,P+6),FILL=0                                      
         EDIT  (B1,RFLEN),(3,P+10),FILL=0                                       
         MVC   P+14(100),RFDATA                                                 
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
         MVC   P,SPACES                                                         
*                                                                               
         XIT1                                                                   
*                                                                               
*        TRCWKR- ROUTINE TO TRACE WORKER FILE READS                             
*                                                                               
TRCWKR   TM    EZTRACE,X'80'       TEST TRACING FIELDS                          
         BZR   RE                                                               
*                                                                               
TRCWKRN  NTR1                                                                   
         MVC   P,SPACES                                                         
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
         L     R6,EZWKRREC                                                      
         LH    R2,0(R6)            LENGTH                                       
         EDIT  (R2),(4,P),FILL=0                                                
         LA    R3,0(R6,R2)         EOR                                          
         LA    R6,2(R6)                                                         
*                                                                               
TW6      DS    0H                                                               
         LR    R4,R3                                                            
         SR    R4,R6                                                            
         BNP   TW8                                                              
         CH    R4,=H'100'                                                       
         BNH   *+8                                                              
         LA    R4,100                                                           
*                                                                               
         BCTR  R4,R0                                                            
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   P+5(0),0(R6)                                                     
         LA    R4,1(R4)                                                         
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
         MVC   P,SPACES                                                         
         LA    R6,0(R6,R4)                                                      
         B     TW6                                                              
*                                                                               
TW8      DS    0H                                                               
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
         MVC   P,SPACES                                                         
         XIT1                                                                   
*                                                                               
*        TRCHOOK- ROUTINE TO TRACE CALLS TO USER                                
*                                                                               
TRCHOOK  DS    0H                                                               
         CLI   EZMODE,EZERRP       TEST ERROR MODE                              
         BNE   TRCH1D                                                           
         TM    EZTRACE,X'20'       TEST TRACING ERRORS                          
         BZR   RE                                                               
         B     TRCHOOKN                                                         
*                                                                               
TRCH1D   DS    0H                                                               
         TM    EZTRACE,X'40'       TEST TRACING REGULAR CALLS                   
         BZR   RE                                                               
*                                                                               
TRCHOOKN NTR1                                                                   
         MVC   P,SPACES                                                         
         MVC   P(17),=C'**HOOK- MODE XX ='                                      
         GOTO1 HEXOUT,DMCB,EZMODE,P+13,1,=C'N'                                  
         LA    RF,MODETAB                                                       
         LA    RE,MODETBN                                                       
*                                                                               
TRCH2    DS    0H                                                               
         CLC   EZMODE,0(RF)                                                     
         BE    TRCH4                                                            
         LA    RF,11(RF)                                                        
         BCT   RE,TRCH2                                                         
         DC    H'0'                                                             
*                                                                               
TRCH4    DS    0H                                                               
         MVC   P+19(10),1(RF)                                                   
         CLI   EZMODE,EZERRP       FOR ERRORS DO MORE                           
         BNE   TRCH6                                                            
         GOTO1 HEXOUT,DMCB,EZERRCD,P+32,1,=C'N'                                 
         GOTO1 HEXOUT,DMCB,EZERRLEV,P+35,1,=C'N'                                
         MVC   P+38(20),EZERRREC   RECORD NAME                                  
         MVC   P+60(20),EZERRFLD   AND FIELD                                    
         MVC   P+82(40),EZERRMSG   AND MESSAGE                                  
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
         MVC   P,SPACES                                                         
         MVC   P+82(30),EZERRDTA  AND DATA                                      
*                                                                               
TRCH6    DS    0H                                                               
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
         MVC   P,SPACES                                                         
*                                                                               
         XIT1                                                                   
*                                                                               
MODETAB  DS    0X                                                               
         DC    AL1(EZERRP),CL10'PROC ERROR'                                     
         DC    AL1(EZINVP),CL10'PROC INV'                                       
         DC    AL1(EZICCOMP),CL10'PROC IC-T'                                    
         DC    AL1(EZSCHP),CL10'PROC SCHED'                                     
         DC    AL1(EZSCOMP),CL10'PROC S COM'                                    
         DC    AL1(EZSPTP),CL10'PROC SPOT'                                      
         DC    AL1(EZRECP),CL10'PROC RECON'                                     
         DC    AL1(EZIBCOMP),CL10'PROC IC-B'                                    
         DC    AL1(EZSPTL),CL10'SPOT LAST'                                      
         DC    AL1(EZSCHL),CL10'SCHED LAST'                                     
         DC    AL1(EZINVL),CL10'INV LAST'                                       
         DC    AL1(EZBATL),CL10'BATCH LAST'                                     
         DC    AL1(EZCMLADD),CL10'CMML ADD'                                     
MODETBN  EQU   (*-MODETAB)/11                                                   
         DC    X'FF',CL10'*UNKNOWN*'                                            
*                                                                               
*        DATAMGR INTERFACE                                                      
*                                                                               
*                                                                               
HIGH     DS    0H                                                               
         LR    R0,RE                                                            
         MVC   KEYSAVE,KEY                                                      
*                                                                               
         CLI   EZSPTNET,C'N'       IF NETWORK, NO TRAFFIC FILE                  
         BE    HIGH10                                                           
*                                                                               
         CLI   EZFCTRFU,C'Y'       TEST TRAFFIC SYSTEM OP                       
         BNE   HIGH10                                                           
*                                                                               
         CLI   KEY,X'0A'           THIS A TRAFFIC REC                           
         BNE   HIGH10                                                           
*                                                                               
         MVC   SPTDIR(3),=C'TRF'                                                
         L     RE,EZUTL                                                         
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
         MVC   4(1,RE),EZRCTRFU    SET TRAFFIC SYSTEM NUMBER                    
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
HIGH10   DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(DMIBTS,DMRDHI),SPTDIR,KEY,KEY                      
         B     DMCK0                                                            
*                                                                               
SEQ      DS    0H                                                               
         LR    R0,RE                                                            
*                                                                               
         CLI   EZSPTNET,C'N'       IF NETWORK, NO TRAFFIC FILE                  
         BE    SEQ10                                                            
*                                                                               
         CLI   EZFCTRFU,C'Y'       TEST TRAFFIC SYSTEM OP                       
         BNE   SEQ10                                                            
*                                                                               
         CLI   KEY,X'0A'           THIS A TRAFFIC REC                           
         BNE   SEQ10                                                            
         MVC   SPTDIR(3),=C'TRF'                                                
         L     RE,EZUTL                                                         
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
         MVC   4(1,RE),EZRCTRFU    SET TRAFFIC SYSTEM NUMBER                    
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
SEQ10    DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(DMIBTS,DMRSEQ),SPTDIR,KEY,KEY                      
         B     DMCK0                                                            
*                                                                               
ADDIR    DS    0H                                                               
         LR    R0,RE                                                            
         CLI   EZWRITE,C'Y'                                                     
         BNE   DMCK4                                                            
*                                                                               
         CLI   EZSPTNET,C'N'       IF NETWORK, NO TRAFFIC FILE                  
         BE    DMCK4                                                            
*                                                                               
         CLI   EZFCTRFU,C'Y'       TEST TRAFFIC SYSTEM OP                       
         BNE   DMCK4                                                            
*                                                                               
         CLI   KEY,X'0A'           THIS A TRAFFIC REC                           
         BNE   ADDIR10                                                          
*                                                                               
         MVC   SPTDIR(3),=C'TRF'                                                
         L     RE,EZUTL                                                         
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
         MVC   4(1,RE),EZRCTRFU    SET TRAFFIC SYSTEM NUMBER                    
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
ADDIR10  DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(DMIBTS,DMADD),SPTDIR,KEY,KEY                       
         B     DMCK0                                                            
*                                                                               
WRITE    DS    0H                                                               
         LR    R0,RE                                                            
         CLI   EZWRITE,C'Y'                                                     
         BNE   DMCK4                                                            
*                                                                               
         CLI   EZSPTNET,C'N'       IF NETWORK, NO TRAFFIC FILE                  
         BE    WRITE10                                                          
*                                                                               
         CLI   EZFCTRFU,C'Y'       TEST TRAFFIC SYSTEM OP                       
         BNE   WRITE10                                                          
*                                                                               
         CLI   KEY,X'0A'           THIS A TRAFFIC REC                           
         BNE   WRITE10                                                          
*                                                                               
         MVC   SPTDIR(3),=C'TRF'                                                
         L     RE,EZUTL                                                         
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
         MVC   4(1,RE),EZRCTRFU    SET TRAFFIC SYSTEM NUMBER                    
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
WRITE10  DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(DMIBTS,DMWRT),SPTDIR,KEY,KEY                       
         B     DMCK0                                                            
*                                                                               
GET      DS    0H                                                               
         LR    R0,RE                                                            
         CLI   EZSPTNET,C'N'       IF NETWORK, NO TRAFFIC FILE                  
         BE    GET10                                                            
*                                                                               
         CLI   EZFCTRFU,C'Y'       TEST TRAFFIC SYSTEM OP                       
         BNE   GET10                                                            
*                                                                               
         CLI   KEY,X'0A'           THIS A TRAFFIC REC                           
         BNE   GET10                                                            
*                                                                               
         MVC   SPTFIL(3),=C'TRF'                                                
         L     RE,EZUTL                                                         
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
         MVC   4(1,RE),EZRCTRFU    SET TRAFFIC SYSTEM NUMBER                    
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
GET10    DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(DMIBTS,GETREC),SPTFIL,KEY+14,             X        
               EZAREC,DMWORK                                                    
         B     DMCK0                                                            
*                                                                               
PUT      DS    0H                                                               
         LR    R0,RE                                                            
         CLI   EZWRITE,C'Y'                                                     
         BNE   DMCK4                                                            
*                                                                               
         CLI   EZSPTNET,C'N'       IF NETWORK, NO TRAFFIC FILE                  
         BE    PUT10                                                            
*                                                                               
         CLI   EZFCTRFU,C'Y'       TEST TRAFFIC SYSTEM OP                       
         BNE   PUT10                                                            
*                                                                               
         CLI   KEY,X'0A'           THIS A TRAFFIC REC                           
         BNE   PUT10                                                            
*                                                                               
         MVC   SPTFIL(3),=C'TRF'                                                
         L     RE,EZUTL                                                         
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
         MVC   4(1,RE),EZRCTRFU    SET TRAFFIC SYSTEM NUMBER                    
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
PUT10    DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(DMIBTS,PUTREC),SPTFIL,KEY+14,             X        
               EZAREC,DMWORK                                                    
         B     DMCK0                                                            
*                                                                               
ADD      DS    0H                                                               
         LR    R0,RE                                                            
         CLI   EZWRITE,C'Y'                                                     
         BNE   DMCK4                                                            
         CLI   EZSPTNET,C'N'       IF NETWORK, NO TRAFFIC FILE                  
         BE    ADD10                                                            
*                                                                               
         CLI   EZFCTRFU,C'Y'       TEST TRAFFIC SYSTEM OP                       
         BNE   ADD10                                                            
*                                                                               
         CLI   KEY,X'0A'           THIS A TRAFFIC REC                           
         BNE   ADD10                                                            
*                                                                               
         MVC   SPTFIL(3),=C'TRF'                                                
         L     RE,EZUTL                                                         
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
         MVC   4(1,RE),EZRCTRFU    SET TRAFFIC SYSTEM NUMBER                    
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
ADD10    DS    0H                                                               
         GOTO1 DATAMGR,DMCB,(DMIBTS,ADDREC),SPTFIL,KEY,                X        
               EZAREC,DMWORK                                                    
         B     DMCK0                                                            
*                                                                               
DMCK0    DS    0H                                                               
         MVC   SPTDIR(3),=C'SPT'                                                
         MVC   SPTFIL(3),=C'SPT'                                                
         ICM   RE,15,EZUTL                                                      
         BZ    DMCK                                                             
*                                                                               
         CLI   EZSPOTSE,0                                                       
         BE    DMCK                                                             
*                                                                               
         MVC   4(1,RE),EZSPOTSE    RESTORE SPOT SYSTEM NUMBER                   
         CLI   4(RE),0             TEMP                                         
         BNE   *+6                                                              
         DC    H'0'                TEMP                                         
*                                                                               
DMCK     DS    0H                                                               
         MVC   BYTE,DMOBTS                                                      
         NC    BYTE,DMCB+8                                                      
         BZ    DMCK4                                                            
*                                                                               
* 10/18/2011 CRASH ON ALL DMGR ERRORS                                           
*                                                                               
*        OC    EZMAST,EZMAST       SEE IF OFFLINE                               
*        BNZ   DMCK2                YES                                         
*                                                                               
         DC    H'0'                DATAMGR ERROR- FOR NOW JUST ABEND            
*                                                                               
DMCK2    DS    0H                                                               
         GOTO1 =A(TELL)            THEM ERROR BUT DON'T STOP                    
         A     RF,RELO                                                          
         LR    RE,R0                                                            
         LTR   RE,RE               RETURN CC NOT = IF ERROR                     
         BR    RE                                                               
*                                                                               
DMCK4    DS    0H                                                               
         LR    RE,R0                                                            
         CR    RE,RE               RETURN CC = IF NO ERROR                      
         BR    RE                                                               
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*                                                                               
         LTORG                                                                  
         DROP  RC                                                               
*                                                                               
*        FLDCVT - FIELD CONVERSIONS AND LOOKUPS                                 
*                                                                               
FLDCVT   NMOD1 0,FLDCVT,R7                                                      
         L     RC,SAVWORK          RESTORE WORK AREA ADDRESS                    
         USING EZMODD,RC                                                        
*                                                                               
         CLI   EZCONVSW,X'FF'      TEST TO SUPPRESS CONVERSIONS                 
         BE    FCX                                                              
*                                                                               
         CLI   RECTYPE,EZIHEQ      INVOICE HEADER                               
         BE    FCIH                                                             
         CLI   RECTYPE,EZSLEQ      SCHEDULE LINE                                
         BE    FCSL                                                             
         CLI   RECTYPE,EZSPEQ      SPOT                                         
         BE    FCSP                                                             
         CLI   RECTYPE,EZITEQ      INVOICE TOTAL                                
         BE    FCIT                                                             
         B     FCX                                                              
*                                                                               
*        INVOICE HEADER FIELDS                                                  
*        ---------------------                                                  
*                                                                               
FCIH     DS    0H                                                               
         CLI   EZSELINV,C' '       TEST HAVE INVOICE FILTER                     
         BNH   FCIH80               NO                                          
         CLC   EZIHINV,EZSELINV    YES- INV NUMBER MUST AGREE                   
         BE    FCIH80                                                           
         MVI   SKIPSW,C'Y'         IF NOT, SKIP                                 
         B     FCX                                                              
*                                                                               
* THIS MID FLIGHT CLEARANCE ONLY RUN?                                           
*                                                                               
FCIH80   DS    0H                                                               
         CLI   EZMCTREQ,C'M'       MCT ONLY                                     
         BNE   FCIH85                                                           
         CLC   =C'MID FLIGHT CL',EZIHORD                                        
         BE    FCIH85                                                           
         MVI   SKIPSW,C'Y'         IF NOT, SKIP                                 
         B     FCX                                                              
*                                                                               
FCIH85   DS    0H                                                               
         MVI   SKIPVAL,C'N'                                                     
         OC    EZMAST,EZMAST       SEE IF OFFLINE                               
         BZ    FCIH90              NO - CONTINUE                                
*                                                                               
* YES, RUNNING OFFLINE - SKIP DELETED, CONVERTED INVOICES                       
*                                                                               
         TM    EZIHCVST,EZIHCDEL   DELETED?                                     
         BO    FCIH89              YES, SKIP IT!                                
         TM    EZIHCVST,EZIHCVQ    TEST ALREADY CONVERTED                       
         BZ    FCIH90              NO - PROCESS IT                              
         TM    EZIHCVST,EZIHRCVQ   CONVERTED - TEST FOR RECONVERT               
         BO    FCIH90              RECONVERT FLAG ON - PROCESS INVOICE          
         OC    EZRERUN,EZRERUN     NO RECONV - DO WE HAVE RERUN DATE?           
         BZ    FCIH89              NO - SKIP THE INVOICE                        
         CLC   EZRERUN(3),=C'ALL'  ALL RE-RUN DATES?                            
         BE    FCIH90              YES - PROCESS THE INVOICE                    
         CLC   EZIHCVDT,EZRERUN    SAME DATE AS CONVERSION DATE?                
         BE    FCIH90              YES - PROCESS THE INVOICE                    
*                                                                               
FCIH89   DS    0H                                                               
         MVI   SKIPVAL,C'Y'                                                     
*                                                                               
*                                                                               
FCIH90   DS    0H                                                               
* CONVERT INV HEADER DATES, SO THERE IS SOMETHING TO DISPLAY IN                 
* CASE THERE ARE ERRORS                                                         
*                                                                               
***      INVOICE DATE                                                           
*                                                                               
         LA    R2,EZIHIDAT         INVOICE DATE                                 
         CLI   0(R2),C' '          TEST THERE                                   
         BH    FCIH90A                                                          
         GOTO1 DATCON,DMCB,(3,EZBTBRDT),(0,(R2)) IF NOT-USE BATCH DATE          
*                                                                               
FCIH90A  DS    0H                  INV DATE PRESENT                             
         MVI   BYTE,0              THIS WILL BE FORCED IF BAD                   
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BE    FCIH90B                                                          
         GOTO1 DATCON,DMCB,(3,EZBTBRDT),(0,(R2))  USE BATCH DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BE    FCIH90B                                                          
         DC    H'0'                                                             
*                                                                               
FCIH90B  DS    0H                                                               
         MVC   EZIHDIDT,DDATE      MMMDD/YY                                     
         MVC   EZIHBIDT,BDATE      BINARY 3                                     
*                                                                               
***      MONTH OF SERVICE (BROADCAST MONTH)                                     
*                                                                               
         LA    R2,EZIHMON          MONTH OF SERVICE                             
         BAS   RE,TSTANY           MUST BE THERE                                
         BNZ   FCIH380                                                          
*                                                                               
* "THEY" ARE SENDING 001 AND BINARY ZERO, NOT GOING TO FIX THIS                 
         LA    R0,4                                                             
         LA    R1,EZIHMON                                                       
         CLI   0(R1),C'0'          ALL 4 CHARACTERS MUST BE NUMERIC             
         BL    FCIH380              BAD                                         
         LA    R1,1(,R1)                                                        
         BCT   R0,*-12                                                          
         XC    EDATE,EDATE                                                      
         MVC   EDATE(4),0(R2)                                                   
         OC    EDATE,=6C'0'                                                     
         CLC   EDATE+0(2),=C'00'   VALIDATE YEAR                                
         BE    FCIH90C                                                          
         CLC   EDATE+0(2),=C'27'   VALIDATE YEAR                                
         BNH   FCIH90C                                                          
         CLC   EDATE+0(2),=C'90'   VALIDATE YEAR                                
         BL    FCIH380                                                          
*                                                                               
FCIH90C  DS    0H                                                               
         CLC   EDATE+2(2),=C'01'   VALIDATE MONTH                               
         BL    FCIH380                                                          
         CLC   EDATE+2(2),=C'12'                                                
         BH    FCIH380                                                          
*                                                                               
         GOTO1 DATCON,DMCB,(0,EDATE),(9,EZIHDMOS)                               
         GOTO1 DATCON,DMCB,,(3,EZIHBMOS)                                        
*                                                                               
***      PERIOD START/END DATES                                                 
*                                                                               
         LA    R2,EZIHISDT         INVOICE PERIOD START                         
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCIH90E                                                          
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BE    *+14                                                             
         XC    EZIHISDT,EZIHISDT                                                
         B     FCIH90E                                                          
*                                                                               
         MVC   EZIHDISD,DDATE      MMMDD/YY                                     
*                                                                               
FCIH90E  DS    0H                                                               
         LA    R2,EZIHIEDT         INVOICE PERIOD END                           
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCIH90G                                                          
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BE    *+14                                                             
         XC    EZIHIEDT,EZIHIEDT                                                
         B     FCIH90G                                                          
*                                                                               
         MVC   EZIHDIED,DDATE      MMMDD/YY                                     
*                                                                               
***      CONTRACT START/END DATES                                               
*                                                                               
FCIH90G  DS    0H                                                               
         LA    R2,EZIHCSDT         CONTRACT YEAR START                          
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCIH90H                                                          
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BNE   FCIH90H                                                          
*                                                                               
         MVC   EZIHDCSD,DDATE      MMMDD/YY                                     
*                                                                               
FCIH90H  DS    0H                                                               
         LA    R2,EZIHCEDT         CONTRACT YEAR END                            
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCIH94                                                           
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BNE   FCIH94                                                           
*                                                                               
         MVC   EZIHDCED,DDATE      MMMDD/YY                                     
*                                                                               
FCIH94   DS    0H                                                               
         LA    R2,EZIHSDT          START DATE                                   
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCIH95                                                           
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BNE   FCIH95                                                           
*                                                                               
         MVC   EZIHDSDT,DDATE      MMMDD/YY                                     
*                                                                               
FCIH95   DS    0H                                                               
         LA    R2,EZIHEDT          END DATE                                     
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCIH98                                                           
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BNE   FCIH98                                                           
*                                                                               
         MVC   EZIHDEDT,DDATE      MMMDD/YY                                     
*                                                                               
FCIH98   DS    0H                                                               
*                                                                               
         LA    R1,EZIHINV                                                       
         LHI   R0,L'EZIHINV                                                     
*                                                                               
FCIH99   DS    0H                  CHECK INV NAME FOR PERIODS, COMMAS           
         CLI   0(R1),C'.'                                                       
         BE    FCIH99E                                                          
         CLI   0(R1),C','                                                       
         BE    FCIH99E                                                          
         LA    R1,1(R1)                                                         
         BCT   R0,FCIH99                                                        
         B     FCIH100             INVOICE NAME OK                              
*                                                                               
FCIH99E  DS    0H                  BAD INVOICE NAME                             
         MVI   EZERRCD,EZERINVN    INVALID INV NAME                             
         LA    R2,EZIHINV                                                       
         B     SETERRB                                                          
*                                                                               
FCIH100  DS    0H                                                               
*                                                                               
* C/P/E CODES LOOKUP HERE.  INITIALIZE LOOKUP VALUES FIRST                      
*                                                                               
         XC    EZIHLADN,EZIHLADN                                                
         XC    EZIHLADC,EZIHLADC                                                
         XC    EZIHLADB,EZIHLADB                                                
         XC    EZIHLADT,EZIHLADT                                                
*                                                                               
         XC    EZIHLPRN,EZIHLPRN                                                
         XC    EZIHLPRC,EZIHLPRC                                                
         XC    EZIHLPRB,EZIHLPRB                                                
         XC    EZIHLPRT,EZIHLPRB                                                
*                                                                               
         XC    EZIHLP2N,EZIHLP2N                                                
         XC    EZIHLP2C,EZIHLP2C                                                
         XC    EZIHLP2B,EZIHLP2B                                                
*                                                                               
         XC    EZIHLEST,EZIHLEST                                                
         XC    EZIHBEST,EZIHBEST                                                
*                                                                               
         TM    EZIHCVST,EZIHCOVR   ANY OVERRIDES?                               
         BO    FCIH105             YES - DO NOT CHECK ADVNAME                   
         CLI   EZIHAAID,C' '       DID STATION SEND ANYTHING?                   
         BH    FCIH105             YES - DO NOT CHECK ADVNAME                   
*                                                                               
* CHECK ADVERTISER NAME.  IF MISSING - DO NOT CONVERT                           
*                                                                               
         LA    R2,EZIHADVN         ADVERTISER (CLIENT)                          
         BAS   RE,TSTANY           MUST BE THERE                                
         BZ    FCIH105             OK - LOOKUP ADVERTISER                       
*                                                                               
         LA    R2,EZIHADVN                                                      
         MVI   EZERRCD,EZERADVN                                                 
         BAS   RE,SETERR                                                        
*                                                                               
FCIH105  DS    0H                                                               
         BAS   RE,LKADV            LOOK UP ADVERTISER                           
*                                                                               
* PRD                                                                           
*                                                                               
         TM    EZLOOKSW,EZLNOPRD   TEST SKIP PRD LOOKUP                         
         BNZ   FCIH200                                                          
*                                                                               
         CLI   SKIPVAL,C'Y'                                                     
         BE    FCIH200                                                          
*                                                                               
         XC    SVPRDS(SVPRDSLQ),SVPRDS                                          
         TM    EZIHCVST,EZIHCOVR   ANY OVERRIDES                                
         BZ    FCIH106             NO - PROCEED TO AGY PRD CODE                 
*                                                                               
         CLI   EZIHCVPR,0          DO WE HAVE OVERRIDE PRODUCT                  
         BNE   FCIH130             YES                                          
*                                                                               
* NO 1-BYTE OVERRIDE.  CHECK 3-CHAR OVERRIDE FOR NETWORK                        
         CLI   EZSPTNET,C'N'       NETWORK?                                     
         BNE   FCIH106             NO - DON'T CHECK 3 CHAR OVERRIDE             
         CLC   EZIHSPRD,SPACES     CHECK 3-CHAR OVERRIDE PRESENT                
         BH    FCIH130             YES                                          
*                                                                               
* NO PRD OVERRIDE HERE                                                          
FCIH106  DS    0H                                                               
         OC    EZIHAPID,EZIHAPID   ANY AGENCY PRODUCT CODE PROVIDED             
         BZ    FCIH110             NO                                           
*                                                                               
         CLC   =C'VARIOUS',EZIHAPID                                             
         BE    FCIH120                                                          
         CLC   =C'POL ',EZIHAPID                                                
         BE    FCIH120                                                          
*                                                                               
* PRD CODE HERE - PARSE                                                         
         XC    WORK,WORK                                                        
         MVC   WORK(L'EZIHAPID),EZIHAPID                                        
         OC    WORK,SPACES                                                      
         LA    R3,WORK             PRODUCT ID (OR 2 IDS)                        
         XC    BLOCK,BLOCK                                                      
         LA    R4,BLOCK                                                         
*                                                                               
* SEPARATOR TABLE IS AL1(1),C' ',AL1(1),C' ',AL1(1),C' ',AL1(1),C' '            
*                                                                               
         GOTO1 PARSNIP,DMCB,(8,(R3)),(2,(R4)),                         X        
               (0,=X'017E014001400140')                                         
         USING PSND,R4                                                          
*                                                                               
         LA    R2,EZIHAPID         AGENCY PRODUCT CODE                          
*                                                                               
         CLI   0(R4),0                                                          
         BE    FCIH150                                                          
         CLI   PSNERR,0                                                         
         BNE   FCIH150                                                          
         CLI   PSNTAG,PSNFLDQ                                                   
         BNE   FCIH150                                                          
         CLI   PSNLEN,2                                                         
         BL    FCIH150                                                          
         CLI   PSNLEN,3                                                         
         BH    FCIH150                                                          
*                                                                               
         L     R1,PSNCOMP          A(COMPONENT)                                 
         MVC   SVPRD1,0(R1)                                                     
         OC    SVPRD1,SPACES                                                    
*                                                                               
         OC    PSNFLD,PSNFLD       HAVE 2ND PRD?                                
         BZ    FCIH140             NO - LOOKUP WHATEVER YOU'VE GOT              
*                                                                               
         L     R4,PSNFLD           NEXT PARSNIP LINE                            
         CLI   PSNTAG,PSNFLDQ                                                   
         BNE   FCIH150                                                          
         CLI   PSNLEN,2                                                         
         BL    FCIH150                                                          
         CLI   PSNLEN,3                                                         
         BH    FCIH150                                                          
         L     R1,PSNCOMP          A(COMPONENT)                                 
         MVC   SVPRD2,0(R1)                                                     
         OC    SVPRD2,SPACES                                                    
         B     FCIH140             GO DO THE LOOKUP                             
*                                                                               
FCIH110  DS    0H                  NO OVERRIDE, NO PRD CODE                     
         LA    R2,EZIHPRDN         25-CHAR PRD NAME                             
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCIH150             NOT THERE - ERROR                            
*                                                                               
         CLC   =C'VARIOUS',0(R2)   VARIOUS AND POL CAN STILL CONVERT            
         BE    FCIH120                                                          
         CLC   =C'POL ',0(R2)                                                   
         BNE   FCIH150                                                          
*                                                                               
FCIH120  DS    0H                  FORCE PRODUCT TO POL                         
         MVI   EZIHLPRB,X'FF'                                                   
         MVC   EZIHLPRC,=C'POL'                                                 
         MVC   EZIHLPRN(7),=C'VARIOUS'                                          
         B     FCIH160             PROCEED TO ESTIMATE                          
*                                                                               
FCIH130  DS    0H                  PRODUCT OVERRIDE HERE                        
         CLI   EZIHCVPR,0          1-BYTE OVERRIDE?                             
         BE    FCIH131             NO, USE 3-CHAR OVERRIDE FOR NET              
         LA    R1,SVCLIST                                                       
         LA    R2,EZIHCVPR         OVERRIDE PRODUCT 1                           
         BRAS  RE,LKBYBIN          GET 3-CHAR PRD CODE                          
         BE    FCIH132             CODE FOUND - SAVE IT                         
*                                                                               
         LA    R2,EZIHPRDN                                                      
         B     FCIH150             ERROR                                        
*                                                                               
FCIH131  DS    0H                  3-CHAR OVERRIDE HERE                         
         LA    R2,EZIHPRDN                                                      
         LA    R1,EZIHSPRD                                                      
         CLC   EZIHSPRD,SPACES     DO WE HAVE 3-CHAR OVERRIDE?                  
         BNH   FCIH150             NO - ERROR                                   
*                                                                               
FCIH132  DS    0H                  SAVE PRODUCT OVERRIDE CODE                   
         MVC   SVPRD1,0(R1)                                                     
*                                                                               
         CLI   EZIHCVP2,0          OVERRIDE PRODUCT 2                           
         BE    FCIH133             NO, SEE IF 3 CHAR OVERRIDE                   
*                                                                               
         LA    R1,SVCLIST                                                       
         LA    R2,EZIHCVP2                                                      
         BRAS  RE,LKBYBIN          GET 3-CHAR PRD CODE                          
         BE    FCIH134             GOT IT - GO SAVE IT                          
*                                                                               
         LA    R2,EZIHPRDN                                                      
         B     FCIH150                                                          
*                                                                               
FCIH133  DS    0H                                                               
         CLI   EZSPTNET,C'N'       NETWORK?                                     
         BNE   FCIH140             NO                                           
         LA    R1,EZIHSPR2                                                      
         CLC   EZIHSPR2,SPACES     GOT 3-CH PRD2 OVERRIDE?                      
         BNH   FCIH140             NO                                           
*                                                                               
FCIH134  DS    0H                  SAVE PRODUCT 2 OVERRIDE                      
         MVC   SVPRD2,0(R1)                                                     
*                                                                               
* ACTUAL LOOKUP HERE                                                            
* AT THIS POINT SVPRD1 (2 - OPTIONAL) *MUST* HAVE PRODUCT CODES IN THEM         
*                                                                               
FCIH140  DS    0H                                                               
*        TM    EZLOOKSW,EZLNOPRD   TEST SKIP PRD LOOKUP                         
*        BNZ   FCIH200                                                          
*                                                                               
         LA    R2,EZIHPRDN         POINT TO AGY PROD NAME                       
         LA    R1,SVPRD1                                                        
         BRAS  RE,LKPRD            LOOK UP PRODUCT                              
         BNE   FCIH150                                                          
         MVC   EZIHLPRN,HPRDNAM    NAME                                         
         MVC   EZIHLPRC,HPRDCOD    CODE                                         
         MVC   EZIHLPRB,HPRDBIN    BINARY                                       
*                                                                               
         OC    SVPRD2,SVPRD2                                                    
         BZ    FCIH160                                                          
         LA    R1,SVPRD2                                                        
         BRAS  RE,LKPRD            LOOK UP PRODUCT                              
         BNE   FCIH150                                                          
         MVC   EZIHLP2N,HPRDNAM    NAME                                         
         MVC   EZIHLP2C,HPRDCOD    CODE                                         
         MVC   EZIHLP2B,HPRDBIN    BINARY                                       
         B     FCIH160             PROCEED TO ESTIMATE                          
*                                                                               
FCIH150  DS    0H                  PRODUCT MISSING ERROR                        
         MVI   EZERRCD,EZERMPRD                                                 
         OI    EZIHLKST,EZIHLPNF                                                
         B     SETERRB                                                          
*                                                                               
FCIH160  DS    0H                  ESTIMATE                                     
         MVI   SVEST,X'00'                                                      
*                                                                               
         CLI   EZESTOPT,C'Y'       USING ESTIMATES?                             
         BE    *+12                                                             
         CLI   EZESTOPT,C'E'       REQUIRING ESTIMATES?                         
         BNE   FCIH190                                                          
*                                                                               
         TM    EZIHCVST,EZIHCOVR   ANY OVERRIDES                                
         BZ    FCIH170                                                          
         CLI   EZIHCVES,0          EST OVERRIDE                                 
         BE    FCIH200                                                          
         MVC   SVEST,EZIHCVES                                                   
         B     FCIH180                                                          
*                                                                               
FCIH170  DS    0H                                                               
         CLC   EZIHEST,SPACES                                                   
         BNH   FCIH200                                                          
         LA    R2,EZIHEST                   AGENCY ESTIMATE                     
*                                                                               
         CLI   3(R2),C' '          MORE THAN 3 DIGITS?                          
         BH    FCIH200             YES, DON'T EVEN BOTHER                       
*                                                                               
         LA    R3,L'EZIHEST        GET LENGTH                                   
         MVI   NUMERRSW,C'N'       SET DONT CARE ABOUT ERRORS                   
         XC    NUMMAX,NUMMAX                                                    
         BRAS  RE,CVTNUM                                                        
         CLI   FULL+3,X'00'                                                     
         BE    FCIH200                                                          
         CLC   FULL,=F'255'                                                     
         BH    *+10                                                             
         MVC   SVEST,FULL+3                                                     
*                                                                               
FCIH180  DS    0H                                                               
         LA    R1,SVEST                                                         
         BRAS  RE,LKEST                                                         
         BE    FCIH190                                                          
         LA    R2,EZIHEST          POINT TO AGY EST FIELD                       
         MVI   EZERRCD,EZERRENF                                                 
         OI    EZIHLKST,EZIHLENF                                                
         B     SETERRB                                                          
*                                                                               
FCIH190  DS    0H                                                               
         MVC   EZIHBEST,SVEST                                                   
*                                                                               
FCIH200  DS    0H                                                               
         TM    EZLOOKSW,EZLNOREP   TEST SKIP REP LOOKUP                         
         BNZ   FCIH220                                                          
*                                                                               
         CLI   SKIPVAL,C'Y'                                                     
         BE    FCIH220                                                          
*                                                                               
         CLI   EZREPOPT,C'Y'      ARE WE CONVERTING REPS?                       
         BNE   FCIH220                                                          
*                                                                               
         XC    EZIHLREP,EZIHLREP                                                
*                                                                               
* PAYING REP                                                                    
*                                                                               
         LA    R2,EZBLOCKD                                                      
         AHI   R2,EZIHPREP-EZBLOCKD R2=ADDR OF REP FIELD                        
*                                                                               
         OC    EZIHSREP,EZIHSREP   ANY OVERRIDES?                               
         BZ    *+12                NO - SKIP                                    
         LA    R2,EZIHSREP                                                      
         B     FCIH212                                                          
*                                                                               
         CLI   EZSPTNET,C'N'       IF NETWORK, NO TRADE REPS                    
         BE    FCIH210                                                          
*                                                                               
* NO OVERRIDE - SEE IF WE'RE DOING TRADE REPS                                   
*                                                                               
         CLI   EZTRDREP,C'Y'      ARE WE CONVERTING TRADE REPS?                 
         BNE   FCIH210                                                          
*                                                                               
* SEE IF WE HAVE "TRADE" IN THE ORDER TYPE FIELD                                
         LA    R1,EZIHORD                                                       
         ST    R1,FULL                                                          
         LHI   R1,L'EZIHORD                                                     
         STH   R1,HALF                                                          
         LA    R0,=C'TRADE'                                                     
         ICM   R0,8,=X'05'                                                      
         BRAS  RE,SUBSTR                                                        
         BNE   FCIH210                                                          
*                                                                               
* SEE IF DAR PROFILE IS SET UP                                                  
*                                                                               
         MVI   EZERRCD,EZERRDAR                                                 
         CLC   SVDARREP,SPACES     DAR PROFILE SET UP?                          
         BNH   SETERRB             NO:ERROR - CAN'T CONVERT INVOICE             
*                                                                               
         CLC   0(3,R2),SPACES      ANYTHING?                                    
         BH    *+12                YES- COMPARE IT TO DAR PROFILE               
         LA    R2,SVDARREP         NO - GET THE CODE FROM DAR PROFILE           
         B     FCIH212             GOT OUR CODE - DONE                          
*                                                                               
         MVI   EZERRCD,EZERDREP                                                 
         CLC   SVDARREP,0(R2)      SENT CODE SAME AS DAR PROFILE?               
         BNE   SETERRB             NO:ERROR - CAN'T CONVERT INVOICE             
         B     FCIH212             YES - DONE                                   
*                                                                               
* NON-TRADE REP PROCESSING LOGIC                                                
*                                                                               
FCIH210  DS    0H                                                               
         CLC   0(L'EZIHPREP,R2),SPACES                                          
         BNH   FCIH220                                                          
*                                                                               
FCIH212  DS    0H                                                               
         CLC   =C'###',0(R2)                                                    
         BE    FCIH220                                                          
*                                                                               
         BRAS  RE,LKREP                                                         
         BE    FCIH215                                                          
*                                                                               
         LA    R2,EZBLOCKD                                                      
         AHI   R2,EZIHPREP-EZBLOCKD R2=ADDR OF REP FIELD                        
         MVI   EZERRCD,EZERREP        REP NOT FOUND                             
         B     SETERRB                                                          
*                                                                               
FCIH215  DS    0H                                                               
         MVC   EZIHLREP,WORK                                                    
*                                                                               
FCIH220  DS    0H                                                               
         CLI   EZSPTNET,C'N'       IF NOT NETWORK, DONT'T LOOK FOR PKG          
         BNE   FCIH240                                                          
*                                                                               
         LA    R2,EZIHNPKG         NETWORK PACKAGE                              
         LA    R3,L'EZIHNPKG                                                    
*                                                                               
         CLC   EZIHNPKG,SPACES     HAVE NET PKG IN PROPER PLACE?                
         BH    FCIH230             YES - KEEP GOING                             
*                                                                               
         CLC   EZIHNET,SPACES      ANYTHING IN NET LOCAL CBL FIELD?             
         BNH   FCIH240             NO - SKIP TO ESTIMATE                        
         LA    R2,EZIHNET                                                       
         LA    R3,L'EZIHNET        GET LENGTH                                   
*                                                                               
FCIH230  DS    0H                                                               
         MVC   NUMMAX,=F'255'                                                   
         BRAS  RE,CVTNUM                                                        
         BE    *+8                                                              
         BAS   RE,SETERR           RETURN HERE                                  
*                                                                               
         MVC   EZIHBPKG,FULL+3                                                  
*                                                                               
FCIH240  DS    0H                                                               
FCIH250  DS    0H                                                               
FCIH280  DS    0H                                                               
FCIH300  DS    0H                                                               
FCIH320  DS    0H                                                               
* GET START AND END OF MONTH                                                    
*                                  SET MOS START AND END                        
         MVC   DUB(4),EZIHMON                                                   
         MVC   DUB+4(2),=C'15'     15TH MUST BE IN BRDMON                       
         GOTO1 DATCON,DMCB,(0,DUB),(0,WORK)                                     
*                                                                               
         NI    EZLOOKSW,X'FF'-EZLCALEN  SET OFF CALENDAR SW                     
*                                                                               
         CLI   EZSPTNET,C'N'       IF NOT NETPAK                                
         BNE   FCIH360                                                          
*                                                                               
         CLC   =AL2(AGYALPH_WS),EZAGY                                           
         BNE   *+14                                                             
         CLC   =C'FOXB',EZEQVSTA                                                
         BE    FCIH360                                                          
*                                                                               
         CLC   =AL2(AGYALPH_H7),EZAGY                                           
         BE    *+14                                                             
         CLC   =AL2(AGYALPH_FR),EZAGY                                           
         BNE   *+14                                                             
         CLC   =C'EABC',EZEQVSTA                                                
         BE    FCIH340                                                          
*                                                                               
         CLC   =C'CW',EZEQVSTA     CW* STATIONS ARE CALENDAR                    
         BE    FCIH340                                                          
         CLC   =C'MY',EZEQVSTA     MY* STATIONS ARE CALENDAR                    
         BNE   *+14                NON-'MY' STATIONS ARE BROADCAST              
         CLC   =AL2(AGYALPH_H7),EZAGY 'MY' AND NON-MINDSHARE = CALENDAR         
         BNE   FCIH340        MINDSHARE'S 'MY' INVOICES ARE *BROADCAST*         
*                                                                               
         LA    R0,NETABLN                                                       
         LA    R1,NETABLE                                                       
         CLC   EZEQVSTA(4),0(R1)   EQV STATION, NOT BATCH!                      
         BE    FCIH340                                                          
         LA    R1,4(,R1)                                                        
         BCT   R0,*-14                                                          
         B     FCIH360              GET BROADCAST MONTH                         
*                                                                               
NETABLE  DC    C'ABC.CBS.FOX.NBC.UPN.WBN.WBK.FOXBMNT '                          
         DC    C'ABC CBS FOX NBC UPN WBN WBK FOXBMNT '                          
NETABLN  EQU   (*-NETABLE)/4                                                    
*                                                                               
* GET START AND END OF CALENDAR MONTH *                                         
*                                                                               
FCIH340  DS    0H                                                               
* DSNTK-50: AGENCY ST, STATION UPN IS ALWAYS BROADCAST                          
         CLC   EZAGY,=AL2(AGYALPH_ST)                                           
         BNE   *+14                                                             
         CLC   EZEQVSTA(4),=C'UPN '                                             
         BE    FCIH360                                                          
*                                                                               
         OI    EZLOOKSW,EZLCALEN    SET ON CALENDAR SW                          
         MVC   WORK+12(4),DUB                                                   
         MVC   WORK+16(2),=C'01'                                                
         GOTO1 ADDAY,DMCB,WORK+12,(X'20',WORK+18),F'31'                         
*                                                                               
FCIH350  GOTO1 ADDAY,DMCB,WORK+18,(X'20',WORK+18),F'-1'                         
         CLC   WORK+12(4),WORK+18                                               
         BNE   FCIH350                                                          
         B     FCIH370                                                          
*                                                                               
FCIH360  DS    0H                                                               
         GOTO1 GETBROAD,DMCB,(1,WORK),WORK+12,GETDAY,ADDAY                      
*                                                                               
FCIH370  DS    0H                                                               
         GOTO1 DATCON,DMCB,(0,WORK+12),(2,EZIHCMST)                             
         GOTO1 DATCON,DMCB,(0,WORK+18),(2,EZIHCMEN)                             
         B     FCIH390                                                          
*                                                                               
FCIH380  DS    0H                                                               
         MVI   EZERRCD,EZERBRDT                                                 
         LA    R2,EZIHMON                                                       
         OI    EZIHLKST,EZIHBRDT   SET TO REJECT ENTIRE INVOICE                 
         BAS   RE,SETERRB                                                       
*                                                                               
FCIH390  DS    0H                                                               
* INITIALIZE INVOICE AS INTEGRATION ONLY.  IF COST IS PRESENT                   
* ON ANY OF THE SPOTS, SIMPLY TURN THE FLAG OFF                                 
* ALSO TURN OFF THE FLAG IF THERE ARE NO SPOTS                                  
* OR IF THE INTEGRATION FIELDS ARE ALL EMPTY                                    
         OI    EZIHFLG,EZIHINTQ                                                 
         NI    EZIHFLG,X'FF'-EZIHIPQ                                            
*                                                                               
         LA    R2,EZIHSTP          SALES TAX PCT                                
         LA    R3,L'EZIHSTP        GET LENGTH                                   
         GOTO1 CASHVAL,DMCB,(2,EZIHSTP),(R3)                                    
         CLI   DMCB,X'FF'          FIELD OK                                     
         BE    *+12                                                             
         MVI   EZERRCD,EZERRINV                                                 
         B     SETERRB                                                          
*                                                                               
         MVC   EZIHBSTP,DMCB+4     SET VALUE                                    
*                                                                               
         LA    R2,EZIHAUDP         AUDIENCE PCT                                 
         LA    R3,L'EZIHAUDP       GET LENGTH                                   
         MVI   NUMERRSW,C'Y'                                                    
         XC    NUMMAX,NUMMAX                                                    
         BRAS  RE,CVTNUM                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
*                                                                               
         MVC   EZIHBAUD,FULL       SET VALUE                                    
*                                                                               
         CLI   EZIHCVES,0          WAS OVERRIDE EST ENTERED                     
         BNE   FCX                  YES, THAT IS ALREADY VALIDATED              
*                                                                               
         CLI   EZSPTNET,C'N'       IF NETPAK                                    
         BE    FCIH400             DO NOT REQUIRE ESTIMATE                      
*                                                                               
         CLC   EZAGY,=AL2(AGYALPH_FR)   FDMJW                                   
         BE    FCIH450              YES                                         
         CLC   EZAGY,=AL2(AGYALPH_JW)   JWT                                     
         BE    FCIH450              YES                                         
         CLC   EZAGY,=AL2(AGYALPH_H7)   MINDSHARE                               
         BE    FCIH450              NO                                          
*                                                                               
FCIH400  DS    0H                                                               
         CLI   EZIHBEST,0          NO ESTIMATE - IGNORE                         
         BE    FCX                                                              
*                                                                               
FCIH450  DS    0H                                                               
         CLI   EZIHBEST,0          CAN'T BE ZERO                                
         BE    FCESTERR                                                         
* SEE IF ESTIMATE IS ON FILE                                                    
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),EZBAGYMD                                                
         MVC   KEY+2(2),EZIHLADB                                                
         MVC   KEY+4(3),EZIHAPID                                                
         OC    KEY+4(3),SPACES                                                  
         MVC   KEY+7(1),EZIHBEST                                                
         BAS   RE,HIGH                                                          
*                                                                               
         CLC   EZAGY,=AL2(AGYALPH_FR)   FDMJW                                   
         BE    FCIH460              YES                                         
         CLC   EZAGY,=AL2(AGYALPH_JW)   JWT                                     
         BE    FCIH460              YES                                         
         CLC   EZAGY,=AL2(AGYALPH_H7)   MINDSHARE                               
         BNE   FCIH480              YES                                         
*                                                                               
FCIH460  DS    0H         FOR THESE THREE AGENCIES MAKE SURE EST EXISTS         
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FCESTERR            IF NOT - ERROR                               
         B     FCX                 IF THERE - JUST EXIT                         
*                                                                               
FCIH480  DS    0H                                                               
* ESTIMATE SHOULD HAVE BEEN VALIDATED BY LKEST                                  
* IF CAN'T BE FOUND - WE HAVE A PROBLEM                                         
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FCESTERR                                                         
*                                                                               
         BAS   RE,GET                                                           
         L     R6,EZAREC           GET RECORD ADDR                              
         LA    R5,ESTART-ESTHDR(R6)                                             
         GOTO1 DATCON,DMCB,(0,(R5)),(2,DUB)                                     
         GOTO1 DATCON,DMCB,(0,6(R5)),(2,DUB+2)                                  
*                                                                               
* 06/16/2005 RELAXING INVOICE MOS VS EST DATES CHECK                            
* WILL ONLY MAKE SURE THE TWO PERIODS OVERLAP                                   
* TO BE CONSISTENT WITH THE CONVERT PROGRAM                                     
*                                                                               
         CLC   DUB(L'EZIHCMEN),EZIHCMEN     EST START AFTER MOS END?            
         BH    FCESTDAT            YES - ERROR                                  
         CLC   DUB+2(L'EZIHCMST),EZIHCMST   EST END BEFORE MOS START?           
         BL    FCESTDAT            YES - ERROR, OK OTHERWISE                    
         B     FCX                                                              
*                                                                               
* INVOICE DATES OUTSIDE ESTIMATE DATES ON SPOT SYSTEM                           
*                                                                               
FCESTDAT MVI   EZERRCD,EZERREDT                                                 
         LA    R2,EZIHMON                                                       
         OI    EZIHLKST,EZIHLEDT   SET TO REJECT ENTIRE INVOICE                 
         B     SETERRB                                                          
*                                                                               
* NO ESTIMATE ON SPOT SYSTEM                                                    
*                                                                               
FCESTERR MVI   EZERRCD,EZERRENF                                                 
         LA    R2,EZIHEST                                                       
         OI    EZIHLKST,EZIHLENF                                                
         B     SETERRB                                                          
*                                                                               
*        SCHEDULE LINE FIELDS                                                   
*        --------------------                                                   
*                                                                               
FCSL     DS    0H                                                               
         L     RF,EZIHTSLN         BUMP SCHEDULE LINE COUNT                     
         LA    RF,1(RF)            FOR INVOICE TOTALS                           
         ST    RF,EZIHTSLN                                                      
*                                                                               
         LA    R2,EZSLDAYS         DAYS OF WEEK                                 
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCSL4                                                            
*                                  SET DAY BITS                                 
         LA    RF,X'40'            MONDAY                                       
         SR    R0,R0                                                            
         LR    RE,R2                                                            
*                                                                               
         CLI   0(RE),C'A'          LETTER OR HIGHER                             
         BL    *+6                 MEANS DAY IS ACTIVE                          
         OR    R0,RF                                                            
         LA    RE,1(RE)                                                         
         SRA   RF,1                NEXT DAY                                     
         BNZ   FCSL4                                                            
         STC   R0,EZSLBDYS                                                      
*                                                                               
         GOTO1 DAYUNPK,DMCB,EZSLBDYS,EZSLDDYS      FOR DISPLAY                  
*                                                                               
FCSL4    DS    0H                  START-END TIMES                              
         LA    R2,EZSLSTIM         START TIME                                   
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT TIME                
         BAS   RE,CVTTIM                                                        
         MVC   EZSLBSTM,HALF                                                    
*                                                                               
         LA    R2,EZSLETIM         END TIME                                     
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT TIME                
         BAS   RE,CVTTIM                                                        
         MVC   EZSLBETM,HALF                                                    
         GOTO1 UNTIME,DMCB,EZSLBSTM,EZSLDTIM                                    
*                                                                               
FCSL6    DS    0H                                                               
         LA    R2,EZSLRATE         RATE                                         
         LA    R3,L'EZSLRATE       LENGTH                                       
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   EZSLBRAT,FULL                                                    
*                                                                               
         L     RF,EZIHTSLC         BUMP SCHEDULE COST TOTAL                     
         A     RF,FULL             FOR INVOICE TOTALS                           
         ST    RF,EZIHTSLC                                                      
*                                                                               
         ICM   RF,15,FULL                                                       
         CVD   RF,DUB                                                           
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZIHPSLC-EZBLOCKD                                             
         AP    0(8,RF),DUB                                                      
*                                                                               
         LA    R2,EZSLNTMS         TIMES PER MONTH                              
         LA    R3,L'EZSLNTMS       GET LENGTH                                   
         XC    NUMMAX,NUMMAX                                                    
         BRAS  RE,CVTNUM                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
*                                                                               
         MVC   EZSLBTMS,FULL+2     SET VALUE                                    
*                                                                               
FCSLX    DS    0H                                                               
         B     FCX                                                              
*                                                                               
*        SPOT DETAIL FIELDS                                                     
*        ------------------                                                     
*                                                                               
FCSP     DS    0H                                                               
         CLI   EZSPRUN,C'N'        TEST DID NOT RUN                             
         BE    FCSP02              IF NOT DO NOT COUNT                          
*                                                                               
         L     RF,EZSLTSPN         BUMP SPOT COUNT                              
         LA    RF,1(RF)            FOR SCHEDULE LINE                            
         ST    RF,EZSLTSPN                                                      
*                                                                               
         L     RF,EZIHTSPN         AND  FOR INVOICE                             
         LA    RF,1(RF)                                                         
         ST    RF,EZIHTSPN                                                      
*                                                                               
FCSP02   DS    0H                                                               
         LA    R2,EZSPDATE         DATE                                         
         BAS   RE,TSTANY           TEST THERE                                   
         BNZ   FCSP04                                                           
         MVI   BYTE,1              THIS IS AN IMPORTANT DATE                    
         BAS   RE,CVTDAT                                                        
         BNE   FCSP04                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(0,EDATE),(5,EZSPDDT)                                
         GOTO1 DATCON,DMCB,EDATE,(2,EZSPCDT)   COMPRESSED                       
*                                                                               
         CLC   EZSPCDT,EZIHCMST      TEST WITHIN MONTH OF SERVICE               
         BL    FCSP03                                                           
         CLC   EZSPCDT,EZIHCMEN                                                 
         BNH   FCSP04                                                           
*                                                                               
FCSP03   DS    0H                                                               
         MVI   EZERRCD,EZERROMN    OUT OF MONTH ERROR                           
         LA    R2,EZSPDATE                                                      
         BAS   RE,SETERR                                                        
*                                                                               
FCSP04   DS    0H                                                               
*                                                                               
         LA    R2,EZSPDAY          DAY OF WEEK                                  
         BAS   RE,TSTANY           MUST BE THERE                                
         BNZ   FCSP07                                                           
*                                                                               
         CLI   0(R2),C'1'          MONDAY                                       
         BL    FCSP06                                                           
         CLI   0(R2),C'7'          SUNDAY                                       
         BH    FCSP06                                                           
*                                                                               
         MVC   BYTE,0(R2)                                                       
         NI    BYTE,X'0F'                                                       
         ZIC   RF,BYTE                                                          
         LA    RF,BINDAYS-1(RF)                                                 
         MVC   EZSPBDAY,0(RF)                                                   
         GOTO1 DAYUNPK,DMCB,EZSPBDAY,EZSPDDAY      FOR DISPLAY                  
         B     FCSP07                                                           
*                                                                               
BINDAYS  DC    X'40201008040201'   DAYS OF WEEK                                 
*                                                                               
FCSP06   DS    0H                                                               
         MVI   EZERRCD,EZERRINV                                                 
         BAS   RE,SETERR                                                        
*                                                                               
FCSP07   DS    0H                                                               
         MVC   EZSPTIM,EZSPTIMT    NEW FIELD WITH TIME PRECEDED BY T            
         CLI   EZSPTIMT,C'T'                                                    
         BNE   *+10                                                             
         MVC   EZSPTIM,EZSPTIMT+1                                               
*                                                                               
         LA    R2,EZSPTIMT         TIME OF DAY                                  
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(L'EZSPTIMT),EZSPTIMT                                        
         MVC   EZSPTIMT,SPACES                                                  
         MVC   EZSPTIMT(4),EZSPTIM                                              
*                                                                               
         MVC   EZSPDTIM,SPACES                                                  
*                                                                               
         CLC   EZSPTIM,SPACES                                                   
         BE    FCSP07B                                                          
         OC    EZSPTIM,EZSPTIM                                                  
         BZ    FCSP07B                                                          
*                                                                               
         LA    R0,4                                                             
         LA    R1,EZSPTIM                                                       
FCSP07A  DS    0H                                                               
         CLI   0(R1),C'0'                                                       
         BL    FCSP07B                                                          
         CLI   0(R1),C'9'                                                       
         BH    FCSP07B                                                          
         LA    R1,1(,R1)                                                        
         BCT   R0,FCSP07A                                                       
         B     FCSP08                                                           
*                                                                               
FCSP07B  DS    0H                                                               
         CLI   EZSPRUN,C'N'        TEST SPOT DID NOT RUN                        
         BE    FCSP09                                                           
         MVC   EZSPDTIM,=C'*****'                                               
         B     FCSP09                                                           
*                                                                               
FCSP08   DS   0H                                                                
         MVI   BYTE,1              THIS IS  AN IMPORTANT TIME                   
         BAS   RE,CVTTIM                                                        
         MVC   EZSPBTIM,HALF                                                    
         MVC   FULL(2),HALF                                                     
         XC    FULL+2(2),FULL+2                                                 
         GOTO1 UNTIME,DMCB,FULL,EZSPDTIM                                        
*                                                                               
FCSP09   DS   0H                                                                
         MVC   EZSPTIMT,WORK                                                    
*                                                                               
         LA    R2,EZSPTYP          TYPE (SPOT LENGTH)                           
         LA    R3,L'EZSPTYP        GET LENGTH                                   
         MVI   NUMERRSW,C'Y'                                                    
         MVC   NUMMAX,=F'255'                                                   
         BRAS  RE,CVTNUM                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
*                                                                               
         MVC   EZSPBSLN,FULL+3                                                  
*                                                                               
         CLI   EZSPBSLN,0          SPOT LENGTH = ZERO                           
         BNE   FCSP10                IT IS OK                                   
         MVI   EZERRCD,EZERRSPL                                                 
         BAS   RE,SETERR                                                        
*                                                                               
FCSP10   DS    0H                                                               
         LA    R2,EZSPPGB          PIGGYBACK SPLIT                              
         CLI   0(R2),C' '          IF NOTHING                                   
         BNH   FCSP12                                                           
         MVC   WORK(6),EZSPPGB                                                  
         OC    WORK(6),=6C'0'                                                   
         PACK  DUB,WORK(3)         FIRST LENGTH                                 
         CVB   R0,DUB                                                           
         STC   R0,EZSPBPG1                                                      
         PACK  DUB,WORK+3(3)       2ND LENGTH                                   
         CVB   R0,DUB                                                           
         STC   R0,EZSPBPG2                                                      
*                                                                               
FCSP12   DS    0H                                                               
         LA    R2,EZSPRATE         RATE                                         
         LA    R3,L'EZSPRATE       LENGTH                                       
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   EZSPBRAT,FULL                                                    
*                                                                               
         CLI   EZSPRUN,C'N'        TEST DID NOT RUN                             
         BE    FCSP14               IF NOT DO NOT COUNT                         
*                                                                               
         L     RF,EZSLTSPC         BUMP SPOT COST TOTAL                         
         A     RF,FULL             FOR SCHEDULE TOTALS                          
         ST    RF,EZSLTSPC                                                      
*                                                                               
         L     RF,EZIHTSPC         AND FOR INVOICE                              
         A     RF,FULL                                                          
         ST    RF,EZIHTSPC                                                      
*                                                                               
         ICM   RF,15,FULL                                                       
         CVD   RF,DUB                                                           
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZIHPSPC-EZBLOCKD                                             
         AP    0(8,RF),DUB                                                      
*                                  ADJUSTMENTS                                  
FCSP14   DS    0H                                                               
         LA    R2,EZSPADR          DEBIT                                        
         LA    R3,L'EZSPADR        LENGTH                                       
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   EZSPBDR,FULL                                                     
*                                                                               
         L     RF,EZSLTDR          BUMP DEBIT TOTALS                            
         A     RF,FULL             FOR SCHEDULE TOTALS                          
         ST    RF,EZSLTDR                                                       
*                                                                               
         L     RF,EZIHTDR          AND FOR INVOICE                              
         A     RF,FULL                                                          
         ST    RF,EZIHTDR                                                       
*                                  UPDATE PACKED COUNTERS TOO                   
         ICM   RF,15,FULL                                                       
         CVD   RF,DUB                                                           
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZIHPDR-EZBLOCKD                                              
         AP    0(8,RF),DUB                                                      
*                                                                               
         LA    R2,EZSPACR          CREDIT                                       
         LA    R3,L'EZSPACR        LENGTH                                       
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         L     RF,FULL             COMPLEMENT CR AMOUNT                         
         LTR   RF,RF                                                            
         BNP   *+10                IF NOT ALREADY NEGATIVE                      
         LCR   RF,RF                                                            
         ST    RF,FULL                                                          
         MVC   EZSPBCR,FULL                                                     
*                                                                               
         L     RF,EZSLTCR          BUMP CREDIT TOTALS                           
         A     RF,FULL             FOR SCHEDULE TOTALS                          
         ST    RF,EZSLTCR                                                       
*                                                                               
         L     RF,EZIHTCR          AND FOR INVOICE                              
         A     RF,FULL                                                          
         ST    RF,EZIHTCR                                                       
*                                  UPDATE PACKED COUNTERS TOO                   
         ICM   RF,15,FULL                                                       
         CVD   RF,DUB                                                           
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZIHPCR-EZBLOCKD                                              
         AP    0(8,RF),DUB                                                      
*                                  NETWORK INTEGRATION COST                     
         LA    R2,EZSPNINT         INTEGRATION COST                             
         LA    R3,L'EZSPNINT       LENGTH                                       
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   EZSPBINT,FULL                                                    
*                                                                               
         CLC   EZSPNINT,SPACES     ANYTHING IN INTEG COST FIELD?                
         BNH   FCSP16A             NOTHING, TURN OFF INT-ONLY FLAG              
*                                                                               
         OC    EZSPBINT,EZSPBINT   INTEGRATION CHARGE PRESENT?                  
         BZ    *+8                 NO                                           
         OI    EZIHFLG,EZIHIPQ     TURN ON INTEGRATION CHARGE FLAG              
*                                                                               
         CLC   =C'ABC ',EZEQVSTA                                                
         BE    FCSP16                                                           
         CLC   =C'NBC ',EZEQVSTA                                                
         BE    FCSP16                                                           
         CLC   =C'CBS ',EZEQVSTA                                                
         BNE   FCSP16A                                                          
*                                                                               
FCSP16   DS    0H                                                               
         OC    EZSPBRAT,EZSPBRAT   COST = 0?                                    
         BZ    *+8                                                              
*                                                                               
FCSP16A  DS    0H                                                               
         NI    EZIHFLG,X'FF'-EZIHINTQ  TURN OFF INT-ONLY FLAG                   
*                                                                               
FCSP16B  DS    0H                                                               
* ADD INTEGRATION CHARGES TO SPOT, INVOICE TOTALS                               
         L     RF,EZSLTSPC         BUMP SPOT COST TOTAL                         
         A     RF,FULL             FOR SCHEDULE TOTALS                          
         ST    RF,EZSLTSPC                                                      
*                                                                               
         L     RF,EZIHTSPC         AND FOR INVOICE                              
         A     RF,FULL                                                          
         ST    RF,EZIHTSPC                                                      
*                                  ADJUSTMENTS                                  
         ICM   RF,15,FULL                                                       
         CVD   RF,DUB                                                           
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZIHPSPC-EZBLOCKD                                             
         AP    0(8,RF),DUB                                                      
*                                  MAKEGOOD DATA                                
         LA    R2,EZSPMGD1         DATE 1                                       
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCSP17                                                           
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BNE   FCSP17                                                           
*                                                                               
         MVC   EZSPDMD1,DDATE      MMMDD/YY                                     
*                                                                               
FCSP17   DS    0H                                                               
         LA    R2,EZSPMGD2         DATE 2                                       
         CLI   0(R2),C' '          TEST THERE                                   
         BNH   FCSP17B                                                          
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT DATE                
         BAS   RE,CVTDAT           CONVERT DATE                                 
         BNE   FCSP17B                                                          
*                                                                               
         MVC   EZSPDMD2,DDATE      MMMDD/YY                                     
*                                                                               
FCSP17B  DS    0H                                                               
         XC    WORK(4),WORK                                                     
         LA    R2,EZSPMGT1         M/G START TIME                               
         CLI   0(R2),C' '                                                       
         BNH   FCSP17D                                                          
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT TIME                
         BAS   RE,CVTTIM                                                        
         MVC   WORK(2),HALF                                                     
FCSP17D  DS    0H                                                               
         LA    R2,EZSPMGT2         END TIME                                     
         CLI   0(R2),C' '                                                       
         BNH   FCSP17F                                                          
         MVI   BYTE,0              THIS IS NOT AN IMPORTANT TIME                
         BAS   RE,CVTTIM                                                        
         MVC   WORK+2(2),HALF                                                   
*                                                                               
FCSP17F  DS    0H                                                               
         OC    WORK(4),WORK                                                     
         BZ    FCSP18                                                           
         GOTO1 UNTIME,DMCB,WORK,EZSPDMTM                                        
*                                                                               
FCSP18   DS    0H                  COMMERCIALS                                  
         BRAS  RE,XCCML                                                         
*                                                                               
         CLI   EZCMLOPT,C'N'       DON'T USE CMLS AT ALL                        
         BE    FCSP108                                                          
*                                                                               
         CLC   EZSPCOPY,SPACES    ANY COMMERCIALS?                              
         BNH   FCSP39                                                           
*                                                                               
* SEE IF RUNNING FOR ARNOLD MPG FIDELITY                                        
         CLI   EZSPTNET,C'N'       NETWORK?                                     
         BNE   FCSP18B                                                          
         CLC   EZAGY,=AL2(AGYALPH_FM)                                           
         BNE   FCSP18B                                                          
         CLC   =C'FIDELITY',EZIHADVN                                            
         BNE   FCSP18B                                                          
         LA    R1,EZSPCOPY                                                      
         LA    R2,SVCMLS                                                        
         BRAS  RE,GETCMFM                                                       
         BE    FCSP19B                                                          
*                                                                               
FCSP18B  DS    0H                                                               
*                                                                               
* TRY FOR AD-IDS FIRST                                                          
*                                                                               
         OI    GBFLAG,GBSPACEQ                                                  
         BRAS  RE,GETADID          TRY FOR AD-IDS                               
         BNE   FCSP18F             PROCEED TO FILMCODES IF UNSUCCESSFUL         
*                                                                               
* GOT AD-ID(S) HERE                                                             
*                                                                               
         OI    EZSPLKST,EZSPADID                                                
*                                                                               
         GOTO1 TRPACK,DMCB,(C'P',GBADID1),SVCMLS                                
         BNE   FCSP18F       DOESN'T PACK - INVALID, GO WITH FILMCODES          
         MVC   EZSPCML1,SVCMLS                                                  
*                                                                               
         CLC   GBADID2,SPACES      GOT PIGGYBACK?                               
         BNH   FCSP28                                                           
*                                                                               
         GOTO1 TRPACK,DMCB,(C'P',GBADID2),SVCMLS+8                              
         BNE   FCSP18F                                                          
         MVC   EZSPCML2,SVCMLS+8                                                
*                                                                               
         B     FCSP28                                                           
*                                                                               
* NO AD-IDS HERE - PROCEED WITH FILMCODE LOGIC                                  
*                                                                               
FCSP18F  DS    0H                                                               
         BRAS  RE,XCCML                                                         
*                                                                               
         LA    R1,EZSPCOPY                                                      
         LA    R2,SVCMLS                                                        
*                                                                               
         CLC   =AL2(AGYALPH_MC),EZAGY                                           
         BE    FCSP19                                                           
         CLC   =AL2(AGYALPH_TH),EZAGY                                           
         BE    FCSP19                                                           
         CLC   =AL2(AGYALPH_G7),EZAGY                                           
         BE    FCSP19                                                           
         CLC   =AL2(AGYALPH_H9),EZAGY                                           
         BNE   FCSP19A                                                          
*                                                                               
FCSP19   BRAS  RE,GETCMOLD                                                      
         B     *+8                                                              
FCSP19A  BRAS  RE,GETCMMLS                                                      
*                                                                               
FCSP19B  OC    SVCMLS,SVCMLS       ANY COMMERCIALS FOUND?                       
         BZ    FCSP39              NO - CHECK CMML/PRD RELATIONSHIP             
* COMMERCIAL 1                                                                  
         CLC   =AL2(AGYALPH_MC),EZAGY                                           
         BE    FCSP20                                                           
         CLC   =AL2(AGYALPH_TH),EZAGY                                           
         BE    FCSP20                                                           
         CLC   =AL2(AGYALPH_G7),EZAGY                                           
         BE    FCSP20                                                           
         CLC   =AL2(AGYALPH_H9),EZAGY                                           
         BE    FCSP20                                                           
         CLI   SVCMLS+7,X'40'      COMMERCIAL LENGTH MUST BE 8                  
         BH    FCSP20              OK                                           
*                                                                               
         MVI   EZERRCD,EZERFILM    ELSE- SET INVALID FILMCODE                   
         LA    R2,EZSPCOPY         SET R2 TO COPY FIELD                         
         BAS   RE,SETERR                                                        
         B     FCSP39                                                           
*                                                                               
FCSP20   DS    0H                                                               
         CLI   EZCMLOPT,C'D'       ADDING AD-IDS?                               
         BE    *+12                                                             
         CLI   EZCMLOPT,C'A'       ADDING COMMERCIALS?                          
         BNE   FCSP28              NO, DON'T VALIDATE                           
*                                                                               
         LA    R1,SVCMLS           A(COMMERCIAL)                                
         LA    R2,EZSPCML1                                                      
         BRAS  RE,VALCML           CHECK STANDARD/NONSTANDARD                   
         BE    FCSP28                                                           
*                                                                               
         MVI   EZERRCD,EZERFILM    ELSE- SET INVALID FILMCODE                   
         LA    R2,EZSPCOPY         SET R2 TO COPY FIELD                         
         BAS   RE,SETERR                                                        
         B     FCSP39                                                           
*                                                                               
* LOOK UP THE COMMERCIAL RECORDS                                                
*                                                                               
FCSP28   DS    0H                  LOOKUP COMMERCIAL 1                          
         LA    R2,SVCMLS                                                        
         MVC   LKCMLPRM,GBADID1                                                 
         GOTO1 ALKCML                                                           
         BE    FCSP28A                                                          
*                                                                               
         TM    EZSPLKST,EZSPADID                                                
         BZ    FCSP28D                                                          
         CLI   EZCMLOPT,C'D'                                                    
         BE    FCSP28D                                                          
         B     FCSP18F                                                          
*                                                                               
FCSP28A  DS    0H                                                               
         MVC   EZSPCML1,0(R2)      FILMCODE                                     
         MVC   EZSPLCM1,HCMLDATA+CMDSEQ-CMDATAD                                 
         MVC   CMLPRDL1,HCMLDATA+CMD1PRDL-CMDATAD                               
         MVC   CML3PRL1,HCMLDATA+CMD3PRDL-CMDATAD                               
*                                                                               
         CLI   HCMLDATA+CMDSOLO-CMDATAD,C'P' PIGGYBACK?                         
         BNE   FCSP28B                                                          
         CLI   EZPROPT,C'P'        GET PRODUCT FROM CMML                        
         BNE   FCSP28B                                                          
*                                                                               
         MVC   CMLPRDL2,HCMLDATA+CMD1PGB-CMDATAD                                
         MVC   CML3PRL2,HCMLDATA+CMD3PGB-CMDATAD                                
         MVI   EZSPPIG,C'Y'                                                     
*                                                                               
FCSP28B  DS    0H                                                               
         CLI   0(R2),X'00'         FIRST FILM VALID?                            
         BH    FCSP29              YES - PROCEED TO CHECK PIGGYBACK             
*                                                                               
FCSP28D  DS    0H                                                               
* NO - CLEAR 2ND FILM VARIABLES                                                 
         XC    SVCMLS,SVCMLS                                                    
         MVI   EZSPPIG,C'N'        SET NOT A PIGGY                              
         XC    EZSPCML2,EZSPCML2                                                
         XC    EZSPLCM2,EZSPLCM2                                                
         XC    CMLPRDL2,CMLPRDL2                                                
         XC    CML3PRL2,CML3PRL2                                                
         B     FCSP39                                                           
*                                                                               
* COMMERCIAL 2                                                                  
*                                                                               
FCSP29   DS    0H                                                               
         OC    SVCMLS+8(8),SVCMLS+8   HAVE 2ND COMMERCIAL?                      
         BZ    FCSP39                                                           
*                                                                               
         CLC   EZIHLPRC,SPACES     PRODUCT IN HEADER?                           
         BNH   FCSP30              NO - WE ARE OK                               
*                                                                               
         CLI   EZIHLPRB,X'FF'      POOL - WE ARE OK                             
         BE    FCSP30                                                           
         CLC   EZIHLP2C,SPACES     2ND PRODUCT IN HEADER?                       
         BH    FCSP30              NO - WE ARE OK                               
         XC    SVCMLS+8(8),SVCMLS+8  CLEAR THE 2ND COMML OTHERWISE              
         B     FCSP39                                                           
*                                                                               
FCSP30   DS    0H                                                               
         MVI   EZSPPIG,C'Y'        2ND COMMERCIAL = PIGGYBACK                   
*                                                                               
         TM    EZSPLKST,EZSPADID                                                
         BO    FCSP34                                                           
*                                                                               
         CLI   EZCMLOPT,C'D'       ADDING AD-IDS?                               
         BE    *+12                                                             
         CLI   EZCMLOPT,C'A'       ADDING COMMERCIALS?                          
         BNE   FCSP34                                                           
*                                                                               
         LA    R1,SVCMLS+8           A(COMPONENT)                               
         LA    R2,EZSPCML2                                                      
         BRAS  RE,VALCML                                                        
         BE    FCSP34                                                           
*                                                                               
         MVI   EZERRCD,EZERFILM    ELSE- SET INVALID FILMCODE                   
         LA    R2,EZSPCOPY         SET R2 TO COPY FIELD                         
         BAS   RE,SETERR                                                        
         B     FCSP39                                                           
*                                                                               
FCSP34   DS    0H                                                               
         LA    R2,SVCMLS+8                                                      
         MVC   LKCMLPRM,GBADID2                                                 
         GOTO1 ALKCML                                                           
         BE    FCSP34A                                                          
*                                                                               
         TM    EZSPLKST,EZSPADID                                                
         BO    FCSP18F                                                          
*                                                                               
FCSP34A  DS    0H                                                               
         MVC   EZSPCML2,0(R2)                                                   
         MVC   EZSPLCM2,HCMLDATA+CMDSEQ-CMDATAD                                 
         MVC   CMLPRDL2,HCMLDATA+CMD1PRDL-CMDATAD                               
         MVC   CML3PRL2,HCMLDATA+CMD3PRDL-CMDATAD                               
*                                                                               
*        CHECK RELATIONSHIPS BETWEEN PRODUCTS, FILMS, ETC                       
*        ------------------------------------------------                       
*                                                                               
FCSP39   DS    0H                  COPY ID (COMMERCIALS)                        
         OC    EZIHLADB,EZIHLADB   TEST HAVE VALID CLIENT                       
         BZ    FCSP108             NO- SKIP ALL TESTS                           
*                                                                               
         CLC   EZIHLPRC,=C'POL'                                                 
         BE    FCSP45                                                           
         LAY   RF,EZ5APROF                                                      
         CLI   EZ5ANPPD-EZ5APROF(RF),C'Y'  NON-POOL PRODUCTS IN DETLS?          
         BE    FCSP108                                                          
*                                                                               
FCSP45   DS    0H                                                               
         CLI   EZPROPT,C'Y'        GET PRODUCT FROM CMML                        
         BE    *+12                                                             
         CLI   EZPROPT,C'P'        GET PRODUCT - PIGGY VERSION?                 
         BNE   FCSP108                                                          
*                                                                               
         OC    EZSPLCM1,EZSPLCM1   TEST HAVE CMML                               
         BZ    FCSP70              NO - USE POL                                 
*                                                                               
         TM    EZLOOKSW,EZLNOPRD   TEST SKIP PRD LOOKUP                         
         BNZ   FCSP108                                                          
*                                                                               
         CLI   SKIPVAL,C'Y'                                                     
         BE    FCSP108                                                          
*                                                                               
         LA    R1,SVCLIST                                                       
         LA    R2,CMLPRDL1                                                      
         CLI   CMLPRDL1,X'00'                                                   
         BE    *+12                                                             
         BRAS  RE,LKBYBIN          GET 3-CHAR PRD CODE                          
         BE    FCSP50                                                           
         CLI   EZSPTNET,C'N'                                                    
         BNE   FCSP70                                                           
         LA    R1,CML3PRL1                                                      
         CLC   CML3PRL1,SPACES                                                  
         BNH   FCSP70                                                           
*                                                                               
FCSP50   DS    0H                                                               
         BRAS  RE,LKPRD            LOOK UP PRODUCT                              
         BNE   FCSP70                                                           
*                                                                               
         MVC   EZSPLPN1,HPRDNAM    NAME                                         
         MVC   EZSPLPC1,HPRDCOD    CODE                                         
         MVC   EZSPLPB1,HPRDBIN    BINARY                                       
         B     FCSP80              CHECK 2ND COMMERCIAL                         
*                                                                               
FCSP70   DS    0H                                                               
         MVC   EZSPLPN1(4),=C'POOL'                                             
         MVC   EZSPLPC1,=C'POL'                                                 
         MVI   EZSPLPB1,X'FF'                                                   
*                                                                               
FCSP80   DS    0H                                                               
         CLI   EZSPPIG,C'Y'        2ND COMMERCIAL - PIGGYBACK                   
         BNE   FCSP100                                                          
*                                                                               
         LA    R2,CMLPRDL2                                                      
         LA    R1,SVCLIST                                                       
         BRAS  RE,LKBYBIN          GET 3-CHAR PRD CODE                          
         BE    FCSP85                                                           
         CLI   EZSPTNET,C'N'                                                    
         BNE   FCSP90                                                           
         LA    R1,CML3PRL1                                                      
*                                                                               
FCSP85   DS    0H                                                               
         BRAS  RE,LKPRD            LOOK UP PRODUCT                              
         BNE   FCSP90                                                           
*                                                                               
         MVC   EZSPLPN2,HPRDNAM    NAME                                         
         MVC   EZSPLPC2,HPRDCOD    CODE                                         
         MVC   EZSPLPB2,HPRDBIN    BINARY                                       
         B     FCSP100                                                          
*                                                                               
FCSP90   DS    0H                                                               
         MVC   EZSPLPN2(4),=C'POOL'                                             
         MVC   EZSPLPC2,=C'POL'                                                 
         MVI   EZSPLPB2,X'FF'                                                   
*                                                                               
FCSP100  DS    0H                                                               
         LAY   RF,EZ5AEST                                                       
         CLI   0(RF),C'Y'                                                       
         BNE   FCSP108                                                          
*                                                                               
         MVI   BYTE,1                                                           
*                                                                               
         CLI   EZIHBEST,0          NO ESTIMATE - IGNORE                         
         BE    FCSP108                                                          
         CLI   EZPROPT,C'Y'        GET PRODUCT FROM CMML                        
         BE    *+12                                                             
         CLI   EZPROPT,C'P'        PRODUCT FROM CMML RECORDS?                   
         BNE   FCSP108             NO, DON'T BOTHER WITH PRD-EST CHECK          
*                                                                               
         XC    KEY,KEY                                                          
         LA    R1,KEY                                                           
         USING ESTHDR,R1                                                        
         MVC   EKEYAM,EZBAGYMD                                                  
         MVC   EKEYCLT,EZIHLADB    LOOKED UP CLIENT CODE                        
         MVC   EKEYPRD,EZSPLPC1    PRODUCT CODE                                 
         MVC   EKEYEST,EZIHBEST    ESTIMATE CODE                                
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FCSP106                                                          
*                                                                               
         CLI   EZSPPIG,C'Y'                                                     
         BNE   FCSP108                                                          
*                                                                               
         MVI   BYTE,2                                                           
         XC    KEY,KEY                                                          
         MVC   KEY(L'EKEY),KEYSAVE                                              
         MVC   EKEYPRD,EZSPLPC2    PRODUCT CODE                                 
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BE    FCSP108                                                          
*                                                                               
FCSP106  DS    0H                                                               
         LAY   R2,ERENOEST                                                      
         MVC   0(L'ERENOEST,R2),SPACES                                          
         EDIT  (B1,EZIHBEST),(3,0(R2))                                          
*                                                                               
         LAY   R2,ERENOPRD                                                      
         MVC   0(L'ERENOPRD,R2),SPACES                                          
         MVC   0(L'ERENOPRD,R2),EZSPLPC1                                        
         CLI   BYTE,2                                                           
         BNE   *+10                                                             
         MVC   0(L'ERENOPRD,R2),EZSPLPC2                                        
*                                                                               
         LAY   R2,ERENOCML                                                      
         MVC   0(L'ERENOCML,R2),SPACES                                          
*                                                                               
         TM    EZSPLKST,EZSPADID                                                
         BO    FCSP106A                                                         
         MVC   0(8,R2),SVCMLS                                                   
         CLI   BYTE,2                                                           
         BNE   FCSP107                                                          
         MVC   0(8,R2),SVCMLS+8                                                 
         B     FCSP107                                                          
*                                                                               
FCSP106A DS    0H                                                               
         GOTO1 TRPACK,DMCB,(C'U',SVCMLS),0(R2)                                  
         CLI   BYTE,2                                                           
         BNE   FCSP107                                                          
         GOTO1 TRPACK,DMCB,(C'U',SVCMLS+8),0(R2)                                
*                                                                               
FCSP107  DS    0H                                                               
         MVI   EZERRCD,EZERRENO                                                 
         LA    R2,EZSPCOPY                                                      
         BAS   RE,SETERR                                                        
*                                                                               
* ONLY PROCESS AUDIO, VIDEO COPY ID FOR DIGITAL BANDS                           
*                                                                               
FCSP108  DS    0H                                                               
         TM    EZLOOKSW,EZVALACT   VALIDATING ACTUALS?                          
         BZ    FCSP200                                                          
*                                                                               
         CLI   EZEQVSTA+4,C'S'                                                  
         BE    *+12                                                             
         CLI   EZEQVSTA+4,C'D'                                                  
         BNE   FCSP200                                                          
*                                                                               
* INITIALIZE TO X'FF'S - NO VALUE                                               
         LAY   RF,EZSXIMP                                                       
         MVC   0(4,RF),=X'FFFFFFFF'                                             
         LAY   RF,EZSXCLK                                                       
         MVC   0(4,RF),=X'FFFFFFFF'                                             
         LAY   RF,EZSXRAT                                                       
         MVC   0(4,RF),=X'FFFFFFFF'                                             
*                                                                               
* VIDEO COPY ID                                                                 
*                                                                               
         CLC   EZSPVCID,SPACES                                                  
         BNH   FCSP160                                                          
*                                                                               
         XC    X,X                                                              
         MVC   X(L'EZSPVCID),EZSPVCID                                           
         OC    X,SPACES                                                         
         XC    WORK,WORK                                                        
         GOTO1 SCANNER,DMCB,(C'C',X),(2,WORK),C',=|='                           
         LLC   R3,DMCB+4                                                        
         LTR   R3,R3                                                            
         BZ    FCSP155             ERROR                                        
*                                                                               
         LA    R2,WORK                                                          
         USING SCANBLKD,R2                                                      
*                                                                               
FCSP110  DS    0H                                                               
         CLI   SC1STFLD,C'I'       IMPRESSIONS?                                 
         BNE   FCSP120                                                          
*                                                                               
         LLC   R0,SC2NDLEN                                                      
         GOTO1 CASHVAL,DMCB,SC2NDFLD,(X'40',(R0))                               
         CLI   DMCB,X'FF'                                                       
         BE    FCSP155             ERROR                                        
*                                                                               
         CLC   =AL4(1),DMCB+4                                                   
         BH    FCSP155                                                          
         CLC   =AL4(99999),DMCB+4                                               
         BL    FCSP155                                                          
*                                                                               
         LAY   RE,EZSXIMP                                                       
         L     RF,DMCB+4                                                        
*                                                                               
         CLIY  P00A2DEC,C'Y'                                                    
         BNE   *+12                                                             
         MHI   RF,10                                                            
         OILH  GRF,X'4000'          OR IMMEDIATE(LO HI)                         
*                                                                               
         ST    RF,0(RE)                                                         
         B     FCSP130                                                          
*                                                                               
FCSP120  DS    0H                                                               
         CLI   SC1STFLD,C'R'       RATINGS?                                     
         BNE   FCSP130                                                          
*                                                                               
         LLC   R0,SC2NDLEN                                                      
         GOTO1 CASHVAL,DMCB,SC2NDFLD,(R0)                                       
         CLI   DMCB,X'FF'                                                       
         BE    FCSP155             ERROR                                        
*                                                                               
         CLC   DMCB+4(4),=AL4(1)                                                
         BL    FCSP155                                                          
         CLC   DMCB+4(4),=AL4(10000) 100.00                                     
         BH    FCSP155                                                          
*                                                                               
         LAY   RE,EZSXRAT                                                       
         MVC   0(L'EZSXRAT,RE),DMCB+4                                           
*                                                                               
FCSP130  DS    0H                  CHECK DEMOS                                  
         LAY   RF,EZIHDEM                                                       
         OC    0(L'EZIHDEM,RF),0(RF)     FIRST TIME?                            
         BNZ   *+14                YES, DO NOT CHECK                            
         MVC   0(L'EZIHDEM,RF),SC1STFLD+1  SAVE DEMO CATEGORY                   
         B     FCSP150                                                          
*                                                                               
         CLC   0(L'EZIHDEM,RF),SC1STFLD+1 SAME DEMO CATEGORY AS OTHERS?         
         BE    FCSP150                                                          
*                                                                               
         MVI   EZERRCD,EZERRDEM                                                 
         LA    R2,EZSPVCID                                                      
         BAS   RE,SETERR                                                        
*                                                                               
FCSP150  DS    0H                                                               
         LA    R2,SCBLKLQ(R2)                                                   
         BCT   R3,FCSP110                                                       
         B     FCSP160                                                          
*                                                                               
FCSP155  LA    R2,EZSPVCID                                                      
         MVI   EZERRCD,EZERRACT                                                 
         BAS   RE,SETERR                                                        
*                                                                               
* AUDIO COPY ID                                                                 
*                                                                               
FCSP160  DS    0H                                                               
         CLC   EZSPACID,SPACES                                                  
         BNH   FCSP200                                                          
*                                                                               
         XC    X,X                                                              
         MVC   X(L'EZSPACID),EZSPACID                                           
         OC    X,SPACES                                                         
         XC    WORK,WORK                                                        
         GOTO1 SCANNER,DMCB,(C'C',X),(1,WORK),C',=|='                           
         LLC   R3,DMCB+4                                                        
         LTR   R3,R3                                                            
         BZ    FCSP199                                                          
*                                                                               
         LA    R2,WORK                                                          
*                                                                               
         CLI   SC1STFLD,C'C'       CLICKS?                                      
         BNE   FCSP199                                                          
*                                                                               
         LLC   R0,SC2NDLEN                                                      
         GOTO1 CASHVAL,DMCB,SC2NDFLD,(X'40',(R0))                               
         CLI   DMCB,X'FF'                                                       
         BE    FCSP199             ERROR                                        
*                                                                               
         CLC   =AL4(1),DMCB+4                                                   
         BH    FCSP199                                                          
         CLC   =AL4(9999999),DMCB+4                                             
         BL    FCSP199                                                          
*                                                                               
         LAY   RE,EZSXCLK                                                       
         MVC   0(L'EZSXCLK,RE),DMCB+4                                           
         B     FCSP200                                                          
*                                                                               
         DROP  R2                  SCANBLKD                                     
*                                                                               
FCSP199  LA    R2,EZSPACID                                                      
         MVI   EZERRCD,EZERRACT                                                 
         BAS   RE,SETERR                                                        
*                                                                               
FCSP200  DS    0H                                                               
         MVI   EZSPBPKG,0                                                       
         CLI   EZSPTNET,C'N'       NETWORK?                                     
         BNE   FCSP220             IF NOT - DON'T DO PACKAGES                   
*                                                                               
         CLI   EZPROF+12,C'Y'      PACKAGE IN INV DETAILS?                      
         BNE   FCSP220                                                          
*                                                                               
         LA    R2,EZSPPKG                                                       
         LA    R3,L'EZSPPKG                                                     
         XC    NUMMAX,NUMMAX                                                    
         MVI   NUMMAX+3,255                                                     
         BRAS  RE,CVTNUM                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
*                                                                               
         MVC   EZSPBPKG,FULL+3     SET VALUE                                    
*                                                                               
FCSP220  DS    0H                                                               
         LAY   RF,EZ5APROF                                                      
         CLI   EZ5ABILB-EZ5APROF(RF),C'Y'  CONVERTING BILLBOARDS?               
         BNE   FCSP240                     DON'T VALIDATE BB INDICATOR          
*                                                                               
         CLI   EZSPBBI,C' '                                                     
         BNH   FCSP240                                                          
         CLI   EZSPBBI,C'Y'                                                     
         BE    FCSP240                                                          
         CLI   EZSPBBI,C'N'                                                     
         BE    FCSP240                                                          
*                                                                               
         MVI   EZERRCD,EZERRBLB    INVALID BILLBOARD INDICATOR                  
         LA    R2,EZSPBBI                                                       
         BAS   RE,SETERR                                                        
*                                                                               
FCSP240  DS    0H                                                               
FCSPX    DS    0H                                                               
         B     FCX                                                              
*                                                                               
*                                                                               
*                                                                               
*        INVOICE TOTAL RECORD FIELDS                                            
*        ---------------------------                                            
*                                                                               
FCIT     DS    0H                                                               
         LA    R2,EZITACT                                                       
         LA    R3,L'EZITACT                                                     
         LA    R4,EZITBACT                                                      
         LA    R5,11               11 FIELDS                                    
*                                                                               
FCIT20   DS    0H                                                               
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   0(4,R4),FULL                                                     
*                                                                               
         AR    R2,R3               NEXT FIELD                                   
         LA    R4,4(R4)                                                         
         BCT   R5,FCIT20                                                        
*                                                                               
* CONVERT SAME FIELDS AS PL8                                                    
*                                                                               
         LA    R2,EZITACT                                                       
         LA    R3,L'EZITACT                                                     
         LA    R4,EZBLOCKD                                                      
         AHI   R4,EZITPACT-EZBLOCKD                                             
         LA    R5,10               10 FIELDS                                    
*                                                                               
FCIT30   DS    0H                                                               
         ZAP   0(8,R4),=P'0'                                                    
         BRAS  RE,CVLAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   0(8,R4),DUB                                                      
*                                                                               
         AR    R2,R3               NEXT FIELD                                   
         LA    R4,8(R4)                                                         
         BCT   R5,FCIT30                                                        
*                                                                               
         LA    R2,EZITSPC                                                       
         LA    R3,L'EZITSPC                                                     
         LA    R4,EZITBSPC                                                      
         LA    R5,1                1 FIELD - SPOTS                              
*                                                                               
FCIT40   DS    0H                                                               
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   0(4,R4),FULL                                                     
*                                                                               
         AR    R2,R3               NEXT FIELD                                   
         LA    R4,4(R4)                                                         
         BCT   R5,FCIT40                                                        
*                                                                               
* GET CANADIAN GST TAX IF THERE                                                 
*                                                                               
         LA    R2,EZITGST                                                       
         LA    R3,L'EZITGST                                                     
         LA    R4,EZITBGST                                                      
*                                                                               
         DS    0H                                                               
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   0(4,R4),FULL                                                     
*                                                                               
* GET CANADIAN PST TAX IF THERE                                                 
*                                                                               
         LA    R2,EZITPST                                                       
         LA    R3,L'EZITPST                                                     
         LA    R4,EZITBPST                                                      
*                                                                               
         BRAS  RE,CVTAMT                                                        
         BE    *+8                                                              
         BAS   RE,SETERR                                                        
         MVC   0(4,R4),FULL                                                     
*                                                                               
* FORCE RECONCILIATION CR MINUS IF NOT ALREADY SO                               
*                                                                               
         ICM   RF,15,EZITBRCR      COMPEMENT CR AMOUNT                          
         BNP   *+10                IF NOT ALREADY NEGATIVE                      
         LCR   RF,RF                                                            
         STCM  RF,15,EZITBRCR                                                   
*                                                                               
         B     FCX                                                              
*                                                                               
FCX      DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        DATE CONVERSION ROUTINE                                                
*                                                                               
CVTDAT   NTR1                                                                   
         XC    BDATE,BDATE                                                      
         MVC   DDATE,0(R2)            SET DISPLAY IN CASE OF ERROR              
*                                                                               
         MVC   EDATE,0(R2)                                                      
*                                                                               
         OC    EDATE,EDATE                                                      
         BNZ   CVTDAT10                                                         
*                                                                               
         CLI   BYTE,0              THIS AN IMPORTANT DATE                       
         BNE   CVTDATER             YES                                         
         B     CVTDATX                                                          
*                                                                               
CVTDAT10 DS    0H                                                               
         LA    R0,6                                                             
         LA    R1,EDATE                                                         
CVTDAT20 DS    0H                                                               
         CLI   0(R1),C'0'                                                       
         BL    CVTDATER                                                         
         LA    R1,1(,R1)                                                        
         BCT   R0,CVTDAT20                                                      
*                                                                               
         OC    EDATE,=6C'0'                                                     
         CLC   EDATE+0(2),=C'85'      VALIDATE YEAR                             
         NOP   CVTDATER                                                         
         CLC   EDATE+2(2),=C'01'      VALIDATE MONTH                            
         BL    CVTDATER                                                         
         CLC   EDATE+2(2),=C'12'                                                
         BH    CVTDATER                                                         
         CLC   EDATE+4(2),=C'01'      VALIDATE DAY                              
         BL    CVTDATER                                                         
         CLC   EDATE+4(2),=C'31'                                                
         BH    CVTDATER                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(0,EDATE),(5,DDATE)                                  
         GOTO1 DATCON,DMCB,,(3,BDATE)                                           
*                                                                               
         CR    RE,RE               SET DATE OKAY                                
         B     CVTDATX                                                          
*                                                                               
CVTDATER DS    0H                                                               
         MVI   EZERRCD,EZERBDDT                                                 
         CLI   BYTE,0              THIS AN IMPORTANT DATE                       
         BE    *+8                  NOPE                                        
         OI    EZIHLKST,EZIHLEDT   SET TO REJECT ENTIRE INVOICE                 
         B     SETERRB                                                          
*                                                                               
         LTR   RE,RE               SET DATE NOT OKAY                            
*                                                                               
CVTDATX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        CVTTIM - CONVERT TIME FIELD                                            
*                                                                               
CVTTIM   NTR1                                                                   
         XC    HALF,HALF                                                        
*                                                                               
         MVC   FULL,0(R2)                                                       
*                                                                               
*                                                                               
         LA    R0,EZSPTIMT         TIME OF DAY                                  
         CR    R0,R2               IS THIS SPOT DETAIL TIME                     
         BNE   CVTTIM2              NO                                          
         CLI   FULL,C'T'           THIS SPECIAL TIME?                           
         BNE   CVTTIM2             NO                                           
         MVC   FULL,1(R2)                                                       
*                                                                               
CVTTIM2  DS    0H                                                               
         LA    R0,4                                                             
         LA    R1,FULL                                                          
CVTTIM4  DS    0H                                                               
         CLI   0(R1),C'0'                                                       
         BL    CVTTIM8                                                          
         CLI   0(R1),C'9'                                                       
         BH    CVTTIM8                                                          
         LA    R1,1(,R1)                                                        
         BCT   R0,CVTTIM4                                                       
*                                                                               
         CLC   FULL(2),=C'00'      VALIDATE HOUR                                
         BL    CVTTIM8                                                          
         CLC   FULL(2),=C'30'                                                   
         BH    CVTTIM8                                                          
         CLC   FULL+2(2),=C'00'    VALIDATE MINUTE                              
         BL    CVTTIM8                                                          
         CLC   FULL+2(2),=C'59'                                                 
         BH    CVTTIM8                                                          
         OC    FULL(4),=6C'0'                                                   
         PACK  DUB,FULL                                                         
         CVB   R0,DUB                                                           
         CHI   R0,2400             2400+ TO 0000+                               
         BL    *+8                                                              
         AHI   R0,-2400                                                         
         STH   R0,HALF                                                          
         B     CVTTIMX                                                          
*                                                                               
CVTTIM8  DS    0H                                                               
         CLI   BYTE,0              THIS AN IMPORTANT TIME                       
         BE    *+8                  NOPE                                        
         OI    EZSPLKST,EZSPBDTM     SET BAD TIME FIELD                         
         MVI   EZERRCD,EZERRINV                                                 
         B     SETERRB                                                          
*                                                                               
CVTTIMX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
*                                                                               
*                                                                               
*        ADVERTISER LOOKUP                                                      
*                                                                               
LKADV    NTR1                                                                   
         MVI   EZRNFRPT,C'N'       CLEAR REPEAT SW                              
         MVI   EZERRCD,0                                                        
*                                                                               
         TM    EZLOOKSW,EZLNOADV   TEST SKIP ADV LOOKUP                         
         BNZ   LKADVX                                                           
*                                                                               
         CLI   SKIPVAL,C'Y'                                                     
         BE    LKADVX                                                           
*                                                                               
         CLI   EZIHCVAD,0          TEST ANY OVERRIDE CLIENT                     
         BE    LKADV04              NO                                          
*                                                                               
         LA    R2,EZIHCVAD                                                      
         CLC   SADVBIN,EZIHCVAD    IS IT SAME AS LAST?                          
         BE    LKADV08                                                          
         B     LKADV10                                                          
*                                                                               
LKADV04  CLI   EZIHAAID,C' '       DO WE HAVE A SPOTPAK CODE?                   
         BNH   LKADV06              NO                                          
*                                                                               
         LA    R2,EZIHADVN                                                      
         CLC   SADVCOD,EZIHAAID    IS IT THE SAME AS LAST?                      
         BE    LKADV08                                                          
         B     LKADV10                                                          
*                                                                               
LKADV06  CLC   EZIHADVN,SADVNM        TEST = TO SAVED ADV                       
         BNE   LKADV10                                                          
*                                                                               
* SAME ADVERTISER AS LAST SAVED                                                 
*                                                                               
LKADV08  DS    0H                                                               
         BAS   RE,SETSEQ                                                        
*                                                                               
         MVC   EZIHLADN,SADVNAM                                                 
         MVC   EZIHLADC,SADVCOD                                                 
         MVC   EZIHLADB,SADVBIN                                                 
         MVC   EZIHLADT,SADVBINC                                                
         MVC   EZIHLKST,SVLKSTAT                                                
*                                                                               
         TM    EZIHLKST,EZIHLANF   LOOKUP ERROR?                                
         BZ    LKADVX                                                           
*                                                                               
*        MVI   EZERRCD,EZERRCLT       SPOTPAK CODE NOT FOUND                    
         XC    SADVBIN,SADVBIN                                                  
         XC    EZIHLADB,EZIHLADB                                                
         MVC   EZERRCD,SVADVERR                                                 
         MVI   EZRNFRPT,C'Y'          NO, SET IS A REPEAT ERROR                 
         LA    R2,EZIHADVN                                                      
         B     SETERRB                                                          
*                                                                               
LKADV10  DS    0H                  NEW ADVERTISER                               
         BAS   RE,SETSEQ           SET LAST USED CMML SEQ                       
*                                                                               
         XC    SPRDDATA,SPRDDATA   NEW ADV- CLEAR PRD DATA                      
         XC    SCMLINFO,SCMLINFO   AND COMMERCIAL                               
         XC    SADVCMML,SADVCMML   CMML SEQ                                     
         MVI   SVLKSTAT,0                                                       
         MVI   SVADVERR,0                                                       
         MVI   NEWCMLSW,C'N'                                                    
*                                                                               
         XC    BSPPARS+8(4),BSPPARS+8   CLEAR PRODUCT TABLE                     
         XC    BSCPARS+8(4),BSCPARS+8   AND CMML TABLE                          
*                                                                               
         TM    EZIHCVST,EZIHCOVR   ANY OVERRIDES                                
         BZ    LKADV20                                                          
         MVC   EZIHLADB,EZIHCVAD                                                
         B     LKADV54                                                          
*                                                                               
LKADV20  OC    EZIHAAID,EZIHAAID        ADVERTISER CODE GIVEN                   
         BZ    LKADV80                                                          
*                                                                               
         LA    R2,EZIHAAID         YES, POINT TO THAT FIELD                     
         MVC   EZIHLADC,EZIHAAID                                                
         OC    EZIHLADC,SPACES                                                  
         GOTO1 CLPACK,DMCB,EZIHLADC,EZIHLADB                                    
*                                                                               
LKADV54  DS    0H                                                               
         MVC   SADVNM,EZIHADVN     SET SAVED DATA                               
         MVC   SADVNAM,SPACES                                                   
         MVC   SADVCOD,EZIHLADC                                                 
         MVC   SADVBIN,EZIHLADB                                                 
         MVI   EZERRCD,0                                                        
         MVI   EZIHLKST,0                                                       
         MVI   SVLKSTAT,0                                                       
         MVI   SVADVERR,0                                                       
         MVI   SADVMGRP,0                                                       
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),EZBAGYMD                                                
         MVC   KEY+2(2),EZIHLADB                                                
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BE    LKADV60                                                          
*                                                                               
         OI    EZIHLKST,EZIHLANF   SET STATUS BIT                               
         OI    SVLKSTAT,EZIHLANF   AND SAVE IT                                  
*                                                                               
         XC    SADVBIN,SADVBIN                                                  
         XC    EZIHLADB,EZIHLADB                                                
*                                                                               
         MVI   EZERRCD,EZERRCLT    IF NOT FOUND - HAVE PROBLEM                  
         MVI   SVADVERR,EZERRCLT                                                
         LA    R2,EZIHADVN                                                      
         B     SETERRB                                                          
*                                                                               
LKADV60  DS    0H                                                               
         BAS   RE,GET                                                           
         L     RF,EZAREC                                                        
         MVC   EZIHLADN,CNAME-CLTHDR(RF)                                        
*                                                                               
         XC    EZIHLADT,EZIHLADT                                                
         XC    EZIHLPRT,EZIHLPRT                                                
*                                                                               
         OC    CMCLTCOD-CLTHDR(,RF),CMCLTCOD-CLTHDR(RF)                         
         BZ    *+22                                                             
         MVC   EZIHLADT,CMCLTCOD-CLTHDR(RF)                                     
         MVC   EZIHLPRT,CMCLTPRD-CLTHDR(RF)                                     
         MVC   SADVBINC,EZIHLADT                                                
*                                                                               
         TM    EZIHCVST,EZIHCOVR   ANY OVERRIDES                                
         BZ    LKADV61                                                          
         IC    R0,CPROF+6-CLTHDR(RF)                                            
         GOTO1 CLUNPK,DMCB,((R0),EZIHLADB),EZIHLADC                             
         MVC   SADVCOD,EZIHLADC                                                 
*                                                                               
LKADV61  DS    0H                                                               
         L     RF,EZAREC                                                        
*                                                                               
         LA    RE,CLIST-CLTHDR(,RF)                                             
         LA    RF,880                                                           
         LA    R0,SVCLIST                                                       
         LR    R1,RF                                                            
         MVCL  R0,RE                                                            
         L     RF,EZAREC                                                        
         MVC   SVCLIST+880(140),CLIST2-CLTHDR(RF)                               
*                                  GET EZ PROFILE FOR THIS CLIENT               
         XC    EZPROF,EZPROF       MAIN PROFILE                                 
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'S0EZ'                                                 
         MVC   WORK+4(2),EZAGY                                                  
*                                                                               
         LA    R1,EZEQVSTA+4                                                    
         ICM   R1,8,=AL1(EZMTBNDQ)                                              
         ICM   RF,15,=V(GETMED)                                                 
         A     RF,RELO                                                          
         GOTO1 (RF)                                                             
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   WORK+6(1),EZMTMED-EZMEDTBD(RF)                                   
*                                                                               
         MVC   WORK+7(3),EZIHLADC                                               
         L     RF,EZAREC                                                        
         LA    RF,COFFICE-CLTHDR(RF)                                            
*        CLI   0(RF),C' '                                                       
*        BNH   *+14                                                             
         MVI   WORK+10,C'*'                                                     
         MVC   WORK+11(1),0(RF)                                                 
*                                                                               
         GOTO1 GETPROF,DMCB,WORK,EZPROF,DATAMGR                                 
*                                                                               
         XC    T1PROF,T1PROF       T1 PROFILE                                   
         MVC   WORK(4),=C'S0T1'                                                 
         GOTO1 GETPROF,DMCB,WORK,T1PROF,DATAMGR                                 
*                                                                               
         MVC   WORK(4),=C'S0Z5'                                                 
         GOTO1 GETPROF,DMCB,WORK,BLOCK,DATAMGR                                  
         MVC   EZI5REQ,EZI5REQ-EZPROF2+BLOCK                                    
         MVC   EZNETREQ,EZNETREQ-EZPROF2+BLOCK                                  
         MVC   EZTRDREP,EZTRDREP-EZPROF2+BLOCK                                  
         MVC   EZPRTMGR,EZPRTMGR-EZPROF2+BLOCK                                  
         MVC   EZI5REPE,EZI5REPE-EZPROF2+BLOCK                                  
         MVC   EZTRUNC,EZTRUNC-EZPROF2+BLOCK                                    
         MVC   EZNOPIGS,EZNOPIGS-EZPROF2+BLOCK                                  
         MVC   EZPOLYES,EZPOLYES-EZPROF2+BLOCK                                  
*                                                                               
         MVC   WORK(4),=C'SZ5A'                                                 
         NI    WORK,X'FF'-X'40'    LOWERCASE 'S'                                
         GOTO1 GETPROF,DMCB,WORK,BLOCK,DATAMGR                                  
         LAY   RF,EZ5AEST   VALIDATE ESTIMATES IF PRD FROM CMML RECORDS         
         MVC   0(1,RF),BLOCK+EZ5AEST-EZ5APROF                                   
         LAY   RF,EZ5ANOPK  SUPPRESS PACKAGE CONVERSION                         
         MVC   0(1,RF),BLOCK+EZ5ANOPK-EZ5APROF                                  
         LAY   RF,EZ5ABILB  CONVERT BILLBOARDS                                  
         MVC   0(1,RF),BLOCK+EZ5ABILB-EZ5APROF                                  
         LAY   RF,EZ5ANPPD  NON-POL PRODUCTS IN DETAILS                         
         MVC   0(1,RF),BLOCK+EZ5ANPPD-EZ5APROF                                  
*                                                                               
         MVC   WORK(4),=C'SEZ2'                                                 
         NI    WORK,X'FF'-X'40'    LOWERCASE 'S'                                
         GOTO1 GETPROF,DMCB,WORK,BLOCK,DATAMGR                                  
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,RF                                                        
         XC    EZ2PROF,EZ2PROF     EZ2 PROFILE                                  
         MVC   EZ2PROF,BLOCK       EZ2 PROFILE                                  
         DROP  RF                                                               
*                                                                               
         MVC   WORK(4),=C'SDAR'                                                 
         NI    WORK,X'FF'-X'40'    LOWERCASE 'S'                                
         GOTO1 GETPROF,DMCB,WORK,BLOCK,DATAMGR                                  
         MVC   SVDARREP,BLOCK+6                                                 
*                                                                               
LKADV68  DS    0H                                                               
         B     LKADVX                                                           
*                                                                               
* ADVERTISER MISSING                                                            
*                                                                               
LKADV80  DS    0H                                                               
         OI    EZIHLKST,EZIHLANF                                                
         XC    SADVDATA,SADVDATA   SET SAVED DATA                               
         MVC   SADVNM,EZIHADVN                                                  
         MVC   SVLKSTAT,EZIHLKST                                                
*                                                                               
         LA    R2,EZIHADVN                                                      
         MVI   EZERRCD,EZERMCLT                                                 
         MVI   SVADVERR,EZERMCLT                                                
         B     SETERRB                                                          
*                                                                               
LKADVX   DS    0H                                                               
         CLI   EZSOON,C'S'         RUNNING SOON?                                
         BNE   LKADVX10                                                         
*                                                                               
         CLI   EZCMLOPT,C'D'       THIS SUPPOSED TO ADD AD-IDS?                 
         BE    *+12                                                             
         CLI   EZCMLOPT,C'A'       THIS SUPPOSED TO ADD COMMLS?                 
         BNE   LKADVX10                                                         
*                                                                               
* TELL THEM THAT WE CAN'T ADD COMMLS                                            
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(L'LINE1),LINE1                                                 
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
         LA    R2,EZIHADVN                                                      
         MVI   EZERRCD,EZERRCAC                                                 
         BAS   RE,SETERR                                                        
*                                                                               
         MVI   EZMODE,EZINVL       LAST FOR INVOICE                             
         MVI   SKIPSW,C'Y'         SKIP                                         
*                                                                               
LKADVX10 DS    0H                                                               
         XIT1                                                                   
*                                                                               
LINE1    DC    C'EZ PROFILE # 3 - COMMERCIAL CONVERSION CAN''T BE SET TC        
               O A FOR SOON'                                                    
         DS    0H                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* LKCML - ROUTINE THAT CHECKS WHETHER COMMERCIAL/AD-IDS EXIST                   
* UNEQUAL CONDITION CODE SET *ONLY* WHEN INVALID AD-ID IS ENCOUNTERED           
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
         DS    0D                                                               
LKCML    NMOD1 0,LKCML                                                          
         L     RC,SAVWORK                                                       
         USING EZMODD,RC                                                        
*                                                                               
         CLI   0(R2),X'00'                                                      
         BE    LKCMLX                                                           
         TM    EZLOOKSW,EZLNOCML   TEST NEED CMML LOOKUPS                       
         BNZ   LKCMLX              NO - SKIP                                    
*                                                                               
         CLI   SKIPVAL,C'Y'                                                     
         BE    LKCMLX                                                           
*                                                                               
         BRAS  RE,READCML                                                       
         BE    LKCMLX                                                           
*                                                                               
* COMMERCIAL RECORD NOT FOUND                                                   
*                                                                               
         TM    EZSPLKST,EZSPADID   WORKING WITH AD-ID?                          
         BZ    LKCML50             NO - EXECUTE THE FILMCODE LOGIC              
*                                                                               
* NOT FOUND: AD-ID                                                              
*                                                                               
         CLI   EZCMLOPT,C'D'       AUTO-ADDING AD-IDS?                          
         BE    LKCML50                                                          
*                                                                               
         CLI   EZAIDOPT,C'I'                                                    
         BNE   LKCML10                                                          
*                                                                               
         CLI   LKCMLPRM+GBLEN-GBADID,11                                         
         BL    LKCMLNQX                                                         
         B     LKCMLX                                                           
*                                                                               
LKCML10  DS    0H                                                               
         CLI   EZAIDOPT,C'Z'       ADDING ALL INVALID AD-IDS?                   
         BNE   LKCML20                                                          
*                                                                               
         TM    LKCMLPRM+GBFLAG-GBADID,GBZEROQ   ZERO-PADDED?                    
         BO    LKCMLX              YES - ADD IT                                 
*                                                                               
         XC    GETADBLK(GBLENQ),GETADBLK                                        
         OI    GBFLAG,GBZEROQ      PAD WITH ZEROS                               
         BRAS  RE,GETADID                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,GBADID1                                                       
         CLI   EZSPPIG,C'Y'                                                     
         BNE   *+8                                                              
         LA    R3,GBADID2                                                       
*                                                                               
         GOTO1 TRPACK,DMCB,(C'P',0(R3)),0(R2)                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BRAS  RE,READCML                                                       
         B     LKCMLX                                                           
*                                                                               
LKCML20  DS    0H                                                               
         CLI   EZAIDOPT,C'S'       CONVERTING "SHORT" AD-IDS?                   
         BNE   LKCML80                                                          
*                                                                               
         MVC   WORK(8),0(R2)                                                    
*                                                                               
         XC    GETADBLK(GBLENQ),GETADBLK                                        
         OI    GBFLAG,GBZEROQ      PAD WITH ZEROS                               
         BRAS  RE,GETADID                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,GBADID1                                                       
         CLI   EZSPPIG,C'Y'                                                     
         BNE   *+8                                                              
         LA    R3,GBADID2                                                       
*                                                                               
         GOTO1 TRPACK,DMCB,(C'P',0(R3)),0(R2)                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BRAS  RE,READCML                                                       
         BE    LKCMLX                                                           
*                                                                               
         MVC   0(8,R2),WORK                                                     
         B     LKCMLX                                                           
*                                                                               
* NOT FOUND: COMMERCIAL RECORD                                                  
*                                                                               
LKCML50  DS    0H                  ADV NOT ON FILE, SEE ABOUT ADD               
         CLI   EZCMLOPT,C'I'       TEST ADD MISSING TO INVOICE ONLY             
         BNE   LKCML54              NO                                          
*                                                                               
         XC    HCMLDATA,HCMLDATA                                                
         B     LKCMLX                                                           
*                                                                               
LKCML54  CLI   EZCMLOPT,C'D'       TEST WHETHER TO ADD MISSING AD-IDS           
         BE    *+12                                                             
         CLI   EZCMLOPT,C'A'       TEST WHETHER TO ADD MISSING CMLS             
         BNE   LKCML80             NO- RETURN ERROR                             
*                                                                               
* ADD INVALID COMMERCIAL TO TRAFFIC                                             
*                                                                               
         CLC   SADVCMML,=3X'FF'    NON-TRAFFIC CLIENT?                          
         BE    LKCMLX              YES- DO NOT ADD COMMERCIAL                   
*                                                                               
         OC    SADVCMML,SADVCMML   DO WE HAVE CMML SEQ                          
         BNZ   LKCML70                                                          
*                                  NO - READ FOR IT                             
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING CMLRECD,R6                                                       
         MVC   CMLKID,=X'0A21'                                                  
         MVC   CMLKAM,EZBAGYMD                                                  
         MVC   CMLKCLT,EZIHLADB    CLIENT CODE                                  
         OC    EZIHLADT,EZIHLADT     IS THERE AN OVERRIDE CLIENT                
         BZ    *+10                                                             
         MVC   CMLKCLT,EZIHLADT    TRAFFIC LINKED CLIENT CODE                   
*                                                                               
         ZIC   R0,EZTRFTBL                                                      
         L     R3,EZTRFTBL                                                      
         LA    R3,0(,R3)                                                        
*                                                                               
LKCML55  OC    0(5,R3),0(R3)       END OF COMML SEQ TABLE                       
         BZ    LKCML58                                                          
         CLC   0(2,R3),CMLKCLT     THIS THE CLIENT                              
         BE    LKCML56                                                          
         LA    R3,5(,R3)                                                        
         BCT   R0,LKCML55                                                       
         DC    H'0'                                                             
*                                                                               
LKCML56  MVC   SADVCMML,2(R3)      SAVE HIGHEST SEQ                             
         B     LKCML70                                                          
*                                                                               
LKCML58  MVC   0(2,R3),CMLKCLT                                                  
*                                                                               
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BE    LKCML60                                                          
*                                                                               
         MVC   SADVCMML,=3X'FF'    IF NOT FOUND ASSUME NON-TRAFFIC              
         XC    0(2,R3),0(R3)       ZERO OUT TABLE, TOO                          
         B     LKCML80                                                          
*                                                                               
LKCML60 DS     0H                                                               
         BAS   RE,GET                                                           
*                                                                               
         L     R6,EZAREC                                                        
         XC    SADVCMML,SADVCMML                                                
         MVC   SADVCMML(2),CMLSEQ+1-CMLRECD(R6)   SAVE HIGHEST SEQ              
         XC    2(3,R3),2(R3)                                                    
         MVC   2(2,R3),CMLSEQ+1-CMLRECD(R6)   SAVE HIGHEST SEQ                  
*                                                                               
LKCML70  DS    0H                                                               
         SR    RF,RF                                                            
         MVI   HCMLDATA+CMD1PRDL-CMDATAD,X'FF'      ALL PRDS                    
         MVC   HCMLDATA+CMD3PRDL-CMDATAD(L'CMD3PRDL),=C'POL'                    
         MVC   HCMLDATA+CMDSLN-CMDATAD(L'CMDSLN),EZSPBSLN                       
* DUMMY SEQ IF NOT ADDING COMML                                                 
         MVC   HCMLDATA+CMDSEQ-CMDATAD(L'CMDSEQ),=X'FFFFFF'                     
*                                                                               
         CLI   EZWRITE,C'Y'                                                     
         BNE   LKCML72                                                          
         CLI   EZTEST,C'Y'                                                      
         BE    LKCML72                                                          
*                                                                               
         MVI   NEWCMLSW,C'Y'       SET HAVE ADDED NEW CMML                      
*                                                                               
LKCML72  DS    0H                                                               
         MVC   HCMLDATA+CMDSEQ-CMDATAD(L'CMDSEQ),SADVCMML HOLD SEQ              
*                                                                               
         TM    EZIHLKST,X'FF'      ANY ERRORS                                   
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   EZIHLPRC,SPACES                                                  
         BH    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* CHECK PASSIVE POINTER BEFORE ADD                                              
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING CMLRECD,R6                                                       
         MVC   CMLPID,=X'0AA1'                                                  
         MVC   CMLPAM,EZBAGYMD                                                  
         MVC   CMLPCLT,EZIHLADB    CLIENT CODE                                  
         OC    EZIHLADT,EZIHLADT     IS THERE AN OVERRIDE CLIENT                
         BZ    *+10                                                             
         MVC   CMLPCLT,EZIHLADT    TRAFFIC LINKED CLIENT CODE                   
         MVC   CMLPSEQ+1(L'CMLPSEQ-1),SADVCMML                                  
*                                                                               
         BAS   RE,HIGH                                                          
         CLC   KEY(L'CMLKEY),KEYSAVE                                            
         BNE   LKCML73             NOT THERE - WE ARE OK                        
*                                                                               
* PASSIVE POINTER ALREADY EXISTS - BIG PROBLEM                                  
         DC    H'0'                                                             
*                                                                               
LKCML73  DS    0H                                                               
         L     RE,EZAREC                                                        
         LHI   RF,4096                                                          
         XCEFL                                                                  
*                                                                               
         L     R6,EZAREC                                                        
         USING CMLRECD,R6                                                       
*                                                                               
         MVC   CMLKID,=X'0A21'                                                  
         MVC   CMLKAM,EZBAGYMD                                                  
         MVC   CMLKCLT,EZIHLADB    CLIENT CODE                                  
         OC    EZIHLADT,EZIHLADT     IS THERE AN OVERRIDE CLIENT                
         BZ    *+10                                                             
         MVC   CMLKCLT,EZIHLADT    TRAFFIC LINKED CLIENT CODE                   
         MVC   CMLKCML,0(R2)                                                    
         MVC   CMLRLEN,=AL2(CMLDTAEL-CMLRECD+1) REC LENGTH                      
         TM    EZSPLKST,EZSPADID                                                
         BZ    *+8                                                              
         OI    CMLRSTAT,CMLKSTA_PCKD                                            
         DROP  R6                                                               
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING CMLDTAEL,R6                                                      
*                                                                               
* BUILD COMMERCIAL DATA ELEMENT                                                 
         MVI   CMLDTAEL,X'10'                                                   
         MVI   CMLDTALN,(CMLDTAX-CMLDTAEL)                                      
         MVC   CMLSEQ+1(2),SADVCMML           SET SEQUENCE NO.                  
         MVC   CMLTITLE(8),=C'**EASI**'                                         
         MVC   CMLSLN,EZSPBSLN     SET SPOT LENGTH                              
         MVC   CMLRLSE,=X'5A0101'                                               
         MVC   CMLRCL,=X'FFFFFF'                                                
         MVI   CMLSTAT,X'20'       SET EASI ORIGIN                              
         DROP  R6                                                               
*                                                                               
         BRAS  RE,ADDELEM                                                       
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING CMLPRDEL,R6                                                      
         MVI   CMLPRDEL,X'20'      PRODUCT LIST ELEM                            
         MVI   CMLPRDLN,3          ONE PRODUCT                                  
         MVI   CMLPRDS,X'FF'       SET FOR ALL PRODUCTS                         
         DROP  R6                                                               
*                                                                               
         BRAS  RE,ADDELEM                                                       
*                                                                               
* ADD AD-ID ELEMENT                                                             
         TM    EZSPLKST,EZSPADID                                                
         BZ    LKCML73A                                                         
*                                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING CMLADIEL,R6                                                      
         MVI   CMLADIEL,X'A0'                                                   
         MVI   CMLADILN,CMLADIDL-CMLADIEL                                       
         MVC   CMLADID,LKCMLPRM+GBADID-GETADBLK                                 
         OC    CMLADID,SPACES                                                   
         MVC   CMLADIDP,0(R2)                                                   
         GOTO1 DATCON,DMCB,(5,0),(3,CMLADIDT)  SAVE DATE                        
         TIME  DEC                                                              
         STCM  R0,14,CMLADITM      SAVE TIME                                    
         DROP  R6                                                               
*                                                                               
         BRAS  RE,ADDELEM                                                       
*                                                                               
*                                                                               
* ADD ACTIVITY ELEMENT                                                          
*                                                                               
LKCML73A DS    0H                                                               
         XC    ELEM,ELEM                                                        
         LA    R6,ELEM                                                          
         USING ACTVD,R6                                                         
         MVI   ACTVEL,X'F1'                                                     
         MVI   ACTVLEN,X'14'       20                                           
         GOTO1 DATCON,DMCB,(5,0),(3,ACTVADDT)                                   
         DROP  R6                                                               
*                                                                               
         BRAS  RE,ADDELEM                                                       
*                                                                               
         L     R6,EZAREC                                                        
         XC    KEY,KEY                                                          
         MVC   KEY(L'CMLKEY),0(R6)                                              
*                                                                               
         BAS   RE,ADD           ADD TO FILE                                     
*                                                                               
         MVC   FULL,KEY                                                         
         MVC   EZSPACML,0(R2)                                                   
*                                                                               
         BRAS  RE,FILLHCML                                                      
*                                                                               
         L     RF,SVCMTENT                                                      
         MVC   CMTDATA-CMTABD(CMDATALQ,RF),HCMLDATA                             
         MVI   CMTUSABL-CMTABD(RF),C'Y'                                         
*                                                                               
         MVC   SCMLCML,0(R2)       SAVE COMMERCIAL                              
         MVI   SCMLOK,C'Y'         SAVE FLAG                                    
         MVC   SCMLDATA,HCMLDATA   SAVE DATA                                    
*                                                                               
         TM    EZTRACE,X'10'       TEST TRACING ADDED CMMLS                     
         BZ    LKCML73B                                                         
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P+2(10),=C'ADDED CML='                                           
         MVC   P+12(8),0(R2)                                                    
         TM    EZSPLKST,EZSPADID                                                
         BZ    LKCML73A1                                                        
         GOTO1 TRPACK,DMCB,(C'U',0(R2)),P+12                                    
*                                                                               
LKCML73A1 GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                       
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P+24(4),=C'KEY='                                                 
         GOTO1 HEXOUT,DMCB,EZAREC,P+28,13,0,0                                   
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
LKCML73B DS    0H                                                               
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING CMLRECD,R6                                                       
*                                                                               
         MVC   CMLPID,=X'0AA1'                                                  
         MVC   CMLPAM,EZBAGYMD                                                  
         MVC   CMLPCLT,EZIHLADB    CLIENT CODE                                  
         OC    EZIHLADT,EZIHLADT     IS THERE AN OVERRIDE CLIENT                
         BZ    *+10                                                             
         MVC   CMLPCLT,EZIHLADT    TRAFFIC LINKED CLIENT CODE                   
         MVC   CMLPSEQ+1(L'CMLPSEQ-1),SADVCMML                                  
         MVC   KEY+14(4),FULL      D/A                                          
         DROP  R6                                                               
*                                                                               
         BAS   RE,ADDIR                                                         
*                                                                               
         TM    EZTRACE,X'10'       TEST TRACING ADDED CMMLS                     
         BZ    LKCML73C                                                         
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P+20(7),=C'0AA1 PP='                                             
         GOTO1 HEXOUT,DMCB,KEY,P+28,13,0,0                                      
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
LKCML73C DS    0H                                                               
         TM    EZSPLKST,EZSPADID                                                
         BZ    LKCML73D                                                         
*                                                                               
         LA    R6,KEY                                                           
         USING CMLRECD,R6                                                       
         MVC   CMLPIDAD,=X'0AC1'                                                
         MVC   CMLPADID,0(R2)                                                   
         BAS   RE,ADDIR                                                         
         DROP  R6                                                               
*                                                                               
         TM    EZTRACE,X'10'       TEST TRACING ADDED CMMLS                     
         BZ    LKCML73D                                                         
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P+20(7),=C'0AC1 PP='                                             
         GOTO1 HEXOUT,DMCB,KEY,P+28,13,0,0                                      
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
LKCML73D DS    0H                                                               
         XR    RF,RF                                                            
         ICM   RF,3,SADVCMML       BUMP CMML SEQ NO                             
         LA    RF,1(RF)            NOTE- HIGHEST USED SEQ IS RE-                
         STCM  RF,3,SADVCMML       WRITTEN TO MASTER IN LKADV                   
*                                                                               
         L     R6,EZAREC                                                        
         USING CMLRECD,R6                                                       
         ZIC   R0,EZTRFTBL                                                      
         L     R3,EZTRFTBL                                                      
         LA    R3,0(,R3)                                                        
*                                                                               
LKCML76  DS    0H                  SET TABLE DATA                               
         OC    0(5,R3),0(R3)       END OF COMML SEQ TABLE                       
         BNZ   *+6                                                              
         DS    H'0'                BAD, SHOULD BE THERE                         
*                                                                               
         CLC   0(2,R3),CMLKCLT     THIS THE CLIENT                              
         BE    LKCML78                                                          
         LA    R3,5(,R3)                                                        
         BCT   R0,LKCML76                                                       
         DROP  R6                                                               
*                                                                               
         DS    H'0'                BAD, SHOULD BE THERE                         
*                                                                               
LKCML78  DS    0H                  SAVE NEW CML SEQ                             
         MVC   2(3,R3),SADVCMML                                                 
*                                                                               
         L     RE,EZUTL                                                         
         MVC   4(1,RE),EZSPOTSE    RESTORE SPOT SYSTEM NUMBER                   
*                                                                               
*                                  SET ERROR INFO                               
         MVC   EZERRDTA,SPACES                                                  
         MVC   EZERRDTA(25),0(R2)  SET CMML CODE (USE ERROR DATA FLD)           
         MVI   EZMODE,EZCMLADD     AND LET CALLER KNOW                          
         BAS   RE,HOOK             I ADDED A COMMERCIAL                         
*                                                                               
         B     LKCML82                                                          
*                                                                               
LKCML80  DS    0H                  SET TABLE DATA                               
         TM    EZSPLKST,EZSPADID   WORKING WITH AD-ID?                          
         BO    LKCMLNQX            YES: NO "COMML MISSING" ERROR                
*                                                                               
LKCML82  DS    0H                  SET TABLE DATA                               
         MVI   EZERRCD,EZERRRNF    ELSE- SET NOT FOUND                          
         XC    0(8,R2),0(R2)       BLANK BAD FILM CODE                          
         LA    R2,EZSPCOPY         SET R2 TO COPY FIELD                         
         BAS   RE,SETERR                                                        
         B     LKCMLNQX                                                         
*                                                                               
LKCMLX   DS    0H                                                               
         MVI   EZRNFRPT,C'N'       RESET REPEAT SW                              
         J     EQXIT                                                            
*                                                                               
LKCMLNQX DS    0H                                                               
         MVI   EZRNFRPT,C'N'       RESET REPEAT SW                              
         J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
ADDELEM  NTR1  BASE=*,LABEL=*                                                   
         L     RF,EZCOMFCS         A(COMFACS)                                   
         USING COMFACSD,RF                                                      
         L     RF,CHELLO                                                        
         DROP  RF                                                               
         GOTO1 (RF),DMCB,(C'P',=C'TRFFIL'),EZAREC,ELEM,0                        
         CLI   DMCB+12,0                                                        
         JE    EQXIT                                                            
         J     NEQXIT                                                           
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* R1 EXPECTED TO ADDRESS COMMERCIAL CODE                                        
* R2 - ADDRESS TO COPY THE COMMERCIAL TO                                        
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
VALCML   NTR1  BASE=*,LABEL=*                                                   
         USING EZBLOCKD,R9                                                      
         USING COMSUBS,RA                                                       
         USING EZMODD,RC                                                        
*                                                                               
         CLI   EZPROF+10,C'Y'                                                   
         BNE   VALCML05            ALPHA - ALWAYS VALID                         
         MVC   0(8,R2),0(R1)                                                    
         B     VALCMLEQ                                                         
*                                                                               
VALCML05 DS    0H                                                               
         LHI   R0,8                                                             
         LR    R3,R1               SAVE R1                                      
*                                                                               
VALCML10 DS    0H                                                               
         CLI   0(R1),C'A'                                                       
         BL    VALCMLNQ            <A ALWAYS INVALID                            
         CLI   0(R1),C'Z'                                                       
         BNH   VALCML17            ALPHA - ALWAYS VALID                         
         CLI   0(R1),C'0'                                                       
         BL    VALCMLNQ            <0, NON-ALPHA - ALWAYS INVALID               
         CLI   0(R1),C'9'                                                       
         BH    VALCMLNQ            >9 ALWAYS INVALID                            
*                                                                               
VALCML13 DS    0H                  NUMBER                                       
         CHI   R0,4                                                             
         BH    VALCML20                                                         
         B     VALCML40                                                         
*                                                                               
VALCML17 DS    0H                  CHARACTER                                    
         CHI   R0,4                                                             
         BH    VALCML40                                                         
*                                                                               
VALCML20 DS    0H                                                               
         CLI   T1PROF+9,C'A'       NON-STANDARD CODES FOR R,T,N?                
         BE    VALCML40                                                         
         CLI   T1PROF+9,C'Y'       NON-STANDARD CODES FOR RADIO?                
         BNE   VALCMLNQ                                                         
         CLI   EZEQVSTA+4,C'R'                                                  
         BNE   VALCMLNQ                                                         
*                                                                               
VALCML40 LA    R1,1(,R1)           NEXT CHARACTER                               
         BCT   R0,VALCML10                                                      
*                                                                               
         MVC   0(8,R2),0(R3)                                                    
*                                                                               
VALCMLEQ J     EQXIT                                                            
VALCMLNQ J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* LOOKUP PRODUCTS BY BINARY CODE                                                
* R1 EXPECTED TO ADDRESS THE CLIST                                              
* R2 EXPECTED TO ADDRESS THE 1-BYTE PRODUCT CODE                                
* ON EXIT, IF PRD FOUND - EQ EXIT AND R1 POINTS TO 3-CHAR PRD CODE              
*             NOT FOUND - UNEQUAL EXIT CONDITION                                
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
LKBYBIN  DS    0H                                                               
         SR    R0,R0                                                            
*                                                                               
LKBYB10  CLI   0(R1),C' '                                                       
         JNH   LKBYBNQX                                                         
         CLC   0(1,R2),3(R1)                                                    
         JE    LKBYBEQX                                                         
         LA    R1,4(,R1)                                                        
         AHI   R0,1                                                             
         CHI   R0,255                                                           
         JL    LKBYB10                                                          
*                                                                               
LKBYBNQX LTR   RB,RB                                                            
         BR    RE                                                               
LKBYBEQX CR    RB,RB                                                            
         BR    RE                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* LOOKUP PRODUCTS BY 3-CHAR CODE                                                
* R1 EXPECTED TO ADDRESS THE CLIST                                              
* R2 EXPECTED TO ADDRESS THE 3-CHAR PRODUCT CODE                                
* ON EXIT, IF PRD FOUND - EQ EXIT AND R1 POINTS TO 1-BYTE PRD CODE              
*             NOT FOUND - UNEQUAL EXIT CONDITION                                
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
LKBYCOD  DS    0H                                                               
         SR    R0,R0                                                            
*                                                                               
LKBYC10  CLI   0(R1),C' '                                                       
         JNH   LKBYCNQX                                                         
         CLC   0(3,R2),0(R1)                                                    
         JE    LKBYCEQX                                                         
         LA    R1,4(,R1)                                                        
         AHI   R0,1                                                             
         CHI   R0,255                                                           
         JL    LKBYC10                                                          
*                                                                               
LKBYCNQX LTR   RB,RB                                                            
         J     LKBYCODX                                                         
LKBYCEQX CR    RB,RB                                                            
LKBYCODX LA    R1,3(,R1)           POINT TO 1-BYTE PRD CODE                     
         BR    RE                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* LKPRD - LOOK UP PRODUCT ROUTINE.  ACCEPTS 3-CHAR PRODUCT CODE                 
*         VALIDATES, AND LOOKS UP PRODUCT NAME                                  
* R1 EXPECTED TO ADDRESS PRODUCT CODE (3 CHARACTERS)                            
* VALID CLIENT CODE EXPECTED                                                    
* PRODUCT INFORMATION RETURNED IN HPRDDATA                                      
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
LKPRD    NTR1  BASE=*,LABEL=*                                                   
         USING EZBLOCKD,R9                                                      
         USING COMSUBS,RA                                                       
         USING EZMODD,RC                                                        
*                                                                               
         XC    SVPLTENT,SVPLTENT   TABLE ENTRY'S ADDRESS                        
         XC    HPRDDATA(HPRDDTLQ),HPRDDATA   CLEAR PRD HOLD FIELDS              
         MVC   HPRDCOD,0(R1)       SAVE 3-CHAR PRD CODE                         
         MVC   HPRDLKST,EZIHLKST   SET LOOKUP STATUS                            
*                                                                               
         OC    BINSRCH,BINSRCH     IS THERE A BINSRCH RTN AVAIL                 
         BZ    LKPRD20             NO - READ FROM DISK                          
*                                                                               
         XCEFL PRTABWRK,'PRTABDLQ'                                              
         MVC   PRTABWRK(PRKEYLQ),HPRDCOD   3-CHAR PRODUCT CODE                  
         MVI   PRTABWRK+PRTNAM-PRTABD,X'FF' DEFAULD=PRD NOT FOUND               
         GOTO1 BINSRCH,BSPPARS,(1,PRTABWRK)                                     
         OC    1(3,R1),1(R1)       TEST TABLE FULL                              
         BZ    LKPRD20             YES - READ FROM DISK                         
*                                                                               
         L     R5,0(R1)                                                         
         ST    R5,SVPLTENT         SAVE ENTRY'S ADDRESS                         
         CLI   0(R1),1             TEST ENTRY FOUND                             
         BE    LKPRD20             NO - READ FROM DISK                          
*                                  YES- SET VALUES FROM TABLE                   
         USING PRTABD,R5                                                        
*                                  YES- SET VALUES FROM TABLE                   
         CLI   PRTNAM,X'FF'        ALREADY IN TABLE "PRD NOT FOUND"?            
         JE    NEQXIT                                                           
*                                  YES- SET VALUES FROM TABLE                   
         OC    PRTBIN,PRTBIN       BIN CODE FOR THIS PRODUCT?                   
         BNZ   LKPRD10                                                          
*                                                                               
         CLI   EZSPTNET,C'N'       IF NETWORK                                   
         BE    LKPRD10             ALLOW PRD W/O BINARY CODE                    
*                                                                               
         MVI   EZRNFRPT,C'Y'       SET REPEAT SW FOR RNF'S                      
         J     NEQXIT              NO                                           
*                                                                               
LKPRD10  DS    0H                                                               
         MVC   HPRDBIN,PRTBIN                                                   
         MVC   HPRDNAM,PRTNAM                                                   
         J     EQXIT                                                            
         DROP  R5                                                               
*                                                                               
LKPRD20  DS    0H                  READ FROM DISK                               
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),EZBAGYMD                                                
         MVC   KEY+2(2),EZIHLADB   LOOKED UP CLIENT CODE                        
         MVC   KEY+4(3),HPRDCOD    PRODUCT CODE                                 
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         JNE   NEQXIT                                                           
*                                                                               
         BAS   RE,GET                                                           
         JNE   NEQXIT                                                           
         L     RF,EZAREC                                                        
         MVC   HPRDNAM,PNAME-PRDHDR(RF)                                         
         MVC   HPRDBIN,PCODE+1-PRDHDR(RF)                                       
*                                                                               
         OC    BINSRCH,BINSRCH     IS THERE A BINSRCH RTN AVAIL                 
         BZ    LKPRDXIT            NO, DON'T SAVE IN TABLE                      
         L     R5,SVPLTENT                                                      
         USING PRTABD,R5                                                        
         MVC   PRTNAM,HPRDNAM      SAVE NAME,                                   
         MVC   PRTBIN,HPRDBIN      BINARY PRD CODE IN PRODUCT TABLE             
*                                                                               
LKPRD30  BAS   RE,SEQ              SAVE ESTIMATES                               
         CLC   KEY(7),KEYSAVE                                                   
         JNE   LKPRDXIT                                                         
         OC    KEY+8(5),KEY+8                                                   
         JNZ   LKPRD30                                                          
*                                                                               
         ZIC   RF,KEY+7                                                         
         CHI   RF,0                                                             
         BH    *+6                                                              
         DC    H'0'                                                             
         LA    R1,PRTESTAB                                                      
         LA    R1,0(R1,RF)         INDEX INTO EST TABLE                         
         BCTR  R1,0                                                             
         STC   RF,0(R1)            STORE ESTIMATE NUMBER                        
         B     LKPRD30                                                          
*                                                                               
LKPRDXIT MVI   EZRNFRPT,C'N'       RESET REPEAT SW                              
         J     EQXIT                                                            
         LTORG                                                                  
         DROP                                                                   
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* LKEST - LOOK UP ESTIMATE ROUTINE.                                             
*         LOOKS UP ESTIMATE IN THE TABLE                                        
* R1 EXPECTED TO ADDRESS ESTIMATE CODE                                          
* EQUAL / UNEQUAL EXIT CONDITION                                                
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
LKEST    NTR1  BASE=*,LABEL=*                                                   
         USING EZBLOCKD,R9                                                      
         USING COMSUBS,RA                                                       
         USING EZMODD,RC                                                        
*                                                                               
         ZIC   R2,0(R1)            SAVE EST IN R2                               
*                                                                               
         XC    SVPLTENT,SVPLTENT   TABLE ENTRY'S ADDRESS                        
         OC    BINSRCH,BINSRCH     IS THERE A BINSRCH RTN AVAIL                 
         BZ    LKEST20             NO - READ ESTIMATE FROM DISK                 
*                                                                               
         XCEFL PRTABWRK,'PRTABDLQ'      BUILD BINSRCH KEY                       
         MVC   PRTABWRK(PRKEYLQ),EZIHLPRC   3-CHAR PRODUCT CODE                 
         GOTO1 BINSRCH,BSPPARS,(0,PRTABWRK)                                     
         L     R5,0(R1)                                                         
         ST    R5,SVPLTENT         SAVE ENTRY'S ADDRESS                         
         CLI   0(R1),1             TEST ENTRY FOUND                             
         JE    NEQXIT                                                           
*                                                                               
         USING PRTABD,R5                                                        
         LA    R1,PRTESTAB                                                      
         CHI   R2,0                                                             
         BNL   *+6                                                              
         DC    H'0'                                                             
         LA    R1,0(R1,R2)         INDEX INTO EST TABLE                         
         BCTR  R1,0                                                             
         CLI   0(R1),0                                                          
         JE    NEQXIT                                                           
*                                                                               
         OC    EZIHLP2C,EZIHLP2C                                                
         JZ    EQXIT                                                            
* CHECK ESTIMATE EXISTS FOR SECONT PRODUCT                                      
         XCEFL PRTABWRK,'PRTABDLQ' BUILD BINSRCH KEY                            
         MVC   PRTABWRK(PRKEYLQ),EZIHLP2C   3-CHAR PRODUCT CODE                 
         GOTO1 BINSRCH,BSPPARS,(0,PRTABWRK)                                     
         L     R5,0(R1)                                                         
         ST    R5,SVPLTENT         SAVE ENTRY'S ADDRESS                         
         CLI   0(R1),1             TEST ENTRY FOUND                             
         JE    NEQXIT              NO - READ FROM DISK                          
*                                  YES- SET VALUES FROM TABLE                   
         USING PRTABD,R5                                                        
         LA    R1,PRTESTAB                                                      
         LA    R1,0(R1,R2)         INDEX INTO EST TABLE                         
         BCTR  R1,0                                                             
         CLI   0(R1),0                                                          
         JE    NEQXIT                                                           
         J     EQXIT                                                            
*                                                                               
LKEST20  DS    0H                  BINSRCH NOT AVAILABLE                        
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),EZBAGYMD                                                
         MVC   KEY+2(2),EZIHLADB   LOOKED UP CLIENT CODE                        
         MVC   KEY+4(3),EZIHLPRC   PRODUCT CODE                                 
         STC   R2,KEY+7                                                         
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         JNE   NEQXIT                                                           
*                                                                               
         OC    EZIHLP2C,EZIHLP2C   SECOND PRODUCT?                              
         JZ    EQXIT               NO - JUST EXIT                               
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),EZBAGYMD                                                
         MVC   KEY+2(2),EZIHLADB   LOOKED UP CLIENT CODE                        
         MVC   KEY+4(3),EZIHLP2C   PRODUCT 2 CODE                               
         STC   R2,KEY+7                                                         
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         JNE   NEQXIT                                                           
         J     EQXIT                                                            
*                                                                               
         LTORG                                                                  
         DROP                                                                   
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* R1 EXPECTED TO ADDRESS EZSPCOPY                                               
* R2 - 16-BYTE AREA WHERE COMMERCIAL CODES WILL BE PLACED                       
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
GETCMMLS NTR1  BASE=*,LABEL=*                                                   
         USING EZBLOCKD,R9                                                      
         USING COMSUBS,RA                                                       
         USING EZMODD,RC                                                        
*                                                                               
         MVI   GETCMPIG,C'N'       PIGGYBACK INDICATOR                          
         LHI   R4,L'EZSPCOPY       NUMBER OF CHARACTERS TO READ                 
*                                                                               
GETCM05  DS    0H                                                               
         LHI   R0,0                NUMBER OF CHARACTERS COPIED                  
         LR    R3,R2               DESTINATION POINTER                          
*                                                                               
         CLC   =C'N-',0(R1)        THIS FUNNY JUNK                              
         BNE   GETCM10                                                          
         MVI   EZSPCNOM,C'Y'       FOR EZADDSNV TO SET NO MATCH FLAG            
         LA    R1,2(R1)                                                         
         SHI   R4,2                                                             
         CHI   R4,0                                                             
         BNH   GETCMLX                                                          
*                                                                               
GETCM10  DS    0H                  THREE POSSIBLE INPUTS:                       
         CLI   0(R1),C' '          1. SPACE?                                    
         BNH   GETCM80             YES, CHECK WHETHER TO TERMINATE              
*                                                                               
GETCM20  DS    0H                                                               
         CLI   0(R1),C'-'          2. DASH?                                     
         BNE   GETCM70             NO                                           
*                                                                               
         CLI   EZPROF+10,C'Y'      ACCEPT DASHES?                               
         BNE   GETCM80             NO - SKIP THE DASH                           
*                                                                               
GETCM70  DS    0H                  3. USABLE CHARACTER                          
         MVC   0(1,R3),0(R1)       COPY                                         
         LA    R3,1(R3)            ADVANCE DESTINATION POINTER                  
         AHI   R0,1                INCREMENT BYTE COUNTER                       
*                                                                               
GETCM80  DS    0H                                                               
         LA    R1,1(R1)            ADVANCE SOURCE POINTER                       
         BCT   R4,GETCM90          CHARACTERS LEFT TO READ                      
* ALL CHARACTERS HAVE BEEN READ AT THIS POINT                                   
         CLI   GETCMPIG,C'Y'       ARE WE ON SECOND FILMCODE?                   
         BNE   GETCMLX             NO, SIMPLY EXIT                              
         XC    0(8,R2),0(R2)       YES = CLEAR SECOND COMMERCIAL                
         B     GETCMLX                                                          
*                                                                               
GETCM90  DS    0H                                                               
         CHI   R0,8                HAVE WE COPIED 8 CHARS ALREADY?              
         BL    GETCM10             NO, CONTINUE LOOPING                         
*                                                                               
* IF 9TH CHARACTER IS NOT A SPACE, IT IS ASSUMED THAT THERE IS                  
* ONLY ONE COMMERCIAL CODE                                                      
         CLI   0(R1),C' '          SPACE?                                       
         BNH   GETCM100            YES - LOOK FOR ANOTHER FILMCODE              
*                                                                               
* NONSPACE HERE - CLEAR SECOND COMMERCIAL AND GET OUT                           
         CLI   GETCMPIG,C'Y'       ARE WE ON 2ND FILMCODE ALREADY?              
         BE    *+8                 YES - DO NOT ADVANCE R2                      
         LA    R2,8(R2)                                                         
         XC    0(8,R2),0(R2)       CLEAR 2ND COMMERCIAL SLOT                    
         B     GETCMLX             END OFCOPYING                                
*                                                                               
GETCM100 DS    0H                  COMMERCIAL CODE COPIED                       
         CLI   EZNOPIGS,C'Y'                                                    
         BE    GETCMLX                                                          
*                                                                               
         CLI   GETCMPIG,C'Y'       NAVE WE DONE PIGGYBACK ALREADY?              
         BE    GETCMLX             YES - GET OUT                                
         MVI   GETCMPIG,C'Y'       SET PIGGYBACK INDICATOR                      
         LA    R2,8(R2)            NEXT COMMERCIAL CODE SLOT                    
*                                                                               
* ADVANCE PAST SPACES TO ANOTHER COMMERCIAL                                     
         CLI   0(R1),C' '                                                       
         BH    GETCM05             NON-SPACE = START OF COMMERCIAL              
         LA    R1,1(R1)            SKIP THE SPACE                               
         BCT   R4,*-12                                                          
         B     GETCMLX             SCANNED ALL OF EZSPCOPY - EXIT               
*                                                                               
GETCMLX  DS    0H                                                               
         J     EQXIT                                                            
*                                                                               
GETCMPIG DS    X                                                                
         LTORG                                                                  
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* R1 EXPECTED TO ADDRESS EZSPCOPY                                               
* R2 - 16-BYTE AREA WHERE COMMERCIAL CODES WILL BE PLACED                       
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
GETCMOLD NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*                  **FOR NOW BYTES 1-8 OR 1-9 = 1ST FILM                        
         LR    R4,R1               SAVE A(EZSPCOPY)                             
         LR    R5,R2               SAVE A(SVCMLS) - OUTPUT                      
         LR    R3,R1               A(EZSPCOPY)                                  
         CLC   =C'N-',0(R4)        THIS FUNNY JUNK                              
         BNE   GETC32                                                           
*                                                                               
         LA    R0,8                                                             
         LA    R1,9(R4)                                                         
GETC30   DS    0H                  COPY ID (COMMERCIALS)                        
         CLI   0(R1),C' '          OKAY IF NON-BLANK                            
         BNH   GETC32                                                           
         BCTR  R1,0                                                             
         BCT   R0,GETC30                                                        
*                                                                               
         MVI   EZSPCNOM,C'Y'       FOR EZADDSNV TO SET NO MATCH FLAG            
         LA    R3,2(R4)                                                         
*                                                                               
GETC32   DS    0H                  COPY ID (COMMERCIALS)                        
*                                                                               
         CLI   0(R3),C'A'                                                       
         BNL   *+8                                                              
         LA    R3,1(,R3)           BYPASS BAD BYTE                              
*                                                                               
* SEE IF 2 CHAR - BLK, THEN 6 CHAR                                              
*                                                                               
         CLI   0(R3),C'A'                                                       
         BL    GETC34                                                           
         CLI   1(R3),C'A'                                                       
         BL    GETC34                                                           
         CLI   2(R3),C' '                                                       
         BH    GETC34                                                           
         CLI   3(R3),C'A'                                                       
         BL    GETC34                                                           
         CLI   4(R3),C'A'                                                       
         BL    GETC34                                                           
         CLI   5(R3),C'A'                                                       
         BL    GETC34                                                           
         CLI   6(R3),C'A'                                                       
         BL    GETC34                                                           
         CLI   7(R3),C'A'                                                       
         BL    GETC34                                                           
         CLI   8(R3),C'A'                                                       
         BL    GETC34                                                           
         CLI   9(R3),C' '                                                       
         BH    GETC34                                                           
         MVC   0(2,R5),0(R3)                                                    
         MVC   2(6,R5),3(R3)                                                    
         LA    R3,10(,R3)                                                       
         B     GETC36                                                           
*                                                                               
GETC34   DS    0H                  COPY ID (COMMERCIALS)                        
         MVC   0(4,R5),0(R3)                                                    
         LA    R3,4(,R3)                                                        
         CLI   0(R3),C'A'          SKIP ANY SEPARATOR                           
         BNL   *+8                                                              
         LA    R3,1(,R3)                                                        
         MVC   4(4,R5),0(R3)                                                    
         LA    R3,4(,R3)            BUMP PAST THIS FILM                         
*                                                                               
* DROP 1ST CHARACTER OF CML IF ACBO, & CMML IS 9 CHARACTERS                     
*                                                                               
GETC36   DS    0H                  COPY ID (COMMERCIALS)                        
*        CLC   EZAGY,=C'AG'        THIS ACBO                                    
         CLC   EZAGY,=AL2(AGYALPH_AG)   ACBO                                    
         BNE   GETC38                                                           
         CLI   0(R3),C'A'          THIS VALID CHARATER                          
         BL    GETC38               NO                                          
*                                                                               
         MVC   0(7,R5),1(R5)                                                    
         MVC   7(1,R5),0(R3)                                                    
         LA    R3,1(,R3)            BUMP PAST THIS CHARACTER                    
*                                                                               
GETC38   DS    0H                  COPY ID (COMMERCIALS)                        
         LA    R2,0(R5)                                                         
*                                                                               
* ELIMINATE TRAILING BLANKS FROM COMML                                          
         LA    RE,8                                                             
         LA    RF,7(R5)                                                         
         CLI   0(RF),C' '                                                       
         BH    *+14                                                             
         MVI   0(RF),0                                                          
         BCTR  RF,0                                                             
         BCT   RE,*-14                                                          
*                                                                               
*                  **FOR NOW NEXT 8 OR 9 BYTES = 2ND FILM                       
*                                                                               
*                                                                               
         CLI   0(R3),C'A'                                                       
         BNL   *+8                                                              
         LA    R3,1(,R3)           BYPASS SEPARATOR BYTE                        
*                                                                               
         OC    0(8,R3),0(R3)       ANY DATA                                     
         BZ    GETCX                NO                                          
*                                                                               
         LR    RE,R3                                                            
         LA    RF,30(R4)                                                        
         CLI   0(RE),0             LOOK FOR END OF DATA                         
         BE    *+14                HERE IT IS                                   
         LA    RE,1(,RE)           CK NEXT BYTE                                 
         CR    RE,RF               AT END OF FIELD?                             
         BL    *-14                NOT YET                                      
*                                                                               
         SR    RE,R3                                                            
         CHI   RE,8                IF FIELD IS MORE THAN 8, BYPASS              
         BNE   GETCX                                                            
*                                                                               
         MVC   8(4,R5),0(R3)                                                    
         LA    R3,4(R3)                                                         
         CLI   0(R3),C'A'          SKIP ANY SEPARATOR                           
         BNL   *+8                                                              
         LA    R3,1(R3)                                                         
         MVC   12(4,R5),0(R3)                                                   
         LA    R2,8(R5)                                                         
*                                                                               
* ELIMINATE TRAILING BLANKS FROM COMML                                          
         LA    RE,8                                                             
         LA    RF,15(R5)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+14                                                             
         MVI   0(RF),0                                                          
         BCTR  RF,0                                                             
         BCT   RE,*-14                                                          
*                                                                               
GETCX    J     EQXIT                                                            
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* ON ENTRY:                                                                     
* EZSPCOPY EXPECTED TO HAVE COMMERCIAL CODE(S)                                  
* GBPADC - THE PAD CHARACTER                                                    
* ON EXIT:                                                                      
* GETADBLK WILL HAVE AD-IDS, LENGTHS                                            
* UNEQUAL CONDITION CODE SET AND BLOCK CLEARED IF INVALID AD-IDS                
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
GETADID  NTR1  BASE=*,LABEL=*                                                   
         TM    GBFLAG,GBSPACEQ+GBZEROQ                                          
         BM    *+6                                                              
         DC    H'0'                                                             
         NI    GETADFLG,X'FF'-GAPIGQ-GADROPQ-GADASHQ                            
*                                                                               
         LA    RF,EZBLOCKD                                                      
         AHI   RF,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,RF                                                        
         CLI   EZ2SPCES,C'Y'       DROPPLING DASHES/SPACES IN AD-IDS?           
         BNE   *+8                                                              
         OI    GETADFLG,GADROPQ    INDICATE WE'RE DROPPING SPACES               
         CLI   EZ2SPCES,C'D'       DROPPLING ALL DASHES?                        
         BNE   *+8                                                              
         OI    GETADFLG,GADASHQ    INDICATE WE'RE DROPPING SPACES               
         DROP  RF                                                               
*                                                                               
         LA    R1,EZSPCOPY         SOURCE                                       
         LA    R3,L'EZSPCOPY(R1)   R3=>END OF EZSPCOPY                          
         LA    R4,GBADID1          FIRST AD-ID                                  
         USING GBADID,R4                                                        
*                                                                               
GETAD05  DS    0H                                                               
         LA    R2,GBADID           DESTINATION                                  
         LHI   R0,L'GBADID                                                      
*                                                                               
GETAD10  DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    GETAD13                                                          
*                                                                               
* HAVE SPACE HERE - SEE IF IT IS THE END OF ADID                                
*                                                                               
         CHI   R0,5                MORE THAN 4 CHARACTERS LEFT?                 
         BL    GETAD30             NO: SPACE=END OF AD-ID                       
         B     GETAD15             YES - SEE IF WE CAN DROP IT                  
*                                                                               
* NONSPACE CHARACTER                                                            
*                                                                               
GETAD13  DS    0H                                                               
         CLI   0(R1),C'-'                                                       
         BNE   GETAD20                                                          
*                                                                               
* HAVE DASH HERE                                                                
*                                                                               
         CHI   R0,5                MORE THAN 4 CHARACTERS LEFT?                 
*        BL    GETAD20             NO: DON'T DROP THE DASHES                    
         BNL   GETAD15             YES - SEE IF WE CAN DROP IT                  
*                                                                               
* SEE IF WE CAN SKIP THIS CHARACTER                                             
*                                                                               
         TM    GETADFLG,GADASHQ    "D" OPTION?                                  
         BO    GETAD16             YES - DROP DASHES                            
         B     GETAD20             NO - COPY IT INTO AD-ID                      
*                                                                               
GETAD15  DS    0H                                                               
         TM    GETADFLG,GADROPQ+GADASHQ DROPPING DASHES/SPACES?                 
         BZ    GETADNO             NO - ERROR, THIS CAN'T BE AN AD-ID           
*                                                                               
GETAD16  LA    R1,1(R1)            ADVANCE SOURCE POINTER                       
         CR    R1,R3               ARE WE PAST THE END OF EZSPCOPY?             
         BNL   GETAD30             YES - END OF AD-ID                           
         B     GETAD10             NO - PROCESS NEXT CHARACTER                  
*                                                                               
* COPY THE CHARACTER                                                            
*                                                                               
GETAD20  DS    0H                                                               
         MVC   0(1,R2),0(R1)       COPY                                         
         LA    R1,1(R1)            ADVANCE SOURCE POINTER                       
         LA    R2,1(R2)            ADVANCE DESTINATION POINTER                  
*                                                                               
         CR    R1,R3               ARE WE PAST END OF EZSPCOPY?                 
         BNL   GETAD30             YES - END OF THE AD-ID HERE                  
         BCT   R0,GETAD10                                                       
*                                                                               
* ALL 12 CHARACTERS COPIED HERE                                                 
*                                                                               
         MVI   GBLEN,L'GBADID                                                   
         CLI   0(R1),C' '          NEXT CHAR = SPACE?                           
         BNH   GETAD40             YES - SEE IF PIGGYBACK FOLLOWS               
*                                                                               
* NEXT CHARACTER IS NON-SPACE, NEED TO TRUNCATE FILMCODE                        
* FIRST, CHECK THE Z5 PROFILE, TRUNCATION LENGTH                                
*                                                                               
         CLI   EZTRUNC,8                                                        
         BL    GETAD25             <8 - VALUE NOT SET                           
         CLI   EZTRUNC,12                                                       
         BH    GETAD25             >12 - VALUE NOT SET                          
*                                                                               
         CLI   EZTRUNC,8                                                        
         BE    GETADNO             =8 - ISCII, NOT AD-ID                        
*                                                                               
* SPECIFIC TRUNCATION VALUE SET, USE IT INSTEAD OF DEFAULT                      
*                                                                               
         MVC   GBLEN,EZTRUNC                                                    
         LLC   RF,EZTRUNC          TRUNCATION LENGTH                            
         LA    RE,0(R4,RF)                                                      
         LHI   RF,L'GBADID                                                      
         LLC   R0,EZTRUNC                                                       
         SR    RF,R0                                                            
         BZ    GETADX              TRUNCATION VALUE=12                          
*                                                                               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),SPACES                                                   
         B     GETADX                                                           
*                                                                               
* TRUNCATION LENGTH NOT EXPLICITLY SET - RUN DEFAULT LOGIC                      
*                                                                               
GETAD25  DS    0H                                                               
* JAN23/09 - SPECIAL PROVISION FOR M2 TO TRUNCATE AT 12 CHARS                   
* AND ACCEPT THE RESULTING FILMCODE AS AN AD-ID: TKT 0214151N                   
*                                                                               
         CLC   EZAGY,=AL2(AGYALPH_M2)                                           
         BE    GETADX              YES - GET OUT                                
         CLC   EZAGY,=AL2(AGYALPH_H7)                                           
         BE    GETADX                                                           
         CLC   EZAGY,=AL2(AGYALPH_FR)                                           
         BE    GETADX                                                           
         CLC   EZAGY,=AL2(AGYALPH_YN)                                           
         BE    GETADX                                                           
*                                                                               
         B     GETADNO             NO: COMML > 12CHAR, CAN'T BE AD-ID           
*                                                                               
* END OF AD-ID HERE, FEWER THAN 12 CHARACTERS COPIED                            
*                                                                               
GETAD30  DS    0H                                                               
         LHI   RF,L'GBADID                                                      
         SR    RF,R0                                                            
         STC   RF,GBLEN                                                         
*                                                                               
         CHI   R0,4                MORE THAN 4 CHARS LEFT?                      
         BNL   GETADNO             YES - ERROR, AD-ID MUST BE 8-12              
*                                                                               
         OI    GBFLAG,GBPADQ       SET THE PAD FLAG                             
*                                                                               
         MVI   BYTE,C'0'                                                        
         TM    GBFLAG,GBZEROQ                                                   
         BO    *+8                                                              
         MVI   BYTE,C' '                                                        
*                                                                               
         MVC   0(1,R2),BYTE        PAD IT TO 12                                 
         LA    R2,1(R2)            ADVANCE DESTINATION POINTER                  
         BCT   R0,*-10                                                          
*                                                                               
* AD-ID DONE, DO PIGGYBACKS NOW                                                 
*                                                                               
GETAD40  DS    0H                                                               
         CR    R1,R3               ARE WE PAST THE END OF EZSPCOPY?             
         BNL   GETADX              YES - GET OUT                                
*                                                                               
         CLI   EZNOPIGS,C'Y'                                                    
         BE    GETADX                                                           
*                                                                               
         TM    GETADFLG,GAPIGQ     DONE WITH PIGGYBACKS ALREADY?                
         BO    GETADX              YES - JUST EXIT                              
         OI    GETADFLG,GAPIGQ     INDICATE WE'VE STARTED A PIGGYBACK           
*                                                                               
GETAD50  CLI   0(R1),C' '          ANYTHING THERE?                              
         BH    GETAD60             YES, ASSUME START OF PIGGY AD-ID             
         LA    R1,1(R1)            NO - ADVANCE SOURCE POINTER                  
         CR    R1,R3               ARE WE PAST THE END OF EZSPCOPY?             
         BNL   GETADX              YES - GET OUT                                
         B     GETAD50                                                          
*                                                                               
GETAD60  LA    R4,L'GBADID1(R4)                                                 
         B     GETAD05                                                          
*                                                                               
* BEFORE EXITING, CHECK AD-ID FOR INVALID CHARACTERS                            
* 08/13/2008 - REMOVED 4A/8AN RESTRICTIONS                                      
*                                                                               
GETADX   DS    0H                                                               
         LA    R4,GBADID1                                                       
         USING GBADID,R4                                                        
*                                                                               
         LHI   R2,2                TWO AD-IDS                                   
*                                                                               
GETADX10 DS    0H                                                               
         LA    R1,GBADID           AD-ID                                        
         LLC   R0,GBLEN            ITS LENGTH                                   
*                                                                               
GETADX20 CLI   0(R1),C' '                                                       
         BNH   GETADX30                                                         
*                                                                               
         BRAS  RE,ISALPHA          IS IT ALPHABETIC?                            
         BE    *+12                YES - OK                                     
         BRAS  RE,ISNUM            IS IT NUMERIC?                               
         BNE   GETADNO             NO - CAN'T BE AN AD ID                       
*                                                                               
         LA    R1,1(R1)            NEXT CHARACTER                               
         BCT   R0,GETADX20                                                      
*                                                                               
GETADX30 LA    R4,L'GBADID1(R4)    NEXT AD-ID                                   
         BCT   R2,GETADX10                                                      
         DROP  R4                                                               
*                                                                               
GETADYES J     EQXIT                                                            
GETADNO  XC    GETADBLK(GBLENQ),GETADBLK                                        
         J     NEQXIT                                                           
*                                                                               
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* R1 - EZSPCOPY                                                                 
* R2 - SPACE TO STORE THE COMML CODES                                           
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
GETCMFM  NTR1  BASE=*,LABEL=*                                                   
         MVI   GETFMPIG,C'N'                                                    
*                                                                               
GETFM05  DS    0H                                                               
         LHI   R0,9                                                             
         LR    R3,R1               SAVE START OF FILMCODE                       
*                                                                               
GETFM10  DS    0H                                                               
         CLI   0(R1),C' '          END OF FILMCODE?                             
         BNH   GETFM30                                                          
*                                                                               
         CLI   0(R1),C'-'          DASH?                                        
         BNE   GETFM20             NO                                           
         CLI   EZPROF+10,C'Y'      ACCEPT DASHES?                               
         BE    GETFM20             YES, PROCEED                                 
         LA    R1,1(R1)            ADVANCE TO NEXT CHAR                         
         B     GETFM10             BUT *DO NOT* COUNT THE DASH                  
*                                                                               
GETFM20  LA    R1,1(R1)                                                         
         BCT   R0,GETFM10                                                       
*                                  END OF COMMERCIAL HERE                       
         CLI   0(R1),C' '          MORE THAN 9 CHARACTERS?                      
         BNH   GETFM40             NO - CHECK FOR PIGGYBACKS                    
         B     GETFMNO             YES - GET OUT, DO NOTHING                    
*                                                                               
GETFM30  DS    0H                  END OF FILMCODE HERE                         
         CHI   R0,0                HAVE WE THE 9 CHARACTERS?                    
         BNE   GETFMNO             YES - ERROR, MUST HAVE 9 CHARACTERS          
*                                                                               
GETFM40  DS    0H                                                               
* LEAVE FIRST CHARACTER OUT, COPY REMAINING 8                                   
*        MVC   0(8,R2),1(R3)                                                    
         LR    RE,R2                                                            
         LA    RF,1(R3)                                                         
         LHI   R0,8                                                             
*                                                                               
GETFM50  CLI   0(RF),C'-'          DASH?                                        
         BNE   *+12                NO                                           
         CLI   EZPROF+10,C'Y'      ACCEPT DASHES?                               
         BNE   *+16                NO - DON'T COPY THE DASH                     
         MVC   0(1,RE),0(RF)       COPY THE CHARACTER                           
         LA    RE,1(RE)            ADVANCE 1 CHAR IN TARGET STRING              
         BCTR  R0,0                DECREMENT COPIED CHARACTER COUNT             
*                                                                               
         LA    RF,1(RF)            ADVANCE 1 CHAR IN SOURCE STRING              
         CHI   R0,0                                                             
         BH    GETFM50                                                          
*                                                                               
         LA    R2,8(R2)                                                         
*                                                                               
         CLI   GETFMPIG,C'Y'       ALREADY DONE WITH PIGGYBACKS?                
         BE    GETFMYES            YES - JUST EXIT                              
*                                                                               
         MVI   GETFMPIG,C'Y'                                                    
         LA    R1,1(R1)            ADVANCE TO NEXT CHARACTER                    
         CLI   0(R1),C' '          ANYTHING THERE?                              
         BH    GETFM05             YES - SEE WHAT IT IS                         
*                                  NO - EXIT                                    
GETFMYES J     EQXIT                                                            
GETFMNO  J     NEQXIT                                                           
GETFMPIG DS    C                                                                
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
* R2 EXPECTED TO ADDRESS THE REP CODE                                           
* ON EXIT WORK WILL HAVE THE VALIDATED, 3-CHAR REP CODE                         
*                                                                               
LKREP    NTR1  BASE=*,LABEL=*                                                   
         USING EZBLOCKD,R9                                                      
         USING COMSUBS,RA                                                       
         USING EZMODD,RC                                                        
*                                                                               
         MVI   LKREPFL,C'N'                                                     
*                                                                               
* FIND LENGTH, AND SEE WHETHER ALPHA OR NUMERIC                                 
*                                                                               
         LR    R1,R2                                                            
         LHI   R3,3                                                             
*                                                                               
LKREP10  DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BNH   LKREP20                                                          
         BRAS  RE,ISNUM                                                         
         BE    *+8                                                              
         MVI   LKREPFL,C'A'                                                     
         LA    R1,1(R1)                                                         
         BCT   R3,LKREP10                                                       
*                                                                               
* DONE COUNTING.  R0=3-LEN                                                      
*                                                                               
LKREP20  DS    0H                                                               
         CLI   LKREPFL,C'A'                                                     
         BE    LKREP40                                                          
*                                                                               
* GOT NUMERIC REP HERE                                                          
*                                                                               
         MVC   WORK,=C'000'                                                     
         LA    R1,WORK(R3)                                                      
         MVC   0(3,R1),0(R2)                                                    
         B     LKREP100                                                         
*                                                                               
* GOT ALPHA REP HERE                                                            
*                                                                               
LKREP40  DS    0H                                                               
         CHI   R3,0                                                             
         JH    NEQXIT                                                           
         MVC   WORK(3),0(R2)                                                    
*                                                                               
LKREP100 DS    0H                                                               
         XC    KEY,KEY                                                          
         LA    R3,KEY                                                           
         USING REPREC,R3                                                        
         MVI   REPKEY,C'0'                                                      
         MVC   REPKEY+1(L'REPKEY-1),REPKEY                                      
         MVI   REPKTYPE,C'R'                                                    
*                                                                               
         LA    R1,EZEQVSTA+4                                                    
         ICM   R1,8,=AL1(EZMTBNDQ)                                              
         ICM   RF,15,=V(GETMED)                                                 
         A     RF,RELO                                                          
         GOTO1 (RF)                                                             
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   REPKMED,EZMTMED-EZMEDTBD(RF)                                     
*                                                                               
         CLI   REPKMED,C'L'                                                     
         BNE   *+8                                                              
         MVI   REPKMED,C'T'                                                     
         MVC   REPKREP,WORK                                                     
         MVC   REPKAGY,EZAGY                                                    
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'DMRDHI',=C'STATION ',REPKEY,EZAREC               
         L     R3,EZAREC                                                        
         CLC   REPKEY,KEY                                                       
         JNE   NEQXIT                                                           
*                                                                               
LKREPX   DS    0H                                                               
         J     EQXIT                                                            
         DROP  R3                                                               
         LTORG                                                                  
LKREPFL  DS    X                   C'A' = ALPHA, C'N' = NUMERIC                 
                                                                                
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
* CVTNUM - CONVERT NUMERIC FIELD                                                
* ON ENTRY: R2 EXPECTED TO ADDRESS THE FIELD                                    
*           R3 EXPECTED TO HAVE FIELD'S LENGTH                                  
* ON EXIT: FULL CONTAINS THE BINARY VALUE OF THE FIELD, EQUAL EXIT CODE         
*          BYTE CONTAINS THE ACTUAL LENGTH                                      
*                                                                               
*          EZERRCD IS SET TO EZERRINV IF FIELD INVALID, UNEQ EXIT CODE          
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
CVTNUM   NTR1  BASE=*,LABEL=*                                                   
         XC    FULL,FULL           INITIALIZE OUTPUT TO ZERO                    
*                                                                               
         CLI   0(R2),C' '          ANYTHING?                                    
         BNH   CVTX                NOTHING THERE - JUST EXIT                    
*                                                                               
         LA    R3,0(R2,R3)         GET END                                      
         BCTR  R3,R0                                                            
         CLI   0(R3),C' '                                                       
         BH    *+8                                                              
         BCT   R3,*-8                                                           
*                                                                               
         SR    R3,R2               SET LENGTH                                   
         LA    R3,1(R3)                                                         
*                                                                               
*        GOTO1 NUMVAL,DMCB,(0,(R2)),(R3)                                        
*        CLI   DMCB,X'FF'          TEST NUMERIC                                 
*        BE    CVTNX                                                            
*                                                                               
         GOTO1 CASHVAL,DMCB,(0,0(R2)),(X'40',(R3))                              
         CLI   DMCB,X'FF'                                                       
         BE    CVTNX               ERROR                                        
*                                                                               
         OC    NUMMAX,NUMMAX       TEST ANY MAXIMUM                             
         BZ    *+14                                                             
         CLC   DMCB+4(4),NUMMAX                                                 
         BH    CVTNX                                                            
*                                                                               
         STC   R3,BYTE             SET ACTUAL LENGTH                            
         MVC   FULL,DMCB+4                                                      
*                                                                               
CVTX     J     EQXIT                                                            
*                                                                               
CVTNX    DS    0H                                                               
         CLI   NUMERRSW,C'Y'       TEST WORRIED ABOUT ERROR                     
         BNE   CVTX                NO - JUST EXIT                               
         MVI   EZERRCD,EZERRINV    SET ERROR CODE                               
         J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
* CVLNUM - CONVERT NUMERIC FIELD TO PL8 COUNTER                                 
* ON ENTRY: R2 EXPECTED TO ADDRESS THE FIELD                                    
*           R3 EXPECTED TO HAVE FIELD'S LENGTH                                  
* ON EXIT: DUB CONTAINS THE PL8 VALUE OF THE FIELD, EQUAL EXIT CODE             
*          BYTE CONTAINS THE ACTUAL LENGTH                                      
*                                                                               
*          EZERRCD IS SET TO EZERRINV IF FIELD INVALID, UNEQ EXIT CODE          
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
CVLNUM   NTR1  BASE=*,LABEL=*                                                   
         ZAP   DUB,=P'0'           INITIALIZE OUTPUT TO ZERO                    
         LR    R4,R2                                                            
*                                                                               
         CLI   0(R2),C' '          ANYTHING?                                    
         BNH   CVLX                NOTHING THERE - JUST EXIT                    
*                                                                               
* SPEC-22935                                                                    
* DISPLAYING MINUS SIGNS FOR NEGATIVE SPOTS                                     
         CLI   0(R2),C'-'          MINUS?                                       
         BNE   CVL05                                                            
         TM    EZFLAG,EZFNEGQ      DO WE WANT NEGATIVE NUMBERS?                 
         BZ    CVL05                                                            
*                                                                               
         LR    R4,R2               POINT R4 TO THE MINUS SIGN                   
         BCTR  R3,0                DECREMENT LENGTH                             
         AHI   R2,1                MOVE PAST MINUS SIGN                         
*                                                                               
CVL05    DS    0H                                                               
         LA    R3,0(R2,R3)         GET END                                      
         BCTR  R3,R0                                                            
         CLI   0(R3),C' '                                                       
         BH    *+8                                                              
         BCT   R3,*-8                                                           
*                                                                               
         SR    R3,R2               SET LENGTH                                   
         LA    R3,1(R3)                                                         
*                                                                               
         LR    R0,R3               R0=LENGTH                                    
         LR    R1,R2               R1=START OF FIELD                            
*                                                                               
         BRAS  RE,ISNUM                                                         
         BNE   CVLNX                                                            
         LA    R1,1(R1)                                                         
         BCT   R0,*-12                                                          
*                                                                               
         STC   R3,BYTE             SET ACTUAL LENGTH                            
*                                                                               
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         PACK  DUB,0(0,R2)                                                      
*                                                                               
         CLI   0(R4),C'-'                                                       
         BNE   CVLX                                                             
         NI    DUB+7,X'F0'                                                      
         OI    DUB+7,X'0D'                                                      
*                                                                               
CVLX     J     EQXIT                                                            
*                                                                               
CVLNX    DS    0H                                                               
         CLI   NUMERRSW,C'Y'       TEST WORRIED ABOUT ERROR                     
         BNE   CVLX                NO - JUST EXIT                               
         MVI   EZERRCD,EZERRINV    SET ERROR CODE                               
         J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
* CVTAMT - CONVERT DOLLAR FIELD                                                 
* ON ENTRY: R2 EXPECTED TO ADDRESS THE FIELD                                    
*           R3 EXPECTED TO HAVE FIELD'S LENGTH                                  
* ON EXIT: FULL CONTAINS THE BINARY VALUE OF THE FIELD, EQUAL EXIT CODE         
*          EZERRCD IS SET TO EZERRINV IF FIELD INVALID, UNEQ EXIT CODE          
*          EZERRCD IS SET TO EZERDOL IF FIELD TOO BIG, UNEQ EXIT CODE           
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
CVTAMT   NTR1  BASE=*,LABEL=*                                                   
         XC    FULL,FULL                                                        
*                                                                               
         CLI   0(R2),C' '          IF NO DATA                                   
         BNH   CVTAMTX                                                          
*                                                                               
         LA    R1,0(R2,R3)         GET END                                      
         BCTR  R1,R0                                                            
         CLI   0(R1),C' '                                                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         SR    R1,R2               SET LENGTH                                   
         LA    R1,1(,R1)                                                        
         CHI   R1,10               LESS THAN 10                                 
         BL    CVTAM10             YES - CONVERT IT                             
*                                                                               
         CLI   0(R2),C'0'          IF NON-ZERO, TOO BIG A NUMBER                
         BE    CVTAM10                                                          
*                                                                               
         OI    EZSPLKST,EZSPBDDL    SET BAD DOLLAR FIELD                        
         MVI   EZERRCD,EZERRDOL                                                 
         B     CVTAMTNX                                                         
*                                                                               
CVTAM10  DS    0H                                                               
         MVI   NUMERRSW,C'Y'       SET TO SHOW ERRORS                           
         XC    NUMMAX,NUMMAX                                                    
         BRAS  RE,CVTNUM                                                        
         BNE   CVTAMTNX                                                         
*                                  SETERR WILL RETURN TO CALLING RTN            
CVTAMTX  J     EQXIT                                                            
*                                                                               
CVTAMTNX DS    0H                                                               
         J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
* CVLAMT - CONVERT DOLLAR FIELD TO PL8 FIELD                                    
* ON ENTRY: R2 EXPECTED TO ADDRESS THE FIELD                                    
*           R3 EXPECTED TO HAVE FIELD'S LENGTH                                  
* ON EXIT: DUB CONTAINS THE BINARY VALUE OF THE FIELD, EQUAL EXIT CODE          
*          EZERRCD IS SET TO EZERRINV IF FIELD INVALID, UNEQ EXIT CODE          
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
CVLAMT   NTR1  BASE=*,LABEL=*                                                   
         ZAP   DUB,=P'0'                                                        
*                                                                               
         CLI   0(R2),C' '          IF NO DATA                                   
         BNH   CVLAMTX                                                          
*                                                                               
         LA    R1,0(R2,R3)         GET END                                      
         BCTR  R1,R0                                                            
         CLI   0(R1),C' '                                                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         SR    R1,R2               SET LENGTH                                   
         LA    R1,1(,R1)                                                        
*                                                                               
         MVI   NUMERRSW,C'Y'       SET TO SHOW ERRORS                           
         BRAS  RE,CVLNUM                                                        
         BNE   CVLAMTNX                                                         
*                                  SETERR WILL RETURN TO CALLING RTN            
CVLAMTX  J     EQXIT                                                            
*                                                                               
CVLAMTNX DS    0H                                                               
         J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* SETPROC - SET PROCESS MODES FOR CALLER (AT EOR)                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
SETPROC  NTR1  BASE=*,LABEL=*                                                   
         LA    R1,SETPTAB                                                       
*                                                                               
SETP10   CLI   0(R1),X'FF'                                                      
         BE    SETPX                                                            
         CLC   RECTYPE,0(R1)                                                    
         BE    *+12                                                             
         LA    R1,2(R1)                                                         
         B     SETP10                                                           
*                                                                               
         MVC   EZMODE,1(R1)                                                     
         BAS   RE,HOOK                                                          
*                                                                               
SETPX    J     EQXIT                                                            
         LTORG                                                                  
*                                                                               
* AL1(RECORD TYPE EQUATE),AL1(MODE EQUATE)                                      
*                                                                               
SETPTAB  DC    AL1(EZSPEQ),AL1(EZSPTP)                                          
         DC    AL1(EZSLEQ),AL1(EZSCHP)                                          
         DC    AL1(EZIHEQ),AL1(EZINVP)                                          
         DC    AL1(EZSCEQ),AL1(EZSCOMP)                                         
         DC    AL1(EZICEQ),AL1(EZICCOMP)                                        
         DC    AL1(EZIBEQ),AL1(EZIBCOMP)                                        
         DC    AL1(EZRREQ),AL1(EZRECP)                                          
         DC    X'FF'                                                            
*                                                                               
*                                                                               
*                                                                               
ISALPHA  CLI   0(R1),C'A'                                                       
         JL    ISNEQX                                                           
         CLI   0(R1),C'Z'                                                       
         JH    ISNEQX                                                           
         J     ISEQX                                                            
*                                                                               
ISNUM    CLI   0(R1),C'0'                                                       
         JL    ISNEQX                                                           
         CLI   0(R1),C'9'                                                       
         JH    ISNEQX                                                           
*                                                                               
ISEQX    CR    RB,RB                                                            
         BR    RE                                                               
ISNEQX   LTR   RB,RB                                                            
         BR    RE                                                               
*                                                                               
*                                                                               
*                                                                               
READCML  NTR1  BASE=*,LABEL=*                                                   
         L     RC,SAVWORK                                                       
         USING EZMODD,RC                                                        
         ST    R2,SVR2                                                          
         XC    HCMLDATA,HCMLDATA                                                
         MVI   RDCMLOK,C'N'                                                     
*                                                                               
         CLC   SCMLCML,0(R2)       TEST = TO SAVED CMML                         
         BNE   RDCML10                                                          
*                                                                               
         CLI   SCMLOK,C'Y'         LAST COMMERCIAL VALID?                       
         BNE   RDCMLNQX            NO - ERROR EXIT                              
*                                                                               
         MVC   HCMLDATA,SCMLDATA   YES - USE SAVED DATA                         
         B     RDCMLQX                                                          
*                                                                               
RDCML10  DS    0H                                                               
         XC    X,X                                                              
         TM    EZSPLKST,EZSPADID   ARE WE DEALING WITH AD-IDS?                  
         BZ    RDCML12             NO                                           
*                                                                               
         MVI   HCMLDATA+CMDFLN-CMDATAD,8                                        
         MVC   X(8),0(R2)                                                       
         B     RDCML14                                                          
*                                                                               
RDCML12  LA    R3,L'EZSPCML1-1(R2) FIND ACTUAL LENGTH                           
         CLI   0(R3),C' '                                                       
         BH    *+8                                                              
         BCT   R3,*-8                                                           
         SR    R3,R2               LENGTH MINUS 1                               
         LA    R3,1(R3)                                                         
         STC   R3,HCMLDATA+CMDFLN-CMDATAD                                       
*                                                                               
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   X(0),0(R2)                                                       
*                                                                               
* FIRST SEE IF IT IS ALREADY SAVED IN BINSRCH TABLE                             
*                                                                               
RDCML14  DS    0H                                                               
         OC    BINSRCH,BINSRCH     IS THERE A BINSRCH RTN AVAIL                 
         BZ    RDCML20             NO - READ FROM DISK                          
*                                                                               
         GOTO1 BINSRCH,BSCPARS,(1,X)                                            
         OC    1(3,R1),1(R1)       TEST TABLE FULL                              
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL - FOR NOW JUST DUMP               
*                                                                               
         L     R5,0(R1)            A(ENTRY)                                     
         ST    R5,SVCMTENT         SAVE A(ENTRY)                                
         CLI   0(R1),1             TEST RECORD FOUND                            
         BE    RDCML20             NO - READ FROM DISK                          
                                                                                
         USING CMTABD,R5                                                        
*                                  YES, RECORD FOUND - USE TABLE DATA           
         CLI   CMTUSABL,C'Y'       IS COMMERCIAL USABLE?                        
         BNE   RDCML50             NO - GO SAVE DATA AND EXIT                   
*                                                                               
         MVC   HCMLDATA,CMTDATA    YES - SAVE INFO                              
         MVI   RDCMLOK,C'Y'        INDICATE COMML OK                            
         B     RDCML50             SAVE LAST COMML DATA AND EXIT                
*                                                                               
* COMML RECORD NOT IN THE BINSEARCH TABLE                                       
* READ IT FROM DISK                                                             
*                                                                               
RDCML20  DS    0H                                                               
         XC    KEYSAVE,KEYSAVE                                                  
*                                                                               
RDCML20A DS    0H                                                               
         XC    KEY,KEY             READ FOR CMML REC                            
         LA    R6,KEY                                                           
*                                                                               
         TM    EZSPLKST,EZSPADID   USING AD-IDS?                                
         BO    RDCML21             YES                                          
*                                                                               
         USING CMLRECD,R6                                                       
         MVC   CMLKID,=X'0A21'                                                  
         MVC   CMLKAM,EZBAGYMD                                                  
         MVC   CMLKCLT,EZIHLADB    CLIENT CODE                                  
         OC    EZIHLADT,EZIHLADT     IS THERE AN OVERRIDE CLIENT                
         BZ    *+10                                                             
         MVC   CMLKCLT,EZIHLADT    TRAFFIC LINKED CLIENT CODE                   
         MVC   CMLKCML,X                                                        
         B     RDCML22                                                          
*                                                                               
RDCML21  DS    0H                  AD-ID HERE                                   
         USING CMLPIDAD,R6                                                      
         CLC   =X'0AC1',KEYSAVE                                                 
         BE    *+14                                                             
         MVC   CMLPIDAD(2),=X'0AC1'                                             
         B     *+10                                                             
*                                                                               
         MVC   CMLPIDAD(2),=X'0AC2'                                             
         MVC   CMLPADAM,EZBAGYMD                                                
         MVC   CMLPADCL,EZIHLADB                                                
         OC    EZIHLADT,EZIHLADT    USE TRAFFIC CLIENT                          
         BZ    *+10                                                             
         MVC   CMLPADCL,EZIHLADT    OTHERWISE USE NORMAL CLIENT                 
         MVC   CMLPADID,X                                                       
*                                                                               
RDCML22  DS    0H                                                               
         MVC   SVCMLKEY,KEY        SAVE CMML KEY                                
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BNE   RDCML40             COMMERCIAL RECORD NOT FOUND                  
*                                                                               
* COMMERCIAL RECORD NOT FOUND                                                   
*                                                                               
*        TM    EZSPLKST,EZSPADID   WORKING WITH AD-ID?                          
*        BO    RDCML40             YES - SAVE DATA AND EXIT                     
*                                                                               
*        MVC   KEY,KEYSAVE                                                      
*        MVC   CMLKID,=X'0AE1'     LOOK FOR TELECASTER NUMBER                   
*        BAS   RE,HIGH                                                          
*                                                                               
*        CLC   KEY(13),KEYSAVE                                                  
*        BNE   RDCML40                                                          
*                                                                               
* COMMERCIAL RECORD FOUND ON DISK                                               
*                                                                               
RDCML24  DS    0H                                                               
         CLC   =X'0A21',KEY        ACTIVE KEY?                                  
         BNE   *+12                NO                                           
         TM    KEY+CMLKSTAT-CMLKEY,CMLKSTA_PCKD PACKED AD-ID?                   
         BO    RDCML40             YES, SHOULD BE 8-CHAR COMML, SKIP IT         
*                                                                               
         MVI   RDCMLOK,C'Y'                                                     
         BAS   RE,GET                                                           
*                                                                               
         CLC   =X'0AC2',KEY        HI-DEF?                                      
         BNE   *+8                                                              
         OI    HCMLDATA+CMDSEQ+2-CMDATAD,X'01'   INCICATE HI-DEF                
*                                                                               
         L     R6,EZAREC                                                        
         MVC   HCMLDATA+CMDSEQ-CMDATAD(2),CMLSEQ+1-CMLRECD(R6)                  
         MVC   HCMLDATA+CMDSLN-CMDATAD(L'CMDSLN),CMLSLN-CMLRECD(R6)             
         MVC   HCMLDATA+CMDSOLO-CMDATAD(L'CMDSOLO),CMLSOLO-CMLRECD(R6)          
*                                                                               
         LA    R6,24(R6)                                                        
*                                                                               
RDCML30  DS    0H                  LOOK FOR PRD LIST ELEM                       
         CLI   0(R6),0             EOR                                          
         BE    RDCML40                                                          
*                                                                               
         CLI   0(R6),X'20'                                                      
         BNE   RDCML30A                                                         
         MVC   HCMLDATA+CMD1PRDL-CMDATAD(L'CMD1PRDL),2(R6)                      
*                                                                               
         CLI   HCMLDATA+CMDSOLO-CMDATAD,C'P'                                    
         BNE   RDCML31                                                          
*                                                                               
         MVC   HCMLDATA+CMD1PGB-CMDATAD(L'CMD1PGB),=X'FF'                       
         CLI   1(R6),4             IS THERE 2ND PRODUCT?                        
         BL    RDCML31                                                          
         MVC   HCMLDATA+CMD1PGB-CMDATAD(L'CMD1PGB),3(R6)                        
*                                                                               
         B     RDCML31                                                          
*                                                                               
RDCML30A DS    0H                                                               
         CLI   0(R6),X'29'                                                      
         BNE   RDCML31                                                          
         MVC   HCMLDATA+CMD3PRDL-CMDATAD(L'CMD3PRDL),2(R6)                      
*                                                                               
         CLI   HCMLDATA+CMDSOLO-CMDATAD,C'P'                                    
         BNE   RDCML31                                                          
*                                                                               
         MVC   HCMLDATA+CMD3PGB-CMDATAD(L'CMD3PGB),=C'POL'                      
         CLI   1(R6),8             IS THERE 2ND PRODUCT?                        
         BL    RDCML31                                                          
         MVC   HCMLDATA+CMD3PGB-CMDATAD(L'CMD3PGB),5(R6)                        
*                                                                               
RDCML31  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R6)                                                         
         AR    R6,R0                                                            
         B     RDCML30                                                          
*                                                                               
* SAVE DATA AND EXIT                                                            
*                                                                               
RDCML40  DS    0H                  SAVE IN BINSRCH TABLE                        
         CLC   =X'0AC1',KEYSAVE                                                 
         BE    RDCML20A                                                         
*                                                                               
         OC    BINSRCH,BINSRCH     IS THERE A BINSRCH RTN AVAIL                 
         BZ    RDCML50                                                          
*                                                                               
         L     R5,SVCMTENT         A(TABLE ENTRY)                               
         USING CMTABD,R5                                                        
         MVC   CMTUSABL,RDCMLOK                                                 
         MVC   CMTDATA,HCMLDATA                                                 
         DROP  R5                                                               
*                                                                               
RDCML50  DS    0H                  SAVE LAST COMMERCIAL'S DATA                  
         L     R2,SVR2                                                          
         MVC   SCMLCML,0(R2)       SAVE COMMERCIAL                              
         MVC   SCMLOK,RDCMLOK      SAVE FLAG                                    
         MVC   SCMLDATA,HCMLDATA   SAVE DATA                                    
*                                                                               
         CLI   SCMLOK,C'Y'                                                      
         BNE   RDCMLNQX                                                         
*                                                                               
RDCMLQX  DS    0H                                                               
         J     EQXIT                                                            
*                                                                               
RDCMLNQX DS    0H                                                               
         XC    HCMLDATA,HCMLDATA                                                
         J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
*                                                                               
* R0 = A(TEXT TO SEARCH), HOB = LENGTH OF TEXT TO SEARCH                        
* HALF = LENGTH OF TEXT                                                         
* FULL = A(TEXT)                                                                
* ON EXIT FULL = 0 IF NOT FOUND OR A(SUBSTRING)                                 
SUBSTR   NTR1  BASE=*,LABEL=*                                                   
         LR    RE,R0                                                            
         SRL   RE,24               RE = LENGTH OF TEXT TO SEARCH                
*                                                                               
         LR    R2,R0               R2 = ADD OF TEXT TO SEARCH                   
*                                                                               
         L     R1,FULL             R1 = A(TEXT)                                 
*                                                                               
         LR    RF,R1               RF = A(TEXT)                                 
         AH    RF,HALF             RF - PAST END OF TEXT                        
         SR    RF,RE               ADDR FOR LAST CLC                            
*                                                                               
         BCTR  RE,0                FOR EXECUTED CLC                             
*                                                                               
SUBS10   CR    R1,RF                                                            
         BH    SUBSNQX                                                          
         EX    RE,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R1),0(R2)                                                    
         BE    SUBSQX                                                           
         LA    R1,1(R1)                                                         
         B     SUBS10                                                           
*                                                                               
SUBSQX   DS    0H                                                               
         ST    R1,FULL                                                          
         J     EQXIT                                                            
SUBSNQX  DS    0H                                                               
         J     NEQXIT                                                           
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
* FAKEIND - ROUTINE TO FILL IN INDEX FIELDS                                     
* THIS IS TO BE USED WITH DDWRKIO CALLS                                         
* ROUTINE WILL POPULATE THE FOLLOWING FIELDS                                    
* WITH DATA TAKEN FROM DDWRKIOD:                                                
* EZWIMED                                                                       
* EZWISTN                                                                       
* EZWKRIND(2) - USER ID                                                         
* W_AGELD                                                                       
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
FAKEIND  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LAY   R1,WRKEZKEY                                                      
         USING WRKEZKEY,R1                                                      
*                                                                               
         LA    R2,EZWKRIND                                                      
*                                                                               
         USING EZWKRIXD,R2                                                      
         MVC   EZWIUID,WRKEZUID                                                 
         MVC   EZWISTN,WRKEZSCL    STA CALL LETTERS                             
         MVC   EZWIMED,WRKEZMED    MEDIA                                        
         DROP  R2                                                               
*                                                                               
         USING W_RECD,R2                                                        
         MVC   W_AGELD,WRKEZBDT    BATCH DATE                                   
         DROP  R2,R1                                                            
*                                                                               
         J     EQXIT                                                            
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
* POPULATES FIELDS IN HCMLDATA WITH DATA FROM COMML RECORD IN EZAREC            
FILLHCML NTR1  BASE=*,LABEL=*                                                   
         LA    R2,HCMLDATA                                                      
         USING CMDATAD,R2                                                       
*                                                                               
         MVC   DATADISP,=AL2(24)   TRFFIL                                       
*                                                                               
         L     R6,EZAREC                                                        
         MVI   ELCODE,X'24'        CMLXDTEL                                     
         BRAS  RE,GETEL                                                         
         BNE   FHCML10                                                          
*                                                                               
         USING CMLXDTEL,R6                                                      
*                                                                               
         OC    CMLXHDEF,CMLXHDEF                                                
         BZ    FHCML10                                                          
         OI    CMDSEQ+2,X'01'      INCICATE HI-DEF                              
*                                                                               
         DROP  R6                                                               
*                                                                               
FHCML10  DS    0H                                                               
         L     R6,EZAREC                                                        
         MVI   ELCODE,X'10'        CMLDTAEL                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING CMLDTAEL,R6                                                      
*                                                                               
         MVC   CMDSEQ(2),CMLSEQ+1                                               
         MVC   CMDSLN,CMLSLN                                                    
         MVC   CMDSOLO,CMLSOLO                                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
FHCML20  DS    0H                                                               
         L     R6,EZAREC                                                        
         MVI   ELCODE,X'20'        CMLPRDEL                                     
         BRAS  RE,GETEL                                                         
         BNE   FHCML30                                                          
*                                                                               
         USING CMLPRDEL,R6                                                      
*                                                                               
         MVC   CMD1PRDL,CMLPRDS                                                 
*                                                                               
         CLI   CMDSOLO,C'P'                                                     
         BNE   FHCML30                                                          
*                                                                               
         MVI   CMD1PGB,X'FF'                                                    
         CLI   CMLPRDLN,4          IS THERE 2ND PRODUCT?                        
         BL    FHCML30                                                          
         MVC   CMD1PGB,CMLPRDS+L'CMLPRDS                                        
*                                                                               
         DROP  R6                                                               
*                                                                               
FHCML30  DS    0H                                                               
         L     R6,EZAREC                                                        
         MVI   ELCODE,X'29'        CMLMPREL                                     
         BRAS  RE,GETEL                                                         
         BNE   FHCML40                                                          
*                                                                               
         USING CMLMPREL,R6                                                      
*                                                                               
         MVC   CMD3PRDL,CMLMPRS                                                 
*                                                                               
         CLI   CMDSOLO,C'P'                                                     
         BNE   FHCML40                                                          
*                                                                               
         MVC   CMD3PGB,=C'POL'                                                  
         CLI   CMLMPRLN,6          IS THERE 2ND PRODUCT?                        
         BL    FHCML40                                                          
         MVC   CMD3PGB,CMLMPRS+L'CMLMPRS                                        
*                                                                               
         DROP  R6                                                               
*                                                                               
FHCML40  DS    0H                                                               
*                                                                               
         J     EQXIT                                                            
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
         GETEL (R6),DATADISP,ELCODE                                             
*                                                                               
*                                                                               
* SEND EMAIL FOR DATAMGR ERROR, DO NOT DIE *                                    
TELL     NMOD1 0,**+TEL**                                                       
         USING EZBLOCKD,R9                                                      
         USING COMSUBS,RA                                                       
         L     RC,SAVWORK          RESTORE WORK AREA ADDRESS                    
         USING EZMODD,RC                                                        
*                                                                               
         MVC   WORK,DMCB                                                        
*                                                                               
         GOTO1 EZPRINT,DMCB,=C'CLOSE'                                           
*                                                                               
         L     R4,EZMAST                                                        
         USING MASTD,R4                                                         
         L     R5,MCVREMOT                                                      
         USING REMOTED,R5                                                       
         MVC   SVREMOT2,0(R5)                                                   
*                                                                               
         MVC   REMOTABF,MCVPQBUF                                                
         MVC   REMOTADM,MCVDMGR                                                 
         MVC   REMOTAOP,MCVPQOPN                                                
*        MVC   REMOTDST,=AL2(6954)  DDSEMAIL ID RECORD - TEST                   
         MVC   REMOTDST,=AL2(8093)  DDSEMAIL ID RECORD - LIVE                   
         MVC   REMOTKEY(11),SPACES                                              
         MVC   REMOTSYS(08),=C'Z5 EZMOD'                                        
         MVI   REMOTCPY,C'1'                                                    
         MVI   REMOTCLS,C'G'                                                    
         MVC   REMOTJID,=C'SZ5'                                                 
*                                                                               
         MVC   P(L'HDRREC),HDRREC                                               
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
         MVC   P,SPACES                                                         
         MVC   P(L'TRNREC),TRNREC                                               
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(L'RCPREC),RCPREC                                               
         MVC   P+15(5),=C'BGRIN'                                                
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(L'SUBREC),SUBREC                                               
         MVC   P+15(L'SUBJECTD),SUBJECTD                                        
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(L'LINE2),LINE2                                                 
         MVC   P+7(L'EZAGY),EZAGY                                               
         MVC   P+L'LINE2(L'MCUSERID),MCUSERID                                   
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(L'LINE3),LINE3                                                 
         MVC   P+7(7),EZBTSTN                                                   
         MVC   P+19(L'EZIHINV),EZIHINV                                          
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,EZWKRIND+8                                                  
         CLI   EZWRKIOF,C'Y'                                                    
         BNE   *+10                                                             
         ICMY  R0,15,WRKEZSQN                                                   
         EDIT  (R0),(6,P+34),ALIGN=LEFT                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,EZBTBRDT),(5,P+L'LINE3)                           
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(L'LINE4),LINE4                                                 
         L     RF,WORK                                                          
         MVC   P+8(6),0(RF)                                                     
         L     RF,WORK+4                                                        
         MVC   P+15(3),3(RF)                                                    
         GOTO1 HEXOUT,DMCB,WORK+8,P+23,1,0,0                                    
         GOTO1 HEXOUT,DMCB,KEY,P+L'LINE4,18,0,0                                 
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(4),=C'SEQ='                                                    
         GOTO1 HEXOUT,DMCB,CMLSEQ+1-CMLRECD(R6),P+4,3,0,0                       
         MVC   P+11(4),=C'SADV='                                                
         GOTO1 HEXOUT,DMCB,SADVCMML,P+16,2,0,0                                  
         MVC   P+23(7),=C'KEYSAV='                                              
         GOTO1 HEXOUT,DMCB,KEYSAVE,P+L'LINE4,13,0,0                             
         GOTO1 EZPRINT,DMCB,PM1,=C'BL01'                                        
*                                                                               
         GOTO1 EZPRINT,DMCB,=C'CLOSE'                                           
         MVC   0(80,R6),SVREMOT2                                                
*                                                                               
         MVI   SKIPSW,C'Y'         YES- SET SKIP SWITCH                         
         LA    R2,EZSPCOPY         SET ERROR FIELD                              
         SR    R2,R2                                                            
         MVI   EZERRCD,EZERDMGR    DATAMGR ERROR                                
         BAS   RE,SETERR                                                        
         XIT1                                                                   
         DROP  R4,R5,RC                                                         
*                                                                               
HDRREC   DC    C'    *HDR*                         WP                  +        
                              M'                                                
*                                                                               
TRNREC   DC    C'++DDS X XXXTRN'                                                
*                                                                               
RCPREC   DC    C'++DDS      RCP '                                               
*                                                                               
CCRREC   DC    C'++DDS      CCR '                                               
*                                                                               
BCCREC   DC    C'++DDS      BCC '                                               
*                                                                               
SUBREC   DC    C'++DDS      SUB '                                               
*                                                                               
*                       7                                                       
LINE2    DC    C'Z5 AGY=XX ID='                                                 
*                                                                               
*                       7           19             34                           
LINE3    DC    C'Z5 STA XXXX-XX INV=XXXXXXXXXX SEQ=XXXXXX B DTE='               
*                                                                               
*                        8      15      23                                      
LINE4    DC    C'Z5 DMGR COMMND FIL ERR=ER KEY='                                
SUBJECTD DC    C'Z5 CONVERSION DATAMGR ERROR'                                   
SVREMOT2 DS    XL80                                                             
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*                                  ERROR TABLE                                  
*                                  CODE(1),LEVEL(1),MESSAGE(40)                 
*                                                                               
ERRTAB   DS    0C                                                               
         DC    AL1(EZERRMIS)       MISSING FIELD                                
         DC    AL1(0)              LEVEL                                        
         DC    CL40'MISSING FIELD'                                              
*                                                                               
ERRTABL  EQU   *-ERRTAB                                                         
*                                                                               
         DC    AL1(EZERRINV)       INVALID DATA                                 
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID DATA'                                               
*                                                                               
         DC    AL1(EZERRRNF)       RECORD NOT FOUND                             
         DC    AL1(0)              LEVEL                                        
         DC    CL40'RECORD NOT FOUND'                                           
*                                                                               
         DC    AL1(EZERRPRD)       PRODUCT INCONSISTENCY                        
         DC    AL1(0)              LEVEL                                        
         DC    CL40'PRODUCTS INCONSISTENT'                                      
*                                                                               
         DC    AL1(EZERRPIG)       PIGGYBACK ERROR                              
         DC    AL1(0)              LEVEL                                        
         DC    CL40'PIGGYBACK ERROR'                                            
*                                                                               
         DC    AL1(EZERRCPR)       CMML/PRD ERROR                               
         DC    AL1(0)              LEVEL                                        
         DC    CL40'COMMERCIAL NOT VALID FOR PRODUCT'                           
*                                                                               
         DC    AL1(EZERROMN)       OUT OF MONTH                                 
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DATE OUT OF MONTH'                                     
*                                                                               
         DC    AL1(EZERRFLN)       FIELD TOO LONG                               
         DC    AL1(0)              LEVEL                                        
         DC    CL40'FIELD TOO LONG- DATA HAS BEEN TRUNCATED'                    
*                                                                               
         DC    AL1(EZERRSCO)       STANDARD COMMENT OVERFLOW                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'TOO MANY STANDARD COMMENTS'                                 
*                                                                               
         DC    AL1(EZERRRTP)       BAD RECORD TYPE                              
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID RECORD TYPE'                                        
*                                                                               
         DC    AL1(EZERRSCD)       INVALID SPOTPAK CLT/PRD CODE                 
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID SPOTPAK CODE'                                       
*                                                                               
         DC    AL1(EZERRSPL)       SPOT DETAIL SPOT LENGTH ZERO                 
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL SPOT LENGTH ZERO'                               
*                                                                               
         DC    AL1(EZERRDOL)       INVALID DOLLAR FIELD                         
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID DOLLARS'                                            
*                                                                               
         DC    AL1(EZERBDDT)       INVALID DATE FIELD                           
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID DATE'                                               
*                                                                               
         DC    AL1(EZERDMGR)       DATAMGR PROBLEM                              
         DC    AL1(0)              LEVEL                                        
         DC    CL40'DMGR-CALL DDS'                                              
*                                                                               
         DC    AL1(EZERFILM)       INVALID FILM CODE                            
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID COMMERCIAL CODE'                                    
*                                                                               
         DC    AL1(EZERMCLT)       CLIENT CODE MISSING                          
         DC    AL1(0)              LEVEL                                        
         DC    CL40'CLIENT CODE MISSING'                                        
*                                                                               
         DC    AL1(EZERMPRD)       PRODUCT CODE MISSING                         
         DC    AL1(0)              LEVEL                                        
         DC    CL40'PRODUCT CODE MISSING'                                       
*                                                                               
         DC    AL1(EZERRENF)       ESTIMATE NOT ON FILE                         
         DC    AL1(0)              LEVEL                                        
         DC    CL40'ESTIMATE NOT ON FILE'                                       
*                                                                               
         DC    AL1(EZERREP)        REP ID NOT ON FILE                           
         DC    AL1(0)              LEVEL                                        
         DC    CL40'REP ID NOT ON FILE'                                         
*                                                                               
         DC    AL1(EZERINVN)       INVALID INVOICE NAME                         
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVOICE NUMBER INVALID'                                     
*                                                                               
         DC    AL1(EZERADVN)       ADVERTISER NAME MISSING                      
         DC    AL1(0)              LEVEL                                        
         DC    CL40'CLIENT NAME MISSING'                                        
*                                                                               
         DC    AL1(EZERRCLT)       CLIENT CODE INVALID                          
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID CLIENT CODE'                                        
*                                                                               
         DC    AL1(EZERRDAR)       DARE PROFILE NOT SET UP                      
         DC    AL1(0)              LEVEL                                        
         DC    CL40'NO REP CODE ON DAR PROFILE'                                 
*                                                                               
         DC    AL1(EZERDREP)       DISCREPANT REP CODES                         
         DC    AL1(0)              LEVEL                                        
         DC    CL40'DISCREPANT REP CODES'                                       
*                                                                               
         DC    AL1(EZERRACT)       ACTUALS: BAD DATA                            
         DC    AL1(0)              LEVEL                                        
         DC    CL40'ACTUALS: BAD DATA'                                          
*                                                                               
         DC    AL1(EZERRDEM)       INCONSISTENT DEMO VALUES                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'ACTUALS: DEMOS INCONSISTENT'                                
*                                                                               
         DC    AL1(EZERRCAC)       CAN'T ADD COMMERCIALS SOON                   
         DC    AL1(0)              LEVEL                                        
         DC    CL40'CANNOT ADD COMMERCIALS FROM SOON REPORTS'                   
*                                                                               
         DC    AL1(EZERRBLB)       INVALID BILLBOARD INDICATOR                  
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID BILLBOARD INDICATOR'                                
*                                                                               
         DC    AL1(EZERRENO)       ESTIMATE NOT OPEN                            
         DC    AL1(0)              LEVEL                                        
ERENOMSG DC    C'EST '                                                          
ERENOEST DC    C'   '                                                           
         DC    C' MISSING FOR PRD '                                             
ERENOPRD DC    C'   '                                                           
         DC    C'/'                                                             
ERENOCML DC    C'            '                                                  
*                                                                               
         DC    X'FFFF'                                                          
*                                                                               
*                                                                               
*                                                                               
*                                                                               
* INITIALIZE WORK AREAS FOR COMMERCIALS, AD-IDS, PACKED AD-IDS                  
         USING EZMODD,RC                                                        
XCCML    NTR1  BASE=*,LABEL=*                                                   
         MVI   EZSPPIG,C'N'        SET NOT A PIGGY                              
         NI    EZSPLKST,X'FF'-EZSPADID                                          
*                                                                               
         XC    GETADBLK(GBLENQ),GETADBLK                                        
         XC    SVCMLS,SVCMLS                                                    
*                                                                               
         XC    EZSPCML1,EZSPCML1                                                
         XC    EZSPLCM1,EZSPLCM1                                                
         XC    EZSPLPB1,EZSPLPB1                                                
         XC    EZSPLPC1,EZSPLPC1                                                
         XC    CMLPRDL1,CMLPRDL1                                                
*                                                                               
         XC    EZSPCML2,EZSPCML2                                                
         XC    EZSPLCM2,EZSPLCM2                                                
         XC    EZSPLPB2,EZSPLPB2                                                
         XC    EZSPLPC2,EZSPLPC2                                                
         XC    CMLPRDL2,CMLPRDL2                                                
*                                                                               
         J     EQXIT                                                            
         LTORG                                                                  
*                                                                               
*                                                                               
*                                  LENGTH OF ADDED CMML REC                     
*                                  (NOTE 3 = PRD LIST ELEM)                     
*                                                                               
PRTABD   DSECT                     LOOKED UP PRODUCT TABLE DSECT                
PRTCOD   DS    CL3                 3-CHAR PRODUCT CODE                          
PRKEYLQ  EQU   *-PRTABD                                                         
*                                                                               
PRTBIN   DS    XL1                 BINARY CODE                                  
PRTNAM   DS    CL20                PRODUCT NAME                                 
*                                  PRTNAM=X'FF' - PRD NOT FOUND                 
PRTESTAB DS    XL256               ESTIMATE TABLE                               
PRTABDLQ EQU   *-PRTABD                                                         
*                                                                               
* * * * * *                                                                     
* CMDATAD                                                                       
* DSECT TO COVER DATA USED FOR FILMCODE PROCESSING                              
* PURPOSE - TO STANDARDIZE THE HOLD, SAVE AND BINSEARCH DATA                    
* * * * * *                                                                     
*                                                                               
CMDATAD  DSECT                                                                  
CMD1PRDL DS    X                                                                
CMD3PRDL DS    XL3                                                              
CMD1PGB  DS    X                                                                
CMD3PGB  DS    XL3                                                              
CMDSEQ   DS    XL3                 2 SEQ, 1 FLAG                                
*        EQU   X'80                TO AVOID MIXUP WITH X'FF',DO NOT USE         
*        EQU   X'01'               HD                                           
CMDSLN   DS    X                                                                
CMDFLN   DS    X                                                                
CMDSOLO  DS    C                   S=SOLO, P=PIGGYBACK                          
CMDATALQ EQU   *-CMDATAD                                                        
*                                                                               
*                                                                               
*                                                                               
* NEW COMMERCIAL TABLE (BINSEARCH) DSECT, UTILIZES CMDATAD                      
*                                                                               
CMTABD   DSECT                     CMML TABLE DSECT                             
CMTCML   DS    CL8                 CMML CODE                                    
CMKEYL   EQU   *-CMTABD                                                         
*                                                                               
CMTDATA  DS    XL(CMDATALQ)        SAVED DATA                                   
CMTUSABL DS    C                   USABLE ENTRY FLAG                            
*                                                                               
CMTABDL  EQU   *-CMTABD                                                         
*                                                                               
*                                                                               
*                                                                               
EZMODD   DSECT                                                                  
RELO     DS    F                                                                
WORK     DS    XL64                                                             
X        DS    XL100                                                            
BLOCK    DS    XL64                                                             
DUB      DS    D                                                                
DMCB     DS    6F                                                               
FULL     DS    F                                                                
HALF     DS    H                                                                
DATADISP DS    H                                                                
BYTE     DS    X                                                                
BYTE2    DS    X                                                                
SBRE     DS    A                                                                
ELCODE   DS    X                                                                
*                                                                               
SPACES   DS    CL132                                                            
PM1      DS    C                                                                
P        DS    CL132                                                            
KEY      DS    CL32                                                             
KEYSAVE  DS    CL32                                                             
*                                                                               
SVPRDS   DS    0H                                                               
SVPRD1   DS    CL3               FOR PRODUCT LOOKUP                             
SVPRD2   DS    CL3                                                              
SVEST    DS    X                                                                
SVPRDSLQ EQU   *-SVPRDS                                                         
*                                                                               
T1PROF   DS    XL16                                                             
*                                                                               
CALLOV   DS    A                                                                
ADDAY    DS    A                                                                
GETDAY   DS    A                                                                
GETPROF  DS    A                                                                
NUMVAL   DS    A                                                                
TIMVAL   DS    A                                                                
UNTIME   DS    A                                                                
CASHVAL  DS    A                                                                
DATVAL   DS    A                                                                
DATCON   DS    A                                                                
DAYPAK   DS    A                                                                
DAYUNPK  DS    A                                                                
DATAMGR  DS    A                                                                
CLPACK   DS    A                                                                
CLUNPK   DS    A                                                                
HEXOUT   DS    A                                                                
PARSNIP  DS    A                                                                
BINSRCH  DS    A                                                                
GETBROAD DS    A                                                                
TRPACK   DS    A                                                                
SCANNER  DS    A                                                                
*                                                                               
AERRTAB  DS    A                                                                
AFLDCVT  DS    A                                                                
ALKCML   DS    A                                                                
*                                                                               
CALLRD   DS    F                                                                
FLDHDR   DS    A                                                                
FLDFRST  DS    A                                                                
RECTYPE  DS    CL1                                                              
RECTYPSV DS    CL1                                                              
BADRCD   DS    CL1                 Y=BAD RECORD CODE                            
NEWCMLSW DS    CL1                                                              
SKIPVAL  DS    CL1                 INV DELETED/CONVERTED - NO LOOKUP            
*                                                                               
BSPPARS  DS    6F                  BINSRCH PARS FOR PRD TAB                     
BSCPARS  DS    6F                  BINSRCH PARS FOR CMML TAB                    
*                                                                               
SVCMTENT DS    A                                                                
SVPLTENT DS    A                                                                
*                                                                               
SADVDATA DS    0CL(SADVDTLQ)       ADV SAVE DATA                                
SADVDAT1 DS    0X                                                               
SADVNM   DS    CL25                INVOICE NAME                                 
SADVNAM  DS    CL20                LOOKED UP NAME                               
SADVCOD  DS    CL3                                                              
SADVBIN  DS    XL2                                                              
SADVCMML DS    XL3                 HIGHEST CMML SEQ                             
SADVBINC DS    XL2                                                              
SADVMGRP DS    CL1                                                              
         DS    CL4                 SPARE                                        
SADVDTLQ EQU   *-SADVDAT1                                                       
*                                                                               
SPRDDATA DS    0CL75               PRODUCT SAVE AREA                            
SPRDNM   DS    CL25                INVOICE NAME                                 
SPRDNAM  DS    CL20                LOOKED UP NAME                               
SPRDCOD  DS    CL3                                                              
SPRDBIN  DS    XL1                                                              
SPRDNAM2 DS    CL20                LOOKED UP NAME                               
SPRDCOD2 DS    CL3                                                              
SPRDBIN2 DS    XL1                                                              
SPRDEST  DS    XL1                                                              
SPRDLKST DS    XL1                                                              
*                                                                               
RDCMLOK  DS    C                                                                
*                                                                               
SCMLINFO DS    0CL(CMDATALQ+9)                                                  
SCMLCML  DS    CL8                 SAVED COMMERCIAL DATA (CODE)                 
SCMLOK   DS    C                   Y=VALID,N=INVALID                            
SCMLDATA DS    XL(CMDATALQ)                                                     
*                                                                               
*                                                                               
*                                                                               
SVLKSTAT DS    XL1                 SAVED LOOKUP STATUS                          
SVADVERR DS    X                   SAVED ADV LOOKUP ERROR                       
*                                  FIELDS SET BY GETFLD                         
ANXTPRD  DS    A                                                                
ANXTCML  DS    A                                                                
*                                                                               
RFDATA   DS    XL256                                                            
RFLEN    DS    XL1                                                              
*                                                                               
RDELIM   DS    CL1                 RECORD DELIMITER                             
FDELIM   DS    CL1                 FIELD DELIMITER                              
*                                                                               
ERRFLDD  DS    S                                                                
EDATE    DS    CL6                 YYMMDD                                       
DDATE    DS    CL8                 MMMDD/YY                                     
BDATE    DS    XL3                 BINARY 3                                     
*                                                                               
HPRDDATA DS    0H                                                               
*                                                                               
HPRDNAM  DS    CL20                                                             
HPRDCOD  DS    CL3                                                              
HPRDBIN  DS    XL1                                                              
HPRDEST  DS    XL1                                                              
HPRDLKST DS    XL1                 LOOKUP STATUS                                
*                                                                               
HPRDDTLQ EQU   *-HPRDDATA                                                       
*                                                                               
* NEW COMMERCIAL HOLD DATA DEFINITION, UTILIZING CMDATAD                        
*                                                                               
HCMLDATA DS    CL(CMDATALQ)                                                     
*                                                                               
*                                                                               
CMLPRDL1 DS    XL1                                                              
CML3PRL1 DS    XL3                                                              
CMLPRDL2 DS    XL1                                                              
CML3PRL2 DS    XL3                                                              
*                                                                               
WFSTATN  DS    CL5                 STATION FROM WKR FILE KEY                    
ELSEL    DS    XL1                                                              
SVR2     DS    A                                                                
*                                                                               
         DS    0D                                                               
SAVSYS   DS    XL1                                                              
DMIBTS   DS    XL1                                                              
DMOBTS   DS    XL1                                                              
SVCMLKEY DS    CL13                                                             
SCTOPSW  DS    CL1                                                              
SCBOTSW  DS    CL1                                                              
SCTOPPTR DS    H                                                                
SCBOTPTR DS    H                                                                
NUMERRSW DS    CL1                                                              
NUMMAX   DS    F                                                                
SVCMLS   DS    XL16                                                             
*                                                                               
GETADFLG DS    X                                                                
GADROPQ  EQU   X'01'               DROPPING SPACES,DASHES                       
GAPIGQ   EQU   X'02'               PROCESSING PIGGYBACK                         
GADASHQ  EQU   X'04'               DROP ALL DASHES FROM AD-ID                   
*                                                                               
*                                                                               
*                                                                               
GETADBLK DS    0X                                                               
GBADID   DS    CL12                                                             
GBLEN    DS    X                                                                
GBFLAG   DS    C                   AD-ID 1 PROPERTIES                           
GBPADQ   EQU   X'01'               PADDED                                       
GBZEROQ  EQU   X'02'               PAD CHARACTER = C'0'                         
GBSPACEQ EQU   X'04'               PAD CHARACTER = C' '                         
GBPIGQ   EQU   X'08'               POTENTIAL PIGGYBACK SITUATION                
         ORG   GETADBLK                                                         
*                                                                               
GBADID1  DS    CL14                                                             
GBADID2  DS    CL14                                                             
*                                                                               
GBLENQ   EQU   *-GETADBLK                                                       
*                                                                               
*                                                                               
*                                                                               
ENDWFREC DS    A                                                                
*                                                                               
LKCMLPRM DS    CL14                PASSED TO LKCML                              
*                                                                               
SVDARREP DS    CL3                 REP CODE FROM DAR PROFILE                    
*                                                                               
         DS    0D                                                               
DMWORK   DS    XL96                                                             
SVCLIST  DS    1020C               USED TO BE 880                               
PRTABWRK DS    XL(PRTABDLQ)                                                     
*                                                                               
ELEM     DS    XL256                                                            
*                                                                               
EZMODDL  EQU   *-EZMODD                                                         
*                                                                               
       ++INCLUDE EZBLOCK                                                        
*                                                                               
EZBLOCKD DSECT                                                                  
         ORG   EZWRKIOB                                                         
       ++INCLUDE DDWRKIOD                                                       
         ORG                                                                    
*                                                                               
         ORG   EZWKA               SAVED WORK AREA                              
SAVWORK  DS    F                                                                
SVEZMODE DS    X                                                                
SKIPSW   DS    CL1                                                              
SVWKRIND DS    XL44                                                             
*                                                                               
RFCNTL   DS    XL1                 X'80'=EOF, X'40'=EOR,                        
*                                  X'20'=FIELD LENGTH ERROR                     
RFFLDNO  DS    XL1                                                              
RFCNTL2  DS    XL1                 (GETFLD INTERNAL CONTROL)                    
RFCURPOS DS    A                                                                
*                                                                               
RECSWS   DS    0CL20               RECORD SWITCHES                              
SNRSW    DS    CL1                                                              
PYRSW    DS    CL1                                                              
AGRSW    DS    CL1                                                              
STRSW    DS    CL1                                                              
SBRSW    DS    CL1                                                              
IHRSW    DS    CL1                                                              
ICRSW    DS    CL1                                                              
SLRSW    DS    CL1                                                              
SPRSW    DS    CL1                                                              
RRRSW    DS    CL1                                                              
IBRSW    DS    CL1                                                              
ITRSW    DS    CL1                                                              
BTRSW    DS    CL1                                                              
*                                                                               
*                                                                               
*                                                                               
       ++INCLUDE SPGENEZ                                                        
       ++INCLUDE DDCOMFACS                                                      
       ++INCLUDE SPGENCLT                                                       
       ++INCLUDE SPGENPRD                                                       
       ++INCLUDE SPGENEST                                                       
       ++INCLUDE SPTRCMML                                                       
       ++INCLUDE DMWRKFD                                                        
       ++INCLUDE DDREPMASTD                                                     
       ++INCLUDE DDREMOTED                                                      
       ++INCLUDE DDPARSNIPD                                                     
       ++INCLUDE SPGENREP                                                       
       ++INCLUDE DDACTIVD                                                       
       ++INCLUDE SPEZDSCTS                                                      
       ++INCLUDE DDSCANBLKD                                                     
       ++INCLUDE DDAGYALPH                                                      
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'188EZMOD     12/10/19'                                      
         END                                                                    
