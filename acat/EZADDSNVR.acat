*          DATA SET EZADDSNVR  AT LEVEL 015 AS OF 10/20/15                      
*CATALP EZADDSNR                                                                
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - INIT'                         
***********************************************************************         
*                                                                     *         
*        USED WITH SPZ502 - LINK WITH LKSPZ502                        *         
*                                                                     *         
*  FIX COUNTS OF OVERWRITE REP INVOICES                               *         
***********************************************************************         
*                                                                     *         
*  LEV 01-   OCT10/94 CONVERT TO MINIO INVOICE RECORDS                *         
*  LEV 08-   DEC09/94 USE GETBROAD TO GET INVOICE START/END DTS       *         
*  LEV 09-   DEC21/94 CHECK FOR DUPLICATE INVOICE & CK OK TO ADD DUPE *         
*  LEV 10-   FEB13/95 DON'T PUT PRD IN HDR IF GETTING PRD FROM COMMMLS*         
*  LEV 11-   FEB21/95 PUT CT AND DOLLARS IN HEADER                    *         
*  LEV 12-   APR05/95 FIX DADDS DUMP                                  *         
*  LEV 13-   MAY09/95 FIX BDS - BVS DATA                              *         
*  LEV 14-   MAY11/95 FIX BROADCAST DATES IF NO FROM - TO DATES GIVEN *         
*  LEV 15-   MAY19/95 BYPASS MINIO WRITES IF TEST OR NO WRITE         *         
*  LEV 16-   JUN13/95 CHANGE MAX REC SIZE                             *         
*  LEV 17-   JUL11/95 CHANGE MAX REC SIZE FROM 4080 TO 3976           *         
*  LEV 18-   OCT26/95 CK FOR DUPLICATE INVOICE AT ADDEL               *         
*  LEV 19-   FEB21/96 RANDOMLY SET SNVHDAUQ BIT FOR AGENCY CK         *         
*  LEV 20    MAR29/96 PUT PROD AS START OF COKEAT INV #               *         
*  LEV 21    APR02/96 DROP OUT ABOVE CODE                             *         
*  LEV 22    APR26/96 IF NOT PUTTING PRD IN HDR, NO EST EITHER        *         
*  LEV 23    APR30/96 DO NOT CONVERT ZERO INVOICES                    *         
*  LEV 24    MAY02/96 DROP CODE FOR  ZERO INVOICES                    *         
*  LEV 25    MAY18/96 ADD NWK                                         *         
*  LEV 26    JUL24/96 DON'T ADD 2ND COMML UNLESS PTR PROD             *         
*  LEV 27-29 JUL29/96 FIX RANDOM BUG                                  *         
*  LEV 30    AUG09/96 FIX EZBLOCK AND ORDER #                         *         
*  LEV 31    AUG14/96 FORCE ORDER # TO BLKS                           *         
*  LEV 32    AUG20/96 CATCH BAD TIME                                  *         
*  LEV 33    AUG29/96 ADD TRANSFER BATCH DATE TO HDR ELEM             *         
*  LEV 34    SEP04/96 ADD SPOT DETAIL DATE CHECK                      *         
*  LEV 35    FEB25/97 STOP ADDING PROD TO DETAIL IF NOT GET FROM COMML*         
*  LEV 36    MAR18/97 STOP EST TO DETAIL/ADD AIL IF NOT GET FROM COMML*         
*  LEV 37    MAY21/97 ADD TAX TO NEW INVOICE HEADER ELEM (COKE ONLY)  *         
*  LEV 38    JUN11/97 IF PUTTING PROD IN DETAIL, PUT EST THERE ALSO   *         
*  LEV 39    JUN12/97 COKE ONLY - IF ZERO SPOTS/$, USE GROSS $        *         
*  LEV 40    JUN19/97 COKE ONLY - VALIDATE ESTIMATE - DONE IN EZMOD   *         
*  LEV 41    JUL24/97 CK SPOT DETAIL TIME MINUTES                     *         
*  LEV 42    AUG14/97 FOR COKE ONLY MOVE TRADING PTR TO CONTRACT      *         
*  LEV 43    OCT27/97 ADD STOP SPOT DATE OUTSIDE MOS DATES            *         
*  LEV 44    NOV05/97 MORE TIME CHECKING NEEDED                       *         
*  LEV 45    MAR04/98 PUT LOCAL CABLE IN X'40' INVOICE DETAIL ELEM    *         
*  LEV 46    MAR18/98 ONE MORE TEST FOR EZWRITE/EZTEST                *         
*  LEV 47    MAY03/98 ADD ERROR-NO NET FOR LOCAL CABLE                *         
*  LEV 48    JUN18/98 ADD FLAG INVOICE FOR ORDER TYPE MID FLIGHT CL   *         
*                     ALSO ALLOW ADD OVER DUPLICATE IF OLD IS MID FLT *         
*            AUG04/98 ADDED COMMENTS FOR MID FLIGHT CLEARANCE INVOICE *         
*  LEV 50    OCT30/98 CHECKED MORE CODES FOR STAPERR                  *         
*  LEV 51    DEC02/98 CHECKED FOR BAD INVOICE START DATE              *         
*  LEV 52    JAN13/99 USE EZTEST IN ADDITION TO EZWRITE               *         
*  LEV 53    JAN25/99 ADD CREATION DATE IN 10 ELEM - SNVHDCDT         *         
*  LEV 54    FEB08/99 CHECK FOR BAD (TOO HIGH) TIME - SCRATCHED       *         
*  LEV 55    MAR09/99 FOR N- CMMLS AND SET NO MATCH FLAG              *         
*  LEV 56    MAR29/99 SET AUTO I5 FOR RAPP (O MATCH FLAG              *         
*  LEV 57    APR22/99 BYPASS INVOICES WITH BAD DOLLAR FIELDS          *         
*  LEV 58    MAY06/99 BYPASS INVOICES WITH BAD DATE FIELDS            *         
*                     BYPASS BAD EST INVOICES                         *         
*  LEV 59    AUG04/97 JWT - REQUIRE ESTIMATE SPOT PAK ONLY            *         
*  LEV 60    AUG11/97 SET EZIHISDT/EDT TO CAL IF NETPAK/N             *         
*  LEV 61    AUG13/97 SET UP FR SAME AS JW                            *         
*  LEV 62    AUG19/97 SET EZERBRDT, SET ON IGNORE TIME IF TIME HAS T  *         
*  LEV 63    OCT28/99 FIX EZMCTINV                                    *         
*  LEV 64    NOV16/99 FIX EZSPDATE                                    *         
*  LEV 65    DEC22/99 FIX EZIHCMST IF 2000, ALSO EZIH                 *         
*  LEV 66    JAN19/00 ADD NET INTEGRATION CHARGE TO NEW INVOICE       *         
*  LEV 67    FEB09/00 FIX BNE TO PR170E TO BE                         *         
*  LEV 68    MAR28/00 ADD P/B CMML IF GETTING PROD FROM CMML          *         
*  LEV 69    JUN29/00 ADD INVOICE  IF GETTING PROD FROM CMML          *         
*  LEV 70    JUL18/00 CK CMML2 TO BE MORE THAN 1 BYTE                 *         
*  LEV 71    JUL24/00 DO NOT PUT EST IN DETAIL ORDER ELEM             *         
*  LEV 72    AUG23/00 ADD FE ELEM TO INVOICE REC                      *         
*  LEV 73    OCT03/00 ALLOW DUP ADD OF DETAIL ELEM IF DUPES ALLOWED   *         
*  LEV 74    OCT13/00 FIX INVOICE START/END DATES IF NOT PROVIDED     *         
*                     AND ADD NETWORK BYTE IN DETAIL ELEM             *         
*                     FIX ESTIMATE GOING IN BOTH HEADER & DETAIL      *         
*  LEV 75    JAN12/01 BYPASS PERIOD DATES IF NOT IN PERIOD            *         
*                     SOON PROCESSING CHANGE TO MAX MINIO REC LENGTH  *         
*  LEV 76    MAR19/01 SOON - BYPASS TOO LARGE INVOICES                *         
*  LEV 80    APR09/01 IGNORE STA TYP-ONLY CONVERT ABC/CBS/NBC/FOX/WBN *         
*                     UPN TO CALENDAR, ALL ELSE TO BROAD              *         
*  LEV 81    MAY03/01 MAKE 40 ELEM LONGER FOR NETPAK                  *         
*  LEV 82    MAY07/01 FIX REGISTER ERROR                              *         
*  LEV 83    MAY10/01 ALLOW FOR NETS WITH BLANKS                      *         
*  LEV 84    JUN13/01 MAKE MINIO BUFFERS LARGER, USE EZEQVSTA         *         
*  LEV 85    JUL30/01 FIX LOCAL CABLE EQUIVALENCED TO STATION         *         
*  LEV 86    NOV15/01 ADD H9 TO HARD CODE                             *         
*  LEV 87    JAN25/02 FIX START PERIOD OUT OF MOS                     *         
*  LEV 88    MAR06/02 MAKE MINIO BUFFER LARGER - FROM 128000 T0 194000*         
*  LEV 89    MAR21/02 REP INVOICING MINIO BUFF FROM 194000 T0 512000  *         
*                                                                     *         
*  NOV22/04 - REP Z5 RENAMED TO ZR.  LEVEL STAMPS ALL RESET TO 1      *         
***********************************************************************         
         PRINT NOGEN                                                            
EZADDSNV CSECT                                                                  
         NMOD1 EZADSDL,**EZADS                                                  
         LA    RA,COMSUBS                                                       
         USING COMSUBS,RA                                                       
         USING EZADSD,RC                                                        
         L     R7,0(R1)            A(EZBLOCK)                                   
         USING EZBLOCKD,R7                                                      
         L     R8,4(R1)            A(SPWORK)                                    
         LR    R9,R8                                                            
         AHI   R9,4096                                                          
         USING SPWORKD,R8,R9                                                    
*                                                                               
         MVI   EZERRCD,0           CLEAR ERROR                                  
*                                                                               
         CLI   ADSCTL,ADS1STQ      SKIP IF NOT FIRST TIME                       
         BNE   DONEINIT                                                         
         BRAS  RE,MININIT             INIT STORAGE AREASÃ¡                       
*                                                                               
DONEINIT DS    0H                                                               
*        LA    R5,MINBLKBF         USE BUFFER MINIO KEY                         
         L     R5,AMBLKBF          USE BUFFER MINIO KEY                         
         USING MINBLKD,R5                                                       
*                                                                               
         CLI   EZMODE,EZINVP       PROC INV                                     
         BE    PRINV                                                            
         CLI   EZMODE,EZSPTP       PROCESS SPOT DETAIL                          
         BE    PRANN                                                            
         CLI   EZMODE,EZINVL       LAST FOR INVOICE                             
         BE    LINV                                                             
*                                                                               
*                                                                               
EQXIT    CR    RB,RB                                                            
         J     EXIT                                                             
NEQXIT   LTR   RB,RB                                                            
EXIT     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - PRINV'                        
***********************************************************************         
*                                                                     *         
*        PROCESS INVOICE HEADER                                       *         
*                                                                     *         
***********************************************************************         
*                                                                               
PRINV    DS    0H                                                               
         XC    EZIHCINV,EZIHCINV                                                
*                                                                               
         XC    EZINVSIZ,EZINVSIZ                                                
*                                                                               
         XC    SNVDTELM,SNVDTELM   DETAIL ORDER ELEM                            
         LA    R6,SNVDTELM                                                      
         USING SNVDTELD,R6                                                      
         MVI   SNVDTELM,SNVDTELQ   (X'20')                                      
         MVI   SNVDTELM+1,11       DETAIL ELEM LEN WITH BASICS                  
         MVI   SNVDTFLD,FLDNDATE                                                
         MVI   SNVDTFLD+1,FLDNTIME                                              
         MVI   SNVDTFLD+2,FLDNSLEN                                              
         MVI   SNVDTFLD+3,FLDNCOST                                              
         DROP  R6                                                               
*                                                                               
         BAS   RE,CKSTA            GO CK STATION CALL LETTERS VALID             
*                                                                               
         CLI   EZERRCD,0                                                        
         BNE   COMERR                                                           
         TM    EZIHLKST,EZIHBRDT   AND IS OK BROADCAST MONTH                    
         BZ    PRI14                                                            
         MVI   EZERRCD,EZERBRDT    BAD BROADCAST DATE                           
         B     COMERR                                                           
*                                                                               
PRI14    DS    0H                                                               
         TM    EZIHLKST,EZIHBDDT   AND IS OK SPOTPAK START/END DATES            
         BZ    PRI40                                                            
*                                                                               
         MVI   EZERRCD,EZERBDDT    INV DATES ARE GARBAGE                        
*                                                                               
         B     COMERR                                                           
*                                                                               
PRI40    DS    0H                                                               
         L     R0,=A(SAVINVH)      A(INVOICE HEADER SAVE AREA)                  
         L     RE,EZWKRREC         A(INVOICE HEADER RECORD)                     
         LH    R1,0(RE)            INVOICE HEADER LENGTH                        
         CHI   R1,L'SAVINVH                                                     
         BNH   *+6                                                              
         DC    H'0'                INVOICE HEADER RECORD TOO LONG               
         LR    RF,R1               LENGTH OF SAVEAREA TO USE                    
         MVCL  R0,RE               SAVE INVOICE HEADER RECORD                   
*                                                                               
         L     R0,=A(SAVWKBUF)     A(WORKER BUFFER SAVE AREA)                   
         LHI   R1,L'SAVWKBUF      SAVE AREA LENGTH                              
         L     RE,EZWKRBUF         A(WORKER BUFFER)                             
         LR    RF,R1               LENGTH OF SAVEAREA TO USE                    
         MVCL  R0,RE               SAVE WORKER BUFFER AREA                      
*                                                                               
*        BUILD MASTER INVOICE KEY                                               
*                                                                               
*        LA    R5,MINBLKBF         USE BUFFER MINIO KEY                         
         L     R5,AMBLKBF          USE BUFFER MINIO KEY                         
         USING MINBLKD,R5                                                       
*                                                                               
         MVI   MINOPEN,C'N'        FORCE NEW RECORD                             
*                                                                               
         XC    MINMKEY,MINMKEY                                                  
         LA    R4,MINMKEY          ESTABLISH NEW INVOICE RECORD KEY             
         USING SNVKEY,R4                                                        
*                                                                               
         MVI   SNVKTYPE,SNVKTYPQ   RECORD TYPE                                  
         MVI   SNVKSUB,SNVKSUBQ    RECORD SUBTYPE                               
         MVC   SNVKAM,BAGYMD       AGENCY/MEDIA                                 
         MVC   SNVKCLT,EZIHLADB    CLIENT                                       
         MVC   SNVKSTA,BSTA                                                     
         MVC   WORK(2),EZIHBMOS    BINARY MONTH OF SERVICE                      
         MVI   WORK+2,1            FIRST DAY OF MONTH OF SERVICE                
         GOTO1 DATCON,DMCB,(3,WORK),(2,SNVKMOS)  COMPRES'D MOS                  
         XC    SNVKMOS,=X'FFFF'      COMPLEMENTED                               
*                                                                               
PRI50    MVC   SNVKINV,EZIHINV     INVOICE NUMBER                               
*                                                                               
         OC    SNVKINV,SPACES      BLANK FILL                                   
         XC    MINMKEY,MINMKEY                                                  
*                                                                               
         TM    EZLOOKSW,EZLOC                                                   
         BO    PRI55               PROCESSING LOCAL STAT (X'0EB3' REC)          
*                                                                               
         MVI   SNVRTYP,SNVRTYPQ                                                 
         MVI   SNVRSUB,SNVRSUBQ                                                 
         MVC   SNVREP,AGENCY                                                    
*                                                                               
         MVC   SNVRSTA(4),EZBTSTN                                               
         MVC   SNVRSTA+4(1),EZBTSTN+5                                           
*                                                                               
         OC    EZEQVSTA,EZEQVSTA   IS THERE A STATION RENAME                    
         BZ    *+10                                                             
         MVC   SNVRSTA(5),EZEQVSTA                                              
*                                                                               
         MVC   WORK(2),EZIHBMOS    BINARY MONTH OF SERVICE                      
         MVI   WORK+2,1            FIRST DAY OF MONTH OF SERVICE                
         GOTO1 DATCON,DMCB,(3,WORK),(2,SNVRMOS)  COMPRES'D MOS                  
         XC    SNVRMOS,=X'FFFF'      COMPLEMENTED                               
*                                                                               
         CLI   CKSTATYP,X'00'                                                   
         BE    PRI53                                                            
*                                                                               
         XC    SNVRCON,SNVRCON                                                  
         MVC   SNVRINV+L'SNVRINV(1),CKSTATYP                                    
         CLI   CKSTATYP,C'S'                                                    
         BNE   *+14                                                             
         MVC   SNVRINV,EZIHSORD                                                 
         B     PRI52                                                            
*                                                                               
         CLI   CKSTATYP,C'R'                                                    
         BNE   *+14                                                             
         MVC   SNVRINV(8),EZIHRORD                                              
         B     PRI52                                                            
         DC    H'0'                                                             
*                                                                               
PRI52    DS    0H                                                               
         OC    SNVRINV,SPACES                                                   
         B     PRI60                                                            
*                                                                               
PRI53    DS    0H                                                               
         MVC   SNVRCON,EZREPCON     GET VALIDATED REP CONTRACT #                
*                                                                               
* TEMP                                                                          
         CLC   SNVRCON,=X'99999999' THIS BAD #                                  
         BNE   *+6                                                              
         DC    H'0'                                                             
* TEMP                                                                          
         MVC   SNVRINV,EZIHINV                                                  
         OC    SNVRINV,SPACES      BLANK FILL                                   
         B     PRI60                                                            
*                                                                               
PRI55    MVI   SNVLTYP,SNVLTYPQ    LOCAL USER INVOICES X'0E'                    
         MVI   SNVLSUB,SNVLSUBQ                        X'B3'                    
*                                                                               
* LOOKUP USER ID                                                                
*                                                                               
         LA    R1,EZBTSTN                                                       
         OC    EZEQVSTA,EZEQVSTA                                                
         BZ    *+8                                                              
         LA    R1,EZEQVSTA                                                      
*                                                                               
         LA    RE,EZBLOCKD                                                      
         AHI   RE,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,RE                                                        
         ICM   RE,15,EZLSTATB                                                   
         DROP  RE                                                               
         USING LOCTBD,RE           (TABLE BUILT IN ZR02)                        
*                                                                               
PRI58    DS    0H                                                               
         OC    LOCTPOW,LOCTPOW                                                  
         BNZ   *+6                                                              
         DC    H'0'                                                             
         CLC   LOCTSIGN,0(R1)                                                   
         BE    *+12                                                             
         LA    RE,LOCTBDLQ(RE)                                                  
         B     PRI58                                                            
*                                                                               
         MVC   SNVLID,LOCTID       USER ID                                      
         MVC   SNVLPOW,LOCTPOW                                                  
         DROP  RE                                                               
*                                                                               
         MVC   SNVLSTA(4),EZBTSTN  STATION (WABCA)                              
         MVC   SNVLSTA+4(1),EZBTSTN+5                                           
         OC    EZEQVSTA,EZEQVSTA   IS THERE A STATION RENAME                    
         BZ    *+10                                                             
         MVC   SNVLSTA(5),EZEQVSTA                                              
*                                                                               
         MVC   WORK(2),EZIHBMOS    BINARY MONTH OF SERVICE                      
         MVI   WORK+2,1            FIRST DAY OF MONTH OF SERVICE                
         GOTO1 DATCON,DMCB,(3,WORK),(2,SNVRMOS)  COMPRES'D MOS                  
         XC    SNVLMOS,=X'FFFF'      COMPLEMENTED                               
         MVC   SNVLSORD,EZIHSORD                                                
         OC    SNVLSORD,SPACES     BLANK FILL                                   
*                                                                               
PRI60    DS   0H                                                                
         GOTO1 VMINIO,MNPRMS,('MINOPN',MINBLKD)    OPEN MINIO BLOCK             
*                                                                               
         LA    R1,SNVKEY              DUMP KEY                                  
         BRAS  RE,DMPREC                                                        
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - PRINVHD'                      
***********************************************************************         
*                                                                     *         
*        ADD INVOICE HEADER ELEMENT                                   *         
*        ADD ACTIVITY       ELEMENT                                   *         
*                                                                     *         
***********************************************************************         
*                                                                               
*                                                                               
PRINVHD  DS    0H                                                               
         XC    SNVELEM,SNVELEM                                                  
         XC    EZREPCT,EZREPCT                                                  
*                                                                               
         LA    R2,SNVELEM          BUILD INVOICE HEADER ELEMENT                 
         USING SNVHDELD,R2                                                      
*                                                                               
         MVI   SNVHDEL,SNVHDELQ    ELEMENT ID                                   
         MVI   SNVHDLEN,SNVHDLN2   NEW ELEMENT LENGTH                           
*                                                                               
         TM    EZLOOKSW,EZLCALEN   IS THIS CALENDAR?                            
         BZ    *+8                   NO                                         
         OI    SNVHDCTL,SNVHDCLQ   SET ON CALENDAR                              
*                                                                               
* PRODUCT AND ESTIMATE GO IN EITHER HEADER OR DETAILS, NOT BOTH                 
*                                                                               
         CLI   EZPROPT,C'Y'       SKIP IF GETTING PROD FROM COMML               
         BE    PR100                                                            
         MVC   SNVHDPRD,EZIHLPRB   PRODUCT (FF = VARIOUS)                       
         MVC   SNVHDPR2,EZIHLP2B   SECOND PRODUCT IF PIGGYBACK                  
*                                                                               
         CLI   EZESTOPT,C'Y'       SKIP IF NOT COPYING ESTIMATE NUMBERS         
         BNE   PR100                                                            
         MVC   SNVHDEST,EZIHBEST     COPY AGENCY ESTIMATE NUMBER                
*                                                                               
PR100    DS   0H                                                                
         CLC   EZAGY,=C'CK'        ANOTHER COKE %&^*                            
         BNE   PR140                                                            
*                                                                               
         OC    EZIHTPTR(5),EZIHTPTR COKE ACN NUMBER ?                           
         BZ    PR170                                                            
*                                                                               
         CLC   EZIHTPTR(5),SPACES   COKE ACN NUMBER ?                           
         BE    PR170                                                            
*                                                                               
         MVC   SNVHDCON(5),EZIHTPTR COKE ACN TO CONTRACT/ORDER                  
         B     PR170                                                            
*                                                                               
PR140    DS   0H                                                                
         CLI   EZCONOPT,C'S'       USE STATION CONTRACT IF 'S'                  
         BE    PR150                                                            
*                                                                               
         CLI   EZCONOPT,C'Y'       SKIP IF NOT COPYING CONTRACT NUMBERS         
         BNE   PR170                                                            
*                                                                               
         MVC   SNVHDCON(10),EZIHRORD   COPY REP CONTRACT/ORDER                  
*                                                                               
         CLI   SNVHDCON,C' '           IF NO REP CONTRACT/ORDER NUMBER          
         BH    PR156                                                            
PR150    DS   0H                                                                
         MVC   SNVHDCON(10),EZIHSORD   USE STATION'S                            
*                                                                               
PR156    DS   0H                                                                
         OC    SNVHDCON,SPACES         FORCE BIN ZEROS TO SPACES                
*                                                                               
PR170    DS    0H                                                               
         MVC   SNVHDSDT,EZIHCMST   INVOICE START DATE                           
         MVC   SNVHDEDT,EZIHCMEN   INVOICE END DATE                             
*                                                                               
         GOTO1 DATCON,DMCB,(2,EZIHCMST),(X'20',WORK)                            
         GOTO1 (RF),(R1),(2,EZIHCMEN),(X'20',WORK+6)                            
*                                                                               
         CLC   EZIHISDT,WORK       PERIOD START TO STD MOS START                
         BL    PR172C               OUT OF PERIOD                               
         CLC   EZIHISDT,WORK+6     PERIOD START TO STD MOS END                  
         BH    PR172C               OUT OF PERIOD                               
*                                                                               
         GOTO1 (RF),(R1),(0,EZIHISDT),(2,SNVHDSDT)                              
*                                                                               
PR172C   DS    0H                                                               
         MVC   SVHDSDT,SNVHDSDT                                                 
*                                                                               
         CLC   EZIHIEDT,WORK       PERIOD START TO STD MOS START                
         BL    PR172E               OUT OF PERIOD                               
         CLC   EZIHIEDT,WORK+6     PERIOD START TO STD MOS END                  
         BH    PR172E               OUT OF PERIOD                               
*                                                                               
         GOTO1 (RF),(R1),(0,EZIHIEDT),(2,SNVHDEDT)                              
*                                                                               
PR172E   DS    0H                                                               
         MVC   SVHDEDT,SNVHDEDT                                                 
*                                                                               
         GOTO1 DATCON,DMCB,EZIHIDAT,(2,SNVHDIDT)   INVOICE DATE                 
*                                                                               
         OC    SNVHDDDT,SNVHDDDT   SKIP IF NO DUE DATE                          
         BZ    PR174                                                            
*                                                                               
         GOTO1 (RF),(R1),EZIHDUDT,(2,SNVHDDDT) INVOICE DUE DATE                 
*                                                                               
PR174    DS    0H                                                               
         CLC   EZAGY,=C'CK'                                                     
         BNE   PR176                                                            
         GOTO1 =V(RANDOM),DMCB,99                                               
         LA    R1,9                                                             
         C     R1,DMCB+4           MARK BIT 10 % OF THE TIME                    
         BL    PR176                                                            
         OI    SNVHDCTL,SNVHDAUQ                                                
*                                                                               
PR176    DS    0H                                                               
         ICM   RF,15,EZIHTSPC      TOTAL SPOT COST                              
         CVD   RF,DUB              CVD                                          
         ZAP   SNVHDTCS,DUB        TOTAL SPOT COST                              
*                                                                               
         ICM   RF,15,EZIHTSPN      TOTAL NUMBER OF SPOTS                        
         STCM  RF,3,SNVHDTSP                                                    
*                                                                               
         MVC   SNVHDEZS,EZSRCE     SOURCE                                       
         MVC   SNVHDEZB,EZBTBRDT   BATCH LOADED DATE                            
*                                                                               
         MVC   SNVHDCDT,TODAYP     ADD CREATION DATE                            
*                                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
*        GOTO1 ADDEL,DMCB,MINBLKD,(R2),0 ADD ELEMENT TO RECORD                  
         BE    PR180                                                            
*                                                                               
         CLI   MINERR,MINEDUP      DUPLICATE INVOICE ERROR                      
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         CLI   EZRPLOPT,C'Y'       IF ALLOWED TO REPLACE INVOICE                
         BE    PR180                                                            
*                                                                               
         MVI   EZERRCD,EZERRDUP       SET ERROR CODE (DUPLICATE INV)            
         B     COMERR                                                           
*                                                                               
         DROP  R2                                                               
*                                  SET ACTIVITY ELEM                            
PR180    XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM          BUILD INVOICE HEADER ELEMENT                 
         USING ACTVD,R2                                                         
*                                                                               
         MVI   ACTVEL,X'F1'                                                     
         MVI   ACTVLEN,20                                                       
         MVC   ACTVADDT,TODAYB     DATE                                         
         MVC   ACTVADID,RCORIGID   USER ID                                      
*                                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
*        GOTO1 ADDEL,DMCB,MINBLKD,(R2),0 ADD ELEMENT TO RECORD                  
         BE    PR190                                                            
*                                                                               
         CLI   MINERR,MINEDUP      DUPLICATE INVOICE ERROR                      
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         CLI   EZRPLOPT,C'Y'       IF ALLOWED TO REPLACE INVOICE                
         BE    PR190                                                            
*                                                                               
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         DROP  R2                                                               
*                                                                               
*                                                                               
*==================================================================*            
* FOR REP, ALWAYS ADD X'24' ELEMENT FOR REP INFO                   *            
*==================================================================*            
*                                                                               
PR190    DS   0H                                                                
         XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM          BUILD INVOICE HEADER ELEMENT                 
*                                                                               
         USING SNVRTEL,R2                                                       
         MVI   SNVRTEL,SNVRTELQ                                                 
         MVI   SNVRTLEN,SNVRTOVQ                                                
         MVC   SNVRORG,EZWKRIND                                                 
         CLC   =C'LOC',EZIHREPC    IF REP ID = LOC                              
         BE    *+10                DON'T ADD ADVERTISER                         
         MVC   SNVRADV,EZIHSAID                                                 
*                                                                               
         MVC   SNVRCT,EZREPCT      # TIMES OVERWRITTEN                          
*                                                                               
         OC    EZEQVSTA,EZEQVSTA   IS THERE A STATION RENAME                    
         BZ    PR220                                                            
         MVC   SNVROLDS(4),EZBTSTN                                              
         MVC   SNVROLDS+4(1),EZBTSTN+5                                          
*                                                                               
PR220    DS   0H                                                                
         MVC   SNVRDTE,TODAYB     DATE CONVERTED                                
*                                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
*        GOTO1 ADDEL,DMCB,MINBLKD,(R2),0 ADD ELEMENT TO RECORD                  
         BE    PR240                                                            
*                                                                               
         CLI   MINERR,MINEDUP      DUPLICATE ELEMENT ERROR                      
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         CLI   EZRPLOPT,C'Y'       IF ALLOWED TO REPLACE INVOICE                
         BE    EXIT                                                             
*                                                                               
         DC    H'0'                ANY ERRORS                                   
*                                                                               
*==================================================================*            
* FOR REP, AND LOCKAL STATION ADD X'25' (INVOICE NUMBER ELEMENT)   *            
*==================================================================*            
*                                                                               
PR240    DS   0H                                                                
         CLC   =C'LOC',EZIHREPC    IF REP ID = LOC                              
         BE    PR250               YES - ADD THE '25' ELEMENT                   
         LA    R1,EZBLOCKD                                                      
         AHI   R1,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,R1                                                        
         CLI   EZIHRTYP,X'00'      NEW STYLE REP KEYS?                          
         BE    EXIT                NO, DONE                                     
         DROP  R1                                                               
*                                                                               
PR250    DS   0H                                                                
         XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM          BUILD INVOICE NUMBER ELEMENT                 
*                                                                               
         USING SNVRIEL,R2                                                       
         MVI   SNVRIEL,SNVRIELQ                                                 
         MVI   SNVRILEN,SNVRINVQ                                                
         MVC   SNVRIAGN,EZAGNAM    AGENCY NAME                                  
         MVC   SNVRISNM,EZIHSLSP   SALESPERSON NAME                             
         MVC   SNVRIANM,EZIHADVN   ADVERTIZER NAME                              
         MVC   SNVRIPNM,EZIHPRDN   PRODUCT NAME                                 
         MVC   SNVRINV#,EZIHINV                                                 
         OC    SNVRINV#,SPACES     BLANK FILL                                   
         MVC   SNVRISSD,EZIHSDT    SCHEDULE START DATE                          
         MVC   SNVRISED,EZIHEDT    SCHEDULE END DATE                            
*                                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
*        GOTO1 ADDEL,DMCB,MINBLKD,(R2),0 ADD ELEMENT TO RECORD                  
         BE    EXIT                                                             
*                                                                               
         CLI   MINERR,MINEDUP      DUPLICATE ELEMENT ERROR                      
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         CLI   EZRPLOPT,C'Y'       IF ALLOWED TO REPLACE INVOICE                
         BE    EXIT                                                             
*                                                                               
         DC    H'0'                ANY ERRORS                                   
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - PRANN'                        
***********************************************************************         
*                                                                     *         
*        PROCESS ANNOUNCEMENT                                         *         
*                                                                     *         
***********************************************************************         
*                                                                               
PRANN    DS    0H                                                               
         CLI   EZSPRUN,C'N'        SKIP IF DID NOT RUN                          
         BE    PRAX                                                             
*                                                                               
         CLI   EZSPBSLN,0          SPOT LENGTH = ZERO                           
         BE    PRAERR               BYPASS INVOICE                              
*                                                                               
         TM    EZSPLKST,EZSPBDDL   SEE IF BAD DOLLAR FIELD                      
         BZ    PRANN02                                                          
*                                                                               
         MVI   EZERRCD,EZERRDOL    BAD DOLLAR FIELD                             
         B     COMERR                                                           
*                                                                               
PRANN02  DS    0H                                                               
         TM    EZSPLKST,EZSPBDTM   SEE IF BAD TIME FIELD                        
         BZ    PRANN04                                                          
*                                                                               
         MVI   EZERRCD,EZERRTIM    BAD TIME FIELD                               
         B     COMERR                                                           
*                                                                               
*        BUILD DETAIL ELEMENT KEY                                               
*                                                                               
PRANN04  DS    0H                                                               
         XC    SNVELEM,SNVELEM                                                  
         LA    R2,SNVELEM                                                       
         USING SNVIDELD,R2         ESTABLISH DETAIL ELEMENT                     
*                                                                               
         MVI   SNVIDEL,SNVIDELQ    SET DETAIL ELEMENT CODE                      
*                                                                               
         MVI   SNVIDLEN,SNVIDSEQ-SNVIDELD                                       
*                                                                               
         CLC   EZSPCDT,SVHDSDT     SEE IF SPOT DATE OUTSIDE MOS                 
         BL    DATERR                                                           
         CLC   EZSPCDT,SVHDEDT                                                  
         BH    DATERR                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(2,SVHDSDT),(X'20',DUB)  INVOICE START DATE          
*                                                                               
         GOTO1 VPERVERT,DMCB,DUB,EZSPDATE,0                                     
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,8(R1)          NUMBER OF DAYS BETWEEN DATES                 
         BCTR  RF,0                RELATIVE NUMBER OF DAYS                      
         STC   RF,SNVIDDAY                                                      
*                                                                               
         OC    EZSPTIM(2),EZSPTIM  TEST TIME MISSING                            
         BZ    TIMERR              THAT'S ALL SHE WROTE                         
*                                                                               
         LA    R0,4                                                             
         LA    R1,EZSPTIM                                                       
         CLI   0(R1),C'0'                                                       
         BL    TIMERR                                                           
         CLI   0(R1),C'9'                                                       
         BH    TIMERR                                                           
         LA    R1,1(,R1)                                                        
         BCT   R0,*-20                                                          
*                                                                               
         CLC   EZSPTIM(2),=C'24'   TEST TIME TOO HIGH                           
         NOP   TIMHIGH              THAT'S ALL SHE WROTE                        
*                                                                               
         PACK  DUB,EZSPTIM(2)      MILITARY HOURS OF TIME                       
*                                                                               
         CP    DUB,=P'6'           IF BEFORE 6AM                                
         BNL   *+10                                                             
         AP    DUB,=P'24'             ADD 24 HOURS                              
*                                                                               
         SP    DUB,=P'6'           SET HOURS RELATIVE TO 6AM                    
*                                                                               
         MP    DUB,=P'60'          CALCULATE MINUTES                            
*                                                                               
         CVB   RF,DUB              CVB HOURS IN RELATIVE MINUTES                
*                                                                               
         OC    EZSPTIM+2(2),EZSPTIM+2  TEST TIME MISSING                        
         BZ    TIMERR                   THAT'S ALL SHE WROTE                    
         CLI   EZSPTIM+2,X'F0'                                                  
         BL    TIMERR                                                           
         CLI   EZSPTIM+3,X'F0'                                                  
         BL    TIMERR                                                           
*                                                                               
         PACK  DUB,EZSPTIM+2(2)    GET MILITARY MINUTES                         
         CVB   RE,DUB              CVB                                          
*                                                                               
         AR    RF,RE               MINUTES RELATIVE TO 6AM                      
         STCM  RF,3,SNVIDTIM       SET IN KEY                                   
*                                                                               
         CLI   EZSPTIMT,C'T'       WAS TIME PRECEDED BY A 'T'                   
         BNE   *+8                                                              
         OI    SNVIDCTL,SNVIDITQ    IGNORE TIME FOR I2 INVOICE MATCH            
*                                                                               
         MVC   SNVIDINT,EZSPBINT   SAVE ANY NETWORK INTEGRATION CHRG            
*                                                                               
         OC    SNVIDINT,SNVIDINT   ANY NETWORK INTEGRATION CHRG?                
         BE    PRANN06              NO                                          
*                                                                               
* PUT INTEGRATION CHARGE IN DETAIL ELEM IF NOT THERE                            
*                                                                               
         LA    R0,MAXFLDEQ-4                                                    
         LA    R1,SNVDTFLD-SNVDTEL+SNVDTELM                                     
         LR    RE,R1                                                            
*                                                                               
         CLI   0(R1),FLDNINTG      ALREADY THERE                                
         BE    PRANN06                                                          
         CLI   0(R1),0             END OF USED PORTION                          
         BE    *+14                                                             
         LA    R1,1(,R1)           NEXT BYTE                                    
         BCT   R0,*-20                                                          
         DC    H'0'                                                             
         MVI   0(R1),FLDNINTG                                                   
         IC    R0,SNVDTELM+1                                                    
         AHI   R0,1                                                             
         STC   R0,SNVDTELM+1                                                    
*                                                                               
PRANN06  DS    0H                                                               
*        OC    EZSPNET,EZSPNET     WAS LOCAL CABLE NET SENT                     
*        BZ    PRANN40             NO (BRANCHING IN THE MIDDLE OF THE           
*                                  CODE THAT SHOULDN'T BE EXECUTED??)           
*                                                                               
* PUT NETWORK IN DETAIL ELEM IF NOT THERE                                       
*                                                                               
PRANN50  DS   0H                                                                
         LA    R0,MAXFLDEQ-4                                                    
         LA    R1,SNVDTFLD-SNVDTEL+SNVDTELM                                     
*                                                                               
         CLI   0(R1),FLDNNTWK       NETWORK ALREADY THERE                       
         BE    PRANIDLP                                                         
         CLI   0(R1),0             END OF USED PORTION                          
         BE    *+14                                                             
         LA    R1,1(,R1)           NEXT BYTE                                    
         BCT   R0,*-20                                                          
         DC    H'0'                                                             
         MVI   0(R1),FLDNNTWK                                                   
         IC    R0,SNVDTELM+1                                                    
         AHI   R0,1                                                             
         STC   R0,SNVDTELM+1                                                    
*                                                                               
PRANIDLP DS    0H                                                               
*                                                                               
         GOTO1 GETEL,DMCB,MINBLKD,(R2),0     CHECK FOR DUPLICATE ELM            
*                                                                               
         ICM   RF,15,8(R1)         POINT TO RETURNED ELEMENT                    
         BZ    PRANIDDN            NONE FOUND                                   
*                                                                               
PRANIDCN DS    0H                                                               
*                                                                               
         SR    RE,RE                                                            
*                                                                               
         CLI   SNVIDSEQ-SNVIDELD(RF),X'FF'                                      
         BL    *+12                                                             
         MVI   EZERRCD,EZERR255    MORE THAN 255 IDENTICAL SPOTS                
         B     COMERR                                                           
*                                                                               
         ICM   RE,1,SNVIDSEQ-SNVIDELD(RF)   FOUND SEQUENCE NUMBER               
         LA    RE,1(RE)            BUMP                                         
         STC   RE,SNVIDSEQ         SET IN SEARCH KEY                            
*                                                                               
         B     PRANIDLP                                                         
*                                                                               
PRANIDDN DS    0H                                                               
*                                                                               
*        BUILD DETAIL ELEMENT                                                   
*                                                                               
         MVI   SNVIDLEN,SNVIDLNQ   SET TO FULL ELEMENT LENGTH                   
*                                                                               
         CLI   EZSPTNET,C'N'       MAKE LONGER ELEM, BUT ONLY FOR NET           
         BNE   *+8                                                              
         MVI   SNVIDLEN,SNVIDL2Q                                                
*                                                                               
         MVC   SNVIDSLN,EZSPBSLN   SPOT LENGTH                                  
*                                                                               
         ICM   R0,15,EZSPBRAT      GET COST                                     
         ICM   RE,15,EZSPBDR       AND DEBIT                                    
         ICM   RF,15,EZSPBCR           CREDIT                                   
         AR    R0,RE                                                            
         AR    R0,RF                                                            
         BZ    *+10                NO COST IF NET IS ZERO                       
         MVC   SNVIDCST,EZSPBRAT   SET SPOT COST                                
*                                                                               
         CLI   EZSPCOPY,C' '                                                    
         BNH   PRA8                                                             
*                                                                               
         XC    FILMCODS,FILMCODS                                                
         LA    R1,EZSPCOPY                                                      
         LR    R3,R2                                                            
         LA    R2,FILMCODS                                                      
         BRAS  RE,GETCMMLS                                                      
         LR    R2,R3                                                            
*                                                                               
         LA    R3,FILMCODS         LOOK IN CMML TABLE                           
         LA    R4,TRAFNUM                                                       
         BAS   RE,SETCML                                                        
         BNE   PRA8                                                             
         MVC   SNVIDCML,BYTE       SET INTERNAL ID                              
*                                                                               
* PUT FILM CODE IN DETAIL ELEM IF NOT THERE                                     
                                                                                
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNFILM                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
         CLI   FILMCODS+8,0        TEST HAVE CMML 2                             
         BE    PRA8                                                             
         LA    R3,FILMCODS+8       LOOK IN CMML TABLE                           
         LA    R4,TRAFNUM                                                       
         BAS   RE,SETCML                                                        
         BNE   PRA8                                                             
         MVC   SNVIDCM2,BYTE       SET INTERNAL ID                              
*                                                                               
         LA    R1,SNVDTELM                                                      
         LHI   R0,FLDNPFLM                                                      
         BRAS  RE,UPDORDER                                                      
*                                                                               
PRA8     DS    0H                                                               
*                                                                               
         CLI   EZMGOPT,C'Y'        TEST TO USE MAKEGOOD STATUS                  
         BNE   PRA9                                                             
         CLI   EZSPDMD1,C' '       TEST SPOT IS A MAKEGOOD                      
         BNH   PRA9                                                             
*                                                                               
         OI    SNVIDCTL,SNVIDMGQ   SET STATUS BIT                               
*                                                                               
PRA9     DS    0H                                                               
*                                                                               
         BAS   RE,CADDEL           GO ADD ELEMENT TO RECORD                     
*        GOTO1 ADDEL,DMCB,MINBLKD,(R2),0 ADD ELEMENT TO RECORD                  
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         CLC   EZINVSIZ,=H'3900'   MAX FOR SOONS-ONLY KEPT IF SOON              
         BL    PRAX                 ALL                                         
*                                                                               
         MVI   EZERRCD,EZERRSIZ    SET INVOICE TOO LARGE FOR SOON               
         B     COMERR                                                           
*                                                                               
PRAX     DS    0H                                                               
*                                                                               
         B     EXIT                                                             
*                                                                               
PRAERR   MVI   EZERRCD,EZERRSPL    SET ERROR SPOT LEN = ZERO                    
         B     COMERR                                                           
*                                                                               
TIMERR   MVI   EZERRCD,EZERRTMZ    SET ERROR TIME = ZERO                        
         B     COMERR                                                           
*                                                                               
TIMHIGH  MVI   EZERRCD,EZERRTMH    SET ERROR TIME = HIGH                        
         B     COMERR                                                           
*                                                                               
DATERR   MVI   EZERRCD,EZERRDTE    SET ERROR DATE = ZERO                        
*                                                                               
COMERR   DS    0H                                                               
         BAS   RE,GETERRM                                                       
         MVI   EZMODE,EZINVL       SET TO SKIP TO NEXT INV                      
         B     EXIT                                                             
*                                                                               
         DROP  R2                                                               
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - LINV'                         
***********************************************************************         
*                                                                     *         
*        LAST FOR INVOICE                                             *         
*                                                                     *         
***********************************************************************         
*                                                                               
LINV     DS    0H                                                               
         ICM   RF,15,EZIHTSPN      TOTAL NUMBER OF SPOTS                        
         BNZ   LINV100                                                          
*                                                                               
         MVI   EZERRCD,EZERRZER       SET ERROR CODE (ZERO SPOTS)               
         BAS   RE,GETERRM             TRANSLATE CODE                            
         MVI   EZMODE,EZINVL          SKIP TO NEXT INVOICE                      
         B     EXIT                                                             
*                                                                               
LINV100  DS    0H                                                               
*        LA    R5,MINBLKBF         ESTABLISH INV FILE MINIO BLOCK               
         L     R5,AMBLKBF          ESTABLISH INV FILE MINIO BLOCK               
         USING MINBLKD,R5                                                       
         MVC   SNVELEM,SNVDTELM             MOVE ELEM AS BUILT                  
         GOTO1 ADDEL,DMCB,MINBLKD,SNVELEM,0 ADD ELEMENT TO RECORD               
         BE    LINV200                                                          
*                                                                               
         CLI   MINERR,MINEDUP      DUPLICATE INVOICE ERROR                      
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         CLI   EZRPLOPT,C'Y'       IF ALLOWED TO REPLACE INVOICE                
         BE    LINV200                                                          
*                                                                               
         DC    H'0'                ANY ERRORS                                   
*                                                                               
LINV200  DS    0H                                                               
         LA    R5,MINBLK           ESTABLISH INV FILE MINIO BLOCK               
         USING MINBLKD,R5                                                       
*                                                                               
         MVI   MINOPEN,C'N'        FORCE OPENING OF RECORD SET                  
         MVI   MINDELSW,C'N'       PROCESS DELETED RECORDS                      
*                                                                               
         CLI   EZTEST,C'Y'         TEST TO SUPPRESS MARKING                     
         BE    *+12                                                             
*                                                                               
         CLI   EZWRITE,C'Y'        IF WRITES NOT ALLOWED                        
         BE    *+8                                                              
         MVI   MINWRITE,C'N'          DISABLE WRITES                            
*                                                                               
*        LA    RF,MINBLKBF                                                      
         L     RF,AMBLKBF                                                       
         LA    RF,MINMKEY-MINBLKD(RF)                                           
         MVC   MINMKEY,0(RF)                                                    
*        MVC   MINMKEY,MINMKEY-MINBLKD+MINBLKBF COPY BUFFER KEY                 
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINOPN',MINBLKD)   OPEN MINIO SET                
*                                                                               
         CLI   MINERR,MINESNF      SKIP IF RECORD NOT FOUND                     
         BE    LINVOLDX                                                         
*                                                                               
         MVC   KEY,MINMKEY                                                      
         XC    KEY+24(6),KEY+24                                                 
         GOTO1 DATAMGR,DMCB,DMRDHI,=C'XSPDIR',KEY,KEY1                          
         CLC   KEY(24),KEY1                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R2,ADBUY                                                         
         GOTO1 (RF),(R1),GETREC,=C'XSPFIL',KEY1+36,(R2),KEY2                    
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R2,42(,R2)                                                       
*                                                                               
         CLI   0(R2),X'10'         THIS HEADER ELEM                             
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* WAS EXISTING INVOICE MID FLIGHT CLEARANCE - IF SO, OKAY                       
* TO OVER-WRITE I WITH REAL INVOICE, OR ANOTHER MID FLIGHT CLEARANCE            
*                                                                               
         TM    SNVHDCTL-SNVHDELD(R2),SNVHDMCQ                                   
         BO    LINVREP1                                                         
*                                                                               
         SR    R0,R0                                                            
LINV210  DS    0H                                                               
         CLI   0(R2),X'24'         THIS REP ORIGIN ELEM                         
         BE    LINV214                                                          
         BL    LINVDELX                                                         
*                                                                               
         IC    R0,1(,R2)           GET LENGTH                                   
         AR    R2,R0                                                            
         CLI   0(R2),0             AT END OF REC                                
         BNE   LINV210                                                          
         B     LINVREP1                                                         
LINV214  DS    0H                                                               
         USING SNVRTELD,R2                                                      
         SR    RF,RF                                                            
         ICM   RF,3,SNVRCT                                                      
         LA    RF,1(,RF)                                                        
         STCM  RF,3,EZREPCT                                                     
         B     LINVDELX                                                         
*                                                                               
LINV220  DS    0H                                                               
         MVI   EZERRCD,EZERRDUP       SET ERROR CODE (DUPLICATE INV)            
         BAS   RE,GETERRM             TRANSLATE CODE                            
         MVI   EZMODE,EZINVL          SKIP TO NEXT INVOICE                      
*                                                                               
         B     EXIT                                                             
*                                                                               
LINVREP1 DS    0H                                                               
*                                                                               
         TM    MINSTAT,MINDELQ     IF RECORD SET IS DELETED                     
         BNO   LINVDELX                                                         
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINRSF',MINBLKD)  RESTORE MINIO SET              
*                                                                               
*        CLEAR OLD RECORD FROM FILE                                             
*                                                                               
LINVDELX DS    0H                                                               
         XC    MINFILTL,MINFILTL   CLEAR FILTER LENGTH                          
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY                             
*                                                                               
         L     RF,MINBUFF          POINT TO BUFFER                              
         XC    0(256,RF),0(RF)     CLEAR OLD DATA                               
*                                                                               
         LA    R0,MINHI            FIRST READ IS HIGH                           
*                                                                               
LINVDLLP DS    0H                                                               
*                                                                               
         GOTO1 VMINIO,MNPRMS,((R0),MINBLKD)   READ NEXT ELEMENT                 
*                                                                               
         CLI   MINERR,0            TREAT ALL ERRORS AS END OF RECORD            
         BNE   LINVDLDN                                                         
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINDEL',MINBLKD)   DELETE ELEMENT                
*                                                                               
LINVDLCN DS    0H                                                               
*                                                                               
         LA    R0,MINSEQ           NEXT READ IS SEQUENTIAL                      
         B     LINVDLLP                                                         
*                                                                               
LINVDLDN DS    0H                                                               
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINCLS',MINBLKD)   CLOSE SET TO EMPTY            
*                                                                               
         GOTO1 (RF),(R1),('MINOPN',MINBLKD)   OPEN EMPTY SET                    
*                                                                               
LINVOLDX DS    0H                                                               
*                                                                               
*        COPY BUFFER TO FILE                                                    
*                                                                               
LINVCPY  DS    0H                                                               
*                                                                               
         SR    R0,R0               SET FIRST TIME SWITCH                        
*                                                                               
         LA    R6,MINBLK           POINT TO FILE MINIO BLOCK                    
         L     R5,AMBLKBF          POINT TO BUFFER MINIO RECORD                 
*                                                                               
         L     R1,AMBLKBF                                                       
         AHI   R1,MINMKEY-MINBLKD  DUMP KEY                                     
         BRAS  RE,DMPREC                                                        
*                                                                               
         LA    R2,SNVELEM          POINT TO ELEMENT WORKAREA                    
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY                             
         XC    SNVELEM,SNVELEM     INIT ELEMENT WORKAREA                        
*                                                                               
         L     R4,AMBLKBF                                                       
*        GOTO1 VMINIO,MNPRMS,('MINHI',MINBLKBF)  READ FIRST ELEMENT             
         GOTO1 VMINIO,MNPRMS,('MINHI',0(R4))  READ FIRST ELEMENT                
*                                                                               
LINVCPLP DS    0H                                                               
*                                                                               
         CLI   MINERR,MINEEOF      DONE IF AT END OF FILE                       
         BE    LINVCPDN                                                         
*                                                                               
         CLI   MINERR,0            NO OTHER ERRORS TOLERATED                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*        ICM   RF,15,MINELEM-MINBLKD+MINBLKBF  POINT TO FOUND RECORD            
         LHI   R0,MINELEM-MINBLKD                                               
*        LA    R1,MINBLKBF(R1)                                                  
         L     R1,AMBLKBF                                                       
         AR    R1,R0                                                            
         ICM   RF,15,0(R1)                                                      
         BZ    LINVCPDN            END OF RECORD                                
*                                                                               
         MVC   SNVELEM,0(RF)       COPY ELEMENT                                 
*                                                                               
*        CHECK FOR VARIOUS ELEMENTS                                             
*                                                                               
         USING SNVHDELD,R2         ESTABLISH AS HEADER ELEMENT                  
*                                                                               
         CLI   SNVHDEL,SNVHDELQ    SKIP IF NOT HEADER ELEMENT                   
         BNE   LINVCHDN                                                         
*                                                                               
         ICM   RF,15,EZIHTSPC      TOTAL SPOT COST                              
         BNZ   *+18                                                             
*                                                                               
         CLC   EZAGY,=C'CK'        ONLY FOR COKE                                
         BNE   *+8                                                              
*                                                                               
         ICM   RF,15,EZITBACT      IF NO SPOTS, USE GROSS                       
*                                                                               
         CVD   RF,DUB              CVD                                          
         ZAP   SNVHDTCS,DUB        TOTAL SPOT COST                              
*                                                                               
         ICM   RF,15,EZIHTSPN      TOTAL NUMBER OF SPOTS                        
         STCM  RF,3,SNVHDTSP                                                    
*                                                                               
         MVI   EZMCTINV,0          SET OFF MCT INVOICE                          
*                                                                               
         CLC   =C'MID FLIGHT CL',EZIHORD THIS SPECIAL 'PRE' INVOICE             
         BE    MCTINV                                                           
*                                                                               
         CLC   =C'BVS',EZSRCE      IF SOURCE BDS                                
         BE    MCTINV                                                           
         CLC   =C'BDS',EZSRCE      IF SOURCE BDS                                
         BNE   NOTMCTIN                                                         
         OC    EZITBDUE,EZITBDUE   AND ZERO DOLLARS                             
         BNZ   NOTMCTIN                                                         
MCTINV   EQU   *                                                                
         OI    SNVHDCTL,SNVHDMCQ       SET ON MCT INVOICE                       
*                                                                               
         MVI   EZMCTINV,C'Y'           SET ON MCT INVOICE                       
*                                                                               
NOTMCTIN DS   0H                                                                
         CLC   EZAGY,=C'CK'        ONLY FOR COKE                                
         BNE   *+10                                                             
*                                                                               
         MVC   SNVHDTAX,EZITBSTX   SAVE STATE TAX                               
*                                                                               
         LR    R1,R2               DUMP ELEM                                    
         BRAS  RE,DMPREC                                                        
*                                                                               
         B     LINVCPCN                                                         
*                                                                               
LINVCHDN DS    0H                                                               
*                                                                               
         USING SNVIDELD,R2         ESTABLISH AS DETAIL ELEMENT                  
*                                                                               
         CLI   SNVIDEL,SNVIDELQ    SKIP IF NOT DETAIL ELEMENT                   
         BNE   LINVCIDN                                                         
*                                                                               
         CLC   =C'BVS',EZSRCE      IF SOURCE BVS                                
         BE    *+14                                                             
         CLC   =C'BDS',EZSRCE      IF SOURCE BDS                                
         BNE   *+26                                                             
         OC    EZITBDUE,EZITBDUE   AND ZERO DOLLARS                             
         BNZ   *+16                                                             
         MVC    SNVIDRSP,SNVIDCST+1    COPY COST TO RESPONSES                   
         XC     SNVIDCST,SNVIDCST      CLEAR COST FIELD                         
*                                                                               
         B     LINVCPCN                                                         
*                                                                               
LINVCIDN DS    0H                                                               
*                                                                               
LINVCPCN DS    0H                                                               
*                                                                               
         CLI   EZTEST,C'Y'         TEST TO SUPPRESS MARKING                     
         BE    LINVCBY                                                          
         CLI   EZWRITE,C'Y'        IF WRITES NOT ALLOWED                        
         BNE   LINVCBY                                                          
*                                                                               
         GOTO1 ADDEL,DMCB,MINBLK,SNVELEM,0  ADD TO FILE RECORD                  
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
         CLI   MINERR,0            NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* THIS CODE BYPASSES A KNOWN BUG IN MINIO *                                     
*                                                                               
         LTR   R0,R0                                                            
         BNZ   LINVCBY                                                          
*                                                                               
*        GOTO1 VMINIO,MNPRMS,('MINCLS',MINBLK)   CLOSE SET                      
*                                                                               
*        GOTO1 (RF),(R1),('MINOPN',MINBLK)   OPEN SET                           
*        BCTR  R0,0                                                             
*                                                                               
LINVCBY  DS    0H                                                               
         L     R4,AMBLKBF                                                       
*        GOTO1 VMINIO,MNPRMS,('MINSEQ',MINBLKBF)  NEXT BUFFER ELEMENT           
         GOTO1 VMINIO,MNPRMS,('MINSEQ',0(R4))  NEXT BUFFER ELEMENT              
*                                                                               
LINVCPC1 DS    0H                                                               
*                                                                               
         B     LINVCPLP                                                         
*                                                                               
LINVCPDN DS    0H                                                               
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINCLS',MINBLK)    CLOSE FILE   RECORD           
         L     R4,AMBLKBF                                                       
*        GOTO1 (RF),(R1),('MINCLS',MINBLKBF)  CLOSE BUFFER RECORD               
         GOTO1 (RF),(R1),('MINCLS',0(R4))  CLOSE BUFFER RECORD                  
*                                                                               
         TM    EZTRACE,X'10'       IF TRACING                                   
         BZ    LINVCPYX            NO                                           
         MVC   P(30),=CL30'CLOSING MINIO DATASET'                               
         GOTO1 REPORT                                                           
*                                                                               
LINVCPYX DS    0H                                                               
*                                                                               
LINV90   DS    0H                  MARK INVOICE AS CONVERTED                    
*                                                                               
         CLI   EZWRITE,C'Y'        IF WRITES NOT ALLOWED                        
         BNE   LINV96                                                           
*                                                                               
         CLI   EZTEST,C'Y'         TEST TO SUPPRESS MARKING                     
         BE    LINV96                                                           
*                                                                               
*                               SET CONVERSION DATA IN INVOICE HEADER           
         L     R3,=A(SAVINVH)      A(INVOICE HEADER SAVE AREA)                  
         LA    R3,7(,R3)           SAVED INVOICE HEADER                         
*                               SET CONVERSION DATA IN INVOICE HEADER           
         OI    0(R3),EZIHREPI      MARK AS CONVERTED TO REP                     
         B     LINV92                                                           
*                                  SKIP RECLEN(4),RECCODE(2),DELIM(1)           
LINV91   DS    0H                  MARK INVOICE AS CONVERTED                    
         OI    0(R3),EZIHCVQ       INDICATE A CONVERTED INVOICE                 
         NI    0(R3),X'FF'-EZIHRCVQ  TURN OFF ANY RECONVERTED INDICATOR         
*                                                                               
         GOTO1 DATCON,DMCB,(0,TODAY),(1,1(R3)) TODAY PWOS                       
*                                                                               
         MVC   4(2,R3),EZIHLADB    CLIENT                                       
         MVC   6(1,R3),EZIHLPRB    PRODUCT                                      
         OI    11(R3),X'80'        STOP TRAILING BLANK DELETION                 
*                                                                               
*                               NOTE- THE RDBLOCK IS NEEDED TO ENSURE           
*                                     WE WRITE BACK THE LATEST VERSION          
*                                     OF THE BLOCK                              
*                                                                               
*        MVC   DMCB+16(4),=A(SAVWKBUF)                                          
*                                                                               
* NOW RESET TO HEADER (31) RECORD OF CURRRENT INVOICE *                         
*                                                                               
LINV92   DS    0H                                                               
         L     RF,EZWKRREC                                                      
         XC    0(12,RF),0(RF)                                                   
         MVC   2(2,RF),EZHDRSEQ                                                 
         MVC   4(4,RF),=C'REC '                                                 
*                                                                               
*        GOTO1 DATAMGR,DMCB,=C'RANDOM',EZWKRFIL,EZWKRIND,EZWKRREC,     C        
               EZWKRBUF                                                         
*        CLI   8(R1),0                                                          
*        BE    *+6                                                              
*        DC    H'0'                                                             
*                                                                               
         LAY   R6,EZWRKIOB                                                      
         USING WRKIOD,R6                                                        
         MVC   WRKEZREC,EZHDRSEQ                                                
         MVI   WRKIACTN,WRKIARAN                                                
         GOTO1 EZWRKIO,(R6)                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R6                  WRKIOD,R6                                    
*                                                                               
         L     RE,=A(SAVINVH)                                                   
         L     RF,EZWKRREC         SAVE INVOICE HEADER RECORD                   
*                                                                               
         CLC   4(2,RF),=C'31'      MUST BE INVOICE HEADER RECORD                
         BE    *+6                                                              
         DC    H'0'                INVOICE HEADER RECORDS DIFFERENT             
*                                                                               
         CLC   0(7,RE),0(RF)       MUST BE SAME LENGTH AND RECORD               
         BE    *+6                                                              
         DC    H'0'                INVOICE HEADER RECORDS DIFFERENT             
*                                                                               
         LH    R1,0(RE)            LENGTH OF RECORD                             
*                                                                               
         LR    R0,RF               TO ADDR                                      
         LR    RF,R1               LENGTH OF MOVE                               
         MVCL  R0,RE                                                            
*                                                                               
*                                                                               
         CLI   EZWRITE,C'Y'        TEST IF WRITE ALLOWED                        
         BNE   LINV94                                                           
*                                                                               
*        GOTO1 DATAMGR,DMCB,=C'WRITE',EZWKRFIL,EZWKRIND,EZWKRREC,      C        
               EZWKRBUF                                                         
*        CLI   8(R1),0                                                          
*        BE    *+6                                                              
*        DC    H'0'                                                             
*                                                                               
         LAY   R6,EZWRKIOB                                                      
         USING WRKIOD,R6                                                        
         MVI   WRKIACTN,WRKIAPUT                                                
         GOTO1 EZWRKIO,(R6)                                                     
         CLI   WRKIERRS,0                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R6                  WRKIOD,R6                                    
*                                                                               
* NOW RESET BACK TO CURRENT RECORD *                                            
*                                                                               
LINV94   DS    0H                                                               
*&&DO                                                                           
         L     RF,EZWKRREC                                                      
         XC    0(12,RF),0(RF)                                                   
         LH    R1,EZRECSEQ                                                      
         LA    R1,1(,R1)                                                        
         ST    R1,0(RF)                                                         
*        MVC   2(2,RF),EZRECSEQ                                                 
         MVC   4(4,RF),=C'REC '                                                 
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'RANDOM',EZWKRFIL,EZWKRIND,EZWKRREC,     C        
               EZWKRBUF                                                         
*&&                                                                             
*                                                                               
         LAY   R6,EZWRKIOB                                                      
         USING WRKIOD,R6                                                        
         LH    R0,EZRECSEQ                                                      
         AHI   R0,1                                                             
         STCM  R0,3,WRKEZREC                                                    
         MVI   WRKIACTN,WRKIARAN                                                
         GOTO1 EZWRKIO,(R6)                                                     
         CLI   WRKIERRS,0                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R6                  WRKIOD,R6                                    
*                                                                               
LINV96   DS    0H                                                               
*                                                                               
LINVX    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - COMSUBS'                      
***********************************************************************         
*                                                                     *         
*        COMSUBS - CODE AND DATA ADDRESSABLE FROM ALL CSECTS          *         
*                                                                     *         
***********************************************************************         
*                                                                               
COMSUBS  DS    0H                                                               
SNVDTELM DS    XL256               DETAIL ORDER ELEM                            
SAVRC    DS    F                                                                
SVHDSDT  DS    H                                                                
SVHDEDT  DS    H                                                                
AMBLK    DS    A                                                                
AMBLKBF  DS    A                                                                
*                                                                               
         TITLE 'EASI - ADD INVOICES TO SPOTFILE - SETCML'                       
***********************************************************************         
*                                                                     *         
*        SETCML - FIND/SET CMML ELEMENTS IN BUFFER                    *         
*                                                                     *         
*NTRY    R3 ==>  COMMERCIAL CODE                                      *         
*        R4 ==>  TRAFFIC SEQUENTIAL NUMBER                            *         
*        R5 ==>  A(MINBLK)                                            *         
*                                                                     *         
*EXIT    BYTE  -  COMMERCIAL INTERNAL CODE                            *         
*                                                                     *         
***********************************************************************         
*                                                                               
SETCML   NTR1                                                                   
*                                                                               
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         MVI   BYTE,0                                                           
*                                                                               
         XC    SNVCMELM,SNVCMELM                                                
         LA    R2,SNVCMELM         ESTABLISH COMMERCIAL ELEMENT                 
         USING SNVCMELD,R2                                                      
*                                                                               
         MVI   SNVCMEL,SNVCMELQ    SET ELEMENT ID                               
         MVI   SNVCMLEN,SNVCMICD-SNVCMELD  IGNORE INTERNAL CD IN SEARCH         
*                                                                               
         GOTO1 GETEL,DMCB,MINBLKD,SNVCMEL,0 FIND FIRST COMMERCIAL ELM           
*                                                                               
SETCMLLP DS    0H                                                               
*                                                                               
         ICM   R2,15,8(R1)         POINT TO FOUND ELEMENT                       
         BZ    SETCMLDN            END OF COMMERCIAL ELEMENTS REACHED           
*                                                                               
         MVC   SNVCMICD-SNVCMELD+SNVCMELM,SNVCMICD  SAVE INTERNAL CODE          
*                                                                               
         CLC   SNVCMCD,0(R3)       MATCH ON COMMERCIAL CODE                     
         BE    SETCMLFD                                                         
*                                                                               
SETCMLCN DS    0H                                                               
*                                                                               
         GOTO1 SEQEL,DMCB,MINBLKD,SNVCMELM,0  GET NEXT ELEMENT                  
*                                                                               
         B     SETCMLLP                                                         
*                                                                               
SETCMLFD DS    0H                                                               
         MVC   BYTE,SNVCMICD-SNVCMELD+SNVCMELM  RETURN INTERNAL CODE            
*                                                                               
         B     SETCMLX                                                          
*                                                                               
SETCMLDN DS    0H                                                               
         LA    R2,SNVCMELM         RE-POINT TO COMML ELM BUILD AREA             
*                                                                               
         MVI   SNVCMLEN,SNVCMLNQ   SET ELEMENT LENGTH                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,SNVCMICD         BUMP LAST FOUND INTERNAL CODE                
         LA    RF,1(RF)                                                         
         STC   RF,SNVCMICD                                                      
*                                                                               
         STC   RF,BYTE             RETURN NEWEST INTERNAL CODE                  
*                                                                               
*        MVC   SNVCMSEQ,1(R4)      SET TRAFFIC SEQUENCE NUMBER                  
         MVC   SNVCMCD,0(R3)       SET COMMERCIAL CODE                          
*                                                                               
         GOTO1 ADDEL,DMCB,MINBLKD,SNVCMELM,0  ADD TO RECORD                     
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
SETCMLX  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
*                                                                               
* CHECK STATION FOR VALIDITY - 1ST 4 MUST NOT BE - (MINUS) *                    
*       UNLESS ALL NUMERIC                                 *                    
*                                                                               
CKSTA    NTR1                                                                   
         MVI   CKSTASRC,X'00'                                                   
         MVI   CKSTATYP,X'00'                                                   
         MVI   EZERRCD,X'00'                                                    
         LA    R1,EZBLOCKD                                                      
         AHI   R1,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,R1                                                        
         MVI   EZIHRTYP,X'00'                                                   
         DROP  R1                                                               
*                                                                               
         LA    R0,4                                                             
         LA    R1,EZBTSTN          USE SENT CALL LETTERS FOR REP                
*                                                                               
         LR    RF,R1                                                            
*                                                                               
         CLI   0(R1),C'Z'          COULD THIS BE CABLE                          
         BH    CKSTA20                                                          
*                                                                               
CKSTA10  CLI   0(R1),C'-'          MINUS NOT ALLOWED ANYWHERE                   
         BE    CKSTA40              ERROR                                       
         LA    R1,1(,R1)                                                        
         BCT   R0,CKSTA10                                                       
         B     CKSTA30             GO CHECK MEDIA                               
*                                                                               
CKSTA20  CLI   0(R1),C'0'                                                       
         BL    CKSTA24                                                          
         CLI   0(R1),C'9'                                                       
         BH    CKSTA40             ERROR                                        
         LA    R1,1(,R1)                                                        
         BCT   R0,CKSTA20                                                       
         B     CKSTA30             GO CK MEDIA                                  
*                                                                               
CKSTA24  CLI   0(R1),C' '          TRAILING BLANKS OK                           
         BNE   CKSTA40              ERROR                                       
         LA    R1,1(,R1)                                                        
         BCT   R0,CKSTA24                                                       
*                                                                               
* CHECK VALID MEDIA - AM/FM(RADIO), T/L(TV), C/S/N (NETWORK) *                  
*                                                                               
CKSTA30  LA    R0,9                                                             
         LA    R1,=C'AFRTLXCSN'                                                 
         LA    RF,4(,RF)                                                        
         LA    RF,1(,RF)                                                        
CKSTA34  CLC   0(1,RF),0(R1)                                                    
         BE    CKSTA50                                                          
         LA    R1,1(,R1)                                                        
         BCT   R0,CKSTA34                                                       
CKSTA40  MVI   EZERRCD,EZERRSTA                                                 
         BAS   RE,GETERRM                                                       
         MVI   EZMODE,EZINVL       SET TO SKIP TO NEXT INV                      
         B     CKSTAX                                                           
*                                                                               
CKSTA50  DS   0H                                                                
         CLI   QPRGTYPE,C'L'       LOCAL?                                       
         BNE   CKSTA52                                                          
         CLC   EZIHSORD,SPACES                                                  
         BNH   CKSTA86                                                          
         B     CKSTAX              YES, NO FURTHER CHECK                        
*                                                                               
* NOW CHECK REP FILE FOR CONTRACT NUMBER                                        
*                                                                               
CKSTA52  DS    0H                                                               
         CLI   QDPTDET,C'R'                                                     
         BNE   CKSTA53                                                          
         LA    RE,EZBLOCKD                                                      
         AHI   RE,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,RE                                                        
         CLI   EZORDSTR,C'S'                                                    
         DROP  RE                                                               
         BNE   *+8                                                              
         BRAS  RE,FIXORD                                                        
*                                                                               
CKSTA53  DS    0H                                                               
         L     RF,EZUTL                                                         
         MVC   HOLDSE,4(RF)                                                     
         MVC   4(1,RF),EZREPSE                                                  
*                                                                               
         XC    EZIHTRAF,EZIHTRAF   SET TRAFFIC ORDER TO NULLS                   
         XC    EZREPCON,EZREPCON   SET REP CONTRACT TO NULLS                    
*                                                                               
* CHECK REP/CONTRACT# PASSIVE POINTER FIRST                                     
*                                                                               
CKSTA54  XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RCONKEY,R4                                                       
         MVI   RCONPTYP,X'8C'      PASS PTR1 - REP, CONTRACT#(9'S COMP)         
         MVC   RCONPREP,EZAGY                                                   
*                                                                               
         CLI   CKSTASRC,C'R'       HAVE WE CHECKED REP ORDER ALREADY?           
         BE    CKSTA56             YES - CHECK STA CONTRACT/ORDER               
*                                                                               
         MVI   BYTE,C'R'           INDICATE SOURCE IS REP                       
         MVI   CKSTASRC,C'R'                                                    
         MVC   WORK(10),EZIHRORD       COPY REP CONTRACT/ORDER                  
         B     CKSTA60                                                          
*                                                                               
CKSTA56  MVI   BYTE,C'S'           INDICATE SOURCE IS STATION                   
         MVI   CKSTASRC,C'S'                                                    
         MVC   WORK(10),EZIHSORD       USE STATION'S                            
*                                                                               
CKSTA60  DS    0H                                                               
         CLC   WORK(10),SPACES     DO WE HAVE CONTRACT/ORDER #                  
         BH    CKSTA62             YES - LOOK IT UP                             
*                                                                               
* NO CONTRACT/ORDER # HERE                                                      
         CLI   CKSTASRC,C'R'       HAVE WE CHECKED REP ORDER ALREADY?           
         BE    CKSTA56             YES - CHECK STA CONTRACT/ORDER               
*                                                                               
         B     CKSTA86             NO CONTRACT#, NO ORDER#                      
*                                                                               
CKSTA62  DS    0H                                                               
         MVC   SVORD,WORK          SAVE FOR TRAFFIC CHECK                       
*                                                                               
         CLC   WORK(2),=C'D0'      THIS SPECIAL CASE                            
         BNE   CKSTA64                                                          
         MVC   WORK(9),WORK+1                                                   
         MVI   WORK+9,C' '                                                      
*                                                                               
CKSTA64  DS    0H                                                               
         LA    RE,10                                                            
         LA    RF,WORK+9                                                        
*                                                                               
CKSTA70  DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNL   CKSTA74                                                          
         BCTR  RF,0                                                             
         BCT   RE,CKSTA70                                                       
         B     CKSTA80             BAD CON# - CHECK ORDER#                      
*                                                                               
CKSTA74  DS    0H                                                               
         LR    R0,RE                                                            
         LR    R1,RF                                                            
*                                                                               
CKSTA76  DS    0H                                                               
         CLI   0(R1),C'0'          REST OF IT MUST BE NUMERIC                   
         BL    CKSTA80             BAD CON# - CHECK ORDER#                      
         BCTR  R1,0                                                             
         BCT   R0,CKSTA76                                                       
*                                                                               
         MVI   1(RF),C'0'          ADD A ZERO TO KILL WITH SIGN                 
         EX    RE,*+8                                                           
         B     *+10                                                             
         PACK  DUB,WORK(0)                                                      
*                                                                               
         MVC   WORK+12(5),=P'999999999'                                         
         SP    WORK+12(5),DUB           NOW GET 9'S COMPLEMENT                  
*                                                                               
         MVC   RCONPCON,WORK+12         MOVE IN 4 BYTES - 8 DIGITS              
*                                                                               
* READ CONTRACT NUMBER                                                          
         GOTO1 DATAMGR,DMCB,DMRDHI,=C'REPDIR',KEY,KEY1                          
*                                                                               
         CLC   KEY(L'RCONKEY),KEY1  SEE IF CONTRACT # EXISTS                    
         BE    CKSTA82              YES                                         
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
*                                                                               
CKSTA80  DS    0H                  LOOK FOR ORDER NUMBER                        
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING RCONKEY,R4                                                       
         MVC   RCONTNTP(2),=X'A203'   FOR TRAFFIC PASSIVE POINTER               
         MVC   RCONTNRP,EZAGY                                                   
         MVC   RCONTNT#,SVORD      MOVE IN TRAFFIC ORDER NUMBER                 
*                                                                               
         MVC   EZIHTRAF,SVORD      SAVE FOR LATER USE IF VALID                  
*                                                                               
         LA    R0,10                                                            
         LA    R1,RCONTNT#+9                                                    
*                                                                               
         CLI   0(R1),C' '          CK FOR BLANKS                                
         BH    *+16                 IF NOT, DONE                                
         MVI   0(R1),0             FORCE TO NULLS                               
         BCTR  R1,0                CK NEXT                                      
         BCT   R0,*-14                                                          
         DC    H'0'                SHOULD HAVE ELIMINATED EARLIER               
*                                                                               
         MVI   BYTE,C'T'           INDICATE SOURCE IS TRAFFIC                   
*                                                                               
         GOTO1 DATAMGR,DMCB,DMRDHI,=C'REPDIR',KEY,KEY1                          
         MVC   WORK(L'RCONKEY),KEY                                              
         MVC   WORK+L'RCONKEY(L'RCONKEY),KEY1                                   
         OC    WORK+RCONTNT#-RCONKEY(L'RCONTNT#),SPACES                         
         OC    WORK+L'RCONKEY+RCONTNT#-RCONKEY(L'RCONTNT#),SPACES               
         CLC   WORK(23),WORK+L'RCONKEY                                          
         BE    CKSTA81              YES                                         
*                                                                               
         MVC   KEY,KEY1            RESTORE KEY                                  
*                                                                               
         OC    RCONTNT#,SPACES     FORCE TRAFFIC # TO SPACES                    
*                                                                               
         GOTO1 DATAMGR,DMCB,DMRDHI,=C'REPDIR',KEY,KEY1                          
*                                                                               
         CLC   KEY(23),KEY1        SEE IF TRAFFIC # EXISTS                      
         BE    CKSTA81                                                          
*                                                                               
         CLI   CKSTASRC,C'R'       WORKING WITH REP ORDER#?                     
         BE    CKSTA54             YES - CHECK STATION CONTRACT/ORDER           
         B     CKSTA86              NO                                          
*                                                                               
*                                  SAVE 4 BYTES-8 DIGITS CONTRACT #             
CKSTA81  DS    0H                                                               
         XC    DUB,DUB                                                          
         MVC   DUB+3(4),RCONTNCN-RCONTNTP+KEY1                                  
         MVI   DUB+7,X'0F'                                                      
*                                                                               
         MVC   WORK+12(5),=P'999999999'                                         
         SP    WORK+12(5),DUB           NOW GET 9'S COMPLEMENT                  
*                                                                               
* FOUND CONTRACT NUMBER HERE                                                    
*                                                                               
CKSTA82  DS    0H                                                               
         MVC   EZREPCON,WORK+12    SAVE THIS CONTRACT #                         
*                                                                               
         L     R4,EZAREC                                                        
         GOTO1 DATAMGR,DMCB,GETREC,=C'REPFIL',KEY1+28,(R4),EZWORK               
*                                                                               
         CLI   EZBTSTN+3,C'.'      THIS NEED TO BE RESET                        
         BNE   *+8                                                              
         MVI   EZBTSTN+3,C' '                                                   
*                                                                               
         CLC   RCONKSTA(4),EZBTSTN SAME STATION AS EXPECTED?                    
         BE    CKSTA84              YES                                         
*                                                                               
         CLC   RCONKSTA(4),EZEQVSTA SAME STATION AS EXPECTED?                   
         BE    CKSTA84               YES                                        
*                                                                               
         LA    R4,KEY                                                           
         CLI   RCONTNTP,X'8C'       WORKING WITH CONTRACT NUMBER?               
         BE    CKSTA80              YES - NOW CHECK ORDER NUMBER                
*                                                                               
         CLC   =X'A203',RCONTNTP    WORKING WITH ORDER NUMBER?                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CKSTA83  DS    0H                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 DATAMGR,DMCB,DMRSEQ,=C'REPDIR',KEY,KEY1                          
         MVC   WORK(L'RCONKEY),KEY                                              
         MVC   WORK+L'RCONKEY,KEY1                                              
         OC    WORK+RCONTNT#-RCONKEY(L'RCONTNT#),SPACES                         
         OC    WORK+L'RCONKEY+RCONTNT#-RCONKEY(L'RCONTNT#),SPACES               
         CLC   WORK(23),WORK+L'RCONKEY    REP/TRAFFIC#                          
         BE    CKSTA81                                                          
*                                                                               
         B     CKSTA86                                                          
*                                                                               
CKSTA84  DS    0H                                                               
         LR    R6,R4                                                            
         LA    R6,RCONELEM-RCONREC(,R6)    POINT TO MAIN ELEM                   
         CLI   0(R6),01                    THIS MUST BE IT                      
         BE    *+6                                                              
         DC    H'0'                CAN NOT BE!                                  
*                                                                               
         USING RCONELEM,R6                                                      
         GOTO1 DATCON,DMCB,(3,RCONDATE),(2,WORK+16)                             
         GOTO1 (RF),(R1),(3,RCONDATE+3),(2,WORK+18)                             
*                                                                               
         MVI   EZERRCD,EZERRBDD                                                 
*                                                                               
         CLC   EZIHCMST,WORK+18    IF START AFTER END, NO GOOD                  
         BH    CKSTA85                                                          
         CLC   EZIHCMEN,WORK+16    IF START AFTER END, NO GOOD                  
         BL    CKSTA85                                                          
*                                                                               
         MVI   EZERRCD,0                                                        
*                                                                               
         MVC   EZIHSAID(4),RCONKADV                                             
*                                                                               
         MVC   DUB+3(4),RCONTNCN   SAVED UNSIGNED PACKED CONT #                 
         MVI   DUB+7,X'0F'         MAKE VALID PACKED                            
*                                                                               
         UNPK  WORK(9),DUB                                                      
         MVC   EZIHRORD(8),WORK                                                 
         MVC   EZIHRORD+8(2),SPACES                                             
*                                                                               
         TM    EZTRACE,X'10'       TEMP PRINT ADDED INVOICES                    
         BZ    CKSTA90                                                          
*                                                                               
         MVC   P+1(4),=C'KEY='                                                  
         GOTO1 HEXOUT,DMCB,KEY,P+5,32,=C'N'                                     
         MVC   P+75(14),=C'CONTRACT FOUND'                                      
         GOTO1 EZPRINT,DMCB,P,=C'BL01'                                          
*                                                                               
         MVC   P+1(4),=C'KY1='                                                  
         GOTO1 HEXOUT,DMCB,KEY1,P+5,32,=C'N'                                    
*                                                                               
         GOTO1 EZPRINT,DMCB,P,=C'BL01'                                          
         MVC   P,SPACES                                                         
         GOTO1 EZPRINT,DMCB,P,=C'BL01'                                          
         B     CKSTA90                                                          
*                                                                               
CKSTA85  DS   0H                                                                
         CLC   =X'A203',KEY         THIS ONLY TRAFFIC ORD SEARCH?               
         BE    CKSTA83                                                          
*                                                                               
* NO CONTRACT NUMBER, NO ORDER NUMBER HERE                                      
*                                                                               
CKSTA86  DS   0H                                                                
         XC    EZIHTRAF,EZIHTRAF   TRAFFIC ORDER OBVIOUSLY BAD                  
*                                                                               
         CLI   QDPTDET,C'R'        MEDIA OCEAN PROCESSING?                      
         BNE   CKSTA87                                                          
*                                                                               
         MVI   EZERRCD,0          PREV ERRS IRRELEVANT, RE-SET ERR CODE         
*                                                                               
         CLC   EZIHRORD,SPACES                                                  
         BNH   CKSTA86S                                                         
*                                                                               
         MVI   CKSTATYP,C'R'                                                    
         LHI   R0,8                                                             
         LA    R1,EZIHRORD                                                      
*                                                                               
CKSTA86R DS   0H                                                                
         CLI   0(R1),C' '                                                       
         BNH   CKSTA86V                                                         
         BRAS  RE,ISNUM                                                         
         BNE   CKSTA86S            REP ORDER NUMBER BAD - CHECK STA             
         LA    R1,1(R1)                                                         
         BCT   R0,CKSTA86R                                                      
         B     CKSTA90             8-CHAR NUMERIC=OK                            
*                                                                               
CKSTA86S DS   0H                                                                
         CLC   EZIHSORD,SPACES                                                  
         BNH   CKSTA87                                                          
*                                                                               
         MVI   CKSTATYP,C'S'                                                    
         LHI   R0,10                                                            
         LA    R1,EZIHSORD                                                      
*                                                                               
CKSTA86T DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BNH   CKSTA86V                                                         
         BRAS  RE,ISALPHA                                                       
         BE    *+12                                                             
         BRAS  RE,ISNUM                                                         
         BNE   CKSTA87                                                          
*                                                                               
         LA    R1,1(R1)                                                         
         BCT   R0,CKSTA86T                                                      
         B     CKSTA90             10-CHAR ALPHANUMERIC=OK                      
*                                                                               
CKSTA86V DS    0H                  MAKE SURE REMAINING CHARS ARE BLANKS         
         CLI   0(R1),C' '                                                       
         BH    CKSTA87                                                          
         LA    R1,1(R1)                                                         
         BCT   R0,CKSTA86V                                                      
         B     CKSTA90                                                          
*                                                                               
CKSTA87  DS   0H                                                                
         MVI   EZERRCD,EZERRCON                                                 
         BAS   RE,GETERRM                                                       
         MVI   EZMODE,EZINVL       SET TO SKIP TO NEXT INV                      
         B     CKSTA90                                                          
*                                                                               
CKSTA88  DS   0H                                                                
         DC    H'0' 10/01/2015 THIS CODE SHOULD BE UNREACHABLE                  
*&&DO                                                                           
         MVC   P,SPACES                                                         
         MVC   P+1(4),=C'REP='                                                  
         MVC   P+5(2),RCONKREP                                                  
         MVC   P+10(6),=C'EZSTA='                                               
         MVC   P+16(4),EZBTSTN                                                  
         MVC   P+22(6),=C'EZEQV='                                               
         MVC   P+28(4),EZEQVSTA                                                 
         MVC   P+34(5),=C'CSTA='                                                
         MVC   P+39(4),RCONKSTA                                                 
         MVC   P+46(7),=C'CON NO='                                              
         MVC   P+53(10),WORK           COPY REP CONTRACT/ORDER                  
         MVC   P+65(1),BYTE            SOURCE - REP OR STA CONTRACT #           
*                                                                               
         MVC   P+68(2),=C'T='                                                   
         MVC   P+67(10),EZIHTRAF                                                
*                                                                               
         MVC   P+80(2),=C'R='                                                   
         MVC   P+82(10),EZIHRORD                                                
*                                                                               
         MVC   P+94(2),=C'S='                                                   
         MVC   P+96(10),EZIHSORD                                                
*                                                                               
         GOTO1 EZPRINT,DMCB,P,=C'BL01'                                          
         MVC   P,SPACES                                                         
         MVC   P+1(3),=C'ID='                                                   
         MVC   P+4(7),=C'UNKNOWN'                                               
         MVC   P+20(4),=C'MOS='                                                 
*                                                                               
         MVC   FULL(2),UKUDATA-UKRECD+EZWKRIND                                  
*                                                                               
         TM    FULL,X'F0'                                                       
         BZ    CKSTA88A                                                         
*                                                                               
         MVC   BYTE,FULL                                                        
         BRAS  RE,NEW2OLD                                                       
         MVC   FULL(2),HALF                                                     
*                                                                               
CKSTA88A DS    0H                                                               
         MVI   FULL+2,X'0F'                                                     
         UNPK  DUB(5),FULL(3)                                                   
         MVC   P+24(4),DUB                                                      
*                                                                               
         MVC   P+32(4),=C'INV='                                                 
         MVC   P+36(10),EZIHINV                                                 
         MVC   P+52(5),=C'LDTE='                                                
         GOTO1 DATCON,DMCB,(2,UKAGELD-UKRECD+EZWKRIND),(5,P+57)                 
*                                                                               
* CHECK CTFILE FOR ORIG ID                                                      
*                                                                               
         L     RF,EZUTL                                                         
         MVI   4(RF),10                                                         
*                                                                               
         XC    KEY,KEY                                                          
         MVI   KEY,C'I'                                                         
         MVC   KEY+23(2),EZWKRIND                                               
         L     R6,EZAREC                                                        
         GOTO1 DATAMGR,DMCB,DMREAD,=C'CTFILE ',KEY,(R6)                         
*                                                                               
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   KEY(25),0(R6)       KEY HAD BETTER BE THE SAME                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SR    R0,R0                                                            
*                                                                               
         LA    R6,28(,R6)          ADDR OF FIRST ELEMENT                        
*                                                                               
         CLI   0(R6),X'02'                                                      
         BE    *+20                                                             
         IC    R0,1(R6)                                                         
         AR    R6,R0                                                            
         CLI   0(R6),0                                                          
         BNE   *-18                                                             
         DC    H'0'                                                             
*                                                                               
         MVC   P+4(10),CTDSC-CTDSCD(R6)                                         
*                                                                               
         GOTO1 EZPRINT,DMCB,P,=C'BL01'                                          
         MVC   P,SPACES                                                         
         MVI   EZERRCD,EZERRBDS                                                 
*                                                                               
CKSTA89  DS   0H                                                                
         BAS   RE,GETERRM                                                       
         MVI   EZMODE,EZINVL       SET TO SKIP TO NEXT INV                      
         B     CKSTA90                                                          
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P+1(3),=C'ID='                                                   
         MVC   P+4(7),=C'UNKNOWN'                                               
*                                                                               
* CHECK CTFILE FOR ORIG ID                                                      
*                                                                               
         L     RF,EZUTL                                                         
         MVI   4(RF),10                                                         
*                                                                               
         XC    KEY,KEY                                                          
         MVI   KEY,C'I'                                                         
         MVC   KEY+23(2),EZWKRIND                                               
         L     R6,EZAREC                                                        
         GOTO1 DATAMGR,DMCB,DMREAD,=C'CTFILE ',KEY,(R6)                         
*                                                                               
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   KEY(25),0(R6)       KEY HAD BETTER BE THE SAME                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R6,28(,R6)          ADDR OF FIRST ELEMENT                        
         CLI   0(R6),X'02'                                                      
         BE    *+22                                                             
         ZIC   R0,1(R6)                                                         
         AR    R6,R0                                                            
         CLI   0(R6),0                                                          
         BNE   *-20                                                             
         DC    H'0'                                                             
*                                                                               
         MVC   P+4(10),CTDSC-CTDSCD(R6)                                         
*                                                                               
*        MVC   P+1(4),=C'STA='                                                  
         MVC   P+15(7),EZBTSTN                                                  
*                                                                               
         MVC   P+25(2),=C'C='                                                   
         MVC   P+27(10),WORK                                                    
*                                                                               
         MVC   P+40(6),=C'FLD=RO'                                               
*        MVC   P+44(2),=C'REP'                                                  
         CLI   BYTE,C'R'                                                        
         BE    *+10                                                             
         MVC   P+44(2),=C'SO'                                                   
*                                                                               
         MVC   P+49(4),=C'INV='                                                 
         MVC   P+53(10),EZIHINV                                                 
*                                                                               
         GOTO1 DATCON,DMCB,(3,EZBTBRDT),(5,P+65)                                
*                                                                               
         MVC   P+75(1),EZWKRFIL+4                                               
*                                                                               
         GOTO1 EZPRINT,DMCB,P,=C'BL01'                                          
         MVC   P,SPACES                                                         
*&&                                                                             
*                                                                               
CKSTA90  DS   0H                                                                
         LA    R1,EZBLOCKD                                                      
         AHI   R1,EZBLKX-EZBLOCKD                                               
         USING EZBLKX,R1                                                        
         MVC   EZIHRTYP,CKSTATYP                                                
         DROP  R1                                                               
         L     RF,EZUTL                                                         
         MVC   4(1,RF),HOLDSE                                                   
*                                                                               
CKSTAX   B     EXIT                                                             
         DROP  R4                                                               
*                                                                               
*                                                                               
*                                                                               
*        GETERRM - GET ERROR MESSAGE AND LEVEL                                  
*                                                                               
GETERRM  NTR1                                                                   
         L     R3,=A(ERRTAB)                                                    
         MVC   EZERRMSG,SPACES                                                  
         MVI   EZERRLEV,0                                                       
*                                                                               
GERM2    DS    0H                                                               
         CLI   0(R3),X'FF'         EOL                                          
         BE    GERMX                                                            
*                                                                               
         CLC   EZERRCD,0(R3)                                                    
         BE    GERM4                                                            
         LA    R3,ERRTABL(R3)                                                   
         B     GERM2                                                            
*                                                                               
GERM4    DS    0H                                                               
         MVC   EZERRLEV,1(R3)                                                   
         MVC   EZERRMSG,2(R3)                                                   
         OC    EZERRLVR,1(R3)      'OR' UP ERROR - RECORD                       
         OC    EZERRLVI,1(R3)                    - INVOICE                      
         OC    EZERRLVB,1(R3)                    - BATCH                        
*                                                                               
GERMX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
SAVBUF   DS    0H                  SAVE WRKR BUFFER                             
         L     RF,EZWKRBUF                                                      
         L     R1,=A(SAVWKBUF)                                                  
*                                                                               
         LA    R0,16               16 X 256 BYTES = 4096                        
         MVC   0(256,R1),0(RF)                                                  
         LA    R1,256(R1)                                                       
         LA    RF,256(RF)                                                       
         BCT   R0,*-14                                                          
         BR    RE                                                               
*                                                                               
INVFILE  DC    CL8'XSPFIL '        INVOICE FILE NAME                            
INVDIR   DC    CL8'XSPDIR'         INVOICE DIRECTORY NAME                       
ERRTABL  EQU   42                                                               
*                                                                               
VMINIO   DS    A                   A(MINIO)                                     
VPERVERT DS    A                   A(PERVERT)                                   
VGTBROAD DS    A                   A(GETBROAD)                                  
*                                                                               
ADSCTL   DC    C'1'                CONTROL SWITCH                               
ADS1STQ  EQU   C'1'                FIRST TIME TO PROGRAM                        
*                                                                               
*                                                                               
*                                                                               
CADDEL   NTR1                                                                   
         GOTO1 ADDEL,DMCB,MINBLKD,(R2),0 ADD ELEMENT TO RECORD                  
         B     EXIT                                                             
         TITLE 'ROUTINE TO ADD ELEMENT TO A MINIO BLOCK - ADDEL'                
***********************************************************************         
* ROUTINE TO ADD AN ELEMENT TO A RECORD                               *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*                                                                     *         
***********************************************************************         
*                                                                               
ADDEL    NTR1                                                                   
*                                                                               
         L     R5,0(R1)            A(MINBLKD)                                   
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         ICM   R0,15,MINELEM       SAVE ELEMENT AREA POINTER                    
*                                                                               
         MVC   MINELEM,4(R1)       POINT BLOCK TO NEW ELEMENT                   
*                                                                               
         CLI   EZSOON,C'S'         THIS RUNNING SOON?                           
         BNE   ADDEL10              NO, DON'T TRACK REC SIZE                    
*                                                                               
         SR    RE,RE                                                            
         L     R2,4(R1)                                                         
         IC    RE,1(R2)                                                         
         SR    RF,RF                                                            
         ICM   RF,3,EZINVSIZ                                                    
         AR    RF,RE                                                            
         STCM  RF,3,EZINVSIZ                                                    
*                                                                               
ADDEL10  DS    0H                                                               
         L     R1,4(R1)               POINT TO ELEMENT TO BE ADDED              
         BRAS  RE,DMPREC              GO DUMP ELEMENT                           
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINADD',MINBLKD)                                 
*                                                                               
         STCM  R0,15,MINELEM       RESTORE ELEMENT AREA POINTER                 
*                                                                               
         CLI   MINERR,0            NO ERRORS ALLOWED                            
         BE    ADDELX                                                           
         CLI   MINERR,MINEDUP      EXCEPT DUPLICATES                            
         BE    *+6                                                              
         DC    H'0'                                                             
         LTR   RB,RB               SET BAD CONDITION CODE                       
*                                                                               
ADDELX   XIT1                                                                   
         DROP  R5                                                               
         TITLE 'ROUTINE TO DELETE AN ELEMENT IN A MINIO BLOCK - ADDEL'          
***********************************************************************         
* ROUTINE TO DELETE AN ELEMENT FROM A RECORD                          *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*                                                                     *         
***********************************************************************         
*                                                                               
DELEL    NTR1  0H                                                               
*                                                                               
         L     R5,0(R1)            A(MINBLKD)                                   
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         ICM   R0,15,MINELEM       SAVE ELEMENT AREA POINTER                    
*                                                                               
         L     R2,4(R1)            POINT TO ELEMENT TO BE DELETED               
*                                                                               
         ST    R2,MINELEM          POINT BLOCK TO ELEMENT                       
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY AREA                        
*                                                                               
         MVC   MINEKEY(1),0(R2)    BUILD ELEMENT KEY                            
*                                                                               
         ZIC   RF,1(R2)            GET ELEMENT LENGTH                           
         BCTR  RF,0                GET KEY LENGTH                               
*                                                                               
         CLM   RF,1,MINEKLEN       DEFAULT TO MINIO KEY LENGTH                  
         BNH   *+8                                                              
         IC    RF,MINEKLEN                                                      
*                                                                               
         AHI   RF,-2               DECREMENT FOR EXECUTE                        
*                                                                               
         EX    RF,DELELMV          SET REST OF KEY                              
*                                                                               
         GOTO1 VMINIO,MNPRMS,('MINDEL',MINBLKD)                                 
*                                                                               
         STCM  R0,15,MINELEM       RESTORE ELEMENT AREA POINTER                 
*                                                                               
         CLI   MINERR,0            NO ERRORS ALLOWED                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     DELELX                                                           
*                                                                               
DELELMV  MVC   MINEKEY+1(0),2(R2)   SETS REST OF ELEMENT KEY                    
*                                                                               
*                                                                               
DELELX   XIT1                                                                   
*                                                                               
         DROP  R5                                                               
*                                                                               
         TITLE 'ROUTINE TO GET AN ELEMENT IN A MINIO BLOCK - GETEL'             
***********************************************************************         
* ROUTINE TO GET AN ELEMENT IN A RECORD                               *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*        ELEMENT  CONTAINS ELEMENT CODE AND DATA TO SEARCH FOR        *         
*        ELEMENT+1 CONTAINS LENGTH TO BE COMPARED INCLUDING LENGTH    *         
*                 BYTE WHICH IS NOT INCLUDED IN COMPARE               *         
* EXIT - 8(R1)  CONTAINS ADDRESS OF ELEMENT OR ZEROES IF NOT FOUND    *         
***********************************************************************         
*                                                                               
GETEL    NTR1                                                                   
*                                                                               
         L     R5,0(R1)            A(MINBLKD)                                   
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         L     R2,4(R1)            POINT O ELEMENT KEY                          
         LR    R4,R1               SAVE PARAMETER REGISTER                      
*                                                                               
         ZIC   R6,MINFILTL         SAVE CURRENT FILTER VALUE                    
*                                                                               
         MVI   MINFILTL,0          INIT FILTER LENGTH                           
*                                                                               
         XC    MINEKEY,MINEKEY     INIT ELEMENT KEY AREA                        
*                                                                               
         MVC   MINEKEY(1),0(R2)    BUILD ELEMENT KEY                            
*                                                                               
         LA    R0,MINRD            DEFAULT TO DIRECT READ                       
*                                                                               
         CLI   1(R2),0             USE DEFAULT IF NO LENGTH GIVEN               
         BE    GETEL10                                                          
*                                                                               
         ZIC   RF,1(R2)            GET ELEMENT LENGTH                           
         BCTR  RF,0                GET SEARCH LENGTH                            
*                                                                               
         CLM   RF,1,MINEKLEN       USE READ IF GREATER THAN KEY LENGTH          
         BNL   GETEL10                                                          
*                                                                               
         LA    R0,MINHI            SET FOR READ HI/EQUAL                        
         STC   RF,MINFILTL         SET FILTER LENGTH                            
*                                                                               
GETEL10  DS    0H                                                               
*                                                                               
         ZIC   RF,MINEKLEN         GET KEY LENGTH                               
         AHI   RF,-2               DECREMENT FOR EXECUTE                        
         EX    RF,GETELMV          SET REST OF KEY                              
*                                                                               
         GOTO1 VMINIO,MNPRMS,((R0),MINBLKD)                                     
*                                                                               
         STC   R6,MINFILTL         RESTORE CURRENT FILTER VALUE                 
*                                                                               
         XC    8(4,R4),8(R4)       INIT RETURNED PARAMETER                      
*                                                                               
         CLI   MINERR,0            NO MATCH                                     
         BNE   GETELX                                                           
*                                                                               
         MVC   8(4,R4),MINELEM     GET RETURNED ELEMENT ADDRESS                 
         B     GETELX                                                           
*                                                                               
GETELMV  MVC   MINEKEY+1(0),2(R2)  SETS REST OF ELEMENT KEY                     
*                                                                               
GETELX   XIT1                                                                   
         DROP  R5                                                               
         TITLE 'ROUTINE TO GET NEXT ELEMENT IN A MINIO BLOCK - SEQEL'           
***********************************************************************         
* ROUTINE TO GET NEXT SEQUENTIAL ELEMENT IN A MINIO RECORD            *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*        ELEMENT  CONTAINS ELEMENT CODE AND DATA TO SEARCH FOR        *         
*        ELEMENT+1 CONTAINS LENGTH TO BE COMPARED INCLUDING LENGTH    *         
*                 BYTE WHICH IS NOT INCLUDED IN COMPARE               *         
*                 ASSUMES LAST ACTION WAS A GETEL AND MINIO BLOCK     *         
*                  IS ALREADY SET UP FOR SEQUENTIAL READ              *         
*                                                                     *         
* EXIT - 8(R1)  CONTAINS ADDRESS OF ELEMENT OR ZEROES IF NOT FOUND    *         
***********************************************************************         
*                                                                               
SEQEL    NTR1                                                                   
*                                                                               
         L     R5,0(R1)            A(MINBLKD)                                   
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         L     R2,4(R1)            POINT TO ELEMENT KEY                         
         LR    R4,R1               SAVE PARAMETER REGISTER                      
*                                                                               
         ZIC   R6,MINFILTL         SAVE CURRENT FILTER VALUE                    
*                                                                               
         MVI   MINFILTL,0          INIT FILTER LENGTH                           
*                                                                               
         CLI   1(R2),0             USE DEFAULT IF NO LENGTH GIVEN               
         BE    SEQEL10                                                          
*                                                                               
         ZIC   RF,1(R2)            GET ELEMENT LENGTH                           
         BCTR  RF,0                GET SEARCH LENGTH                            
*                                                                               
         CLM   RF,1,MINEKLEN       USE READ IF GREATER THAN KEY LENGTH          
         BNL   SEQEL10                                                          
*                                                                               
         STC   RF,MINFILTL         SET FILTER LENGTH                            
*                                                                               
SEQEL10  DS    0H                                                               
*                                                                               
         LA    R0,MINSEQ           SET FOR READ READ SEQUENTIAL                 
*                                                                               
         GOTO1 VMINIO,MNPRMS,((R0),MINBLKD)                                     
*                                                                               
         STC   R6,MINFILTL         RESTORE CURRENT FILTER VALUE                 
*                                                                               
         XC    8(4,R4),8(R4)       INIT RETURNED PARAMETER                      
*                                                                               
         CLI   MINERR,0            NO MATCH                                     
         BNE   SEQELX                                                           
*                                                                               
         MVC   8(4,R4),MINELEM     GET RETURNED ELEMENT ADDRESS                 
         B     SEQELX                                                           
*                                                                               
SEQELX   XIT1                                                                   
         DROP  R5                                                               
         TITLE 'ROUTINE TO PUT AN ELEMENT TO A MINIO BLOCK - PUTEL'             
***********************************************************************         
* ROUTINE TO PUT AN ELEMENT IN A RECORD                               *         
*       DELETES AND ADDS NEW ELEMENT WILL NOT GET UPSET IF THERE      *         
*         IS NO PRIOR ELEMENT                                         *         
*                                                                     *         
* NTRY - PARM1    A(MINIO BLOCK)                                      *         
*        PARM2    A(ELEMENT)                                          *         
*                                                                     *         
***********************************************************************         
*                                                                               
PUTEL    NTR1  0H                                                               
*                                                                               
         GOTO1 GETEL,(R1)          FIND ELEMENT                                 
*                                                                               
         OC    8(4,R1),8(R1)       ADD ELEMENT IF NONE ALREADY                  
         BZ    PUTELADD            ELSE DELETE OLD ELEMENT                      
*                                                                               
         GOTO1 DELEL,(R1)          DELETE ELEMENT                               
*                                                                               
PUTELADD DS    0H                                                               
*                                                                               
         GOTO1 ADDEL,(R1)          ADD ELEMENT TO RECORD                        
         BE    *+6                                                              
         DC    H'0'                ANY ERRORS                                   
*                                                                               
PUTELX   XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
*                                                                               
HOLDSE   DC    H'0'                                                             
         DS    0D                                                               
MINBLK   DS    XL(MINBLKL)         MINIO BLOCK FOR INVOICE RECORD               
         DS    0D                                                               
MINBLKBF DS    XL(MINBLKL)         MINIO BLOCK FOR BUFFER INVOICE REC           
*                                                                               
         DS    0D                                                               
*SNVMELEM DS    XL128               ELEMENT RETRIEVAL AREA                      
SNVMELEM DS    XL255               ELEMENT RETRIEVAL AREA                       
SNVMRTAB DS    XL14336             RECORD TABLE                                 
*                                                                               
         DS    0D                                                               
SAVINVH  DS    XL512               SAVE AREA FOR INVOICE HEADER                 
         DS    0D                                                               
SNVMBUF1 DS    XL3975              FIRST  MINIO BUFFER                          
SNVMBUF2 DS    XL3975              SECOND MINIO BUFFER                          
SNVMBUF3 DS    XL3975              THIRD  MINIO BUFFER                          
SNVMBUF4 DS    XL3975              FOURTH MINIO BUFFER                          
*                                                                               
SAVWKBUF DS    XL14336             WORKER FILE BUFFER SAVEAREA                  
*                                                                               
*                                  ERROR TABLE                                  
*                                  CODE(1),LEVEL(1),MESSAGE(40)                 
*                                                                               
ERRTAB   DS    0C                                                               
         DC    AL1(EZERRDUP)       DUPLICATE INVOICE                            
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVOICE ALREADY ON FILE'                                    
*                                                                               
         DC    AL1(EZERROVF)       OVERFLOW                                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'TOO MANY SPOTS IN INVOICE'                                  
*                                                                               
         DC    AL1(EZERRANF)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'CLIENT NOT ON FILE'                                         
*                                                                               
         DC    AL1(EZERRPNF)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'PRODUCT NOT ON FILE'                                        
*                                                                               
         DC    AL1(EZERRSPL)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL SPOT LENGTH ZERO'                               
*                                                                               
         DC    AL1(EZERRMUL)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'COMBINED INVOICES, NO RECONVERT'                            
*                                                                               
         DC    AL1(EZERRZER)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'ZERO SPOTS, NOT CONVERTED'                                  
*                                                                               
         DC    AL1(EZERRTMZ)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL TIME ZERO'                                      
*                                                                               
         DC    AL1(EZERRDTE)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL DATE OUT OF PERIOD'                             
*                                                                               
         DC    AL1(EZERRENF)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'ESTIMATE NOT ON FILE'                                       
*                                                                               
         DC    AL1(EZERREDT)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INV DATES NOT IN EST DATES'                                 
*                                                                               
         DC    AL1(EZERRSTA)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'UNKNOWN NET FOR CABLE STATION'                              
*                                                                               
         DC    AL1(EZERRTMH)                                                    
         DC    AL1(0)              LEVEL                                        
         DC    CL40'SPOT DETAIL TIME HIGH'                                      
*                                                                               
         DC    AL1(EZERRDOL)       INVALID DOLLAR FIELD                         
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID DOLLARS'                                            
*                                                                               
         DC    AL1(EZERBDDT)       BAD DATE                                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'BAD DATE'                                                   
*                                                                               
         DC    AL1(EZERBRDT)       BAD BROADCAST MONTH                          
         DC    AL1(0)              LEVEL                                        
         DC    CL40'BAD BROADCAST MONTH'                                        
*                                                                               
         DC    AL1(EZERRSIZ)       INVOICE TOO BIG FOR SOON                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVOICE TOO BIG FOR SOON'                                   
*                                                                               
         DC    AL1(EZERRCON)       CONTRACT NUMBER NOT ON REP FILE              
         DC    AL1(0)              LEVEL                                        
         DC    CL40'CONTRACT NOT ON REP FILE'                                   
*                                                                               
         DC    AL1(EZERR255)       MORE THAN 255 IDENTICAL SPOTS                
         DC    AL1(0)              LEVEL                                        
         DC    CL40'OVER 255 SPOTS WITH SAME DATE,TIME'                         
*                                                                               
         DC    AL1(EZERRTIM)       BAD TIME                                     
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVALID TIME'                                               
*                                                                               
         DC    AL1(EZERRBDS)       REP - CONTRACT HAS DIFFERENT STA             
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVOICE WRONG STA FOR CONTRACT'                             
*                                                                               
         DC    AL1(EZERRBDD)       REP - CONTRACT HAS WRONG DATES               
         DC    AL1(0)              LEVEL                                        
         DC    CL40'INVOICE WRONG DATES FOR CONTRACT'                           
*                                                                               
         DC    X'FFFF'                                                          
*                                                                               
         DROP  RB,RC                                                            
         TITLE 'EZADDSNV - PROGRAM INITIALIZATION - MININIT'                    
***********************************************************************         
*                                                                     *         
*        MININIT - PROGRAM INITIALIZATION                             *         
*              INIT SPOT INVOICE RECORD MINIO BLOCK                   *         
*              INIT SPOT INVOICE RECORD BUFFER MINIO BLOCK            *         
*                                                                     *         
***********************************************************************         
*                                                                               
MININIT  NMOD1 0,**+MIN**                                                       
*                                                                               
         LHI   RF,MINBLKBF-COMSUBS                                              
         LA    RF,0(RA,RF)                                                      
         ST    RF,AMBLKBF                                                       
*                                                                               
         LHI   RF,MINBLK-COMSUBS                                                
         LA    RF,0(RA,RF)                                                      
         ST    RF,AMBLK                                                         
*                                                                               
         L     RC,SAVRC                                                         
         USING EZADSD,RC                                                        
         MVI   ADSCTL,0               CLEAR FIRST TIME SWITCH                   
         L     RF,ACOMFACS         GET MINIO ADDRESS                            
         MVC   CDATAMGR-COMFACSD(4,RF),DATAMGR  SET A(DATAMGR)                  
         MVC   VMINIO,CMINIO-COMFACSD(RF)                                       
*                                                                               
         L     RF,CCALLOV-COMFACSD(RF) A(CALLOV)                                
         ICM   R0,15,=X'D9000A74'  MINIO PHASE NAME                             
*                                                                               
         IC    R0,=X'1D'           GETBROAD PHASE NAME                          
         GOTO1 (RF),DMCB,0,(R0)                                                 
         MVC   VGTBROAD,0(R1)      SET GETBROAD ADDRESS                         
*                                                                               
         L     RF,=V(PERVERT)                                                   
         ST    RF,VPERVERT                                                      
*                                                                               
*        INITIALIZE MINIO VALUES                                                
*                                                                               
         LA    R0,MINBLK           CLEAR MINBLOCK                               
         LA    R1,MINBLKL                                                       
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         LA    R5,MINBLK           ESTABLISH MINIO BLOCK                        
         USING MINBLKD,R5                                                       
*                                                                               
         MVI   MINBF2,X'00'        FIRST MINIO BUFFER                           
         MVC   MINSPCT,=AL2(90)                                                 
*                                                                               
         MVC   MINRECUP,=V(RECUP)  A(RECUP)                                     
         MVC   MINCOMF,ACOMFACS    A(COMFACS)                                   
         MVI   MINOPEN,C'N'        SET NOT OPEN                                 
         MVC   MINFIL,INVFILE      FILE NAME                                    
         MVC   MINDIR,INVDIR       DIR NAME                                     
         MVI   MINFKLEN,L'SNVKEY   KEY LENGTH                                   
         MVI   MINEKLEN,L'SNVKMINK   ELEMENT KEY LENGTH                         
         MVI   MINEKDSP,L'SNVKMAST   DISPLACEMENT TO ELEMENT KEY                
*                                                                               
         MVI   MINEKDSP,26                                                      
*                                                                               
         MVI   MINNCTL,L'SNVDSTAT  NUMBER OF CONTROL BYTES                      
         MVC   MINFRCLM,=H'3975'   MAXIMUM RECORD LENGTH                        
*                                                                               
         CLI   EZSOON,C'S'         THIS RUNNING SOON?                           
         BNE   *+10                                                             
         MVC   MINFRCLM,=H'3900'   MAXIMUM RECORD LENGTH                        
*                                  FOR SOON - MINIO WRITES REC MORE             
*                                  THAN ONCE, PART AT A TIME                    
*                                                                               
         L     RF,=A(SNVMBUF1)     POINT TO START OF MINIO BUFFERS              
         ST    RF,MINBUFF          A(FIRST BUFFER)                              
*                                                                               
         MVI   MINNBUF,4           USE FOUR BUFFERS                             
*                                                                               
         L     RF,=A(SNVMRTAB)                                                  
         ST    RF,MINRTAB          A(AREA FOR RECORD TABLE)                     
*                                                                               
         MVC   MINRTABL,=Y(L'SNVMRTAB) LENGTH OF RECORD TABLE                   
*                                                                               
         L     RF,=A(SNVMELEM)      A(AREA FOR ELEM OR CLUSTER)                 
         ST    RF,MINELEM                                                       
*                                                                               
         XC    0(L'SNVMELEM,RF),0(RF)  CLEAR MINELEM AREA                       
*                                                                               
         MVC   MINMAXEL,=Y(L'SNVMELEM)   MAX LENGTH OF ELEM OR CLUSTER          
*                                                                               
***********************************************************************         
*                                                                     *         
*        SET UP BUFFER FOR BUILDING INVOICE MINIO RECORD              *         
*            IT WILL BE USED TO HOLD RECORDS WHILE TAPE IS            *         
*            BEING PROCESSED. AT END OF INV ON TAPE RECORDS WILL      *         
*            BE WRITTEN BACK TO FILE FROM THE BUFFERS. NEEDED TO      *         
*            PREVENT MINIO FROM WRITING TO FILE PREMATURELY. ALSO     *         
*            ALLOWS FOR TRUE TEST MODE.                               *         
*                                                                     *         
***********************************************************************         
*                                                                               
*                                                                               
*        MINIO PARAMETERS FOR INVOICE BUFFER                                    
*                                                                               
*NVBBFL  EQU   128000+64000+64000+64000  MINIO BUFFER LENGTH                    
SNVBBFL  EQU   512000                    MINIO BUFFER LENGTH                    
SNVBNBUF EQU   1                   NUMBER OF BUFFERS                            
SNVBELML EQU   256                 ELEMENT AREA LENGTH                          
SNVBTBLL EQU   ((6+L'SNVKMINK)*1) TABLE AREA LENGTH - MAX 1 RECORD              
*                                                                               
*        LA    R5,MINBLKBF         POINT TO BUFFER MINIO BLOCK                  
         L     R5,AMBLKBF          POINT TO BUFFER MINIO BLOCK                  
         USING MINBLKD,R5                                                       
         XC    MINBLKD(MINNRECS-MINBLKD),MINBLKD INIT MINIO AREA                
*                                                                               
         MVI   MINBF2,C'Y'         SECOND MINIO BUFFER                          
                                                                                
*                                                                               
         MVC   MINRECUP,=V(RECUP)  A(RECUP)                                     
         MVC   MINCOMF,ACOMFACS    A(COMFACS)                                   
         MVI   MINOPEN,C'N'        SET NOT OPEN                                 
         MVC   MINFIL,INVFILE      FILE NAME                                    
         MVC   MINDIR,INVDIR       DIR NAME                                     
         MVI   MINFKLEN,L'SNVKEY   KEY LENGTH                                   
         MVI   MINEKLEN,L'SNVKMINK   ELEMENT KEY LENGTH                         
         MVI   MINEKDSP,L'SNVKMAST   DISPLACEMENT TO ELEMENT KEY                
         MVI   MINNCTL,L'SNVDSTAT  NUMBER OF CONTROL BYTES                      
         MVC   MINFRCM3,=AL3(SNVBBFL)  MAX RECORD LENGTH                        
         MVI   MINNBUF,SNVBNBUF    USE ONE BUFFER                               
*                                                                               
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         IC    RF,MINNBUF          NUMBER OF MINIO BLOCKS                       
         ICM   RE,7,MINFRCM3       LENGTH OF A MINIO BUFFER                     
         MR    RE,RE               BUFFER AREA NEEDED                           
         LA    RF,SNVBELML+SNVBTBLL(RF) ADD ON ELM AND TABLE LENGTHS            
*                                                                               
         LA    R3,8(RF)            MAKE EVEN NO. OF DOUBLE WORDS                
         SRL   R3,3                                                             
         SLL   R3,3                                                             
*                                                                               
         LA    R4,MINBUFF          RETURN ADDRESS HERE                          
*                                                                               
         GETMAIN EC,LV=(R3),A=(R4) GET CORE                                     
         LTR   RF,RF               CHECK FOR ERRORS                             
         BZ    *+6                                                              
         DC    H'0'                NO BUFFER AREA AVAILABLE                     
*                                                                               
         ICM   R1,15,MINBUFF       BUFFER ADDRESS                               
         L     RF,=AL4(SNVBBFL)                                                 
         AR    R1,RF               A(ELEMENT AREA)                              
         ST    R1,MINELEM                                                       
         LA    R1,SNVBELML(R1)     A(RECORD TABLE)                              
         ST    R1,MINRTAB                                                       
*                                                                               
         MVC   MINRTABL,=Y(SNVBTBLL)   LENGTH OF RECORD TABLE                   
*                                                                               
         MVC   MINMAXEL,=Y(SNVBELML)   MAX LENGTH OF ELEM OR CLUSTER            
*                                                                               
         MVI   MINMODE,C'B'        SET FOR BUFFER MODE                          
*                                                                               
MININITX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  RB,RC                                                            
*                                                                               
*                                                                               
*        DMPREC - HEX DUMP OF ELEMENT WORK AREA                                 
*                                                                               
*NTRY    R1 ==>  ELEMENT TO BE ADDED                                            
*                                                                               
DMPREC   DS    0H                                                               
         TM    EZTRACE,X'10'       IF TRACING                                   
         BZR   RE                  NO                                           
DMP      NMOD1 0,**+DMP**                                                       
*                                                                               
         L     RC,SAVRC                                                         
         USING EZADSD,RC                                                        
*                                                                               
         LR    R5,R1               POINT TO ELEMENT WORKAREA                    
         SR    R2,R2                                                            
         ICM   R2,1,1(R5)          ELEMENT LENGTH                               
*                                                                               
         CLC   =X'0EA3',0(R5)      IF DUMPING KEY                               
         BE    *+14                                                             
         CLC   =X'0E03',0(R5)      IF DUMPING KEY                               
         BNE   *+8                                                              
         LA    R2,L'SNVKEY            RESET DUMP LENGTH                         
*                                                                               
         LA    R3,0(R5,R2)         EOR                                          
*                                                                               
DMPREC2  DS    0H                                                               
         LR    R4,R3                                                            
         SR    R4,R5                                                            
         BNP   DMPRECX                                                          
         CHI   R4,32                                                            
         BNH   *+8                                                              
         LA    R4,32                                                            
         XC    WORK,WORK                                                        
         GOTO1 HEXOUT,DMCB,(R5),WORK,(R4),=C'N'                                 
*                                                                               
         MVC   P+01(8),WORK+00                                                  
         MVC   P+10(8),WORK+08                                                  
         MVC   P+19(8),WORK+16                                                  
         MVC   P+28(8),WORK+24                                                  
         MVC   P+37(8),WORK+32                                                  
         MVC   P+46(8),WORK+40                                                  
         MVC   P+55(8),WORK+48                                                  
         MVC   P+64(8),WORK+56                                                  
*                                                                               
         MVC   WORK(32),0(R5)                                                   
         TR    WORK(32),TRTAB                                                   
         BCTR  R4,R0                                                            
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   P+75(0),WORK                                                     
         LA    R4,1(R4)                                                         
         GOTO1 REPORT                                                           
         LA    R5,0(R5,R4)                                                      
         B     DMPREC2                                                          
*                                                                               
DMPRECX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
TRTAB    DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     00-0F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     10-1F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     20-2F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     30-3F                    
         DC    X'404B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     40-4F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B5B5C5D4B4B'     50-5F                    
         DC    X'60614B4B4B4B4B4B4B4B4B6B6C6D4B6F'     60-6F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B7B4B7D7E4B'     70-7F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     80-8F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     90-9F                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     A0-AF                    
         DC    X'4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B4B'     B0-BF                    
         DC    X'4BC1C2C3C4C5C6C7C8C94B4B4B4B4B4B'     C0-CF                    
         DC    X'4BD1D2D3D4D5D6D7D8D94B4B4B4B4B4B'     D0-DF                    
         DC    X'4B4BE2E3E4E5E6E7E8E94B4B4B4B4B4B'     E0-EF                    
         DC    X'F0F1F2F3F4F5F6F7F8F94B4B4B4B4B4B'     F0-FF                    
         DROP  R5                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* THIS SUBROUTINE UPDATES DETAIL ORDER ELEMENT BY ADDING FIELD EQUATE           
* SUPPLIED BY THE CALLER                                                        
* FOLLOWING IS EXPECTED TO BE TRUE ON INPUT:                                    
*    R1 ADDRESSES DETAIL ELEMENT                                                
*    R0 HAS FIELD NUMBER EQUATE IN LOW-ORDER BYTE                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
UPDORDER NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LR    R2,R1               A(DETAIL ORDER ELEM)                         
         USING SNVDTELD,R1         R1 POINTS TO DETAIL ORDER ELEM               
         LHI   RF,MAXFLDEQ-4       MAX NUMBER OF EQUATES COUNTER                
         LA    R1,SNVDTFLD-SNVDTEL(R1)   POINT TO EQUATE LIST                   
*                                                                               
UPDORD10 CLM   R0,1,0(R1)          EQUATE ALREADY THERE?                        
         BE    UPDORDX             YES - EXIT                                   
         CLI   0(R1),0             END OF USED PORTION                          
         BE    UPDORD20                                                         
         LA    R1,1(,R1)           NEXT BYTE                                    
         BCT   RF,UPDORD10                                                      
*                                                                               
         DC    H'0'                DIE, IF DETAIL ORDER ELEMENT FULL            
*                                                                               
UPDORD20 STC   R0,0(R1)            ADD FIELD EQUATE                             
         IC    RF,1(R2)            UPDATE ELEMENT LENGTH                        
         AHI   RF,1                                                             
         STC   RF,1(R2)                                                         
*                                                                               
UPDORDX  J     EQXIT                                                            
         LTORG                                                                  
         DROP  R2                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* R1 EXPECTED TO ADDRESS EZSPCOPY                                               
* R2 - 16-BYTE AREA WHERE COMMERCIAL CODES WILL BE PLACED                       
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
GETCMMLS NTR1  BASE=*,LABEL=*                                                   
         USING COMSUBS,RA                                                       
*                                                                               
         MVI   GETCMPIG,C'N'       PIGGYBACK INDICATOR                          
         LHI   R4,L'EZSPCOPY       NUMBER OF CHARACTERS TO READ                 
*                                                                               
GETCM05  DS    0H                                                               
         LHI   R0,0                NUMBER OF CHARACTERS COPIED                  
         LR    R3,R2               DESTINATION POINTER                          
*                                                                               
GETCM10  DS    0H                                                               
         CLI   0(R1),C' '          SPACE?                                       
         BNH   GETCM80             YES, CHECK WHETHER TO TERMINATE              
*                                                                               
GETCM20  DS    0H                                                               
         MVC   0(1,R3),0(R1)       COPY                                         
         LA    R3,1(R3)            ADVANCE DESTINATION POINTER                  
         AHI   R0,1                INCREMENT BYTE COUNTER                       
*                                                                               
GETCM80  DS    0H                                                               
         LA    R1,1(R1)            ADVANCE SOURCE POINTER                       
         BCT   R4,GETCM90          CHARACTERS LEFT TO READ                      
*                                                                               
* ALL CHARACTERS HAVE BEEN READ AT THIS POINT                                   
*                                                                               
         CLI   GETCMPIG,C'Y'       ARE WE ON SECOND FILMCODE?                   
         BNE   GETCMLX             NO, SIMPLY EXIT                              
         XC    0(8,R2),0(R2)       YES = CLEAR SECOND COMMERCIAL                
         B     GETCMLX                                                          
*                                                                               
GETCM90  DS    0H                                                               
         CHI   R0,8                HAVE WE COPIED 8 CHARS ALREADY?              
         BL    GETCM10             NO, CONTINUE LOOPING                         
*                                                                               
* IF 9TH CHARACTER IS NOT A SPACE, IT IS ASSUMED THAT THERE IS                  
* ONLY ONE COMMERCIAL CODE                                                      
         CLI   0(R1),C' '          SPACE?                                       
         BNH   GETCM100            YES - LOOK FOR ANOTHER FILMCODE              
*                                                                               
* NONSPACE HERE - CLEAR SECOND COMMERCIAL AND GET OUT                           
*                                                                               
         CLI   GETCMPIG,C'Y'       ARE WE ON 2ND FILMCODE ALREADY?              
         BE    *+8                 YES - DO NOT ADVANCE R2                      
         LA    R2,8(R2)                                                         
         XC    0(8,R2),0(R2)       CLEAR 2ND COMMERCIAL SLOT                    
         B     GETCMLX             END OFCOPYING                                
*                                                                               
GETCM100 DS    0H                  COMMERCIAL CODE COPIED                       
         CLI   GETCMPIG,C'Y'       NAVE WE DONE PIGGYBACK ALREADY?              
         BE    GETCMLX             YES - GET OUT                                
         MVI   GETCMPIG,C'Y'       SET PIGGYBACK INDICATOR                      
         LA    R2,8(R2)            NEXT COMMERCIAL CODE SLOT                    
*                                                                               
* ADVANCE PAST SPACES TO ANOTHER COMMERCIAL                                     
         CLI   0(R1),C' '                                                       
         BH    GETCM05             NON-SPACE = START OF COMMERCIAL              
         LA    R1,1(R1)            SKIP THE SPACE                               
         BCT   R4,*-12                                                          
         B     GETCMLX             SCANNED ALL OF EZSPCOPY - EXIT               
*                                                                               
GETCMLX  DS    0H                                                               
         J     EQXIT                                                            
*                                                                               
GETCMPIG DS    X                                                                
         LTORG                                                                  
*                                                                               
*                                                                               
ISALPHA  CLI   0(R1),C'A'                                                       
         JL    ISNEQX                                                           
         CLI   0(R1),C'Z'                                                       
         JH    ISNEQX                                                           
         J     ISEQX                                                            
*                                                                               
ISNUM    CLI   0(R1),C'0'                                                       
         JL    ISNEQX                                                           
         CLI   0(R1),C'9'                                                       
         JH    ISNEQX                                                           
*                                                                               
ISEQX    CR    RB,RB                                                            
         BR    RE                                                               
ISNEQX   LTR   RB,RB                                                            
         BR    RE                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *                 
* BYTE EXPECTED TO HAVE THE NEW MOS (X'BA' = OCT 2011)                          
* ON EXIT HALF WILL HAVE THE OLD FORMAT MOS (X'1110')                           
* DUB IS USED FOR CONVERSION                                                    
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *                 
NEW2OLD  NTR1  BASE=*,LABEL=*                                                   
         ZIC   RF,BYTE                                                          
         NILL  GRF,X'000F'         ZERO OUT YEAR, RF, GRAND REGISTER            
         CVD   RF,DUB                                                           
         SR    RF,RF                                                            
         ICM   RF,3,DUB+6                                                       
         SRL   RF,4                                                             
         STC   RF,HALF+1                                                        
*                                                                               
         ZIC   RF,BYTE                                                          
         SRL   RF,4                GET RID OF THE MONTH                         
         CVD   RF,DUB                                                           
         SR    RF,RF                                                            
         ICM   RF,3,DUB+6                                                       
         SRL   RF,4                                                             
         STC   RF,HALF                                                          
*                                                                               
         J     EQXIT                                                            
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
FIXORD   NTR1  BASE=*,LABEL=*                                                   
         MVC   WORK,SPACES                                                      
         LHI   R0,L'EZIHRORD                                                    
         LA    R1,EZIHRORD                                                      
         LA    R2,WORK                                                          
*                                                                               
FIXORD10 DS    0H                                                               
         CHI   R0,L'EZIHRORD-1                                                  
         BL    *+12                                                             
         BRAS  RE,ISALPHA                                                       
         BE    *+14                                                             
         MVC   0(1,R2),0(R1)                                                    
         LA    R2,1(R2)                                                         
*                                                                               
         LA    R1,1(R1)                                                         
         BCT   R0,FIXORD10                                                      
*                                                                               
         MVC   EZIHRORD,WORK                                                    
*                                                                               
         J     EQXIT                                                            
         LTORG                                                                  
*                                                                               
*                                                                               
*                                                                               
***********************************************************************         
*                                                                     *         
*        WORKAREAS                                                    *         
*                                                                     *         
***********************************************************************         
*                                                                               
EZADSD   DSECT                                                                  
SVORD    DS    CL10                                                             
SNVELEM  DS    XL256               ELEMENT WORKAREA                             
SNVCMELM DS    XL(SNVCMLNQ+1)      COMMERCIAL ELM WORKAREA                      
ERR      DS    XL1                                                              
FILMCODS DS    CL16                                                             
TRAFNUM  DS    XL4                                                              
         DS    0D                                                               
EZWORK   DS    CL256                                                            
*                                                                               
*        MINIO ROUTINES WORKAREAS                                               
*                                                                               
MNPRMS   DS    6A                  PARAMETER BLOCK                              
*                                                                               
CKSTASRC DS    C                                                                
CKSTATYP DS    C                TYPE OF EZPOST INVOICE. X'00' = REGULAR         
*                                                                               
EZADSDL  EQU   *-EZADSD                                                         
*                                                                               
*                                                                               
*                                                                               
LSTATBD  DSECT                     LOCAL STATION CALL LETTERS                   
LSTASTA  DS    CL4                                                              
LSTAFLG  DS    XL1                                                              
LSTASKIP EQU   X'80'               SKIP THIS STATION                            
LSTAUID  DS    XL2                 USER ID                                      
*                                                                               
* TEMP DEBUG, TILL EXTENDED PRODUCT DSECT GOES LIVE                             
       ++INCLUDE SPGENSNV                                                       
       ++INCLUDE SPSNVFEQTB        FIELD EQUATE TABLE                           
       ++INCLUDE DDMINBLK                                                       
*                                                                               
       ++INCLUDE EZBLOCK                                                        
*                                                                               
WRKIOD   DSECT                                                                  
       ++INCLUDE DDWRKIOD                                                       
*                                                                               
* MID FLIGHT CLEARANCE INVOICES ARE USED ONLY AS AN EARLY AFFIDAVID             
* FOR SPOTS SHOWN SO THE AGENCY CAN RUN AN I2 INVOICE MATCHING REPORT           
*                                                                               
       ++INCLUDE DDACTIVD                                                       
       ++INCLUDE SPGENCLT                                                       
       ++INCLUDE REGENCON                                                       
       ++INCLUDE SPREPWORKD                                                     
       ++INCLUDE SPGENEZ                                                        
       ++INCLUDE DMWRKFD                                                        
       ++INCLUDE DMWRKFK                                                        
       ++INCLUDE DDCOMFACSD                                                     
       ++INCLUDE CTGENFILE                                                      
*                                                                               
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'015EZADDSNVR 10/20/15'                                      
         END                                                                    
