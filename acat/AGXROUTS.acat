*          DATA SET AGXROUTS   AT LEVEL 038 AS OF 08/24/20                      
*CATALP AGXROUTS                                                                
                                                                                
         TITLE 'Extract routines for AGXTRACT'                                  
                                                                                
***********************************************************************         
* Who  Lvl Date    Change(s)                                 Audit              
* ---- --- ------- ----------------------------------------- ----------         
* YNGX 035 10AUG20 Set timeoff load time used by Bulk SQLs   DSRD-25739         
* MPEN 034 20MAY20 Add new order fields                      DSRD-25739         
* NSHE 034 05May20 Add client summary processing             DSRD-26144         
* YNGX 033 12Mar20 New Timeoff for Load/Update purposes      DSRD-23410         
* YNGX 032 13Jan20 NEW MOA AND TRANSACTION MODULE FIELS      DSRD-25135         
* VGUP 032 10JAN20 Call CATCALL only for expense acc         DSRD-25132         
* NSHE 031 09Dec19 Fix to previous level expense acc changes DSRD-24760         
* NSHE 030 06Nov19 Extend extract to include expense trans   DSRD-23387         
* MPEN 029 06Aug19 New company userid on Agency Dim          DSRD-23461         
* YNGX 028 28May19 New field No of Invoices in Order dim     DSRD-22573         
* TKLU 027 08Feb19 New data fields for high level accounts   DSRD-21185         
* TKLU 026 23Jan19 AGXROUTS.CHKEIM adjustments               DSRD-21047         
* TKLU 025 26Nov18 SETSJO coding for TRNFOFF if update mode  DSRD-20807         
* YNGX 024 31Oct18 Pass 1R Person code in facts              DSRD-20566         
* TKLU             SETACTV ',0' fix (for EXPFUTS e.g.)       DSRD-20440         
* TKLU 023 16Oct18 US transaction SCITSJXP change            DSRD-20460         
* TKLU 022 01Oct18 US transaction reference adjustment       DSRD-20140         
*                  PREVODB fix                               DSRD-20268         
*                  ERDIMUL=0 is 0 or 1 - another attempt     DSRD-20268         
*                  to fix using CHKEIM code                                     
*                  INIWCA - handle duplicate OAM work codes  DSRD-20268         
*                  AGXORDDQ/AGXORDSQ =Order fix              SPEC-12211         
*                  SAVEEUR calculate agency item amount via  DSRD-20352         
*                  Eureka as ERDIMUL*ERDIAPR leads to penny                     
*                  differences, same for ERDIRAF                                
* TKLU 021 14Sep18 Some US data fixes                        DSRD-20140         
*                  Estimates zero item multiplier fix (see   DSRD-20125         
*                  also DSRD-20185)                                             
*                  Estimates ESTFIST fix                     DSRD-20165         
* TKLU 020 04Sep18 Extra date validation + US merge +        DSRD-20010         
*                  New System data field                     DSRD-19961         
* TKLU 019 17Aug18 Dummy US w/c 99 entry on load             DSRD-19969         
*                  EXPRX01T type field bug fix               DSRD-19970         
*                  Estimate ERDWHRS w/c level hours fix      DSRD-19983         
* TKLU 018 15Aug18 Set ESTFEXI with estimate number          DSRD-19937         
* TKLU 017 14Aug18 Adjust CUT if LOAD mode + US MNAS bug fix DSRD-19926         
*                  and changed SETACTV globally              DSRD-19938         
* TKLU 016 30Jul18 New CUT dimension for update purposes     DSRD-19766         
* TKLU 015 10May18 SCMEL/ARTEL sub sequence logic change     DSRD-18977         
*                  and some rework in OFLKAHD routine                           
*                  ARTMULT dec pl changes due to web fix     DSRD-18931         
*                  SAVOAMP/DPL logic removed)                                   
* TKLU 014 23Apr18 Currency order add up to avoid 'pennies'  DSRD-18850         
*                  Assume ARTMULT of zero is 1 really (*n    DSRD-18850         
*                  for decimal places)                       DSRD-18850         
*                  Skip zero timesheet rows (TIMEL clusters) DSRD-18836         
*                  Include Expense POs without cli/pro/job   DSRD-13993         
*                  Expense order OAMEL (no wc)/SCMEL (wc)/   DSRD-18850         
*                  ARTEL(no wc) inconsistency/fix                               
* TKLU 013 05Apr18 AGFORDC EUREKA call adjustments (again)   DSRD-18788         
* TKLU 012 29Mar18 Estimates and order time manipulation     DSRD-18638         
*                  JOBDAPST fix                              DSRD-18604         
* TKLU 011 26Mar18 AGXCLIC: label typo for FFTELQ            DSRD-18510         
*                  SJ office from current level only         DSRD-18534         
*                  XNMELD XNMSUBL fix                        DSRD-18534         
*                  AGFTIM17 fixed bad jump around TIMFESID   DSRD-18575         
*                  EXPRRWNR source adjustment                DSRD-18578         
*                  Expenses line manager/fin approver rework DSRD-18578         
*                  Order approvers via TEMPSTOR (rework)     DSRD-18601         
*                  Job creator/approver fix + add look up    DSRD-18604         
*                  EMDSCA for none approved estimate         DSRD-18602         
*                  JOBDMJCC master job fix                   DSRD-18639         
*                  Order printed description enhancement     DSRD-18638         
* TKLU 010 08Mar18 GETMAP call parameter fix                 DSRD-18430         
* TKLU 009 28Feb18 Estimate item data retrieval bug fix      DSRD-18342         
* TKLU 008 21Feb18 =BILL transaction billing fix             DSRD-18117         
* /YNGX            ESTFAMT on 1R time entries fix            DSRD-18127         
*                  TIMFIST setting on item entries           DSRD-18144         
*                                                           /DSRD-18277         
*                  EUREKA fix if deriving ORDFAMT            DSRD-18156         
*                  Various expenses issues                   DSRD-18165         
*                  Timesheet skip empty day entries          DSRD-18190         
*                  Timesheet day entry fixes                 DSRD-18181         
*                  Timesheet cost/sale and status fixes      DSRD-18181         
*                  Order status fix                          DSRD-18302         
*                  Skip CIDMSID = 'Item Deleted' clusters    DSRD-18304         
*                  Order amount on currency orders fix       DSRD-18240         
* TKLU 007 26Jan18 Transaction billing enhancements          DSRD-18079         
* TKLU 006 11Jan18 Added EXPRRWNR and EXPRX01N length fix    DSRD-17946         
* TKLU 005 09Jan18 GETOPT IO improvements                    DSRD-17593         
* TKLU 004 08Jan18 UFSELD JOBDU* bug fix                     DSRD-17881         
* TKLU 003 05Jan18 Add TYPE=TRN and TYPE=EXP                 DSRD-17376         
* TKLU 002 13Dec17 Enlarge estimate facts 1R to incl. u/l    ITMF-21419         
* TKLU 001 27Oct17 Initial Version for BulkAPI Extract       DSRD-13993         
*                                                                               
***********************************************************************         
* Parameters                                                          *         
* ----------                                                          *         
* AL4 A(Extract record)                                               *         
* AL4 A(AccFile record)                                               *         
* AL4 0(AccFile to extract)                                           *         
* AL4 A(SXDTABD)                                                      *         
* AL4 A(LEVELS)                                                       *         
*                                                                     *         
***********************************************************************         
                                                                                
         PRINT NOGEN                                                            
                                                                                
AGXROUTS CSECT                                                                  
         ENTRY AGXCPYC                                                          
         ENTRY AGXCLIC                                                          
         ENTRY AGXPROC                                                          
         ENTRY AGXJOBC                                                          
         ENTRY AGXETYC                                                          
         ENTRY AGXWCOC                                                          
         ENTRY AGXCATC                                                          
         ENTRY AGXACCC                                                          
         ENTRY AGXPERC                                                          
         ENTRY AGXTRNC                                                          
         ENTRY AGFTRNC                                                          
         ENTRY AGFXTRC                                                          
         ENTRY AGXORDC                                                          
         ENTRY AGFORDC                                                          
         ENTRY AGXESTC                                                          
         ENTRY AGFESTC                                                          
         ENTRY AGXEXPC                                                          
         ENTRY AGFEXPC                                                          
         ENTRY AGXTIMC                                                          
         ENTRY AGFTIMC                                                          
         ENTRY AGXITMC                                                          
         ENTRY AGXCURC                                                          
         ENTRY AGXCUTC                                                          
         ENTRY AGXETXC                                                          
         ENTRY AGXOTXC                                                          
         ENTRY AG2ESTC                                                          
         ENTRY AG2ORDC                                                          
         ENTRY AGXBILC                                                          
         ENTRY AGRTIMC                                                          
         ENTRY AGREXPC                                                          
         ENTRY AGXOFFC                                                          
         ENTRY AGFTOFC                                                          
                                                                                
***********************************************************************         
* AGXCPYC - Extract company dimension data                            *         
***********************************************************************         
                                                                                
AGXCPYC  NMOD1 WORKX-WORKD,*AGXCPY*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXCPYLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING CPYRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,CPYDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXCPYDQ                                                
                                                                                
*obs(agy MVC   CPYDAGY(2),SAVCALP  Set values                                   
*obs| ID)MVI   CPYDAGY+2,UNDSCQ                                                 
*        MVC   CPYDAGY+2+1(2),EUROPE  (*&&UK*&&)                                
*&&UK*&& MVC   CPYDCONT,EUROPE     EU                                           
*        MVC   CPYDAGY+2+1(2),NORTHAM (*&&US*&&)                                
*&&US*&& MVC   CPYDCONT,NORTHAM    NA                                           
*No '_'! MVI   CPYDUNDS,UNDSCQ     Connect _ to                                 
         MVC   CPYDALPH,SAVCALP    Agy Alpha ID                                 
*02AUG17/JPAT  CPYDCONT(+UNDSCQnow) before ALPH in AGXCNVX also|                
*Global? MVC   CPYDGID,SAVCALP     Agency ID - now CPYDCOAL CL5                 
*                                                                               
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   CPYDUTS,WORK                                                     
                                                                                
         LA    RE,CTRYTAB                                                       
                                                                                
AGXCPY02 CLC   SAVCLOC,0(RE)                                                    
         JE    AGXCPY04                                                         
         CLI   0(RE),FFQ                                                        
         JE    *+2                                                              
         AHI   RE,L'CTRYTAB                                                     
         J     AGXCPY02                                                         
                                                                                
AGXCPY04 MVC   CPYDLOCL,1(RE)    Locale language eg. 'En/GB'                    
                                                                                
         MVC   WORK(3),=CL3'SE='                                                
         MVC   WORK+4(1),DXSENUM                                                
         GOTO1 =V(DMDDNAME),DMCB,(X'24',=C'DDNAME'),WORK,0                      
         CLI   8(R1),0                                                          
         JNE   *+2                                                              
         L     RF,8(R1)            Get A(File Info list)                        
         MVC   CPYDSYST,2(RF)                                                   
                                                                                
         LA    R2,CPYRFST                                                       
                                                                                
         USING NAMELD,R2                                                        
AGXCPY06 CLI   NAMEL,0                                                          
         JE    AGXCPY30                                                         
         CLI   NAMEL,CPYELQ                                                     
         JE    AGXCPY14                                                         
         CLI   NAMEL,NAMELQ                                                     
         JE    AGXCPY10                                                         
         CLI   NAMEL,ADRELQ                                                     
         JE    AGXCPY16                                                         
                                                                                
AGXCPY08 LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     AGXCPY06                                                         
                                                                                
AGXCPY10 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXCPY08                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'CPYDNAM-1                                                   
         JNH   AGXCPY12                                                         
         LHI   RF,L'CPYDNAM-1                                                   
                                                                                
AGXCPY12 MVC   CPYDNAM(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXCPY08                                                         
                                                                                
         USING CPYELD,R2                                                        
AGXCPY14 OC    CPYUID,CPYUID       Extract company userid                       
         JZ    AGXCPY08                                                         
         GOTO1 =V(GETUID),DMCB,CPYUID,CPYDUID                                   
         J     AGXCPY08                                                         
                                                                                
         USING ADRELD,R2                                                        
AGXCPY16 CLI   ADRLN,ADRLN1Q                                                    
         JL    AGXCPY08                                                         
         MVC   CPYDADL1,ADRADD1                                                 
         CLI   ADRLN,ADRLN2Q                                                    
         JL    AGXCPY08                                                         
         MVC   CPYDADL2,ADRADD2                                                 
         CLI   ADRLN,ADRLN3Q                                                    
         JL    AGXCPY08                                                         
         MVC   CPYDADL3,ADRADD3                                                 
         CLI   ADRLN,ADRLN4Q                                                    
         JL    AGXCPY08                                                         
         MVC   CPYDADL4,ADRADD4                                                 
         J     AGXCPY08                                                         
                                                                                
AGXCPY30 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXCPYLT DC    A(LITERAL)                                                       
                                                                                
CTRYTAB  DC    0XL6                                                             
         DC    AL1(CTRYGBR),CL5'En/GB'                                          
         DC    AL1(CTRYUSA),CL5'En/US'                                          
         DC    AL1(CTRYGER),CL5'De/De'                                          
         DC    AL1(CTRYCAN),CL5'En/CA'                                          
         DC    AL1(CTRYIRE),CL5'En/EI'                                          
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXCLIC - Extract client dimension data                             *         
***********************************************************************         
                                                                                
AGXCLIC  NMOD1 WORKX-WORKD,*AGXCLI*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXCLILT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ACTRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,CLIDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXCLIDQ                                                
                                                                                
*&&UK*&& MVC   CLIDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   CLIDAGY(2),NORTHAM                                               
         MVI   CLIDAGY+2,UNDSCQ                                                 
         MVC   CLIDAGY+2+1(2),SAVCALP                                           
*        MVC   CLIDAID,ACTKACT                                                  
         MVC   CLIDCOD,ACTKACT                                                  
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   CLIDUTS,WORK                                                     
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'CLIDCRL,CLIDCRL)                     
                                                                                
         USING NAMELD,R2                                                        
         LA    R2,ACTRFST                                                       
         XC    FULL,FULL                                                        
                                                                                
AGXCLI02 CLI   NAMEL,0                                                          
         JE    AGXCLI80                                                         
         CLI   NAMEL,NAMELQ                                                     
         JE    AGXCLI06                                                         
         CLI   NAMEL,ADRELQ                                                     
         JE    AGXCLI10                                                         
         CLI   NAMEL,PPRELQ                                                     
         JE    AGXCLI12                                                         
         CLI   NAMEL,RSTELQ                                                     
         JE    AGXCLI16                                                         
         CLI   NAMEL,FFTELQ                                                     
         JE    AGXCLI40                                                         
         CLI   NAMEL,XNMELQ                                                     
         JE    AGXCLI50                                                         
         CLI   NAMEL,SCIELQ                                                     
         JE    AGXCLI60                                                         
                                                                                
AGXCLI04 LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     AGXCLI02                                                         
                                                                                
AGXCLI06 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXCLI04                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'CLIDNAM-1                                                   
         JNH   AGXCLI08                                                         
         LHI   RF,L'CLIDNAM-1                                                   
                                                                                
AGXCLI08 MVC   CLIDNAM(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXCLI04                                                         
                                                                                
         USING ADRELD,R2                                                        
AGXCLI10 CLI   ADRLN,ADRLN1Q                                                    
         JL    AGXCLI04                                                         
         MVC   CLIDAD1,ADRADD1                                                  
         CLI   ADRLN,ADRLN2Q                                                    
         JL    AGXCLI04                                                         
         MVC   CLIDAD2,ADRADD2                                                  
         CLI   ADRLN,ADRLN3Q                                                    
         JL    AGXCLI04                                                         
         MVC   CLIDAD3,ADRADD3                                                  
         CLI   ADRLN,ADRLN4Q                                                    
         JL    AGXCLI04                                                         
         MVC   CLIDAD4,ADRADD4                                                  
         CLI   ADRLN,ADRLN5Q                                                    
         JL    AGXCLI04                                                         
         MVC   CLIDAD5,ADRADD5                                                  
         J     AGXCLI04                                                         
                                                                                
         USING PPRELD,R2                                                        
AGXCLI12 MVC   CLIDOFF,PPRGAOFF                                                 
         OC    CLIDOFF,GSPACES                                                  
         MVC   CLIDPOB,PPRBILLP                                                 
         MVC   CLIDDEB,PPRRECVU                                                 
         MVC   CLIDCOS,PPRCOSTU                                                 
         CLI   PPRLN,PPRLN1Q                                                    
         JNH   AGXCLI04                                                         
         LLC   RE,PPRLN                                                         
         SHI   RE,PPRLN1Q+1                                                     
         CHI   RE,L'CLIDOTH-1                                                   
         JNH   AGXCLI14                                                         
         LHI   RE,L'CLIDOTH-1                                                   
                                                                                
AGXCLI14 MVC   CLIDOTH(0),PPRNARRP                                              
         EX    RE,*-6                                                           
         J     AGXCLI04                                                         
                                                                                
         USING RSTELD,R2                                                        
AGXCLI16 MVI   CLIDISL,FALSEQ                                                   
         MVI   CLIDISC,FALSEQ                                                   
         CLI   RSTLN,RSTFILT1-RSTELD                                            
         JL    AGXCLI18                                                         
         MVC   CLIDFL1,RSTFILT1                                                 
                                                                                
AGXCLI18 CLI   RSTLN,RSTFILT2-RSTELD                                            
         JL    AGXCLI20                                                         
         MVC   CLIDFL2,RSTFILT2                                                 
                                                                                
AGXCLI20 CLI   RSTLN,RSTFILT3-RSTELD                                            
         JL    AGXCLI22                                                         
         MVC   CLIDFL3,RSTFILT3                                                 
                                                                                
AGXCLI22 CLI   RSTLN,RSTFILT4-RSTELD                                            
         JL    AGXCLI24                                                         
         MVC   CLIDFL4,RSTFILT4                                                 
                                                                                
AGXCLI24 CLI   RSTLN,RSTFILT5-RSTELD                                            
         JL    AGXCLI26                                                         
         MVC   CLIDFL5,RSTFILT5                                                 
                                                                                
AGXCLI26 CLI   RSTLN,RSTSTAT-RSTELD                                             
         JL    AGXCLI04                                                         
         TM    RSTSTAT,RSTSACIL                                                 
         JZ    AGXCLI28                                                         
         MVI   CLIDISL,TRUEQ                                                    
                                                                                
AGXCLI28 TM    RSTSTAT,RSTSACIC                                                 
         JZ    AGXCLI04                                                         
         MVI   CLIDISC,TRUEQ                                                    
         J     AGXCLI04                                                         
                                                                                
         USING FFTELD,R2                                                        
AGXCLI40 CLI   FFTLN,FFTLN1Q+1                                                  
         JNH   AGXCLI04                                                         
         CLI   FFTTYPE,FFTTPCOM                                                 
         JNE   AGXCLI41                                                         
         LA    RE,CLIDCOM1                                                      
         LHI   RF,L'CLIDCOM1-1                                                  
         CLI   FFTSEQ,0                                                         
         JE    AGXCLI42                                                         
         LA    RE,CLIDCOM2                                                      
         LHI   RF,L'CLIDCOM2-1                                                  
         CLI   FFTSEQ,1                                                         
         JE    AGXCLI42                                                         
         LA    RE,CLIDCOM3                                                      
         LHI   RF,L'CLIDCOM3-1                                                  
         CLI   FFTSEQ,2                                                         
         JE    AGXCLI42                                                         
         J     AGXCLI04                                                         
                                                                                
AGXCLI41 LA    RE,CLIDMCO                                                       
         LHI   RF,L'CLIDMCO-1                                                   
         CLI   FFTTYPE,FFTTPCON                                                 
         JE    AGXCLI42                                                         
         LA    RE,CLIDTEL                                                       
         LHI   RF,L'CLIDTEL-1                                                   
         CLI   FFTTYPE,FFTTPTEL                                                 
         JE    AGXCLI42                                                         
         LA    RE,CLIDFAX                                                       
         LHI   RF,L'CLIDFAX-1                                                   
         CLI   FFTTYPE,FFTTPFAX                                                 
         JE    AGXCLI42                                                         
         LA    RE,CLIDEMA                                                       
         LHI   RF,L'CLIDEMA-1                                                   
*&&UK*&& CLI   FFTTYPE,FFTTPEML                                                 
*&&US*&& CLI   FFTTYPE,FFTTEML                                                  
         JE    AGXCLI42                                                         
*&&UK                                                                           
         LA    RE,CLIDVRG                                                       
         LHI   RF,L'CLIDVRG-1                                                   
         CLI   FFTTYPE,FFTTAXLO                                                 
         JE    AGXCLI42                                                         
*&&                                                                             
         LA    RE,CLIDVRN                                                       
         LHI   RF,L'CLIDVRN-1                                                   
         CLI   FFTTYPE,FFTTAXNO                                                 
         JE    AGXCLI42                                                         
*&&UK*&& CLI   FFTTYPE,FFTTCRLM                                                 
         JNE   AGXCLI04                                                         
         MVC   CLIDCRL,GSPACES                                                  
         LA    RE,CLIDCRL          value is from SR so won't populate           
         LHI   RF,L'CLIDCRL-1           (No sign change required here)          
                                                                                
AGXCLI42 LLC   R1,FFTDLEN                                                       
         SHI   R1,1                                                             
         CR    R1,R1                                                            
         JM    AGXCLI04                                                         
         CR    R1,RF                                                            
         JNH   AGXCLI44                                                         
         LR    R1,RF                                                            
                                                                                
AGXCLI44 MVC   0(0,RE),FFTDATA                                                  
         EX    R1,*-6                                                           
         J     AGXCLI04                                                         
                                                                                
         USING XNMELD,R2                                                        
AGXCLI50 CLI   XNMLN,XNMLN1Q+1                                                  
         JL    AGXCLI04                                                         
         LLC   R1,XNMSUBL                                                       
         SHI   R1,1                                                             
         CHI   R1,L'CLIDALT-1                                                   
         JNH   AGXCLI52                                                         
         LHI   R1,L'CLIDALT-1                                                   
                                                                                
AGXCLI52 MVC   CLIDALT(0),XNMSUBN                                               
         EX    R1,*-6                                                           
         J     AGXCLI04                                                         
                                                                                
         USING SCIELD,R2                                                        
AGXCLI60 CLI   SCITYPE,SCITCLIM                                                 
         JNE   AGXCLI04                                                         
         STCM  R2,B'1111',FULL                                                  
         J     AGXCLI04                                                         
         DROP  R2                                                               
                                                                                
         USING SCIELD,R2                                                        
AGXCLI80 ICM   R2,B'1111',FULL                                                  
         JZ    AGXCLI82                 T01D126 CL13 Credit limit               
         MVC   CLIDCRL,GSPACES          (No sign change required here)          
                                                                                
*        EDITR (P6,SCIAMNT),(L'CLIDCRL,CLIDCRL),0,ZERO=NOBLANK,        +        
               MINUS=YES,ALIGN=LEFT                                             
                                                                                
         ZAP   EDDUB,SCIAMNT       Normal cur                                   
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'CLIDCRL,CLIDCRL)                     
                                                                                
AGXCLI82 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXCLILT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXPROC - Extract product dimension data                            *         
***********************************************************************         
                                                                                
AGXPROC  NMOD1 WORKX-WORKD,*AGXPRO*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXPROLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ACTRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,PRODLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXPRODQ                                                
                                                                                
*&&UK*&& MVC   PRODAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   PRODAGY(2),NORTHAM                                               
         MVI   PRODAGY+2,UNDSCQ                                                 
         MVC   PRODAGY+2+1(2),SAVCALP                                           
*        MVC   PRODAID,ACTKACT                                                  
                                                                                
         GOTO1 =V(SPLITSJ),ACTKACT                                              
         MVC   PRODCLI,WORK+30+0                                                
         MVC   PRODCOD,WORK+30+8                                                
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   PRODUTS,WORK                                                     
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'PRODCRL,PRODCRL)                     
                                                                                
         USING NAMELD,R2                                                        
         LA    R2,ACTRFST                                                       
         XC    FULL,FULL                                                        
                                                                                
AGXPRO02 CLI   NAMEL,0                                                          
         JE    AGXPRO80                                                         
         CLI   NAMEL,NAMELQ                                                     
         JE    AGXPRO06                                                         
         CLI   NAMEL,ADRELQ                                                     
         JE    AGXPRO10                                                         
         CLI   NAMEL,PPRELQ                                                     
         JE    AGXPRO12                                                         
         CLI   NAMEL,RSTELQ                                                     
         JE    AGXPRO16                                                         
         CLI   NAMEL,FFTELQ                                                     
         JE    AGXPRO40                                                         
         CLI   NAMEL,XNMELQ                                                     
         JE    AGXPRO50                                                         
         CLI   NAMEL,SCIELQ                                                     
         JE    AGXPRO60                                                         
                                                                                
AGXPRO04 LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     AGXPRO02                                                         
                                                                                
AGXPRO06 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXPRO04                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'PRODNAM-1                                                   
         JNH   AGXPRO08                                                         
         LHI   RF,L'PRODNAM-1                                                   
                                                                                
AGXPRO08 MVC   PRODNAM(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXPRO04                                                         
                                                                                
         USING ADRELD,R2                                                        
AGXPRO10 CLI   ADRLN,ADRLN1Q                                                    
         JL    AGXPRO04                                                         
         MVC   PRODAD1,ADRADD1                                                  
         CLI   ADRLN,ADRLN2Q                                                    
         JL    AGXPRO04                                                         
         MVC   PRODAD2,ADRADD2                                                  
         CLI   ADRLN,ADRLN3Q                                                    
         JL    AGXPRO04                                                         
         MVC   PRODAD3,ADRADD3                                                  
         CLI   ADRLN,ADRLN4Q                                                    
         JL    AGXPRO04                                                         
         MVC   PRODAD4,ADRADD4                                                  
         CLI   ADRLN,ADRLN5Q                                                    
         JL    AGXPRO04                                                         
         MVC   PRODAD5,ADRADD5                                                  
         J     AGXPRO04                                                         
                                                                                
         USING PPRELD,R2                                                        
AGXPRO12 MVC   PRODOFF,PPRGAOFF                                                 
         OC    PRODOFF,GSPACES                                                  
         MVC   PRODPOB,PPRBILLP                                                 
         MVC   PRODDEB,PPRRECVU                                                 
         MVC   PRODCOS,PPRCOSTU                                                 
         CLI   PPRLN,PPRLN1Q                                                    
         JNH   AGXPRO04                                                         
         LLC   RE,PPRLN                                                         
         SHI   RE,PPRLN1Q+1                                                     
         CHI   RE,L'PRODOTH-1                                                   
         JNH   AGXPRO14                                                         
         LHI   RE,L'PRODOTH-1                                                   
                                                                                
AGXPRO14 MVC   PRODOTH(0),PPRNARRP                                              
         EX    RE,*-6                                                           
         J     AGXPRO04                                                         
                                                                                
         USING RSTELD,R2                                                        
AGXPRO16 MVI   PRODISL,FALSEQ                                                   
         MVI   PRODISC,FALSEQ                                                   
         CLI   RSTLN,RSTFILT1-RSTELD                                            
         JL    AGXPRO18                                                         
         MVC   PRODFL1,RSTFILT1                                                 
                                                                                
AGXPRO18 CLI   RSTLN,RSTFILT2-RSTELD                                            
         JL    AGXPRO20                                                         
         MVC   PRODFL2,RSTFILT2                                                 
                                                                                
AGXPRO20 CLI   RSTLN,RSTFILT3-RSTELD                                            
         JL    AGXPRO22                                                         
         MVC   PRODFL3,RSTFILT3                                                 
                                                                                
AGXPRO22 CLI   RSTLN,RSTFILT4-RSTELD                                            
         JL    AGXPRO24                                                         
         MVC   PRODFL4,RSTFILT4                                                 
                                                                                
AGXPRO24 CLI   RSTLN,RSTFILT5-RSTELD                                            
         JL    AGXPRO26                                                         
         MVC   PRODFL5,RSTFILT5                                                 
                                                                                
AGXPRO26 CLI   RSTLN,RSTSTAT-RSTELD                                             
         JL    AGXPRO04                                                         
         TM    RSTSTAT,RSTSACIL                                                 
         JZ    AGXPRO28                                                         
         MVI   PRODISL,TRUEQ                                                    
                                                                                
AGXPRO28 TM    RSTSTAT,RSTSACIC                                                 
         JZ    AGXPRO04                                                         
         MVI   PRODISC,TRUEQ                                                    
         J     AGXPRO04                                                         
                                                                                
         USING FFTELD,R2                                                        
AGXPRO40 CLI   FFTLN,FFTLN1Q+1                                                  
         JNH   AGXPRO04                                                         
         CLI   FFTTYPE,FFTTPCOM                                                 
         JNE   AGXPRO41                                                         
         LA    RE,PRODCOM1                                                      
         LHI   RF,L'PRODCOM1-1                                                  
         CLI   FFTSEQ,0                                                         
         JE    AGXPRO42                                                         
         LA    RE,PRODCOM2                                                      
         LHI   RF,L'PRODCOM2-1                                                  
         CLI   FFTSEQ,1                                                         
         JE    AGXPRO42                                                         
         LA    RE,PRODCOM3                                                      
         LHI   RF,L'PRODCOM3-1                                                  
         CLI   FFTSEQ,2                                                         
         JE    AGXPRO42                                                         
         J     AGXPRO04                                                         
                                                                                
AGXPRO41 LA    RE,PRODMCO                                                       
         LHI   RF,L'PRODMCO-1                                                   
         CLI   FFTTYPE,FFTTPCON                                                 
         JE    AGXPRO42                                                         
         LA    RE,PRODTEL                                                       
         LHI   RF,L'PRODTEL-1                                                   
         CLI   FFTTYPE,FFTTPTEL                                                 
         JE    AGXPRO42                                                         
         LA    RE,PRODFAX                                                       
         LHI   RF,L'PRODFAX-1                                                   
         CLI   FFTTYPE,FFTTPFAX                                                 
         JE    AGXPRO42                                                         
         LA    RE,PRODEMA                                                       
         LHI   RF,L'PRODEMA-1                                                   
*&&UK*&& CLI   FFTTYPE,FFTTPEML                                                 
*&&US*&& CLI   FFTTYPE,FFTTEML                                                  
         JE    AGXPRO42                                                         
*&&UK                                                                           
         LA    RE,PRODVRG                                                       
         LHI   RF,L'PRODVRG-1                                                   
         CLI   FFTTYPE,FFTTAXLO                                                 
         JE    AGXPRO42                                                         
*&&                                                                             
         LA    RE,PRODVRN                                                       
         LHI   RF,L'PRODVRN-1                                                   
         CLI   FFTTYPE,FFTTAXNO                                                 
         JE    AGXPRO42                                                         
*&&UK*&& CLI   FFTTYPE,FFTTCRLM                                                 
         JNE   AGXPRO04                                                         
         MVC   PRODCRL,GSPACES                                                  
         LA    RE,PRODCRL          value is from SR so won't populate           
         LHI   RF,L'PRODCRL-1           (No sign change required here)          
                                                                                
AGXPRO42 LLC   R1,FFTDLEN                                                       
         SHI   R1,1                                                             
         CR    R1,R1                                                            
         JM    AGXPRO04                                                         
         CR    R1,RF                                                            
         JNH   AGXPRO44                                                         
         LR    R1,RF                                                            
                                                                                
AGXPRO44 MVC   0(0,RE),FFTDATA                                                  
         EX    R1,*-6                                                           
         J     AGXPRO04                                                         
                                                                                
         USING XNMELD,R2                                                        
AGXPRO50 CLI   XNMLN,XNMLN1Q+1                                                  
         JL    AGXPRO04                                                         
         LLC   R1,XNMSUBL                                                       
         SHI   R1,1                                                             
         CHI   R1,L'PRODALT-1                                                   
         JNH   AGXPRO52                                                         
         LHI   R1,L'PRODALT-1                                                   
                                                                                
AGXPRO52 MVC   PRODALT(0),XNMSUBN                                               
         EX    R1,*-6                                                           
         J     AGXPRO04                                                         
                                                                                
         USING SCIELD,R2                                                        
AGXPRO60 CLI   SCITYPE,SCITCLIM                                                 
         JNE   AGXPRO04                                                         
         STCM  R2,B'1111',FULL                                                  
         J     AGXPRO04                                                         
         DROP  R2                                                               
                                                                                
         USING SCIELD,R2                                                        
AGXPRO80 ICM   R2,B'1111',FULL                                                  
         JZ    AGXPRO82                                                         
         MVC   PRODCRL,GSPACES          (No sign change required here)          
                                                                                
*        EDITR (P6,SCIAMNT),(L'PRODCRL,PRODCRL),0,ZERO=NOBLANK,        *        
               MINUS=YES,ALIGN=LEFT                                             
                                                                                
         ZAP   EDDUB,SCIAMNT       Normal cur                                   
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'PRODCRL,PRODCRL)                     
                                                                                
AGXPRO82 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXPROLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXJOBC - Extract job dimension data                                *         
***********************************************************************         
                                                                                
AGXJOBC  NMOD1 WORKX-WORKD,*AGXJOB*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXJOBLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ACTRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,JOBDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXJOBDQ                                                
                                                                                
*&&UK*&& MVC   JOBDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   JOBDAGY(2),NORTHAM                                               
         MVI   JOBDAGY+2,UNDSCQ                                                 
         MVC   JOBDAGY+2+1(2),SAVCALP                                           
*        MVC   JOBDAID,ACTKACT                                                  
                                                                                
         GOTO1 =V(SETACTV),0                                                    
         MVC   JOBDUTS,WORK                                                     
                                                                                
         GOTO1 =V(SPLITSJ),ACTKACT                                              
         MVC   JOBDCLI,WORK+30+0                                                
         MVC   JOBDPRO,WORK+30+8                                                
         MVC   JOBDCOD,WORK+30+16                                               
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'JOBDBUDA,JOBDBUDA)                   
                                                                                
         USING NAMELD,R2                                                        
         LA    R2,ACTRFST                                                       
         XC    TEMPSTOR,TEMPSTOR                                                
         LA    R5,JOBDUN01                                                      
         MVI   BYTE,0                                                           
                                                                                
AGXJOB02 CLI   NAMEL,0                                                          
         JE    AGXJOB80                                                         
         CLI   NAMEL,NAMELQ                                                     
         JE    AGXJOB06                                                         
         CLI   NAMEL,ADRELQ                                                     
         JE    AGXJOB10                                                         
         CLI   NAMEL,PPRELQ                                                     
         JE    AGXJOB12                                                         
         CLI   NAMEL,RSTELQ                                                     
         JE    AGXJOB16                                                         
         CLI   NAMEL,SCMELQ                                                     
         JE    AGXJOB40                                                         
         CLI   NAMEL,JOBELQ                                                     
         JE    AGXJOB30                                                         
         CLI   NAMEL,XNMELQ                                                     
         JE    AGXJOB50                                                         
         CLI   NAMEL,SCIELQ                                                     
         JE    AGXJOB60                                                         
         CLI   NAMEL,RACELQ                                                     
         JE    AGXJOB62                                                         
         CLI   NAMEL,SPAELQ                                                     
         JE    AGXJOB66                                                         
         CLI   NAMEL,UFSELQ                                                     
         JE    AGXJOB70                                                         
                                                                                
AGXJOB04 LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     AGXJOB02                                                         
                                                                                
AGXJOB06 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXJOB04                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'JOBDNAM-1                                                   
         JNH   AGXJOB08                                                         
         LHI   RF,L'JOBDNAM-1                                                   
                                                                                
AGXJOB08 MVC   JOBDNAM(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXJOB04                                                         
                                                                                
         USING ADRELD,R2                                                        
AGXJOB10 CLI   ADRLN,ADRLN1Q                                                    
         JL    AGXJOB04                                                         
         MVC   JOBDAD1,ADRADD1                                                  
         CLI   ADRLN,ADRLN2Q                                                    
         JL    AGXJOB04                                                         
         MVC   JOBDAD2,ADRADD2                                                  
         CLI   ADRLN,ADRLN3Q                                                    
         JL    AGXJOB04                                                         
         MVC   JOBDAD3,ADRADD3                                                  
         CLI   ADRLN,ADRLN4Q                                                    
         JL    AGXJOB04                                                         
         MVC   JOBDAD4,ADRADD4                                                  
         CLI   ADRLN,ADRLN5Q                                                    
         JL    AGXJOB04                                                         
         MVC   JOBDAD5,ADRADD5                                                  
         J     AGXJOB04                                                         
                                                                                
         USING PPRELD,R2                                                        
AGXJOB12 MVC   JOBDOFF,PPRGAOFF                                                 
         OC    JOBDOFF,GSPACES                                                  
         MVC   JOBDPOB,PPRBILLP                                                 
         CLI   PPRLN,PPRLN1Q                                                    
         JNH   AGXJOB04                                                         
         LLC   RE,PPRLN                                                         
         SHI   RE,PPRLN1Q+1                                                     
         CHI   RE,L'JOBDOTH-1                                                   
         JNH   AGXJOB14                                                         
         LHI   RE,L'JOBDOTH-1                                                   
                                                                                
AGXJOB14 MVC   JOBDOTH(0),PPRNARRP                                              
         EX    RE,*-6                                                           
         J     AGXJOB04                                                         
                                                                                
         USING RSTELD,R2                                                        
AGXJOB16 MVI   JOBDISL,FALSEQ                                                   
         MVI   JOBDISC,FALSEQ                                                   
                                                                                
         CLI   RSTLN,RSTFILT1-RSTELD                                            
         JL    AGXJOB18                                                         
         MVC   JOBDFL1,RSTFILT1                                                 
                                                                                
AGXJOB18 CLI   RSTLN,RSTFILT2-RSTELD                                            
         JL    AGXJOB20                                                         
         MVC   JOBDFL2,RSTFILT2                                                 
                                                                                
AGXJOB20 CLI   RSTLN,RSTFILT3-RSTELD                                            
         JL    AGXJOB22                                                         
         MVC   JOBDFL3,RSTFILT3                                                 
                                                                                
AGXJOB22 CLI   RSTLN,RSTFILT4-RSTELD                                            
         JL    AGXJOB24                                                         
         MVC   JOBDFL4,RSTFILT4                                                 
                                                                                
AGXJOB24 CLI   RSTLN,RSTFILT5-RSTELD                                            
         JL    AGXJOB26                                                         
         MVC   JOBDFL5,RSTFILT5                                                 
                                                                                
AGXJOB26 CLI   RSTLN,RSTSTAT-RSTELD                                             
         JL    AGXJOB04                                                         
         TM    RSTSTAT,RSTSACIL                                                 
         JZ    AGXJOB28                                                         
         MVI   JOBDISL,TRUEQ                                                    
                                                                                
AGXJOB28 TM    RSTSTAT,RSTSACIC                                                 
         JZ    AGXJOB04                                                         
         MVI   JOBDISC,TRUEQ                                                    
         J     AGXJOB04                                                         
                                                                                
         USING JOBELD,R2                                                        
AGXJOB30 GOTO1 =V(SET1DAT),JOBCDATE                                             
         MVC   JOBDCLDT,WORK                                                    
         MVI   JOBDISMS,FALSEQ                                                  
                                                                                
         CLI   JOBLN,JOBLN2Q                                                    
         JL    AGXJOB04                                                         
         GOTO1 =V(SET1DAT),JOBODATE                                             
         MVC   JOBDOPDT,WORK                                                    
                                                                                
AGXJOB32 CLI   JOBLN,JOBLN3Q                                                    
         JL    AGXJOB04                                                         
         TM    JOBSTA2,JOBSMST                                                  
         JZ    AGXJOB34                                                         
         MVI   JOBDISMS,TRUEQ                                                   
                                                                                
AGXJOB34 MVI   JOBDAPST,JAPAPPQ                                                 
         TM    ACTRSTAT,ACTSDRFT                                                
         JNZ   AGXJOB36                                                         
         MVI   JOBDAPST,JAPREJQ                                                 
         TM    JOBSTA2,JOBSREJ                                                  
         JNZ   AGXJOB36                                                         
         MVI   JOBDAPST,JAPDRAQ                                                 
                                                                                
AGXJOB36 DS    0H                                                               
         J     AGXJOB04                                                         
                                                                                
         USING SCMELD,R2                                                        
AGXJOB40 DS    0H                  ACBRA28 based                                
*&&UK                                                                           
         CLI   SCMLN,SCMNARR-SCMELD                                             
         JNH   AGXJOB04                                                         
         LLC   R1,SCMLN                                                         
         SHI   R1,SCMNARR-SCMELD+1                                              
         CHI   R1,L'JOBDCOM1-1                                                  
         JL    AGXJOB42                                                         
         LHI   R1,L'JOBDCOM1-1                                                  
                                                                                
AGXJOB42 CLI   BYTE,2                                                           
         JH    AGXJOB04                                                         
                                                                                
         LLC   RE,BYTE                                                          
         AHI   RE,1                                                             
         STC   RE,BYTE                                                          
         SHI   RE,1                                                             
         MHI   RE,L'JOBDCOM1                                                    
         LA    RE,JOBDCOM1(RE)                                                  
                                                                                
         MVC   0(0,RE),SCMNARR                                                  
         EX    R1,*-6                                                           
*&&                                                                             
*&&US                                                                           
         CLI   SCMLN,SCMNARR-SCMELD                                             
         JNH   AGXJOB04                                                         
                                                                                
         CLI   BYTE,2                                                           
         JH    AGXJOB04                                                         
                                                                                
         LR    R0,R4               Do we need to protect against                
         LLC   R4,BYTE             L'JOBDCOMn overflow?                         
         AHI   R4,1                                                             
         STC   R4,BYTE                                                          
         SHI   R4,1                                                             
         MHI   R4,L'JOBDCOM                                                     
         LA    R4,JOBDCOM1(R4)                                                  
                                                                                
         LLC   RF,SCMLN            Get length                                   
         SHI   RF,SCMLN1Q                                                       
         LA    RE,SCMCODE                                                       
                                                                                
         TM    SCMTYPE,SCMTPRBI    Print on Bills comment                       
         JZ    AGXJOB44            no, regular comment                          
         MVC   0(4,R4),=C'BIL='                                                 
         AHI   R4,4                                                             
         LHI   RF,L'SCMCODE                                                     
                                                                                
AGXJOB42 CLI   0(RE),C' '          parse thru right justified comment           
         JH    AGXJOB44                                                         
         AHI   RE,1                                                             
         SHI   R1,1                                                             
         J     AGXJOB42                                                         
                                                                                
AGXJOB44 SHI   RF,1                FOR EXECUTED MOVE                            
         BASR  R1,0                                                             
         MVC   0(0,R4),0(RE)                                                    
         EX    RF,0(R1)                                                         
                                                                                
         LR    R4,R0                                                            
*&&                                                                             
         J     AGXJOB04                                                         
                                                                                
         USING XNMELD,R2                                                        
AGXJOB50 CLI   XNMLN,XNMLN1Q+1                                                  
         JL    AGXJOB04                                                         
         LLC   R1,XNMLN                                                         
         SHI   R1,XNMLN1Q+1                                                     
         CHI   R1,L'JOBDALT-1                                                   
         JNH   AGXJOB52                                                         
         LHI   R1,L'JOBDALT-1                                                   
                                                                                
AGXJOB52 MVC   JOBDALT(0),XNMSUBN                                               
         EX    R1,*-6                                                           
         J     AGXJOB04                                                         
                                                                                
         USING SCIELD,R2                                                        
AGXJOB60 CLI   SCITYPE,SCITFEEB                                                 
         JNE   AGXJOB04            T03D132 CL12 Job Bugdet                      
                                                                                
*        EDITR (P6,SCIAMNT),(L'JOBDBUDA,JOBDBUDA),0,ZERO=NOBLANK,      *        
               ALIGN=LEFT,MINUS=YES                                             
                                                                                
         ZAP   EDDUB,SCIAMNT       Normal cur                                   
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'JOBDBUDA,JOBDBUDA)                   
         J     AGXJOB04                                                         
                                                                                
         USING RACELD,R2                                                        
AGXJOB62 LA    RE,TEMPSTOR+0                                                    
         CLI   RACTYPE,RACTAPP                                                  
         JE    AGXJOB64                                                         
         LA    RE,TEMPSTOR+2                                                    
         CLI   RACTYPE,RACTADD                                                  
         JNE   AGXJOB04                                                         
                                                                                
AGXJOB64 MVC   0(2,RE),RACPERS                                                  
         J     AGXJOB04                                                         
                                                                                
         USING SPAELD,R2                                                        
AGXJOB66 CLI   SPATYPE,SPATMJOB    master job element                           
         JNE   AGXJOB04                                                         
         GOTO1 =V(SPLITSJ),SPAAACT                                              
         MVC   JOBDMJCC,WORK+30+0                                               
         MVC   JOBDMJPC,WORK+30+8                                               
         MVC   JOBDMJJC,WORK+30+16                                              
         LLC   R1,SAVCSJA                                                       
         AHI   R1,2-1                                                           
         MVC   PL16,GSPACES                                                     
         MVC   PL16(0),SPAAULA                                                  
         EX    R1,*-6                                                           
         GOTO1 =V(GETACN),PL16                                                  
         MVC   JOBDMJCN,WORK                                                    
         LLC   R1,SAVCSJB                                                       
         AHI   R1,2-1                                                           
         MVC   PL16,GSPACES                                                     
         MVC   PL16(0),SPAAULA                                                  
         EX    R1,*-6                                                           
         GOTO1 =V(GETACN),PL16                                                  
         MVC   JOBDMJPN,WORK                                                    
         LLC   R1,SAVCSJC                                                       
         MVC   PL16,GSPACES                                                     
         MVC   PL16(0),SPAAULA                                                  
         EX    R1,*-6                                                           
         GOTO1 =V(GETACN),PL16                                                  
         MVC   JOBDMJJN,WORK                                                    
         J     AGXJOB04                                                         
                                                                                
         USING UFSELD,R2                                                        
AGXJOB70 LA    R1,JOBDUN10         prevent overrun (if > 10)                    
         CR    R5,R1                                                            
         JH    AGXJOB04                                                         
         MVC   0(L'JOBDUN01,R5),UFSDESC                                         
         MVC   JOBDUE01-JOBDUN01(L'JOBDUE01,R5),UFSEDIT                         
         CLI   UFSEDIT,C'N'        Numbers                                      
         JE    AGXJOB72                                                         
         CLI   UFSEDIT,C'C'        Characters                                   
         JE    AGXJOB72                                                         
         CLI   UFSEDIT,C'D'        Date                                         
         JE    AGXJOB72                                                         
         CLI   UFSEDIT,C' '        Other                                        
         JH    AGXJOB72                                                         
         MVC   JOBDUE01-JOBDUN01(L'JOBDUE01,R5),GSPACES                         
                                                                                
AGXJOB72 LLC   R1,UFSLN                                                         
         SHI   R1,UFSLN1Q+1                                                     
         CHI   R1,0                                                             
         JL    AGXJOB76                                                         
         CHI   R1,L'JOBDUD01                                                    
         JNH   AGXJOB74                                                         
         LHI   R1,L'JOBDUD01                                                    
                                                                                
AGXJOB74 MVC   JOBDUD01-JOBDUN01(0,R5),UFSDATA                                  
         EX    R1,*-6                                                           
                                                                                
AGXJOB76 AHI   R5,JOBDUN02-JOBDUN01                                             
         J     AGXJOB04                                                         
                                                                                
AGXJOB80 TM    ACTRSTAT,ACTSDRFT   if draft need to look up                     
         JNZ   AGXJOB82                                                         
         OC    TEMPSTOR+0(2),TEMPSTOR                                           
         JZ    AGXJOB82            same if not found                            
         LA    R1,TEMPSTOR+0                                                    
         GOTO1 =V(GETSPD)                                                       
         MVC   JOBDAPCD,WORK+100                                                
         MVC   JOBDAPFN,WORK+00                                                 
         MVC   JOBDAPMN,WORK+32                                                 
         MVC   JOBDAPLN,WORK+16                                                 
         J     AGXJOB84                                                         
                                                                                
AGXJOB82 GOTO1 =V(GETSJO),ACTKEY   get office for job into HALF                 
                                                                                
         GOTO1 =V(GETJAP),ACTKACT  get default approver                         
         JNE   AGXJOB84                                                         
                                                                                
         GOTO1 =V(GETSPD),HALF                                                  
         MVC   JOBDAPCD,WORK+100                                                
         MVC   JOBDAPFN,WORK+00                                                 
         MVC   JOBDAPMN,WORK+32                                                 
         MVC   JOBDAPLN,WORK+16                                                 
                                                                                
AGXJOB84 OC    TEMPSTOR+2(2),TEMPSTOR+2                                         
         JZ    AGXJOB86            job creator                                  
         LA    R1,TEMPSTOR+2                                                    
         GOTO1 =V(GETSPD)                                                       
         MVC   JOBDCRCD,WORK+100                                                
         MVC   JOBDCRFN,WORK+00                                                 
         MVC   JOBDCRMN,WORK+32                                                 
         MVC   JOBDCRLN,WORK+16                                                 
                                                                                
AGXJOB86 DS    0H                                                               
                                                                                
AGXJOB90 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXJOBLT DC    A(LITERAL)                                                       
JAPAPPQ  EQU   C'1'                                                             
JAPDRAQ  EQU   C'2'                                                             
JAPREJQ  EQU   C'3'                                                             
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXETYC - Extract expenditure type dimension data                   *         
***********************************************************************         
                                                                                
AGXETYC  NMOD1 WORKX-WORKD,*AGXETY*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXETYLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ETYRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ETYDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXETYDQ                                                
                                                                                
*&&UK*&& MVC   ETYDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ETYDAGY(2),NORTHAM                                               
         MVI   ETYDAGY+2,UNDSCQ                                                 
         MVC   ETYDAGY+2+1(2),SAVCALP                                           
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   ETYDUTS,WORK                                                     
                                                                                
AGXETY02 MVC   ETYDCOD,ETYKCODE                                                 
         MVC   ETYDOFF,ETYKOFFC                                                 
                                                                                
         MVI   ETYDISL,FALSEQ                                                   
         TM    ETYRSTAT,ETYSLOCK                                                
         JZ    AGXETY04                                                         
         MVI   ETYDISL,TRUEQ                                                    
                                                                                
         USING NAMELD,R2                                                        
AGXETY04 LA    R2,ETYRFST                                                       
                                                                                
AGXETY06 CLI   NAMEL,0                                                          
         JE    AGXETY20                                                         
         CLI   NAMEL,NAMELQ                                                     
         JE    AGXETY10                                                         
         CLI   NAMEL,XNMELQ                                                     
         JE    AGXETY14                                                         
                                                                                
AGXETY08 LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     AGXETY06                                                         
                                                                                
AGXETY10 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXETY08                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'ETYDNAM-1                                                   
         JNH   AGXETY12                                                         
         LHI   RF,L'ETYDNAM-1                                                   
                                                                                
AGXETY12 MVC   ETYDNAM(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXETY08                                                         
                                                                                
         USING XNMELD,R2                                                        
AGXETY14 CLI   XNMLN,XNMLN1Q                                                    
         JNH   AGXETY08                                                         
         LLC   RF,XNMSUBL                                                       
         SHI   RF,1                                                             
         CHI   RF,L'ETYDCAT-1                                                   
         JNH   AGXETY16                                                         
         LHI   RF,L'ETYDCAT-1                                                   
                                                                                
AGXETY16 MVC   ETYDCAT(0),XNMSUBN                                               
         EX    RF,*-6                                                           
         J     AGXETY08                                                         
                                                                                
AGXETY20 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXETYLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXWCOC - Extract work code dimension data                          *         
***********************************************************************         
                                                                                
AGXWCOC  NMOD1 WORKX-WORKD,*AGXWCO*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXWCOLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING WCORECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,WCODLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXWCODQ                                                
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   WCODUTS,WORK                                                     
                                                                                
*&&UK*&& MVC   WCODAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   WCODAGY(2),NORTHAM                                               
         MVI   WCODAGY+2,UNDSCQ                                                 
         MVC   WCODAGY+2+1(2),SAVCALP                                           
                                                                                
*        MVC   WCODEID,WCOKWRK                                                  
                                                                                
*&&US                                                                           
         TM    PROCMOD3,PROCW99Q   Massage for dummy w/c 99                     
         JZ    AGXWCO02                                                         
                                                                                
         MVC   WCODCOD,BILWC                                                    
         MVC   WCODNAM,GSPACES                                                  
         MVC   WCODNAM(7),WC99                                                  
         MVC   WCODNAM,GSPACES                                                  
         MVC   WCODDSC(7),WC99                                                  
         MVI   WCODECH,FALSEQ                                                   
         MVI   WCODLFO,FALSEQ                                                   
         MVI   WCODLFE,FALSEQ                                                   
         MVI   WCODLFP,FALSEQ                                                   
         MVI   WCODLFB,FALSEQ                                                   
         MVI   WCODTYP,C'C'                                                     
         J     AGXWCO40                                                         
*&&                                                                             
                                                                                
AGXWCO02 MVC   WCODCOD,WCOKWRK                                                  
                                                                                
         USING NAMELD,R2                                                        
AGXWCO04 LA    R2,WCORFST                                                       
                                                                                
AGXWCO06 CLI   NAMEL,0                                                          
         JE    AGXWCO40                                                         
         CLI   NAMEL,NAMELQ                                                     
         JE    AGXWCO10                                                         
         CLI   NAMEL,WCOELQ                                                     
         JE    AGXWCO20                                                         
                                                                                
AGXWCO08 LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     AGXWCO06                                                         
                                                                                
AGXWCO10 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXWCO08                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'WCODNAM-1                                                   
         JNH   AGXWCO12                                                         
         LHI   RF,L'WCODNAM-1                                                   
                                                                                
AGXWCO12 MVC   WCODNAM(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXWCO08                                                         
                                                                                
         USING WCOELD,R2                                                        
AGXWCO20 MVC   WCODDSC,WCODESC                                                  
         MVI   WCODECH,FALSEQ                                                   
*&&UK                                                                           
         CLI   WCOLN,WCOSTAT3-WCOELD                                            
         JL    AGXWCO22                                                         
         TM    WCOSTAT3,WCOSESCK                                                
         JZ    AGXWCO22                                                         
         MVI   WCODECH,TRUEQ                                                    
*&&                                                                             
                                                                                
AGXWCO22 MVI   WCODLFO,FALSEQ                                                   
         MVI   WCODLFE,FALSEQ                                                   
         MVI   WCODLFP,FALSEQ                                                   
         MVI   WCODLFB,FALSEQ                                                   
         CLI   WCOLN,WCOSTAT2-WCOELD                                            
         JL    AGXWCO30                                                         
         TM    WCOSTAT2,WCOSLORD                                                
         JZ    AGXWCO24                                                         
         MVI   WCODLFO,TRUEQ                                                    
                                                                                
AGXWCO24 TM    WCOSTAT2,WCOSLEST                                                
         JZ    AGXWCO26                                                         
         MVI   WCODLFE,TRUEQ                                                    
                                                                                
AGXWCO26 TM    WCOSTAT2,WCOSLPST                                                
         JZ    AGXWCO28                                                         
         MVI   WCODLFP,TRUEQ                                                    
                                                                                
AGXWCO28 DS    0H                                                               
*&&UK                                                                           
         TM    WCOSTAT2,WCOSLBIL                                                
         JZ    AGXWCO30                                                         
         MVI   WCODLFB,TRUEQ                                                    
*&&                                                                             
                                                                                
AGXWCO30 MVI   WCODTYP,C'C'        Cost or Time?                                
         TM    WCOSTAT,WCOSHCOE                                                 
         JZ    AGXWCO08                                                         
         MVI   WCODTYP,C'T'                                                     
         J     AGXWCO08                                                         
                                                                                
AGXWCO40 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXWCOLT DC    A(LITERAL)                                                       
WC99     DC    CL7'Billing'                                                     
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXOFFC - Extract office dimension data                             *         
***********************************************************************         
                                                                                
AGXOFFC  NMOD1 WORKX-WORKD,*AGXOFF*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXOFFLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING OFFRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,OFFDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXOFFDQ                                                
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   OFFDUTS,WORK                                                     
                                                                                
*&&UK*&& MVC   OFFDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   OFFDAGY(2),NORTHAM                                               
         MVI   OFFDAGY+2,UNDSCQ                                                 
         MVC   OFFDAGY+2+1(2),SAVCALP                                           
                                                                                
         LA    RE,OFFKOFF                                                       
         CLI   SAVC2CO,YESQ                                                     
         JE    AGXOFF00                                                         
         LA    RE,OFFKEY+OGRKOFC-OGRRECD                                        
                                                                                
AGXOFF00 MVC   OFFDOFF,0(RE)                                                    
                                                                                
         USING NAMELD,R2                                                        
         LA    R2,OFFRFST                                                       
                                                                                
AGXOFF02 CLI   NAMEL,0                                                          
         JE    AGXOFF20                                                         
         CLI   NAMEL,NAMELQ                                                     
         JE    AGXOFF06                                                         
                                                                                
AGXOFF04 LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     AGXOFF02                                                         
                                                                                
AGXOFF06 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXOFF04                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'OFFDNAM-1                                                   
         JNH   AGXOFF08                                                         
         LHI   RF,L'OFFDNAM-1                                                   
                                                                                
AGXOFF08 MVC   OFFDNAM(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXOFF04                                                         
                                                                                
AGXOFF20 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXOFFLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXITMC - Extract item dimension data                               *         
***********************************************************************         
                                                                                
AGXITMC  NMOD1 WORKX-WORKD,*AGXITM*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXITMLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ARTRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ITMDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXITMDQ                                                
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   ITMDUTS,WORK                                                     
                                                                                
*&&UK*&& MVC   ITMDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ITMDAGY(2),NORTHAM                                               
         MVI   ITMDAGY+2,UNDSCQ                                                 
         MVC   ITMDAGY+2+1(2),SAVCALP                                           
         MVC   ITMDCOD,ARTKART                                                  
                                                                                
         MVI   ITMDIPF,FALSEQ       Is item price flexible?                     
         TM    ARTRSTAT,ARTKFLXQ                                                
         JZ    AGXITM02                                                         
         MVI   ITMDIPF,TRUEQ        Is item price flexible?                     
                                                                                
AGXITM02 MVI   ITMDISL,FALSEQ       Is item locked?                             
         TM    ARTRSTAT,ARTKLOCK                                                
         JZ    AGXITM04                                                         
         MVI   ITMDISL,TRUEQ        Is item locked?                             
                                                                                
         USING AFDELD,R2                                                        
AGXITM04 LA    R2,ARTRFST                                                       
                                                                                
AGXITM06 CLI   AFDEL,0                                                          
         JE    AGXITM50                                                         
         CLI   AFDEL,AFDELQ                                                     
         JE    AGXITM10                                                         
         CLI   AFDEL,NAMELQ                                                     
         JE    AGXITM20                                                         
         CLI   AFDEL,SCMELQ                                                     
         JE    AGXITM30                                                         
                                                                                
AGXITM08 LLC   R1,AFDLN                                                         
         AR    R2,R1                                                            
         J     AGXITM06                                                         
                                                                                
AGXITM10 XOUT  AFDSEQ,ITMDXID,3                                                 
         CLI   AFDLN,AFDLNXQ                                                    
         JL    AGXITM08                                                         
         MVC   ITMDUNT,AFDUNIT                                                  
         J     AGXITM08                                                         
                                                                                
         USING NAMELD,R2                                                        
AGXITM20 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXITM08                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'ITMDDES-1                                                   
         JNH   AGXITM22                                                         
         LHI   RF,L'ITMDDES-1                                                   
                                                                                
AGXITM22 MVC   ITMDDES(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXITM08                                                         
                                                                                
         USING SCMELD,R2                                                        
AGXITM30 TM    SCMSEQ,SCMSEQLQ                                                  
         JNZ   AGXITM08                                                         
         CLI   SCMLN,SCMNARR-SCMELD                                             
         JNH   AGXITM08                                                         
         LLC   R1,SCMLN                                                         
         SHI   R1,SCMNARR-SCMELD+1                                              
         CHI   R1,L'ITMDTXT-1                                                   
         JNH   AGXITM32                                                         
         LHI   R1,L'ITMDTXT-1                                                   
                                                                                
AGXITM32 MVC   ITMDTXT(0),SCMNARR                                               
         EX    R1,*-6                                                           
         J     AGXITM08                                                         
                                                                                
AGXITM50 DS    0H                                                               
                                                                                
AGXITMY  MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXITMLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXETXC - Extract text row dimension data for estimates             *         
***********************************************************************         
                                                                                
AGXETXC  NMOD1 WORKX-WORKD,*AGXETX*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXETXLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         L     R3,0(R1)                                                         
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ETXDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXETXDQ                                                
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   ETXDUTS,WORK                                                     
                                                                                
*&&UK*&& MVC   ETXDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ETXDAGY(2),NORTHAM                                               
         MVI   ETXDAGY+2,UNDSCQ                                                 
         MVC   ETXDAGY+2+1(2),SAVCALP                                           
                                                                                
         MVC   ETXDKEY,KEY4TXT     T22D102/T22D103/T22D104                      
         MVC   ETXDROW,ROW4TXT     and 'row' code                               
         MVC   ETXDSUB,SUB4TXT     and 'subrow' code                            
                                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'ETXDKEY,ETXDKEY)                            
                                                                                
         LLC   R2,LEN4TXT          get length and address of text               
         ICM   R4,B'1111',ADR4TXT                                               
         MVC   ETXDT01(0),0(R4)    T22D105,T22D106 (both CL250)                 
         EX    R2,*-6                                                           
                                                                                
         CLI   LEN4TX2,FFQ         Any 2nd text?                                
         JE    AGXETX2                                                          
         LLC   R2,LEN4TX2          get length and address of text 2             
         ICM   R4,B'1111',ADR4TX2                                               
         MVC   ETXDT02(0),0(R4)                                                 
         EX    R2,*-6                                                           
                                                                                
         CLI   LEN4TX3,FFQ         Any 3rd text?                                
         JE    AGXETX2                                                          
         LLC   R2,LEN4TX3          get length and address of text 3             
         ICM   R4,B'1111',ADR4TX3                                               
         MVC   ETXDT03(0),0(R4)                                                 
         EX    R2,*-6                                                           
                                                                                
         CLI   LEN4TX4,FFQ         Any 4th text?                                
         JE    AGXETX2                                                          
         LLC   R2,LEN4TX4          get length and address of text 4             
         ICM   R4,B'1111',ADR4TX4                                               
         MVC   ETXDT04(0),0(R4)                                                 
         EX    R2,*-6                                                           
                                                                                
AGXETX2  DS    0H                                                               
         MVI   LEN4TX2,FFQ         Set extra texts to naught                    
         MVI   LEN4TX3,FFQ                                                      
         MVI   LEN4TX4,FFQ                                                      
                                                                                
AGXETXY  DS    0H                  Pass previous indicator back                 
         MVC   DMCB+8(L'RETBYTE),RETBYTE                                        
         NI    PROCMODE,FFQ-PROCTDQ                                             
         J     EXIT                                                             
         DROP  R3                                                               
                                                                                
AGXETXLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXOTXC - Extract text row dimension data for orders                *         
***********************************************************************         
                                                                                
AGXOTXC  NMOD1 WORKX-WORKD,*AGXOTX*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXOTXLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         L     R3,0(R1)                                                         
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,OTXDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXOTXDQ                                                
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   OTXDUTS,WORK                                                     
                                                                                
*&&UK*&& MVC   OTXDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   OTXDAGY(2),NORTHAM                                               
         MVI   OTXDAGY+2,UNDSCQ                                                 
         MVC   OTXDAGY+2+1(2),SAVCALP                                           
                                                                                
         MVC   OTXDKEY,KEY4TXT                                                  
         MVC   OTXDROW,ROW4TXT     and 'row' code                               
         MVC   OTXDSUB,SUB4TXT     and 'subrow' code                            
                                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'OTXDKEY,OTXDKEY)                            
                                                                                
         LLC   R2,LEN4TXT          get length and address of text               
         ICM   R4,B'1111',ADR4TXT                                               
         MVC   OTXDT01(0),0(R4)                                                 
         EX    R2,*-6                                                           
                                                                                
         CLI   LEN4TX2,FFQ         Any 2nd text?                                
         JE    AGXOTX2                                                          
         LLC   R2,LEN4TX2          get length and address of text 2             
         ICM   R4,B'1111',ADR4TX2                                               
         MVC   OTXDT02(0),0(R4)                                                 
         EX    R2,*-6                                                           
                                                                                
         CLI   LEN4TX3,FFQ         Any 3rd text?                                
         JE    AGXOTX2                                                          
         LLC   R2,LEN4TX3          get length and address of text 3             
         ICM   R4,B'1111',ADR4TX3                                               
         MVC   OTXDT03(0),0(R4)                                                 
         EX    R2,*-6                                                           
                                                                                
         CLI   LEN4TX4,FFQ         Any 4th text?                                
         JE    AGXOTX2                                                          
         LLC   R2,LEN4TX4          get length and address of text 4             
         ICM   R4,B'1111',ADR4TX4                                               
         MVC   OTXDT04(0),0(R4)                                                 
         EX    R2,*-6                                                           
                                                                                
AGXOTX2  DS    0H                                                               
         MVI   LEN4TX2,FFQ         Set extra texts to naught                    
         MVI   LEN4TX3,FFQ                                                      
         MVI   LEN4TX4,FFQ                                                      
                                                                                
AGXOTXY  DS    0H                  Pass previous indicator back                 
         MVC   DMCB+8(L'RETBYTE),RETBYTE                                        
         NI    PROCMODE,FFQ-PROCTDQ                                             
         J     EXIT                                                             
         DROP  R3                                                               
                                                                                
AGXOTXLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXBILC - Extract bill number dimension data                        *         
***********************************************************************         
                                                                                
AGXBILC  NMOD1 WORKX-WORKD,*AGXBIL*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXBILLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING TRNRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,BILDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXBILDQ                                                
                                                                                
*&&UK*&& MVC   BILDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   BILDAGY(2),NORTHAM                                               
         MVI   BILDAGY+2,UNDSCQ                                                 
         MVC   BILDAGY+2+1(2),SAVCALP                                           
                                                                                
         USING PTAELD,R2                                                        
         ICM   R2,B'1111',SAV_TELE                                              
         MVC   BILDNUM,PTARBLNO                                                 
                                                                                
         GOTOR =V(SET2DAT),PTARBLDT                                             
         MVC   BILDDAT,WORK                                                     
*obs|    MVC   BILDCTI,GSPACES     ???                                          
         GOTO1 =V(SETACTV),0                                                    
         MVC   BILDUTS,WORK                                                     
                                                                                
         LLC   R1,SAV_TBNC                                                      
         SHI   R1,1                                                             
         STC   R1,SAV_TBNC                                                      
         CHI   R1,1                                                             
         JL    AGXBILN                                                          
                                                                                
AGXBIL02 LLC   R1,PTALN            Set A(next bill no. element)                 
         AR    R2,R1                                                            
         CLI   PTAEL,0                                                          
         JE    *+2                                                              
         CLI   PTAEL,PTAELQ                                                     
         JNE   AGXBIL02                                                         
                                                                                
         CLI   PTATYPE,PTATRAL     Bill number check - see AGFTRN22             
         JNE   AGXBIL02                                                         
         TM    PTASTAT1,PTASPEND                                                
         JNZ   AGXBIL02                                                         
         OC    PTADATE,PTADATE                                                  
         JZ    AGXBIL02                                                         
         CLC   PTARBLNO,GSPACES                                                 
         JNH   AGXBIL02                                                         
         OC    PTARBLDT,PTARBLDT                                                
         JZ    AGXBIL02                                                         
                                                                                
         STCM  R2,B'1111',SAV_TELE                                              
                                                                                
AGXBILY  OI    PROCMODE,PROCBNQ          indicate bill numbers to come          
         MVI   DMCB+8,RETBNMQ                                                   
         J     EXIT                                                             
                                                                                
AGXBILN  NI    PROCMODE,FFQ-PROCBNQ      indicate no more to come               
         MVI   DMCB+8,RETBNMQ                                                   
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXBILLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXCURC - Extract currency dimension data                           *         
***********************************************************************         
                                                                                
AGXCURC  NMOD1 WORKX-WORKD,*AGXCUR*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXCURLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING CURTABD,R4                                                       
         L     R3,0(R1)                                                         
         L     R4,SAVCURAD         A(currency table entry)                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,CURDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXCURDQ                                                
                                                                                
*        MVC   CURDAGY,GSPACES     Set data                                     
*        MVC   CURDCID,CURTCUR                                                  
         MVC   CURDCOD,CURTCUR                                                  
         MVC   CURDNAM,CURTLONG                                                 
         LLC   R1,CURTDECP                                                      
         AHI   R1,X'F0'                                                         
         STC   R1,CURDDPL                                                       
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   CURDUTS,WORK                                                     
                                                                                
AGXCURY  MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R3,R4                                                            
                                                                                
AGXCURLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXCUTC - Extract company update time dimension data                *         
***********************************************************************         
                                                                                
AGXCUTC  NMOD1 WORKX-WORKD,*AGXCUT*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXCUTLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         L     R3,0(R1)                                                         
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,CUTDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXCUTDQ                                                
                                                                                
*&&UK*&& MVC   CUTDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   CUTDAGY(2),NORTHAM                                               
         MVI   CUTDAGY+2,UNDSCQ                                                 
         MVC   CUTDAGY+2+1(2),SAVCALP                                           
                                                                                
         GOTOR =V(SETACTV),1       Use run date/time right now                  
         MVC   CUTDTIM,WORK        (change once we run multiple a day)          
                                                                                
AGXCUTX  DS    0H                  Pass previous indicator back                 
         MVC   DMCB+8(L'RETBYTE),RETBYTE                                        
         J     EXIT                                                             
         DROP  R3                                                               
                                                                                
AGXCUTLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGFTOFC - Extract Timeoff fact data                                 *         
* ETRY: SV_TOAID from LOADTOF                                         *         
***********************************************************************         
                                                                                
AGFTOFC  NMOD1 WORKX-WORKD,*AGFTOF*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXTOFLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         L     R3,0(R1)                                                         
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,TOFFLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXTOFFQ                                                
                                                                                
*&&UK*&& MVC   TOFFAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   TOFFAGY(2),NORTHAM                                               
         MVI   TOFFAGY+2,UNDSCQ                                                 
         MVC   TOFFAGY+2+1(2),SV_TOAID                                          
*                                                                               
         GOTOR =V(SETACTV),1       Get run date/time                            
         MVC   TOFFEDT,WORK                                                     
*                                                                               
         MVI   BYTE,0              US Mediaocean time offset as                 
         PACK  DUB,WORK+11(2)      Aura database uses EST                       
         MP    DUB,=P'10'                                                       
         ZAP   PKWORK2,DUB                                                      
         SP    PKWORK2,=P'60'      Subtract 6 hours                             
         CP    PKWORK2,PZERO       Check if it's less than zero hour            
         JNL   AGXTOF2                                                          
         AP    PKWORK2,=P'240'     Yes - add 24 hours                           
         MVI   BYTE,1                                                           
                                                                                
AGXTOF2  DS    0H                                                               
         MVC   FULL(1),PKWORK2                                                  
                                                                                
         L     R1,FULL                                                          
         SRL   R1,28                                                            
         STC   R1,TOFFEDT+11                                                    
         OI    TOFFEDT+11,X'F0'                                                 
         L     R1,FULL                                                          
         SRL   R1,24                                                            
         STC   R1,TOFFEDT+12                                                    
         OI    TOFFEDT+12,X'F0'                                                 
                                                                                
         CLI   BYTE,1                                                           
         JNE   AGXTOF6                                                          
         GOTO1 VDATCON,DMCB,(10,WORK),(0,DUBNET)                                
         GOTO1 VADDAY,DMCB,(C'D',DUBNET),DUBCOM,-1                              
         GOTO1 VDATCON,DMCB,(0,DUBCOM),(23,TOFFEDT)                             
                                                                                
AGXTOF6  CLI   DXMODE,DXLOADQ      For load no start time                       
         JE    AGXTOFX                                                          
         MVC   TOFFSDT,TOFFEDT                                                  
         GOTO1 VDATCON,DMCB,(10,TOFFEDT),(0,DUBNET)                             
         GOTO1 VADDAY,DMCB,(C'D',DUBNET),DUBCOM,-1                              
         GOTO1 VDATCON,DMCB,(0,DUBCOM),(23,TOFFSDT)                             
                                                                                
AGXTOFX  DS    0H                  Pass previous indicator back                 
         MVC   DMCB+8(L'RETBYTE),RETBYTE                                        
         J     EXIT                                                             
         DROP  R3                                                               
                                                                                
AGXTOFLT DC    A(LITERAL)                                                       
                                                                                
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXCATC - Extract category dimension data                           *         
***********************************************************************         
                                                                                
AGXCATC  NMOD1 WORKX-WORKD,*AGXCAT*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXCATLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING CATRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,CATDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXCATDQ                                                
                                                                                
*&&UK*&& MVC   CATDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   CATDAGY(2),NORTHAM                                               
         MVI   CATDAGY+2,UNDSCQ                                                 
         MVC   CATDAGY+2+1(2),SAVCALP                                           
*        MVC   CATDCID(L'CATKSCH),CATKSCH                                       
*        MVI   CATDCID+L'CATKSCH,UNDSCQ                                         
         MVC   CATDSCH,CATKSCH                                                  
         MVC   CATDCOD,GSPACES                                                  
*        MVC   CATDCID+L'CATKSCH+1(L'CATKCODE),GSPACES                          
         CLC   CATKCODE,CATFFS                                                  
         JE    AGXCAT00                                                         
         MVC   CATDCOD,CATKCODE                                                 
*        MVC   CATDCID+L'CATKSCH+1(L'CATKCODE),CATKCODE                         
                                                                                
         USING CADELD,R2                                                        
AGXCAT00 LA    R2,CATRFST                                                       
                                                                                
AGXCAT02 CLI   CADEL,0                                                          
         JE    AGXCAT20                                                         
         CLI   CADEL,CADELQ                                                     
         JE    AGXCAT06                                                         
                                                                                
AGXCAT04 LLC   R1,CADLN                                                         
         AR    R2,R1                                                            
         J     AGXCAT02                                                         
                                                                                
AGXCAT06 MVC   CATDCNA,CADNAME                                                  
*        CATDINS instruction ACBRA17.GETCAT5                                    
         CLI   CADLN,CADLN1Q                                                    
         JNH   AGXCAT04                                                         
         TM    CADSTAT,CADSFLAN                                                 
         JZ    AGXCAT12                                                         
         LA    R1,CADLINP                                                       
         CLI   CADTYPE,CADTFORM                                                 
         JNE   AGXCAT08                                                         
         LLC   RF,CADLINP          add lengths of input string and              
         AR    R1,RF               internal formula                             
         LLC   RF,0(R1)                                                         
         AR    R1,RF                                                            
                                                                                
AGXCAT08 LLC   RF,0(R1)            length of foreign name                       
         SHI   RF,2                subtract length byte and for EX              
***      LTR   RF,RF                                                            
***      JM    AGXCAT10                                                         
***      BASR  RE,0                                                             
***      MVC   SCHCFNA(0),1(R1)    FOREIGN NAME                                 
***      EX    RF,0(RE)                                                         
AGXCAT10 LLC   RF,0(R1)            add length of foreign name                   
         AR    R1,RF               (R1 from above)                              
         LLC   RF,0(R1)            length of foreign total name                 
         SHI   RF,2                subtract length byte and for EX              
***      LTR   RF,RF                                                            
***      JM    AGXCAT12                                                         
***      BASR  RE,0                                                             
***      MVC   SCHCFNT(0),1(R1)    FOREIGN TOTAL NAME                           
***      EX    RF,0(RE)                                                         
                                                                                
AGXCAT12 CLI   CADTYPE,CADTCTY     Intructions - for contingency or             
         JE    AGXCAT14            calculation or formula                       
*&&UK*&& CLI   CADTYPE,CADTCAL                                                  
*&&UK*&& JE    AGXCAT14                                                         
         CLI   CADTYPE,CADTFORM                                                 
         JNE   AGXCAT04                                                         
                                                                                
AGXCAT14 XR    RF,RF                                                            
         ICM   RF,1,CADLINP                                                     
         JZ    AGXCAT04                                                         
         SHI   RF,2                subtract length byte and for EX              
         LTR   RF,RF                                                            
         JM    AGXCAT04                                                         
         BASR  RE,0                                                             
         MVC   CATDINS(0),CADINP   INSTRUCTION                                  
         EX    RF,0(RE)                                                         
         CLI   CADTYPE,CADTCAL                                                  
         JNE   AGXCAT04                                                         
         LA    RF,CATDINS                                                       
         LA    RE,L'CATDINS-3                                                   
                                                                                
AGXCAT16 CLC   0(2,RF),CATMX       make MX into MAX                             
         JNE   AGXCAT18                                                         
         CLC   2(2,RF),GSPACES                                                  
         JH    AGXCAT18                                                         
         MVC   0(3,RF),CATMAX                                                   
                                                                                
AGXCAT18 AHI   RF,1                                                             
         JCT   RE,AGXCAT16                                                      
         J     AGXCAT04                                                         
                                                                                
         USING SCHRECD,R2                                                       
AGXCAT20 LA    R2,IOKEY                                                         
         XC    SCHKEY,SCHKEY                                                    
         MVI   SCHKTYP,SCHKTYPQ                                                 
         MVI   SCHKSUB,SCHKSUBQ                                                 
         MVC   SCHKCPY,CATKCPY                                                  
         MVC   SCHKUNT(L'PRODUL),PRODUL                                         
         MVC   SCHKCODE,CATKSCH                                                 
                                                                                
         L     R2,AIOGEN                                                        
         GOTO1 =V(READHI)                                                       
         JNE   *+2                                                              
         CLC   SCHKEY,IOKEYSAV                                                  
         JNE   AGXCAT30                                                         
                                                                                
         MVC   ACCADDR,SCHKDA                                                   
         GOTO1 =V(GETIT)                                                        
         JNE   AGXCAT30                                                         
                                                                                
         LA    R2,SCHRFST                                                       
         DROP  R2                                                               
                                                                                
         USING SCHELD,R2                                                        
AGXCAT22 CLI   SCHEL,0                                                          
         JE    AGXCAT30                                                         
         CLI   SCHEL,SCHELQ                                                     
         JE    AGXCAT26                                                         
                                                                                
AGXCAT24 LLC   R0,SCHLN                                                         
         AR    R2,R0                                                            
         J     AGXCAT22                                                         
                                                                                
AGXCAT26 MVC   CATDSNA,SCHNAME                                                  
         J     AGXCAT24                                                         
                                                                                
AGXCAT30 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXCATLT DC    A(LITERAL)                                                       
CATFFS   DC    X'FFFF'                                                          
CATMX    DC    C'MX'                                                            
CATMAX   DC    C'MAX'                                                           
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXPERC - Extract person dimension data                             *         
***********************************************************************         
                                                                                
AGXPERC  NMOD1 WORKX-WORKD,*AGXPER*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXPERLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING PERRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,PERDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXPERDQ                                                
                                                                                
*&&UK*&& MVC   PERDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   PERDAGY(2),NORTHAM                                               
         MVI   PERDAGY+2,UNDSCQ                                                 
         MVC   PERDAGY+2+1(2),SAVCALP                                           
         MVC   PERDCOD,PERKCODE                                                 
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   PERDUTS,WORK                                                     
                                                                                
         USING PIDELD,R2                                                        
         LA    R2,PERRFST                                                       
         XC    HALF,HALF                                                        
                                                                                
AGXPER02 CLI   PIDEL,PIDELQ                                                     
         JE    AGXPER06                                                         
         CLI   PIDEL,EMPELQ                                                     
         JE    AGXPER08                                                         
         CLI   PIDEL,0                                                          
         JE    AGXPER20                                                         
                                                                                
AGXPER04 LLC   R1,PIDLN                                                         
         AR    R2,R1                                                            
         J     AGXPER02                                                         
                                                                                
AGXPER06 MVC   HALF,PIDNO                                                       
         XOUT  PIDNO,PERDPID,2                                                  
         J     AGXPER04                                                         
                                                                                
         USING EMPELD,R2                                                        
AGXPER08 OC    EMPHIR,EMPHIR                                                    
         JZ    AGXPER10                                                         
         GOTO1 =V(SET1DAT),EMPHIR                                               
         MVC   PERDHIR,WORK                                                     
                                                                                
AGXPER10 OC    EMPTRM,EMPTRM                                                    
         JZ    AGXPER04                                                         
         GOTO1 =V(SET1DAT),EMPTRM                                               
         MVC   PERDTRM,WORK                                                     
         J     AGXPER04                                                         
                                                                                
AGXPER20 OC    HALF,HALF           skip if no PID element/PIDNO                 
         JZ    AGXPER32                                                         
         LA    R1,HALF                                                          
         GOTO1 =V(GETSPD)                                                       
         MVC   PERDFNA,WORK+00                                                  
         MVC   PERDMNA,WORK+32                                                  
         MVC   PERDLNA,WORK+16                                                  
                                                                                
AGXPER30 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
                                                                                
AGXPER32 MVI   DMCB+8,RETBNWQ      don't write as no PIDNO                      
         CLI   DXMODE,DXUPDTQ      should not get here in update mode           
         JE    *+2                                                              
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXPERLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXACCC - Extract account dimension data                            *         
***********************************************************************         
                                                                                
AGXACCC  NMOD1 WORKX-WORKD,*AGXACC*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXACCLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ACTRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ACCDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXACCDQ                                                
                                                                                
*&&UK*&& MVC   ACCDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ACCDAGY(2),NORTHAM                                               
         MVI   ACCDAGY+2,UNDSCQ                                                 
         MVC   ACCDAGY+2+1(2),SAVCALP                                           
         MVC   ACCDUAL,ACTKULA     Account unit+ledger CL2                      
         MVC   ACCDCOD,ACTKACT                                                  
                                                                                
         GOTO1 =V(SPLITAC),ACTKULA                                              
         MVC   ACCDLVL,WORK+25                                                  
                                                                                
*&&US                                                                           
         CLC   ACTKULA(2),=C'SE'                                                
         JNE   AGXACC02                                                         
         TM    ACTRSTAT,ACTSDELT                                                
         JO    AGXACC02            Skip deleted record                          
         USING CATD,R1                                                          
         LA    R1,CATBLK           Get cost setting from CATCALL                
         XC    CATD(CATLNQ),CATD                                                
         MVC   CATDMGR,=V(DATAMGR)                                              
         MVC   CATSEAC(L'ACTKCPY),ACTKCPY  Company code                         
         MVC   CATSEAC+1(L'ACTKULA),ACTKULA  account from above                 
*        LA    RF,1                                                             
*        TM    CPYSTAT4,CPYSOFF2                                                
*        JNZ   *+6                                                              
*        XR    RF,RF                     sub 1 for ex move                      
*        BASR  RE,0                                                             
*        MVC   CATOFF(0),VX2DAC                                                 
*        EX    RF,0(RE)                                                         
*        AHI   RF,1                                                             
*        LA    RE,VX2DAC                                                        
*        AR    RE,RF                                                            
*        MVC   CATDPT,0(RE)                                                     
         GOTO1 VCATCALL                                                         
         CLI   CATERR,0                                                         
         JE    AGXACC02                                                         
         CLI   CATPST,C'Y'                                                      
         JNE   AGXACC02                                                         
         MVI   ACCDCLIA,C'Y'                                                    
*&&                                                                             
                                                                                
                                                                                
AGXACC02 MVI   ACCDLOW,TRUEQ                                                    
         TM    ACTRSTAT,ACTSABLP                                                
         JNZ   AGXACC04                                                         
         MVI   ACCDLOW,FALSEQ                                                   
                                                                                
AGXACC04 GOTO1 =V(SETACTV),0                                                    
         MVC   ACCDUTS,WORK                                                     
                                                                                
         USING NAMELD,R2                                                        
         LA    R2,ACTRFST                                                       
                                                                                
AGXACC06 CLI   NAMEL,0                                                          
         JE    AGXACC90                                                         
         CLI   NAMEL,NAMELQ                                                     
         JE    AGXACC10                                                         
         CLI   NAMEL,ADRELQ                                                     
         JE    AGXACC14                                                         
         CLI   NAMEL,RSTELQ                                                     
         JE    AGXACC16                                                         
         CLI   NAMEL,OMEELQ                                                     
         JE    AGXACC44                                                         
         CLI   NAMEL,FFTELQ                                                     
         JE    AGXACC46                                                         
*&&UK                                                                           
         CLI   NAMEL,RATEVATQ                                                   
         JE    AGXACC42                                                         
*&&                                                                             
                                                                                
AGXACC08 LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     AGXACC06                                                         
                                                                                
AGXACC10 CLI   NAMLN,NAMLN1Q                                                    
         JNH   AGXACC08                                                         
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'ACCDNAM-1                                                   
         JNH   AGXACC12                                                         
         LHI   RF,L'ACCDNAM-1                                                   
                                                                                
AGXACC12 MVC   ACCDNAM(0),NAMEREC                                               
         EX    RF,*-6                                                           
         J     AGXACC08                                                         
                                                                                
         USING ADRELD,R2                                                        
AGXACC14 CLI   ADRLN,ADRLN1Q                                                    
         JL    AGXACC08                                                         
         MVC   ACCDAD1,ADRADD1                                                  
         CLI   ADRLN,ADRLN2Q                                                    
         JL    AGXACC08                                                         
         MVC   ACCDAD2,ADRADD2                                                  
         CLI   ADRLN,ADRLN3Q                                                    
         JL    AGXACC08                                                         
         MVC   ACCDAD3,ADRADD3                                                  
         CLI   ADRLN,ADRLN4Q                                                    
         JL    AGXACC08                                                         
         MVC   ACCDAD4,ADRADD4                                                  
         CLI   ADRLN,ADRLN5Q                                                    
         JL    AGXACC08                                                         
         MVC   ACCDAD5,ADRADD5                                                  
         J     AGXACC08                                                         
                                                                                
         USING RSTELD,R2                                                        
AGXACC16 MVI   ACCDISL,FALSEQ                                                   
         MVI   ACCDSTAF,FALSEQ                                                  
         MVI   ACCDDEPT,FALSEQ                                                  
         MVI   ACCDVATI,FALSEQ                                                  
         MVI   ACCDJOBA,FALSEQ                                                  
         MVI   ACCDPROA,FALSEQ                                                  
         MVI   ACCDMILE,FALSEQ                                                  
         CLI   RSTLN,RSTFILT1-RSTELD                                            
         JL    AGXACC18                                                         
         MVC   ACCDFL1,RSTFILT1                                                 
                                                                                
AGXACC18 CLI   RSTLN,RSTFILT2-RSTELD                                            
         JL    AGXACC20                                                         
         MVC   ACCDFL2,RSTFILT2                                                 
                                                                                
AGXACC20 CLI   RSTLN,RSTFILT3-RSTELD                                            
         JL    AGXACC22                                                         
         MVC   ACCDFL3,RSTFILT3                                                 
                                                                                
AGXACC22 CLI   RSTLN,RSTFILT4-RSTELD                                            
         JL    AGXACC24                                                         
         MVC   ACCDFL4,RSTFILT4                                                 
                                                                                
AGXACC24 CLI   RSTLN,RSTFILT5-RSTELD                                            
         JL    AGXACC26                                                         
         MVC   ACCDFL5,RSTFILT5                                                 
                                                                                
AGXACC26 CLI   RSTLN,RSTSTAT-RSTELD                                             
         JL    AGXACC08                                                         
         TM    RSTSTAT,RSTSACIL    Is account locked                            
         JZ    AGXACC28                                                         
         MVI   ACCDISL,TRUEQ                                                    
AGXACC28 TM    RSTSTAT,RSTSGPEI    Staff analysis on expense account            
         JZ    AGXACC30                                                         
         MVI   ACCDSTAF,TRUEQ                                                   
AGXACC30 TM    RSTSTAT,RSTSEADD    Dept analysis on expense account             
         JZ    AGXACC32                                                         
         MVI   ACCDDEPT,TRUEQ                                                   
                                                                                
*&&UK                                                                           
AGXACC32 TM    RSTSTAT,RSTSIVAT    Is Input VAT account                         
         JZ    AGXACC34                                                         
         MVI   ACCDVATI,TRUEQ                                                   
                                                                                
AGXACC34 MVC   ACCDCLIA,RSTCOSTG                                                
*&&                                                                             
                                                                                
*&&US                                                                           
AGXACC32 CLI   RSTLN,RSTSTAT2-RSTELD                                            
         JL    AGXACC08                                                         
         TM    RSTSTAT2,RSTSIVAT   Is Input VAT account                         
         JZ    AGXACC36                                                         
         MVI   ACCDVATI,TRUEQ                                                   
*&&                                                                             
                                                                                
AGXACC36 CLI   RSTLN,RSTLN2Q                                                    
         JL    AGXACC08                                                         
         MVC   ACCDGLOF,RSTOFFC                                                 
                                                                                
         TM    RSTSTAT4,RSTSJREA   Job analysis on expense account              
         JZ    AGXACC38                                                         
         MVI   ACCDJOBA,TRUEQ                                                   
                                                                                
AGXACC38 TM    RSTSTAT5,RSTSPREA   Product analysis on expense account          
         JZ    AGXACC40                                                         
         MVI   ACCDPROA,TRUEQ                                                   
                                                                                
AGXACC40 TM    RSTSTAT2,RSTSMILE   Mile analysis on expense account             
         JZ    AGXACC08                                                         
         MVI   ACCDMILE,TRUEQ                                                   
                                                                                
         J     AGXACC08                                                         
                                                                                
*&&UK                                                                           
         USING RATELD,R2                                                        
AGXACC42 CURED RATRATE,(L'ACCDVATR,ACCDVATR),2,ALIGN=LEFT,             +        
               MODADDR=VCUREDIT                                                 
         J     AGXACC08                                                         
*&&                                                                             
                                                                                
         USING OMEELD,R2                                                        
AGXACC44 LLC   RF,OMELN                                                         
         SHI   RF,OMELN1Q+1                                                     
         CHI   RF,L'ACCDOMEM                                                    
         JNH   *+8                                                              
         LHI   RF,L'ACCDOMEM                                                    
         BASR  RE,0                                                             
         MVC   ACCDOMEM(0),OMEMO                                                
         EX    RF,0(RE)                                                         
         J     AGXACC08                                                         
                                                                                
         USING FFTELD,R2                                                        
AGXACC46 CLI   FFTTYPE,FFTTAXNO                                                 
         JNE   AGXACC48                                                         
         LLC   RF,FFTDLEN                                                       
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   ACCDVAT#(0),FFTDATA                                              
         EX    RF,0(RE)                                                         
         J     AGXACC08                                                         
                                                                                
AGXACC48 DS    0H                                                               
*&&UK                                                                           
         CLI   FFTTYPE,FFTTAXLO                                                 
         JNE   AGXACC08                                                         
         MVC   ACCDVATW,FFTDATA                                                 
*&&                                                                             
         J     AGXACC08                                                         
                                                                                
AGXACC90 MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXACCLT DC    A(LITERAL)                                                       
VCUREDIT DC    V(CUREDIT)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXTRNC - Extract job and expense transaction dimension data        *         
***********************************************************************         
                                                                                
AGXTRNC  NMOD1 WORKX-WORKD,*AGXTRN*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXTRNLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING TRNRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,TRNDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXTRNDQ                                                
                                                                                
* >>> if this requires SAVTRN then SAVORD needs to be saved in UPDTTRN          
* >>> and restored similar to S_PROCMO                                          
                                                                                
*&&UK*&& MVC   TRNDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   TRNDAGY(2),NORTHAM                                               
         MVI   TRNDAGY+2,UNDSCQ                                                 
         MVC   TRNDAGY+2+1(2),SAVCALP                                           
         MVC   TRNDCON,TRNKULC                                                  
         MVI   TRNDMOD,TRNMODPQ    DEFAULT TO PRODUCT MODULE                    
         CLC   PRODUL,TRNKULA                                                   
         JE    *+8                                                              
         MVI   TRNDMOD,TRNMODEQ    EXPENSE MODULE (SE,SA,SQ,SB)                 
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   TRNDUTS,WORK                                                     
                                                                                
         USING TRNELD,R2                                                        
         LA    R2,TRNRFST                                                       
         MVI   BYTE,0                                                           
                                                                                
         MVC   TRNDREF(L'TRNREF),TRNREF                                         
         MVC   TRNDBRF,TRNBREF     Set Reference, Batch Ref. + Type             
         EDITR (B1,TRNTYPE),(L'TRNDBTY,TRNDBTY),0,ZERO=NOBLANK,        *        
               ALIGN=LEFT                                                       
                                                                                
         CLC   TRNKWORK,BILWC                                                   
         JE    AGXTRN04                                                         
         LLC   R1,TRNLN                                                         
         SHI   R1,TRNLN1Q+1                                                     
         CHI   R1,0                                                             
         JL    AGXTRN04                                                         
         CHI   R1,L'TRNDNAR-1                                                   
         JNH   AGXTRN02                                                         
         LHI   R1,L'TRNDNAR-1                                                   
                                                                                
AGXTRN02 MVC   TRNDNAR(0),TRNNARR                                               
         EX    R1,*-6                                                           
                                                                                
         USING SERELD,R2                                                        
AGXTRN04 LLC   R1,SERLN                                                         
         AR    R2,R1                                                            
                                                                                
         CLI   SEREL,0                                                          
         JE    AGXTRN30                                                         
         CLI   SEREL,OTHELQ                                                     
         JE    AGXTRN08                                                         
         CLI   SEREL,FFTELQ                                                     
         JE    AGXTRN10                                                         
         CLI   SEREL,AFCELQ                                                     
         JE    AGXTRN14                                                         
         CLI   SEREL,SCIELQ                                                     
         JE    AGXTRN18                                                         
         CLI   SEREL,SERELQ                                                     
         JNE   AGXTRN04                                                         
                                                                                
         XOUT  SERNM,TRNDKEY,4                                                  
                                                                                
         J     AGXTRN04                                                         
                                                                                
         USING OTHELD,R2                                                        
AGXTRN08 MVC   TRNDIRF,OTHNUM      Set internal reference                       
         J     AGXTRN04                                                         
                                                                                
         USING FFTELD,R2                                                        
AGXTRN10 CLI   FFTTYPE,FFTTKREF                                                 
         JNE   AGXTRN12                                                         
         TM    BYTE,BYTLRFQ                                                     
         JNZ   AGXTRN04                                                         
         OI    BYTE,BYTKRFQ                                                     
         MVC   TRNDREF(L'TRNREF),FFTDATA                                        
         J     AGXTRN04                                                         
                                                                                
AGXTRN12 DS    0H                                                               
*&&UK                                                                           
         CLI   FFTTYPE,FFTTINVN                                                 
         JNE   AGXTRN04                                                         
         LLC   R1,FFTLN                                                         
         SHI   R1,(FFTLN1Q+1+1)                                                 
         CHI   R1,0                                                             
         JL    AGXTRN04                                                         
         CHI   R1,L'TRNDREF-1                                                   
         JH    AGXTRN04                                                         
         OI    BYTE,BYTLRFQ                                                     
         MVC   TRNDREF(0),FFTDATA                                               
         EX    R1,*-6                                                           
*&&                                                                             
         J     AGXTRN04                                                         
                                                                                
         USING AFCELD,R2                                                        
AGXTRN14 TM    AFCXSTA2,AFCXSMEM                                                
         JNZ   AGXTRN04                                                         
         CLC   AFCCURR,SAVCCUR                                                  
         JE    AGXTRN04                                                         
         CLC   AFCCURR,GSPACES                                                  
         JNH   AGXTRN04                                                         
         ZAP   DUB,PZERO                                                        
         MVO   DUB,AFCXRATE                                                     
         TM    AFCXSTAT,AFCXSDIV                                                
         JZ    AGXTRN16                                                         
         ZAP   PL16,PONE                                                        
         MP    PL16,=P'100000000000'                                            
         DP    PL16,DUB                                                         
         SRP   PL16(8),64-1,5                                                   
         ZAP   DUB,PL16(8)                                                      
                                                                                
AGXTRN16 EDITR (P8,DUB),(L'TRNDRAT,TRNDRAT),5,ALIGN=LEFT                        
         J     AGXTRN04                                                         
                                                                                
         USING SCIELD,R2                                                        
AGXTRN18 CLI   SCITYPE,SCITCPAD                                                 
         JNE   AGXTRN04                                                         
         MVC   TRNDPRF,SCITCPNO    Set payment reference                        
         GOTOR =V(SET2DAT),SCITCPDT                                             
         MVC   TRNDPDT,WORK        Set payment date                             
         J     AGXTRN04                                                         
                                                                                
         USING TRNELD,R2                                                        
AGXTRN30 MVI   TRNDLTY,LOGTY_0Q    Default - determine logical type             
         LA    R2,TRNRFST                                                       
         LARL  R1,TTTABLE                                                       
AGXTRN32 CLI   0(R1),FFQ                                                        
         JE    AGXTRN40                                                         
         CLC   TRNTYPE,1(R1)                                                    
         JNE   AGXTRN34                                                         
         CLI   0(R1),LOGTY_5Q                                                   
         JNE   AGXTRN36                                                         
         CP    TRNAMNT,PZERO                                                    
         JE    AGXTRN36                                                         
                                                                                
AGXTRN34 AHI   R1,2                                                             
         J     AGXTRN32                                                         
                                                                                
AGXTRN36 MVC   TRNDLTY,0(R1)       Set found logical type                       
                                                                                
AGXTRN40 CLC   TRNDKEY,GSPACES                                                  
         JNH   *+2                 No SERNM present ?|                          
                                                                                
AGXTRNX  MVI   DMCB+8,RETBFFQ      Indicate fact(s) to follow                   
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGXTRNLT DC    A(LITERAL)                                                       
BYTKRFQ  EQU   X'01'                                                            
BYTLRFQ  EQU   X'10'                                                            
                                                                                
LOGTY_0Q EQU   LOGTY_1Q            (others)                                     
LOGTY_1Q EQU   C'1'                Invoice                                      
LOGTY_2Q EQU   C'2'                Prebill (NA only)                            
LOGTY_3Q EQU   C'3'                Bill (EU only)                               
LOGTY_4Q EQU   C'4'                Timesheet                                    
LOGTY_5Q EQU   C'5'                Expense                                      
                                                                                
TRNMODPQ EQU   C'P'                Product module                               
TRNMODEQ EQU   C'E'                Expense module                               
TTTABLE  DS    0H                                                               
         DC    AL1(LOGTY_5Q),AL1(TRNTINV)                                       
         DC    AL1(LOGTY_5Q),AL1(TRNTNBIN)                                      
         DC    AL1(LOGTY_1Q),AL1(TRNTINV)                                       
         DC    AL1(LOGTY_1Q),AL1(TRNTNBIN)                                      
*&&US*&& DC    AL1(LOGTY_1Q),AL1(10)                                            
*&&US*&& DC    AL1(LOGTY_1Q),AL1(TRNTMUBL)                                      
*&&US*&& DC    AL1(LOGTY_1Q),AL1(61)                                            
*&&UK*&& DC    AL1(LOGTY_1Q),AL1(71)                                            
*&&UK*&& DC    AL1(LOGTY_1Q),AL1(72)                                            
         DC    AL1(LOGTY_1Q),AL1(TRNTBLTX)                                      
         DC    AL1(LOGTY_1Q),AL1(TRNTJBTX)                                      
*&&US*&& DC    AL1(LOGTY_3Q),AL1(TRNTBILL)                                      
*&&UK*&& DC    AL1(LOGTY_4Q),AL1(TRNTMABL)                                      
*&&UK*&& DC    AL1(LOGTY_4Q),AL1(TRNTCLBL)                                      
         DC    AL1(FFQ)                                                         
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGFTRNC - Extract job transaction fact data                         *         
***********************************************************************         
                                                                                
AGFTRNC  NMOD1 WORKX-WORKD,*AGFTRN*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGFTRNLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING TRNRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,TRNFLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXTRNFQ                                                
                                                                                
                                                                                
*&&UK*&& MVC   TRNFAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   TRNFAGY(2),NORTHAM                                               
         MVI   TRNFAGY+2,UNDSCQ                                                 
         MVC   TRNFAGY+2+1(2),SAVCALP                                           
         MVC   TRNFCUR,SAVCCUR                                                  
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   TRNFUTS,WORK                                                     
                                                                                
         USING TRNELD,R2                                                        
         LA    R2,TRNRFST                                                       
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFCAM,TRNFCAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFPAM,TRNFPAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFHAM,TRNFHAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFMAM,TRNFMAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFNBL,TRNFNBL)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFCBL,TRNFCBL)                     
                                                                                
         GOTO1 =V(SPLITSJ),TRNKACT                                              
         MVC   TRNFCLI,WORK+30+0                                                
         MVC   TRNFPRO,WORK+30+8                                                
         MVC   TRNFJOB,WORK+30+16                                               
         MVC   TRNFWRK,TRNKWORK                                                 
         CLI   DXMODE,DXUPDTQ      Get office in in Update mode                 
         JNE   AGFTRN00                                                         
         GOTO1 =V(SETSJO),TRNKEY                                                
                                                                                
AGFTRN00 MVC   TRNFOFF,SAV_TOFF    (missing in update mode still)               
         CLC   TRNKCCPY,TRNKCPY    Real c/a?                                    
         JNE   AGFTRN01                                                         
         CLC   PRODUL,TRNKULC      Are we dealing with SJ contra                
         JE    AGFTRN1A                                                         
         MVC   TRNFCON,TRNKULC                                                  
         GOTO1 =V(SPLITAC),TRNKULC                                              
         CLI   WORK+25,C'0'                                                     
         JE    AGFTRN01                                                         
         MVC   TRNFCON1,WORK+30+00                                              
         CLI   WORK+25,C'1'                                                     
         JE    AGFTRN01                                                         
         MVC   TRNFCON2,WORK+30+15                                              
         CLI   WORK+25,C'2'                                                     
         JE    AGFTRN01                                                         
         MVC   TRNFCON3,WORK+30+30                                              
         CLI   WORK+25,C'3'                                                     
         JE    AGFTRN01                                                         
         MVC   TRNFCON4,WORK+30+45                                              
         J     AGFTRN01                                                         
                                                                                
AGFTRN1A GOTO1 =V(SPLITSJ),TRNKCACT                                             
         MVC   TRNFSJCL,WORK+30+0                                               
         MVC   TRNFSJPR,WORK+30+8                                               
         MVC   TRNFSJJB,WORK+30+16                                              
                                                                                
AGFTRN01 GOTO1 =V(SET1DAT),TRNKDATE                                             
         MVC   TRNFDAT,WORK                                                     
*                                                                               
         OC    TRNRSMOS,TRNRSMOS                                                
         JZ    AGFTRN2A            NO MOA!!!!                                   
         XC    DUB,DUB                                                          
         MVC   DUB(2),TRNRSMOS     MONTH-OF-ACTIVITY                            
         MVI   DUB+2,X'01'         DEFAULT TO FIRST DAY OF MONTH                
         GOTO1 =V(SET1DAT),DUB                                                  
         MVC   TRNFMOA,WORK                                                     
*                                                                               
AGFTRN2A MVI   TRNFISD,FALSEQ                                                   
         TM    TRNSTAT,TRNSDR                                                   
         JZ    AGFTRN02                                                         
         MVI   TRNFISD,TRUEQ                                                    
                                                                                
AGFTRN02 DS    0H                                                               
                                                                                
*        EDITR (P6,TRNAMNT),(L'TRNFNAM-1,TRNFNAM+1),0,ZERO=NOBLANK,    +        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,TRNAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN04                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTRN04 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFNAM,TRNFNAM)                     
                                                                                
         CP    TRNAMNT,PZERO                                                    
         JE    AGFTRN06                                                         
         OI    SAV_TIND,SAV_TIAQ                                                
                                                                                
AGFTRN06 XC    DUB,DUB                                                          
         LA    R5,TRNFBN1                                                       
         MVI   SAV_TBNC,0                                                       
         MVI   SAV_TIND,0                                                       
         XC    SAV_TELE,SAV_TELE                                                
         ZAP   DUBNET,PZERO                                                     
         ZAP   DUBCOM,PZERO                                                     
         ZAP   DUBFBC,PZERO                                                     
         ZAP   DUBFBN,PZERO                                                     
         ZAP   BILLAMT,PZERO                                                    
                                                                                
         CLC   TRNKWORK,BILWC                                                   
         JNE   AGFTRN08                                                         
*&&US                                                                           
         CLI   TRNLN,TRNLN1Q                                                    
         JNH   AGFTRN08                                                         
         ZAP   DUBCOM,TRNBLCOM                                                  
         ZAP   DUBNET,TRNAMNT                                                   
***      AP    DUBNET,TRNBLCOM                                                  
*&&                                                                             
*&&UK                                                                           
         ZAP   DUBNET,TRNAMNT      (default: DSRD-18117)                        
         CLI   TRNLN,TRNLNBQ                                                    
         JNE   AGFTRN08                                                         
         ZAP   DUBCOM,TRNCOMM                                                   
         ZAP   DUBNET,TRNAMNT                                                   
***      AP    DUBNET,TRNCOMM                                                   
*&&                                                                             
         USING SERELD,R2                                                        
AGFTRN08 LLC   R1,SERLN                                                         
         AR    R2,R1                                                            
                                                                                
         CLI   SEREL,0                                                          
         JE    AGFTRN60                                                         
         CLI   SEREL,FFNELQ                                                     
         JE    AGFTRN10                                                         
         CLI   SEREL,TRSELQ                                                     
         JE    AGFTRN12                                                         
         CLI   SEREL,AFCELQ                                                     
         JE    AGFTRN14                                                         
*&&UK*&& CLI   SEREL,FBAELQ                                                     
*&&UK*&& JE    AGFTRN18                                                         
         CLI   SEREL,FFTELQ                                                     
         JE    AGFTRN20                                                         
         CLI   SEREL,PTAELQ                                                     
         JE    AGFTRN22                                                         
         CLI   SEREL,SCIELQ                                                     
         JE    AGFTRN30                                                         
         CLI   SEREL,PRTELQ                                                     
         JE    AGFTRN48                                                         
         CLI   SEREL,SERELQ                                                     
         JNE   AGFTRN08                                                         
                                                                                
         XOUT  SERNM,TRNFKEY,4                                                  
                                                                                
         J     AGFTRN08                                                         
                                                                                
         USING FFNELD,R2                                                        
AGFTRN10 CLC   FFNONUM,ORDDUMMY                                                 
         JE    AGFTRN08                                                         
         MVC   TRNFORD,FFNONUM                                                  
         J     AGFTRN08                                                         
                                                                                
         USING TRSELD,R2                                                        
AGFTRN12 MVC   DUB(2),TRSDATE                                                   
         MVC   SAVMOS(L'TRSPMOS),TRSPMOS                                        
         CLI   TRSLN,TRSLN2Q                                                    
         JL    AGFTRN08                                                         
*&&UK                                                                           
         MVC   DUB(2),TRSADATE                                                  
         MVC   DUB+3(3),TRSATIME                                                
*&&                                                                             
         J     AGFTRN08                                                         
                                                                                
         USING AFCELD,R2                                                        
AGFTRN14 CLC   AFCCURR,GSPACES                                                  
         JNH   AGFTRN08                                                         
         CLC   AFCCURR,SAVCCUR                                                  
         JE    AGFTRN08                                                         
         MVC   TRNFCUR,AFCCURR                                                  
                                                                                
*        EDITR (P6,AFCAMNT),(L'TRNFCAM-1,TRNFCAM+1),0,ZERO=NOBLANK,    +        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,AFCAMNT       Foreign cur                                  
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN16                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTRN16 GOTO1 =V(SETAMNT),DMCB,AFCCURR,(L'TRNFCAM,TRNFCAM)                     
         CP    AFCAMNT,PZERO                                                    
         JE    AGFTRN08                                                         
         OI    SAV_TIND,SAV_TICQ                                                
         J     AGFTRN08                                                         
*&&UK                                                                           
         USING FBAELD,R2                                                        
AGFTRN18 CLI   FBASUB,FBASUBQ                                                   
         JNE   AGFTRN08                                                         
         CLC   SAVCCUR,FBACUR      (currency bills have agency and              
         JNE   AGFTRN08             bill currency FBA elements)                 
         CLI   FBALN,FBALN2Q                                                    
         JL    AGFTRN08                                                         
         AP    DUBFBN,FBANET                                                    
         AP    DUBFBC,FBACOM                                                    
         OI    SAV_TIND,SAV_TIFQ                                                
         J     AGFTRN08                                                         
*&&                                                                             
         USING FFTELD,R2                                                        
AGFTRN20 CLI   FFTTYPE,FFTTESTN                                                 
         JNE   AGFTRN08                                                         
         MVC   TRNFEST,FFTDATA                                                  
         J     AGFTRN08                                                         
                                                                                
         USING PTAELD,R2                                                        
AGFTRN22 DS    0H                                                               
                                                                                
         CLI   PTATYPE,PTATRAL     Bill number check - see AGXBIL02             
         JNE   AGFTRN08                                                         
         TM    PTASTAT1,PTASPEND                                                
         JNZ   AGFTRN08                                                         
         OC    PTADATE,PTADATE                                                  
         JZ    AGFTRN08                                                         
         CLC   PTARBLNO,GSPACES                                                 
         JNH   AGFTRN08                                                         
         OC    PTARBLDT,PTARBLDT                                                
         JZ    AGFTRN08                                                         
                                                                                
         LA    R1,TRNFBN8                                                       
         CR    R5,R1               Skip if > 8 bill numbers                     
         JH    AGFTRN08                                                         
         MVC   0(6,R5),PTARBLNO                                                 
         MVI   6(R5),UNDSCQ                                                     
         GOTOR =V(SET2DAT),PTARBLDT                                             
         MVC   7(10,R5),WORK                                                    
         AHI   R5,TRNFBN2-TRNFBN1                                               
         LLC   R1,SAV_TBNC                                                      
         AHI   R1,1                                                             
         STC   R1,SAV_TBNC                                                      
         OC    SAV_TELE,SAV_TELE                                                
         JNZ   AGFTRN08                                                         
         STCM  R2,B'1111',SAV_TELE Save first Bill number element               
         J     AGFTRN08                                                         
                                                                                
         USING SCIELD,R2                                                        
AGFTRN30 CLI   SCITYPE,SCITCPAD                                                 
         JNE   AGFTRN32                                                         
         CLC   SCITCPNO,GSPACES                                                 
         JNH   AGFTRN08                                                         
                                                                                
         MVC   TRNFPAM,TRNFNAM     Use transaction amount as Pay2Job            
         J     AGFTRN08                                                         
                                                                                
AGFTRN32 DS    0H                                                               
*&&UK                                                                           
         CLI   SCITYPE,SCITSJHR                                                 
         JNE   AGFTRN36                                                         
                                                                                
*        EDITR (P6,SCIAMNT),(L'TRNFHAM-1,TRNFHAM+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,SCIAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN34                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTRN34 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFHAM,TRNFHAM)                     
                                                                                
AGFTRN36 CLC   TRNKWORK,BILWC      Skip for bill transaction                    
         JE    AGFTRN40                                                         
         CLI   SCITYPE,SCITMEXP    Memo amount?                                 
         JE    AGFTRN37                                                         
*&&                                                                             
                                                                                
*&&US*&& CLI   SCITYPE,SCITSJXP    Memo amount?                                 
*&&US*&& JE    AGFTRN37                                                         
         CLI   SCITYPE,SCITCRAT                                                 
         JNE   AGFTRN08                                                         
                                                                                
AGFTRN37 TM    SAV_TIND,SAV_TIAQ   Only if TRNAMNT zero                         
         JNZ   AGFTRN08                                                         
                                                                                
         ZAP   EDDUB,SCIAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN38                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTRN38 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFMAM,TRNFMAM)                     
         J     AGFTRN08                                                         
                                                                                
AGFTRN40 CLI   SCITYPE,SCITCOMM    (=SCITCRAT)                                  
*&&UK*&& JNE   AGFTRN42                                                         
*&&US*&& JNE   AGFTRN08                                                         
         ZAP   DUBCOM,SCIAMNT                                                   
         J     AGFTRN08                                                         
                                                                                
*&&UK                                                                           
AGFTRN42 TM    SCITYPE,X'40'       VAT TYPE?                                    
         JNZ   AGFTRN08                                                         
         CLI   SCITYPE,SCITCPAD    Skip new debtor SCIELDs                      
         JNH   AGFTRN08                                                         
         CLI   SCITYPE,SCITAVT0    Test VAT code a - z                          
         JL    AGFTRN44            Yes, include them                            
         CLI   SCITYPE,SCITAVT9    Test VAT code 0 to 9                         
         JH    AGFTRN08            No - skip                                    
                                                                                
AGFTRN44 ZAP   BILLAMT,SCIGBIL                                                  
         J     AGFTRN08                                                         
*&&                                                                             
                                                                                
AGFTRN48 DS    0H                                                               
*&&US                                                                           
         USING PRTELD,R2                                                        
*        EDITR (P3,PRTHOUR),(L'TRNFHAM-1,TRNFHAM+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,PRTHOUR       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN50                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTRN50 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFHAM,TRNFHAM)                     
*&&                                                                             
         J     AGFTRN08            logic demands|                               
                                                                                
AGFTRN60 MVC   FULL(2),DUB                                                      
         GOTO1 =V(CHKDATE),DMCB,(2,FULL)                                        
         GOTO1 =V(DATCON),DMCB,(2,FULL),(1,DUB)                                 
         CLC   TRNKWORK,BILWC      Skip Bill transactions                       
         JNE   AGFTRN62                                                         
                                                                                
         USING TRNELD,R2                                                        
         LA    R2,TRNRFST                                                       
OB       USING OB_D,OBTTAREA                                                    
         LA    R0,OBTTAREA                                                      
         LHI   R1,OB_LNQ-1                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   OB.OB_LEN,=AL2(OB_CSLNQ)                                         
         MVI   OB.OB_KTYP,OB_KTYPQ                                              
         MVC   OB.OB_KMOA,SAVMOS                                                
         MVC   OB.OB_KOFF,SAV_TOFF                                              
         MVC   OB.OB_KCLI,GSPACES                                               
         LLC   R1,CLILEN                                                        
         BCTR  R1,0                                                             
         MVC   OB.OB_KCLI(0),TRNKACT                                            
         EX    R1,*-6                                                           
         MVC   OB.OB_KAGY,TRNFAGY                                               
                                                                                
         ZAP   OB.OB_EHRS,PZERO                                                 
         ZAP   OB.OB_ESTA,PZERO                                                 
         ZAP   OB.OB_BHRS,PZERO                                                 
         ZAP   OB.OB_NHRS,PZERO                                                 
         ZAP   OB.OB_AHRS,PZERO                                                 
         ZAP   OB.OB_NEXA,PZERO                                                 
         ZAP   OB.OB_BILD,BILLAMT                                               
                                                                                
         CLI   DXACTION,C'D'       If action is delete need to subtract         
         JNE   AGFTRN61             so multiply by minus one                    
         MP    OB.OB_BILD,PMONE                                                 
                                                                                
AGFTRN61 GOTOR =V(CLIREC),OB.OB_D                                               
         J     AGFTRN70                                                         
         DROP  OB                                                               
                                                                                
AGFTRN62 GOTO1 =V(SPLITSJ),TRNKACT                                              
                                                                                
         USING PRORATAD,R2                                                      
         L     R2,APRORATA         Point to cleared PRORATAD area               
         LR    R0,R2                                                            
         LHI   R1,JBLOCKL                                                       
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         USING GOBLOCKD,R5                                                      
         L     R5,AGOBLOCB                                                      
         ZAP   GOAGYCOM,PZERO      set to zero                                  
                                                                                
*** => ACPRORATA seems to use GOAGYCOM only which gets set to zero              
***    so given the massive IO overhead this has been dropped ufn.              
***                                                                             
***      MVC   GOADM,=V(DATAMGR)                                                
***      MVC   GOACOVL,=V(COVAIL)                                               
***      MVC   GOABINSR,=V(BINSRCH)                                             
***      MVC   GOSELCUL,TRNKCPY                                                 
***      MVC   GOSELCLI,WORK+30+0                                               
***      MVC   GOSELPRO,WORK+30+8                                               
***      MVC   GOSELJOB,WORK+30+16                                              
***      MVC   GOSELWC,TRNKWORK                                                 
***      MVC   GOSELMED,WORK+30+16                                              
***      MVC   GOABUFF,AOPTBUF                                                  
***      MVC   GOLBUFF,=A(OPTBUFL)                                              
***      OI    GOSPEC3,GOSPNERQ                                                 
***                                                                             
***      GOTO1 =V(GETOPT),DMCB,GOBLOCKD                                         
***      ZAP   GOAGYCOM,PZERO                                                   
                                                                                
         GOTO1 =V(PRORATA),DMCB,TRNRECD,GOBLOCKD,ACOMFAC,0,PRORATAD,0           
         DROP  R5                                                               
                                                                                
         TM    PG$STAT,PG$FULLB+PG$PARTB      Billed?                           
         JZ    AGFTRN64                                                         
         ZAP   DUBNET,PA$NETBL                                                  
         ZAP   DUBCOM,PA$COMBL                                                  
                                                                                
AGFTRN64 ZAP   EDDUB,DUBNET        Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN66                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTRN66 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFNBL,TRNFNBL)                     
                                                                                
         ZAP   EDDUB,DUBCOM        Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN68                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTRN68 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFCBL,TRNFCBL)                     
         J     AGFTRN80                                                         
                                                                                
AGFTRN70 ZAP   EDDUB,DUBCOM        Bill transaction                             
         TM    SAV_TIND,SAV_TIFQ                                                
         JZ    AGFTRN72                                                         
         ZAP   EDDUB,DUBFBC        use FBAEL value                              
                                                                                
AGFTRN72 CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN74                                                         
         MP    EDDUB,PMONE                                                      
                                                                                
AGFTRN74 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFCBL,TRNFCBL)                     
                                                                                
         ZAP   EDDUB,DUBNET                                                     
         TM    SAV_TIND,SAV_TIFQ                                                
         JZ    AGFTRN76                                                         
         ZAP   EDDUB,DUBFBN        use FBAEL value                              
                                                                                
AGFTRN76 CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTRN78                                                         
         MP    EDDUB,PMONE                                                      
                                                                                
AGFTRN78 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TRNFNBL,TRNFNBL)                     
         J     AGFTRN80                                                         
                                                                                
AGFTRN80 CLI   SAV_TBNC,0                                                       
         JE    AGFTRNN                                                          
                                                                                
AGFTRNY  OI    PROCMODE,PROCBNQ          indicate bill numbers to come          
         MVI   DMCB+8,RETBNMQ                                                   
         J     EXIT                                                             
                                                                                
AGFTRNN  NI    PROCMODE,FFQ-PROCBNQ      indicate no more to come               
         MVI   DMCB+8,RETBNMQ                                                   
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGFTRNLT DC    A(LITERAL)                                                       
ORDDUMMY DC    CL6'DUMMY'                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGFXTRC - Extract expense transaction fact data                               
***********************************************************************         
                                                                                
AGFXTRC  NMOD1 WORKX-WORKD,*AGFXTR*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGFXTRLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING TRNRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,XTRFLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXXTRFQ                                                
                                                                                
*&&UK*&& MVC   XTRFAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   XTRFAGY(2),NORTHAM                                               
         MVI   XTRFAGY+2,UNDSCQ                                                 
         MVC   XTRFAGY+2+1(2),SAVCALP                                           
         MVC   XTRFCUR,SAVCCUR                                                  
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   XTRFUTS,WORK                                                     
                                                                                
         USING TRNELD,R2                                                        
         LA    R2,TRNRFST                                                       
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'XTRFCAM,XTRFCAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'XTRFMAM,XTRFMAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'XTRFAMT,XTRFAMT)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'XTRFMILE,XTRFMILE)                   
                                                                                
AGFXTR02 MVC   XTRFOFF,TRNOFFC     office                                       
         CLC   TRNKCCPY,TRNKCPY    Real c/a?                                    
         JNE   AGFXTR04                                                         
         CLC   PRODUL,TRNKULC                                                   
         JE    AGFXTR03                                                         
         MVC   XTRFCON,TRNKULC                                                  
         GOTO1 =V(SPLITAC),TRNKULC                                              
         CLI   WORK+25,C'0'                                                     
         JE    AGFXTR04                                                         
         MVC   XTRFCON1,WORK+30+00                                              
         CLI   WORK+25,C'1'                                                     
         JE    AGFXTR04                                                         
         MVC   XTRFCON2,WORK+30+15                                              
         CLI   WORK+25,C'2'                                                     
         JE    AGFXTR04                                                         
         MVC   XTRFCON3,WORK+30+30                                              
         CLI   WORK+25,C'3'                                                     
         JE    AGFXTR04                                                         
         MVC   XTRFCON4,WORK+30+45                                              
         J     AGFXTR04                                                         
                                                                                
AGFXTR03 GOTO1 =V(SPLITSJ),TRNKCACT                                             
         MVC   XTRFSJCL,WORK+30+0                                               
         MVC   XTRFSJPR,WORK+30+8                                               
         MVC   XTRFSJJB,WORK+30+16                                              
                                                                                
AGFXTR04 MVC   XTRFACC,TRNKULA                                                  
         GOTO1 =V(SPLITAC),TRNKULA                                              
         CLI   WORK+25,C'0'                                                     
         JE    AGFXTR06                                                         
         MVC   XTRFLVL1,WORK+30+00                                              
         CLI   WORK+25,C'1'                                                     
         JE    AGFXTR06                                                         
         MVC   XTRFLVL2,WORK+30+15                                              
         CLI   WORK+25,C'2'                                                     
         JE    AGFXTR06                                                         
         MVC   XTRFLVL3,WORK+30+30                                              
         CLI   WORK+25,C'3'                                                     
         JE    AGFXTR06                                                         
         MVC   XTRFLVL4,WORK+30+45                                              
                                                                                
AGFXTR06 GOTO1 =V(SET1DAT),TRNKDATE                                             
         MVC   XTRFDAT,WORK                                                     
                                                                                
         OC    TRNRSMOS,TRNRSMOS                                                
         JZ    AGFXTR08            NO MOA!!!!                                   
         XC    DUB,DUB                                                          
         MVC   DUB(2),TRNRSMOS     MONTH-OF-ACTIVITY                            
         MVI   DUB+2,X'01'         DEFAULT TO FIRST DAY OF MONTH                
         GOTO1 =V(SET1DAT),DUB                                                  
         MVC   XTRFMOA,WORK                                                     
                                                                                
AGFXTR08 MVI   XTRFISD,FALSEQ                                                   
         TM    TRNSTAT,TRNSDR                                                   
         JZ    AGFXTR26                                                         
         MVI   XTRFISD,TRUEQ                                                    
                                                                                
AGFXTR26 DS    0H                                                               
         ZAP   EDDUB,TRNAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFXTR28                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFXTR28 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'XTRFAMT,XTRFAMT)                     
                                                                                
         XC    TEMPSTOR,TEMPSTOR                                                
         CP    TRNAMNT,PZERO                                                    
         JE    AGFXTR30                                                         
         OI    SAV_TIND,SAV_TIAQ                                                
                                                                                
         USING SERELD,R2                                                        
AGFXTR30 LLC   R1,SERLN                                                         
         AR    R2,R1                                                            
                                                                                
         CLI   SEREL,0                                                          
         JE    AGFXTR80                                                         
         CLI   SEREL,FFNELQ                                                     
         JE    AGFXTR32                                                         
         CLI   SEREL,TRSELQ                                                     
         JE    AGFXTR34                                                         
         CLI   SEREL,AFCELQ                                                     
         JE    AGFXTR36                                                         
         CLI   SEREL,SCIELQ                                                     
         JE    AGFXTR50                                                         
         CLI   SEREL,FFTELQ                                                     
         JE    AGFXTR60                                                         
         CLI   SEREL,SERELQ                                                     
         JNE   AGFXTR30                                                         
                                                                                
         XOUT  SERNM,XTRFKEY,4                                                  
                                                                                
         J     AGFXTR30                                                         
                                                                                
         USING FFNELD,R2                                                        
AGFXTR32 CLC   FFNONUM,XORDDUMY                                                 
         JE    AGFXTR30                                                         
         MVC   XTRFORD,FFNONUM                                                  
         J     AGFXTR30                                                         
                                                                                
         USING TRSELD,R2                                                        
AGFXTR34 MVC   DUB(2),TRSDATE                                                   
         MVC   SAVMOS(L'TRSPMOS),TRSPMOS                                        
         CLI   TRSLN,TRSLN2Q                                                    
         JL    AGFXTR30                                                         
*&&UK                                                                           
         MVC   DUB(2),TRSADATE                                                  
         MVC   DUB+3(3),TRSATIME                                                
*&&                                                                             
         J     AGFXTR30                                                         
                                                                                
         USING AFCELD,R2                                                        
AGFXTR36 CLC   AFCCURR,GSPACES                                                  
         JNH   AGFXTR30                                                         
         CLC   AFCCURR,SAVCCUR                                                  
         JE    AGFXTR30                                                         
         MVC   XTRFCUR,AFCCURR                                                  
                                                                                
         ZAP   EDDUB,AFCAMNT       Foreign cur                                  
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFXTR38                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFXTR38 GOTO1 =V(SETAMNT),DMCB,AFCCURR,(L'XTRFCAM,XTRFCAM)                     
         CP    AFCAMNT,PZERO                                                    
         JE    AGFXTR30                                                         
         OI    SAV_TIND,SAV_TICQ                                                
         J     AGFXTR30                                                         
                                                                                
         USING APEELD,R2                                                        
AGFXTR40 XR    R1,R1                                                            
         ICM   R1,1,APENUM         Any sub elements                             
         JZ    AGFXTR30            No                                           
         LA    RE,APENTRY                                                       
EL       USING APENTRY,RE                                                       
AGFXTR42 LA    RF,APETAB                                                        
AGFXTR44 CLI   0(RF),X'FF'         End of table                                 
         JE    AGFXTR48            Yes - skip putting out account               
         CLC   EL.APENACT(L'PRODUL),0(RF)  Does unit ledger match               
         JE    AGFXTR46            Yes                                          
         LA    RF,APETABL(RF)      No - go to next entry in table               
         J     AGFXTR44                                                         
                                                                                
AGFXTR46 LH    R5,2(RF)                                                         
         AR    R5,R3               R5=A(Output field)                           
         LLC   RF,EL.APENLEN                                                    
         SHI   RF,APELN2Q+1        RF=length of unit ledger account             
         MVC   0(0,R5),EL.APENACT  Extract data to output field                 
         EX    RF,*-6                                                           
AGFXTR48 LLC   RF,EL.APENLEN       Bump RE to next sub element entry            
         AR    RE,RF                                                            
         JCT   R1,AGFXTR42         Decrement sub element count                  
         J     AGFXTR30                                                         
                                                                                
         USING SCIELD,R2                                                        
AGFXTR50 DS    0H                                                               
         CLI   SCITYPE,SCITMILE    Miles?                                       
         JE    AGFXTR54                                                         
*&&UK                                                                           
         CLI   SCITYPE,SCITMEXP    Memo amount?                                 
         JNE   AGFXTR30                                                         
*&&                                                                             
                                                                                
*&&US                                                                           
         CLI   SCITYPE,SCITSJXP    Memo amount?                                 
         JNE   AGFXTR30                                                         
*&&                                                                             
                                                                                
         ZAP   EDDUB,SCIAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFXTR52                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFXTR52 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'XTRFMAM,XTRFMAM)                     
                                                                                
         J     AGFXTR30                                                         
                                                                                
AGFXTR54 ZAP   EDDUB,SCIAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFXTR56                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFXTR56 DS    0H                                                               
*&&UK                                                                           
         CURED EDDUB,(L'XTRFMILE,XTRFMILE),0,ALIGN=LEFT,               +        
               MODADDR=CUREDIT                                                  
*&&                                                                             
*&&US                                                                           
         CURED EDDUB,(L'XTRFMILE,XTRFMILE),1,ALIGN=LEFT,               +        
               MODADDR=CUREDIT                                                  
*&&                                                                             
         J     AGFXTR30                                                         
                                                                                
         USING FFTELD,R2                                                        
AGFXTR60 CLI   FFTTYPE,FFTTCLPR    Client product                               
         JNE   AGFXTR30                                                         
         CLC   TEMPSTOR(L'ACTKACT),GSPACES    Did we find a client              
         JH    AGFXTR30                         previously                      
         CLI   FFTLN,FFTLN1Q+1                                                  
         JNH   AGFXTR30                                                         
         LLC   R1,FFTDLEN                                                       
         BCTR  R1,0                                                             
         MVC   TEMPSTOR(0),FFTDATA                                              
         EX    R1,*-6                                                           
         J     AGFXTR30                                                         
                                                                                
AGFXTR80 MVC   FULL(2),DUB                                                      
         GOTO1 =V(CHKDATE),DMCB,(2,FULL)                                        
         GOTO1 =V(DATCON),DMCB,(2,FULL),(1,DUB)                                 
                                                                                
         CLC   TEMPSTOR(L'ACTKACT),GSPACES    Did we find a client              
         JNH   AGFXTRN             No - therefore no client summary rec         
                                                                                
         USING TRNELD,R2                                                        
         LA    R2,TRNRFST                                                       
*&&UK                                                                           
         CLI   TRNTYPE,TRNTNBIN                                                 
         JE    *+12                                                             
         CLI   TRNTYPE,TRNTNBCH                                                 
*&&                                                                             
*&&US                                                                           
         CLI   TRNTYPE,10                                                       
*&&                                                                             
         JNE   AGFXTRN                                                          
OB       USING OB_D,OBTTAREA                                                    
         LA    R0,OBTTAREA                                                      
         LHI   R1,OB_LNQ-1                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   OB.OB_LEN,=AL2(OB_CSLNQ)                                         
         MVI   OB.OB_KTYP,OB_KTYPQ                                              
         MVC   OB.OB_KMOA,SAVMOS                                                
         MVC   OB.OB_KOFF,TRNOFFC                                               
         MVC   OB.OB_KCLI,GSPACES                                               
         LLC   R1,CLILEN                                                        
         BCTR  R1,0                                                             
         MVC   OB.OB_KCLI(0),TEMPSTOR                                           
         EX    R1,*-6                                                           
         MVC   OB.OB_KAGY,XTRFAGY                                               
                                                                                
         ZAP   OB.OB_EHRS,PZERO                                                 
         ZAP   OB.OB_ESTA,PZERO                                                 
         ZAP   OB.OB_BHRS,PZERO                                                 
         ZAP   OB.OB_NHRS,PZERO                                                 
         ZAP   OB.OB_AHRS,PZERO                                                 
         ZAP   OB.OB_NEXA,TRNAMNT                                               
         ZAP   OB.OB_BILD,PZERO                                                 
                                                                                
         CLI   DXACTION,C'D'       If action is delete need to subtract         
         JNE   AGFXTR82             so multiply by minus one                    
         MP    OB.OB_NEXA,PMONE                                                 
                                                                                
AGFXTR82 GOTOR =V(CLIREC),OB.OB_D                                               
         DROP  OB                                                               
                                                                                
AGFXTRN  NI    PROCMODE,FFQ-PROCBNQ      indicate no more to come               
         MVI   DMCB+8,RETBNMQ                                                   
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
AGFXTRLT DC    A(LITERAL)                                                       
XORDDUMY DC    CL6'DUMMY'                                                       
CUREDIT  DC    V(CUREDIT)                                                       
APETAB   DS    0X                                                               
         DC    CL2'2P',AL2(XTRF2PA-AGXRECD)                                     
APETABL  EQU   *-APETAB                                                         
         DC    CL2'2D',AL2(XTRF2DA-AGXRECD)                                     
         DC    CL2'1C',AL2(XTRF1CA-AGXRECD)                                     
         DC    CL2'SJ',AL2(XTRFSJA-AGXRECD)                                     
         DC    CL2'SV',AL2(XTRFSVA-AGXRECD)                                     
         DC    CL2'SX',AL2(XTRFSXA-AGXRECD)                                     
*&&US*&& DC    CL2'SY',AL2(XTRFSYA-AGXRECD)                                     
*&&US*&& DC    CL2'SW',AL2(XTRFSYA-AGXRECD)                                     
         DC    CL2'SG',AL2(XTRFSGA-AGXRECD)                                     
         DC    CL2'SQ',AL2(XTRFSQA-AGXRECD)                                     
*&&US*&& DC    CL2'SB',AL2(XTRFSBA-AGXRECD)                                     
         DC    CL2'SC',AL2(XTRFSCA-AGXRECD)                                     
APETABX  DC    X'FF'                                                            
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXORDC - Extract order dimension data                              *         
***********************************************************************         
                                                                                
AGXORDC  NMOD1 WORKX-WORKD,*AGXORD*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXORDLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ORDRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ORDDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXORDDQ                                                
         TM    PROCMOD2,PROCSFQ    Skip if sequentials and load mode            
         JNZ   AGXORD02                                                         
         TM    PROCMODE,PROCMLQ                                                 
         JNZ   AGXORD02                                                         
         TM    ORDRSTA2,ORDSEXEX   =Order order?                                
         JZ    AGXORD02                                                         
         MVC   AGXRETYP,AGXORDSQ                                                
                                                                                
AGXORD02 XC    SAVORD(SAVORDLQ),SAVORD                                          
                                                                                
*&&UK*&& MVC   ORDDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ORDDAGY(2),NORTHAM                                               
         MVI   ORDDAGY+2,UNDSCQ                                                 
         MVC   ORDDAGY+2+1(2),SAVCALP                                           
*        MVC   ORDDOID,ORDKORD                                                  
         MVC   ORDDNUM,ORDKORD                                                  
         MVC   ORDDREQ,GSPACES                                                  
         MVC   SAVOCUR,SAVCCUR                                                  
         MVC   SAVOORD,ORDKORD                                                  
         MVC   SAVOEWC,GSPACES                                                  
         ZAP   SAVOAMT,PZERO                                                    
                                                                                
         GOTOR =V(SETACTV),0                                                    
*11aug???MVC   WORK,ORDDUTS                                                     
         MVC   ORDDUTS,WORK                                                     
                                                                                
         MVC   SAVOOFF,ORDROFF                                                  
         MVC   SAVOETY,ORDREXTY                                                 
                                                                                
         USING ORDELD,R2                                                        
AGXORD04 LA    R2,ORDRFST                                                       
         MVI   SAVOALL,0                                                        
         XC    TEMPSTOR,TEMPSTOR   Used for approver PIDs                       
         MVI   SAVOEXT,FALSEQ      BrandOcean/Aura order?                       
         TM    ORDRSTA2,ORDSEXEX                                                
         JZ    AGXORD06                                                         
         MVI   SAVOEXT,YESQ                                                     
                                                                                
AGXORD06 SAM31 ,                                                                
         CLI   DXMODE,DXLOADQ      For load use BUFFER                          
         JE    AGXORD08                                                         
         TM    PROCMOD2,PROCMRQ    Also in 'multiple records' mode              
         JZ    AGXORD09                                                         
                                                                                
AGXORD08 L     R2,ABUFFER                                                       
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AGXORD09                                                         
         L     R2,ABUFOLD                                                       
                                                                                
AGXORD09 STCM  R2,B'1111',SAVO1ST                                               
                                                                                
AGXORD10 CLI   ORDEL,OAMELQ                                                     
         JE    AGXORD14                                                         
         CLI   ORDEL,ORDELQ                                                     
         JE    AGXORD15                                                         
         CLI   ORDEL,SPAELQ                                                     
         JE    AGXORD28                                                         
         CLI   ORDEL,SORELQ                                                     
         JE    AGXORD30                                                         
         CLI   ORDEL,PIDELQ                                                     
         JE    AGXORD31                                                         
         CLI   ORDEL,OATELQ                                                     
         JE    AGXORD34                                                         
         CLI   ORDEL,ENMELQ                                                     
         JE    AGXORD36                                                         
         CLI   ORDEL,SCMELQ                                                     
         JE    AGXORD40                                                         
         CLI   ORDEL,FFTELQ                                                     
         JE    AGXORD56                                                         
         CLI   ORDEL,AFCELQ                                                     
         JE    AGXORD60                                                         
         CLI   ORDEL,RACELQ                                                     
         JE    AGXORD62                                                         
         CLI   ORDEL,0                                                          
         JE    AGXORD70                                                         
                                                                                
AGXORD12 LLC   R1,ORDLN                                                         
         AR    R2,R1                                                            
         J     AGXORD10                                                         
                                                                                
         USING OAMELD,R2                                                        
AGXORD14 LLC   R1,SAVOALL                                                       
         AHI   R1,1                                                             
         STC   R1,SAVOALL                                                       
         MVC   SAVOINUM,OAMINUM Saved Number of Invoices                        
         OI    SAVOIND,SAVOIOAQ                                                 
         AP    SAVOAMT,OAMAMNT   add ordered amount                             
         SP    SAVOAMT,OAMIVAL   subtract what has been invoiced                
         J     AGXORD12                                                         
                                                                                
         USING ORDELD,R2                                                        
AGXORD15 MVC   SAVCPID,ORDCPID     Raiser pid                                   
         MVI   ORDDTYP,PRODORDQ                                                 
         CLI   ORDSUPL,STLDGQ      Skip artist orders                           
         JE    AGXORD16                                                         
         CLI   ORDSUPL,SKLDGQ      Skip internal orders                         
         JE    AGXORD16                                                         
         CLI   ORDSUPL,SILDGQ                                                   
         JE    AGXORD16                                                         
         CLC   ORDACCU(2),PRODUL                                                
         JE    AGXORD17                                                         
         MVC   SAVOEXP,ORDACCU                                                  
         MVI   ORDDTYP,EXPORDQ                                                  
         J     AGXORD18                                                         
                                                                                
AGXORD16 DS    0H                                                               
         SAM24 ,                                                                
         J     AGXORDN                                                          
                                                                                
AGXORD17 MVC   SAVOCPJ,ORDACCA                                                  
                                                                                
AGXORD18 OI    SAVOIND,SAVOIORQ                                                 
         MVC   SAVODAT,ORDDATE                                                  
         CLI   SAVOEXT,YESQ                                                     
         JNE   AGXORD19                                                         
         MVC   SAVODUE,ORDRQBD     (same name but diff location US/UK)          
                                                                                
AGXORD19 CLC   ORDSUPA,GSPACES     (make a/c for U/L only empty)                
         JNH   AGXORD20                                                         
         MVC   SAVOSUP,ORDSUPU                                                  
                                                                                
AGXORD20 MVI   ORDDMST,ONONEMQ                                                  
         CLI   ORDLN,ORDSTAT-ORDELD                                             
         JL    AGXORD21                                                         
         TM    ORDSTAT,ORDSPART                                                 
         JZ    AGXORD21                                                         
         TM    ORDRSTAT,ORDCLOSE                                                
         JNZ   AGXORD21                                                         
         MVI   ORDDMST,OPARTMQ     part matched                                 
                                                                                
AGXORD21 TM    ORDRSTAT,ORDSFMCH+ORDCLOSE                                       
         JZ    AGXORD22                                                         
         MVI   ORDDMST,OFMOCLQ     fully matched or closed                      
                                                                                
AGXORD22 MVI   ORDDAST,OFULAPPQ    default                                      
         TM    ORDRSTAT,ORDSLDEL                                                
         JZ    AGXORD24                                                         
         MVI   ORDDAST,ODELETEQ    unless deleted                               
         J     AGXORD12                                                         
                                                                                
AGXORD24 CLI   ORDLN,ORDSTAT2-ORDELD                                            
         JL    AGXORD12                                                         
         LA    RE,OSTATAB                                                       
         MVC   BYTE,ORDSTAT2                                                    
*&&UK*&& NI    BYTE,FFQ-(ORDGDRCV+ORDSEXEX+ORDSSTAT)                            
*&&US*&& NI    BYTE,FFQ-(ORDGDRCV+ORDSEXEX+ORDSSTAT) (was X'04')?|              
AGXORD26 CLI   0(RE),FFQ                                                        
         JE    AGXORD12                                                         
         CLC   BYTE,1(RE)                                                       
         JE    AGXORD27                                                         
         AHI   RE,2                                                             
         J     AGXORD26                                                         
                                                                                
AGXORD27 MVC   ORDDAST,0(RE)                                                    
         J     AGXORD12                                                         
                                                                                
         USING SPAELD,R2                                                        
AGXORD28 CLI   SPATYPE,SPATDEPT                                                 
         JNE   AGXORD29                                                         
         MVC   SAVO2DA(2),TDUL                                                  
         MVC   SAVO2DA+2(12),SPAAACT                                            
         J     AGXORD12                                                         
                                                                                
AGXORD29 CLI   SPATYPE,SPATPERS                                                 
         JNE   AGXORD12                                                         
         MVC   SAVO2PA(2),TPUL                                                  
         MVC   SAVO2PA+2(12),SPAAACT                                            
         J     AGXORD12                                                         
                                                                                
         USING SORELD,R2                                                        
AGXORD30 CLI   SORSYS,SORSACC                                                   
         JNE   AGXORD12                                                         
         CLC   SORAULA(2),PRODUL                                                
         JNE   AGXORD12                                                         
         MVC   SAVOCPJ,SORAACT                                                  
         J     AGXORD12                                                         
                                                                                
         USING PIDELD,R2                                                        
AGXORD31 LA    RF,TEMPSTOR                                                      
                                                                                
AGXORD32 OC    0(L'PIDNO+1,RF),0(RF)                                            
         JZ    AGXORD33                                                         
         AHI   RF,L'PIDNO+1                                                     
         J     AGXORD32                                                         
                                                                                
AGXORD33 LLC   RE,PIDNTR#                                                       
         LA    R1,PIDNTRS                                                       
                                                                                
NTRY     USING PIDNTRS,R1                                                       
AGXORD3A MVC   0(L'PIDNO,RF),NTRY.PIDNTRS+1                                     
         MVC   L'PIDNO(1,RF),PIDTYPE                                            
         AHI   RF,L'PIDNO+1                                                     
         AHI   R1,L'PIDNTRS                                                     
         JCT   RE,AGXORD3A                                                      
         J     AGXORD12                                                         
         DROP  NTRY                                                             
                                                                                
         USING OATELD,R2                                                        
AGXORD34 CLI   OATSUB,OATSUB5Q                                                  
         JNE   AGXORD12                                                         
         LLC   R1,OATLN                                                         
         SHI   R1,OATDABOX-OATELD                                               
         CHI   R1,0                                                             
         JNH   AGXORD12                                                         
         SHI   R1,1                                                             
         CHI   R1,L'ORDDDAD-1                                                   
         JNH   AGXORD35                                                         
         LHI   R1,L'ORDDDAD-1                                                   
                                                                                
AGXORD35 MVC   ORDDDAD(0),OATDABOX                                              
         EX    R1,*-6                                                           
         J     AGXORD12                                                         
                                                                                
         USING ENMELD,R2                                                        
AGXORD36 CLI   ENMLN,ENMLNQ                                                     
         JNH   AGXORD12                                                         
         LLC   R1,ENMLN                                                         
         SHI   R1,ENMLNQ+1                                                      
         CHI   R1,L'ORDDNAM-1                                                   
         JNH   AGXORD38                                                         
         LHI   R1,L'ORDDNAM-1                                                   
                                                                                
AGXORD38 MVC   ORDDNAM(0),ENMNAME                                               
         EX    R1,*-6                                                           
         J     AGXORD12                                                         
                                                                                
         USING SCMELD,R2                                                        
AGXORD40 CLI   SCMTYPE,SCMTSTND    Printed description from here                
         JNE   AGXORD42                                                         
         CLI   SCMSEQ,0                                                         
         JNE   AGXORD12                                                         
         LLC   R1,SCMLN                                                         
         SHI   R1,SCMLN1Q+1                                                     
         CHI   R1,L'ORDDPDE-1                                                   
         JNH   AGXORD41                                                         
         LHI   R1,L'ORDDPDE-1                                                   
                                                                                
AGXORD41 MVC   ORDDPDE(0),SCMNARR                                               
         EX    R1,*-6                                                           
         J     AGXORD12                                                         
                                                                                
AGXORD42 CLC   ORDDPDE,GSPACES     Resolved already?                            
         JH    AGXORD12                                                         
         CLI   SCMTYPE,SCMTOPDX    Still ok to leave this in?                   
         JNE   AGXORD44                                                         
         CLI   SCMLN,SCMNARR-SCMELD                                             
         JNH   AGXORD12                                                         
         LLC   R1,SCMLN                                                         
         SHI   R1,SCMTBOX-SCMELD+1                                              
         CHI   R1,L'ORDDPDE-1                                                   
         JNH   AGXORD43                                                         
         LHI   R1,L'ORDDPDE-1                                                   
                                                                                
AGXORD43 MVC   ORDDPDE(0),SCMNARR                                               
         EX    R1,*-6                                                           
         J     AGXORD12                                                         
                                                                                
AGXORD44 CLI   SCMTYPE,SCMTOMOC                                                 
         JNE   AGXORD50                                                         
         CLI   SCMLN,SCMNARR-SCMELD                                             
         JNH   AGXORD12                                                         
         LLC   R1,SCMLN                                                         
         SHI   R1,SCMNARR-SCMELD+1                                              
         CHI   R1,L'ORDDMDE-1                                                   
         JNH   AGXORD46                                                         
         LHI   R1,L'ORDDMDE-1                                                   
                                                                                
AGXORD46 MVC   ORDDMDE(0),SCMNARR                                               
         EX    R1,*-6                                                           
         J     AGXORD12                                                         
                                                                                
AGXORD50 DS    0H                                                               
*        CLI   SCMTYPE,SCMTPRBD                                                 
*        JNE   AGXORD54                                                         
*        CLI   SCMLN,SCMNARR-SCMELD                                             
*        JNH   AGXORD12                                                         
*        LLC   R1,SCMLN                                                         
*        SHI   R1,SCMNARR-SCMELD+1                                              
*        CHI   R1,L'ORDDHDR-1                                                   
*        JNH   AGXORD52                                                         
*        LHI   R1,L'ORDDHDR-1                                                   
*                                                                               
*GXORD52 MVC   ORDDHDR(0),SCMNARR                                               
*        EX    R1,*-6                                                           
*        J     AGXORD12                                                         
*                                                                               
*GXORD54 CLI   SCMTYPE,SCMTPRAD                                                 
*        JNE   AGXORD12                                                         
*        CLI   SCMLN,SCMNARR-SCMELD                                             
*        JNH   AGXORD12                                                         
*        LLC   R1,SCMLN                                                         
*        SHI   R1,SCMNARR-SCMELD+1                                              
*        CHI   R1,L'ORDDFTR-1                                                   
*        JNH   AGXORD55                                                         
*        LHI   R1,L'ORDDFTR-1                                                   
*                                                                               
*GXORD55 MVC   ORDDFTR(0),SCMNARR                                               
*        EX    R1,*-6                                                           
         J     AGXORD12                                                         
                                                                                
         USING FFTELD,R2                                                        
AGXORD56 CLI   FFTTYPE,FFTTORNO                                                 
         JNE   AGXORD57                                                         
         MVC   ORDDREQ+0(1),SAVCRQNP                                            
         MVC   ORDDREQ+1(6),FFTDATA                                             
         MVC   ORDDREQ+7(1),SAVCRQNS                                            
         J     AGXORD12                                                         
                                                                                
AGXORD57 CLI   FFTTYPE,FFTTWRKC                                                 
         JNE   AGXORD58                                                         
         MVC   SAVOEWC,FFTDATA                                                  
         J     AGXORD12                                                         
                                                                                
AGXORD58 CLI   FFTTYPE,FFTTSATN                                                 
         JNE   AGXORD12                                                         
         LLC   R1,FFTDLEN                                                       
         SHI   R1,1                                                             
         CR    R1,R1                                                            
         JM    AGXORD12                                                         
         CHI   R1,L'ORDDATT-1                                                   
         JNH   AGXORD59                                                         
         LHI   R1,L'ORDDATT-1                                                   
                                                                                
AGXORD59 MVC   ORDDATT(0),FFTDATA                                               
         EX    R1,*-6                                                           
         J     AGXORD12                                                         
                                                                                
         USING AFCELD,R2                                                        
AGXORD60 CLC   AFCCURR,GSPACES                                                  
         JNH   AGXORD12                                                         
         CLC   AFCCURR,SAVCCUR                                                  
         JE    AGXORD12                                                         
         MVC   SAVOCUR,AFCCURR                                                  
                                                                                
         GOTOR SETEUR,AFCELD                                                    
         ZAP   DUB,PZERO                                                        
         MVO   DUB,AFCXRATE                                                     
         TM    AFCXSTAT,AFCXSDIV                                                
         JZ    AGXORD61                                                         
         ZAP   PL16,PONE                                                        
         MP    PL16,=P'100000000000'                                            
         DP    PL16,DUB                                                         
         SRP   PL16(8),64-1,5                                                   
         ZAP   DUB,PL16(8)                                                      
                                                                                
AGXORD61 EDITR (P8,DUB),(L'ORDDEXR,ORDDEXR),5,ALIGN=LEFT                        
         J     AGXORD12                                                         
                                                                                
         USING RACELD,R2                                                        
AGXORD62 CLC   RACDATE(L'RACDATE+L'RACTIME),SAVOACT                             
         JL    AGXORD63                                                         
         MVC   SAVOACT,RACDATE                                                  
                                                                                
AGXORD63 OC    SAVODAT,SAVODAT                                                  
         JNZ   AGXORD12                                                         
         CLI   RACTYPE,RACTADD                                                  
         JNE   AGXORD12                                                         
         MVC   SAVODAT,RACDATE                                                  
         J     AGXORD12                                                         
*15AUG - see above, obs here:                                                   
**11AUG - move here from ORD2:                                                  
*         USING SCMELD,R2                                                       
*AGXORD64 CLI   SCMTYPE,SCMTOPDX                                                
*         JNE   AGXORD65                                                        
*         CLI   SCMLN,SCMNARR-SCMELD                                            
*         JNH   AGXORD12                                                        
*         LLC   R1,SCMLN                                                        
*         SHI   R1,SCMTBOX-SCMELD+1                                             
*         CHI   R1,L'ORDDPDE-1                                                  
*         JNH   AGXORD24                                                        
*         LHI   R1,L'ORDDPDE-1                                                  
*                                                                               
*AGXORD65 MVC   ORDDPDE(0),SCMNARR                                              
*         EX    R1,*-6                                                          
*         J     AGXORD12                                                        
*                                                                               
*AGXORD66 CLI   SCMTYPE,SCMTOMOC                                                
*         JNE   AGXORD12                                                        
*         CLI   SCMLN,SCMNARR-SCMELD                                            
*         JNH   AGXORD12                                                        
*         LLC   R1,SCMLN                                                        
*         SHI   R1,SCMNARR-SCMELD+1                                             
*         CHI   R1,L'ORDDMDE-1                                                  
*         JNH   AGXORD68                                                        
*         LHI   R1,L'ORDDMDE-1                                                  
*                                                                               
*AGXORD68 MVC   ORDDMDE(0),SCMNARR                                              
*         EX    R1,*-6                                                          
*         J     AGXORD12                                                        
*         DROP  R2                            SCMELD                            
**11AUG - above here from ORD2                                                  
*15AUG - Now back see AGXORD40 ff...                                            
                                                                                
AGXORD70 DS    0H                                                               
         SAM24 ,                                                                
                                                                                
         CLI   ORDDTYP,EXPORDQ     Only want expense orders                     
         JNE   AGXORD7B                                                         
         CLC   SAVOCPJ,GSPACES      that quote a client                         
         JNH   AGXORD7B                                                         
         TM    ORDRSTA2,ORDSAPPR   Orders must be approved                      
         JZ    AGXORD7B                                                         
         TM    ORDRSTAT,ORDSFMCH    but not fully matched                       
         JNZ   AGXORD7B                                                         
         TM    ORDRSTAT,ORDCLOSE     or closed                                  
         JNZ   AGXORD7B                                                         
         TM    ORDRSTAT,ORDSLDEL      or logically deleted                      
         JNZ   AGXORD7B                                                         
OB       USING OB_D,OBTTAREA                                                    
         LA    R0,OBTTAREA                                                      
         LHI   R1,OB_LNQ-1                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   OB.OB_LEN,=AL2(OB_CSLNQ)                                         
         MVI   OB.OB_KTYP,OB_KTYPQ                                              
         MVC   OB.OB_KMOA,SAVODAT                                               
         MVC   OB.OB_KOFF,SAVOOFF                                               
         MVC   OB.OB_KCLI,GSPACES                                               
         LLC   R1,CLILEN                                                        
         BCTR  R1,0                                                             
         MVC   OB.OB_KCLI(0),SAVOCPJ                                            
         EX    R1,*-6                                                           
         MVC   OB.OB_KAGY,ORDDAGY                                               
                                                                                
         ZAP   OB.OB_EHRS,PZERO                                                 
         ZAP   OB.OB_BILD,PZERO                                                 
         ZAP   OB.OB_ESTA,PZERO                                                 
         ZAP   OB.OB_BHRS,PZERO                                                 
         ZAP   OB.OB_NHRS,PZERO                                                 
         ZAP   OB.OB_AHRS,PZERO                                                 
         ZAP   OB.OB_NEXA,SAVOAMT                                               
                                                                                
         CLI   DXACTION,C'D'       If action is delete need to subtract         
         JNE   AGXORD7A             so multiply by minus one                    
         MP    OB.OB_NEXA,PMONE                                                 
                                                                                
AGXORD7A GOTOR =V(CLIREC),OB.OB_D                                               
         DROP  OB                                                               
                                                                                
AGXORD7B OC    SAVOINUM,SAVOINUM   Test if we have number of invoices           
         JNZ   *+10                                                             
         ZAP   SAVOINUM,PZERO      No!!!                                        
         EDITR (P6,SAVOINUM),(L'ORDNOINV,ORDNOINV),0,ZERO=NOBLANK,     +        
               ALIGN=LEFT                                                       
                                                                                
         GOTO1 =V(GETSPD),SAVCPID                                               
         MVC   ORDORC,WORK+100           PID                                    
         MVC   ORDORFNM,WORK+00          First name                             
         MVC   ORDORMNM,WORK+32          Middle name                            
         MVC   ORDORLNM,WORK+16          Last name                              
                                                                                
         GOTOR INIWCA              Build accummulator from OAMELs               
                                                                                
         LA    R2,TEMPSTOR         process saved PINs                           
                                                                                
AGXORD71 OC    0(L'PIDNO+1,R2),0(R2)                                            
         JZ    AGXORD73                                                         
         LA    R5,ORDDA11C         match on type=slot                           
         CLI   L'PIDNO(R2),PIDT1Q                                               
         JE    AGXORD72                                                         
         LA    R5,ORDDA21C                                                      
         CLI   L'PIDNO(R2),PIDT2Q                                               
         JE    AGXORD72                                                         
         LA    R5,ORDDA31C                                                      
         CLI   L'PIDNO(R2),PIDT3Q                                               
         JE    AGXORD72                                                         
         LA    R5,ORDDA41C                                                      
         CLI   L'PIDNO(R2),PIDT4Q                                               
         JE    AGXORD72                                                         
         J     AGXORD7E            (skip if unknown)                            
                                                                                
AGXORD72 CLC   0(L'ORDDA11C,R5),GSPACES  1st slot?                              
         JNH   AGXORD7D                                                         
         AHI   R5,ORDDA12C-ORDDA11C      2nd slot if 1st set already            
         CLC   0(L'ORDDA11C,R5),GSPACES                                         
         JH    AGXORD7E                  (skip if both used already)            
                                                                                
AGXORD7D GOTO1 =V(GETSPD),(R2)                                                  
         MVC   0(L'ORDDA11C,R5),WORK+100 PID                                    
         AHI   R5,ORDDA11F-ORDDA11C                                             
         MVC   0(L'ORDDA11F,R5),WORK+00  First name                             
         AHI   R5,ORDDA11M-ORDDA11F                                             
         MVC   0(L'ORDDA11M,R5),WORK+32  Middle name                            
         AHI   R5,ORDDA11L-ORDDA11M                                             
         MVC   0(L'ORDDA11L,R5),WORK+16  Last name                              
                                                                                
AGXORD7E AHI   R2,L'PIDNO+1                                                     
         J     AGXORD71                                                         
                                                                                
AGXORD73 DS    0H                                                               
***      CLC   SAVOCPJ,GSPACES                                                  
***      JNH   AGXORDN                                                          
                                                                                
         TM    SAVOIND,SAVOIOAQ+SAVOIORQ                                        
         JNO   AGXORDN             Data integrity check                         
                                                                                
         MVI   ORDDIGR,FALSEQ                                                   
         TM    ORDRSTAT,ORDGDRCV                                                
         JZ    AGXORD74                                                         
         MVI   ORDDIGR,TRUEQ                                                    
                                                                                
AGXORD74 MVI   SAVOMOD,OAMELQ      Default is OAMEL mode                        
         MVI   SAVOCNT,0                                                        
                                                                                
         CLI   SAVOEXT,YESQ        BrandOcean/Aura order?                       
         JNE   AGXORDX                                                          
                                                                                
         USING ODBUFFD,R5                                                       
         L     R5,AODBUF           build order details buffer                   
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AGXORD75                                                         
         L     R5,AODOBUF                                                       
                                                                                
AGXORD75 XC    ODBKEY,ODBKEY                                                    
                                                                                
         LHI   R1,ODBMAXQ                                                       
         STH   R1,HALF                                                          
                                                                                
         USING SCMELD,R2                                                        
         SAM31 ,                                                                
         L     R2,ABUFFER                                                       
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AGXORD76                                                         
         L     R2,ABUFOLD                                                       
                                                                                
AGXORD76 CLI   SCMEL,0             end of buffer?                               
         JE    AGXORD86                                                         
         CLI   SCMEL,SCMELQ                                                     
         JE    AGXORD78                                                         
         CLI   SCMEL,ARTELQ                                                     
         JE    AGXORD82                                                         
         CLI   SCMEL,ATXELQ                                                     
         JE    AGXORD84                                                         
                                                                                
AGXORD77 LLC   R1,SCMLN                                                         
         AR    R2,R1                                                            
         J     AGXORD76                                                         
                                                                                
AGXORD78 TM    SCMTYPE,SCMTSANP                                                 
         JZ    AGXORD77                                                         
         MVC   ODBKSEQ,SCMSEQ                                                   
         MVC   ODBKWC,SCMWCOD                                                   
         OC    ODBKWC,GSPACES                                                   
         MVC   ODBKSUB,SCMSSEQ                                                  
         MVI   ODBKELE,SCMELQ                                                   
                                                                                
AGXORD80 STCM  R2,B'1111',ODBADR                                                
         AHI   R5,ODBLENQ                                                       
         XC    ODBKEY,ODBKEY                                                    
         LH    R1,HALF                                                          
         SHI   R1,1                                                             
         CHI   R1,0                                                             
         JE    *+2                 increase ODBMAXQ                             
         STH   R1,HALF                                                          
         J     AGXORD77                                                         
                                                                                
         USING ARTELD,R2                                                        
AGXORD82 CLI   ARTLN,ARTLN3Q                                                    
         JL    AGXORD77                                                         
         MVC   ODBKSEQ,ARTWSQN                                                  
         MVC   ODBKWC,ARTWC                                                     
         CLC   ARTWC,GSPACES       no w/c set then use expense order            
         JH    AGXORD83            w/c                                          
         MVC   ODBKWC,SAVOEWC                                                   
                                                                                
AGXORD83 MVC   ODBKSUB,ARTWSSN                                                  
         MVI   ODBKELE,ARTELQ                                                   
         J     AGXORD80                                                         
                                                                                
         USING ATXELD,R2                                                        
AGXORD84 MVC   ODBKSEQ,ATXWSQN                                                  
         MVC   ODBKWC,ATXWCOD                                                   
         CLC   ATXWCOD,GSPACES                                                  
         JH    AGXORD85                                                         
         MVC   ODBKWC,SAVOEWC                                                   
                                                                                
AGXORD85 MVC   ODBKSUB,ATXWSSN                                                  
         MVI   ODBKELE,ATXELQ                                                   
         J     AGXORD80                                                         
                                                                                
AGXORD86 DS    0H                                                               
         SAM24 ,                                                                
         MVI   SAVOMOD,FFQ                                                      
         LHI   R2,ODBMAXQ                                                       
         SH    R2,HALF                                                          
                                                                                
         L     R5,AODBUF                                                        
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AGXORD88                                                         
         L     R5,AODOBUF                                                       
                                                                                
AGXORD88 CHI   R2,1                article/work code entries?                   
         JL    AGXORD98                                                         
         JE    AGXORD90                                                         
                                                                                
         GOTOR OFIXWC              fix ARTEL/ATXEl missing work codes           
                                                                                
         GOTO1 =V(XSORT),DMCB,(R5),(R2),ODBLENQ,L'ODBKEY,0                      
                                                                                
AGXORD90 CLC   SAVOCUR,SAVCCUR     Skip for none currency orders, else          
         JE    AGXORD97            apply SCMELD/ARTELD logic                    
                                                                                
         XC    PREVODB,PREVODB                                                  
                                                                                
AGXORD91 CLI   ODBKELE,0           end reached?                                 
         JE    AGXORD97                                                         
         CLI   ODBKELE,ARTELQ      take any ARTEL                               
         JNE   AGXORD92                                                         
                                                                                
         ICM   R2,B'1111',ODBADR                                                
         GOTOR ADDWCA              (ARTELQ)                                     
         J     AGXORD95                                                         
                                                                                
AGXORD92 CLI   ODBKELE,SCMELQ      for every SCMEL check no ARTELs              
         JNE   AGXORD95                                                         
         LR    RF,R5                                                            
                                                                                
LOOK     USING ODBUFFD,RF                                                       
AGXORD93 AHI   RF,ODBLENQ                                                       
         CLI   LOOK.ODBKELE,0                                                   
         JE    AGXORD94                                                         
         CLC   LOOK.ODBCOMP,ODBCOMP                                             
         JNE   AGXORD94                                                         
         CLI   LOOK.ODBKELE,ARTELQ                                              
         JE    AGXORD95                                                         
         J     AGXORD93                                                         
         DROP  LOOK                                                             
                                                                                
AGXORD94 CLC   ODBCOMP,PREVODB     same SCMEL seq + wc then skip                
         JE    AGXORD95                                                         
         ICM   R2,B'1111',ODBADR                                                
         GOTOR ADDWCA              (SCMELQ)                                     
         MVC   PREVODB,ODBCOMP                                                  
                                                                                
AGXORD95 AHI   R5,ODBLENQ                                                       
         J     AGXORD91                                                         
                                                                                
AGXORD97 DS    0H                                                               
         J     AGXORDX                                                          
         DROP  R5                                                               
                                                                                
AGXORD98 MVI   SAVOMOD,OAMELQ      indicate OAMEL mode                          
         USING WCACUMD,R1                                                       
         SAM31 ,                                                                
         L     R1,AWCACUM          and clear accummulator as n/a                
         XC    WCACUMD(WCACLNQ),WCACUMD                                         
         SAM24 ,                                                                
         DROP  R1                                                               
                                                                                
AGXORDX  MVI   DMCB+8,RETBFFQ      indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGXORDN  MVI   DMCB+8,RETBNWQ      skip record                                  
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
         USING AFCELD,R2                                                        
         USING EURKBLKD,R3                                                      
SETEUR   NTR1  ,                   *** Eureka preliminary call ***              
         LA    R3,SAVOEUR                                                       
         LR    R2,R1                                                            
                                                                                
         XC    0(EURKBLKL,R3),0(R3)                                             
***      MVC   EURKCUFR,AFCCURR                                                 
***      MVC   EURKCUTO,SAVCCUR                                                 
         MVC   EURKCUFR,SAVCCUR                                                 
         MVC   EURKCUTO,AFCCURR                                                 
         MVC   EURKALPH,SAVCALP                                                 
         MVC   EURKDATE,TODAYC                                                  
         MVC   EURKAFAC,ACOMFAC                                                 
         MVI   EURKTYPE,ACCQ                                                    
         OI    EURKTYPE,ALLOWFTQ+SWAPQ                                          
         GOTO1 =V(EUREKA),DMCB,('GETQ',EURKBLKD)                                
         CLI   0(R1),0                                                          
         JE    SETEUR2                                                          
         XC    EURKRLRT,EURKRLRT                                                
         J     SETEURX                                                          
                                                                                
SETEUR2  MVC   EURKRULE,AFCX                                                    
                                                                                
SETEURX  DS    0H                                                               
         J     EXIT                                                             
         DROP  R2,R3                                                            
                                                                                
AGXORDLT DC    A(LITERAL)                                                       
                                                                                
OFIXWC   NTR1  ,                   *** Set missing ART/ATX w/cs ***             
                                                                                
         USING ODBUFFD,R5                                                       
         LR    R2,R5               save start of buffer                         
                                                                                
         CLC   SAVOEXP,GSPACES     not for expense orders, see SAVOEWC          
         JH    OFIXWCX                                                          
                                                                                
OFIXW02  CLI   ODBKELE,0           end of table - all done                      
         JE    OFIXWCX                                                          
         CLI   ODBKELE,ARTELQ                                                   
         JNE   OFIXW04                                                          
         CLC   ODBKWC,GSPACES                                                   
         JH    OFIXW20                                                          
         J     OFIXW10                                                          
                                                                                
OFIXW04  CLI   ODBKELE,ATXELQ                                                   
         JNE   OFIXW20                                                          
         CLC   ODBKWC,GSPACES                                                   
         JH    OFIXW20                                                          
                                                                                
SCM      USING ODBUFFD,RF                                                       
OFIXW10  LR    RF,R2               look for SCMEL entry from start              
                                                                                
OFIXW12  CLI   SCM.ODBKELE,0                                                    
         JE    OFIXW20             (cannot do anything here - die?)             
         CLI   SCM.ODBKELE,SCMELQ                                               
         JNE   OFIXW18                                                          
         CLC   SCM.ODBKSEQ,ODBKSEQ same sequence?                               
         JNE   OFIXW18                                                          
         MVC   ODBKWC,SCM.ODBKWC   set w/c to ODBUFFER                          
         ICM   R1,B'1111',ODBADR                                                
         LA    RE,ARTWC-ARTELD(R1) and into element                             
         CLI   ODBKELE,ARTELQ                                                   
         JE    OFIXW14                                                          
         LA    RE,ATXWCOD-ATXELD(R1)                                            
                                                                                
OFIXW14  MVC   0(L'ARTWC,RE),SCM.ODBKWC                                         
         J     OFIXW20                                                          
                                                                                
OFIXW18  AHI   RF,ODBLENQ                                                       
         J     OFIXW12                                                          
         DROP  SCM                                                              
                                                                                
OFIXW20  AHI   R5,ODBLENQ          next element                                 
         J     OFIXW02                                                          
                                                                                
OFIXWCX  DS    0H                                                               
         J     EXIT                                                             
         DROP  R5                                                               
                                                                                
         USING WCACUMD,R3                                                       
INIWCA   NTR1  ,                   *** Initialise W/C accummulator ***          
         SAM31 ,                                                                
                                                                                
         L     R3,AWCACUM          Clear accummulator                           
         XC    WCACUMD(WCACLNQ),WCACUMD                                         
         MVI   SAVOWCS,NOQ                                                      
                                                                                
         CLC   SAVOCUR,SAVCCUR     Skip for none currency orders                
         JE    INIWCAX                                                          
                                                                                
         USING AFCELD,R4                                                        
         ICM   R4,B'1111',SAVO1ST  Point to start                               
                                                                                
INIWCA1  CLI   AFCEL,0                                                          
         JE    *+2                                                              
         CLI   AFCEL,AFCELQ                                                     
         JE    INIWCA2                                                          
         LLC   R1,AFCLN                                                         
         AR    R4,R1                                                            
         J     INIWCA1                                                          
                                                                                
         USING OAMELD,R2                                                        
INIWCA2  ICM   R2,B'1111',SAVO1ST  Point to start                               
                                                                                
INIWCA3  CLI   OAMEL,0             Get main amounts                             
         JE    INIWCAB                                                          
         CLI   OAMEL,OAMELQ                                                     
         JE    INIWCA5                                                          
                                                                                
INIWCA4  LLC   R1,OAMLN                                                         
         AR    R2,R1                                                            
         J     INIWCA3                                                          
                                                                                
INIWCA5  MVC   TWOBYTES,SAVOEWC    Any real w/c or memo w/c?                    
         CLC   OAMWORK,GSPACES                                                  
         JNH   INIWCA6                                                          
         MVC   TWOBYTES,OAMWORK                                                 
                                                                                
INIWCA6  CLC   TWOBYTES,GSPACES                                                 
         JNH   INIWCA7                                                          
         MVI   SAVOWCS,YESQ                                                     
                                                                                
INIWCA7  L     R3,AWCACUM          Allow for duplicate w/cs                     
                                                                                
INIWCA8  OC    WCACWC,WCACWC                                                    
         JZ    INIWCAA                                                          
         CLC   WCACWC,TWOBYTES                                                  
         JNE   INIWCA9                                                          
         AP    WCACAGY,OAMAMNT                                                  
         J     INIWCA4                                                          
                                                                                
INIWCA9  AHI   R3,WCACLNQ                                                       
         J     INIWCA8                                                          
                                                                                
INIWCAA  MVC   WCACWC,TWOBYTES     Save work code and agency amount             
         ZAP   WCACAGY,OAMAMNT                                                  
         AHI   R3,WCACLNQ                                                       
         XC    WCACUMD(WCACLNQ),WCACUMD                                         
         L     R0,AWCACUM                                                       
         AHI   R0,WCACUML                                                       
         CR    R3,R0                                                            
         JL    INIWCA4                                                          
         J     *+2                 (increase WCACUM#)                           
         DROP  R2                                                               
                                                                                
INIWCAB  MVC   AFCTEMP,AFCELD                                                   
         DROP  R4                                                               
         SAM24 ,                                                                
         GOTOR SETEUR,AFCTEMP                                                   
         SAM31 ,                                                                
                                                                                
INIWCAX  DS    0H                                                               
         SAM24 ,                                                                
         J     EXIT                                                             
         DROP  R3                                                               
                                                                                
         USING WCACUMD,R3                                                       
ADDWCA   NTR1  ,                   *** Add to W/C accummulator ***              
                                                                                
         L     R3,AWCACUM                                                       
                                                                                
         USING ARTELD,R2                                                        
         CLI   ARTEL,ARTELQ        R2=A(element) incoming                       
         JNE   ADDWCA4                                                          
         MVC   TWOBYTES,ARTWC                                                   
         CLC   ARTWC,GSPACES       no w/c set then use expense order            
         JH    ADDWCA0             w/c                                          
         MVC   TWOBYTES,SAVOEWC                                                 
                                                                                
ADDWCA0  ZAP   PL16,ARTMULT                                                     
         CP    ARTMULT,PZERO                                                    
         JNE   ADDWCA1                                                          
         ZAP   PL16,P100                                                        
                                                                                
ADDWCA1  MP    PL16,ARTPRICE                                                    
         LHI   RF,2                                                             
         LCR   RF,RF                                                            
         SRP   PL16,0(RF),5                                                     
                                                                                
         ZAP   DUB,PL16                                                         
         CP    DUB,PZERO                                                        
         JE    ADDWCAX                                                          
         J     ADDWCA5                                                          
         DROP  R2                                                               
                                                                                
         USING SCMELD,R2                                                        
ADDWCA4  CLI   SCMEL,SCMELQ                                                     
         JNE   *+2                                                              
         MVC   TWOBYTES,SCMWCOD                                                 
         OC    TWOBYTES,GSPACES                                                 
         ZAP   DUB,SCMAMNT                                                      
         DROP  R2                                                               
                                                                                
         USING EURKBLKD,R6                                                      
ADDWCA5  LA    R6,SAVOEUR                                                       
         OC    EURKRLRT,EURKRLRT   Skip if GETQ error                           
         JZ    ADDWCAX                                                          
         MVC   WORK(EURKBLKL),SAVOEUR                                           
         LHI   R0,APPLYQ+INVERTQ                                                
         MVC   EURKCUFR,SAVCCUR                                                 
         MVC   EURKCUTO,SAVOCUR                                                 
                                                                                
         SAM24 ,                                                                
         GOTO1 =V(EUREKA),DMCB,((R0),EURKBLKD),DUB,EDDUB                        
         SAM31 ,                                                                
         MVC   SAVOEUR(EURKBLKL),WORK                                           
         CLI   0(R1),0                                                          
         JNE   ADDWCAX             Skip if error                                
         DROP  R6                                                               
                                                                                
ADDWCA6  OC    WCACWC,WCACWC       EDDUB into table for w/c in TWOBYTES         
         JZ    *+2                                                              
         CLC   WCACWC,TWOBYTES                                                  
         JE    ADDWCA8                                                          
         CLI   SAVOWCS,YESQ        (cater for MCSTST.E03299 scenario)           
         JE    ADDWCA7                                                          
         CLC   WCACWC,GSPACES      (put under GSPACES entry)                    
         JE    ADDWCA8                                                          
                                                                                
ADDWCA7  AHI   R3,WCACLNQ                                                       
         J     ADDWCA6                                                          
                                                                                
ADDWCA8  SP    WCACAGY,EDDUB                                                    
                                                                                
ADDWCAX  DS    0H                                                               
         J     EXIT                                                             
         DROP  R3                                                               
                                                                                
OSTATAB  DS    0H                                                               
         DC    AL1(OINPROGQ),AL1(ORDSDRFT)                                      
         DC    AL1(OSUBMITQ),AL1(ORDSSUBM)                                      
         DC    AL1(OPARTAPQ),AL1(ORDSPAPP)                                      
         DC    AL1(OFULAPPQ),AL1(ORDSAPPR)                                      
         DC    AL1(OREJECTQ),AL1(ORDSOREJ)                                      
         DC    AL1(FFQ)                                                         
                                                                                
OINPROGQ EQU   C'1'                                                             
OSUBMITQ EQU   C'2'                                                             
OPARTAPQ EQU   C'3'                                                             
OFULAPPQ EQU   C'4'                                                             
OREJECTQ EQU   C'5'                                                             
ODELETEQ EQU   C'6'                                                             
                                                                                
ONONEMQ  EQU   C'1'                                                             
OFMOCLQ  EQU   C'2'                                                             
OPARTMQ  EQU   C'3'                                                             
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGFORDC - Extract order fact data                                   *         
*                                                                     *         
* Note: There may be empty SCMTSANP/SCMAMNT elements which are used   *         
*       by Aura as a text buffer - no easy way to detect/skip them.   *         
***********************************************************************         
                                                                                
AGFORDC  NMOD1 WORKX-WORKD,*AGFORD*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGFORDLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ORDRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ORDFLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXORDFQ                                                
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ORDFCAM,ORDFCAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ORDFAMT,ORDFAMT)                     
                                                                                
         SAM31 ,                                                                
         LA    R2,ORDRFST                                                       
         CLI   SAVOEXT,YESQ                                                     
         JNE   AGFORD02                                                         
         L     R2,ABUFFER                                                       
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AGFORD02                                                         
         L     R2,ABUFOLD                                                       
                                                                                
AGFORD02 CLI   SAVOMOD,OAMELQ      OAMEL mode                                   
         JNE   AGFORD30                                                         
         XR    R0,R0                                                            
                                                                                
         USING OAMELD,R2                                                        
AGFORD10 CLI   OAMEL,OAMELQ                                                     
         JNE   AGFORD12                                                         
         CLM   R0,B'0001',SAVOCNT  This time this one?                          
         JE    AGFORD14                                                         
         AHI   R0,1                                                             
                                                                                
AGFORD12 CLI   OAMEL,0                                                          
         JE    *+2                 SAVOALL/SAVOCNT bug                          
                                                                                
         LLC   R1,OAMLN                                                         
         AR    R2,R1                                                            
         J     AGFORD10                                                         
                                                                                
AGFORD14 LLC   R1,SAVOCNT                                                       
         AHI   R1,1                                                             
         STC   R1,SAVOCNT                                                       
                                                                                
         JAS   RE,OFAINIT                                                       
                                                                                
         MVC   TWOBYTES,SAVOEWC                                                 
         CLC   OAMWORK,GSPACES                                                  
         JNH   AGFORD15                                                         
         MVC   TWOBYTES,OAMWORK                                                 
                                                                                
AGFORD15 MVC   ORDFWCD,TWOBYTES                                                 
                                                                                
         SAM24 ,                                                                
         EDITR (B1,SAVOCNT),(6,SAVOROW),0,ALIGN=LEFT,ZERO=NOBLANK               
         XC    FULL,FULL                                                        
         EDITR (B1,FULL),(6,SAVOSUB),0,ALIGN=LEFT,ZERO=NOBLANK                  
         SAM31 ,                                                                
                                                                                
*        EDITR (P6,OAMAMNT),(L'ORDFAMT-1,ORDFAMT+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,OAMAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFORD16                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFORD16 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ORDFAMT,ORDFAMT)                     
         SAM31 ,                                                                
                                                                                
AGFORD18 CLC   SAVOCUR,SAVCCUR                                                  
         JE    AGFORD22                                                         
         CLI   OAMLN,OAMLN3Q                                                    
         JL    AGFORD22                                                         
                                                                                
*        EDITR (P6,OAMFCAMT),(L'ORDFCAM-1,ORDFCAM+1),0,ZERO=NOBLANK,   *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,OAMFCAMT      Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFORD20                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFORD20 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVOCUR,(L'ORDFCAM,ORDFCAM)                     
         SAM31 ,                                                                
                                                                                
AGFORD22 DS    0H                                                               
         SAM24 ,                                                                
         CLC   SAVOCNT,SAVOALL     all done?                                    
         JNE   AGFORDXY                                                         
         J     AGFORDXN                                                         
                                                                                
AGFORD30 CLI   SAVOMOD,FFQ         SCMEL/ARTEL mode                             
         JNE   *+2                                                              
                                                                                
*        CLC   ORDKORD,=CL6'P08762' TKLUDEBUG                                   
*        JNE   *+6                                                              
*        XR    RE,RE                                                            
                                                                                
         USING ODBUFFD,R5                                                       
         L     R5,AODBUF                                                        
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AGFORD31                                                         
         L     R5,AODOBUF                                                       
                                                                                
AGFORD31 OC    SAVOADR,SAVOADR     First time?                                  
         JZ    AGFORD32                                                         
                                                                                
         ICM   R5,B'1111',SAVOADR  Get of next block                            
                                                                                
AGFORD32 GOTOR OFLKAHD             Find entry to process now                    
         OI    SAVOIND,SAVOINQ     (indicate not first time)                    
                                                                                
         TM    SAVOIND,SAVOIAQ     ARTELQ scenario                              
         JNZ   AGFORD50                                                         
         TM    SAVOIND,SAVOISQ     SCMELQ scenario                              
*&&UK*&& JZ    *+2                                                              
*&&US*&& JZ    AGFORDXS            US: temporary solution                       
                                                                                
         USING SCMELD,R2                                                        
         ICM   R2,B'1111',ODBADR                                                
         MVC   ORDFWCD,SCMWCOD                                                  
         OC    ORDFWCD,GSPACES                                                  
                                                                                
         JAS   RE,OFAINIT                                                       
                                                                                
         MVC   HALF+0(1),SCMSEQ                                                 
         MVC   HALF+1(1),SCMSSEQ                                                
         SAM24 ,                                                                
         EDITR (B1,HALF+0),(6,SAVOROW),0,ALIGN=LEFT,ZERO=NOBLANK                
         EDITR (B1,HALF+1),(6,SAVOSUB),0,ALIGN=LEFT,ZERO=NOBLANK                
         SAM31 ,                                                                
                                                                                
         CLC   SAVOCUR,SAVCCUR                                                  
         JE    AGFORD38                                                         
                                                                                
*        EDITR (P6,SCMAMNT),(L'ORDFCAM-1,ORDFCAM+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,SCMAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFORD33                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFORD33 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVOCUR,(L'ORDFCAM,ORDFCAM)                     
         SAM31 ,                                                                
                                                                                
         USING EURKBLKD,R6                                                      
AGFORD34 LA    R6,SAVOEUR          Calculate agency value via Eureka            
         MVC   WORK(EURKBLKL),SAVOEUR                                           
                                                                                
         OC    EURKRLRT,EURKRLRT   Skip if GETQ error                           
         JZ    AGFORD42                                                         
                                                                                
         ZAP   PL16+0(8),SCMAMNT                                                
         LHI   R0,APPLYQ+INVERTQ                                                
         MVC   EURKCUFR,SAVCCUR                                                 
         MVC   EURKCUTO,SAVOCUR                                                 
                                                                                
         SAM24 ,                                                                
         GOTO1 =V(EUREKA),DMCB,((R0),EURKBLKD),PL16+0,PL16+8                    
         SAM31 ,                                                                
         MVC   SAVOEUR(EURKBLKL),WORK                                           
         CLI   0(R1),0                                                          
         JNE   AGFORD42            Skip if error                                
         DROP  R6                                                               
                                                                                
         ZAP   DUB,PL16+8(8)                                                    
         MVC   TWOBYTES,SCMWCOD                                                 
         OC    TWOBYTES,GSPACES                                                 
         GOTOR GETWCA,TWOBYTES     Any diff from W/C accummulator?              
                                                                                
*        EDITR (P8,DUB),(L'ORDFAMT-1,ORDFAMT+1),0,ZERO=NOBLANK,        *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,DUB           Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFORD36                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFORD36 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ORDFAMT,ORDFAMT)                     
         SAM31 ,                                                                
         J     AGFORD42                                                         
                                                                                
AGFORD38 DS    0H                                                               
*        EDITR (P6,SCMAMNT),(L'ORDFAMT-1,ORDFAMT+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,SCMAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFORD40                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFORD40 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ORDFAMT,ORDFAMT)                     
         SAM31 ,                                                                
                                                                                
AGFORD42 CLI   SCMLN,SCMLN2Q       any text?                                    
         JNH   AGFORD48                                                         
         CLI   SCMLN,SCMTEXT-SCMELD                                             
         JNH   AGFORD48                                                         
         LLC   R1,SCMLN                                                         
         SHI   R1,SCMTEXT-SCMELD+1                                              
*        CHI   R1,L'ORDFTXT-1                                                   
*        JNH   AGFORD44                                                         
*        LHI   R1,L'ORDFTXT-1                                                   
*                                                                               
*GFORD44 MVC   ORDFTXT(0),SCMTEXT                                               
*        EX    R1,*-6                                                           
         STC   R1,LEN4TXT                                                       
         LA    RE,SCMTEXT                                                       
         STCM  RE,B'1111',ADR4TXT                                               
                                                                                
         MVC   ORDFTXT+0(6),SAVOORD          TextRow ID                         
         MVI   ORDFTXT+6,UNDSCQ                                                 
         MVC   ORDFTXT+6+1(6),SAVOROW                                           
         MVI   ORDFTXT+6+1+6,UNDSCQ                                             
         MVC   ORDFTXT+6+1+6+1(6),SAVOSUB                                       
         SAM24 ,                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'ORDFTXT,ORDFTXT)                            
         SAM31 ,                                                                
                                                                                
         MVC   KEY4TXT(L'SAVOORD),SAVOORD                                       
         MVC   ROW4TXT,SAVOROW                                                  
         MVC   SUB4TXT,SAVOSUB                                                  
         OI    PROCMODE,PROCTDQ    Text processing                              
         MVI   LEN4TX2,FFQ                                                      
         MVI   LEN4TX3,FFQ                                                      
         MVI   LEN4TX4,FFQ                                                      
                                                                                
         LA    RF,LEN4TX2                                                       
         LHI   R0,NUMTXTS-1                                                     
                                                                                
NXT      USING SCMELD,R6                                                        
         LR    R6,R2                                                            
                                                                                
AGFORD46 LLC   R1,NXT.SCMLN        Check for more text                          
         AR    R6,R1                                                            
         CLI   NXT.SCMEL,SCMELQ                                                 
         JNE   AGFORD48                                                         
         TM    NXT.SCMTYPE,SCMTSANP                                             
         JZ    AGFORD48                                                         
         CLC   NXT.SCMSEQ,SCMSEQ                                                
         JNE   AGFORD48                                                         
         CLC   NXT.SCMWCOD,SCMWCOD                                              
         JNE   AGFORD48                                                         
         CLI   NXT.SCMLN,SCMLN2Q   any text?                                    
         JNH   AGFORD48                                                         
         CLI   NXT.SCMLN,SCMTEXT-SCMELD                                         
         JNH   AGFORD48                                                         
         LLC   R1,NXT.SCMLN                                                     
         SHI   R1,SCMTEXT-SCMELD+1                                              
         STC   R1,LEN4TX2-LEN4TX2(RF)                                           
         LA    RE,NXT.SCMTEXT                                                   
         STCM  RE,B'1111',ADR4TX2-LEN4TX2(RF)                                   
         AHI   RF,LEN4TX3-LEN4TX2                                               
         JCT   R0,AGFORD46                                                      
         DROP  NXT                                                              
                                                                                
AGFORD48 DS    0H                  SCMEL done, skip to 'set next'               
         J     AGFORD80                                                         
                                                                                
AGFORD50 TM    SAVOIND,SAVOIAQ     ARTELQ scenario                              
         JZ    *+2                                                              
                                                                                
         USING ARTELD,R2                                                        
         ICM   R2,B'1111',ODBADR   (R5 points to current)                       
         MVC   ORDFWCD,ARTWC                                                    
         CLC   ARTWC,GSPACES       no w/c set then use expense order            
         JH    AGFORD52            w/c                                          
         MVC   ORDFWCD,SAVOEWC                                                  
                                                                                
AGFORD52 MVC   DUB,ARTSEQ                                                       
         SAM24 ,                                                                
         XOUT  DUB,ORDFITM,3                                                    
         SAM31 ,                                                                
                                                                                
         JAS   RE,OFAINIT                                                       
                                                                                
         XC    HALF,HALF                                                        
         CLI   ARTLN,ARTLN3Q                                                    
         JL    AGFORD54                                                         
         MVC   HALF+0(1),ARTWSQN   should match ATXWSQN                         
         MVC   HALF+1(1),ARTWSSN                ATXWSSN                         
                                                                                
AGFORD54 DS    0H                                                               
         SAM24 ,                                                                
         EDITR (B1,HALF+0),(6,SAVOROW),0,ALIGN=LEFT,ZERO=NOBLANK                
         EDITR (B1,HALF+1),(6,SAVOSUB),0,ALIGN=LEFT,ZERO=NOBLANK                
         SAM31 ,                                                                
                                                                                
         ZAP   PL16,ARTMULT                                                     
         CP    ARTMULT,PZERO                                                    
         JNE   AGFORD56                                                         
         ZAP   PL16,P100                                                        
                                                                                
AGFORD56 MP    PL16,ARTPRICE                                                    
         LHI   RF,2                                                             
         LCR   RF,RF                                                            
         SRP   PL16,0(RF),5                                                     
                                                                                
         ZAP   DUB,PL16                                                         
                                                                                
         CLC   SAVOCUR,SAVCCUR                                                  
         JE    AGFORD68                                                         
                                                                                
*        EDITR (P8,DUB),(L'ORDFCAM-1,ORDFCAM+1),0,ZERO=NOBLANK,        *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,DUB           Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFORD59                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFORD59 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVOCUR,(L'ORDFCAM,ORDFCAM)                     
         SAM31 ,                                                                
                                                                                
         USING EURKBLKD,R6                                                      
AGFORD60 LA    R6,SAVOEUR          Calculate agency value via Eureka            
                                                                                
         ZAP   EDDUB,PZERO         Init with zero                               
         SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ORDFAMT,ORDFAMT)                     
         SAM31 ,                                                                
                                                                                
         OC    EURKRLRT,EURKRLRT   Skip if GETQ error                           
         JZ    AGFORD72                                                         
                                                                                
         MVC   WORK(EURKBLKL),SAVOEUR                                           
         ZAP   PL16+0(8),DUB                                                    
         LHI   R0,APPLYQ+INVERTQ                                                
         MVC   EURKCUFR,SAVCCUR                                                 
         MVC   EURKCUTO,SAVOCUR                                                 
                                                                                
         SAM24 ,                                                                
         GOTO1 =V(EUREKA),DMCB,((R0),EURKBLKD),PL16+0,PL16+8                    
         SAM31 ,                                                                
         MVC   SAVOEUR(EURKBLKL),WORK                                           
         CLI   0(R1),0                                                          
         JNE   AGFORD72            Skip if error                                
         DROP  R6                                                               
                                                                                
         ZAP   DUB,PL16+8(8)                                                    
         LA    R1,ARTWC                                                         
         CLC   ARTWC,GSPACES       no w/c set then use expense order            
         JH    AGFORD62            w/c                                          
         LA    R1,SAVOEWC                                                       
                                                                                
AGFORD62 GOTOR GETWCA              Any diff from W/C accummulator?              
                                                                                
*        EDITR (P8,DUB),(L'ORDFAMT-1,ORDFAMT+1),0,ZERO=NOBLANK,        *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,DUB           Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFORD64                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFORD64 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ORDFAMT,ORDFAMT)                     
         SAM31 ,                                                                
                                                                                
AGFORD66 DS    0H                                                               
         J     AGFORD72                                                         
                                                                                
AGFORD68 DS    0H                                                               
                                                                                
*        EDITR (P8,DUB),(L'ORDFAMT-1,ORDFAMT+1),0,ZERO=NOBLANK,        *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,DUB           Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFORD70                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFORD70 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ORDFAMT,ORDFAMT)                     
         SAM31 ,                                                                
                                                                                
AGFORD72 TM    SAVOIND,SAVOITQ     any text present?                            
         JZ    AGFORD80                                                         
                                                                                
         USING ATXELD,R2                                                        
         ICM   RE,B'1111',SAVOATX                                               
         ICM   R2,B'1111',ODBADR-ODBUFFD(RE)                                    
         CLI   ATXLN,ATXLNQ                                                     
         JNH   AGFORD78                                                         
         LLC   R1,ATXLN                                                         
         SHI   R1,ATXLNQ+1                                                      
*        CHI   R1,L'ORDFTXT-1                                                   
*        JNH   AGFORD76                                                         
*        LHI   R1,L'ORDFTXT-1                                                   
*                                                                               
*GFORD76 MVC   ORDFTXT(0),ATXTXT                                                
*        EX    R1,*-6                                                           
         STC   R1,LEN4TXT                                                       
         LA    RE,ATXTXT                                                        
         STCM  RE,B'1111',ADR4TXT                                               
                                                                                
         MVC   ORDFTXT+0(6),SAVOORD          TextRow ID                         
         MVI   ORDFTXT+6,UNDSCQ                                                 
         MVC   ORDFTXT+6+1(6),SAVOROW                                           
         MVI   ORDFTXT+6+1+6,UNDSCQ                                             
         MVC   ORDFTXT+6+1+6+1(6),SAVOSUB                                       
         SAM24 ,                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'ORDFTXT,ORDFTXT)                            
         SAM31 ,                                                                
                                                                                
         MVC   KEY4TXT(L'SAVOORD),SAVOORD                                       
         MVC   ROW4TXT,SAVOROW                                                  
         MVC   SUB4TXT,SAVOSUB                                                  
         OI    PROCMODE,PROCTDQ    Text processing                              
         MVI   LEN4TX2,FFQ                                                      
         MVI   LEN4TX3,FFQ                                                      
         MVI   LEN4TX4,FFQ                                                      
                                                                                
         LA    RF,LEN4TX2                                                       
         LHI   R0,NUMTXTS-1                                                     
                                                                                
NXT      USING ATXELD,R6                                                        
         LR    R6,R2                                                            
                                                                                
AGFORD76 LLC   R1,NXT.ATXLN        Check for more text                          
         AR    R6,R1                                                            
         CLI   NXT.ATXEL,ATXELQ                                                 
         JNE   AGFORD78                                                         
         CLC   NXT.ATXWCOD,ATXWCOD (ok to leave w/c as it is here)              
         JNE   AGFORD78                                                         
         CLC   NXT.ATXWSQN,ATXWSQN                                              
         JNE   AGFORD78                                                         
         CLC   NXT.ATXWSSN,ATXWSSN                                              
         JNE   AGFORD78                                                         
         CLI   NXT.ATXLN,ATXLNQ    any text?                                    
         JNH   AGFORD78                                                         
         LLC   R1,ATXLN                                                         
         SHI   R1,ATXLNQ+1                                                      
         STC   R1,LEN4TX2-LEN4TX2(RF)                                           
         LA    RE,NXT.ATXTXT                                                    
         STCM  RE,B'1111',ADR4TX2-LEN4TX2(RF)                                   
         AHI   RF,LEN4TX3-LEN4TX2                                               
         JCT   R0,AGFORD76                                                      
         DROP  NXT                                                              
                                                                                
AGFORD78 DS    0H                                                               
                                                                                
AGFORD80 GOTOR OFLKNXT                                                          
                                                                                
         SAM24 ,                                                                
         TM    SAVOIND,SAVOIXQ     No more to come?                             
         JNZ   AGFORDXN                                                         
                                                                                
AGFORDXY MVI   DMCB+8,RETBFFQ      indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGFORDXN MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
                                                                                
AGFORDXS MVI   DMCB+8,RETBNWQ      skip record                                  
         J     EXIT                                                             
                                                                                
OFAINIT  ST    RE,SAVERE           * Order Facts initialisation *               
                                                                                
*&&UK*&& MVC   ORDFAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ORDFAGY(2),NORTHAM                                               
         MVI   ORDFAGY+2,UNDSCQ                                                 
         MVC   ORDFAGY+2+1(2),SAVCALP                                           
         MVC   ORDFORD,SAVOORD                                                  
         MVC   ORDFCUR,SAVOCUR                                                  
         MVC   ORDFETY,SAVOETY                                                  
         MVC   ORDFOFF,SAVOOFF                                                  
                                                                                
         GOTO1 =V(SET1DAT),SAVODAT                                              
         MVC   ORDFDAT,WORK                                                     
                                                                                
         GOTO1 =V(SET1DAT),SAVODUE                                              
         MVC   ORDFDUE,WORK                                                     
                                                                                
         CLC   SAVOCPJ,GSPACES     (empty if none SJ expense order)             
         JNH   OFAINI2                                                          
         GOTO1 =V(SPLITSJ),SAVOCPJ                                              
         MVC   ORDFCLI,WORK+30+0                                                
         MVC   ORDFPRO,WORK+30+8                                                
         MVC   ORDFJOB,WORK+30+16                                               
                                                                                
OFAINI2  MVC   ORDFSUP,SAVOSUP                                                  
         MVC   ORDFEXP,SAVOEXP                                                  
         MVC   ORDF2DA,SAVO2DA                                                  
         MVC   ORDF2PA,SAVO2PA                                                  
         CLC   SAVOEXP,GSPACES                                                  
         JNH   OFAINI4                                                          
                                                                                
         GOTO1 =V(SPLITAC),SAVOEXP                                              
         CLI   WORK+25,C'0'                                                     
         JE    OFAINI4                                                          
         MVC   ORDFEXP1,WORK+30+00                                              
         CLI   WORK+25,C'1'                                                     
         JE    OFAINI4                                                          
         MVC   ORDFEXP2,WORK+30+15                                              
         CLI   WORK+25,C'2'                                                     
         JE    OFAINI4                                                          
         MVC   ORDFEXP3,WORK+30+30                                              
         CLI   WORK+25,C'3'                                                     
         JE    OFAINI4                                                          
         MVC   ORDFEXP4,WORK+30+45                                              
                                                                                
OFAINI4  MVC   ORDFXID,SAVOORD     (DSRD-16606: Sam, 21Aug17)                   
                                                                                
*        ICM   RE,B'1111',SAVOACT+3                                             
*        SRL   RE,4                                                             
*        MVC   DUB(3),SAVOACT                                                   
*        STCM  RE,B'0111',DUB+3                                                 
*        GOTO1 =V(SETACTV),DUB                                                  
         GOTO1 =V(SETACTV),0                                                    
         MVC   ORDFUTS,WORK                                                     
                                                                                
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
***********************************************************************         
* Look for more facts (SCMEL/ARTEL) to come - set SAVOIXQ if not      *         
***********************************************************************         
                                                                                
OFLKNXT  ST    RE,SAVERE                                                        
                                                                                
NXT      USING ODBUFFD,RF                                                       
         LR    RF,R5               current entry                                
SCM      USING ODBUFFD,R1                                                       
         ICM   R1,B'1111',SAVOSCM  saved SCM entry                              
                                                                                
OFLKN02  AHI   RF,ODBLENQ                                                       
                                                                                
         CLI   NXT.ODBKELE,0                                                    
         JE    OFLKNNO                                                          
         CLI   NXT.ODBKELE,ARTELQ                                               
         JNE   OFLKN04             MCSTST.P00938 bad ARTEL data:                
         CLC   SCM.ODBCOMP,NXT.ODBCOMP                                          
         JNE   OFLKN02             skip if ARTEL not belonging to SCMEL         
         J     OFLKNYES                                                         
                                                                                
OFLKN04  CLI   NXT.ODBKELE,SCMELQ                                               
         JNE   OFLKN02                                                          
         CLC   SCM.ODBCOMP,NXT.ODBCOMP                                          
         JE    OFLKN02             check it's not the same SCM seq/wc           
         J     OFLKNYES                                                         
                                                                                
OFLKNNO  OI    SAVOIND,SAVOIXQ     set end of facts                             
                                                                                
OFLKNYES L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  NXT,SCM                                                          
                                                                                
***********************************************************************         
* Look ahead in ODBUFF and determine SCMEL or ARTEL scenario, set     *         
* SAVOADR to address of what is to be processed and current SAVOSCM   *         
***********************************************************************         
                                                                                
OFLKAHD  ST    RE,SAVERE           (R5 pointing to current entry)               
                                                                                
         NI    SAVOIND,FFQ-(SAVOIAQ+SAVOITQ+SAVOISQ)                            
                                                                                
         TM    SAVOIND,SAVOINQ     not first time then get first SCMEL          
         JZ    OFLKA02                                                          
SCM      USING ODBUFFD,R1                                                       
         ICM   R1,B'1111',SAVOSCM  point to current SCMEL                       
         J     OFLKA20                                                          
                                                                                
OFLKA02  CLI   ODBKELE,0           (no SCMEL?)                                  
         JE    *+2                                                              
         CLI   ODBKELE,SCMELQ      get first SCMEL from buffer                  
         JE    OFLKA04                                                          
         AHI   R5,ODBLENQ                                                       
         J     OFLKA02                                                          
                                                                                
OFLKA04  LR    R1,R5               save first SCMEL and set to current          
         STCM  R1,B'1111',SAVOSCM  and say SCMEL found                          
         STCM  R5,B'1111',SAVOADR                                               
         OI    SAVOIND,SAVOISQ                                                  
                                                                                
OFLKA06  AHI   R5,ODBLENQ          look for ARTEL                               
                                                                                
         CLI   ODBKELE,0                                                        
         JE    OFLKA12                                                          
         CLI   ODBKELE,ARTELQ                                                   
         JNE   OFLKA06                                                          
         CLC   SCM.ODBCOMP,ODBCOMP same sequence/work code?                     
         JNE   OFLKA12                                                          
         STCM  R5,B'1111',SAVOADR  save ARTEL and say ARTEL found               
         OI    SAVOIND,SAVOIAQ                                                  
                                                                                
TXT      USING ODBUFFD,RF                                                       
OFLKA08  LR    RF,R5               look for ATXEL                               
                                                                                
OFLKA10  AHI   RF,ODBLENQ                                                       
                                                                                
         CLI   TXT.ODBKELE,0                                                    
         JE    OFLKAXIT                                                         
         CLI   TXT.ODBKELE,ATXELQ                                               
         JNE   OFLKA10                                                          
         CLC   TXT.ODBCOMPS,ODBCOMPS     <=== ODBCOMP or ODBCOMPS?              
         JNE   OFLKAXIT                                                         
         OI    SAVOIND,SAVOITQ                                                  
         STCM  RF,B'1111',SAVOATX                                               
         J     OFLKAXIT                                                         
         DROP  TXT                                                              
                                                                                
OFLKA12  LR    R5,R1               point back to SCMEL and exit                 
         J     OFLKAXIT                                                         
                                                                                
OFLKA20  AHI   R5,ODBLENQ          get next after current entry                 
                                                                                
         CLI   ODBKELE,0                                                        
         JE    *+2                                                              
         CLI   ODBKELE,SCMELQ      SCMELQ?                                      
         JNE   OFLKA22                                                          
         CLC   SCM.ODBCOMP,ODBCOMP same sequence/work code?                     
         JE    OFLKA20                                                          
         LR    R1,R5               save this SCMEL and set to current           
         STCM  R1,B'1111',SAVOSCM  and say SCMEL found                          
         STCM  R5,B'1111',SAVOADR                                               
         OI    SAVOIND,SAVOISQ                                                  
         J     OFLKA06             (ARTEL/ATXEL look up)                        
                                                                                
OFLKA22  CLI   ODBKELE,ARTELQ                                                   
         JNE   OFLKA20                                                          
         CLC   SCM.ODBCOMP,ODBCOMP same sequence/work code?                     
         JNE   OFLKA12                                                          
         STCM  R5,B'1111',SAVOADR  save ARTEL and say ARTEL found               
         OI    SAVOIND,SAVOIAQ                                                  
         J     OFLKA08             (ATXEL look up)                              
                                                                                
OFLKAXIT L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  SCM,R5                                                           
                                                                                
         DROP  R2,R3,R4                                                         
                                                                                
         USING WCACUMD,R3                                                       
GETWCA   NTR1  ,                   *** Get any diff for w/c and add ***         
                                                                                
         CLC   SAVOCUR,SAVCCUR     Skip for none currency orders                
         JE    GETWCAX                                                          
                                                                                
         L     R3,AWCACUM                                                       
                                                                                
GETWCA2  OC    WCACWC,WCACWC                                                    
         JZ    *+2                                                              
         CLC   WCACWC,0(R1)                                                     
         JE    GETWCA6                                                          
         CLI   SAVOWCS,YESQ        (cater for MCSTST.E03299 scenario)           
         JE    GETWCA4                                                          
         CLC   WCACWC,GSPACES                                                   
         JE    GETWCA6                                                          
                                                                                
GETWCA4  AHI   R3,WCACLNQ                                                       
         J     GETWCA2                                                          
                                                                                
GETWCA6  AP    DUB,WCACAGY                                                      
         ZAP   WCACAGY,PZERO                                                    
                                                                                
GETWCAX  DS    0H                                                               
         J     EXIT                                                             
         DROP  R3                                                               
                                                                                
AGFORDLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AG2ORDC - Extract order extra dimension                             *         
***********************************************************************         
                                                                                
AG2ORDC  NMOD1 WORKX-WORKD,*AG2ORD*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AG2ORDLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ORDRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ORD2LENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXORD2Q                                                
                                                                                
         MVI   ISDATA,NOQ                                                       
                                                                                
         SAM31 ,                                                                
         LA    R2,ORDRFST                                                       
         CLI   DXMODE,DXLOADQ      For load and multiple records update         
         JE    AG2ORD02            use Buffer                                   
         TM    PROCMOD2,PROCMRQ                                                 
         JZ    AG2ORD04                                                         
                                                                                
AG2ORD02 L     R2,ABUFFER                                                       
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AG2ORD04                                                         
         L     R2,ABUFOLD                                                       
                                                                                
AG2ORD04 DS    0H                                                               
*&&UK*&& MVC   ORD2AGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ORD2AGY(2),NORTHAM                                               
         MVI   ORD2AGY+2,UNDSCQ                                                 
         MVC   ORD2AGY+2+1(2),SAVCALP                                           
         MVC   ORD2NUM,SAVOORD                                                  
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   ORD2UTS,WORK                                                     
                                                                                
         LA    R5,ORD2X01T                                                      
         J     AG2ORD12                                                         
                                                                                
         USING SCMELD,R2                                                        
AG2ORD10 LLC   R1,SCMLN                                                         
         AR    R2,R1                                                            
                                                                                
AG2ORD12 CLI   SCMEL,0                                                          
         JE    AG2ORD50                                                         
         CLI   SCMEL,SCMELQ                                                     
         JE    AG2ORD14                                                         
         CLI   SCMEL,XDFELQ                                                     
         JE    AG2ORD30                                                         
         J     AG2ORD10                                                         
                                                                                
AG2ORD14 CLI   SCMTYPE,SCMTPRBD                                                 
         JNE   AG2ORD18                                                         
         CLI   SCMLN,SCMNARR-SCMELD                                             
         JNH   AG2ORD10                                                         
         CLI   SCMSEQ,1                                                         
         JNE   AG2ORD10                                                         
         LLC   R1,SCMLN                                                         
         SHI   R1,SCMNARR-SCMELD+1                                              
         CHI   R1,L'ORD2HDR-1                                                   
         JNH   AG2ORD16                                                         
         LHI   R1,L'ORD2HDR-1                                                   
                                                                                
AG2ORD16 MVC   ORD2HDR(0),SCMNARR                                               
         EX    R1,*-6                                                           
         MVI   ISDATA,YESQ                                                      
         J     AG2ORD10                                                         
                                                                                
AG2ORD18 CLI   SCMTYPE,SCMTPRAD                                                 
         JNE   AG2ORD22                                                         
         CLI   SCMLN,SCMNARR-SCMELD                                             
         JNH   AG2ORD10                                                         
         CLI   SCMSEQ,1                                                         
         JNE   AG2ORD10                                                         
         LLC   R1,SCMLN                                                         
         SHI   R1,SCMNARR-SCMELD+1                                              
         CHI   R1,L'ORD2FTR-1                                                   
         JNH   AG2ORD20                                                         
         LHI   R1,L'ORD2FTR-1                                                   
                                                                                
AG2ORD20 MVC   ORD2FTR(0),SCMNARR                                               
         EX    R1,*-6                                                           
         MVI   ISDATA,YESQ                                                      
         J     AG2ORD10                                                         
*                                                                               
AG2ORD22 CLI   SCMTYPE,SCMTOPDX                                                 
         JNE   AG2ORD26                                                         
         CLI   SCMLN,SCMNARR-SCMELD                                             
         JNH   AG2ORD10                                                         
         J     AG2ORD10                                                         
*        ==============                                                         
*        LLC   R1,SCMLN                                                         
*        SHI   R1,SCMTBOX-SCMELD+1                                              
*11aug   CHI   R1,L'ORD2PDE-1                                                   
*now to  JNH   AG2ORD24                                                         
*ORD DIM|LHI   R1,L'ORD2PDE-1                                                   
*see     CHI   R1,L'ORDDPDE-1                                                   
*ORDX    JNH   AG2ORD24                                                         
*...     LHI   R1,L'ORDDPDE-1                                                   
                                                                                
*AG2ORD24 MVC   ORD2PDE(0),SCMNARR                                              
*AG2ORD24 MVC   ORDDPDE(0),SCMNARR                                              
*         EX    R1,*-6                                                          
*        MVI   ISDATA,YESQ                                                      
*         J     AG2ORD10                                                        
                                                                                
AG2ORD26 CLI   SCMTYPE,SCMTOMOC                                                 
         JNE   AG2ORD10                                                         
*        CLI   SCMLN,SCMNARR-SCMELD                                             
*        JNH   AG2ORD10                                                         
*        LLC   R1,SCMLN                                                         
*        SHI   R1,SCMNARR-SCMELD+1                                              
*11aug   CHI   R1,L'ORD2MDE-1                                                   
*now to  JNH   AG2ORD28                                                         
*ORD DIM|LHI   R1,L'ORD2MDE-1                                                   
*see     CHI   R1,L'ORDDMDE-1                                                   
*ORDX    JNH   AG2ORD28                                                         
*...     LHI   R1,L'ORDDMDE-1                                                   
*15Aug-active again, see AGXORD40 ff for ORDD(dim1)-fields|                     
*=========================================================                      
*AG2ORD28 MVC   ORD2MDE(0),SCMNARR                                              
*AG2ORD28 MVC   ORDDMDE(0),SCMNARR                                              
*         EX    R1,*-6                                                          
*        MVI   ISDATA,YESQ                                                      
         J     AG2ORD10                                                         
                                                                                
         USING XDFELD,R2                                                        
AG2ORD30 LA    R1,ORD2X10T         Skip if > 10                                 
         CR    R5,R1                                                            
         JH    AG2ORD10                                                         
         MVC   0(L'ORD2X01T,R5),XDFOTYP                                         
         CLI   XDFOTYP,XDFEDNQ     N=numeric                                    
         JE    AG2ORD32                                                         
         CLI   XDFOTYP,XDFEDXQ     X=dropdown                                   
         JE    AG2ORD32                                                         
         CLI   XDFOTYP,XDFEDCQ     C=char                                       
         JNE   AG2ORD36                                                         
                                                                                
AG2ORD32 LLC   RE,XDFLN                                                         
         SHI   RE,XDFOLNQ+1                                                     
         CHI   RE,L'ORD2X01V-1                                                  
         JNH   AG2ORD34                                                         
         LHI   RE,L'ORD2X01V-1                                                  
                                                                                
AG2ORD34 MVC   ORD2X01V-ORD2X01T(0,R5),XDFODTA                                  
         EX    RE,*-6                                                           
         J     AG2ORD42                                                         
                                                                                
AG2ORD36 CLI   XDFOTYP,XDFEDDQ     D=DATE                                       
         JNE   AG2ORD38                                                         
         MVC   FULL,XDFODTA                                                     
         SAM24 ,                                                                
         GOTO1 =V(SET1DAT),FULL                                                 
         SAM31 ,                                                                
         MVC   ORD2X01V-ORD2X01T(10,R5),WORK                                    
         J     AG2ORD42                                                         
                                                                                
AG2ORD38 CLI   XDFOTYP,XDFEDYQ     Y=YES/NO                                     
         JNE   AG2ORD40                                                         
         MVC   ORD2X01V-ORD2X01T(1,R5),XDFODTA                                  
         J     AG2ORD42                                                         
                                                                                
AG2ORD40 CLI   XDFOTYP,XDFEDAQ     A=AMOUNT                                     
         JNE   *+2                                                              
                                                                                
         LA    R6,ORD2X01V-ORD2X01T(R5)                                         
*        ZAP   DUB,XDFODTA(6)                                                   
         ZAP   EDDUB,XDFODTA(6)                                                 
         SAM24 ,                                                                
*        EDITR (P8,DUB),(15,0(R6)),0,ZERO=NOBLANK,MINUS=YES,ALIGN=LEFT          
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(15,0(R6))                              
         SAM31 ,                                                                
                                                                                
AG2ORD42 DS    0H                                                               
         MVC   FULL,XDFOCOD                                                     
         SAM24 ,                                                                
         GOTO1 =V(GETXDF),FULL                                                  
         SAM31 ,                                                                
         MVI   ISDATA,YESQ                                                      
         MVC   ORD2X01N-ORD2X01T(L'ORD2X01N,R5),WORK                            
                                                                                
         AHI   R5,ORD2X02T-ORD2X01T                                             
         J     AG2ORD10                                                         
                                                                                
AG2ORD50 DS    0H                  Pass previous indicator back                 
         SAM24 ,                                                                
         CLI   ISDATA,YESQ         But only if there is data                    
         JE    AG2ORD52                                                         
         CLI   DXMODE,DXLOADQ      and we are in LOAD mode                      
         JNE   AG2ORD52                                                         
         OI    RETBYTE,RETBNWQ                                                  
                                                                                
AG2ORD52 MVC   DMCB+8(L'RETBYTE),RETBYTE                                        
         J     EXIT                                                             
                                                                                
         DROP  R2,R3                                                            
                                                                                
AG2ORDLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXESTC - Extract estimate dimension data                           *         
***********************************************************************         
                                                                                
AGXESTC  NMOD1 WORKX-WORKD,*AGXEST*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXESTLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ESTRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ESTDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXESTDQ                                                
         TM    PROCMOD2,PROCSFQ    Skip if sequentials and load mode            
         JNZ   AGXEST02                                                         
         TM    PROCMODE,PROCMLQ                                                 
         JNZ   AGXEST02                                                         
         MVC   AGXRETYP,AGXESTSQ                                                
                                                                                
AGXEST02 XC    SAVEST(SAVESTLQ),SAVEST                                          
         XC    SAV_ESEQ,SAV_ESEQ                                                
                                                                                
         MVC   PL16,GSPACES                                                     
         LA    R1,PL16                                                          
         LLC   RE,CLILEN                                                        
         SHI   RE,1                                                             
         MVC   0(0,R1),ESTKCLI                                                  
         EX    RE,*-6                                                           
         AHI   RE,1                                                             
         AR    R1,RE                                                            
         LLC   RE,PROLEN                                                        
         SHI   RE,1                                                             
         MVC   0(0,R1),ESTKPRO                                                  
         EX    RE,*-6                                                           
         AHI   RE,1                                                             
         AR    R1,RE                                                            
         MVC   0(L'ESTKJOB,R1),ESTKJOB                                          
         MVC   PL16+12(1),ESTKLNO                                               
                                                                                
*&&UK*&& MVC   ESTDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ESTDAGY(2),NORTHAM                                               
         MVI   ESTDAGY+2,UNDSCQ                                                 
         MVC   ESTDAGY+2+1(2),SAVCALP                                           
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   ESTDUTS,WORK                                                     
                                                                                
         MVC   SAVEOFF,ESTRSOFF                                                 
         MVI   ESTDAST,EDELETEQ                                                 
         EDITR (B1,ESTKLNO),(L'ESTDLSN,ESTDLSN),0,ZERO=NOBLANK,        *        
               ALIGN=LEFT                                                       
         MVC   SAV_EKEY,PL16                                                    
         TM    ESTRSTA1,ESTKDELT+ESTKLOGD                                       
         JNZ   AGXEST04                                                         
         MVI   ESTDAST,EMERGEQ                                                  
         TM    ESTRSTA2,ESTKMERG                                                
         JNZ   AGXEST04                                                         
         MVI   ESTDAST,EREJECTQ                                                 
         TM    ESTRSTA1,ESTKREJE                                                
         JNZ   AGXEST04                                                         
         MVI   ESTDAST,ECREATEQ                                                 
         TM    ESTRSTA1,ESTKCREA                                                
         JNZ   AGXEST04                                                         
         MVI   ESTDAST,ESUBMITQ                                                 
         TM    ESTRSTA1,ESTKSUBM                                                
         JNZ   AGXEST04                                                         
         MVI   ESTDAST,EINTAPPQ                                                 
         TM    ESTRSTA1,ESTKINTA                                                
         JNZ   AGXEST04                                                         
         MVI   ESTDAST,ECLIAPPQ                                                 
         TM    ESTRSTA1,ESTKCAPP                                                
         JNZ   AGXEST04                                                         
         MVI   ESTDAST,ESUBIAPQ                                                 
         TM    ESTRSTA2,ESTKSINA                                                
         JNZ   AGXEST04                                                         
         MVI   ESTDAST,EUNKNONQ                                                 
                                                                                
         USING EMDELD,R2                                                        
AGXEST04 SAM31 ,                                                                
         LA    R2,ESTRFST                                                       
                                                                                
         CLI   DXMODE,DXLOADQ      For load use BUFFER                          
         JE    AGXEST06                                                         
         TM    PROCMOD2,PROCMRQ    Also in 'multiple records' mode              
         JZ    AGXEST08                                                         
                                                                                
AGXEST06 L     R2,ABUFFER                                                       
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AGXEST08                                                         
         L     R2,ABUFOLD                                                       
                                                                                
AGXEST08 CLI   EMDEL,EMDELQ        must be first                                
         JNE   *+2                                                              
         XC    TEMPSTOR,TEMPSTOR                                                
                                                                                
*        MVC   ESTDEID,EMDGNO                                                   
         MVC   ESTDGNO,EMDGNO                                                   
         MVC   SAVEST#,EMDGNO                                                   
         MVC   SAVESTD,EMDDAT                                                   
         MVC   TEMPSTOR(L'EMDSCA),EMDSCA                                        
         MVC   SAVECUR,EMDCUR                                                   
         CLC   SAVECUR,GSPACES                                                  
         JH    AGXEST10                                                         
         MVC   SAVECUR,SAVCCUR                                                  
                                                                                
AGXEST10 MVC   SAVESCH,EMDSCH                                                   
         MVC   SAVEACT,EMDLDT                                                   
         OC    EMDRAT,EMDRAT                                                    
         JZ    AGXEST13                                                         
         ZAP   DUB,PZERO                                                        
         MVO   DUB,EMDRAT+1(5)                                                  
         TM    EMDRAT,AFCXSDIV                                                  
         JZ    AGXEST12                                                         
         ZAP   PL16,PONE                                                        
         MP    PL16,=P'100000000000'                                            
         DP    PL16,DUB                                                         
         SRP   PL16(8),64-1,5                                                   
         ZAP   DUB,PL16(8)                                                      
                                                                                
AGXEST12 EDITR (P8,DUB),(L'ESTDEXR,ESTDEXR),5,ALIGN=LEFT                        
                                                                                
         GOTOR ESTEUR,EMDELD                                                    
                                                                                
AGXEST13 DS    0H                                                               
*&&UK*&& TM    ESTRSTA1,ESTKCAPP   For Europe we check it's approved            
*&&UK*&& JZ    AGXEST70                                                         
*&&US*&& TM    ESTRSTA3,ESTSCEST   For US we check it's current est             
*&&US*&& JZ    AGXEST70                                                         
OB       USING OB_D,OBTTAREA                                                    
         LA    R0,OBTTAREA                                                      
         LHI   R1,OB_LNQ-1                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   OB.OB_LEN,=AL2(OB_CSLNQ)                                         
         MVI   OB.OB_KTYP,OB_KTYPQ                                              
         MVC   OB.OB_KMOA,EMDDAT                                                
         MVC   OB.OB_KOFF,ESTRSOFF                                              
         MVC   OB.OB_KCLI,GSPACES                                               
         LLC   R1,CLILEN                                                        
         BCTR  R1,0                                                             
         MVC   OB.OB_KCLI(0),ESTKCLI                                            
         EX    R1,*-6                                                           
         MVC   OB.OB_KAGY,ESTDAGY                                               
                                                                                
         ZAP   OB.OB_EHRS,PZERO                                                 
         ZAP   OB.OB_EHRS,PZERO                                                 
         OC    EMDHRS,EMDHRS                                                    
         JZ    *+10                                                             
         ZAP   OB.OB_EHRS,EMDHRS                                                
         ZAP   OB.OB_BILD,PZERO                                                 
         ZAP   OB.OB_ESTA,EMDAMT                                                
         ZAP   OB.OB_BHRS,PZERO                                                 
         ZAP   OB.OB_NHRS,PZERO                                                 
         ZAP   OB.OB_AHRS,PZERO                                                 
         ZAP   OB.OB_NEXA,PZERO                                                 
                                                                                
         CLI   DXACTION,C'D'       If action is delete need to subtract         
         JNE   AGXEST14             so multiply by minus one                    
         MP    OB.OB_EHRS,PMONE                                                 
         MP    OB.OB_ESTA,PMONE                                                 
                                                                                
AGXEST14 SAM24 ,                                                                
         GOTOR =V(CLIREC),OB.OB_D                                               
         SAM31 ,                                                                
         DROP  OB                                                               
                                                                                
         USING ENMELD,R2                                                        
AGXEST70 LLC   R1,ENMLN                                                         
         AR    R2,R1                                                            
         CLI   ENMEL,0                                                          
         JE    AGXEST90                                                         
         CLI   ENMEL,ENMELQ                                                     
         JE    AGXEST72                                                         
         CLI   ENMEL,STCELQ                                                     
         JE    AGXEST76                                                         
         CLI   ENMEL,ERDELQ                                                     
         JE    AGXEST88                                                         
         J     AGXEST70                                                         
                                                                                
AGXEST72 CLI   ENMLN,ENMLNQ                                                     
         JNH   AGXEST70                                                         
         LLC   R1,ENMLN                                                         
         SHI   R1,ENMLNQ+1                                                      
         CHI   R1,L'ESTDNAM-1                                                   
         JNH   AGXEST74                                                         
         LHI   R1,L'ESTDNAM-1                                                   
                                                                                
AGXEST74 MVC   ESTDNAM(0),ENMNAME                                               
         EX    R1,*-6                                                           
         J     AGXEST70                                                         
                                                                                
         USING STCELD,R2                                                        
AGXEST76 CLI   STCIND,STCIEST2                                                  
         JNE   AGXEST70                                                         
         CLI   STCETY2,STCSTATE                                                 
         JNE   AGXEST78                                                         
         CLI   STCETYP,STCEESG+STCECHG                                          
         JNE   AGXEST70                                                         
         J     AGXEST80                                                         
                                                                                
AGXEST78 CLI   STCETY2,STCAPCMT                                                 
         JNE   AGXEST70                                                         
         CLI   STCETYP,STCEADD                                                  
         JNE   AGXEST70                                                         
                                                                                
AGXEST80 LA    R1,STCPERS                                                       
         GOTO1 =V(GETSPD)                                                       
         MVC   ESTDCAC,WORK+100                                                 
         MVC   ESTDCAF,WORK+00                                                  
         MVC   ESTDCAM,WORK+32                                                  
         MVC   ESTDCAL,WORK+16                                                  
         LLC   R1,STCLN                                                         
         SHI   R1,STCELN2Q+1                                                    
         CHI   R1,0                                                             
         JL    AGXEST70                                                         
         CHI   R1,L'ESTDCAT-1                                                   
         JNH   AGXEST82                                                         
         LHI   R1,L'ESTDCAT-1                                                   
                                                                                
AGXEST82 MVC   ESTDCAT(0),STCECOMM                                              
         EX    R1,*-6                                                           
         J     AGXEST70                                                         
                                                                                
         USING ERDELD,R2                                                        
AGXEST88 DS    0H                                                               
         J     AGXEST70                                                         
                                                                                
AGXEST90 CLC   ESTDCAC,GSPACES     Client approver resolved?                    
         JH    AGXEST92                                                         
         OC    TEMPSTOR(L'EMDSCA),TEMPSTOR                                      
         JZ    AGXEST92                                                         
         GOTO1 =V(GETSPD),TEMPSTOR                                              
         MVC   ESTDCAC,WORK+100                                                 
         MVC   ESTDCAF,WORK+00                                                  
         MVC   ESTDCAM,WORK+32                                                  
         MVC   ESTDCAL,WORK+16                                                  
                                                                                
AGXEST92 CLI   DXMODE,DXLOADQ      For load use BUFFER or if in 'mul-           
         JE    AGXEST94            tiple records' mode                          
         TM    PROCMOD2,PROCMRQ                                                 
         JZ    AGXESTS             Take 'single' dimension record               
                                                                                
AGXEST94 L     R4,ABUFFER                                                       
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AGXEST96                                                         
         L     R4,ABUFOLD                                                       
                                                                                
AGXEST96 STCM  R4,B'1111',SAVEADR                                               
         LR    R2,R4                                                            
                                                                                
AGXEST98 LLC   R1,ERDLN            Ensure good estimate                         
         AR    R2,R1                                                            
         CLI   ERDEL,0                                                          
         JE    AGXESTN                                                          
         CLI   ERDEL,ERDELQ                                                     
         JNE   AGXEST98                                                         
         CLI   ERDTYP,ERDTWDQ                                                   
         JNE   AGXEST98                                                         
         SAM24 ,                                                                
                                                                                
AGXESTX  MVI   DMCB+8,RETBFFQ      indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGXESTN  MVI   DMCB+8,RETBNWQ      skip record                                  
         J     EXIT                                                             
                                                                                
AGXESTS  MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
         DROP  R2,R3,R4                                                         
                                                                                
         USING EMDELD,R2                                                        
         USING EURKBLKD,R3                                                      
ESTEUR   NTR1  ,                   *** Eureka preliminary call ***              
         LA    R3,SAVEEUR                                                       
         LR    R2,R1                                                            
                                                                                
         XC    0(EURKBLKL,R3),0(R3)                                             
***      MVC   EURKCUFR,AFCCURR                                                 
***      MVC   EURKCUTO,SAVCCUR                                                 
         MVC   EURKCUFR,SAVCCUR                                                 
         MVC   EURKCUTO,EMDCUR                                                  
         MVC   EURKALPH,SAVCALP                                                 
         MVC   EURKDATE,TODAYC                                                  
         MVC   EURKAFAC,ACOMFAC                                                 
         MVI   EURKTYPE,ACCQ                                                    
         OI    EURKTYPE,ALLOWFTQ+SWAPQ                                          
         GOTO1 =V(EUREKA),DMCB,('GETQ',EURKBLKD)                                
         CLI   0(R1),0                                                          
         JE    ESTEUR2                                                          
         XC    EURKRLRT,EURKRLRT                                                
         J     ESTEURX                                                          
                                                                                
ESTEUR2  MVC   EURKRULE,EMDRAT                                                  
                                                                                
ESTEURX  DS    0H                                                               
         J     EXIT                                                             
         DROP  R2,R3                                                            
                                                                                
AGXESTLT DC    A(LITERAL)                                                       
                                                                                
EUNKNONQ EQU   C'0'                                                             
EDELETEQ EQU   C'1'                                                             
EMERGEQ  EQU   C'2'                                                             
EREJECTQ EQU   C'3'                                                             
ECREATEQ EQU   C'4'                                                             
ESUBMITQ EQU   C'5'                                                             
EINTAPPQ EQU   C'6'                                                             
ECLIAPPQ EQU   C'7'                                                             
ESUBIAPQ EQU   C'8'                                                             
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGFESTC - Extract estimate fact data                                *         
***********************************************************************         
                                                                                
AGFESTC  NMOD1 WORKX-WORKD,*AGFEST*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGFESTLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING ESTRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,ESTFLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXESTFQ                                                
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ESTFHON,ESTFHON)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ESTFRAT,ESTFRAT)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ESTFCAM,ESTFCAM)                     
                                                                                
         USING ERDELD,R2                                                        
         SAM31 ,                                                                
         ICM   R2,B'1111',SAVEADR  This time entry point                        
                                                                                
         CLI   SAVETYP,SAVETNQ     Find first/next w/c entry                    
         JNE   AGFEST06                                                         
                                                                                
         OC    SAVEWCA,SAVEWCA     Any saved w/c entry?                         
         JZ    AGFEST02                                                         
         ICM   R2,B'1111',SAVEWCA  set saved w/c entry                          
                                                                                
AGFEST02 LLC   R1,ERDLN            Locate first w/c element                     
         AR    R2,R1                                                            
         CLI   ERDEL,0                                                          
         JE    *+2                                                              
         CLI   ERDEL,ERDELQ                                                     
         JNE   AGFEST02                                                         
         CLI   ERDTYP,ERDTCSQ      This comes first ...|                        
         JNE   AGFEST03                                                         
         MVC   SAVEINST,ERDCINS                                                 
*        MVC   SAVECTNA,ERDCTNA                                                 
         J     AGFEST02                                                         
                                                                                
AGFEST03 CLI   ERDTYP,ERDTWDQ                                                   
         JNE   AGFEST02                                                         
         STCM  R2,B'1111',SAVEWCA  save w/c entry                               
         STCM  R2,B'1111',SAVEADR  set current address                          
         XC    SAV_ESEQ,SAV_ESEQ                                                
                                                                                
         JAS   RE,EFLKAHD          determine type                               
                                                                                
         CLI   SAVETYP,SAVETEQ     Set to this time is w/c entry                
         JNE   AGFEST04                                                         
         MVI   SAVETYP,ERDTWDQ                                                  
                                                                                
AGFEST04 CLI   SAVETYP,ERDTWDQ                                                  
         JE    AGFEST06                                                         
         L     R2,FULL             Set new address                              
         STCM  R2,B'1111',SAVEADR                                               
                                                                                
AGFEST06 CLI   SAVETYP,ERDTWDQ     work code data                               
         JE    AGFEST20                                                         
         CLI   SAVETYP,ERDTIDQ     item data                                    
         JE    AGFEST40                                                         
         CLI   SAVETYP,ERDTIRQ     item time data                               
         JE    AGFEST64                                                         
         DC    H'0'                (what else?)                                 
                                                                                
AGFEST20 DS    0H                  * Process w/c style *                        
         SAM24 ,                                                                
         JAS   RE,EFAINIT                                                       
         SAM31 ,                                                                
                                                                                
*        MVC   ESTFCIN,SAVEINST                                                 
*        MVC   ESTFCTN,SAVECTNA                                                 
                                                                                
         MVC   ESTFCAT(L'EMDSCH),SAVESCH                                        
         MVI   ESTFCAT+L'EMDSCH,UNDSCQ                                          
         CLC   ERDWCAT,EDCFFS                                                   
         JE    AGFEST22                                                         
         MVC   ESTFCAT+L'EMDSCH+1(L'ERDWCAT),ERDWCAT                            
                                                                                
AGFEST22 SAM24 ,                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'ESTFCAT,ESTFCAT)   T15F106 CAT Id           
         SAM31 ,                                                                
                                                                                
         MVC   ESTFWCD,ERDWCOD                                                  
         MVC   FULL(2),ERDWSEQ                                                  
         SAM24 ,                                                                
         EDITR (B2,FULL),(6,SAVEROW),0,ALIGN=LEFT,ZERO=NOBLANK                  
         EDITR (B3,SAV_ESEQ),(6,SAVESUB),0,ALIGN=LEFT,ZERO=NOBLANK              
         SAM31 ,                                                                
                                                                                
         MVC   ESTFTXR+0(6),SAVEST#                                             
         MVI   ESTFTXR+6,UNDSCQ                                                 
         MVC   ESTFTXR+6+1(6),SAVEROW                                           
         MVI   ESTFTXR+6+1+6,UNDSCQ                                             
         MVC   ESTFTXR+6+1+6+1(6),SAVESUB                                       
         SAM24 ,                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'ESTFTXR,ESTFTXR)                            
         SAM31 ,                                                                
                                                                                
         ZAP   EDDUB,ERDWAMT       Normal cur - T15F116 Est amount              
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST26                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST26 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ESTFAMT,ESTFAMT)                     
         SAM31 ,                                                                
                                                                                
AGFEST28 CLC   SAVECUR,SAVCCUR     Est Cur=Cpy Cur?                             
         JE    AGFEST30                                                         
                                                                                
*        EDITR (P6,ERDWFCA),(L'ESTFCAM-1,ESTFCAM+1),0,ZERO=NOBLANK,    +        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,ERDWFCA       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST29                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST29 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFCAM,ESTFCAM)                     
         SAM31 ,                                                                
                                                                                
AGFEST30 CLI   ERDLN,ERDWLX1Q      w/c level items?                             
         JNE   AGFEST34                                                         
                                                                                
*        EDITR (P4,ERDWRAT),(L'ESTFRAT-1,ESTFRAT+1),0,ZERO=NOBLANK,    +        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,ERDWRAT       Normal cur                                   
***      CLI   DXACTION,C'D'       Sign change required?                        
***      JNE   AGFEST31                                                         
***      MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST31 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFRAT,ESTFRAT)                     
         SAM31 ,                                                                
                                                                                
         CP    ERDWHRS,PZERO       If Hours then set 'is time'                  
         JE    AGFEST32                                                         
         MVI   ESTFIST,TRUEQ                                                    
                                                                                
         ZAP   EDDUB,ERDWHRS       Normal cur                                   
AGFEST32 CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST33                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST33 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFHON,ESTFHON)                     
         SAM31 ,                                                                
                                                                                
NXT      USING ERDELD,R5                                                        
AGFEST34 LLC   R5,ERDLN            Check next element is text                   
         AR    R5,R2                                                            
         CLI   NXT.ERDEL,ERDELQ                                                 
         JNE   AGFEST38                                                         
         CLI   NXT.ERDTYP,ERDTWTQ                                               
         JNE   AGFEST38                                                         
                                                                                
         CLI   NXT.ERDLN,ERDTLNQ                                                
         JNH   AGFEST38                                                         
         LLC   R1,NXT.ERDLN                                                     
         SHI   R1,ERDTLNQ+1                                                     
*        CHI   R1,L'ESTFTXT-1                                                   
*        JNH   AGFEST35                                                         
*        LHI   R1,L'ESTFTXT-1                                                   
*                                                                               
*GFEST35 MVC   ESTFTXT(0),NXT.ERDTEXT                                           
*        EX    R1,*-6                                                           
         STC   R1,LEN4TXT                                                       
         LA    RE,NXT.ERDTEXT                                                   
         STCM  RE,B'1111',ADR4TXT                                               
                                                                                
         MVC   KEY4TXT(L'SAVEST#),SAVEST#                                       
         MVC   ROW4TXT,SAVEROW                                                  
         MVC   SUB4TXT,SAVESUB                                                  
         OI    PROCMODE,PROCTDQ    Text processing                              
         MVI   LEN4TX2,FFQ                                                      
         MVI   LEN4TX3,FFQ                                                      
         MVI   LEN4TX4,FFQ                                                      
                                                                                
         LA    RF,LEN4TX2                                                       
         LHI   R0,NUMTXTS-1                                                     
                                                                                
AGFEST36 LLC   R1,NXT.ERDLN        Check for more text                          
         AR    R5,R1                                                            
         CLI   NXT.ERDEL,ERDELQ                                                 
         JNE   AGFEST38                                                         
         CLI   NXT.ERDTYP,ERDTWTQ                                               
         JNE   AGFEST38                                                         
         CLI   NXT.ERDLN,ERDTLNQ                                                
         JNH   AGFEST38                                                         
         LLC   R1,NXT.ERDLN                                                     
         SHI   R1,ERDTLNQ+1                                                     
         STC   R1,LEN4TX2-LEN4TX2(RF)                                           
         LA    RE,NXT.ERDTEXT                                                   
         STCM  RE,B'1111',ADR4TX2-LEN4TX2(RF)                                   
         AHI   RF,LEN4TX3-LEN4TX2                                               
         JCT   R0,AGFEST36                                                      
         DROP  NXT                                                              
                                                                                
AGFEST38 STCM  R2,B'1111',SAVEADR                                               
         JAS   RE,EFLKAHD                                                       
         SAM24 ,                                                                
                                                                                
         CLI   SAVETYP,SAVETEQ     No more?                                     
         JE    AGFESTXN                                                         
         MVI   SAVETYP,SAVETNQ                                                  
         J     AGFESTXY            Start again if w/c entry                     
                                                                                
AGFEST40 DS    0H                  * Process generic item data *                
                                                                                
         SAM24 ,                   R2 point to current item data entry          
         JAS   RE,EFAINIT                                                       
         SAM31 ,                                                                
                                                                                
*        MVC   ESTFCIN,SAVEINST                                                 
*        MVC   ESTFCTN,SAVECTNA                                                 
                                                                                
         XR    R1,R1                                                            
         ICM   R1,B'0111',SAV_ESEQ                                              
         AHI   R1,1                                                             
         STCM  R1,B'0111',SAV_ESEQ                                              
                                                                                
WC       USING ERDELD,R5                                                        
         ICM   R5,B'1111',SAVEWCA  get w/c entry                                
                                                                                
         MVC   ESTFWCD,WC.ERDWCOD                                               
         MVC   FULL(2),WC.ERDWSEQ                                               
         SAM24 ,                                                                
         EDITR (B2,FULL),(6,SAVEROW),0,ALIGN=LEFT,ZERO=NOBLANK                  
         EDITR (B3,SAV_ESEQ),(6,SAVESUB),0,ALIGN=LEFT,ZERO=NOBLANK              
         SAM31 ,                                                                
                                                                                
         MVC   ESTFTXR+0(6),SAVEST#  T15F110 TextRow ID                         
         MVI   ESTFTXR+6,UNDSCQ                                                 
         MVC   ESTFTXR+6+1(6),SAVEROW                                           
         MVI   ESTFTXR+6+1+6,UNDSCQ                                             
         MVC   ESTFTXR+6+1+6+1(6),SAVESUB                                       
         SAM24 ,                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'ESTFTXR,ESTFTXR)                            
         SAM31 ,                                                                
                                                                                
         MVC   ESTFCAT(L'EMDSCH),SAVESCH                                        
         MVI   ESTFCAT+L'EMDSCH,UNDSCQ                                          
         CLC   WC.ERDWCAT,EDCFFS                                                
         JE    AGFEST42                                                         
         MVC   ESTFCAT+L'EMDSCH+1(L'ERDWCAT),WC.ERDWCAT                         
                                                                                
AGFEST42 SAM24 ,                   T15F106 Category ID                          
         GOTOR =V(SQUASHIT),DMCB,(L'ESTFCAT,ESTFCAT)                            
         SAM31 ,                                                                
                                                                                
*        EDITR (P6,WC.ERDWAMT),(L'ESTFAMT-1,ESTFAMT+1),0,ZERO=NOBLANK, +        
               ALIGN=LEFT                                                       
                                                                                
         CLC   SAVECUR,SAVCCUR     Skip if currency as calculated               
         JNE   AGFEST46            differently                                  
                                                                                
         ZAP   DUB,ERDIMUL         TBWAGER estimates 231421/C20115              
         CP    ERDIMUL,PZERO       DDB estimate 0Z1297                          
         JNE   AGFEST43                                                         
         GOTOR CHKEIM                                                           
         JE    AGFEST43                                                         
***      CP    WC.ERDWAMT,PZERO                                                 
***      JE    AGFEST43                                                         
         ZAP   DUB,P100                                                         
                                                                                
AGFEST43 ZAP   PL16,ERDIAPR                                                     
         MP    PL16,DUB                                                         
         SRP   PL16,64-2,5                                                      
         ZAP   EDDUB,PL16          Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST44                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST44 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ESTFAMT,ESTFAMT)                     
         SAM31 ,                                                                
                                                                                
AGFEST46 CLC   SAVECUR,SAVCCUR     Currency?                                    
         JE    AGFEST50                                                         
                                                                                
*        EDITR (P6,WC.ERDWFCA),(L'ESTFCAM-1,ESTFCAM+1),0,ZERO=NOBLANK, +        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   DUB,ERDIMUL         TBWAGER estimates 231421/C20115              
         CP    ERDIMUL,PZERO                                                    
         JNE   AGFEST47                                                         
         GOTOR CHKEIM                                                           
         JE    AGFEST47                                                         
***      CP    WC.ERDWAMT,PZERO                                                 
***      JE    AGFEST47                                                         
         ZAP   DUB,P100                                                         
                                                                                
AGFEST47 ZAP   PL16,ERDIFPR                                                     
         MP    PL16,DUB                                                         
         SRP   PL16,64-2,5                                                      
         ZAP   EDDUB,PL16          Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST48                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST48 SAM24 ,                   T15F117 Foreign Cur Amt                      
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFCAM,ESTFCAM)                     
                                                                                
         USING EURKBLKD,R6                                                      
         LA    R6,SAVEEUR          Calculate ESTFAMT from current FC            
         OC    EURKRLRT,EURKRLRT   Skip if GETQ error                           
         JZ    AGFEST49                                                         
         MVC   WORK(EURKBLKL),SAVEEUR                                           
         LHI   R0,APPLYQ+INVERTQ                                                
         MVC   EURKCUFR,SAVCCUR                                                 
         MVC   EURKCUTO,SAVECUR                                                 
                                                                                
         GOTO1 =V(EUREKA),DMCB,((R0),EURKBLKD),EDDUB,DUB                        
         MVC   SAVEEUR(EURKBLKL),WORK                                           
         CLI   0(R1),0                                                          
         JNE   AGFEST49            Skip if error                                
         ZAP   EDDUB,DUB                                                        
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ESTFAMT,ESTFAMT)                     
         DROP  R6                                                               
                                                                                
AGFEST49 DS    0H                                                               
         SAM31 ,                                                                
                                                                                
AGFEST50 MVC   DUB,ERDISEQ                                                      
         SAM24 ,                                                                
         XOUT  DUB,ESTFITM,3                                                    
         SAM31 ,                                                                
                                                                                
*        EDITR (P6,ERDIMUL),(L'ESTFHON-1,ESTFHON+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   DUB,ERDIMUL         TBWAGER estimates 231421/C20115              
*        CP    ERDIMUL,PZERO       (not done here just added                    
*        JNE   AGFEST51            as comment)                                  
*        ZAP   DUB,P100                                                         
                                                                                
AGFEST51 ZAP   EDDUB,DUB           Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST52                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST52 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFHON,ESTFHON)                     
         SAM31 ,                                                                
                                                                                
AGFEST54 DS    0H                                                               
                                                                                
*        EDITR (P6,ERDIAPR),(L'ESTFRAT-1,ESTFRAT+1),0,ZERO=NOBLANK,    +        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,ERDIAPR       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST55                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST55 SAM24 ,                   T15F115 For. cur rate                        
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFRAT,ESTFRAT)                     
         SAM31 ,                                                                
                                                                                
NXT      USING ERDELD,R5                                                        
AGFEST56 LLC   R5,ERDLN            Check next element is text                   
         AR    R5,R2                                                            
         CLI   NXT.ERDEL,ERDELQ                                                 
         JNE   AGFEST59                                                         
         CLI   NXT.ERDTYP,ERDTITQ                                               
         JNE   AGFEST59                                                         
                                                                                
         CLI   NXT.ERDLN,ERDTLNQ                                                
         JNH   AGFEST59                                                         
         LLC   R1,NXT.ERDLN                                                     
         SHI   R1,ERDTLNQ+1                                                     
*        CHI   R1,L'ESTFTXT-1                                                   
*        JNH   AGFEST57                                                         
*        LHI   R1,L'ESTFTXT-1                                                   
*                                                                               
*GFEST57 MVC   ESTFTXT(0),NXT.ERDTEXT                                           
*        EX    R1,*-6                                                           
         STC   R1,LEN4TXT                                                       
         LA    RE,NXT.ERDTEXT                                                   
         STCM  RE,B'1111',ADR4TXT                                               
                                                                                
         MVC   KEY4TXT(L'SAVEST#),SAVEST#                                       
         MVC   ROW4TXT,SAVEROW                                                  
         MVC   SUB4TXT,SAVESUB                                                  
         OI    PROCMODE,PROCTDQ    Text processing                              
         MVI   LEN4TX2,FFQ                                                      
         MVI   LEN4TX3,FFQ                                                      
         MVI   LEN4TX4,FFQ                                                      
                                                                                
         LA    RF,LEN4TX2                                                       
         LHI   R0,NUMTXTS-1                                                     
                                                                                
AGFEST58 LLC   R1,NXT.ERDLN        Check for more text                          
         AR    R5,R1                                                            
         CLI   NXT.ERDEL,ERDELQ                                                 
         JNE   AGFEST59                                                         
         CLI   NXT.ERDTYP,ERDTWTQ                                               
         JNE   AGFEST59                                                         
         CLI   NXT.ERDLN,ERDTLNQ                                                
         JNH   AGFEST59                                                         
         LLC   R1,NXT.ERDLN                                                     
         SHI   R1,ERDTLNQ+1                                                     
         STC   R1,LEN4TX2-LEN4TX2(RF)                                           
         LA    RE,NXT.ERDTEXT                                                   
         STCM  RE,B'1111',ADR4TX2-LEN4TX2(RF)                                   
         AHI   RF,LEN4TX3-LEN4TX2                                               
         JCT   R0,AGFEST58                                                      
         DROP  NXT                                                              
                                                                                
AGFEST59 JAS   RE,EFLKAHD                                                       
         SAM24 ,                                                                
                                                                                
         CLI   SAVETYP,SAVETEQ     No more?                                     
         JE    AGFESTXN                                                         
         CLI   SAVETYP,ERDTIDQ     Another one?                                 
         JNE   AGFEST60                                                         
         MVC   SAVEADR,FULL        Set next time address                        
         J     AGFESTXY                                                         
                                                                                
AGFEST60 CLI   SAVETYP,ERDTWDQ                                                  
         JNE   AGFEST62            (my logic is crap)                           
         MVI   SAVETYP,SAVETNQ                                                  
         J     AGFESTXY            Start again if w/c entry                     
                                                                                
AGFEST62 CLI   SAVETYP,ERDTIRQ     ? does exist though ... ?                    
         JNE   *+2                                                              
         MVC   SAVEADR,FULL        Set next time address                        
         J     AGFESTXY                                                         
                                                                                
AGFEST64 DS    0H                  * Process time item data *                   
                                                                                
         SAM24 ,                   R2 point to current item data entry          
         JAS   RE,EFAINIT                                                       
         SAM31 ,                                                                
                                                                                
*        MVC   ESTFCIN,SAVEINST                                                 
*        MVC   ESTFCTN,SAVECTNA                                                 
                                                                                
         XR    R1,R1                                                            
         ICM   R1,B'0111',SAV_ESEQ                                              
         AHI   R1,1                                                             
         STCM  R1,B'0111',SAV_ESEQ                                              
                                                                                
WC       USING ERDELD,R5                                                        
         ICM   R5,B'1111',SAVEWCA  get w/c entry                                
         MVC   ESTFWCD,WC.ERDWCOD                                               
         MVC   FULL(2),WC.ERDWSEQ                                               
         SAM24 ,                                                                
         EDITR (B2,FULL),(6,SAVEROW),0,ALIGN=LEFT,ZERO=NOBLANK                  
         EDITR (B3,SAV_ESEQ),(6,SAVESUB),0,ALIGN=LEFT,ZERO=NOBLANK              
         SAM31 ,                                                                
                                                                                
         MVC   ESTFTXR+0(6),SAVEST#  T15F110 TextRow ID                         
         MVI   ESTFTXR+6,UNDSCQ                                                 
         MVC   ESTFTXR+6+1(6),SAVEROW                                           
         MVI   ESTFTXR+6+1+6,UNDSCQ                                             
         MVC   ESTFTXR+6+1+6+1(6),SAVESUB                                       
         SAM24 ,                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'ESTFTXR,ESTFTXR)                            
         SAM31 ,                                                                
                                                                                
         MVC   ESTFCAT(L'EMDSCH),SAVESCH                                        
         MVI   ESTFCAT+L'EMDSCH,UNDSCQ                                          
         CLC   WC.ERDWCAT,EDCFFS                                                
         JE    AGFEST66                                                         
         MVC   ESTFCAT+L'EMDSCH+1(L'ERDWCAT),WC.ERDWCAT                         
                                                                                
AGFEST66 SAM24 ,                                                                
         GOTOR =V(SQUASHIT),DMCB,(L'ESTFCAT,ESTFCAT)                            
         SAM31 ,                                                                
                                                                                
         MVI   ESTFIST,TRUEQ                                                    
         MVC   ESTF1RA(2),ORUL                                                  
         MVC   ESTF1RA+2(12),ERDITAC                                            
         GOTO1 =V(SPLITAC),ESTF1RA                                              
         CLI   WORK+25,C'0'                                                     
         JE    AGFEST67                                                         
         MVC   ESTF1RA1(12),WORK+30+00+02                                       
         CLI   WORK+25,C'1'                                                     
         JE    AGFEST67                                                         
         MVC   ESTF1RA2(12),WORK+30+15+02                                       
         CLI   WORK+25,C'2'                                                     
         JE    AGFEST67                                                         
         MVC   ESTF1RA3(12),WORK+30+30+02                                       
         CLI   WORK+25,C'3'                                                     
         JE    AGFEST67                                                         
         MVC   ESTF1RA4(12),WORK+30+45+02                                       
                                                                                
AGFEST67 DS    0H                                                               
                                                                                
*        EDITR (P6,WC.ERDWAMT),(L'ESTFAMT-1,ESTFAMT+1),0,ZERO=NOBLANK, *        
               ALIGN=LEFT                                                       
                                                                                
         CLC   SAVECUR,SAVCCUR     Skip if currency as calculated               
         JNE   AGFEST70            differently                                  
                                                                                
***      ZAP   EDDUB,WC.ERDWAMT    Normal cur                                   
         ZAP   PL16,ERDIRAT                                                     
         MP    PL16,ERDIHRS                                                     
         SRP   PL16,64-2,5                                                      
         ZAP   EDDUB,PL16          Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST68                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST68 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ESTFAMT,ESTFAMT)                     
         SAM31 ,                                                                
                                                                                
AGFEST70 CLC   SAVECUR,SAVCCUR     Currency?                                    
         JE    AGFEST74                                                         
                                                                                
*        EDITR (P6,WC.ERDWFCA),(L'ESTFCAM-1,ESTFCAM+1),0,ZERO=NOBLANK, *        
               ALIGN=LEFT                                                       
                                                                                
***      ZAP   EDDUB,WC.ERDWFCA    Normal cur                                   
         ZAP   PL16,ERDIRAT        (what else to do as default?)                
         CLI   ERDLN,ERDITLQ                                                    
         JL    AGFEST71                                                         
         TM    ERDITND,ERDITFQ                                                  
         JZ    AGFEST71                                                         
         ZAP   PL16,ERDIRAF                                                     
                                                                                
AGFEST71 MP    PL16,ERDIHRS                                                     
         SRP   PL16,64-2,5                                                      
         ZAP   EDDUB,PL16          Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST72                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST72 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFCAM,ESTFCAM)                     
                                                                                
         USING EURKBLKD,R6                                                      
         LA    R6,SAVEEUR          Calculate ESTFAMT from current FC            
         OC    EURKRLRT,EURKRLRT   Skip if GETQ error                           
         JZ    AGFEST73                                                         
         MVC   WORK(EURKBLKL),SAVEEUR                                           
         LHI   R0,APPLYQ+INVERTQ                                                
         MVC   EURKCUFR,SAVCCUR                                                 
         MVC   EURKCUTO,SAVECUR                                                 
                                                                                
         GOTO1 =V(EUREKA),DMCB,((R0),EURKBLKD),EDDUB,DUB                        
         MVC   SAVEEUR(EURKBLKL),WORK                                           
         CLI   0(R1),0                                                          
         JNE   AGFEST73            Skip if error                                
         ZAP   EDDUB,DUB                                                        
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'ESTFAMT,ESTFAMT)                     
         DROP  R6                                                               
                                                                                
AGFEST73 DS    0H                                                               
         SAM31 ,                                                                
         DROP  WC                                                               
                                                                                
AGFEST74 DS    0H                                                               
                                                                                
*        EDITR (P6,ERDIHRS),(L'ESTFHON-1,ESTFHON+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,ERDIHRS       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST76                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST76 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFHON,ESTFHON)                     
         SAM31 ,                                                                
                                                                                
*        EDITR (P6,ERDIRAT),(L'ESTFRAT-1,ESTFRAT+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,ERDIRAT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEST77                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEST77 SAM24 ,                   T15F115 For. cur rate                        
         GOTO1 =V(SETAMNT),DMCB,SAVECUR,(L'ESTFRAT,ESTFRAT)                     
         SAM31 ,                                                                
                                                                                
NXT      USING ERDELD,R5                                                        
AGFEST78 LLC   R5,ERDLN            Check next element is text                   
         AR    R5,R2                                                            
         CLI   NXT.ERDEL,ERDELQ                                                 
         JNE   AGFEST82                                                         
         CLI   NXT.ERDTYP,ERDTITQ                                               
         JNE   AGFEST82                                                         
                                                                                
         CLI   NXT.ERDLN,ERDTLNQ                                                
         JNH   AGFEST82                                                         
         LLC   R1,NXT.ERDLN                                                     
         SHI   R1,ERDTLNQ+1                                                     
*        CHI   R1,L'ESTFTXT-1                                                   
*        JNH   AGFEST80                                                         
*        LHI   R1,L'ESTFTXT-1                                                   
*                                                                               
*GFEST80 MVC   ESTFTXT(0),NXT.ERDTEXT                                           
*        EX    R1,*-6                                                           
         STC   R1,LEN4TXT                                                       
         LA    RE,NXT.ERDTEXT                                                   
         STCM  RE,B'1111',ADR4TXT                                               
                                                                                
         MVC   KEY4TXT(L'SAVEST#),SAVEST#                                       
         MVC   ROW4TXT,SAVEROW                                                  
         MVC   SUB4TXT,SAVESUB                                                  
         OI    PROCMODE,PROCTDQ    Text processing                              
         MVI   LEN4TX2,FFQ                                                      
         MVI   LEN4TX3,FFQ                                                      
         MVI   LEN4TX4,FFQ                                                      
                                                                                
         LA    RF,LEN4TX2                                                       
         LHI   R0,NUMTXTS-1                                                     
                                                                                
AGFEST81 LLC   R1,NXT.ERDLN        Check for more text                          
         AR    R5,R1                                                            
         CLI   NXT.ERDEL,ERDELQ                                                 
         JNE   AGFEST82                                                         
         CLI   NXT.ERDTYP,ERDTWTQ                                               
         JNE   AGFEST82                                                         
         CLI   NXT.ERDLN,ERDTLNQ                                                
         JNH   AGFEST82                                                         
         LLC   R1,NXT.ERDLN                                                     
         SHI   R1,ERDTLNQ+1                                                     
         STC   R1,LEN4TX2-LEN4TX2(RF)                                           
         LA    RE,NXT.ERDTEXT                                                   
         STCM  RE,B'1111',ADR4TX2-LEN4TX2(RF)                                   
         AHI   RF,LEN4TX3-LEN4TX2                                               
         JCT   R0,AGFEST81                                                      
         DROP  NXT                                                              
                                                                                
AGFEST82 JAS   RE,EFLKAHD                                                       
         SAM24 ,                                                                
                                                                                
         CLI   SAVETYP,SAVETEQ     No more?                                     
         JE    AGFESTXN                                                         
         CLI   SAVETYP,ERDTIRQ     Another one?                                 
         JNE   AGFEST84                                                         
         MVC   SAVEADR,FULL        Set next time address                        
         J     AGFESTXY                                                         
                                                                                
AGFEST84 CLI   SAVETYP,ERDTWDQ                                                  
         JNE   AGFEST86            (my logic is crap)                           
         MVI   SAVETYP,SAVETNQ                                                  
         J     AGFESTXY            Start again if w/c entry                     
                                                                                
AGFEST86 CLI   SAVETYP,ERDTIDQ     ? does exist though ... ?                    
         JNE   *+2                                                              
         MVC   SAVEADR,FULL        Set next time address                        
         J     AGFESTXY                                                         
                                                                                
AGFESTXY MVI   DMCB+8,RETBFFQ      indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGFESTXN MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
                                                                                
EFAINIT  ST    RE,SAVERE           * Estimate Facts initialisation *            
                                                                                
*&&UK*&& MVC   ESTFAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   ESTFAGY(2),NORTHAM                                               
         MVI   ESTFAGY+2,UNDSCQ                                                 
         MVC   ESTFAGY+2+1(2),SAVCALP                                           
         MVC   ESTFEID,SAVEST#                                                  
         MVC   ESTFEXI,SAVEST#                                                  
         GOTO1 =V(SET1DAT),SAVESTD                                              
         MVC   ESTFDAT,WORK                                                     
         MVC   ESTFCUR,SAVECUR                                                  
         MVC   ESTFCLI(L'ESTKCLI),ESTKCLI                                       
         MVC   ESTFPRO(L'ESTKPRO),ESTKPRO                                       
         MVC   ESTFJOB(L'ESTKJOB),ESTKJOB                                       
         MVC   ESTFOFF,SAVEOFF                                                  
                                                                                
***      GOTO1 =V(SETACTV),SAVEACT                                              
         GOTO1 =V(SETACTV),0                                                    
         MVC   ESTFUTS,WORK                                                     
                                                                                
         MVI   ESTFIST,FALSEQ     (default)                                     
                                                                                
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
EFLKAHD  ST    RE,SAVERE           * Look ahead for type of fact *              
                                                                                
LKAH     USING ERDELD,R1                                                        
         LA    R1,ERDELD           Look ahead for items/time                    
         MVI   SAVETYP,SAVETEQ                                                  
                                                                                
EFLKA01  LLC   RF,LKAH.ERDLN                                                    
         AR    R1,RF                                                            
                                                                                
         CLI   LKAH.ERDEL,0                                                     
         JE    EFLKA09                                                          
         CLI   LKAH.ERDEL,ERDELQ                                                
         JNE   EFLKA09                                                          
         CLI   LKAH.ERDTYP,ERDTCSQ This comes first ...|                        
         JNE   EFLKA02                                                          
         MVC   SAVEINST,LKAH.ERDCINS                                            
*        MVC   SAVECTNA,LKAH.ERDCTNA                                            
         J     EFLKA01                                                          
                                                                                
EFLKA02  CLI   LKAH.ERDTYP,ERDTWDQ                                              
         JE    EFLKA03                                                          
         CLI   LKAH.ERDTYP,ERDTIDQ                                              
         JE    EFLKA04                                                          
         CLI   LKAH.ERDTYP,ERDTIRQ                                              
         JE    EFLKA05                                                          
         J     EFLKA01                                                          
         DROP  LKAH                                                             
                                                                                
EFLKA03  MVI   SAVETYP,ERDTWDQ                                                  
         J     EFLKA09                                                          
                                                                                
EFLKA04  MVI   SAVETYP,ERDTIDQ                                                  
         J     EFLKA09                                                          
                                                                                
EFLKA05  MVI   SAVETYP,ERDTIRQ                                                  
                                                                                
EFLKA09  ST    R1,FULL             Save new address                             
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
         DROP  R2,R3,R4                                                         
                                                                                
*WC      USING ERDELD,R5                                                        
         USING ERDELD,R2                                                        
CHKEIM   ST    RE,SAVERE           Check estimate item multiplier 0/1           
         DS    0H                  (R2=current item, R5=current w/c)            
                                                                                
***      CP    WC.ERDWAMT,PZERO    Pre-CHKEIM code ...                          
***      JE    CHKEIMY                                                          
***      J     CHKEIMN                                                          
                                                                                
* New code here, predecessor code see Issue/problem below. Current code         
* eased on MWHE/NSHE findings:                                                  
*                                                                               
* > For normal items with a price a zero multiplier is treated as zero,         
* > where items are free form zero multiplier is treated as 1.                  
*                                                                               
                                                                                
         CLI   ERDTYP,ERDTIDQ      Skip element with other type                 
         JNE   CHKEIMY                                                          
         OC    ERDISEQ,ERDISEQ     Skip regular item based element              
         JNZ   CHKEIMY                                                          
         J     CHKEIMN             Else make multiplier 1                       
                                                                                
*                                                                               
* Issue/problem: if we have more than 1 zero ERDIMUL item element for           
*                the current work code then we can have both '0', both          
*                '1' or a mixture '0/1' (least likely), but either way          
*                - how to calculate? And what about currency? Should            
*                be ok - but handle differences or use currency (dp).           
*                                                                               
*ST      USING ERDELD,RF                                                        
*        LR    RF,R5                                                            
*        ZAP   EDDUB,PZERO                                                      
*                                                                               
*HKEIM2  LLC   RE,TST.ERDLN                                                     
*        AR    RF,RE                                                            
*        CLI   TST.ERDEL,0                                                      
*        JE    CHKEIM6                                                          
*        CLI   TST.ERDEL,ERDELQ                                                 
*        JNE   CHKEIM2                                                          
*        CLI   TST.ERDTYP,ERDTWDQ                                               
*        JE    CHKEIM6                                                          
*        CLI   TST.ERDTYP,ERDTIDQ  item data?                                   
*        JE    CHKEIM4                                                          
*        CLI   TST.ERDTYP,ERDTIRQ                                               
*        JNE   CHKEIM2                                                          
*        ZAP   PL16,TST.ERDIRAT                                                 
*        MP    PL16,TST.ERDIHRS                                                 
*        SRP   PL16,64-2,5                                                      
*        AP    EDDUB,PL16                                                       
*        J     CHKEIM2                                                          
*                                                                               
*HKEIM4  CR    RF,R2               skip current                                 
*        JE    CHKEIM2                                                          
*        CP    TST.ERDIMUL,PZERO   skip any zero multiplier                     
*        JE    CHKEIM2                                                          
*        ZAP   PL16,TST.ERDIAPR    item article proce/multiplier data           
*        MP    PL16,TST.ERDIMUL                                                 
*        SRP   PL16,64-2,5                                                      
*        AP    EDDUB,PL16                                                       
*        J     CHKEIM2                                                          
*                                                                               
*HKEIM6  CP    EDDUB,WC.ERDWAMT    if they match then multipliers are           
*        JNE   CHKEIMN             really zero                                  
*        DROP  TST                                                              
* ends here *                                                                   
                                                                                
CHKEIMY  LHI   R1,1                                                             
         J     CHKEIMX                                                          
                                                                                
CHKEIMN  LHI   R1,0                                                             
                                                                                
CHKEIMX  CHI   R1,1                                                             
         L     RE,SAVERE                                                        
         BR    RE                                                               
*        DROP  WC                                                               
         DROP  R2                                                               
                                                                                
EDCFFS   DC    X'FFFF'                                                          
AGFESTLT DC    A(LITERAL)                                                       
*                                                                               
TRTABUS  DC    256AL1(0)           Find 1st underscore                          
         ORG   TRTABUS+C'_'                                                     
         DC    X'FF'                                                            
         ORG   ,                                                                
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AG2ESTC - Extract estimate extra dimension                          *         
***********************************************************************         
                                                                                
AG2ESTC  NMOD1 WORKX-WORKD,*AG2EST*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AG2ESTLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,EST2LENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXEST2Q                                                
                                                                                
         SAM31 ,                                                                
         CLI   DXMODE,DXLOADQ      For load and multiple records update         
         JE    AG2EST02            use Buffer                                   
         TM    PROCMOD2,PROCMRQ                                                 
         JZ    *+2                                                              
                                                                                
AG2EST02 L     R2,ABUFFER                                                       
         TM    PROCMODE,PROCOPQ                                                 
         JZ    AG2EST04                                                         
         L     R2,ABUFOLD                                                       
                                                                                
AG2EST04 DS    0H                                                               
*&&UK*&& MVC   EST2AGY(2),EUROPE   Set data                                     
*&&US*&& MVC   EST2AGY(2),NORTHAM                                               
         MVI   EST2AGY+2,UNDSCQ                                                 
         MVC   EST2AGY+2+1(2),SAVCALP                                           
         MVC   EST2GNO,SAVEST#                                                  
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   EST2UTS,WORK                                                     
                                                                                
         LA    R5,EST2X01T                                                      
         J     AG2EST12                                                         
                                                                                
         USING ERDELD,R2                                                        
AG2EST10 LLC   R1,ERDLN                                                         
         AR    R2,R1                                                            
                                                                                
AG2EST12 CLI   ERDEL,0                                                          
         JE    AG2EST40                                                         
         CLI   ERDEL,ERDELQ                                                     
         JE    AG2EST14                                                         
         CLI   ERDEL,XDFELQ                                                     
         JE    AG2EST20                                                         
         J     AG2EST10                                                         
                                                                                
AG2EST14 CLI   ERDLN,ERDTLNQ                                                    
         JNH   AG2EST10                                                         
         LA    RE,EST2HDR                                                       
         LHI   RF,L'EST2HDR-1                                                   
         CLI   ERDTYP,ERDTHTQ                                                   
         JE    AG2EST16                                                         
         LA    RE,EST2ATX                                                       
         LHI   RF,L'EST2ATX-1                                                   
         CLI   ERDTYP,ERDTETQ                                                   
         JE    AG2EST16                                                         
         LA    RE,EST2FTR                                                       
         LHI   RF,L'EST2FTR-1                                                   
         CLI   ERDTYP,ERDTFTQ                                                   
         JNE   AG2EST10                                                         
                                                                                
AG2EST16 LLC   R1,ERDLN                                                         
         SHI   R1,ERDTLNQ+1                                                     
         CR    R1,RF                                                            
         JNH   AG2EST18                                                         
         LR    R1,RF                                                            
                                                                                
AG2EST18 MVC   0(0,RE),ERDTEXT                                                  
         EX    R1,*-6                                                           
         J     AG2EST10                                                         
                                                                                
         USING XDFELD,R2                                                        
AG2EST20 LA    R1,EST2X10T         Skip if > 10                                 
         CR    R5,R1                                                            
         JH    AG2EST10                                                         
         MVC   0(L'EST2X01T,R5),XDFOTYP                                         
         CLI   XDFOTYP,XDFEDNQ     N=numeric                                    
         JE    AG2EST22                                                         
         CLI   XDFOTYP,XDFEDXQ     X=dropdown                                   
         JE    AG2EST22                                                         
         CLI   XDFOTYP,XDFEDCQ     C=char                                       
         JNE   AG2EST26                                                         
                                                                                
AG2EST22 LLC   RE,XDFLN                                                         
         SHI   RE,XDFOLNQ+1                                                     
         CHI   RE,L'EST2X01V-1                                                  
         JNH   AG2EST24                                                         
         LHI   RE,L'EST2X01V-1                                                  
                                                                                
AG2EST24 MVC   EST2X01V-EST2X01T(0,R5),XDFODTA                                  
         EX    RE,*-6                                                           
         J     AG2EST34                                                         
                                                                                
AG2EST26 CLI   XDFOTYP,XDFEDDQ     D=DATE                                       
         JNE   AG2EST28                                                         
         GOTO1 =V(SET1DAT),XDFODTA                                              
         MVC   EST2X01V-EST2X01T(10,R5),WORK                                    
         J     AG2EST34                                                         
                                                                                
AG2EST28 CLI   XDFOTYP,XDFEDYQ     Y=YES/NO                                     
         JNE   AG2EST30                                                         
         MVC   EST2X01V-EST2X01T(1,R5),XDFODTA                                  
         J     AG2EST34                                                         
                                                                                
AG2EST30 CLI   XDFOTYP,XDFEDAQ     A=AMOUNT                                     
         JNE   *+2                                                              
                                                                                
         LA    R6,EST2X01V-EST2X01T(R5)                                         
                                                                                
*        EDITR (P6,XDFODTA),(15,0(R6)),0,ZERO=NOBLANK,MINUS=YES,       *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,XDFODTA(6)    Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AG2EST32                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AG2EST32 SAM24 ,                                                                
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(15,0(R6))                              
         SAM31 ,                                                                
                                                                                
AG2EST34 SAM24 ,                                                                
         GOTO1 =V(GETXDF),XDFOCOD                                               
         SAM31 ,                                                                
         MVC   EST2X01N-EST2X01T(L'EST2X01N,R5),WORK                            
                                                                                
         AHI   R5,EST2X02T-EST2X01T                                             
         J     AG2EST10                                                         
                                                                                
AG2EST40 DS    0H                  Pass previous indicator back                 
         SAM24 ,                                                                
         MVC   DMCB+8(L'RETBYTE),RETBYTE                                        
         J     EXIT                                                             
                                                                                
         DROP  R2,R3                                                            
                                                                                
AG2ESTLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXEXPC - Extract expense claim dimension data                      *         
***********************************************************************         
                                                                                
AGXEXPC  NMOD1 WORKX-WORKD,*AGXEXP*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXEXPLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING EXCRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,EXPDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXEXPDQ                                                
                                                                                
         XC    SAVEXP(SAVEXPLQ),SAVEXP                                          
                                                                                
         MVC   SAVXTYP,EXCKTYPE    Save type and number                         
         MVC   SAVXREF,EXCKREF                                                  
                                                                                
*&&UK*&& MVC   EXPDAGY(2),EUROPE   EXPD: Set agy data                           
*&&US*&& MVC   EXPDAGY(2),NORTHAM                                               
         MVI   EXPDAGY+2,UNDSCQ                                                 
         MVC   EXPDAGY+2+1(2),SAVCALP                                           
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   EXPDUTS,WORK        EXPD: Update time stamp                      
                                                                                
         MVC   EXPDCNO(L'SAVXREF),SAVXREF                                       
         MVI   EXPDCNO+L'SAVXREF,UNDSCQ                                         
         MVC   EXPDCNO+L'SAVXREF+1(L'SAVXTYP),SAVXTYP                           
                                                                                
         CLI   EXCKTYPE,EXCPTDQ                                                 
         JNE   AGXEXP00                                                         
         MVC   EXPDDRFN,EXPDCNO                                                 
* >>>    MVC   EXPDDRFN,EXPDCID    >>> still with NSHE                          
                                                                                
AGXEXP00 XR    R1,R1                                                            
         ICM   R1,B'0011',EXCKDATE                                              
         LNR   R1,R1                                                            
         STH   R1,HALF                                                          
         GOTO1 =V(SET2DAT),HALF                                                 
         MVC   EXPDCDT,WORK        Expense claim date                           
                                                                                
         GOTO1 =V(SPLIT1R),EXCK1RAC                                             
         MVC   EXPD1ROC,WORK+00    1R office code                               
         MVC   EXPD1RDC,WORK+06    1R department code                           
         MVC   EXPD1RSD,WORK+12    1R sub department code                       
         MVC   EXPD1RPC,WORK+18    1R person code                               
         MVC   SAVXPID,EXPD1RPC                                                 
                                                                                
*        LA    R1,EXCKPIDB                                                      
*        GOTO1 =V(GETSPD)                                                       
*        MVC   SAVXPID,WORK+100                                                 
                                                                                
         MVI   EXPDCLST,EX_SUBQ                                                 
         TM    EXCRSTAT,EXCSSUBM                                                
         JNZ   AGXEXP01                                                         
         MVI   EXPDCLST,EX_PAPQ                                                 
         TM    EXCRSTAT,EXCSPAPP                                                
         JNZ   AGXEXP01                                                         
         MVI   EXPDCLST,EX_POSQ                                                 
         TM    EXCRSTAT,EXCSCOMP                                                
         JNZ   AGXEXP01                                                         
         MVI   EXPDCLST,EX_REJQ                                                 
         TM    EXCRSTAT,EXCSREJE                                                
         JNZ   AGXEXP01                                                         
         MVI   EXPDCLST,EX_LDEQ                                                 
         TM    EXCRSTAT,EXCSLOGD                                                
         JNZ   AGXEXP01                                                         
         MVI   EXPDCLST,EX_FAPQ                                                 
         TM    EXCRSTAT,EXCSFNTA                                                
         JNZ   AGXEXP01                                                         
         MVI   EXPDCLST,EX_INPQ                                                 
                                                                                
         USING CLDELD,R2                                                        
AGXEXP01 LA    R2,EXCRFST                                                       
         MVI   BYTE,0                                                           
                                                                                
AGXEXP02 CLI   CLDEL,CLDELQ        No data required yet                         
         JE    AGXEXP06                                                         
         CLI   CLDEL,CIDELQ                                                     
         JE    AGXEXP30                                                         
         CLI   CLDEL,0                                                          
         JE    AGXEXP50                                                         
                                                                                
AGXEXP04 LLC   R1,CLDLN                                                         
         AR    R2,R1                                                            
         J     AGXEXP02                                                         
                                                                                
AGXEXP06 CLI   CLDTYPE,CLDTHDRQ    Main header                                  
         JNE   AGXEXP20                                                         
         OI    BYTE,X'80'          Ensure main element exists                   
         LLC   R1,CLDLN                                                         
         SHI   R1,CLDLNQ+1                                                      
         CHI   R1,0                                                             
         JL    AGXEXP10                                                         
         CHI   R1,L'EXPDCLNM-1                                                  
         JNH   AGXEXP08                                                         
         LHI   R1,L'EXPDCLNM-1                                                  
                                                                                
AGXEXP08 MVC   EXPDCLNM(0),CLDDESC                                              
         EX    R1,*-6                                                           
                                                                                
AGXEXP10 DS    0H                                                               
*        OC    CLDAPPID,CLDAPPID   see CIDTYPE=CLDFNAPQ if empty                
*        JZ    AGXEXP12                                                         
*        LA    R1,CLDAPPID                                                      
*        OI    BYTE,X'04'                                                       
*        GOTO1 =V(GETSPD)                                                       
*        MVC   EXPDFACD,WORK+100                                                
*        MVC   EXPDFAFN,WORK+00                                                 
*        MVC   EXPDFAMN,WORK+32                                                 
*        MVC   EXPDFALN,WORK+16                                                 
*                                                                               
*GXEXP12 DS    0H                                                               
         J     AGXEXP04                                                         
                                                                                
AGXEXP20 DS    0H                                                               
*        CLI   CLDTYPE,CLDLMAPQ    Only one line approver really                
*        JNE   AGXEXP22                                                         
*        CLI   CLDLN,CLDL1LNQ+CLDLLNQ                                           
*        JL    AGXEXP22                                                         
*        LA    R1,CLDLAPP                                                       
*        GOTO1 =V(GETSPD)                                                       
*        MVC   EXPDLMCD,WORK+100                                                
*        MVC   EXPDLMFN,WORK+00                                                 
*        MVC   EXPDLMMN,WORK+32                                                 
*        MVC   EXPDLMLN,WORK+16                                                 
*        J     AGXEXP04                                                         
*                                                                               
*GXEXP22 CLI   CLDTYPE,CLDFNAPQ                                                 
*        JNE   AGXEXP24                                                         
*        CLI   CLDLN,CLDFLNQ                                                    
*        JL    AGXEXP04                                                         
*        TM    BYTE,X'04'                                                       
*        JNZ   AGXEXP04                                                         
*        OI    BYTE,X'40'                                                       
*        LA    R1,CLDFAPP                                                       
*        GOTO1 =V(GETSPD)                                                       
*        MVC   EXPDLMCD,WORK+100                                                
*        MVC   EXPDLMFN,WORK+00                                                 
*        MVC   EXPDLMMN,WORK+32                                                 
*        MVC   EXPDLMLN,WORK+16                                                 
*        J     AGXEXP04                                                         
*                                                                               
*GXEXP24 DS    0H                                                               
         J     AGXEXP04                                                         
                                                                                
         USING ACTKCULA,R1                                                      
AGXEXP30 LA    R1,PL16             Determine line manager                       
         MVC   ACTKCPY,EXCKCPY                                                  
         MVC   ACTKUNT(L'ACTKUNT+L'ACTKLDG),ORUL                                
         MVC   ACTKACT,EXCK1RAC                                                 
         GOTO1 =V(GETMAP)                                                       
         DROP  R1                                                               
         GOTO1 =V(GETSPD),HALF                                                  
         MVC   EXPDLMCD,WORK+100                                                
         MVC   EXPDLMFN,WORK+00                                                 
         MVC   EXPDLMMN,WORK+32                                                 
         MVC   EXPDLMLN,WORK+16                                                 
                                                                                
         GOTO1 =V(GETFAP),PL16                                                  
         GOTO1 =V(GETSPD),HALF                                                  
         MVC   EXPDFACD,WORK+100                                                
         MVC   EXPDFAFN,WORK+00                                                 
         MVC   EXPDFAMN,WORK+32                                                 
         MVC   EXPDFALN,WORK+16                                                 
                                                                                
         USING CIDELD,R2                                                        
AGXEXP40 CLI   CIDTYPE,CIDTYMQ     Ensure at least one cluster to go on         
         JNE   AGXEXP04                                                         
         TM    CIDMSTA,CIDMSID     (skip if deleted)                            
         JNZ   AGXEXP04                                                         
         OI    BYTE,X'08'                                                       
         J     AGXEXP04                                                         
                                                                                
AGXEXP50 MVC   SAVXSEQ,EXCKSEQ                                                  
         MVI   SAVXICN,0                                                        
                                                                                
         CLI   DXMODE,DXLOADQ      In update mode handle sequentials            
         JE    AGXEXP52                                                         
         CLI   EXCKSEQ,0                                                        
         JE    AGXEXP52                                                         
         TM    BYTE,X'08'          Carry on?                                    
         JNZ   AGXEXPX                                                          
         J     AGXEXPP                                                          
                                                                                
AGXEXP52 TM    BYTE,X'08'+X'80'    Carry on?                                    
         JNO   AGXEXPN                                                          
                                                                                
AGXEXPX  MVI   DMCB+8,RETBFFQ      indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGXEXPN  MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
                                                                                
AGXEXPS  MVI   DMCB+8,RETBNWQ      skip record                                  
         J     EXIT                                                             
                                                                                
AGXEXPP  MVI   DMCB+8,RETBNWQ+RETBFFQ                                           
         J     EXIT                skip record but process facts                
         DROP  R2,R3,R4                                                         
                                                                                
AGXEXPLT DC    A(LITERAL)                                                       
                                                                                
EX_INPQ  EQU   C'1'                                                             
EX_SUBQ  EQU   C'2'                                                             
EX_PAPQ  EQU   C'3'                                                             
EX_REJQ  EQU   C'4'                                                             
EX_FAPQ  EQU   C'5'                                                             
EX_POSQ  EQU   C'6'                                                             
EX_LDEQ  EQU   C'7'                                                             
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGREXPC - Extract expense claim row dimension data                  *         
***********************************************************************         
                                                                                
AGREXPC  NMOD1 WORKX-WORKD,*AGREXP*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGREXPLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING EXCRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         CLC   SAVXTYP,EXCKTYPE    (integrity check)                            
         JNE   *+2                                                              
         CLC   SAVXREF,EXCKREF                                                  
         JNE   *+2                                                              
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,EXPRLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXEXPRQ                                                
                                                                                
         USING CIDELD,R2                                                        
         LA    R2,EXCRFST                                                       
         CLC   SAVXSEQR,EXCKSEQ    Same sequence as before?                     
         JE    AGREXP02                                                         
         MVC   SAVXSEQR,EXCKSEQ    Save sequence                                
         MVI   SAVXICNR,0          Reset item cluster                           
                                                                                
AGREXP02 CLI   SAVXICNR,0          First time for record?                       
         JE    AGREXP10            Then get first cluster on record             
                                                                                
AGREXP04 CLI   CIDEL,0             Else find current cluster first              
         JE    *+2                 (must exists|)                               
         CLI   CIDEL,CIDELQ                                                     
         JNE   AGREXP06                                                         
         CLI   CIDTYPE,CIDTYMQ                                                  
         JNE   AGREXP06                                                         
         TM    CIDMSTA,CIDMSID     (skip if deleted)                            
         JNZ   AGREXP06                                                         
         CLC   CIDSEQ,SAVXICN                                                   
         JNE   AGREXP06                                                         
         LLC   R1,CIDLN                                                         
         AR    R2,R1                                                            
         J     AGREXP10            And now get next one                         
                                                                                
AGREXP06 LLC   R1,CIDLN                                                         
         AR    R2,R1                                                            
         J     AGREXP04                                                         
                                                                                
AGREXP10 CLI   CIDEL,0             Find first/next item cluster                 
         JE    AGREXP70                                                         
         CLI   CIDEL,CIDELQ                                                     
         JNE   AGREXP12                                                         
         CLI   CIDTYPE,CIDTYMQ     Look for cluster start                       
         JNE   AGREXP12                                                         
         TM    CIDMSTA,CIDMSID     (skip if deleted)                            
         JZ    AGREXP20                                                         
                                                                                
AGREXP12 LLC   R1,CIDLN                                                         
         AR    R2,R1                                                            
         J     AGREXP10                                                         
                                                                                
COD      USING CIDELD,R5                                                        
AGREXP20 MVC   SAVXICNR,CIDSEQ     Save current                                 
         LR    R5,R2               Process cluster                              
                                                                                
AGREXP22 LLC   R1,COD.CIDLN                                                     
         AR    R5,R1                                                            
                                                                                
         CLI   COD.CIDEL,0         Die if no CIDTYCQ element                    
***      JE    *+2                 (well ... MCSTST.PUNETRA.D/913669)           
         JE    AGREXP24                                                         
         CLI   COD.CIDEL,CIDELQ                                                 
         JNE   AGREXP22                                                         
         CLC   COD.CIDSEQ,CIDSEQ                                                
         JNE   AGREXP22                                                         
         CLI   COD.CIDTYPE,CIDTYCQ                                              
         JNE   AGREXP22                                                         
         J     AGREXP25                                                         
                                                                                
AGREXP24 LA    R5,GSPACES                                                       
                                                                                
AGREXP25 DS    0H                                                               
*&&UK*&& MVC   EXPRAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   EXPRAGY(2),NORTHAM                                               
         MVI   EXPRAGY+2,UNDSCQ                                                 
         MVC   EXPRAGY+2+1(2),SAVCALP                                           
         MVC   EXPRCLN(L'SAVXREF),SAVXREF                                       
         MVI   EXPRCLN+L'SAVXREF,UNDSCQ                                         
         MVC   EXPRCLN+L'SAVXREF+1(L'SAVXTYP),SAVXTYP                           
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   EXPRUTS,WORK                                                     
                                                                                
*&&US*&& MVC   EXPRPRV,CIDMPROV                                                 
***      XOUT  CIDSEQ,EXPRROW,1                                                 
         EDITR (B1,CIDSEQ),(L'EXPRROW,EXPRROW),0,ZERO=NOBLANK,         *        
               ALIGN=LEFT                                                       
                                                                                
         OC    CIDMRAT,CIDMRAT                                                  
         JZ    AGREXP28                                                         
         ZAP   DUB,PZERO                                                        
         MVO   DUB,CIDMRAT+1(5)                                                 
         TM    CIDMRAT,AFCXSDIV                                                 
         JZ    AGREXP26                                                         
         ZAP   PL16,PONE                                                        
         MP    PL16,=P'100000000000'                                            
         DP    PL16,DUB                                                         
         SRP   PL16(8),64-1,5                                                   
         ZAP   DUB,PL16(8)                                                      
                                                                                
AGREXP26 EDITR (P8,DUB),(L'EXPREXR,EXPREXR),5,ALIGN=LEFT                        
                                                                                
AGREXP28 CLC   COD.CIDCVAC,GSPACES                                              
         JNH   AGREXP29                                                         
         MVC   EXPRVAC,COD.CIDCVAC                                              
         GOTO1 =V(GETACN),COD.CIDCVAC                                           
         MVC   EXPRVAN,WORK                                                     
                                                                                
AGREXP29 DS    0H                                                               
*&&US                                                                           
         CLC   COD.CIDCPSTA,GSPACES                                             
         JNH   AGREXP30                                                         
         MVC   EXPRPSC,COD.CIDCPSTA                                             
         GOTO1 =V(GETACN),COD.CIDCPSTA                                          
         MVC   EXPRPSN,WORK                                                     
*&&                                                                             
         DROP  COD                                                              
                                                                                
APP      USING CIDELD,R5                                                        
AGREXP30 LR    R5,R2               process cluster                              
                                                                                
AGREXP32 LLC   R1,APP.CIDLN                                                     
         AR    R5,R1                                                            
                                                                                
         CLI   APP.CIDEL,0         look for approver element                    
         JE    AGREXP40                                                         
         CLI   APP.CIDEL,CIDELQ                                                 
         JNE   AGREXP32                                                         
         CLC   APP.CIDSEQ,CIDSEQ                                                
         JNE   AGREXP32                                                         
         CLI   APP.CIDTYPE,CIDTYAQ                                              
         JNE   AGREXP32                                                         
                                                                                
         MVI   EXPRCAS,ECAMISQ     Missing approval                             
         TM    APP.CIDASTAT,CIDAREJ                                             
         JZ    AGREXP34                                                         
         MVI   EXPRCAS,ECAREJQ     Rejected                                     
                                                                                
AGREXP34 TM    APP.CIDASTAT,CIDAAPP                                             
         JZ    AGREXP36                                                         
         MVI   EXPRCAS,ECAAPPQ     Approved                                     
                                                                                
AGREXP36 TM    APP.CIDASTAT,CIDAANR                                             
         JZ    AGREXP38                                                         
         MVI   EXPRCAS,ECANOTQ     Not required                                 
                                                                                
AGREXP38 OC    APP.CIDAPID,APP.CIDAPID                                          
         JZ    AGREXP40                                                         
                                                                                
         LA    R1,APP.CIDAPID                                                   
         GOTO1 =V(GETSPD)                                                       
         MVC   EXPRCAC,WORK+100                                                 
         MVC   EXPRCAF,WORK+00                                                  
         MVC   EXPRCAM,WORK+32                                                  
         MVC   EXPRCAL,WORK+16                                                  
         DROP  APP                                                              
                                                                                
NAR      USING CIDELD,R5                                                        
AGREXP40 LR    R5,R2               process cluster                              
                                                                                
AGREXP42 LLC   R1,NAR.CIDLN                                                     
         AR    R5,R1                                                            
                                                                                
         CLI   NAR.CIDEL,0         die if no CIDTYNQ element                    
         JE    AGREXP50                                                         
         CLI   NAR.CIDEL,CIDELQ                                                 
         JNE   AGREXP42                                                         
         CLC   NAR.CIDSEQ,CIDSEQ                                                
         JNE   AGREXP42                                                         
         CLI   NAR.CIDTYPE,CIDTYOQ                                              
         JE    AGREXP43                                                         
         CLI   NAR.CIDTYPE,CIDTYNQ                                              
         JNE   AGREXP42                                                         
                                                                                
AGREXP43 CLI   NAR.CIDLN,CIDNARR-CIDELD                                         
         JNH   AGREXP50                                                         
         LLC   R1,NAR.CIDLN                                                     
         SHI   R1,CIDNARR-CIDELD+1                                              
         CHI   R1,L'EXPRRWNR-1                                                  
         JNH   AGREXP44                                                         
         LHI   R1,L'EXPRRWNR-1                                                  
                                                                                
AGREXP44 MVC   EXPRRWNR(0),NAR.CIDNARR                                          
         EX    R1,*-6                                                           
         DROP  NAR                                                              
                                                                                
*AR      USING CIDELD,R5                                                        
*        LR    R5,R2               process cluster                              
*                                                                               
*GREXP42 LLC   R1,NAR.CIDLN                                                     
*        AR    R5,R1                                                            
*                                                                               
*        CLI   NAR.CIDEL,0         die if no CIDTYCQ element                    
*        JE    AGREXP50                                                         
*        CLI   NAR.CIDEL,CIDELQ                                                 
*        JNE   AGREXP42                                                         
*        CLC   NAR.CIDSEQ,CIDSEQ                                                
*        JNE   AGREXP42                                                         
*        CLI   NAR.CIDTYPE,CIDTYNQ                                              
*        JNE   AGREXP42                                                         
*                                                                               
*        CLI   NAR.CIDLN,CIDNARR-CIDELD                                         
*        JNH   AGREXP50                                                         
*        LLC   R1,NAR.CIDLN                                                     
*        SHI   R1,CIDNARR-CIDELD+1                                              
**       CHI   R1,L'EXPRTXT-1                                                   
**       JNH   AGREXP44                                                         
**       LHI   R1,L'EXPRTXT-1                                                   
**                                                                              
**REXP44 MVC   EXPRTXT(0),NAR.CIDNARR                                           
**       EX    R1,*-6                                                           
*        STC   R1,LEN4TXT                                                       
*        LA    RE,NAR.CIDNARR                                                   
*        STCM  RE,B'1111',ADR4TXT                                               
*        MVI   EXPRTXRW+0,C'T'                                                  
*        XOUT  CIDSEQ,EXPRTXRW+2,1                                              
*        MVC   ENT4TXT,AGXRETYP                                                 
*        MVC   KEY4TXT(L'SAVXREF),SAVXREF                                       
*        MVI   KEY4TXT+L'SAVXREF,UNDSCQ                                         
*        MVC   KEY4TXT+L'SAVXREF+1(L'SAVXTYP),SAVXTYP                           
*        MVC   ROW4TXT,EXPRTXRW                                                 
*        OI    PROCMODE,PROCTDQ    Text processing                              
*        DROP  NAR                                                              
                                                                                
AGREXP50 LA    R5,EXPRX01N                                                      
         LA    R6,CIDELD                                                        
                                                                                
         USING XDFELD,R6                                                        
AGREXP52 LLC   R0,XDFLN                                                         
         AR    R6,R0                                                            
         CLI   XDFEL,0                                                          
         JE    AGREXP60                                                         
         CLI   XDFEL,XDFELQ                                                     
         JNE   AGREXP52                                                         
         CLC   XDFXPTC,CIDSEQ                                                   
         JNE   AGREXP52                                                         
         CLI   XDFLN,XDFXLNQ       too short (MCSTST/USER37001260)              
         JNH   AGREXP52                                                         
                                                                                
         LA    R1,EXPRX10N         Skip if > 10                                 
         CR    R5,R1                                                            
         JH    AGREXP60                                                         
         MVC   EXPRX01T-EXPRX01N(L'EXPRX01T,R5),XDFXTYP                         
         CLI   XDFXTYP,XDFEDNQ     N=numeric                                    
         JE    AGREXP53                                                         
         CLI   XDFXTYP,XDFEDXQ     X=dropdown                                   
         JE    AGREXP53                                                         
         CLI   XDFXTYP,XDFEDCQ     C=char                                       
         JNE   AGREXP55                                                         
                                                                                
AGREXP53 LLC   RE,XDFLN                                                         
         SHI   RE,XDFXLNQ+1                                                     
         CHI   RE,L'EXPRX01V-1                                                  
         JNH   AGREXP54                                                         
         LHI   RE,L'EXPRX01V-1                                                  
                                                                                
AGREXP54 MVC   EXPRX01V-EXPRX01N(0,R5),XDFXDTA   Order N/T/V                    
         EX    RE,*-6                                                           
         J     AGREXP59                                                         
                                                                                
AGREXP55 CLI   XDFXTYP,XDFEDDQ     D=DATE                                       
         JNE   AGREXP56                                                         
         MVC   FULL,XDFXDTA                                                     
         SAM24 ,                                                                
         GOTO1 =V(SET1DAT),FULL                                                 
         SAM31 ,                                                                
         MVC   EXPRX01V-EXPRX01N(10,R5),WORK                                    
         J     AGREXP59                                                         
                                                                                
AGREXP56 CLI   XDFXTYP,XDFEDYQ     Y=YES/NO                                     
         JNE   AGREXP57                                                         
         MVC   EXPRX01V-EXPRX01N(1,R5),XDFXDTA                                  
         J     AGREXP59                                                         
                                                                                
AGREXP57 CLI   XDFXTYP,XDFEDAQ     A=AMOUNT                                     
         JNE   *+2                                                              
***      JNE   AGREXP52            (MCSTST bad data ...)                        
                                                                                
         ST    R2,FULL                                                          
         LA    R2,EXPRX01V-EXPRX01N(R5)                                         
*        ZAP   DUB,XDFXDTA(6)                                                   
         ZAP   EDDUB,XDFXDTA(6)    Normal cur                                   
         SAM24 ,                                                                
                                                                                
*        EDITR (P8,DUB),(15,0(R2)),0,ZERO=NOBLANK,MINUS=YES,ALIGN=LEFT          
                                                                                
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGREXP58                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGREXP58 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(15,0(R2))                              
         SAM31 ,                                                                
         L     R2,FULL                                                          
                                                                                
AGREXP59 DS    0H                                                               
         MVC   FULL,XDFXPTX                                                     
         SAM24 ,                                                                
         GOTO1 =V(GETXDF),FULL                                                  
         SAM31 ,                                                                
         MVC   EXPRX01N-EXPRX01N(L'EXPRX01N,R5),WORK   Expenses N/T/V           
                                                                                
         AHI   R5,EXPRX02N-EXPRX01N                                             
         J     AGREXP52                                                         
         DROP  R6                                                               
                                                                                
AGREXP60 DS    0H                                                               
         J     AGREXPXY                                                         
                                                                                
AGREXP70 CLI   EXCKSEQ,0           If in main record die                        
         JE    *+2                                                              
                                                                                
AGREXPXS MVI   DMCB+8,RETBNWQ      Skip this record (don't write)               
         J     EXIT                                                             
                                                                                
AGREXPXY MVI   DMCB+8,RETBFFQ      indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
         DROP  R2,R3,R4                                                         
                                                                                
AGREXPLT DC    A(LITERAL)                                                       
ECAMISQ  EQU   C'1'                                                             
ECAREJQ  EQU   C'2'                                                             
ECAAPPQ  EQU   C'3'                                                             
ECANOTQ  EQU   C'4'                                                             
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGFEXPC - Extract expense claim fact data                           *         
***********************************************************************         
                                                                                
AGFEXPC  NMOD1 WORKX-WORKD,*AGFEXP*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGFEXPLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING EXCRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         CLC   SAVXTYP,EXCKTYPE    (integrity check)                            
         JNE   *+2                                                              
         CLC   SAVXREF,EXCKREF                                                  
         JNE   *+2                                                              
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,EXPFLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXEXPFQ                                                
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'EXPFCAM,EXPFCAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'EXPFVAM,EXPFVAM)                     
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'EXPFPSA,EXPFPSA)                     
                                                                                
         USING CIDELD,R2                                                        
         LA    R2,EXCRFST                                                       
         CLC   SAVXSEQ,EXCKSEQ     Same sequence as before?                     
         JE    AGFEXP02                                                         
         MVC   SAVXSEQ,EXCKSEQ     Save sequence                                
         MVI   SAVXICN,0           Reset item cluster                           
                                                                                
AGFEXP02 CLI   SAVXICN,0           First time for record?                       
         JE    AGFEXP10            Then get first cluster on record             
                                                                                
AGFEXP04 CLI   CIDEL,0             Else find current cluster first              
         JE    *+2                 (must exists|)                               
         CLI   CIDEL,CIDELQ                                                     
         JNE   AGFEXP06                                                         
         CLI   CIDTYPE,CIDTYMQ                                                  
         JNE   AGFEXP06                                                         
         TM    CIDMSTA,CIDMSID     (skip if deleted)                            
         JNZ   AGFEXP06                                                         
         CLC   CIDSEQ,SAVXICN                                                   
         JNE   AGFEXP06                                                         
         LLC   R1,CIDLN                                                         
         AR    R2,R1                                                            
         J     AGFEXP10            And now get next one                         
                                                                                
AGFEXP06 LLC   R1,CIDLN                                                         
         AR    R2,R1                                                            
         J     AGFEXP04                                                         
                                                                                
AGFEXP10 CLI   CIDEL,0             Find first/next item cluster                 
         JE    AGFEXP70                                                         
         CLI   CIDEL,CIDELQ                                                     
         JNE   AGFEXP12                                                         
         CLI   CIDTYPE,CIDTYMQ     Look for cluster start                       
         JNE   AGFEXP12                                                         
         TM    CIDMSTA,CIDMSID     (skip if deleted)                            
         JZ    AGFEXP20                                                         
                                                                                
AGFEXP12 LLC   R1,CIDLN                                                         
         AR    R2,R1                                                            
         J     AGFEXP10                                                         
                                                                                
COD      USING CIDELD,R5                                                        
AGFEXP20 MVC   SAVXICN,CIDSEQ      Save current                                 
         LR    R5,R2               Process cluster                              
                                                                                
AGFEXP22 LLC   R1,COD.CIDLN                                                     
         AR    R5,R1                                                            
                                                                                
         CLI   COD.CIDEL,0         Die if no CIDTYCQ element                    
***      JE    *+2                 (well ... MCSTST.PUNETRA.D/913669)           
         JE    AGFEXP23                                                         
         CLI   COD.CIDEL,CIDELQ                                                 
         JNE   AGFEXP22                                                         
         CLC   COD.CIDSEQ,CIDSEQ                                                
         JNE   AGFEXP22                                                         
         CLI   COD.CIDTYPE,CIDTYCQ                                              
         JNE   AGFEXP22                                                         
         J     AGFEXP24                                                         
                                                                                
AGFEXP23 LA    R5,GSPACES                                                       
                                                                                
AGFEXP24 DS    0H                                                               
*&&UK*&& MVC   EXPFAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   EXPFAGY(2),NORTHAM                                               
         MVI   EXPFAGY+2,UNDSCQ                                                 
         MVC   EXPFAGY+2+1(2),SAVCALP                                           
         MVC   EXPFPID,SAVXPID                                                  
         MVC   EXPFCLN(L'SAVXREF),SAVXREF                                       
         MVI   EXPFCLN+L'SAVXREF,UNDSCQ                                         
         MVC   EXPFCLN+L'SAVXREF+1(L'SAVXTYP),SAVXTYP                           
                                                                                
         MVC   EXPF2DAI(2),TDUL                                                 
         MVC   EXPF2DAI+2(12),COD.CIDC2DA                                       
         MVC   EXPF2PAI(2),TPUL                                                 
         MVC   EXPF2PAI+2(12),COD.CIDC2PA                                       
                                                                                
         MVC   PL16,GSPACES                                                     
         MVC   PL16(2),ORUL                                                     
         MVC   PL16+2(L'EXCK1RAC),EXCK1RAC                                      
         GOTO1 =V(SPLITAC),PL16                                                 
         CLI   WORK+25,C'0'                                                     
         JE    AGFEXP2A                                                         
         MVC   EXPF1RA1(12),WORK+30+00+02                                       
         CLI   WORK+25,C'1'                                                     
         JE    AGFEXP2A                                                         
         MVC   EXPF1RA2(12),WORK+30+15+02                                       
         CLI   WORK+25,C'2'                                                     
         JE    AGFEXP2A                                                         
         MVC   EXPF1RA3(12),WORK+30+30+02                                       
         CLI   WORK+25,C'3'                                                     
         JE    AGFEXP2A                                                         
         MVC   EXPF1RA4(12),WORK+30+45+02                                       
                                                                                
AGFEXP2A EDITR (B1,SAVXICN),(L'EXPFERWI,EXPFERWI),0,ZERO=NOBLANK,      *        
               ALIGN=LEFT                                                       
                                                                                
         GOTO1 =V(SET2DAT),CIDMDAT                                              
         MVC   EXPFDAT,WORK                                                     
                                                                                
         MVI   EXPFISR,FALSEQ                                                   
         CLI   CIDMREC,YESQ                                                     
         JNE   AGFEXP25                                                         
         MVI   EXPFISR,TRUEQ                                                    
                                                                                
AGFEXP25 MVI   EXPFISB,FALSEQ                                                   
         CLI   CIDMTYP,CIDMBILQ                                                 
         JNE   AGFEXP26                                                         
         MVI   EXPFISB,TRUEQ                                                    
                                                                                
AGFEXP26 MVC   EXPFETY,CIDMEXP                                                  
                                                                                
         MVC   EXPFWCD,CIDMWCD                                                  
         MVC   EXPFOFF,CIDMOFF                                                  
         MVC   EXPFCUR,CIDMCUR                                                  
         CLC   EXPFCUR,GSPACES                                                  
         JH    AGFEXP27                                                         
         MVC   EXPFCUR,SAVCCUR                                                  
                                                                                
AGFEXP27 CLC   COD.CIDCCPJ,GSPACES                                              
         JNH   AGFEXP28                                                         
         GOTO1 =V(SPLITSJ),COD.CIDCCPJ                                          
         MVC   EXPFCLI,WORK+30+0                                                
         MVC   EXPFPRO,WORK+30+8                                                
         MVC   EXPFJOB,WORK+30+16                                               
                                                                                
AGFEXP28 MVC   EXPFEXP,COD.CIDCEXP                                              
                                                                                
         GOTO1 =V(SPLITAC),EXPFEXP                                              
         CLI   WORK+25,C'0'                                                     
         JE    AGFEXP2B                                                         
         MVC   EXPFEXP1,WORK+30+00                                              
         CLI   WORK+25,C'1'                                                     
         JE    AGFEXP2B                                                         
         MVC   EXPFEXP2,WORK+30+15                                              
         CLI   WORK+25,C'2'                                                     
         JE    AGFEXP2B                                                         
         MVC   EXPFEXP3,WORK+30+30                                              
         CLI   WORK+25,C'3'                                                     
         JE    AGFEXP2B                                                         
         MVC   EXPFEXP4,WORK+30+45                                              
                                                                                
AGFEXP2B DS    0H                                                               
                                                                                
*        EDITR (P6,CIDMAMT),(L'EXPFAMT-1,EXPFAMT+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,CIDMAMT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEXP29                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEXP29 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'EXPFAMT,EXPFAMT)                     
                                                                                
AGFEXP30 DS    0H                                                               
*&&US*&& ZAP   DUB,CIDMGST                                                      
*&&UK                                                                           
                                                                                
         ZAP   DUB,CIDMAMT                                                      
         SP    DUB,CIDMNET                                                      
                                                                                
         CLC   EXPFCUR,SAVCCUR     if currency CIDMNET is currency              
         JE    AGFEXP32            so recalculate VAT                           
                                                                                
         ZAP   DUB,CIDMAMT                                                      
         CP    CIDMNET,PZERO                                                    
         JE    AGFEXP32                                                         
                                                                                
         USING EURKBLKD,R6                                                      
         LA    R6,WORK                                                          
         XC    EURKBLKD(EURKBLKL),EURKBLKD                                      
         MVC   EURKCUFR,EXPFCUR                                                 
         MVC   EURKCUTO,SAVCCUR                                                 
         MVC   EURKALPH,SAVCALP                                                 
         MVC   EURKDATE,TODAYC                                                  
         MVC   EURKAFAC,ACOMFAC                                                 
         MVC   EURKRLST(L'CIDMRAT),CIDMRAT                                      
         ZAP   PL16+0(8),CIDMNET                                                
         LHI   R0,APPLYQ+INVERTQ   (see AGFORDC fixes)                          
                                                                                
         GOTO1 =V(EUREKA),DMCB,((R0),EURKBLKD),PL16+0,PL16+8                    
         CLI   0(R1),0                                                          
         JNE   AGFEXP32            Skip if error                                
         DROP  R6                                                               
         SP    DUB,PL16+8(8)                                                    
                                                                                
*&&                                                                             
*        EDITR (P8,DUB),(L'EXPFVAM-1,EXPFVAM+1),0,ZERO=NOBLANK,        *        
               ALIGN=LEFT                                                       
                                                                                
*        MVI   EXPFVAM,PLUSQ       +                                            
*        CP    DUB,PZERO                                                        
*        JNL   AGFEXP36                                                         
*        MVI   EXPFVAM,MINUSQ      -                                            
                                                                                
AGFEXP32 ZAP   EDDUB,DUB           Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEXP34                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEXP34 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'EXPFVAM,EXPFVAM)                     
                                                                                
AGFEXP36 DS    0H                                                               
*&&US                                                                           
*        EDITR (P6,CIDMPST),(L'EXPFPSA-1,EXPFPSA+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,CIDMPST       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEXP37                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEXP37 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'EXPFPSA,EXPFPSA)                     
*&&                                                                             
                                                                                
AGFEXP38 CLC   EXPFCUR,SAVCCUR                                                  
         JE    AGFEXP40                                                         
                                                                                
*        EDITR (P6,CIDMFCA),(L'EXPFCAM-1,EXPFCAM+1),0,ZERO=NOBLANK,    *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,CIDMFCA       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFEXP39                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFEXP39 GOTO1 =V(SETAMNT),DMCB,EXPFCUR,(L'EXPFCAM,EXPFCAM)                     
         DROP  COD                                                              
                                                                                
AGFEXP40 DS    0H                                                               
NAR      USING CIDELD,R5                                                        
         LR    R5,R2               process cluster                              
                                                                                
AGFEXP42 LLC   R1,NAR.CIDLN                                                     
         AR    R5,R1                                                            
                                                                                
         CLI   NAR.CIDEL,0         die if no CIDTYCQ element                    
         JE    AGFEXP50                                                         
         CLI   NAR.CIDEL,CIDELQ                                                 
         JNE   AGFEXP42                                                         
         CLC   NAR.CIDSEQ,CIDSEQ                                                
         JNE   AGFEXP42                                                         
         CLI   NAR.CIDTYPE,CIDTYNQ                                              
         JNE   AGFEXP42                                                         
                                                                                
         CLI   NAR.CIDLN,CIDNARR-CIDELD                                         
         JNH   AGFEXP50                                                         
         LLC   R1,NAR.CIDLN                                                     
         SHI   R1,CIDNARR-CIDELD+1                                              
* no text - neither field nor pointer ...                                       
*        MVC   EXPFTRWI(0),NAR.CIDNARR                                          
*        EX    R1,*-6                                                           
*        STC   R1,LEN4TXT                                                       
*        LA    RE,NAR.CIDNARR                                                   
*        STCM  RE,B'1111',ADR4TXT                                               
*        MVI   EXPFTRWI+0,C'T'                                                  
*        XOUT  CIDSEQ,EXPFTRWI+2,1                                              
*        MVC   ENT4TXT,AGXRETYP                                                 
*        MVC   KEY4TXT(L'SAVXREF),SAVXREF                                       
*        MVI   KEY4TXT+L'SAVXREF,UNDSCQ                                         
*        MVC   KEY4TXT+L'SAVXREF+1(L'SAVXTYP),SAVXTYP                           
*        MVC   ROW4TXT,EXPFTRWI                                                 
*        OI    PROCMODE,PROCTDQ    Text processing                              
         DROP  NAR                                                              
                                                                                
AGFEXP50 DS    0H                                                               
                                                                                
***      GOTOR GETAUD,CIDSEQ       see ACGPMAIN.GETAUD sample - needs           
***      ICM   RE,B'1111',DUB      to read exp claim audit records into         
***      SRL   RE,4                ABUFFER first and then get the right         
***      STCM  RE,B'0111',DUB+3    entry - await NSHE/MWHE decision on          
***      GOTO1 =V(SETACTV),DUB     general time stamp issue                     
                                                                                
         GOTO1 =V(SETACTV),0                                                    
         MVC   EXPFUTS,WORK                                                     
                                                                                
AGFEXP60 LLC   R1,CIDLN            Look whether there is more to come           
         AR    R2,R1                                                            
         CLI   CIDEL,0                                                          
         JE    AGFEXPXN                                                         
         CLI   CIDEL,CIDELQ                                                     
         JNE   AGFEXP60                                                         
         CLI   CIDTYPE,CIDTYMQ                                                  
         JNE   AGFEXP60                                                         
         TM    CIDMSTA,CIDMSID     (skip if deleted)                            
         JNZ   AGFEXP60                                                         
         J     AGFEXPXY                                                         
                                                                                
AGFEXP70 CLI   EXCKSEQ,0           If in main record die                        
         JE    *+2                                                              
                                                                                
AGFEXPXS MVI   DMCB+8,RETBNWQ      Skip this record (don't write)               
         J     EXIT                                                             
                                                                                
AGFEXPXY MVI   DMCB+8,RETBFFQ      indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGFEXPXN MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
                                                                                
         DROP  R2,R3,R4                                                         
                                                                                
AGFEXPLT DC    A(LITERAL)                                                       
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGXTIMC - Extract timesheet dimension data                          *         
***********************************************************************         
                                                                                
AGXTIMC  NMOD1 WORKX-WORKD,*AGXTIM*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGXTIMLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING TIMRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,TIMDLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXTIMDQ                                                
                                                                                
         CLC   TIMKULC,GSPACES     Skip t/s if no c/a                           
         JNH   AGXTIMS                                                          
                                                                                
         MVI   SAVZSEQ,0                                                        
         MVI   SAVZSTA,0                                                        
         MVI   SAVZITM,0                                                        
         MVI   SAVZDAY,0                                                        
         MVI   SAVZNPI,0                                                        
                                                                                
         CLI   DXMODE,DXUPDTQ                                                   
         JE    AGXTIM04                                                         
         OC    TIMTSWP,TIMTSWP     First time?                                  
         JZ    AGXTIM02                                                         
         CLC   TIMTSWC(TSWKULC-TSWKEY),TIMTSWP                                  
         JE    AGXTIMSQ            No new timesheet so skip                     
                                                                                
AGXTIM02 MVC   TIMTSWP,TIMTSWC     Save timesheet pointer key                   
                                                                                
AGXTIM04 XC    SAVTIM(SAVTIMLQ),SAVTIM                                          
                                                                                
*&&UK*&& MVC   TIMDAGY(2),EUROPE   Set data                                     
*&&US*&& MVC   TIMDAGY(2),NORTHAM                                               
         MVI   TIMDAGY+2,UNDSCQ                                                 
         MVC   TIMDAGY+2+1(2),SAVCALP                                           
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   TIMDUTS,WORK                                                     
                                                                                
         GOTO1 =V(SPLIT1R),TIMKACT                                              
         MVC   TIMD1ROC,WORK+00    1R office code                               
         MVC   TIMD1RDC,WORK+06    1R department code                           
         MVC   TIMD1RSD,WORK+12    1R sub departmt cd                           
         MVC   TIMD1RPC,WORK+18    1r person code                               
                                                                                
         CLI   DXMODE,DXLOADQ                                                   
         JNE   AGXTIM06                                                         
                                                                                
         USING TSWRECD,R5                                                       
         LA    R5,TIMTSWC                                                       
         MVC   SAVZTIDP,TSWKPER                                                 
         MVI   SAVZTID1,UNDSCQ                                                  
         MVI   SAVZTID2,UNDSCQ                                                  
         XR    R1,R1                                                            
         ICM   R1,B'0111',TSWKEND                                               
         LNR   R1,R1                                                            
         STCM  R1,B'0111',FULL                                                  
         GOTO1 =V(CHKDATE),DMCB,(1,FULL)                                        
         GOTO1 =V(DATCON),DMCB,(1,FULL),(23,SAVZTIDE)                           
* SAVZTIDL set later on                                                         
         MVC   SAVZODS,TSWKODS                                                  
         J     AGXTIM10                                                         
         DROP  R5                                                               
                                                                                
AGXTIM06 CLI   DXMODE,DXUPDTQ                                                   
         JNE   *+2                                                              
                                                                                
         MVC   SAVZTIDP,TIMD1RPC                                                
         MVI   SAVZTID1,UNDSCQ                                                  
         MVI   SAVZTID2,UNDSCQ                                                  
         GOTO1 =V(CHKDATE),DMCB,(1,TIMKPEDT)                                    
         GOTO1 =V(DATCON),DMCB,(1,TIMKPEDT),(23,SAVZTIDE)                       
* SAVZTIDL set later on                                                         
         MVC   SAVZODS,GSPACES                                                  
         LLC   R1,SAVC1RC                                                       
         SHI   R1,1                                                             
         MVC   SAVZODS(0),TIMKACT                                               
         EX    R1,*-6                                                           
                                                                                
AGXTIM10 DS    0H                                                               
                                                                                
*        CLC   =C'RIOJA',SAVZTIDP                                               
*        JNE   NNNNNN                                                           
*        CLC   =C'2018-03-18',SAVZTIDE                                          
*        JNE   NNNNNN                                                           
*        XR    R0,R0                                                            
*NNNNN   DS    0H                                                               
                                                                                
         MVI   TIMDTSST,TS_REJQ                                                 
         TM    TIMRSTAT,TIMSREJE                                                
         JNZ   AGXTIM11                                                         
         MVI   TIMDTSST,TS_SUBQ                                                 
         TM    TIMRSTAT,TIMSSUBM                                                
         JNZ   AGXTIM11                                                         
         MVI   TIMDTSST,TS_PAPQ                                                 
         TM    TIMRSTAT,TIMSPAPP                                                
         JNZ   AGXTIM11                                                         
         MVI   TIMDTSST,TS_APPQ                                                 
         TM    TIMRSTAT,TIMSFAPP                                                
         JNZ   AGXTIM11                                                         
         MVI   TIMDTSST,TS_INPQ                                                 
                                                                                
AGXTIM11 GOTO1 =V(SET1DAT),TIMKPEDT                                             
         MVC   TIMDPEDT,WORK       Period end date                              
                                                                                
         USING PIDELD,R2                                                        
         LA    R2,TIMRFST                                                       
         MVC   SAVZPER,TIMD1RPC    default 1R person code                       
                                                                                
AGXTIM12 CLI   PIDEL,0                                                          
         JE    AGXTIM20                                                         
         CLI   PIDEL,PIDELQ                                                     
         JE    AGXTIM16                                                         
                                                                                
AGXTIM14 LLC   R1,PIDLN                                                         
         AR    R2,R1                                                            
         J     AGXTIM12                                                         
                                                                                
AGXTIM16 OC    PIDNO,PIDNO         save real PID                                
         JZ    AGXTIM14                                                         
         MVC   SAVZPID,PIDNO                                                    
         J     AGXTIM14                                                         
                                                                                
AGXTIM20 GOTO1 =V(GETPER),TIMKEY                                                
         MVC   SAVZPED,WORK+00                                                  
         MVC   SAVZPSD,WORK+03                                                  
         MVC   SAVZLED,WORK+06                                                  
         MVC   SAVZLSD,WORK+09                                                  
         OC    SAVZPID,SAVZPID                                                  
         JNZ   AGXTIM24                                                         
         MVC   SAVZPID,WORK+12                                                  
                                                                                
*GXTIM22 OC    SAVZPID,SAVZPID                                                  
*        JZ    AGXTIM24                                                         
*        LA    R1,SAVZPID                                                       
*        GOTO1 =V(GETSPD)                                                       
*        MVC   SAVZPER,WORK+100                                                 
                                                                                
AGXTIM24 GOTO1 =V(SET1DAT),SAVZPSD                                              
         MVC   TIMDPSDT,WORK             Period start date                      
         GOTO1 =V(SET1DAT),SAVZLSD                                              
         MVC   TIMDLSDT,WORK             Location start date                    
         GOTO1 =V(SET1DAT),SAVZLED                                              
         MVC   TIMDLEDT,WORK             Location end date                      
                                                                                
         USING TIMELD,R2                                                        
         LA    R2,TIMRFST          Location start and end date from             
         MVC   DUB(3),SAVZLED      t/s record TIMEL                             
         MVC   DUB+3(3),SAVZLSD                                                 
                                                                                
AGXTIM25 CLI   TIMEL,0                                                          
         JE    AGXTIM30                                                         
         CLI   TIMEL,TIMELQ                                                     
         JNE   AGXTIM28                                                         
         CLI   TIMETYP,TIMETIME                                                 
         JNE   AGXTIM28                                                         
         CLI   TIMETPDT,X'80'      Bad LTST.MCSTST data                         
         JL    *+10                Bad LTST.MCSTST data                         
         MVC   DUB(3),TIMETPDT                                                  
         MVC   DUB+3(3),TIMETDT1                                                
         OC    DUB(3),DUB                                                       
         JNZ   AGXTIM30                                                         
         LA    RE,TIMETDTE                                                      
         LLC   RF,TIMLN                                                         
         LA    RF,TIMELD(RF)                                                    
                                                                                
AGXTIM26 CR    RE,RF                                                            
         JNL   AGXTIM30                                                         
         CLI   0(RE),SPACEQ                                                     
         JNH   AGXTIM27                                                         
         CLC   0(L'TIMETDTE,RE),DUB                                             
         JL    AGXTIM27                                                         
         MVC   DUB(3),0(RE)                                                     
                                                                                
AGXTIM27 AHI   RE,L'TIMEDAY                                                     
         J     AGXTIM26                                                         
                                                                                
AGXTIM28 LLC   R1,TIMLN                                                         
         AR    R2,R1                                                            
         J     AGXTIM25                                                         
         DROP  R2                                                               
                                                                                
AGXTIM30 OC    DUB(L'TIMETDTE),DUB                                              
         JNZ   AGXTIM32                                                         
         MVC   SAVZTIDL,SAVZTIDE                                                
         MVC   TIMDLEDT,SAVZTIDE                                                
         J     AGXTIM34                                                         
                                                                                
AGXTIM32 GOTO1 =V(SET1DAT),DUB                                                  
         MVC   SAVZTIDL,WORK                                                    
         MVC   TIMDLEDT,SAVZTIDL                                                
                                                                                
AGXTIM34 GOTO1 =V(SET1DAT),DUB+3                                                
         MVC   SAVZTIDS,WORK                                                    
         MVC   TIMDLSDT,SAVZTIDS                                                
                                                                                
         CLC   TIMDLSDT,GSPACES                                                 
         JH    AGXTIM36                                                         
         MVC   TIMDLSDT,TIMDLEDT                                                
                                                                                
AGXTIM36 GOTO1 =V(GETMAP),TIMKCULA                                              
         GOTO1 =V(GETSPD),HALF                                                  
         MVC   TIMDLMGC,WORK+100                                                
         MVC   TIMDLMFN,WORK+00                                                 
         MVC   TIMDLMMN,WORK+32                                                 
         MVC   TIMDLMLN,WORK+16                                                 
                                                                                
         J     AGXTIMX                                                          
                                                                                
AGXTIMSQ MVI   DMCB+8,RETBFFQ+RETBNWQ    skip this dimension but                
         J     EXIT                      use it for facts                       
                                                                                
AGXTIMX  MVI   DMCB+8,RETBFFQ      indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGXTIMN  MVI   DMCB+8,RETBNMQ      indicate no more to come                     
         J     EXIT                                                             
                                                                                
AGXTIMS  MVI   DMCB+8,RETBNWQ      skip record                                  
         J     EXIT                                                             
         DROP  R3,R4                                                            
                                                                                
AGXTIMLT DC    A(LITERAL)                                                       
                                                                                
TS_INPQ  EQU   C'1'                                                             
TS_SUBQ  EQU   C'2'                                                             
TS_PAPQ  EQU   C'3'                                                             
TS_REJQ  EQU   C'4'                                                             
TS_APPQ  EQU   C'5'                                                             
                                                                                
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGRTIMC - Extract timesheet row dimension data                      *         
***********************************************************************         
                                                                                
AGRTIMC  NMOD1 WORKX-WORKD,*AGRTIM*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGRTIMLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING TIMRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,TIMRLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXTIMRQ                                                
                                                                                
         USING TIMELD,R2                                                        
         LA    R2,TIMRFST                                                       
                                                                                
         CLI   SAVZSEQ,0           Skip if 1st time else find previous          
         JE    AGRTIM10            cluster                                      
                                                                                
AGRTIM02 CLI   TIMEL,0                                                          
         JE    AGRTIMXS                                                         
         CLI   TIMEL,TIMELQ                                                     
         JNE   AGRTIM04                                                         
         CLI   TIMETYP,TIMEINP                                                  
         JNE   AGRTIM04                                                         
         CLC   SAVZSEQ,TIMSEQ                                                   
         JNE   AGRTIM04                                                         
         CLI   SAVZITM,0           Any days or items left to process            
         JNE   AGRTIM16            then skip here                               
         CLI   SAVZDAY,0                                                        
         JNE   AGRTIM16                                                         
         LLC   R1,TIMLN                                                         
         AR    R2,R1                                                            
         J     AGRTIM10                                                         
                                                                                
AGRTIM04 LLC   R1,TIMLN                                                         
         AR    R2,R1                                                            
         J     AGRTIM02                                                         
                                                                                
AGRTIM10 CLI   TIMEL,0             Find next cluster                            
         JE    AGRTIMXS                                                         
         CLI   TIMEL,TIMELQ                                                     
         JNE   AGRTIM12                                                         
         CLI   TIMETYP,TIMEINP                                                  
         JNE   AGRTIM12                                                         
         CLI   TIMTTYP,TIMTEM                                                   
         JNE   AGRTIM14                                                         
                                                                                
AGRTIM12 LLC   R1,TIMLN                                                         
         AR    R2,R1                                                            
         J     AGRTIM10                                                         
                                                                                
AGRTIM14 JAS   RE,SETIMTR          Set time type details                        
                                                                                
         CLI   SAVZDAYR,0          Skip zero time rows                          
         JNE   AGRTIM16                                                         
         CLI   SAVZITMR,0                                                       
         JNE   AGRTIM16                                                         
         TM    SAVZSTAR,SAVZSDQ+SAVZSIQ                                         
         JNZ   AGRTIM16                                                         
         CLI   TIMLN,TIMILN1Q                                                   
         JL    AGRTIM12                                                         
         CP    TIMHRS,PZERO                                                     
         JE    AGRTIM12                                                         
                                                                                
AGRTIM16 DS    0H                                                               
*&&UK*&& MVC   TIMRAGY(2),EUROPE   Set general data                             
*&&US*&& MVC   TIMRAGY(2),NORTHAM                                               
         MVI   TIMRAGY+2,UNDSCQ                                                 
         MVC   TIMRAGY+2+1(2),SAVCALP                                           
                                                                                
         GOTOR =V(SETACTV),0                                                    
         MVC   TIMRUTS,WORK                                                     
                                                                                
         MVC   TIMRPEDT,SAVZTIDE   Period end date                              
         MVC   TIMRPID,SAVZPER     Person code                                  
         MVC   TIMRLEDT,SAVZTIDL   Location end date                            
                                                                                
         MVC   WORK+60(L'SAVZODS),SAVZODS                                       
         GOTO1 =V(SPLIT1R),WORK+60                                              
         MVC   TIMR1ROC,WORK+00                                                 
         MVC   TIMR1RDC,WORK+06                                                 
         MVC   TIMR1RSD,WORK+12                                                 
                                                                                
         JAS   RE,SETIMNA          Set narrative if present                     
                                                                                
         EDITR (B1,TIMSEQ),(3,TIMROWNO),0,ALIGN=LEFT,ZERO=NOBLANK               
         MVC   SAVZROW#,TIMROWNO                                                
         MVC   SAVZSUB#,GSPACES                                                 
         CLI   TIMLN,TIMILN1Q                                                   
         JL    AGRTIM20                                                         
         XR    RE,RE                                                            
         ICM   RE,3,TIMLINE#                                                    
         EDITR (RE),(5,TIMRSRNO),0,ALIGN=LEFT,ZERO=NOBLANK                      
         MVC   SAVZROW#,TIMROWNO                                                
         MVC   SAVZSUB#,TIMRSRNO                                                
                                                                                
DAY      USING TIMELD,R5                                                        
AGRTIM20 LR    R5,R2               Find days entry                              
                                                                                
AGRTIM22 CLI   DAY.TIMEL,0                                                      
         JE    AGRTIM28                                                         
         CLI   DAY.TIMEL,TIMELQ                                                 
         JNE   AGRTIM24                                                         
         CLC   DAY.TIMSEQ,TIMSEQ                                                
         JNE   AGRTIM24                                                         
         CLI   DAY.TIMETYP,TIMETIME                                             
         JE    AGRTIM26                                                         
                                                                                
AGRTIM24 LLC   R1,DAY.TIMLN                                                     
         AR    R5,R1                                                            
         J     AGRTIM22                                                         
                                                                                
AGRTIM26 ST    R5,FULL                                                          
*                                  Approval status                              
         MVI   TIMRCAST,TCANOTQ    Cli appr status                              
         TM    DAY.TIMEPST1,TIMESAPR+TIMESREJ                                   
         JZ    AGRTIM27                                                         
         MVI   TIMRCAST,TCAAPPQ    Cli appr status                              
         TM    DAY.TIMEPST1,TIMESREJ                                            
         JZ    AGRTIM27                                                         
         MVI   TIMRCAST,TCAREJQ    Cli appr status                              
                                                                                
AGRTIM27 OC    DAY.TIMEPIDC,DAY.TIMEPIDC                                        
         JZ    AGRTIM28                                                         
         LA    R1,DAY.TIMEPIDC                                                  
         GOTO1 =V(GETSPD)                                                       
         MVC   TIMRCACD,WORK+100    Code                                        
         MVC   TIMRCAFN,WORK+00     First name                                  
         MVC   TIMRCAMN,WORK+32     Middle name                                 
         MVC   TIMRCALN,WORK+16     Last name                                   
                                                                                
AGRTIM28 TM    SAVZSTAR,SAVZSDQ+SAVZSIQ                                         
         JZ    AGRTIM30            No days nor items at all ...                 
                                                                                
         CLI   SAVZDAYR,0          Any days left for processing?                
         JNE   AGRTIM40                                                         
         CLI   SAVZITMR,0          Any items left for processing?               
         JNE   AGRTIM50                                                         
                                                                                
AGRTIM30 CLI   TIMLN,TIMILN1Q                                                   
         JL    AGRTIM80                                                         
         J     AGRTIM80                                                         
                                                                                
AGRTIM40 CLI   DAY.TIMETYP,TIMETIME                                             
         JNE   *+2                                                              
                                                                                
*        XOUT  DAY.TIMEIDNO,TIMRSRNO,2 Sub row number                           
         EDITR (B2,DAY.TIMEIDNO),(5,TIMRSRNO),0,ALIGN=LEFT,ZERO=NOBLANK         
         MVC   SAVZROW#,TIMROWNO                                                
         MVC   SAVZSUB#,TIMRSRNO                                                
                                                                                
*        LLC   RF,SAVZDAYR                                                      
*        SHI   RF,1                                                             
*        MHI   RF,L'TIMEDAY                                                     
*        LA    R5,DAY.TIMETDT1(RF)  point to current day                        
* >>>    no check to skip empty hour lines here                                 
         DROP  DAY                                                              
                                                                                
         LLC   RF,SAVZDAYR                                                      
         SHI   RF,1                                                             
         STC   RF,SAVZDAYR                                                      
         J     AGRTIM80                                                         
                                                                                
ITM      USING TIMELD,R5                                                        
AGRTIM50 LR    R5,R2               Find items entry                             
         LLC   RF,SAVZITMR                                                      
         LLC   RE,SAVZNPIR                                                      
         SR    RE,RF                                                            
                                                                                
AGRTIM52 CLI   ITM.TIMEL,0                                                      
         JE    *+2                                                              
         CLI   ITM.TIMEL,TIMELQ                                                 
         JNE   AGRTIM54                                                         
         CLC   ITM.TIMSEQ,TIMSEQ                                                
         JNE   AGRTIM54                                                         
         CLI   ITM.TIMETYP,TIMEITMS                                             
         JNE   AGRTIM54                                                         
         CHI   RE,0                                                             
         JE    AGRTIM56                                                         
         SHI   RE,1                                                             
                                                                                
AGRTIM54 LLC   R1,ITM.TIMLN                                                     
         AR    R5,R1                                                            
         J     AGRTIM52                                                         
                                                                                
AGRTIM56 DS    0H                                                               
         EDITR (B1,ITM.TIMSEQ),(3,TIMROWNO),0,ALIGN=LEFT,ZERO=NOBLANK           
         EDITR (B2,ITM.TIMIIDNO),(5,TIMRSRNO),0,ALIGN=LEFT,ZERO=NOBLANK         
         MVC   SAVZROW#,TIMROWNO                                                
         MVC   SAVZSUB#,TIMRSRNO                                                
         DROP  ITM                                                              
                                                                                
AGRTIM58 LLC   RF,SAVZITMR                                                      
         SHI   RF,1                                                             
         STC   RF,SAVZITMR                                                      
                                                                                
AGRTIM80 DS    0H                                                               
                                                                                
*        TIMRTST  Timestamp        not defined yet                              
                                                                                
         MVI   DMCB+8,RETBFFQ      Indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGRTIMXS MVI   DMCB+8,RETBNWQ      Skip this record (don't write)               
         J     EXIT                                                             
                                                                                
SETIMTR  ST    RE,SAVERE           *** Set time type details ***                
         MVI   SAVZSTAR,0                                                       
         MVI   SAVZITMR,0                                                       
         MVI   SAVZDAYR,0                                                       
         MVI   SAVZNPIR,0                                                       
                                                                                
LKAH     USING TIMELD,R1                                                        
         LR    R1,R2                                                            
                                                                                
SETIMTR2 CLI   LKAH.TIMEL,0                                                     
         JE    SETIMTRX                                                         
         CLI   LKAH.TIMEL,TIMELQ                                                
         JNE   SETIMTR8                                                         
         CLC   LKAH.TIMSEQ,TIMSEQ                                               
         JNE   SETIMTRX                                                         
         CLI   LKAH.TIMETYP,TIMETIME                                            
         JNE   SETIMTR6                                                         
                                                                                
*        XR    RE,RE                                                            
*        LLC   RF,LKAH.TIMLN                                                    
*        SHI   RF,TIMETDT1-TIMELD                                               
*        CHI   RF,L'TIMEDAY                                                     
*        JL    *+2                 (blank element?)                             
*        D     RE,DAYLENRQ                                                      
*        CHI   RE,0                                                             
*        JNE   *+2                 (any remainder???)                           
*        CHI   RF,FFQ                                                           
*        JH    *+2                 (quotient>255???)                            
*        STC   RF,SAVZDAYR                                                      
                                                                                
         CLI   SAVZDAY,0           *** check against MCSTST bad data            
         JNE   SETIMTR6            *** (dupe TIMETIME elements)                 
                                                                                
         LA    RE,LKAH.TIMEDAY                                                  
         XR    R0,R0                                                            
         LLC   RF,LKAH.TIMLN                                                    
         LA    RF,LKAH.TIMEL(RF)                                                
                                                                                
SETIMTR3 CR    RE,RF                                                            
         JNL   SETIMTR5                                                         
         CLI   0(RE),SPACEQ                                                     
         JNH   SETIMTR5                                                         
         OC    TIMEHRS-TIMEDAY(L'TIMEHRS,RE),TIMEHRS-TIMEDAY(RE)                
         JZ    SETIMTR4            skip empty hour entries                      
         CP    TIMEHRS-TIMEDAY(L'TIMEHRS,RE),PZERO                              
         JE    SETIMTR4            skip zero hour entries                       
         AHI   R0,1                                                             
                                                                                
SETIMTR4 AHI   RE,L'TIMEDAY                                                     
         J     SETIMTR3                                                         
                                                                                
SETIMTR5 CHI   R0,0                                                             
         JE    SETIMTR8                                                         
         STC   R0,SAVZDAYR                                                      
         OI    SAVZSTAR,SAVZSDQ                                                 
         J     SETIMTR8                                                         
                                                                                
SETIMTR6 CLI   LKAH.TIMETYP,TIMEITMS                                            
         JNE   SETIMTR8                                                         
         OI    SAVZSTAR,SAVZSIQ                                                 
         LLC   RF,SAVZITMR                                                      
         CHI   RF,FFQ                                                           
         JE    *+2                                                              
         AHI   RF,1                                                             
         STC   RF,SAVZITMR                                                      
         STC   RF,SAVZNPIR                                                      
                                                                                
SETIMTR8 LLC   RF,LKAH.TIMLN                                                    
         AR    R1,RF                                                            
         J     SETIMTR2                                                         
         DROP  LKAH                                                             
                                                                                
SETIMTRX L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
NAR      USING TIMELD,R5                                                        
SETIMNA  ST    RE,SAVERE           *** Set time narrative ***                   
         LR    R5,R2               Any narrative?                               
                                                                                
SETIMNA2 CLI   NAR.TIMEL,0                                                      
         JE    SETIMNAX                                                         
         CLI   NAR.TIMEL,TIMELQ                                                 
         JNE   SETIMNA4                                                         
         CLC   NAR.TIMSEQ,TIMSEQ                                                
         JNE   SETIMNAX                                                         
         CLI   NAR.TIMETYP,TIMENAR                                              
         JE    SETIMNA6                                                         
                                                                                
SETIMNA4 LLC   R1,NAR.TIMLN                                                     
         AR    R5,R1                                                            
         J     SETIMNA2                                                         
                                                                                
SETIMNA6 CLI   NAR.TIMLN,TIMNARR-TIMELD                                         
         JL    SETIMNAX                                                         
         LLC   R1,NAR.TIMLN                                                     
         SHI   R1,TIMNARR-TIMELD+1                                              
         CHI   R1,L'TIMRTITN-1                                                  
         JNH   SETIMNA8                                                         
         LHI   R1,L'TIMRTITN-1                                                  
                                                                                
SETIMNA8 MVC   TIMRTITN(0),NAR.TIMNARR                                          
         EX    R1,*-6                                                           
*        STC   R1,LEN4TXT                                                       
*        LA    RE,NAR.TIMNARR                                                   
*        STCM  RE,B'1111',ADR4TXT                                               
*        MVI   TIMRTITN+0,C'T'                                                  
*        XOUT  TIMSEQ,TIMRTITN+2,1                                              
*        CLI   TIMLN,TIMILN1Q                                                   
*        JL    SETIMNA8                                                         
*        XOUT  TIMLINE#,TIMRTITN+5,2                                            
*                                                                               
*ETIMNA8 MVC   ENT4TXT,AGXRETYP                                                 
*        MVC   KEY4TXT(L'SAVZTID),SAVZTID                                       
*        MVC   ROW4TXT,TIMRTITN                                                 
*        OI    PROCMODE,PROCTDQ    Text processing                              
                                                                                
SETIMNAX L     RE,SAVERE                                                        
         BR    RE                                                               
         DROP  NAR                                                              
                                                                                
         DROP  R2,R3,R4                                                         
                                                                                
AGRTIMLT DC    A(LITERAL)                                                       
                                                                                
*DAYLENRQ DC    A(L'TIMEDAY)                                                    
TCANOTQ  EQU   C'1'                                                             
TCAAPPQ  EQU   C'2'                                                             
TCAREJQ  EQU   C'3'                                                             
                                                                                
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* AGFTIMC - Extract timesheet fact data                               *         
***********************************************************************         
                                                                                
AGFTIMC  NMOD1 WORKX-WORKD,*AGFTIM*,RR=RA                                       
                                                                                
         USING WORKD,RC                                                         
         USING LITERAL,RA                                                       
         L     RA,AGFTIMLT                                                      
         USING GWORKD,R9                                                        
         DS    0H                                                               
         USING DXBLOCKD,R7                                                      
         DS    0H                                                               
                                                                                
         ST    R1,APARM                                                         
         MVC   ALPARMS,0(R1)       Extract parameter list                       
                                                                                
         USING AGXRECD,R3                                                       
         USING TIMRECD,R4                                                       
         LM    R3,R4,0(R1)                                                      
                                                                                
         XC    AGXRELEN,AGXRELEN   Record length/type/eor                       
         LHI   RF,TIMFLENQ                                                      
         STCM  RF,B'0011',AGXRELEN                                              
         MVC   AGXRETYP,AGXTIMFQ                                                
                                                                                
         ZAP   EDDUB,PZERO         Init amounts to 0.00                         
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFHONI,TIMFHONI)                   
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFAMTS,TIMFAMTS)                   
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFRATC,TIMFRATC)                   
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFRATS,TIMFRATS)                   
                                                                                
         USING TIMELD,R2                                                        
         LA    R2,TIMRFST                                                       
         CLI   SAVZSEQ,0           Skip if 1st time else find previous          
         JE    AGFTIM10            cluster                                      
                                                                                
AGFTIM02 CLI   TIMEL,0                                                          
         JE    AGFTIMXS                                                         
         CLI   TIMEL,TIMELQ                                                     
         JNE   AGFTIM04                                                         
         CLI   TIMETYP,TIMEINP                                                  
         JNE   AGFTIM04                                                         
         CLC   SAVZSEQ,TIMSEQ                                                   
         JNE   AGFTIM04                                                         
         CLI   SAVZITM,0           Any days or items left to process            
         JNE   AGFTIM14            then skip here                               
         CLI   SAVZDAY,0                                                        
         JNE   AGFTIM14                                                         
         LLC   R1,TIMLN                                                         
         AR    R2,R1                                                            
         J     AGFTIM10                                                         
                                                                                
AGFTIM04 LLC   R1,TIMLN                                                         
         AR    R2,R1                                                            
         J     AGFTIM02                                                         
                                                                                
AGFTIM10 CLI   TIMEL,0             Find next cluster                            
         JE    AGFTIMXS                                                         
         CLI   TIMEL,TIMELQ                                                     
         JNE   AGFTIM12                                                         
         CLI   TIMETYP,TIMEINP                                                  
         JNE   AGFTIM12                                                         
         CLI   TIMTTYP,TIMTEM                                                   
         JNE   AGFTIM13                                                         
                                                                                
AGFTIM12 LLC   R1,TIMLN                                                         
         AR    R2,R1                                                            
         J     AGFTIM10                                                         
                                                                                
AGFTIM13 MVC   SAVZSEQ,TIMSEQ      Save current cluster                         
                                                                                
         JAS   RE,SETIMTY          Set time type details                        
                                                                                
         CLI   SAVZDAY,0           Skip zero time rows                          
         JNE   AGFTIM1A                                                         
         CLI   SAVZITM,0                                                        
         JNE   AGFTIM1A                                                         
         TM    SAVZSTA,SAVZSDQ+SAVZSIQ                                          
         JNZ   AGFTIM1A                                                         
         CLI   TIMLN,TIMILN1Q                                                   
         JL    AGFTIM12                                                         
         CP    TIMHRS,PZERO                                                     
         JE    AGFTIM12                                                         
                                                                                
AGFTIM1A CLC   PRODUL,TIMACC                                                    
         JNE   AGFTIM14                                                         
                                                                                
         GOTO1 =V(SPLITSJ),TIMACC+L'PRODUL                                      
         MVC   TIMFCLI,WORK+30+0                                                
         MVC   TIMFPRO,WORK+30+8                                                
         MVC   TIMFJOB,WORK+30+16                                               
                                                                                
         TM    TIMRSTAT,TIMSFAPP   Only create summary data for                 
         JZ    AGFTIM14                            approved time                
                                                                                
OB       USING OB_D,OBTTAREA                                                    
         LA    R0,OBTTAREA                                                      
         LHI   R1,OB_LNQ-1                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   OB.OB_LEN,=AL2(OB_CSLNQ)                                         
         MVI   OB.OB_KTYP,OB_KTYPQ                                              
         MVC   OB.OB_KMOA,TIMMOA                                                
         MVC   OB.OB_KOFF,TIMOFF                                                
         MVC   OB.OB_KCLI,WORK+30                                               
*&&UK*&& MVC   OB.OB_KAGY(2),EUROPE                                             
*&&US*&& MVC   OB.OB_KAGY(2),NORTHAM                                            
         MVI   OB.OB_KAGY+2,UNDSCQ                                              
         MVC   OB.OB_KAGY+2+1(2),SAVCALP                                        
         ZAP   OB.OB_EHRS,PZERO                                                 
         ZAP   OB.OB_BILD,PZERO                                                 
         ZAP   OB.OB_ESTA,PZERO                                                 
                                                                                
         ZAP   OB.OB_BHRS,PZERO                                                 
         ZAP   OB.OB_AHRS,PZERO                                                 
         ZAP   OB.OB_NEXA,PZERO                                                 
                                                                                
         ZAP   OB.OB_NHRS,TIMHRS   Non billable includes R time                 
         CLI   TIMTTYP,TIMTCB      Client billable time                         
         JNE   AGFTIM2A            No                                           
         ZAP   OB.OB_BHRS,TIMHRS   Billable hours                               
         ZAP   OB.OB_AHRS,TIMHRS   Actuals hours                                
         ZAP   OB.OB_NHRS,PZERO    clear non billable hours                     
         J     AGFTIM2C                                                         
                                                                                
AGFTIM2A CLI   TIMLN,TIMILN2Q      Is amount present on element                 
         JL    AGFTIM2B             below this length it won't be               
         ZAP   OB.OB_NEXA,TIMAMNT  Sales amount                                 
AGFTIM2B CLC   TIMFJOB,GSPACES     Only job time gets added to actual           
         JNH   AGFTIM2C            no job so skip                               
         ZAP   OB.OB_AHRS,TIMHRS                                                
                                                                                
AGFTIM2C CLI   DXACTION,C'D'       If action is delete need to subtract         
         JNE   AGFTIM2D             so multiply by minus one                    
         MP    OB.OB_BHRS,PMONE                                                 
         MP    OB.OB_NHRS,PMONE                                                 
         MP    OB.OB_EHRS,PMONE                                                 
         MP    OB.OB_AHRS,PMONE                                                 
         MP    OB.OB_NEXA,PMONE                                                 
         MP    OB.OB_ESTA,PMONE                                                 
         MP    OB.OB_BILD,PMONE                                                 
                                                                                
AGFTIM2D GOTOR =V(CLIREC),OB.OB_D                                               
         DROP  OB                                                               
                                                                                
AGFTIM14 DS    0H                                                               
*&&UK*&& MVC   TIMFAGY(2),EUROPE   Set general data                             
*&&US*&& MVC   TIMFAGY(2),NORTHAM                                               
         MVI   TIMFAGY+2,UNDSCQ                                                 
         MVC   TIMFAGY+2+1(2),SAVCALP                                           
                                                                                
         GOTO1 =V(SPLITAC),TIMKULA                                              
         CLI   WORK+25,C'0'                                                     
         JE    AGFTIM15                                                         
         MVC   TIMF1RA1(12),WORK+30+00+02                                       
         CLI   WORK+25,C'1'                                                     
         JE    AGFTIM15                                                         
         MVC   TIMF1RA2(12),WORK+30+15+02                                       
         CLI   WORK+25,C'2'                                                     
         JE    AGFTIM15                                                         
         MVC   TIMF1RA3(12),WORK+30+30+02                                       
         CLI   WORK+25,C'3'                                                     
         JE    AGFTIM15                                                         
         MVC   TIMF1RA4(12),WORK+30+45+02                                       
                                                                                
AGFTIM15 GOTOR =V(SETACTV),0                                                    
         MVC   TIMFUTS,WORK                                                     
                                                                                
         MVC   TIMFTID,SAVZTID                                                  
         GOTOR =V(SQUASHIT),DMCB,(L'TIMFTID,TIMFTID)                            
                                                                                
         MVC   TIMFTSRN(L'SAVZTID),SAVZTID                                      
         MVI   TIMFTSRN+L'SAVZTID,UNDSCQ                                        
         MVC   TIMFTSRN+L'SAVZTID+1(L'SAVZROW#),SAVZROW#                        
         CLC   SAVZSUB#,GSPACES                                                 
         JNH   AGFTIM16                                                         
         MVI   TIMFTSRN+L'SAVZTID+1+L'SAVZROW#,UNDSCQ                           
         MVC   TIMFTSRN+L'SAVZTID+1+L'SAVZROW#+1(L'SAVZSUB#),SAVZSUB#           
                                                                                
AGFTIM16 GOTOR =V(SQUASHIT),DMCB,(L'TIMFTSRN,TIMFTSRN)                          
                                                                                
*        MVC   TIMF1RP,SAVZTIDP                                                 
*        MVC   TIMFEDT,SAVZTIDE                                                 
         MVC   WORK+60(L'ACTKACT),GSPACES                                       
         MVC   WORK+60(L'SAVZODS),SAVZODS                                       
*        GOTO1 =V(SPLIT1R),WORK+60                                              
*        MVC   TIMF1RO,WORK+00                                                  
*        MVC   TIMF1RD,WORK+06                                                  
*        MVC   TIMF1RS,WORK+12                                                  
                                                                                
EST      USING TIMELD,R1                                                        
         LA    R1,TIMELD                                                        
                                                                                
AGFTIM17 LLC   R0,EST.TIMLN                                                     
         AR    R1,R0                                                            
         CLI   EST.TIMEL,0                                                      
         JE    AGFTIM18                                                         
         CLI   EST.TIMEL,TIMELQ                                                 
         JNE   AGFTIM18                                                         
         CLC   EST.TIMSEQ,TIMSEQ                                                
         JNE   AGFTIM18                                                         
         CLI   EST.TIMETYP,TIMEEST                                              
         JNE   AGFTIM17                                                         
         MVC   TIMFESID,EST.TIMSESNM                                            
         DROP  EST                                                              
                                                                                
AGFTIM18 CLC   PRODUL,TIMACC                                                    
         JE    AGFTIM20                                                         
         CLC   ONUL,TIMACC                                                      
         JNE   *+2                                                              
                                                                                
         MVC   TIMFNCAC,TIMACC+L'ONUL   None client account ID                  
         J     AGFTIM22                                                         
                                                                                
AGFTIM20 GOTO1 =V(SPLITSJ),TIMACC+L'PRODUL                                      
         MVC   TIMFCLI,WORK+30+0                                                
         MVC   TIMFPRO,WORK+30+8                                                
         MVC   TIMFJOB,WORK+30+16                                               
                                                                                
AGFTIM22 MVC   TIMFPID,SAVZPER                                                  
         MVC   TIMFWCD,TIMTSK                                                   
         MVC   TIMFOFF,TIMOFF                                                   
         MVI   TIMFIST,TRUEQ       (default, false if item entry)               
         MVI   TIMFISTR,FALSEQ                                                  
         MVI   TIMFISTB,FALSEQ                                                  
         MVI   TIMFISTN,FALSEQ                                                  
         MVI   TIMFISTC,FALSEQ                                                  
         CLC   PRODUL,TIMACC                                                    
         JNE   AGFTIM23                                                         
         MVI   TIMFISTC,TRUEQ                                                   
                                                                                
AGFTIM23 LA    R1,TIMFISTB                                                      
         CLI   TIMTTYP,TIMTCB      CLIENT BILLABLE                              
         JE    AGFTIM24                                                         
         LA    R1,TIMFISTR                                                      
         CLI   TIMTTYP,TIMTCR      CLIENT REALIZATION                           
         JE    AGFTIM24                                                         
*        LA    R1,TIMFISTC                                                      
*        CLI   TIMTTYP,TIMTCN      CLIENT NON-BILLABLE                          
*        JE    AGFTIM24                                                         
         LA    R1,TIMFISTN                                                      
*        CLI   TIMTTYP,TIMTNC      NON-CLIENT                                   
*        JNE   *+2                                                              
                                                                                
AGFTIM24 MVI   0(R1),TRUEQ                                                      
                                                                                
AGFTIM26 TM    SAVZSTA,SAVZSDQ+SAVZSIQ                                          
         JZ    AGFTIM27            No days nor items at all ...                 
                                                                                
         CLI   SAVZDAY,0           Any days left for processing?                
         JNE   AGFTIM40                                                         
         CLI   SAVZITM,0           Any items left for processing?               
         JNE   AGFTIM60                                                         
                                                                                
AGFTIM27 CLI   TIMLN,TIMILN1Q                                                   
         JL    AGFTIM80            (may die as no data?)                        
                                                                                
         CP    TIMHRS,PZERO        Skip empty timesheet row (cluster)           
         JE    AGFTIM80                                                         
                                                                                
AGFTIM28 DS    0H                                                               
                                                                                
*        EDITR (P3,TIMHRS),(L'TIMFHONI-1,TIMFHONI+1),0,ZERO=NOBLANK,   *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,TIMHRS                                                     
         CLI   DXACTION,C'D'                                                    
         JNE   AGFTIM29                                                         
         MP    EDDUB,PMONE                                                      
                                                                                
AGFTIM29 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFHONI,TIMFHONI)                   
                                                                                
AGFTIM30 CLI   TIMLN,TIMILN2Q                                                   
         JL    AGFTIM36                                                         
         CLI   TIMTTYP,TIMTCB      Billable time?                               
         JE    *+12                                                             
         CLI   TIMTTYP,TIMTCR      Client realization?                          
         JNE   AGFTIM34                                                         
*&&US*&& ZAP   DUB,TIMRATE                                                      
*&&UK*&& ZAP   DUB,TIMCRATE                                                     
                                                                                
*        EDITR (P8,DUB),(L'TIMFRATC-1,TIMFRATC+1),0,ZERO=NOBLANK,      *        
               ALIGN=LEFT          T19F121 Cost rate                            
                                                                                
         ZAP   EDDUB,DUB           Normal cur                                   
*        CLI   DXACTION,C'D'       Sign change required?                        
*        JNE   AGFTIM31                                                         
*        MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTIM31 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFRATC,TIMFRATC)                   
                                                                                
AGFTIM32 OC    TIMAMNT,TIMAMNT                                                  
         JZ    AGFTIM34                                                         
                                                                                
*        EDITR (P6,TIMAMNT),(L'TIMFAMTS-1,TIMFAMTS+1),0,ZERO=NOBLANK,  *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,TIMAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTIM33                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTIM33 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFAMTS,TIMFAMTS)                   
                                                                                
AGFTIM34 DS    0H                                                               
*        EDITR (P4,TIMRATE),(L'TIMFRATS-1,TIMFRATS+1),0,ZERO=NOBLANK,  *        
               ALIGN=LEFT          T19F122 Sales rate                           
                                                                                
         ZAP   EDDUB,TIMRATE       Normal cur                                   
*        CLI   DXACTION,C'D'       Sign change required?                        
*        JNE   AGFTIM35                                                         
*        MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTIM35 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFRATS,TIMFRATS)                   
                                                                                
AGFTIM36 DS    0H                                                               
         J     AGFTIM80                                                         
                                                                                
DAY      USING TIMELD,R5                                                        
AGFTIM40 LR    R5,R2               Find days entry                              
                                                                                
AGFTIM41 CLI   DAY.TIMEL,0                                                      
         JE    *+2                                                              
         CLI   DAY.TIMEL,TIMELQ                                                 
         JNE   AGFTIM42                                                         
         CLC   DAY.TIMSEQ,TIMSEQ                                                
         JNE   AGFTIM42                                                         
         CLI   DAY.TIMETYP,TIMETIME                                             
         JE    AGFTIM44                                                         
                                                                                
AGFTIM42 LLC   R1,DAY.TIMLN                                                     
         AR    R5,R1                                                            
         J     AGFTIM41                                                         
                                                                                
AGFTIM44 DS    0H                                                               
                                                                                
*        ST    R5,FULL             (not required)                               
*        LLC   RF,SAVZDAY                                                       
*        SHI   RF,1                                                             
*        MHI   RF,L'TIMEDAY                                                     
*        LA    R5,DAY.TIMETDT1(RF) Point to current day                         
                                                                                
         LLC   RF,SAVZDAY          > Skip empty/zero hour day entries           
         LA    R5,DAY.TIMEDAY      point to start                               
         DROP  DAY                                                              
                                                                                
DAY      USING TIMEDAY,R5                                                       
AGFTIM46 OC    DAY.TIMEHRS,DAY.TIMEHRS                                          
         JZ    AGFTIM48            skip empty hour entries                      
         CP    DAY.TIMEHRS,PZERO                                                
         JNE   AGFTIM50            skip zero hour entries                       
                                                                                
AGFTIM48 AHI   R5,L'TIMEDAY                                                     
         J     AGFTIM46                                                         
                                                                                
AGFTIM50 SHI   RF,1                                                             
         CHI   RF,0                this one?                                    
         JH    AGFTIM48                                                         
                                                                                
AGFTIM52 GOTO1 =V(SET1DAT),DAY.TIMETDTE                                         
         MVC   TIMFDAT,WORK                                                     
                                                                                
         OC    DAY.TIMEHRS,DAY.TIMEHRS                                          
         JNZ   AGFTIM53                                                         
         ZAP   DAY.TIMEHRS,PZERO                                                
                                                                                
AGFTIM53 DS    0H                                                               
                                                                                
*        EDITR (P4,DAY.TIMEHRS),(L'TIMFHONI-1,TIMFHONI+1),0,           *        
               ALIGN=LEFT,ZERO=NOBLANK                                          
                                                                                
         ZAP   EDDUB,DAY.TIMEHRS                                                
         CLI   DXACTION,C'D'                                                    
         JNE   AGFTIM54                                                         
         MP    EDDUB,PMONE                                                      
                                                                                
AGFTIM54 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFHONI,TIMFHONI)                   
                                                                                
         CLI   TIMLN,TIMILN2Q      (see also AGFTIM30)                          
         JL    AGFTIM58                                                         
         CLI   TIMTTYP,TIMTCB      Billable time?                               
         JE    *+12                                                             
         CLI   TIMTTYP,TIMTCR      Client realization?                          
         JNE   AGFTIM57                                                         
*&&US*&& ZAP   DUB,TIMRATE                                                      
*&&UK*&& ZAP   DUB,TIMCRATE                                                     
                                                                                
*        EDITR (P8,DUB),(L'TIMFRATC-1,TIMFRATC+1),0,ZERO=NOBLANK,      *        
               ALIGN=LEFT          T19F121 Cost rate                            
                                                                                
         ZAP   EDDUB,DUB           Normal cur                                   
*        CLI   DXACTION,C'D'       Sign change required?                        
*        JNE   AGFTIM55                                                         
*        MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTIM55 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFRATC,TIMFRATC)                   
                                                                                
         OC    TIMAMNT,TIMAMNT                                                  
         JZ    AGFTIM57                                                         
                                                                                
* bad 2007 etc. MCSTST UK data skip:                                            
         TM    TIMAMNT+L'TIMAMNT-1,X'0C'                                        
         JNO   AGFTIM57                                                         
                                                                                
*        EDITR (P6,TIMAMNT),(L'TIMFAMTS-1,TIMFAMTS+1),0,ZERO=NOBLANK,  *        
               ALIGN=LEFT                                                       
                                                                                
         ZAP   EDDUB,PZERO         Initialize it to zero                        
         OC    TIMRATE,TIMRATE     Prevent against odd/empty data               
         JZ    AGFTIM56                                                         
                                                                                
         ZAP   EDDUB,TIMRATE       Test zero rate ?                             
         JZ    AGFTIM56            Yes                                          
         MP    EDDUB,DAY.TIMEHRS   Sale rate * Hours of day / 100 =             
         SRP   EDDUB,62,5          Timesheet amount of day                      
*                                                                               
*        ZAP   EDDUB,TIMAMNT       Normal cur                                   
         CLI   DXACTION,C'D'       Sign change required?                        
         JNE   AGFTIM56                                                         
         MP    EDDUB,PMONE         Swap sign                                    
                                                                                
AGFTIM56 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFAMTS,TIMFAMTS)                   
         DROP  DAY                                                              
                                                                                
AGFTIM57 OC    TIMRATE,TIMRATE     Prevent against odd/empty data               
         JZ    AGFTIM58                                                         
                                                                                
*        EDITR (P4,TIMRATE),(L'TIMFRATS-1,TIMFRATS+1),0,ZERO=NOBLANK,  *        
               ALIGN=LEFT          T19F122 Sales rate                           
                                                                                
         ZAP   EDDUB,TIMRATE       Normal cur                                   
         GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFRATS,TIMFRATS)                   
                                                                                
AGFTIM58 LLC   RF,SAVZDAY                                                       
         SHI   RF,1                                                             
         STC   RF,SAVZDAY                                                       
         J     AGFTIM80                                                         
                                                                                
ITM      USING TIMELD,R5                                                        
AGFTIM60 LR    R5,R2               Find items entry                             
         LLC   RF,SAVZITM                                                       
         LLC   RE,SAVZNPI                                                       
         SR    RE,RF                                                            
                                                                                
AGFTIM62 CLI   ITM.TIMEL,0                                                      
         JE    *+2                                                              
         CLI   ITM.TIMEL,TIMELQ                                                 
         JNE   AGFTIM64                                                         
         CLC   ITM.TIMSEQ,TIMSEQ                                                
         JNE   AGFTIM64                                                         
         CLI   ITM.TIMETYP,TIMEITMS                                             
         JNE   AGFTIM64                                                         
         CHI   RE,0                                                             
         JE    AGFTIM66                                                         
         SHI   RE,1                                                             
                                                                                
AGFTIM64 LLC   R1,ITM.TIMLN                                                     
         AR    R5,R1                                                            
         J     AGFTIM62                                                         
                                                                                
AGFTIM66 GOTO1 =V(SET1DAT),TIMKPEDT                                             
         MVC   TIMFDAT,WORK                                                     
         XOUT  ITM.TIMISEQ,TIMFITM,3                                            
                                                                                
*17aug   XOUT  ITM.TIMSEQ,TIMFFID,1   T19F108 Start.3                           
*        MVI   TIMFFID+2,UNDSCQ                                                 
*        MVI   TIMFFID+3,TS_ITEMQ                                               
*        MVI   TIMFFID+4,UNDSCQ                                                 
*        XOUT  ITM.TIMIIDNO,TIMFFID+5,2                                         
*        MVI   TIMFFID+9,UNDSCQ       T19F108 End.3                             
*        XOUT  ITM.TIMIIIDN,TIMFFID+10,2                                        
*        GOTOR =V(SQUASHIT),DMCB,(L'TIMFFID,TIMFFID)                            
                                                                                
*        EDITR (P6,ITM.TIMIMULT),(L'TIMFHONI-1,TIMFHONI+1),0,          *        
               ZERO=NOBLANK,ALIGN=LEFT                                          
                                                                                
         MVI   TIMFIST,FALSEQ                                                   
         ZAP   EDDUB,ITM.TIMIMULT                                               
         CLI   DXACTION,C'D'                                                    
         JNE   AGFTIM67                                                         
         MP    EDDUB,PMONE                                                      
                                                                                
AGFTIM67 GOTO1 =V(SETAMNT),DMCB,SAVCCUR,(L'TIMFHONI,TIMFHONI)                   
         DROP  ITM                                                              
                                                                                
AGFTIM68 LLC   RF,SAVZITM                                                       
         SHI   RF,1                                                             
         STC   RF,SAVZITM                                                       
                                                                                
AGFTIM80 DS    0H                                                               
*        TIMFTST  Timestamp        Not defined yet                              
                                                                                
         CLI   SAVZDAY,0           Process next day/item or cluster             
         JNE   AGFTIMXY            Unless days/items o/s                        
         CLI   SAVZITM,0                                                        
         JNE   AGFTIMXY                                                         
                                                                                
AGFTIM90 LLC   R1,TIMLN            Is there more to come?                       
         AR    R2,R1                                                            
         CLI   TIMEL,0                                                          
         JE    AGFTIMXN                                                         
         CLI   TIMEL,TIMELQ                                                     
         JNE   AGFTIM90                                                         
         CLI   TIMETYP,TIMEINP                                                  
         JNE   AGFTIM90                                                         
         CLI   TIMTTYP,TIMTEM      Empty timesheet dummy row                    
         JE    AGFTIM90                                                         
         J     AGFTIMXY            Yes ...                                      
                                                                                
AGFTIMXS MVI   DMCB+8,RETBNWQ      Skip this record (don't write)               
         J     EXIT                                                             
                                                                                
AGFTIMXY MVI   DMCB+8,RETBFFQ      Indicate fact(s) to follow                   
         J     EXIT                                                             
                                                                                
AGFTIMXN MVI   DMCB+8,RETBNMQ      Indicate no more to come                     
         J     EXIT                                                             
                                                                                
SETIMTY  ST    RE,SAVERE           *** Set time type details ***                
         MVI   SAVZSTA,0                                                        
         MVI   SAVZITM,0                                                        
         MVI   SAVZDAY,0                                                        
         MVI   SAVZNPI,0                                                        
                                                                                
LKAH     USING TIMELD,R1                                                        
         LR    R1,R2                                                            
                                                                                
SETIMTY2 CLI   LKAH.TIMEL,0                                                     
         JE    SETIMTYX                                                         
         CLI   LKAH.TIMEL,TIMELQ                                                
         JNE   SETIMTY8                                                         
         CLC   LKAH.TIMSEQ,TIMSEQ                                               
         JNE   SETIMTYX                                                         
         CLI   LKAH.TIMETYP,TIMETIME                                            
         JNE   SETIMTY6                                                         
                                                                                
*        XR    RE,RE                                                            
*        LLC   RF,LKAH.TIMLN                                                    
*        SHI   RF,TIMETDT1-TIMELD                                               
*        CHI   RF,L'TIMEDAY                                                     
*        JL    *+2                 (blank element?)                             
*        D     RE,DAYLENQ                                                       
*        CHI   RE,0                                                             
*        JNE   *+2                 (any remainder???)                           
*        CHI   RF,FFQ                                                           
*        JH    *+2                 (quotient>255???)                            
*        STC   RF,SAVZDAY                                                       
                                                                                
         CLI   SAVZDAY,0           *** check against MCSTST bad data            
         JNE   SETIMTY6            *** (dupe TIMETIME elements)                 
                                                                                
         LA    RE,LKAH.TIMEDAY                                                  
         XR    R0,R0                                                            
         LLC   RF,LKAH.TIMLN                                                    
         LA    RF,LKAH.TIMEL(RF)                                                
                                                                                
SETIMTY3 CR    RE,RF                                                            
         JNL   SETIMTY5                                                         
         CLI   0(RE),SPACEQ                                                     
         JNH   SETIMTY5                                                         
         OC    TIMEHRS-TIMEDAY(L'TIMEHRS,RE),TIMEHRS-TIMEDAY(RE)                
         JZ    SETIMTY4            skip empty hour entries                      
         CP    TIMEHRS-TIMEDAY(L'TIMEHRS,RE),PZERO                              
         JE    SETIMTY4            skip zero hour entries                       
         AHI   R0,1                                                             
                                                                                
SETIMTY4 AHI   RE,L'TIMEDAY                                                     
         J     SETIMTY3                                                         
                                                                                
SETIMTY5 CHI   R0,0                                                             
         JE    SETIMTY8                                                         
         STC   R0,SAVZDAY                                                       
         OI    SAVZSTA,SAVZSDQ                                                  
         J     SETIMTY8                                                         
                                                                                
SETIMTY6 CLI   LKAH.TIMETYP,TIMEITMS                                            
         JNE   SETIMTY8                                                         
         OI    SAVZSTA,SAVZSIQ                                                  
         LLC   RF,SAVZITM                                                       
         CHI   RF,FFQ                                                           
         JE    *+2                                                              
         AHI   RF,1                                                             
         STC   RF,SAVZITM                                                       
         STC   RF,SAVZNPI                                                       
                                                                                
SETIMTY8 LLC   RF,LKAH.TIMLN                                                    
         AR    R1,RF                                                            
         J     SETIMTY2                                                         
         DROP  LKAH                                                             
                                                                                
SETIMTYX L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
         DROP  R2,R3,R4                                                         
                                                                                
AGFTIMLT DC    A(LITERAL)                                                       
*DAYLENQ  DC    A(L'TIMEDAY)                                                    
                                                                                
TS_ITEMQ EQU   C'I'                                                             
TS_DAYQ  EQU   C'D'                                                             
TS_TIMEQ EQU   C'T'                                                             
         DROP  R7,R9,RA                                                         
                                                                                
***********************************************************************         
* General code, LTOrg and DSECTs                                      *         
***********************************************************************         
                                                                                
DELREC   L     R1,APARM            DELETE THIS RECORD                           
         MVI   8(R1),X'80'                                                      
         J     EXIT                                                             
                                                                                
RETEXIT  L     R1,APARM                                                         
         OI    8(R1),X'40'         SET RETURN REQUIRED                          
         J     EXIT                                                             
                                                                                
EXIT     XMOD1 1                                                                
                                                                                
LITERAL  DS    0D                                                               
                                                                                
         LTORG                                                                  
                                                                                
VDATCON  DC    V(DATCON)                                                        
VADDAY   DC    V(ADDAY)                                                         
VHEXOUT  DC    V(HEXOUT)                                                        
*&&US                                                                           
VCATCALL DC    V(CATCALL)                                                       
*&&                                                                             
                                                                                
       ++INCLUDE MXTRT                                                          
                                                                                
       ++INCLUDE FALANGTAB                                                      
                                                                                
WORKD    DSECT                                                                  
ALPARMS  DS    0XL20               PARAMETER LIST                               
AXREC    DS    A                   A(EXTRACT RECORD)                            
AFREC    DS    A                   A(ACCFILE RECORD)                            
         DS    A                                                                
         DS    A                                                                
         DS    A                                                                
                                                                                
APARM    DS    A                   A(PARAMETER LIST)                            
RELO     DS    A                                                                
ALEVELS  DS    A                                                                
                                                                                
*&&US                                                                           
CATBLK   DS    CL(CATLNQ)          CATCALL AREA RETURN BY CATCALL               
*&&                                                                             
PKWORK2  DS    PL2                                                              
SAVOAMT  DS    PL6                 Saved order amount                           
BILLAMT  DS    PL6                 Saved billed amount                          
SAVMOS   DS    XL2                 Saved trans MOA                              
SAVCPID  DS    XL2                 Saved creator pid                            
WORKX    DS    0H                                                               
                                                                                
***********************************************************************         
* Included books                                                      *         
***********************************************************************         
                                                                                
       ++INCLUDE DXDSECTS                                                       
       ++INCLUDE AGXWORKD                                                       
       ++INCLUDE AGXRECD                                                        
       ++INCLUDE ACGENFILE                                                      
       ++INCLUDE ACGENRAC                                                       
       ++INCLUDE ACJOBBLOCK                                                     
*&&US                                                                           
       ++INCLUDE ACCATCALLD                                                     
*&&                                                                             
                                                                                
PRORATAD DSECT                                                                  
       ++INCLUDE ACPRORATAD                                                     
                                                                                
GOBLOCKD DSECT                                                                  
       ++INCLUDE ACGOBLOCK                                                      
                                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'038AGXROUTS  08/24/20'                                      
         END                                                                    
