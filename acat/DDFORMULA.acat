*          DATA SET DDFORMULA  AT LEVEL 006 AS OF 05/01/02                      
*CATALP FORMULA                                                                 
*                                                                               
*********************************************************************           
*                                                                   *           
*  FORMULA                                                          *           
*                                                                   *           
*  FUNCTIONS 1 CALCULATION   FORMULA, OPERATE +-*X/% DECIMAL & HEX  *           
*  INPUT     P1  BYTE  0     L'FORMULA                              *           
*                      1-3   A(FORMULA)                             *           
*            P2        0     TYPE                                   *           
*                      1-3   A(ANSWER)                              *           
*            P3        1-3   A(COMMON FACILITY LIST)                *           
*            P4        1-3   A(CUREDIT)                             *           
*  OUTPUT    P1        0     PRECISION                              *           
*            P2        O     L'ANSWER    IF VALID                   *           
*                            X'FF'       IF INVALID                 *           
*            3               ANSWER IN PASSED ADDRESS               *           
*     TYPE= X-HEXADECIMAL INPUT                                     *           
*           0-STRING OUTPUT                                         *           
*           1-PACKED OUTPUT                                         *           
*********************************************************************           
         TITLE 'FORMULA  MODULE   '                                             
         PRINT NOGEN                                                            
FORMULA  CSECT                                                                  
         NMOD1 DATX-DATD,*FORMULA*,R9,RR=R5,CLEAR=YES                           
         USING DATD,RC                                                          
*                                                                               
***************************************************************                 
*                                                                               
*  CONTROL BLOCK                                                                
*                                                                               
***************************************************************                 
*                                                                               
C1       BAS   RE,PREL             PRELIMINARIES                                
         CLI   DMCB,0                                                           
         BE    C2A                                                              
         MVI   ERR,X'FF'                                                        
         B     EXIT                                                             
*                                                                               
C2A      GOTO1 COMPRESS,DMCB,ASTART,AENDFOR                                     
         CLI   DMCB,0                                                           
         BE    C2B                                                              
         MVI   ERR,X'FF'                                                        
         B     EXIT                                                             
*                                                                               
C2B      L     R2,DMCB                                                          
         LA    R2,0(R2)                                                         
         ST    R2,ASTART                                                        
         L     R2,DMCB+4                                                        
         LA    R2,0(R2)                                                         
         ST    R2,AENDFOR                                                       
*                                                                               
C2       GOTO1 OPERA,DMCB,(0,ASTART),AENDFOR,SETOPER  LOC FIRST OPERAND         
         CLI   DMCB,0                                                           
         BE    C3                                                               
         MVI   ERR,X'FF'                                                        
         B     EXIT                                                             
*                                                                               
C3       ZIC   R2,DMCB+4                                                        
         STC   R2,LOP1          R2=LOP1=L'FIRST OPERAND                         
         L     R3,DMCB+4                                                        
         LA    R3,0(R3)                                                         
         ST    R3,AOP1          1R3=AOP1=A(FIRST OPERAND)                       
*                                                                               
C4       GOTO1 DELIM,DMCB,(LOP1,AOP1),SET1,AENDFOR   LOC                        
         CLI   DMCB,0             DELIMITER TYPE 1                              
         BE    C5                                                               
         MVI   ERR,X'FF'                                                        
         B     EXIT                                                             
*                                                                               
C5       L     R3,DMCB+4                                                        
         LA    R3,0(R3)                                                         
         ST    R3,ADEL1            R3=ADEL1=A(DELIMITER)                        
*                                                                               
C6       GOTO1 OPERA,DMCB,(1,ADEL1),AENDFOR,SETOPER                             
         CLI   DMCB,0                                                           
         BE    C7                                                               
         MVI   ERR,X'FF'           NO SECOND OPERAND                            
         B     EXIT                                                             
*                                                                               
C7       ZIC   R2,DMCB+4                                                        
         STC   R2,LOP2             R2=LOP2=L'SECOND OPERAND                     
         L     R3,DMCB+4                                                        
         LA    R3,0(R3)                                                         
         ST    R3,AOP2             R3=AOP2=A(SECOND OPERAND)                    
*                                                                               
         GOTO1 DELIM,DMCB,(LOP2,AOP2),SET2,AENDFOR     LOC DELIM2               
         CLI   DMCB,0                                                           
         BE    C9                  2 OPERAND,2 OPERATION                        
*                                                                               
C8       BAS   RE,RETBL1                                                        
         A     RF,RELO             RF=A(BLOCK EXECUTION)                        
         GOTO1 (RF),DMCB,(LOP1,AOP1),(LOP2,AOP2)     EXECUTION                  
         CLI   DMCB,0                                                           
         BE    C10A                OK,PROCESS CYCLE                             
         MVI   ERR,X'FF'           ERROR                                        
         B     EXIT                                                             
*                                                                               
C9       L     R3,DMCB+4                                                        
         LA    R3,0(R3)                                                         
         ST    R3,ADEL2                                                         
         BAS   RE,RETBL2           LOC A(BLOCK EXECUTION)                       
         A     RF,RELO             RF=A(BLOCK EXECUTION)                        
         GOTO1 (RF),DMCB,(LOP1,AOP1),(LOP2,AOP2),ADEL1      EXEC %              
         CLI   DMCB,0                                                           
         BE    C10B                OK,PROCESS CYCLE                             
         MVI   ERR,X'FF'           ERROR                                        
         B     EXIT                                                             
*                                                                               
*                         CYCLE                                                 
*                                                                               
C10A     MVC   LNEXT,LOP2          PREPARATION FOR NEXT ACTION                  
         MVC   ANEXT,AOP2          CURRENT VALUES                               
         B     C10                                                              
*                                                                               
C10B     MVI   LNEXT,1             PREPARATION FOR NEXT ACTION                  
         MVC   ANEXT,ADEL2         CURRENT VALUES                               
*                                                                               
*                                                                               
C10      MVI   ZERO,1              CALCULATION IN PROGRESS                      
         GOTO1 DELIM,DMCB,(LNEXT,ANEXT),SET1,AENDFOR     LOC DELIMITER          
         CLI   DMCB,0                                                           
         BE    C11                                                              
         CLC   DMCB+4(4),=F'0'                                                  
         BE    EXIT      NO DELIMITER BUT ALL SPACES END OF FORMULA             
         MVI   ERR,X'FF'         NO DELIMITER,NOT END OF FORMULA ERROR          
         B     EXIT                                                             
*                                                                               
C11      L     R3,DMCB+4                                                        
         LA    R3,0(R3)                                                         
         ST    R3,ADEL1            R3=A(DELIMITER)                              
*                                                                               
         GOTO1 OPERA,DMCB,(1,ADEL1),AENDFOR,SETOPER  LOC NEXT                   
         CLI   DMCB,0 OPERAND                                                   
         BE    C12                                                              
         MVI   ERR,X'FF'           ERROR,AFTER DELIMITER OPERAND                
         B     EXIT                SHOULD FOLLOW                                
*                                                                               
C12      ZIC   R2,DMCB+4                                                        
         STC   R2,LNEXT            LNEXT=L'NEXT OPERAND                         
         L     R3,DMCB+4                                                        
         LA    R3,0(R3)                                                         
         ST    R3,ANEXT            ANEXT=A(NEXT OPERAND9                        
*                                                                               
C13      GOTO1 DELIM,DMCB,(LNEXT,ANEXT),SET2,AENDFOR                            
         CLI   DMCB,0              IS THERE SECOND DELIMITER                    
         BE    C15                 EXIST                                        
*                                                                               
C14      BAS   RE,RETBL1                                                        
         A     RF,RELO                                                          
         GOTO1 (RF),DMCB,(LANS,ANS),(LNEXT,ANEXT)                               
         CLI   DMCB,0                                                           
         BE    C10                 CONTINUE CYCLE                               
         MVI   ERR,X'FF'           ERROR                                        
         B     EXIT                                                             
*                                                                               
C15      L     R3,DMCB+4                                                        
         LA    R3,0(R3)                                                         
         ST    R3,ADEL2                                                         
         BAS   RE,RETBL2                                                        
         A     RF,RELO                                                          
         GOTO1 (RF),DMCB,(LANS,ANS),(LNEXT,ANEXT),ADEL1                         
         CLI   DMCB,0                                                           
         BE    C10B                CONTINUE CYCLE                               
         MVI   ERR,X'FF'                                                        
*                                                                               
EXIT     EQU   *                                                                
C16      L     R2,APARAM                                                        
         CLI   ERR,X'FF'                                                        
         BNE   C17                                                              
         MVI   4(R2),X'FF'                                                      
         B     XIT1                                                             
*                                                                               
C17      GOTO1 CONVERT,DMCB        CONVERSION ANSWER                            
*                                                                               
         MVC   0(1,R2),PREC        MOVE PRECISION                               
         L     R3,4(R2)                                                         
         LA    R3,0(R3)            R3=A(ANSWER IN CALLING PROGRAM)              
         ZIC   R4,LANS             R4=L'ANSWER                                  
         BCTR  R4,0                                                             
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),ANS         MOVE ANSWER                                  
         MVC   4(1,R2),LANS        MOVE ANSWER                                  
XIT1     XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  PRELIMINARIES              DMCB=0  - VALID   1- INVALID          *           
*********************************************************************           
*                                                                               
PREL     DS    0H                                                               
         NTR1                                                                   
*                                                                               
         ST    R1,APARAM           APARAM=A(PARAMETER LIST)                     
         L     R2,0(R1)                                                         
         LA    R2,0(R2)            R2=A(START OF FORMULA)                       
         ST    R2,ASTART                                                        
*                                                                               
         ZIC   R3,0(R1)            R3=L'FORMULA                                 
         AR    R2,R3                                                            
         BCTR  R2,0                                                             
         ST    R2,AENDFOR          R2=A(END OF FORMULA)                         
*                                                                               
         ZIC   R3,4(R1)                                                         
         STC   R3,TYPE                                                          
         CLI   TYPE,C'0'                                                        
         BE    PL1                                                              
         CLI   TYPE,C'1'                                                        
         BE    PL1                                                              
         CLI   TYPE,C'X'                                                        
         BE    PL1                                                              
         MVI   DMCB,1              ERROR                                        
         B     ENDPL                                                            
*                                                                               
PL1      L     R2,8(R1)                                                         
         LA    R2,0(R2)                                                         
         ST    R2,ACOMFACS         R2=A(COMMON FACILITY LIST)                   
         L     R3,12(R1)                                                        
         LA    R3,0(R3)                                                         
         ST    R3,VCUREDIT         R3=A(CUREDITR)                               
*                                                                               
         L     RE,ACOMFACS                                                      
         USING COMFACSD,RE                                                      
*                                                                               
         MVC   VHEXIN,CHEXIN                                                    
         MVC   VHEXOUT,CHEXOUT                                                  
*                                                                               
         ST    R5,RELO                                                          
         MVI   DMCB,0                                                           
ENDPL    XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  OPERA                                                            *           
*                                                                   *           
*  FUNCTIONS 1 RETRIEVAL OPERAND                                    *           
*  INPUT     P1  BYTE  0     L'PREVIOUS FUNCTION/DELIMITER          *           
*                      1-3   A(PREVIOUS FUNCTION/DELIMITER)         *           
*            P2        1-3   A'END OF STRING                        *           
*            P3        1-3   A(SET OF POSSIBLE SYMBOLS OF OPERAND)  *           
*  OUTPUT    P1        0     X'00'-OPERAND EXIST,X'FF'-NO OPERAND   *           
*            P2        O     L'OPERAND                              *           
*                      1-3   A(OPERAND)                             *           
*                                                                   *           
*********************************************************************           
*                                                                               
OPERA    NTR1                                                                   
*                                                                               
         ZIC   R2,DMCB             R2=L'PREVIOUS FUNCTION/DELIMITER             
         L     R3,DMCB                                                          
         LA    R3,0(R3)            R3=A(PREVIOUS FUNCTION/DELIMITER)            
         AR    R3,R2               R3=START ADDRESS FOR LOCATION                
         L     R7,DMCB+4                                                        
         LA    R7,1(R7)            R7=A(END OF STRING)+1                        
*                                                                               
CLOP1    CLI   0(R3),X'40'                                                      
         BH    CLOP2               FIRST SYMBOL                                 
         LA    R3,1(R3)                                                         
         CR    R3,R7                                                            
         BNE   CLOP1                                                            
*                                                                               
         MVI   DMCB,X'FF'          NO OPERAND                                   
         B     ENDOP                                                            
*                                                                               
CLOP2    LR    R6,R3               R3=R6=A(OPERAND)                             
         XR    R8,R8                                                            
*                                                                               
         CLI   0(R3),C'-'                                                       
         BE    CLOP5                                                            
         CLI   0(R3),C'+'                                                       
         BE    CLOP5                                                            
*                                                                               
CLOP3    L     R4,DMCB+8                                                        
         LA    R4,0(R4)            R4=A(SET OF POSSIBLE SYMBOLS OF OP           
CLOP4    CLC   0(1,R3),0(R4)                                                    
         BE    CLOP5               GOOD CHARACTER                               
         LA    R4,1(R4)                                                         
         CLI   0(R4),X'FF'                                                      
         BE    CLOP6               END OF OPERAND                               
         B     CLOP4                                                            
*                                                                               
CLOP5    LA    R3,1(R3)                                                         
         LA    R8,1(R8)                                                         
         CR    R3,R7                                                            
         BNE   CLOP3                                                            
*                                                                               
CLOP6    C     R8,=F'0'                                                         
         BNE   CLOP7               OPERAND EXISTS                               
         MVI   DMCB,X'FF'          NO OPERAND                                   
         B     ENDOP                                                            
*                                                                               
CLOP7    ST    R6,DMCB+4           R6=A(OPERAND)                                
         STC   R8,DMCB+4           R8=L'OPERAND                                 
         MVI   DMCB,0                                                           
ENDOP    XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  DELIM                                                            *           
*                                                                   *           
*  FUNCTIONS 1 LOC CURRENT DELIMITER IN FORMULA (TYPE 1,TYPE 2)     *           
*  INPUT     P1   BYTE   0   L'OPERAND                              *           
*                        1-3 A(OPERAND)                             *           
*            P2          1-3 A(DELIMITER SET)                       *           
* P3          1-3 A(END OF FORMULA)                      *                      
*  OUTPUT    P1          0   X'00'/X'FF' IF NO DELIMITER            *           
*            P2          1-3 A(DELIMITER                            *           
*                        0-4 ZERO IF NO DELIMITER AND ALL SPACES    *           
*                            AFTER OPERAND                          *           
*********************************************************************           
*                                                                               
DELIM    NTR1                                                                   
         ZIC   R2,DMCB             R2=L'OPERAND                                 
         L     R3,DMCB                                                          
         LA    R3,0(R3)            R3=A(OPERAND)                                
         AR    R3,R2               R3=START ADDRESS FOR LOCATION                
         L     R4,DMCB+4                                                        
         LA    R4,0(R4)            R4=A(DELIMITER SET)                          
         L     R5,DMCB+8                                                        
         LA    R5,1(R5)            R5=A(END OF FORMULA +1)                      
*                                                                               
         CR    R3,R5                                                            
         BE    FIL                 END OF FORMULA,NO ERROR                      
D1       CLI   0(R3),X'40'         LOC OF DELIMITER                             
         BH    D2                                                               
         LA    R3,1(R3)                                                         
         B     D1                                                               
FIL      MVI   DMCB,X'FF'          NO DELIMITER BUT                             
         MVC   DMCB+4(4),=F'0'     ALL SPACES                                   
         B     ENDDEL                                                           
*                                                                               
D2       CLC   0(1,R3),0(R4)       IS IT DELIMITER                              
         BE    D3                                                               
         LA    R4,1(R4)                                                         
         CLI   0(R4),X'FF'         END OF DELIMITER SET ?                       
         BNE   D2                                                               
*                                                                               
         MVI   DMCB,X'FF'          NO DELIMITER                                 
         B     ENDDEL              NOT ALL SPACES                               
*                                                                               
D3       ST    R3,DMCB+4           R3=A(DELIMITER)                              
         MVI   DMCB,0                                                           
ENDDEL   XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  RETBL1                                                           *           
*                                                                   *           
*  FUNCTIONS 1  LOC    A(BLOCK EXECUTION)                           *           
*  INPUT     1  TABL                                                            
*            2  A(OPERATION)-ADEL1                                  *           
*  OUTPUT    1  RF=A(SUB ROUTIN)                                    *           
*                                                                   *           
*********************************************************************           
*                                                                               
RETBL1   DS    0H                                                               
         NTR1                                                                   
*                                                                               
         L     R2,ADEL1            R2=A(DELIMITER)                              
         LA    R3,TABL                                                          
CLR1     CLC   0(1,R2),0(R3)                                                    
         BE    CLR2                                                             
         LA    R3,8(R3)                                                         
         B     CLR1                                                             
CLR2     L     RF,4(R3)            RF=A(SUB ROUTINE)                            
         XIT1  REGS=(RF)                                                        
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  RETBL2                                                           *           
*                                                                   *           
*  FUNCTIONS 1  LOC    A(BLOCK EXECUTION)                           *           
*  INPUT     1  TABL                                                            
*            2  A(OPERATION)-ADEL2                                  *           
*  OUTPUT    1  RF=A(SUB ROUTIN)                                    *           
*                                                                   *           
*********************************************************************           
*                                                                               
RETBL2   DS    0H                                                               
         NTR1                                                                   
*                                                                               
         L     R2,ADEL2            R2=A(DELIMITER)                              
         LA    R3,TABL                                                          
POT1     CLC   0(1,R2),0(R3)                                                    
         BE    POT2                                                             
         LA    R3,8(R3)                                                         
         B     POT1                                                             
POT2     L     RF,4(R3)            RF=A(SUB ROUTINE)                            
         XIT1  REGS=(RF)                                                        
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  ADD                                                              *           
*                                                                   *           
*  FUNCTIONS 1 ADDING TWO NUMBER                                    *           
*  INPUT     P1    BYTE   0    L'OPERAND 1                          *           
*                         1-3  A(OPERAND 1)                         *           
*            P2           0    L'OPERAND 2                          *           
*                         1-3  A(OPERAND 2)                         *           
*  OUTPUT    1 ANS =ANSWER                                          *           
*            2 LANS=L'ANSWER                                        *           
*            3 PREC=PRECISION                                       *           
*            P1           0    0-VALID,X'FF'-INVALID                *           
*                                                                   *           
*********************************************************************           
***********************************************************                     
*                                                                               
ADD      NTR1                                                                   
*                                                                               
         ZIC   R2,DMCB                                                          
         STC   R2,LONE             R2=L'OP1                                     
         L     R3,DMCB                                                          
         LA    R3,0(R3)                                                         
         ST    R3,AONE             R3=A(OP1)                                    
*                                                                               
         ZIC   R4,DMCB+4                                                        
         STC   R4,LTWO             R4=L'OP2                                     
         L     R5,DMCB+4                                                        
         LA    R5,0(R5)                                                         
         ST    R5,ATWO             R5=A(OP2)                                    
*                                                                               
         CLI   TYPE,C'X'                                                        
         BE    HEXAD               HEXADECEMAL CALCULATION                      
*                                                                               
*                                  DECIMAL CALCULATION                          
*                                                                               
         CLI   ZERO,0                                                           
         BNE   AD3                                                              
*                                                                               
*                                  ZERO CALCULATION                             
*                                                                               
         GOTO1 CHECKD,DMCB,(LONE,AONE),PC1            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    AD1                                                              
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
AD1      GOTO1 CHECKD,DMCB,(LTWO,ATWO),PC2            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    AD2                                                              
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
AD2      AP    PC1(16),PC2(16)     PC1=SUM                                      
         MVC   ANS(16),PC1                                                      
         MVI   LANS,16                                                          
*                                                                               
         GOTO1 SIZE,DMCB,ANS       VALIDATE SIZE OF RESULT                      
         CLI   DMCB,0                                                           
         BE    ENDADD                                                           
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                  NON ZERO CALC                                
AD3      GOTO1 CHECKD,DMCB,(LTWO,ATWO),PC2            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    AD4                                                              
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
AD4      AP    0(16,R3),PC2(16)                                                 
         MVC   ANS(16),0(R3)                                                    
         MVI   LANS,16                                                          
         GOTO1 SIZE,DMCB,ANS       VALIDATE SIZE OF RESULT                      
         CLI   DMCB,0                                                           
         BE    ENDADD                                                           
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
*                              HEXADECIMAL CALCULATION                          
*                                                                               
HEXAD    CLI   ZERO,0                                                           
         BNE   AD9                                                              
*                                                                               
*                                  ZERO CALCULATION                             
*                                                                               
         GOTO1 CHECKHD,DMCB,(LONE,AONE),HEXDEC       CHECKING HEXA              
         CLI   DMCB,0                                DECIMAL                    
         BE    AD5                                                              
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
AD5      GOTO1 VHEXIN,DMCB,AONE,FWORD1,(R2) CONVERT TO BINARY                   
         CLC   DMCB+12(4),=F'0' INTO FWORD                                      
         BNE   W1                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
W1       L     RF,FWORD1           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R2                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD1                                                        
*                                                                               
AD6      GOTO1 CHECKHD,DMCB,(LTWO,ATWO),HEXDEC         CHECKING HEXA            
         CLI   DMCB,0                                  DECIMAL                  
         BE    AD7                                                              
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
AD7      GOTO1 VHEXIN,DMCB,ATWO,FWORD2,(R4)        CONVERT TO BINARY            
         CLC   DMCB+12(4),=F'0'                    INTO FWORD                   
         BNE   W2                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
W2       L     RF,FWORD2           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R4                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD2                                                        
*                                                                               
AD8      L     R6,FWORD1                                                        
         A     R6,FWORD2           R6=SUM                                       
         ST    R6,ANS                                                           
         MVI   LANS,4                                                           
         B     ENDADD                                                           
*                                                                               
* NON ZERO CALCULATION                                                          
*                                                                               
AD9      GOTO1 CHECKHD,DMCB,(LTWO,ATWO),HEXDEC         CHECKING HEXA            
         CLI   DMCB,0                                  DECIMAL                  
         BE    AD10                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
AD10     GOTO1 VHEXIN,DMCB,ATWO,FWORD2,(R4)        CONVERT TO BINARY            
         CLC   DMCB+12(4),=F'0'                    INTO FWORD                   
         BNE   W3                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDADD                                                           
*                                                                               
W3       L     RF,FWORD2           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R4                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD2                                                        
*                                                                               
AD11     L     R6,0(R3)                                                         
         A     R6,FWORD2           R6=SUM                                       
         ST    R6,ANS                                                           
         MVI   LANS,4                                                           
*                                                                               
ENDADD   CLI   ERR,X'FF'                                                        
         BE    AD12                                                             
         MVI   DMCB,0                                                           
         B     AD13                                                             
AD12     MVI   DMCB,X'FF'                                                       
AD13     XIT1                                                                   
*                                                                               
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  SUB                                                              *           
*                                                                   *           
*  FUNCTIONS 1 SUBSTRACTION                                         *           
*  INPUT     P1    BYTE   0    L'OPERAND 1                          *           
*                         1-3  A(OPERAND 1)                         *           
*            P2           0    L'OPERAND 2                          *           
*                         1-3  A(OPERAND 2)                         *           
*  OUTPUT    1 ANS =ANSWER                                          *           
*            2 LANS=L'ANSWER                                        *           
*            3 PREC=PRECISION                                       *           
*            P1           0    0-VALID,X'FF'-INVALID                *           
*                                                                   *           
*********************************************************************           
***********************************************************                     
*                                                                               
SUB      NTR1                                                                   
*                                                                               
         ZIC   R2,DMCB                                                          
         STC   R2,LONE             R2=L'OP1                                     
         L     R3,DMCB                                                          
         LA    R3,0(R3)                                                         
         ST    R3,AONE             R3=A(OP1)                                    
*                                                                               
         ZIC   R4,DMCB+4                                                        
         STC   R4,LTWO             R4=L'OP2                                     
         L     R5,DMCB+4                                                        
         LA    R5,0(R5)                                                         
         ST    R5,ATWO             R5=A(OP2)                                    
*                                                                               
         CLI   TYPE,C'X'                                                        
         BE    HEXSUB              HEXADECEMAL CALCULATION                      
*                                                                               
*                                  DECIMAL CALCULATION                          
*                                                                               
         CLI   ZERO,0                                                           
         BNE   SUB3                                                             
*                                                                               
*                                  ZERO CALCULATION                             
*                                                                               
         GOTO1 CHECKD,DMCB,(LONE,AONE),PC1            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    SUB1                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
SUB1     GOTO1 CHECKD,DMCB,(LTWO,ATWO),PC2            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    SUB2                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
SUB2     SP    PC1(16),PC2(16)                                                  
         MVC   ANS(16),PC1                                                      
         MVI   LANS,16                                                          
         GOTO1 SIZE,DMCB,ANS       VALIDATE SIZE OF RESULT                      
         CLI   DMCB,0                                                           
         BE    ENDSUB                                                           
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                  NON ZERO CALC                                
SUB3     GOTO1 CHECKD,DMCB,(LTWO,ATWO),PC2            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    SUB4                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
SUB4     SP    0(16,R3),PC2(16)                                                 
         MVC   ANS(16),0(R3)                                                    
         MVI   LANS,16                                                          
         GOTO1 SIZE,DMCB,ANS       VALIDATE SIZE OF RESULT                      
         CLI   DMCB,0                                                           
         BE    ENDSUB                                                           
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
*                              HEXADECIMAL CALCLUATION                          
*                                                                               
HEXSUB   CLI   ZERO,0                                                           
         BNE   SUB9                                                             
*                                                                               
*                                  ZERO CALCULATION                             
*                                                                               
         GOTO1 CHECKHD,DMCB,(LONE,AONE),HEXDEC       CHECKING HEXA              
         CLI   DMCB,0                                DECIMAL                    
         BE    SUB5                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
SUB5     GOTO1 VHEXIN,DMCB,AONE,FWORD1,(R2) CONVERT TO BINARY                   
         CLC   DMCB+12(4),=F'0' INTO FWORD                                      
         BNE   W4                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
W4       L     RF,FWORD1           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R2                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD1                                                        
*                                                                               
SUB6     GOTO1 CHECKHD,DMCB,(LTWO,ATWO),HEXDEC         CHECKING HEXA            
         CLI   DMCB,0                                  DECIMAL                  
         BE    SUB7                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
SUB7     GOTO1 VHEXIN,DMCB,ATWO,FWORD2,(R4)        CONVERT TO BINARY            
         CLC   DMCB+12(4),=F'0'                    INTO FWORD                   
         BNE   W5                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
W5       L     RF,FWORD2           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R4                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD2                                                        
*                                                                               
SUB8     L     R6,FWORD1                                                        
         S     R6,FWORD2                                                        
         ST    R6,ANS                                                           
         MVI   LANS,4                                                           
         B     ENDSUB                                                           
*                                                                               
*                                  NON ZERO CALCULATION                         
*                                                                               
SUB9     GOTO1 CHECKHD,DMCB,(LTWO,ATWO),HEXDEC         CHECKING HEXA            
         CLI   DMCB,0                                  DECIMAL                  
         BE    SUB10                                                            
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
SUB10    GOTO1 VHEXIN,DMCB,ATWO,FWORD2,(R4)        CONVERT TO BINARY            
         CLC   DMCB+12(4),=F'0'                    INTO FWORD                   
         BNE   W6                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDSUB                                                           
*                                                                               
W6       L     RF,FWORD2           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R4                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD2                                                        
*                                                                               
SUB11    L     R6,0(R3)                                                         
         S     R6,FWORD2                                                        
         ST    R6,ANS                                                           
         MVI   LANS,4                                                           
*                                                                               
ENDSUB   CLI   ERR,X'FF'                                                        
         BE    SUB12                                                            
         MVI   DMCB,0                                                           
         B     SUB13                                                            
SUB12    MVI   DMCB,X'FF'                                                       
SUB13    XIT1                                                                   
*                                                                               
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  MUL                                                              *           
*                                                                   *           
*  FUNCTIONS 1 MULTIPLYING                                          *           
*  INPUT     P1    BYTE   0    L'OPERAND 1                          *           
*                         1-3  A(OPERAND 1)                         *           
*            P2           0    L'OPERAND 2                          *           
*                         1-3  A(OPERAND 2)                         *           
*  OUTPUT    1 ANS =ANSWER                                          *           
*            2 LANS=L'ANSWER                                        *           
*            3 PREC=PRECISION                                       *           
*            P1           0    0-VALID,X'FF'-INVALID                *           
*                                                                   *           
*********************************************************************           
***********************************************************                     
*                                                                               
MUL      NTR1                                                                   
*                                                                               
         ZIC   R2,DMCB                                                          
         STC   R2,LONE             R2=L'OP1                                     
         L     R3,DMCB                                                          
         LA    R3,0(R3)                                                         
         ST    R3,AONE             R3=A(OP1)                                    
*                                                                               
         ZIC   R4,DMCB+4                                                        
         STC   R4,LTWO             R4=L'OP2                                     
         L     R5,DMCB+4                                                        
         LA    R5,0(R5)                                                         
         ST    R5,ATWO             R5=A(OP2)                                    
*                                                                               
         CLI   TYPE,C'X'                                                        
         BE    HEXMUL              HEXADECEMAL CALCULATION                      
*                                                                               
*                                  DECIMAL CALCULATION                          
*                                                                               
         CLI   ZERO,0                                                           
         BNE   MUL3                                                             
*                                                                               
*                                  ZERO CALCULATION                             
*                                                                               
         GOTO1 CHECKD,DMCB,(LONE,AONE),PC1            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    MUL1                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
MUL1     GOTO1 CHECKD,DMCB,(LTWO,ATWO),PC2            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    MUL2                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
MUL2     MP    PC1(16),PC2+8(8)                                                 
*                                                                               
FOR1     DP    PC1(16),=PL4'10000'   NORMALISATION                              
         CP    PC1(12),=P'0'                                                    
         BE    ROU2                NO ROUNDING                                  
         BL    ROU1                                                             
         AP    PC1(12),=P'5'       ROUND POSITIVE                               
         B     ROU2                                                             
ROU1     SP    PC1(12),=P'5'       ROUND NEGATIVE                               
ROU2     DP    PC1(12),=PL2'10'    NORMALISATION                                
         XC    ANS,ANS                                                          
         MVC   ANS+6(10),PC1                                                    
         MVI   LANS,16                                                          
         GOTO1 SIZE,DMCB,ANS       VALIDATE SIZE OF RESULT                      
         CLI   DMCB,0                                                           
         BE    ENDMUL                                                           
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
MUL3     GOTO1 CHECKD,DMCB,(LTWO,ATWO),PC2            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    MUL4                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
MUL4     MVC   PC1(16),0(R3)                                                    
         MP    PC1(16),PC2+8(8)                                                 
*                                                                               
FOR2     DP    PC1(16),=PL4'10000'   NORMALISATION                              
         CP    PC1(12),=P'0'                                                    
         BE    ROU4                NO ROUNDING                                  
         BL    ROU3                                                             
         AP    PC1(12),=P'5'       ROUND POSITIVE                               
         B     ROU4                                                             
ROU3     SP    PC1(12),=P'5'       ROUND NEGATIVE                               
ROU4     DP    PC1(12),=PL2'10' NORMALISATION                                   
         XC    ANS,ANS                                                          
         MVC   ANS+6(10),PC1                                                    
         MVI   LANS,16                                                          
         GOTO1 SIZE,DMCB,ANS       VALIDATE SIZE OF RESULT                      
         CLI   DMCB,0                                                           
         BE    ENDMUL                                                           
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
*                              HEXADECIMAL CALCULATION                          
*                                                                               
HEXMUL   CLI   ZERO,0                                                           
         BNE   MUL9                                                             
*                                                                               
*                                  ZERO CALCULATION                             
*                                                                               
         GOTO1 CHECKHD,DMCB,(LONE,AONE),HEXDEC       CHECKING HEXA              
         CLI   DMCB,0                                DECIMAL                    
         BE    MUL5                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
MUL5     GOTO1 VHEXIN,DMCB,AONE,FWORD1,(R2) CONVERT TO BINARY                   
         CLC   DMCB+12(4),=F'0' INTO FWORD                                      
         BNE   W7                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
W7       L     RF,FWORD1           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R2                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD1                                                        
*                                                                               
MUL6     GOTO1 CHECKHD,DMCB,(LTWO,ATWO),HEXDEC         CHECKING HEXA            
         CLI   DMCB,0                                  DECIMAL                  
         BE    MUL7                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
MUL7     GOTO1 VHEXIN,DMCB,ATWO,FWORD2,(R4)        CONVERT TO BINARY            
         CLC   DMCB+12(4),=F'0'                    INTO FWORD                   
         BNE   W8                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
W8       L     RF,FWORD2           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R4                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD2                                                        
*                                                                               
MUL8     L     R7,FWORD1                                                        
         M     R6,FWORD2                                                        
         ST    R7,ANS                                                           
         MVI   LANS,4                                                           
         B     ENDMUL                                                           
*                                                                               
* NON ZERO CALCULATION                                                          
*                                                                               
MUL9     GOTO1 CHECKHD,DMCB,(LTWO,ATWO),HEXDEC         CHECKING HEXA            
         CLI   DMCB,0                                  DECIMAL                  
         BE    MUL10                                                            
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
MUL10    GOTO1 VHEXIN,DMCB,ATWO,FWORD2,(R4)        CONVERT TO BINARY            
         CLC   DMCB+12(4),=F'0'                    INTO FWORD                   
         BNE   W9                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDMUL                                                           
*                                                                               
W9       L     RF,FWORD2           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R4                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD2                                                        
*                                                                               
MUL11    L     R7,0(R3)                                                         
         M     R6,FWORD2                                                        
         ST    R7,ANS                                                           
         MVI   LANS,4                                                           
*                                                                               
ENDMUL   CLI   ERR,X'FF'                                                        
         BE    MUL12                                                            
         MVI   DMCB,0                                                           
         B     MUL13                                                            
MUL12    MVI   DMCB,X'FF'                                                       
MUL13    XIT1                                                                   
*                                                                               
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  DIV                                                              *           
*                                                                   *           
*  FUNCTIONS 1 DIVIDE TWO NUMBER                                    *           
*  INPUT     P1    BYTE   0    L'OPERAND 1                          *           
*                         1-3  A(OPERAND 1)                         *           
*            P2           0    L'OPERAND 2                          *           
*                         1-3  A(OPERAND 2)                         *           
*  OUTPUT    1 ANS =ANSWER                                          *           
*            2 LANS=L'ANSWER                                        *           
*            3 PREC=PRECISION                                       *           
*            P1           0    0-VALID,X'FF'-INVALID                *           
*                                                                   *           
*********************************************************************           
***********************************************************                     
*                                                                               
DIV      NTR1                                                                   
*                                                                               
         ZIC   R2,DMCB                                                          
         STC   R2,LONE             R2=L'OP1                                     
         L     R3,DMCB                                                          
         LA    R3,0(R3)                                                         
         ST    R3,AONE             R3=A(OP1)                                    
*                                                                               
         ZIC   R4,DMCB+4                                                        
         STC   R4,LTWO             R4=L'OP2                                     
         L     R5,DMCB+4                                                        
         LA    R5,0(R5)                                                         
         ST    R5,ATWO             R5=A(OP2)                                    
*                                                                               
         CLI   TYPE,C'X'                                                        
         BE    HEXDIV              HEXADECIMAL CALCULATION                      
*                                                                               
*                                  DECIMAL CALCULATION                          
*                                                                               
         CLI   ZERO,0                                                           
         BNE   DIV3                                                             
*                                                                               
*                                  ZERO CALCULATION                             
*                                                                               
         GOTO1 CHECKD,DMCB,(LONE,AONE),PC1            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    DIV1                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
DIV1     GOTO1 CHECKD,DMCB,(LTWO,ATWO),PC2            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    DIV2                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
DIV2     MP    PC1(16),=P'1000000'                                              
         CP    PC2+8(8),=P'0'                                                   
         BNE   DIV2A                                                            
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
DIV2A    DP    PC1(16),PC2+8(8)                                                 
         CP    PC1(8),=P'0'                                                     
         BE    ROG2                                                             
         BL    ROG1                                                             
         AP    PC1(8),=P'5'                                                     
         B     ROG2                                                             
ROG1     SP    PC1(8),=P'5'                                                     
ROG2     XC    ANS,ANS                                                          
         XC    RAB,RAB                                                          
         MVC   RAB+2(8),PC1                                                     
         DP    RAB(10),=PL2'10'                                                 
         MVC   ANS+8(8),RAB                                                     
         MVI   LANS,16                                                          
         B     ENDDIV                                                           
*                                                                               
DIV3     GOTO1 CHECKD,DMCB,(LTWO,ATWO),PC2            CHECKING,                 
         CLI   DMCB,0              PACKING,CORRECTION PRECISION                 
         BE    DIV4                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
DIV4     MVC   PC1(16),0(R3)                                                    
         CP    PC2+8(8),=P'0'                                                   
         BNE   DIV4A                                                            
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
DIV4A    MP    PC1(16),=P'1000000'                                              
         DP    PC1(16),PC2+8(8)                                                 
         CP    PC1(8),=P'0'                                                     
         BE    ROG4                                                             
         BL    ROG3                                                             
         AP    PC1(8),=P'5'                                                     
         B     ROG4                                                             
ROG3     SP    PC1(8),=P'5'                                                     
ROG4     XC    ANS,ANS                                                          
         XC    RAB,RAB                                                          
         MVC   RAB+2(8),PC1                                                     
         DP    RAB(10),=PL2'10'                                                 
         MVC   ANS+8(8),RAB                                                     
         MVI   LANS,16                                                          
         B     ENDDIV                                                           
*                                                                               
*                              HEXADECIMAL CALCLUATION                          
*                                                                               
HEXDIV   CLI   ZERO,0                                                           
         BNE   DIV9                                                             
*                                                                               
*                                  ZERO CALCULATION                             
*                                                                               
         GOTO1 CHECKHD,DMCB,(LONE,AONE),HEXDEC       CHECKING HEXA              
         CLI   DMCB,0                                DECIMAL                    
         BE    DIV5                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
DIV5     GOTO1 VHEXIN,DMCB,AONE,FWORD1,(R2) CONVERT TO BINARY                   
         CLC   DMCB+12(4),=F'0' INTO FWORD                                      
         BNE   Q7                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
Q7       L     RF,FWORD1           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R2                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD1                                                        
*                                                                               
DIV6     GOTO1 CHECKHD,DMCB,(LTWO,ATWO),HEXDEC         CHECKING HEXA            
         CLI   DMCB,0                                  DECIMAL                  
         BE    DIV7                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
DIV7     GOTO1 VHEXIN,DMCB,ATWO,FWORD2,(R4)        CONVERT TO BINARY            
         CLC   DMCB+12(4),=F'0'                    INTO FWORD                   
         BNE   Q8                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
Q8       L     RF,FWORD2           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R4                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD2                                                        
*                                                                               
DIV8     OC    FWORD2,FWORD2                                                    
         BNZ   XRA                                                              
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
XRA      L     R7,FWORD1                                                        
         C     R7,=F'0'                                                         
         BNL   XR1                                                              
         L     R6,FF4                                                           
         B     XR2                                                              
XR1      XR    R6,R6                                                            
XR2      D     R6,FWORD2                                                        
         ST    R7,ANS                                                           
         MVI   LANS,4                                                           
         B     ENDDIV                                                           
*                                                                               
* NON ZERO CALCULATION                                                          
*                                                                               
DIV9     GOTO1 CHECKHD,DMCB,(LTWO,ATWO),HEXDEC         CHECKING HEXA            
         CLI   DMCB,0                                  DECIMAL                  
         BE    DIV10                                                            
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
DIV10    GOTO1 VHEXIN,DMCB,ATWO,FWORD2,(R4)        CONVERT TO BINARY            
         CLC   DMCB+12(4),=F'0'                    INTO FWORD                   
         BNE   Q9                                                               
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
*                                                                               
Q9       L     RF,FWORD2           MOVE FWORD AFTER HEXIN                       
         LA    R1,8                                                             
         SR    R1,R4                                                            
         SLL   R1,2                                                             
         SRL   RF,0(R1)                                                         
         ST    RF,FWORD2                                                        
*                                                                               
DIV11    OC    FWORD2,FWORD2                                                    
         BNZ   XRB                                                              
         MVI   ERR,X'FF'                                                        
         B     ENDDIV                                                           
XRB      L     R7,0(R3)                                                         
         C     R7,=F'0'                                                         
         BNL   XR3                                                              
         L     R6,FF4                                                           
         B     XR4                                                              
XR3      XR    R6,R6                                                            
XR4      D     R6,FWORD2                                                        
         ST    R7,ANS                                                           
         MVI   LANS,4                                                           
*                                                                               
ENDDIV   XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  CONVERT                                                          *           
*                                                                   *           
*  FUNCTIONS 1 TRANSFORMATION ANSWER                                *           
*  INPUT      1      L'ANSWER-LANS                                  *           
*             2      ANSWER-ANS                                     *           
*             3      PRECISION-PREC                                 *           
*             4      TYPE TYPE                                      *           
*  OUTPUT     1      NEW L'ANSWER -LANS                             *           
*             2      NEW ANSWER-ANS                                 *           
*                                                                   *           
*********************************************************************           
CONVERT  NTR1                                                                   
*                                                                               
         CLI   TYPE,C'X'                                                        
         BE    CONH                HEXADECIMAL ANSWER                           
         CLI   TYPE,C'0'                                                        
         BE    CONS                STRING ANSWER                                
*                                                                               
*                              PACKED ANSWER                                    
*                                                                               
CONP     B     ENDCONV         REAL ANSWER=ANS/10!5                             
*                                                                               
*               TRANSFORMATION INTO STRING                                      
*                                                                               
CONS     L     RF,VCUREDIT                                                      
         MVI   WORK+3,5            MOVE PRECISION                               
         MVC   PC1(16),ANS                                                      
         CURED (P16,PC1),(20,ANS),WORK,ALIGN=LEFT,                     *        
               MODADDR=(RF),MINUS=YES,COMMAS=YES                                
*                                  R0=L'EDITED ANSWER-1                         
*                PERFORM PRECISION AND MINUS                                    
         LA    R3,ANS                                                           
         AR    R3,R0                                                            
         BCTR  R3,0                R3=A(END OF ANSWER)                          
         CLI   0(R3),C'-'                                                       
         BNE   CON7                POSITIVBE NUMBER                             
*                MOVE ANSWER IN FRONT                                           
         BCTR  R0,0                                                             
         LR    R7,R0                                                            
         EX    R7,*+8                                                           
         B     *+10                                                             
CON5     MVC   PC1+1(0),ANS                                                     
         MVI   PC1,C'-'                                                         
         EX    R7,*+8                                                           
         B     *+10                                                             
CON6     MVC   ANS(0),PC1                                                       
         A     R0,=F'1'                                                         
*           FORCE NON SIGNIFICANT ZEROS AFTER FULL-STOP                         
CON7     LA    R2,ANS                                                           
         AR    R2,R0                                                            
         BCTR  R2,0                R2=A(END OF NUMBER)                          
         LA    R3,5                                                             
         XR    R4,R4                                                            
*                                                                               
CON8     CLI   0(R2),C'0'                                                       
         BNE   CON9                                                             
         BCTR  R2,0                                                             
         LA    R4,1(R4)                                                         
         BCT   R3,CON8                                                          
*             INTEGER NUMBER                                                    
         S     R0,=F'6'                                                         
         STC   R0,LANS             REMOVE FULL-STOP                             
         LA    R5,5                                                             
         SR    R5,R4                                                            
         STC   R5,PREC                                                          
         B     ENDCONV                                                          
*                                                                               
CON9     SR    R0,R4               REDUCE LENGTH                                
         STC   R0,LANS             REMOVE FULL-STOP                             
         LA    R5,5                                                             
         SR    R5,R4                                                            
         STC   R5,PREC                                                          
         B     ENDCONV                                                          
*                                                                               
*                TRANSFORMATION INTO HEXADECIMAL                                
*                                                                               
CONH     MVC   PC1(4),ANS                                                       
         GOTO1 VHEXOUT,DMCB,PC1,ANS,4,=C'TOG'                                   
         L     R3,DMCB+16          R3=L'REAL ANSWER                             
         STC   R3,LANS                                                          
*                                                                               
ENDCONV  XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  PER                                                              *           
*                                                                   *           
*  FUNCTIONS 1 CALCULATION  PERCENTAGE                              *           
*  INPUT     P1    BYTE   0    L'OPERAND 1                          *           
*                         1-3  A(OPERAND 1)                         *           
*            P2           0    L'OPERAND 2                          *           
*                         1-3  A(OPERAND 2)                         *           
*            P3           1-3  A(DELIMITER)                         *           
*  OUTPUT    1 ANS =ANSWER                                          *           
*            2 LANS=L'ANSWER                                        *           
*            3 PREC=PRECISION                                       *           
*            P1           0    0-VALID,X'FF'-INVALID                *           
*                                                                   *           
*********************************************************************           
*                                                                               
PER      NTR1                                                                   
*                                                                               
*                                                                               
         ZIC   R2,DMCB                                                          
         STC   R2,LONE             R2=L'OP1                                     
         L     R3,DMCB                                                          
         LA    R3,0(R3)                                                         
         ST    R3,AONE             R3=A(OP1)                                    
*                                                                               
         ZIC   R4,DMCB+4                                                        
         STC   R4,LTWO             R4=L'OP2                                     
         L     R5,DMCB+4                                                        
         LA    R5,0(R5)                                                         
         ST    R5,ATWO             R5=A(OP2)                                    
*                                                                               
         L     R6,DMCB+8                                                        
         LA    R6,0(R6)            R6=A(DELIMITER)                              
*                                                                               
         MVC   IM(16),ANS                                                       
         MVC   PERO(1),ZERO                                                     
*                                                                               
*        THERE ARE THREE TYPES:                                                 
*        1 AXB%=AXB/100                                                         
*        2 A+B%=A+AXB/100                                                       
*        3 A-B%=A-AXB/100                                                       
****                                                                            
*                                                                               
*     CALCULATION   AXB/100                                                     
*                                                                               
         GOTO1 MUL,DMCB,(LONE,AONE),(LTWO,ATWO)                                 
         CLI   DMCB,0                                                           
         BE    PER1                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDPER                                                           
*                                                                               
PER1     MVI   ZERO,1            IT MEANS THAT FIRST OPERAND IS PACKED          
         GOTO1 DIV,DMCB,(LANS,ANS),(3,HUNDRED)                                  
         CLI   DMCB,0                                                           
         BE    PER2                                                             
         MVI   ERR,X'FF'                                                        
         B     ENDPER                                                           
*                                                                               
PER2     CLI   PERO,0                                                           
         BNE   SEC2                                                             
*                                                                               
         CLI   0(R6),C'+'                                                       
         BE    PER3                                                             
         CLI   0(R6),C'-'                                                       
         BE    PER4                                                             
         CLI   0(R6),C'X'                                                       
         BE    ENDPER                                                           
         CLI   0(R6),C'*'                                                       
         BE    ENDPER                                                           
         MVI   ERR,X'FF'           /-FORBIDDEN OPERATION                        
         B     ENDPER                                                           
*                                                                               
*                                  TYPE2                                        
*                                                                               
PER3     GOTO1 ADD,DMCB,(LANS,ANS),((R2),(R3))                                  
         CLI   DMCB,0                                                           
         BE    ENDPER                                                           
         MVI   ERR,X'FF'                                                        
         B     ENDPER                                                           
*              TYPE 3                                                           
*                                                                               
PER4     MP    ANS(16),=P'-1'                                                   
         GOTO1 ADD,DMCB,(LANS,ANS),((R2),(R3))                                  
         CLI   DMCB,0                                                           
         BE    ENDPER                                                           
         MVI   ERR,X'FF'                                                        
         B     ENDPER                                                           
*                                                                               
SEC2     CLI   0(R6),C'+'                                                       
         BE    SEC3                                                             
         CLI   0(R6),C'-'                                                       
         BE    SEC4                                                             
         CLI   0(R6),C'X'                                                       
         BE    ENDPER                                                           
         CLI   0(R6),C'*'                                                       
         BE    ENDPER                                                           
         MVI   ERR,X'FF'           /-FORBIDDEN OPERATION                        
         B     ENDPER                                                           
*                                                                               
SEC3     AP    ANS(16),IM                                                       
         MVI   LANS,16                                                          
         B     ENDPER                                                           
*                                                                               
SEC4     MP    ANS(16),=P'-1'                                                   
         AP    ANS(16),IM                                                       
         MVI   LANS,16                                                          
         B     ENDPER                                                           
*                                                                               
ENDPER   CLI   ERR,0                                                            
         BE    PER5                                                             
         MVI   DMCB,X'FF'                                                       
         B     PER6                                                             
PER5     MVI   DMCB,0                                                           
PER6     XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  CHECKD                                                           *           
*                                                                   *           
*  FUNCTIONS 1 CHECK DECIMAL VALUES                                 *           
*            2 RELESE NUMBER FROM FULL-STOP & COMMAS                *           
*            3 PACKING                                              *           
*            4 CORRECTION PRECISION,CHECKING LENGTH                 *           
*  INPUT     P1    BYTE   0    L'OPERAND                            *           
*                         1-3  A(OPERAND)                           *           
*            P2           1-3  A(PACKED ANSWER)   *                             
*  OUTPUT    P1           0    X'FF'-ERROR,0-VALID                  *           
*                         ANSWER IN PC1                             *           
*                                                                   *           
*********************************************************************           
*                                                                               
CHECKD   NTR1                                                                   
*                                                                               
         ZIC   R2,DMCB             R2=L'OPERAND                                 
         L     R3,DMCB                                                          
         LA    R3,0(R3)            R3=A(OPERAND)                                
         LA    R4,SET3             R4=A(SET OF POSSIBLE VALUES)                 
         XC    SIGN,SIGN                                                        
*                                                                               
         CLI   0(R3),C'-'                                                       
         BNE   CH1                                                              
         BE    SI                                                               
         CLI   0(R3),C'+'                                                       
         BNE   CH1                                                              
SI       MVC   SIGN(1),0(R3)                                                    
         BCTR  R2,0                NEW L                                        
         LA    R3,1(R3)            NEW A                                        
         ST    R3,DMCB                                                          
         STC   R2,DMCB                                                          
*                                                                               
*         CHECK DECIMAL VALUES                                                  
*                                                                               
CH1      CLC   0(1,R3),0(R4)       VALID ?                                      
         BE    CH2                 YES,VALID,CHECK NEXT SYMBOL                  
         LA    R4,1(R4)                                                         
         CLI   0(R4),X'FF'         END OF SET3 ?                                
         BNE   CH1                 NO                                           
         MVI   ERR,X'FF'           ERROR                                        
         B     ENDCHD                                                           
*                                                                               
CH2      LA    R3,1(R3)            CHECK                                        
         LA    R4,SET3             NEXT SYMBOL OF OPERAND                       
         BCT   R2,CH1                                                           
*                                                                               
*              CORRECT PRECISION                                                
*                                                                               
         ZIC   R2,DMCB             R2=L'OPERAND                                 
         L     R3,DMCB                                                          
         LA    R3,0(R3)            R3=A(OPERAND)                                
*                                                                               
         AR    R2,R3                                                            
         BCTR  R2,0                R2=A(END OF OPERAND)                         
         XR    R4,R4                                                            
CH3      CLI   0(R2),C'.'          DEC-POINT ?                                  
         BE    CH4                 YES                                          
         LA    R4,1(R4)            R4=PRECISION                                 
         BCTR  R2,0                                                             
         CR    R2,R3                                                            
         BNL   CH3                                                              
         XR    R4,R4               NO DEC-POINT IN OPERAND                      
*                                                                               
CH4      STC   R4,PRECT            R4=PRECISION OF CURRENT OPERAND              
         ZIC   R5,PREC             R5=OLD PRECISION                             
         CR    R4,R5               IS CORRECTION NEEDED                         
         BH    CH5                 YES                                          
         B     CH7                 NOT NEEDED                                   
*                                                                               
CH5      EQU   *                                                                
*&&US*&& C     R4,=F'15'           NOT MORE THAN 15                             
*&&UK*&& C     R4,=F'5'            NOT MORE THAN 5                              
         BNH   CH6                                                              
         MVI   ERR,X'FF'           ERROR                                        
         B     ENDCHD                                                           
CH6      STC   R4,PREC             PREC=NEW VALUE                               
*                                                                               
*        REMOVE FUL-STOP & COMMAS,CHECK LENGTH NGT 15                           
*                                                                               
CH7      ZIC   R2,DMCB             R2=L'OPERAND                                 
         L     R3,DMCB                                                          
         LA    R3,0(R3)            R3=A(OPERAND)                                
         LA    R4,RAB                                                           
         XR    R5,R5                                                            
*                                                                               
CH8      CLI   0(R3),C'.'          DEC-POINT ?                                  
         BE    REM                 REMOVE                                       
         CLI   0(R3),C','          COMMA ?                                      
         BE    REM                 REMOVE                                       
         MVC   0(1,R4),0(R3)       MOVE SYMBOL                                  
         LA    R3,1(R3)                                                         
         LA    R4,1(R4)                                                         
         LA    R5,1(R5)            R5=L'OPERAND WITHOUT DEC-POINT AND           
         BCT   R2,CH8                                     COMMAS                
         B     CH9                                                              
*                                                                               
REM      LA    R3,1(R3)                                                         
         BCT   R2,CH8                                                           
*             REMOVING IS COMPLITED R5=L'OPERAND                                
CH9      EQU   *                                                                
*&&UK*&& C     R5,=F'5'                                                         
*&&US*&& C     R5,=F'15'                                                        
         BNH   CH10                CORRECT                                      
         MVI   ERR,X'FF'           ERROR LENGTH                                 
         B     ENDCHD                                                           
*                                                                               
*        PACKING  RAB =OPERAND EBCIDIC R5=L AND MULTIPLYING BY 10!5             
*                                                                               
CH10     BCTR  R5,0                R5=L=1                                       
         STC   R5,F2+1             MOVE L2 INTO PACK                            
         OI    F2+1,X'70'          MOVE L1 INTO PACK                            
F2       PACK  DUB,RAB             DUB=PACKED NUMBER                            
         XC    DUBL,DUBL                                                        
         MVC   DUBL+8(8),DUB                                                    
*                                   WHAT IS SIGN ?                              
         CLI   SIGN,C'-'                                                        
         BNE   LONO                POSITIV NUMBER                               
         MP    DUBL(16),=P'-1'                                                  
*                                                                               
*                                                                               
LONO     LA    R6,5                                                             
         IC    R5,PRECT            R5=PRECISION OF OPERAND                      
         SR    R6,R5                                                            
         C     R6,=F'0'                                                         
         BE    PR5                 PRECISION=5,NO MULTIPLYING                   
*                                                                               
CH11     MP    DUBL(16),=P'10'     MULTIPLY BY 10!5                             
         BCT   R6,CH11                                                          
*                                  MOVE PACKED ANSWER                           
PR5      L     R3,DMCB+4                                                        
         LA    R3,0(R3)                                                         
         XC    0(16,R3),0(R3)                                                   
         MVC   8(8,R3),DUBL+8                                                   
*                                                                               
ENDCHD   CLI   ERR,X'FF'                                                        
         BNE   CH12                                                             
         MVI   DMCB,X'FF'          ERROR                                        
         B     CH13                                                             
CH12     MVI   DMCB,0              VALID                                        
CH13     XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  CHECKHD                                                         *            
*                                                                   *           
*  FUNCTIONS 1 CHECKING HEXA DECIMAL,CHECKING LENGTH NOT MORE 8     *           
*  INPUT     P1  BYTE O     L'OPERAND                               *           
*                     1-3   A(OPERAND)                              *           
*            P2       1-3   A(SET OF HEXA DECIMAL CHARACTERS)       *           
*  OUTPUT    P1       0     X'00'-CORRECT,X'FF'-INVALID             *           
*                                                                   *           
*********************************************************************           
*                                                                               
CHECKHD  NTR1                                                                   
*                                                                               
         ZIC   R2,DMCB             R2=L'OPERAND                                 
         C     R2,=F'8'                                                         
         BH    BADCH               INVALID LENGTH                               
         L     R3,DMCB             R3=A(OPERAND)                                
         LA    R3,0(R3)                                                         
         L     R4,DMCB+4                                                        
         LA    R4,0(R4)            R4=A(H-D SET)                                
*                                                                               
CHD1     CLC   0(1,R3),0(R4)                                                    
         BE    CHD2                GOOD SYMBOL                                  
         LA    R4,1(R4)                                                         
         CLI   0(R4),X'FF'         END OF SET?                                  
         BE    BADCH               INVALID                                      
         B     CHD1                                                             
*                                                                               
CHD2     LA    R3,1(R3)                                                         
         L     R4,DMCB+4                                                        
         LA    R4,0(R4)                                                         
         BCT   R2,CHD1                                                          
*                                                                               
         MVI   DMCB,0                                                           
         B     ENDCHHD                                                          
*                                                                               
BADCH    MVI   DMCB,X'FF'                                                       
ENDCHHD  XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  COMPRESS                                                         *           
*                                                                   *           
*  FUNCTIONS 1   REMOVE SPACES  FROM FORMULA                        *           
*  INPUT     P1  BYTE  1-3   A(FORMULA START)                       *           
*            P2        1-3   A(FOMULA END)                          *           
*  OUTPUT    P1        0     X'00'-VALID   X'FF'-INVALID            *           
*                      1-3   A(FORMULA START) NEW                   *           
*            P2        1-3   A(FORMULA END) NEW                     *           
*                                                                   *           
*********************************************************************           
*                                                                               
COMPRESS NTR1                                                                   
*                                                                               
         L     R2,DMCB                                                          
         LA    R2,0(R2)            R2=A(START)                                  
         L     R3,DMCB+4                                                        
         LA    R3,1(R3)            R7=A(END)+1                                  
         LA    R4,LINE                                                          
         XR    R5,R5                                                            
*                       CALCULATION NEW A(START)                                
COMP1    CLI   0(R2),X'40'                                                      
         BH    COMP2               FIRST SYMBOL                                 
         LA    R2,1(R2)                                                         
         CR    R2,R3                                                            
         BNE   COMP1                                                            
*                                                                               
         MVI   DMCB,X'FF'                                                       
         B     ENDSS                                                            
*                            COMPRESSING                                        
COMP2    ST    R4,DMCB             STORE NEW START ADDRESS                      
COMP3    CLI   0(R2),X'40'                                                      
         BH    COMP4               MOVE SYMBOL                                  
         LA    R2,1(R2)                                                         
         CR    R2,R3                                                            
         BNE   COMP3                                                            
         B     COMP5                                                            
*                      MOVE SYMBOL                                              
COMP4    MVC   0(1,R4),0(R2)                                                    
         LA    R2,1(R2)                                                         
         LA    R4,1(R4)                                                         
         LA    R5,1(R5)                                                         
         CR    R2,R3                                                            
         BNE   COMP3                                                            
*                                  COMPRESSING  COMPLETED                       
COMP5    L     R6,DMCB                                                          
         AR    R6,R5                                                            
         BCTR  R6,0                                                             
         ST    R6,DMCB+4                                                        
*                                                                               
ENDSS    CLI   ERR,0                                                            
         BE    COMP6                                                            
         MVI   DMCB,X'FF'                                                       
         BE    COMP7                                                            
COMP6    MVI   DMCB,0                                                           
COMP7    XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*                                                                   *           
*  SIZE                                                             *           
*                                                                   *           
*  FUNCTIONS 1   VALIDATE RESULT  AFTER +-X/*                       *           
*  INPUT     P1  BYTE  1-3   A(ANSWER)                              *           
*  OUTPUT    P1        0     X'00'-VALID   X'FF'-INVALID            *           
*                                                                   *           
*********************************************************************           
SIZE     NTR1                                                                   
*                                                                               
         L     R2,DMCB                                                          
         LA    R2,0(R2)            R2=A(ANSWER)                                 
*                                                                               
         CP    0(16,R2),=P'999999999999999'                                     
         BH    SZ                                                               
         CP    0(16,R2),=P'-999999999999999'                                    
         BL    SZ                                                               
         MVI   DMCB,0                                                           
         B     ENDSIZE                                                          
*                                                                               
SZ       MVI   DMCB,X'FF'                                                       
ENDSIZE  XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
TABL     DS    0D                                                               
         DC    C'+   ',A(ADD)                                                   
         DC    C'-   ',A(SUB)                                                   
         DC    C'*   ',A(MUL)                                                   
         DC    C'X   ',A(MUL)                                                   
         DC    C'/   ',A(DIV)                                                   
         DC    C'%   ',A(PER)                                                   
         DC    X'FF'                                                            
SETOPER  DC    C'0123456789ABCDEF.,' POSSIBLE OPERAND SYMBOLS                   
         DC    X'FF'                                                            
HEXDEC   DC    C'0123456789ABCDEF'   POSSIBLE HEX-DEC OPERAND SYMBOLS           
         DC    X'FF'                                                            
SET1     DC    C'+-*X/' DELIMITERS TYPE 1                                       
         DC    X'FF'                                                            
SET2     DC    C'%' DELIMITER TYPE 2                                            
         DC    X'FF'                                                            
SET3     DC    C'0123456789.,' POSSIBLE DECIMAL VALUES                          
         DC    X'FF'                                                            
         DS    F                                                                
FF4      DC    4X'FF'                                                           
HUNDRED  DC    C'100'                                                           
         EJECT                                                                  
DATD     DSECT                                                                  
ASTART   DS    A                                                                
AOP1     DS    A                                                                
DMCB     DS    6F                                                               
PAR      DS    6F                                                               
ADEL1    DS    A                                                                
ADEL2    DS    A                                                                
APARAM   DS    A                                                                
AOP2     DS    A                                                                
RELO     DS    A                                                                
AENDFOR  DS    A                                                                
AONE     DS    A                                                                
ATWO     DS    A                                                                
ANEXT    DS    A                                                                
FWORD1   DS    F                                                                
FWORD2   DS    F                                                                
ACOMFACS DS    V                                                                
VCUREDIT DS    V                                                                
VHEXIN   DS    V                                                                
VHEXOUT  DS    V                                                                
ANS      DS    4D                                                               
PC1      DS    2D                                                               
PC2      DS    2D                                                               
IM       DS    CL16                                                             
DUB      DS    D                                                                
DUBL     DS    2D                                                               
WORK     DS    D                                                                
*                                                                               
LOP1     DS    CL1                                                              
LOP2     DS    CL1                                                              
LNEXT    DS    CL1                                                              
ZERO     DS    CL1                                                              
PERO     DS    CL1                                                              
TYPE     DS    CL1                                                              
PREC     DS    CL1                                                              
PRECT    DS    CL1                                                              
ERR      DS    CL1                                                              
LONE     DS    CL1                                                              
LTWO     DS    CL1                                                              
LANS     DS    CL1                                                              
LSTR     DS    CL1                                                              
RAB      DS    CL10                                                             
SIGN     DS    CL1                                                              
LINE     DS    CL60                                                             
STRING   DS    CL60                                                             
SUP      DS    CL20                                                             
DATX     DS    0C                                                               
*                                                                               
         EJECT                                                                  
*DDCOMFACS                                                                      
       ++INCLUDE DDCOMFACS                                                      
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'006DDFORMULA 05/01/02'                                      
         END                                                                    
