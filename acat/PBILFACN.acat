*          DATA SET PBILFACN   AT LEVEL 036 AS OF 05/01/02                      
*CATALP PBILFACN                                                                
         TITLE 'ADBIL - ADD BILLING RECORDS'                                    
         PRINT NOGEN                                                            
ADBIL    CSECT                                                                  
         NMOD1 0,**ADBL                                                         
         USING PPWORKD,RA                                                       
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         USING PBILWRKD,R8                                                      
         SPACE 2                                                                
*                                  SET BILL REC                                 
         XC    PBILLREC(103),PBILLREC                                           
         MVC   PBILLKEY(7),RCSVAGY                                              
         MVI   PBILKRCD,8                                                       
         MVC   PBILKBMN,BTODAY                                                  
         MVC   PBILLLEN,=H'103'                                                 
         MVC   PBILLEL(2),=X'0846'                                              
         MVC   PBILLDAT,ETODAY                                                  
         MVI   PBILLCAN,C'0'                                                    
         MVC   PBILLCAN+1(11),PBILLCAN                                          
         MVI   PBILLTYP,C'4'       DET                                          
         CLC   QPROG,=C'06'                                                     
         BE    ADB1                                                             
         MVI   PBILLTYP,C'3'       SUMMARY                                      
         OC    MANGRS(8),MANGRS                                                 
         BZ    *+8                                                              
         MVI   PBILLTYP,C'1'                                                    
ADB1     DS    0H                                                               
         GOTO1 DTCNV,DMCB,QINVDATE,(1,PBILINVD)                                 
*                                                                               
         CLC   QDUEDAYS,=C'00'     NO DUE DATE                                  
         BE    ADB1B                                                            
         PACK  DUB,QDUEDAYS                                                     
         CVB   R0,DUB                                                           
         GOTO1 ADDAY,(R1),,WORK,(R0)                                            
*                                                                               
         GOTO1 DTCNV,(R1),WORK,(1,PBILDUED)                                     
*                                                                               
ADB1B    DS    0H                                                               
         CLI   ESTSW,C'S'                                                       
         BNE   ADB2                                                             
         PACK  DUB,QEST                                                         
         CVB   R0,DUB                                                           
         STH   R0,FULL                                                          
         PACK  DUB,QESTEND                                                      
         CVB   R0,DUB                                                           
         STH   R0,FULL+2                                                        
         MVC   PBILESTS(4),FULL                                                 
*                                                                               
ADB2     DS    0H                                                               
         MVI   PREVSW,0            SET NO PREVIOUS BILLING                      
         L     R2,BSTAB            TABLE                                        
         USING POSTKEYD,R2                                                      
         CLI   NXTYM,0                                                          
         BNE   ADB2B                                                            
         MVC   NXTYM,POSTKYM                                                    
         L     RF,BSNUM                                                         
         M     RE,BSLEN                                                         
         AR    RF,R2                                                            
         XC    0(7,RF),0(RF)       SET END OF TABLE                             
         MVC   3(2,RF),=2X'FF'     SET END OF TABLE                             
ADB2B    DS    0H                                                               
         MVC   THISYM,NXTYM                                                     
ADB3     DS    0H                                                               
         MVI   BYTE,C'3'                                                        
         BAS   RE,ADBTRC                                                        
*                                                                               
         CLI   POSTKPRD,0                                                       
         BE    ADBX                                                             
         CLI   PRIORSW,C'S'                                                     
         BNE   ADB4                                                             
         CLC   NXTYM,POSTKYM                                                    
         BL    ADB60                                                            
         BH    ADB40                                                            
ADB4     DS    0H                                                               
         CLI   POSTKYM,X'FF'                                                    
         BE    ADB40                                                            
         CLI   POSTKPRD,X'FF'                                                   
         BE    ADB40                                                            
         MVC   PBILKMOS,POSTKYM                                                 
         MVC   PBILKPRD,POSTKPRD                                                
         MVC   PBILKEST,POSTKEST                                                
         CLC   POSTKEST,=X'FFFF'   PROD TOT                                     
         BNE   ADB6                                                             
         XC    PBILKEST,PBILKEST                                                
         CLI   ADBSW,0                                                          
         BNE   ADB7                ADD PROD BILL IF ANY EST BILLS               
         B     ADB40                                                            
*                                                                               
ADB6     DS    0H                                                               
         MVI   BYTE,C'6'                                                        
         BAS   RE,ADBTRC                                                        
*                                                                               
         OC    POSTBL,POSTBL                                                    
         BZ    *+8                                                              
         OI    PREVSW,X'80'        SET HAVE PREV BILLING                        
         CLC   POSTBL,POSTBY       NOTHING TO BILL                              
         BNE   ADB7                                                             
         CLC   QPROG,=C'04'                                                     
         BE    ADB40               - NEXT ELEM                                  
ADB7     DS    0H                                                               
         GOTO1 AGETFORM,DMCB,(R2)                                               
*                                                                               
         L     R3,DMCB+4           A(HDR) RETURNED                              
         USING HDRKEYD,R3                                                       
         MVC   PBILCMSW,BILCMSW    SET COMMISSION ONLY SWITCH                   
         MVC   PBILBASA(5),BFORM                                                
         MVC   WORK(24),POSTBY                                                  
         LM    R5,R7,WORK                                                       
         S     R5,WORK+12                                                       
         S     R6,WORK+16                                                       
         S     R7,WORK+20                                                       
         CVD   R5,DUB                                                           
         ZAP   PBILLGRS,DUB        GROSS                                        
         SR    R5,R7                                                            
         CVD   R5,DUB                                                           
         ZAP   PBILLBIL,DUB        GROSS - CD                                   
         SR    R5,R6                                                            
         CVD   R5,DUB                                                           
         ZAP   PBILLNET,DUB        GROSS - CD - AC                              
         MVI   PBILLMOD,C'E'                                                    
         CLI   ESTSW,C'E'                                                       
         BNH   ADB8                                                             
         MVI   PBILLMOD,C' '                                                    
         CLC   POSTKEST,=X'FFFF'                                                
         BE    ADB8                                                             
         MVI   PBILLMOD,C'S'                                                    
         CLI   ESTSW,C'S'                                                       
         BE    ADB8                                                             
         MVI   PBILLMOD,C'P'                                                    
*                                                                               
ADB8     DS    0H                                                               
         MVC   PBILKBNO,INVNO                                                   
         CLC   POSTKYM,BSTART      TEST CURR MON                                
         BE    ADB9                                                             
         MVI   BHIDAYS+1,28                                                     
         TM    POSTKYM,X'03'                                                    
         BNZ   *+8                                                              
         MVI   BHIDAYS+1,29        LEAP YR                                      
         SR    RF,RF                                                            
         IC    RF,POSTKYM+1                                                     
         LA    RF,BHIDAYS-1(RF)                                                 
         MVC   PBILLEND(1),0(RF)                                                
         MVI   PBILLSTA,1                                                       
         MVI   PBILLPER,C'M'                                                    
         B     ADB10                                                            
*                                                                               
ADB9     DS    0H                                                               
         MVC   PBILLSTA,BSTART+2                                                
         MVC   PBILLEND,BEND+2                                                  
         MVC   PBILLPER,PERSW                                                   
ADB10    DS    0H                                                               
         MVC   PBILCDSW,CDSEPSW    SET CD HANDLING SW                           
         MVI   PBILSEP,C'R'       REGULAR BILL                                  
         CLI   RCWRITE,C'Y'                                                     
         BNE   ADB13                                                            
         ZAP   PBILLRCV,RCVBL1                                                  
         MVC   X+25(32),KEY                                                     
         GOTO1 ADD,DMCB,PBILLREC                                                
*                                                                               
         OC    SAVEDA,SAVEDA                                                    
         BNZ   *+10                                                             
         MVC   SAVEDA,KEY          SAVE DA OF FIRST BILL ADDED                  
*                                                                               
*                                                                               
         GOTO1 APBINTAP                                                         
         ZAP   PBILLBIL,=P'0'                                                   
         ZAP   PBILLGRS,=P'0'                                                   
         ZAP   PBILLNET,=P'0'                                                   
*                                                                               
         CLI   CDSEPSW,C'S'                                                     
         BNE   ADB12                                                            
         MVC   HALF,PBILKBNO                                                    
         LH    R4,HALF                                                          
         LA    R4,1(R4)                                                         
         STH   R4,HALF                                                          
         MVC   PBILKBNO,HALF       USE INV NO. EVEN IF NO CD BILL               
         ZAP   PBILLRCV,RCVBL2                                                  
         BZ    ADB12                                                            
         MVI   PBILSEP,C'C'        SEP CD INV                                   
         GOTO1 ADD,DMCB,PBILLREC                                                
*                                                                               
         GOTO1 APBINTAP                                                         
ADB12    DS    0H                                                               
         CP    RCVBL3,=P'0'                                                     
         BE    ADB13                                                            
         MVC   HALF,PBILKBNO                                                    
         LH    R4,HALF                                                          
         LA    R4,1(R4)                                                         
         STH   R4,HALF                                                          
         MVC   PBILKBNO,HALF                                                    
         ZAP   PBILLRCV,RCVBL3                                                  
         MVI   PBILSEP,C'A'       SEP ADJ INVOICE                               
         GOTO1 ADD,DMCB,PBILLREC                                                
         GOTO1 APBINTAP                                                         
ADB13    DS    0H                                                               
         MVI   ADBSW,C'A'                                                       
         MVI   RACTSW,C'A'                                                      
*                                                                               
ADB40    DS    0H                                                               
         A     R2,BSLEN            NEXT ENTRY                                   
         B     ADB3                                                             
*                                                                               
ADB60    DS    0H                                                               
*                                                                               
ADBX     DS    0H                                                               
         CLI   ADBSW,0                                                          
         BNE   *+10                                                             
         MVC   NXTYM,POSTKYM                                                    
         XIT1                                                                   
         SPACE 2                                                                
ADBTRC   DS    0H                                                               
         CLI   RCTRACE,C'Y'                                                     
         BNER  RE                                                               
*                                                                               
ADBTR2   NTR1                                                                   
         MVC   P(14),=C'**TAB TRC N **'                                         
         MVC   P+10(1),BYTE                                                     
         MVC   P+16(3),POSTKPRD                                                 
         GOTO1 HEXOUT,DMCB,POSTKYM,WORK,4,=C'N'                                 
         MVC   P+20(4),WORK                                                     
         MVC   P+25(4),WORK+4                                                   
*                                                                               
         CLC   POSTBY,POSTBL                                                    
         BE    *+8                                                              
         MVI   P+45,C'*'                                                        
*                                                                               
         MVC   P+30(4),=C'NYM='                                                 
         GOTO1 HEXOUT,DMCB,NXTYM,P+34,2,=C'N'                                   
*                                                                               
         LA    R3,POSTBY                                                        
         LA    R4,6                                                             
         LA    R5,P+47                                                          
*                                                                               
ADBTR4   DS    0H                                                               
         EDIT  (B4,0(R3)),(10,0(R5)),2,MINUS=YES                                
*                                                                               
         LA    R3,4(R3)                                                         
         LA    R5,11(R5)                                                        
         BCT   R4,ADBTR4                                                        
*                                                                               
         GOTO1 APRNT                                                            
*                                                                               
ADBTRX   DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
BHIDAYS  DC    AL1(31,28,31,30,31,30,31,31,30,31,30,31)                         
         SPACE 3                                                                
         DROP  R2,R3                                                            
         LTORG                                                                  
         TITLE 'BLDREV - BUILD LIST OF REVERSALS'                               
BLDREV   CSECT                                                                  
         NMOD1 0,BLDREV                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         USING PBILWRKD,R8                                                      
         SPACE 2                                                                
         XC    REVNUM,REVNUM       RESET TABLE                                  
         CLC   QREGION,SPACES                                                   
         BE    BR1                                                              
         CLC   QREGION,=C'ALL'                                                  
         BNE   BLDREVX                                                          
BR1      DS    0H                                                               
         CLC   QDIST,SPACES                                                     
         BE    BR1B                                                             
         CLC   QDIST,=C'ALL'                                                    
         BNE   BLDREVX                                                          
BR1B     DS    0H                                                               
         CLC   QREGION(6),SPACES                                                
         BE    BR2                                                              
         LA    RF,MASTHDR                                                       
         USING HDRKEYD,RF                                                       
         CLI   BILRDSW,C'S'        NO REVERSE IF SEP REG & DST                  
         BE    BLDREVX                                                          
         DROP  RF                                                               
*                                                                               
BR2      DS    0H                                                               
         MVC   SAVKEY,KEY                                                       
         XC    KEY,KEY                                                          
         MVC   KEY(7),RCSVAGY      AMC                                          
         MVI   KEY+3,8                                                          
         CLI   PRDSW,C'T'                                                       
         BNL   *+10                                                             
         MVC   KEY+7(3),PPRDKPRD                                                
         CLI   ESTSW,C'E'                                                       
         BH    BR2B                                                             
         MVC   KEY+10(2),PESTKEST                                               
         BL    BR2B                                                             
*                        IF ONE EST AND PRD=NO SOMETIMES                        
*                        THE EST HEADER IS CLEARED                              
*                        THIS IS A TEMPERARY FIX TO THIIS BUG                   
         PACK  DUB,QEST                                                         
         CVB   R0,DUB                                                           
         STH   R0,HALF                                                          
         MVC   KEY+10(2),HALF                                                   
         MVC   PESTKEST,HALF                                                    
BR2B     DS    0H                                                               
         CLC   QPROG,=C'06'                                                     
         BNE   *+10                                                             
         MVC   KEY+12(2),THISYM                                                 
         GOTO1 HIGH                                                             
*                                                                               
         B     BR3A                                                             
BR3      DS    0H                                                               
         GOTO1 SEQ                                                              
BR3A     DS    0H                                                               
         TM    KEY+25,X'80'                                                     
         BNZ   BR3                 BYPASS DELETES                               
         CLC   KEY(7),KEYSAVE      AMC                                          
         BNE   BR40                                                             
         CLI   KEYSAVE+7,0                                                      
         BE    *+14                                                             
         CLC   KEY+7(3),KEYSAVE+7                                               
         BNE   BR40                                                             
         OC    KEYSAVE+10(2),KEYSAVE+10                                         
         BZ    *+14                                                             
         CLC   KEY+10(2),KEYSAVE+10                                             
         BNE   BR3                                                              
         OC    KEYSAVE+12(2),KEYSAVE+12                                         
         BZ    *+14                                                             
         CLC   KEY+12(2),KEYSAVE+12                                             
         BNE   BR3                                                              
*                                                                               
         CLC   KEY+12(2),BSTART                                                 
         BH    BR3                                                              
         BE    BR3C                                                             
         CLI   PRIORSW,C'N'                                                     
         BE    BR3                                                              
         CLI   PRIORSW,C'S'                                                     
         BE    BR3C                                                             
*                                  IF PRIOR TOGETHER AND QSTART                 
*                                  NOT BEFORE BILL FORM EFF DATE                
*                                  AND BILL MOS BEFORE BILL FORM EFF            
*                                  DATE - SKIP BILL                             
         LA    R3,MASTHDR                                                       
         USING HDRKEYD,R3                                                       
         CLC   BSTART,BILADAT                                                   
         BL    BR3C                                                             
         CLC   KEY+12(2),BILADAT                                                
         BL    BR3                                                              
BR3C     DS    0H                                                               
         OC    KEY+10(2),KEY+10    EST = 0 - BYPASS                             
         BZ    BR3                                                              
         BAS   RE,FLTREST                                                       
         BNE   BR3                                                              
*                                                                               
BR4      DS    0H                                                               
*                                  CHECK PRODUCT IN RIGHT DIVISION              
         CLI   QDIV,C' '                                                        
         BE    BR4A8                                                            
         CLC   QDIV,=C'ALL'                                                     
         BE    BR4A8                                                            
         CLC   KEY+7(3),PPRDKPRD                                                
         BE    BR4A4                                                            
         MVC   WORK(64),KEY                                                     
         XC    KEY,KEY                                                          
         MVC   KEY(10),WORK                                                     
         MVI   KEY+3,6                                                          
         GOTO1 READ                                                             
*                                                                               
         GOTO1 GET,DMCB,PPRDREC                                                 
*                                                                               
         MVC   KEY,WORK                                                         
         GOTO1 HIGH                                                             
*                                                                               
         MVC   KEYSAVE,WORK+32                                                  
BR4A4    DS    0H                                                               
         CLC   PPRDDIV,QDIV                                                     
         BNE   BR3                                                              
BR4A8    DS    0H                                                               
         XC    LASTDA,LASTDA       RESET LAST IO                                
         GOTO1 GET,DMCB,PBILLREC                                                
*                                                                               
         CLI   QOPT1,C'I'          IGNORE BILL OPTION (FOR TESTING)             
         BNE   *+14                                                             
         CLC   PBILLDAT,QINVDATE                                                
         BE    BR3                                                              
*                                                                               
         CLI   REVSW,0                                                          
         BE    BR4C                                                             
         CLC   QPROG,=C'04'                                                     
         BE    BR4B                                                             
         CLI   PBILLTYP,C'4'       DETAIL BILL                                  
         BE    BR3                                                              
         CLI   PBILLCDT,C'0'       ALREADY REVSD                                
         BNE   BR3                                                              
BR4B     DS    0H                                                               
         CLI   PBILSEP,C'A'        BYPASS ADJ BILLS                             
         BE    BR3                                                              
         CLI   PBILSEP,C'C'        BYPASS CD BILLS                              
         BE    BR3                                                              
*                                                                               
BR4C     DS    0H                                                               
         CLC   PBILKMOS,BSTART       TEST DOING CURRENT MONTH                   
         BNE   BR5                 NO                                           
*                                                                               
         CLI   PERSW,C'M'          TEST SPECIAL PERIOD                          
         BE    BR5                                                              
*                                  TEST WITHIN START & END                      
         CLC   PBILLSTA,BSTART+2                                                
         BL    BR3                                                              
         CLC   PBILLEND,BEND+2                                                  
         BH    BR3                                                              
*                                  REVERSE BILL                                 
BR5      DS    0H                                                               
         CLC   QPROG,=C'06'                                                     
         BNE   BR6                                                              
         MVI   ADBSW,1                                                          
         MVC   PBILLCDT,ETODAY                                                  
         LH    R0,INVNO                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PBILLCAN,DUB                                                     
         MVC   PBILLCAN(2),ETODAY+2                                             
         CLI   RCWRITE,C'Y'                                                     
         BNE   BR6                                                              
         GOTO1 PUT,DMCB,PBILLREC                                                
*                                  PUT IN LIST                                  
BR6      DS    0H                                                               
         CLI   REVSW,C'R'                                                       
         BNE   BR9                                                              
         XC    REVREC,REVREC                                                    
         MVC   REVPRD,PBILKPRD                                                  
         MVC   REVMOS,PBILKMOS                                                  
         MVC   X(12),INVNO         SAVE INVNO + PINVNO                          
         MVC   HALF,PBILKBNO                                                    
         LH    RF,HALF                                                          
         BCTR  RF,R0                                                            
         STH   RF,INVNO                                                         
         OI    INVNO,X'80'         GETNUM NOT TO READ FOR INVNO                 
         GOTO1 AGETNUM             USE GETNUM TO FORMATE INVNO                  
*                                                                               
         MVC   REVINUM,PINVNO                                                   
         MVC   INVNO(12),X         RESTORE                                      
         ZAP   DUB,PBILLGRS                                                     
         CVB   R0,DUB                                                           
         ST    R0,X                GRS                                          
         SP    DUB,PBILLBIL                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+8              CD                                           
         ZAP   DUB,PBILLBIL                                                     
         SP    DUB,PBILLNET                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+4              AF                                           
         MVC   REVGRS(12),X                                                     
*                                                                               
         LA    R1,REVREC                                                        
         ST    R1,REVPARS                                                       
         MVI   REVPARS,1           SET TO ADD                                   
         GOTO1 ABINSRCH,REVPARS                                                 
*                                                                               
         CLI   REVPARS,1                                                        
         BNE   BR8                 ALREADY THERE                                
         OC    REVPARS+1(3),REVPARS+1                                           
         BNZ   BR9                                                              
         DC    H'0'                                                             
*                                                                               
BR8      DS    0H                                                               
         L     RF,REVPARS                                                       
         MVC   X(12),REVGRS-REVREC(RF)                                          
         MVC   X+12(12),REVGRS                                                  
         LM    R5,R7,X                                                          
         A     R5,X+12                                                          
         A     R6,X+16                                                          
         A     R7,X+20                                                          
         STM   R5,R7,X                                                          
         MVC   REVGRS-REVREC(12,RF),X                                           
BR9      DS    0H                                                               
         GOTO1 APOST,DMCB,PBILLREC                                              
*                                                                               
         B     BR3                                                              
*                                                                               
*                                                                               
BR40     DS    0H                                                               
         MVC   KEY,SAVKEY                                                       
         GOTO1 HIGH                                                             
*                                                                               
BLDREVX  DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
FLTREST  NTR1                                                                   
         LA    R2,KEY                                                           
         MVC   DUB(2),10(R2)       BILL REC EST                                 
*                                                                               
         CLI   QEST,C' '                                                        
         BE    FE2                                                              
         CLC   QEST,=C'ALL'                                                     
         BE    FE2                                                              
*                                  ONE EST                                      
         CLC   DUB(2),BQEST                                                     
         BL    FENO                                                             
         BE    FEYES                                                            
         CLI   QESTEND,C' '        OR GROUP                                     
         BE    FENO                                                             
         CLC   DUB(2),BQESTEND                                                  
         BH    FENO                                                             
         B     FEYES                                                            
*                                                                               
FE2      DS    0H                                                               
         CLC   QESTEND,SPACES                                                   
         BE    FEYES                                                            
*                                  ESTIMATE FILTERS                             
*                                  CHECK EST HEADER                             
         XC    WORK,WORK                                                        
         MVC   WORK(12),0(R2)                                                   
         MVI   WORK+3,X'07'                                                     
         CLC   WORK(12),PESTKEY    ALREADY HAVE RECORD                          
         BE    FE8                 YES                                          
*                                                                               
         MVC   X(64),KEY                                                        
         MVC   KEY,WORK                                                         
         GOTO1 READ                                                             
         GOTO1 GETEST                                                           
         MVC   KEY,X               RESTPRE KEY                                  
         GOTO1 HIGH                                                             
         MVC   KEYSAVE,X+32        RESTORE DEYSAVE                              
*                                                                               
FE8      DS    0H                                                               
         LA    RE,QESTEND                                                       
         LA    RF,PESTGRPS                                                      
         LA    R0,3                                                             
*                                                                               
FE10     DS    0H                                                               
         CLI   0(RE),C'*'                                                       
         BE    FE14                                                             
         CLI   0(RE),C' '                                                       
         BE    FE14                                                             
*                                                                               
         TM    0(RE),X'40'         TEST NGEATIVE FILTER                         
         BZ    FE12                YES                                          
*                                                                               
         CLC   0(1,RE),0(RF)       POSITIVE FILTER                              
         BNE   FENO                                                             
         B     FE14                                                             
*                                                                               
FE12     DS    0H                                                               
         MVC   DUB(1),0(RE)                                                     
         OI    DUB,X'40'                                                        
         CLC   DUB(1),0(RF)        NEGATIVE FILTER                              
         BE    FENO                                                             
*                                                                               
FE14     DS    0H                                                               
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,FE10                                                          
*                                                                               
FEYES    DS    0H                                                               
         SR    R0,R0                                                            
         B     FEX                                                              
*                                                                               
FENO     DS    0H                                                               
         LTR   RE,RE                                                            
*                                                                               
FEX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'DMGR  - DATAMGR INTERFACE'                                      
PBDMGR   CSECT                                                                  
         NMOD1 0,**PDMG                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         USING PBILWRKD,R8                                                      
*                                                                               
         MVC   SAVDMCB,DMCB                                                     
         SPACE 2                                                                
         LR    R2,RF                                                            
         SRL   R2,24                                                            
         MH    R2,=H'4'                                                         
         B     *(R2)                                                            
         B     DHIGH          1                                                 
         B     DSEQ           2                                                 
         B     DREAD          3                                                 
         B     DGET           4                                                 
         B     DPUT           5                                                 
         B     DADD           6                                                 
         EJECT                                                                  
DHIGH    LA    RF,DMRDHI                                                        
         MVC   KEYSAVE,KEY                                                      
         B     DDIR                                                             
         SPACE 2                                                                
DSEQ     LA    RF,DMRSEQ                                                        
         B     DDIR                                                             
         SPACE 2                                                                
DREAD    LA    RF,DMREAD                                                        
         MVC   KEYSAVE,KEY                                                      
         SPACE 2                                                                
DDIR     DS    0H                                                               
         ST    RF,DMCB                                                          
         MVC   DMCB(1),DMINBTS                                                  
         GOTO1 DATAMGR,DMCB,,PRTDIR,KEY,KEY                                     
*                                                                               
         B     DCHK                                                             
         SPACE 2                                                                
DGET     LA    RF,GETREC                                                        
         B     DFIL                                                             
         SPACE 2                                                                
DPUT     LA    RF,PUTREC                                                        
         B     DFIL                                                             
         SPACE 2                                                                
DADD     LA    RF,ADDREC                                                        
         SPACE 2                                                                
DFIL     DS    0H                                                               
         MVC   DMCB+12(4),DMCB     A(REC)                                       
         ST    RF,DMCB                                                          
         MVC   DMCB(1),DMINBTS                                                  
         LA    R1,KEY+27                                                        
         CLI   0(RF),C'A'                                                       
         BNE   *+8                                                              
         LA    R1,KEY                                                           
         ST    R1,DMCB+8                                                        
         GOTO1 DATAMGR,DMCB,,PRTFILE,,,DMWORK                                   
*                                                                               
         SPACE 2                                                                
DCHK     DS    0H                                                               
         MVC   BYTE,DMOUTBTS                                                    
         NC    BYTE,DMCB+8                                                      
         BZ    *+6                                                              
         DC    H'0'                                                             
         SPACE 2                                                                
         MVC   DMCB(24),SAVDMCB                                                 
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'FORMAT $ LINE'                                                  
         SPACE 2                                                                
FMTLIN   CSECT                                                                  
         NMOD1 0,**FMTL                                                         
         USING PPWORKD,RA                                                       
         USING PBILWRKD,R8                                                      
         SPACE 2                                                                
         L     R1,DMCB                                                          
         MVC   X(12),0(R1)                                                      
         LA    R6,BCDETS           WHAT TO PRINT                                
         LA    R4,P+37                                                          
         LA    R5,4                4 COL'S                                      
*                                                                               
FMTL2    DS    0H                                                               
         CLI   0(R6),0                                                          
         BE    FMTL3                                                            
         SR    R1,R1                                                            
         IC    R1,0(R6)                                                         
         SLL   R1,2           X4                                                
         BAS   RE,FMTBRTAB-4(R1)                                                
*                                                                               
FMTL3    DS    0H                                                               
         LA    R6,1(R6)                                                         
         LA    R4,16(R4)                                                        
         BCT   R5,FMTL2                                                         
         MVI   TOTSW,0                                                          
FMTLX    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
FMTBRTAB DS    0H                                                               
         B     FMTGRS                                                           
         B     FMTNET                                                           
         B     FMTCD                                                            
         DC    XL4'0'                                                           
         B     FMTGLCD                                                          
         B     FMTNLCD                                                          
         SPACE 3                                                                
FMTGRS   DS    0H                                                               
         L     R1,X                                                             
         B     EDTAMT                                                           
         SPACE 2                                                                
FMTNET   DS    0H                                                               
         L     R1,X                                                             
         S     R1,X+4                                                           
         B     EDTAMT                                                           
         SPACE 2                                                                
FMTCD    DS    0H                                                               
         CLI   CDSKIP,C'Y'         TEST TO SKIP CD                              
         BNE   FMTCD2                                                           
         CLI   TOTSW,0             BUT MUST BE AT TOTAL                         
         BE    FMTCD2                                                           
         CLI   TOTSW,C'('                                                       
         BNER  RE                                                               
FMTCD2   DS    0H                                                               
         L     R1,X+8                                                           
         B     EDTAMT                                                           
         SPACE 2                                                                
FMTGLCD  DS    0H                                                               
         L     R1,X                                                             
         S     R1,X+8                                                           
         B     EDTAMT                                                           
         SPACE 2                                                                
FMTNLCD  DS    0H                                                               
         L     R1,X                                                             
         S     R1,X+4                                                           
         S     R1,X+8                                                           
         B     EDTAMT                                                           
         SPACE 3                                                                
EDTAMT   DS    0H                                                               
         EDIT  (R1),(16,0(R4)),2,COMMAS=YES,CR=YES                              
*                                                                               
         CLI   TOTSW,0                                                          
         BER   RE                                                               
         CLI   TOTSW,C'('                                                       
         BE    EDTAMT3                                                          
         LA    RF,14(R4)                                                        
         CLI   0(RF),C'C'                                                       
         BER   RE                                                               
         MVI   0(RF),C'*'                                                       
         CLI   TOTSW,1                                                          
         BER   RE                                                               
         MVI   1(RF),C'*'                                                       
         BR    RE                                                               
*                                                                               
EDTAMT3  DS    0H                                                               
         LA    RF,14(R4)                                                        
         CLI   0(RF),C'C'                                                       
         BNE   *+8                                                              
         LA    RF,2(RF)                                                         
         MVI   0(RF),C')'                                                       
*                                                                               
         LA    RF,12(R4)                                                        
         CLI   0(RF),C' '                                                       
         BNH   *+8                                                              
         BCT   RF,*-8                                                           
         MVI   0(RF),C'('                                                       
*                                                                               
         BR    RE                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'GETFORM - GET BILLING FORMULA'                                  
GETFORM  CSECT                                                                  
         NMOD1 0,**GETF                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         USING PBILWRKD,R8                                                      
         L     R2,0(R1)                                                         
         USING POSTKEYD,R2                                                      
         LA    R3,TABWORK                                                       
         USING HDRKEYD,R3                                                       
*                                                                               
         XC    SAVKEY,SAVKEY                                                    
         XC    HDRKEY(60),HDRKEY                                                
         MVC   HDRKPRD,POSTKPRD                                                 
         MVC   HDRKEST,POSTKEST                                                 
         CLI   POSTKPRD,0               0=GET MAST HDR                          
         BNE   GETF2                                                            
         MVC   HDRKPRD,PPRDKPRD                                                 
         CLI   PRDSW,C'T'                                                       
         BL    *+10                                                             
         MVC   HDRKPRD,=C'AAA'                                                  
         MVC   HDRKEST,PESTKEST                                                 
         CLI   ESTSW,C'E'                                                       
         BNH   *+10                                                             
         MVC   HDRKEST,=2X'FF'                                                  
GETF2    DS    0H                                                               
         CLI   POSTKYM,0                0=GET HDR ONLY                          
         BE    GETF3                                                            
         CLI   FORMSW,C'0'                                                      
         BE    GETF62                                                           
         CLI   FORMSW,C'5'                                                      
         BNE   *+10                                                             
         MVC   HDRKPRD,=C'AAA'                                                  
         CLI   ESTSW,C'E'                                                       
         BNH   *+10                                                             
         MVC   HDRKEST,=2X'FF'                                                  
GETF3    DS    0H                                                               
         MVC   DUB(2),HDRKEST      SAVE ORIG EST                                
GETF4    DS    0H                                                               
         ST    R3,HDRPARS                                                       
         GOTO1 ABINSRCH,HDRPARS                                                 
*                                                                               
         CLI   HDRPARS,1                                                        
         BE    GETF8               NOT FOUND                                    
         L     R3,HDRPARS                                                       
GETF6    DS    0H                                                               
         CLI   POSTKPRD,0          GET MAST HDR                                 
         BE    GETF6B                                                           
         CLI   POSTKYM,0                                                        
         BE    GETF70                                                           
GETF6B   DS    0H                                                               
         OC    HDRBILP,HDRBILP     TEST HAVE BILL PROF                          
         BNZ   GETF60                                                           
GETF7    DS    0H                                                               
         MVC   TABWORK(64),HDRKEY                                               
         LA    R3,TABWORK                                                       
         CLC   HDRKEST,=2X'FF'                                                  
         BE    GETF7B                                                           
         MVC   HDRKEST,=2X'FF'          DEFAULT TO PRD                          
         B     GETF4                                                            
GETF7B   DS    0H                                                               
         CLC   HDRKPRD,=C'AAA'                                                  
         BE    GETF60                                                           
         MVC   HDRKPRD,=C'AAA'          DEFAULT TO AAAPRD                       
         MVC   HDRKEST,DUB         RESTORE ORIG EST                             
         B     GETF4                                                            
*                                  READ FOR HDR                                 
GETF8    DS    0H                                                               
         OC    SAVKEY,SAVKEY                                                    
         BNZ   *+10                                                             
         MVC   SAVKEY,KEY                                                       
         XC    KEY,KEY                                                          
         MVC   KEY(7),RCSVAGY      AMC                                          
         MVC   KEY+7(3),HDRKPRD                                                 
         MVI   KEY+3,6                                                          
         CLC   HDRKEST,=2X'FF'                                                  
         BE    *+14                                                             
         MVI   KEY+3,7                                                          
         MVC   KEY+10(2),HDRKEST                                                
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BNE   GETF6                                                            
         XC    LASTDA,LASTDA       RESET LAST IO                                
         GOTO1 GET,DMCB,ALISREC                                                 
*                                                                               
         L     RF,ALISREC                                                       
         CLI   KEY+3,6                                                          
         BNE   GETF10                                                           
*                                                 PRD HDR                       
         MVC   HDRNAME,PPRDNAME-PPRDREC(RF)                                     
         MVC   HDRACCT,PPRDACCT-PPRDREC(RF)                                     
         MVC   HDRBILP,PPRDBILP-PPRDREC(RF)                                     
         MVC   HDRKEST,=2X'FF'                                                  
         B     GETF12                                                           
*                                                 EST HDR                       
GETF10   DS    0H                                                               
         MVC   HDRBILP,PESTBILP-PESTREC(RF)                                     
         MVC   HDRNAME,PESTNAME-PESTREC(RF)                                     
         XC    HDRACCT,HDRACCT                                                  
         MVC   HDRKEST,KEY+10                                                   
*                                                                               
GETF12   DS    0H                                                               
         CLI   BILNBSW,C'Y'        TEST IF FORMULA NOT FOR BILLS                
         BNE   *+10                                                             
         XC    BILBASA(5),BILBASA                                               
         MVC   HDRKPRD,KEY+7                                                    
         LA    R0,HDRKEY                                                        
         ST    R0,HDRPARS                                                       
         MVI   HDRPARS,1         SET TO ADD                                     
         GOTO1 ABINSRCH,HDRPARS                                                 
*                                                                               
         B     GETF6                                                            
         SPACE 3                                                                
*                             COMPUTE RECEIVABLES                               
GETF60   DS    0H                                                               
         CLI   POSTKYM,0           GET HDR ONLY                                 
         BE    GETF70                                                           
         CLC   POSTKYM,BILADAT                                                  
         BL    GETF62                                                           
         CLI   FORMSW,C'0'         FORMULAS NOT USED                            
         BE    GETF62                                                           
         XC    BFORM,BFORM                                                      
         OC    BFORM,BILBASA                                                    
         BNZ   *+10                                                             
GETF62   DS    0H                                                               
         MVC   BFORM,DFLTFORM      DEFAULT                                      
*                                                                               
         MVC   WORK(24),POSTBY                                                  
         LM    R4,R6,WORK                                                       
         S     R4,WORK+12                                                       
         S     R5,WORK+16                                                       
         S     R6,WORK+20                                                       
         STM   R4,R6,WORK+24                                                    
*                                                                               
         LR    R0,R4               GROSS                                        
         TM    BFORM,X'01'                                                      
         BNZ   *+6                                                              
         SR    R0,R5               LESS AC                                      
         TM    BFORM,X'04'                                                      
         BZ    *+6                                                              
         SR    R0,R6               LESS CD                                      
         ST    R0,ADJBASA          BASE A                                       
*                                                                               
         LR    R0,R4               GROSS                                        
         TM    BFORM+1,X'01'                                                    
         BNZ   *+6                                                              
         SR    R0,R5               LESS AC                                      
         TM    BFORM+1,X'04'                                                    
         BZ    *+6                                                              
         SR    R0,R6               LESS CD                                      
         ST    R0,ADJBASB          BASE B                                       
*                                                                               
         L     R1,ADJBASB                                                       
         MVC   FULL(3),BFORM+2                                                  
         L     RF,FULL                                                          
         SRA   RF,8                                                             
         MR    R0,RF                                                            
*                                                                               
         SLDA  R0,1                                                             
         D     R0,=F'1000000'                                                   
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
*                                                                               
         ST    R1,ADJAMT                                                        
         A     R1,ADJBASA          ADJUSTMENT AMOUNT                            
         ST    R1,ADJBIL           TOTAL AFTER ADJUSTING                        
*                                                                               
         ZAP   RCVBL1,=P'0'                                                     
         ZAP   RCVBL2,=P'0'                                                     
         ZAP   RCVBL3,=P'0'                                                     
*                                                                               
         LR    R0,R1                                                            
         CLI   CDSEPSW,C'S'        SEP BILL FOR CD                              
         BNE   GETF64                                                           
         LCR   R6,R6                                                            
         CVD   R6,DUB                                                           
         ZAP   RCVBL2,DUB          -(CD) IN RCVBL2                              
         LCR   R6,R6                                                            
         AR    R0,R6                                                            
         B     GETF65                                                           
GETF64   DS    0H                                                               
         CLI   CDSEPSW,C'N'        NORMAL CD HANDLING                           
         BNE   GETF65                                                           
         TM    BFORM,X'04'         TEST CD IN ADJTOT                            
         BZ    *+6                                                              
         AR    R0,R6               REMOVE CD FORM BASE                          
*                                                                               
GETF65   DS    0H                                                               
         CLI   SEPSW,C'S'          SEP ADJ BILL                                 
         BNE   GETF66                                                           
         L     R7,ADJAMT                                                        
         CVD   R7,DUB                                                           
         ZAP   RCVBL3,DUB          ADJ AMT IN RCVBL3                            
         SR    R0,R7                                                            
*                                                                               
GETF66   DS    0H                                                               
         CVD   R0,DUB                                                           
         ZAP   RCVBL1,DUB                                                       
*                                                                               
*                                                                               
GETF70   DS    0H                                                               
         OC    SAVKEY,SAVKEY                                                    
         BZ    GETF72                                                           
*                                  NEED TO RESTORE SEQ READ                     
         MVC   KEY,SAVKEY                                                       
         GOTO1 HIGH                                                             
*                                                                               
GETF72   DS    0H                                                               
         CLI   POSTKPRD,0          0 = GET MASTHDR                              
         BNE   GETF76                                                           
*                                  SET BCDETS                                   
         LA    R7,BLIST                                                         
GETF73   DS    0H                                                               
         CLC   BILDETS,0(R7)                                                    
         BE    GETF74                                                           
         CLI   0(R7),0                                                          
         BE    GETF75                                                           
         LA    R7,5(R7)                                                         
         B     GETF73                                                           
GETF74   DS    0H                                                               
GETF75   DS    0H                                                               
         MVC   BCDETS,1(R7)                                                     
         CLI   BCDETS+3,0                                                       
         BE    GETF75A                                                          
         CLI   PAGYPROF+14,C'0'                                                 
         BNE   *+8                                                              
         OI    BCDETS+3,X'04'      SET X TO X-CD IN STRIP                       
GETF75A  DS    0H                                                               
         MVC   MASTHDR,HDRKEY                                                   
         MVC   CDSEPSW,BILCDSW     SET CD SEP SW                                
         OC    BILBASA(5),BILBASA                                               
         BZ    GETF75D                                                          
         CLC   BSTART(2),BILADAT                                                
         BNL   *+10                                                             
*                                                                               
GETF75D  DS    0H                                                               
         MVC   BILBASA(5),DFLTFORM                                              
         CLI   CDSEPSW,C'C'        SPECIAL CD HANDLING                          
         BE    GETF76                                                           
         TM    BILBASA,X'04'       TEST CD IN BASE                              
         BZ    GETF75B             NO                                           
         CLI   CDSEPSW,C'S'        YES - CD MUST BE SEPARATE                    
         BE    GETF76                                                           
         MVI   CDSEPSW,C'R'        OR REGULAR                                   
         B     GETF76                                                           
GETF75B  DS    0H                                                               
         MVI   CDSEPSW,C'N'        SUPPRESS CD                                  
GETF76   DS    0H                                                               
         ST    R3,DMCB+4                                                        
GETFX    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
DFLTFORM DC    X'0505000000'       GLCD + 0 X GLCD                              
*                                  WHAT TO PRINT ON BILL                        
*                                                                               
BLIST    DS    0C                                                               
         DC    C'1',X'00010002'    G-N                                          
         DC    C'2',X'00020001'    N-G                                          
         DC    C'3',X'01020000'    G,N-0                                        
         DC    C'4',X'01030502'    G,CD,GLCD-N                                  
         DC    C'5',X'02030601'    N,CD,NLCD-G                                  
         DC    C'6',X'01020300'    G,N,CD-0                                     
         DC    C'7',X'01020502'    G,N,BLCD-N                                   
         DC    C'8',X'01020601'    G,N,NLCD-G                                   
         DC    C'9',X'01030602'    G,CD,N-CD,N                                  
         DC    C'A',X'01050602'    G,GLCD,NLCD,-N                               
         DC    C'B',X'01030501'    G-G                                          
         DC    C'C',X'02030602'    N-N                                          
         DC    C'D',X'01030002'        G,CD-N                                   
         DC    C'E',X'02030001'        N,CD-G                                   
         DC    X'0',X'01030502'                                                 
*                                                                               
         SPACE 3                                                                
         DROP  R2,R3                                                            
         LTORG                                                                  
         TITLE 'GETNUM - GET FIRST/NEXT INVOICE NUMBER'                         
GETNUM   CSECT                                                                  
         NMOD1 0,**GETN                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         USING PBILWRKD,R8                                                      
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         SPACE 2                                                                
         OC    INVNO,INVNO                                                      
         BNZ   GN22                                                             
*                                                                               
         PACK  DUB,PAGYPROF+17(3)       STARTING VALUE                          
         CVB   R0,DUB                                                           
         MH    R0,=H'10'                                                        
         STH   R0,INVNO                                                         
         XC    KEY,KEY                                                          
         MVC   KEY(3),RCSVAGY           AMC                                     
         MVI   KEY+3,8                                                          
*                                                                               
         MVC   PBILKBMN,BTODAY          SET DATE FOR PINVNO FORMAT              
*                                                                               
         CLI   PAGYPROF+5,C'0'                                                  
         BE    GN16                BY CLIENT                                    
*                                  BY AGENCY                                    
         CLC   PAGYPROF+17(3),=3C'0'    IF START GIVEN SRCH ONLY                
         BNZ   GN4                      THIS MEDIA - ELSE                       
         MVI   KEY+2,0                  ALL MEDIAS                              
*                                                                               
GN4      DS    0H                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(2),KEYSAVE      AGY                                          
         BNE   GN20                                                             
         MVI   KEY+3,8                                                          
         GOTO1 HIGH                                                             
*                                                                               
         B     GN7                                                              
GN6      DS    0H                                                               
         GOTO1 SEQ                                                              
*                                                                               
GN7      CLC   KEY(4),KEYSAVE      AMR                                          
         BNE   GN8                                                              
         CLC   KEY(2),=C'BJ'                                                    
         BE    GN7B                SPECIAL FOR BJ                               
         CLC   KEY(2),=C'KN'                                                    
         BE    GN7F                FOR K&E NO INV NUMBER RESEQ                  
*                                                                               
         CLC   KEY+14(2),BTODAY    DATE CHECK                                   
         BNE   GN6                                                              
         B     GN7F                                                             
*                                                                               
GN7B     DS    0H                  FOR BJ                                       
         CLC   KEY+14(2),=X'5604'  IGNORE BILLS BEFORE DEC85                    
         BL    GN6                                                              
         BH    GN7F                NO SPECIFIC DATE CHECK IF LATER              
*                                                                               
         GOTO1 GETBILL                                                          
         CLC   PBILLDAT,=C'860419'  SKIP BILLS BEFORE DEC20/85                  
         BL    GN6                                                              
*                                                                               
GN7F     DS    0H                                                               
         CLC   INVNO,KEY+16                                                     
         BNL   GN6                                                              
         MVC   INVNO,KEY+16                                                     
         B     GN6                                                              
*                                                                               
GN8      DS    0H                                                               
         CLC   PAGYPROF+17(3),=3C'0'                                            
         BNE   GN20                                                             
         MVC   KEY(4),KEYSAVE                                                   
         XC    KEY+4(21),KEY+4                                                  
         IC    R2,KEY+2                                                         
         LA    R2,1(R2)                                                         
         STC   R2,KEY+2                                                         
         B     GN4                                                              
         SPACE 2                                                                
*                                  BY CLIENT                                    
GN16     DS    0H                                                               
         MVC   KEY+4(3),PCLTKCLT                                                
         GOTO1 HIGH                                                             
*                                                                               
         B     GN17A                                                            
GN17     DS    0H                                                               
         GOTO1 SEQ                                                              
*                                                                               
GN17A    DS    0H                                                               
         CLC   KEY(7),KEYSAVE                                                   
         BNE   GN20                                                             
*                                                                               
         CLC   KEY+14(2),BTODAY    DATE CHECK                                   
         BNE   GN17                                                             
*                                                                               
         CLC   INVNO,KEY+16                                                     
         BNL   GN17                                                             
         MVC   INVNO,KEY+16                                                     
         B     GN17                                                             
*                                  BUMP INVOICE NO.                             
GN20     DS    0H                                                               
         MVC   PBILKBMN,BTODAY          SET DATE FOR PINVNO FORMAT              
GN22     DS    0H                                                               
         NI    INVNO,X'7F'         CLEAR HOB                                    
         LH    R2,INVNO                                                         
         LA    R2,1(R2)                                                         
         STH   R2,INVNO                                                         
*                                  FORMAT AS SS-MM-NNNN                         
*                                         OR MM-SS-NNNN                         
         MVC   PINVNO,SPACES                                                    
         CVD   R2,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PINVNO+6(4),DUB                                                  
         SR    R2,R2                                                            
         IC    R2,PBILKBMN+1                                                    
         CVD   R2,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PINVNO+3(2),DUB                                                  
         MVI   PINVNO+2,C'-'                                                    
         MVI   PINVNO+5,C'-'                                                    
         MVC   PINVNO(2),PAGYPROF+2                                             
         CLI   PAGYPROF+4,C'0'                                                  
         BE    GETNUMX                                                          
         MVC   DUB(2),PINVNO            REVERSE SS AND MM                       
         MVC   PINVNO(2),PINVNO+3                                               
         MVC   PINVNO+3(2),DUB                                                  
*                                                                               
         CLI   PINVNO+3,C' '                                                    
         BH    GETNUMX                                                          
         MVC   PINVNO+3(6),PINVNO+4                                             
         MVI   PINVNO+9,C' '                                                    
*                                                                               
GETNUMX  DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'INVREG - PRINT INVOICE REGISTER'                                
INVREG   CSECT                                                                  
         NMOD1 0,**INVR                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         USING PBILWRKD,R8                                                      
         SPACE 2                                                                
         GOTO1 APBINTAP                                                         
         OC    SAVEDA,SAVEDA                                                    
         BZ    INVRX                                                            
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         XC    IRCTOTS,IRCTOTS                                                  
         XC    IRMTOTS,IRMTOTS                                                  
*                                                                               
         SR    R0,R0                                                            
         IC    R0,SAVEDA+2                                                      
         BCTR  R0,R0                                                            
         STC   R0,SAVEDA+2         BACK UP ONE REC                              
         XC    SAVKEY,SAVKEY                                                    
INVR2    DS    0H                                                               
         GOTO1 DATAMGR,DMCB,DMRSEQ,PRTFILE,SAVEDA,PBILLREC                      
*                                                                               
         TM    DMCB+8,X'7F'                                                     
         BZ    *+6                                                              
         DC    H'0'                                                             
         TM    DMCB+8,X'80'        EOF                                          
         BZ    *+14                                                             
         MVC   PBILLREC(3),=3X'FF'                                              
         B     INVR3                                                            
*                                                                               
         CLI   PBILKRCD,8                                                       
         BNE   INVR2                                                            
         CLC   PBILKAGY,PAGYKAGY                                                
         BNE   INVR2                                                            
         CLI   PBILLMOD,C'P'       BYPASS PRD MODE BILLS                        
         BE    INVR2                                                            
         CLI   PBILLMOD,C'S'       AND SERIES MODE                              
         BE    INVR2                                                            
*                                                                               
         CLC   SAVKEY(7),PBILLKEY                                               
         BE    INVR8                                                            
         CLI   SAVKEY,0                                                         
         BE    INVR4                                                            
INVR3    DS    0H                                                               
*                                  CLIENT TOTALS                                
         MVC   X(20),IRCTOTS                                                    
         MVI   TOTSW,1                                                          
         BAS   RE,IRFMTL                                                        
         MVC   P+1(7),=C'*CLIENT'                                               
         MVC   P+9(3),SAVKEY+4                                                  
         MVC   P+13(7),=C'TOTALS*'                                              
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
         LM    R3,R7,IRMTOTS                                                    
         A     R3,IRCTOTS+0                                                     
         A     R4,IRCTOTS+4                                                     
         A     R5,IRCTOTS+8                                                     
         A     R6,IRCTOTS+12                                                    
         A     R7,IRCTOTS+16                                                    
         STM   R3,R7,IRMTOTS                                                    
*                                                                               
         XC    IRCTOTS,IRCTOTS                                                  
         CLC   SAVKEY+2(1),PBILKMED                                             
         BE    INVR6                                                            
*                                  MEDIA TOTALS                                 
         MVC   X(20),IRMTOTS                                                    
         MVI   TOTSW,2                                                          
         BAS   RE,IRFMTL                                                        
         MVC   P+1(16),=C'**MEDIA TOTALS**'                                     
         GOTO1 APRNT                                                            
*                                                                               
         CLC   PBILLREC(3),=3X'FF'                                              
         BE    INVRX                                                            
*                                  NEW MEDIA                                    
INVR4    DS    0H                                                               
         MVI   FORCEHED,C'Y'                                                    
         XC    IRMTOTS,IRMTOTS                                                  
*                                  SET MEDIA NAME                               
         LA    R4,MEDLIST                                                       
INVR4B   DS    0H                                                               
         CLC   PBILKMED,0(R4)                                                   
         BH    *+10                                                             
         BE    INVR5                                                            
         DC    H'0'                                                             
         LA    R4,11(R4)                                                        
         B     INVR4B                                                           
*                                                                               
INVR5    DS    0H                                                               
         MVC   PAGYMED,1(R4)                                                    
         MVC   PAGYKMED,0(R4)                                                   
*                                  NEW CLIENT                                   
INVR6    DS    0H                                                               
         CLI   PAGYPROF+28,C'N'                                                 
         BE    *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
         MVC   P+1(6),=C'CLIENT'                                                
         MVC   P+8(3),PBILKCLT                                                  
         MVI   PSECOND+1,C'-'                                                   
         MVC   PSECOND+2(9),PSECOND+1                                           
         CLI   P+10,C' '                                                        
         BH    *+8                                                              
         MVI   PSECOND+10,C' '                                                  
         GOTO1 APRNT                                                            
         XC    SAVKEY+7(3),SAVKEY+7     CLEAR INV DATE                          
*                                                                               
INVR8    DS    0H                                                               
         CLC   PBILINVD,SAVKEY+7                                                
         BE    INVR8D                                                           
         GOTO1 DTCNV,DMCB,(1,PBILINVD),(3,WORK)                                 
*                                                                               
         MVC   P+16(5),=C'DATE='                                                
         MVC   P+22(8),WORK                                                     
         GOTO1 APRNT                                                            
*                                                                               
INVR8D   DS    0H                                                               
         MVC   SAVKEY(07),PBILLKEY                                              
         MVC   SAVKEY+7(3),PBILINVD                                             
         MVC   P+1(3),PBILKPRD                                                  
         MVC   HALF,PBILKEST                                                    
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+5(3),DUB                                                       
         GOTO1 DTCNV,DMCB,(1,PBILKMOS),(5,P+9)                                  
*                                                                               
         MVC   P+12(2),P+13                                                     
         MVI   P+14,C' '                                                        
         MVC   HALF,PBILKBNO                                                    
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+15(4),DUB                                                      
         CLI   PBILSEP,C'R'                                                     
         BE    INVR9                                                            
         MVC   P+20(2),=C'CD'                                                   
         CLI   PBILSEP,C'C'                                                     
         BE    INVR9                                                            
         MVC   P+20(2),=C'AJ'                                                   
*                                                                               
INVR9    DS    0H                                                               
         ZAP   DUB,PBILLGRS                                                     
         CVB   R0,DUB                                                           
         ST    R0,X                GROSS                                        
         SP    DUB,PBILLBIL                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+8              CD                                           
         AP    DUB,PBILLNET                                                     
         SP    DUB,PBILLGRS                                                     
         CVB   R0,DUB                                                           
         LCR   R0,R0                                                            
         ST    R0,X+4              AC                                           
         ZAP   DUB,PBILLRCV                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+16             RECEIVABLE                                   
*                                  TEST SPECIAL CD OPTION                       
         LTR   R0,R0                                                            
         BNP   INVR10              RCV MUST BE +                                
         CLI   PBILCDSW,C'C'                                                    
         BNE   INVR10                                                           
         TM    PBILBASA,X'04'      CD IN BASE                                   
         BZ    INVR10                                                           
         OC    PBILADJ,PBILADJ     NO REAL FORMULA                              
         BNZ   INVR10                                                           
         ZAP   DUB,PBILLGRS                                                     
         SP    DUB,PBILLBIL                                                     
         BNP   INVR10              CD MUST ALSO BE POS                          
*                                                                               
         L     R0,X+16                                                          
         A     R0,X+8              ADD BACK CD TO RCVBL                         
         ST    R0,X+16                                                          
*                                                                               
INVR10   DS    0H                                                               
         ZAP   DUB,PBILLRCV                                                     
         TM    PBILBASA,X'04'      IF BASE NOT 'LESS CD'                        
         BNZ   *+16                                                             
         SP    DUB,PBILLGRS        SUBTRACT CD OUT NOW                          
         AP    DUB,PBILLBIL                                                     
         CLI   PBILSEP,C'C'        IF SEPARATE CD INV                           
         BNE   *+10                                                             
         SR    R0,R0               THEN NO 'AC'                                 
         B     *+10                                                             
         SP    DUB,PBILLNET                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+12             EFFECTIVE AGY COMM                           
*                                                                               
         CLI   PBILCMSW,C'C'       TEST COMMISSION ONLY BILL                    
         BNE   INVR10D             NO                                           
         L     RF,X                SET AC=GROSS SO NET=0                        
         CLI   PAGYPROF+14,C'0'                                                 
         BNE   *+8                                                              
         S     RF,X+8              INCLUDE CD                                   
         ST    RF,X+4                                                           
         MVC   X+12(4),X+16        SET EFF AC = BILL ACTUAL                     
INVR10D  DS    0H                                                               
*                                                                               
         MVI   TOTSW,0                                                          
         BAS   RE,IRFMTL                                                        
         GOTO1 APRNT                                                            
*                                                                               
         LM    R3,R7,IRCTOTS                                                    
         A     R3,X+0                                                           
         A     R4,X+4                                                           
         A     R5,X+8                                                           
         A     R6,X+12                                                          
         A     R7,X+16                                                          
         STM   R3,R7,IRCTOTS                                                    
         B     INVR2                                                            
         SPACE 3                                                                
*                                                                               
IRFMTL   NTR1                                                                   
         SPACE 2                                                                
         LA    R3,P+22                                                          
         L     R2,X+16             BILL AMOUNT                                  
         BAS   RE,IRFEDT                                                        
         L     R2,X                GROSS                                        
         CLI   PAGYPROF+14,C'0'    TEST CD OPT                                  
         BNE   *+8                                                              
         S     R2,X+8              LESS CD                                      
         S     R2,X+4              LESS AC = NET                                
         BAS   RE,IRFEDT                                                        
         L     R2,X+12             EFFECTIVE AC                                 
         BAS   RE,IRFEDT                                                        
         L     R2,X                GROSS                                        
         BAS   RE,IRFEDT                                                        
         L     R2,X+8                                                           
         BAS   RE,IRFEDT                                                        
         XIT1                                                                   
         SPACE 2                                                                
IRFEDT   DS    0H                                                               
         EDIT  (R2),(15,0(R3)),2,COMMAS=YES,CR=YES                              
*                                                                               
         CLI   TOTSW,0                                                          
         BE    IRFEDT4                                                          
         LA    RF,13(R3)                                                        
         CLI   0(RF),C'C'                                                       
         BE    IRFEDT4                                                          
         MVI   0(RF),C'*'                                                       
         CLI   TOTSW,1                                                          
         BE    IRFEDT4                                                          
         MVI   1(RF),C'*'                                                       
*                                                                               
IRFEDT4  DS    0H                                                               
         LA    R3,16(R3)                                                        
         BR    RE                                                               
         SPACE 2                                                                
INVRX    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
MEDLIST  DC    CL11'MMAGAZINE'                                                  
         DC    CL11'NNEWSPAPER'                                                 
         DC    CL11'OOUTDOOR'                                                   
         DC    CL11'SSUPPLEMENT'                                                
         DC    CL11'TTRADE'                                                     
         DC    C'Z'                                                             
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'POST BUYS AND BILLS'                                            
*                                  POST BUY/BILL TO ACCUMS                      
PBPOST   CSECT                                                                  
         NMOD1 0,**POST                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         USING PBILWRKD,R8                                                      
         LA    R3,TABWORK                                                       
         SPACE 2                                                                
         L     R2,0(R1)                                                         
         CLI   3(R2),X'20'                                                      
         BE    PBY                                                              
         CLI   3(R2),X'08'                                                      
         BE    PBL                                                              
         CLI   3(R2),X'06'                                                      
         BE    PPRD                                                             
         CLI   3(R2),X'07'                                                      
         BE    PEST                                                             
         CLI   3(R2),X'FF'                                                      
         BE    POSTADD                                                          
         DC    H'0'                                                             
*                                  POST BILL RECORD                             
PBL      DS    0H                                                               
         USING POSTKEYD,R3                                                      
         MVC   POSTKPRD,PBILKPRD                                                
         MVC   POSTKYM,PBILKMOS                                                 
         MVC   POSTKEST,PBILKEST                                                
         ZAP   DUB,PBILLGRS                                                     
         CVB   R0,DUB                                                           
         ST    R0,WORK             GRS                                          
         SP    DUB,PBILLBIL                                                     
         CVB   R0,DUB                                                           
         ST    R0,WORK+8           CD                                           
         AP    DUB,PBILLNET                                                     
         CVB   R0,DUB                                                           
         S     R0,WORK                                                          
         LCR   R0,R0                                                            
         ST    R0,WORK+4           COMM                                         
         XC    POSTBY,POSTBY                                                    
         MVC   POSTBL(12),WORK                                                  
         BAS   RE,POSTUP                                                        
         B     POSTX                                                            
*                                  POST BUY RECORD                              
         SPACE 3                                                                
PBY      DS    0H                                                               
         MVC   POSTKPRD,PBUYKPRD                                                
         CLC   POSTKPRD,=C'ZZZ'                                                 
         BNE   *+10                                                             
         MVC   POSTKPRD,PPRDKPRD                                                
         MVC   POSTKYM,PBDBDATE                                                 
         MVC   POSTKEST,PBUYKEST                                                
         XC    POSTBL,POSTBL                                                    
         CLC   QPROG,=C'04'                                                     
         BE    PBY3                                                             
         LM    R5,R7,BUYGRS                                                     
         S     R5,BGROSS                LESS BILLED                             
         S     R6,BAGYCOM                                                       
         S     R7,BCSHDSC                                                       
         STM   R5,R7,BUYGRS                                                     
PBY3     DS    0H                                                               
         CLI   PRDSW,C'T'                                                       
         BL    PBY3D                                                            
         CLC   PBUYKPRD,=C'ZZZ'                                                 
         BE    PBY4                                                             
PBY3D    DS    0H                                                               
         MVC   POSTBY,BUYGRS                                                    
         BAS   RE,MARKBUY                                                       
         BAS   RE,POSTUP                                                        
         B     POSTX                                                            
*                             ZZZ                                               
PBY4     DS    0H                                                               
         MVC   SAVPVALS,GROSS                                                   
         LA    R2,PBUYREC+33                                                    
         USING PPRELEM,R2                                                       
PBY5     DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    PBY10                                                            
         CLI   0(R2),X'21'         PRODUCT ELEM                                 
         BE    PBY7                                                             
PBY6     DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PBY5                                                             
*                                                                               
PBY7     DS    0H                                                               
         GOTO1 GETINS,DMCB,PBUYKEY,GROSS,PPRCODE                                
*                                                                               
         TM    PBUYCNTL,X'80'                                                   
         BZ    *+10                                                             
         XC    GROSS(12),GROSS                                                  
*                                                                               
         MVC   POSTKPRD,PPRCODE                                                 
         MVC   POSTKYM,PBDBDATE                                                 
         MVC   POSTKEST,PBUYKEST                                                
         LM    R5,R7,GROSS         ORDERED                                      
         CLC   QPROG,=C'04'                                                     
         BE    PBY8                                                             
         CLI   PCLTPROF+13,C'1'                                                 
         BE    PBY7B                                                            
         LM    R5,R7,PGROSS        PAID                                         
PBY7B    DS    0H                                                               
         S     R5,BGROSS           LESS BILLED                                  
         S     R6,BAGYCOM                                                       
         S     R7,BCSHDSC                                                       
*                                                                               
PBY8     DS    0H                                                               
         STM   R5,R7,X                                                          
         MVC   POSTBY,X                                                         
         XC    POSTBL,POSTBL                                                    
         BAS   RE,MARKBUY          MARK ONLY                                    
         BAS   RE,POSTUP                                                        
         B     PBY6                                                             
*                                                                               
PBY10    DS    0H                                                               
         MVI   POSTKPRD,X'FF'                                                   
         BAS   RE,MARKBUY          WRITE ZZZ REC                                
         MVC   GROSS(L'SAVPVALS),SAVPVALS                                       
         B     POSTX                                                            
         DROP  R2                                                               
         SPACE 2                                                                
*                                  ROLL UP TOTALS                               
POSTADD  DS    0H                                                               
         L     R2,BSTAB                                                         
         CLI   0(R2),0             NO DATA                                      
         BE    POSTX                                                            
PADD2    DS    0H                                                               
         CLC   0(3,R2),=3X'FF'                                                  
         BE    PADD6                                                            
         CLC   3(2,R2),=3X'FF'                                                  
         BE    PADD6                                                            
         CLC   5(2,R2),=3X'FF'                                                  
         BE    PADD6                                                            
*                                                                               
         CLC   QPROG,=C'06'                                                     
         BE    PADD4                                                            
         CLC   7(12,R2),19(R2)     TEST ORDERED = BILLED                        
         BC    0,PADD6             NO-OP SUPPRESS OF WHOLLY BILLED MOS          
*                                                                               
PADD4    DS    0H                                                               
         MVC   TABWORK(31),0(R2)                                                
         BAS   RE,POSTALL                                                       
*                                                                               
PADD6    DS    0H                                                               
         L     R1,BSLEN            LENGTH                                       
         M     R0,BSNUM            X CURRENT NUMBER                             
         A     R1,BSTAB            R1 = 1 PAST END OF TABLE                     
         A     R2,BSLEN                                                         
         CR    R2,R1                                                            
         BL    PADD2                                                            
*                                                                               
         B     POSTX                                                            
         SPACE 3                                                                
POSTALL  NTR1                                                                   
         SPACE 2                                                                
POSTALL2 DS    0H                                                               
         CLI   ESTSW,C'E'                                                       
         BNH   POSTALL3                                                         
*                                                                               
         MVC   POSTKEST,=3X'FF'         EST=FF, PRD/YM TOTS                     
         BAS   RE,POSTUP                                                        
*                                                                               
POSTALL3 DS    0H                                                               
         CLI   PRIORSW,C'T'                                                     
         BNE   PA3B                                                             
         MVC   HOLDYM,POSTKYM                                                   
         MVC   POSTKYM,=3X'FF'          YM+EST=FF, PRD TOTS                     
         BAS   RE,POSTUP                                                        
PA3B     DS    0H                                                               
         CLI   PRDSW,C'T'                                                       
         BL    PA4                                                              
*                                                                               
         MVC   POSTKPRD,=3X'FF'         YM+EST+PRD=FF, CLT TOTS                 
         BAS   RE,POSTUP                                                        
*                                                                               
*                                       EST+PRD=FF, CLT/YM TOTS                 
         CLI   PRIORSW,C'T'                                                     
         BNE   PA4                                                              
         MVC   POSTKYM,HOLDYM                                                   
         BAS   RE,POSTUP                                                        
*                                                                               
PA4      DS    0H                                                               
PA6      DS    0H                                                               
POSTX    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
POSTUP   DS    0H                                                               
         LR    R0,RE                                                            
         LA    R1,POSTKEY                                                       
         ST    R1,BSREC                                                         
         MVI   BSREC,1             SET TO ADD                                   
         GOTO1 ABINSRCH,BSPARS                                                  
*                                                                               
         LR    RE,R0                                                            
         CLI   BSREC,1                                                          
         BNE   PU2                                                              
         OC    BSPARS+1(3),BSPARS+1                                             
         BNZR  RE                                                               
         DC    H'0'                TABLE OVERFLOW                               
*                                                                               
PU2      DS    0H                  ADD INTO EXISTING ELEMENT                    
         L     R1,BSPARS                                                        
         MVC   WORK(24),7(R1)                                                   
         MVC   WORK+24(24),POSTBY                                               
         LA    R5,WORK                                                          
         LA    R6,WORK+24                                                       
         LA    R7,6                                                             
PU4      DS    0H                                                               
         L     R0,0(R5)                                                         
         A     R0,0(R6)                                                         
         ST    R0,0(R5)                                                         
         LA    R5,4(R5)                                                         
         LA    R6,4(R6)                                                         
         BCT   R7,PU4                                                           
*                                                                               
         MVC   7(24,R1),WORK                                                    
         BR    RE                                                               
         EJECT                                                                  
*                                  MARK BUY REC                                 
         SPACE 2                                                                
MARKBUY  NTR1                                                                   
         SPACE 2                                                                
         CLI   RCWRITE,C'Y'                                                     
         BNE   POSTX                                                            
         CLC   QPROG,=C'04'                                                     
         BE    POSTX                                                            
         CLI   POSTKPRD,X'FF'                                                   
         BE    MB14                                                             
         CLC   KEY(25),PBUYKEY                                                  
         BNE   MB1                                                              
         CLC   LASTDA,KEY+27                                                    
         BE    MB1D                                                             
MB1      MVC   KEY(25),PBUYKEY                                                  
         CLC   PBUYKPRD,=C'ZZZ'         REREAD BUY REC BEFORE PUT               
         BNE   MB1B                                                             
         CLI   PRDSW,C'T'                                                       
         BNL   MB1B                                                             
         MVC   KEY+7(3),PPRDKPRD                                                
         MVC   KEY+21(3),=C'ZZZ'                                                
MB1B     DS    0H                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   LASTDA,KEY+27                                                    
         BE    MB1D                                                             
         GOTO1 GET,DMCB,PBUYREC                                                 
         MVC   LASTDA,KEY+27                                                    
MB1D     DS    0H                                                               
*                                                                               
         LA    R2,PBUYREC+33                                                    
MB2      DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    MB8                                                              
         CLI   0(R2),X'26'                                                      
         BE    MB6                                                              
MB4      DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     MB2                                                              
MB6      DS    0H                                                               
         USING PBILELEM,R2                                                      
         OC    PBLDATE,PBLDATE                                                  
         BNZ   MB4                                                              
         CLC   PBPRD,POSTKPRD                                                   
         BNE   MB4                                                              
         MVC   PBLDATE,BTODAY                                                   
         MVC   PBGROSS(12),POSTBY                                               
         MVC   PBINVNO,INVNO       SET INVOICE NO.                              
         B     MB12                                                             
*                                                                               
MB8      DS    0H                                                               
         LR    R4,R2                                                            
         XC    X,X                                                              
         LA    R2,X                                                             
         MVC   PBLDATE,BTODAY                                                   
         MVC   PBPRD,POSTKPRD                                                   
         MVC   PBILELEM(2),=X'2617'                                             
         MVC   PBGROSS(12),POSTBY                                               
         MVC   PBINVNO,INVNO       SET INVOICE NO.                              
         GOTO1 RECUP,DMCB,(1,PBUYREC),X,(R4)                                    
*                                                                               
*                                                                               
MB12     DS    0H                                                               
         CLI   PRDSW,C'T'          ONLY MARK ZZZ REC                            
         BL    MB14                AFTER LAST PROD IF MULTI-PROD                
         CLC   PBUYKPRD,=C'ZZZ'                                                 
         BE    POSTX                                                            
*                                                                               
MB14     DS    0H                                                               
         GOTO1 PUT,DMCB,PBUYREC                                                 
*                                                                               
         B     POSTX                                                            
         SPACE 3                                                                
PPRD     DS    0H                                                               
         USING HDRKEYD,R3     PRODUCT HDR                                       
         MVC   HDRKPRD,PPRDKPRD                                                 
         MVC   HDRKEST,=3X'FF'                                                  
         MVC   HDRNAME,PPRDNAME                                                 
         MVC   HDRACCT,PPRDACCT                                                 
         MVC   HDRBILP,PPRDBILP                                                 
         CLI   BILNBSW,C'Y'        TEST IF FORMULA NOT FOR BILLS                
         BNE   *+10                                                             
         XC    BILBASA(5),BILBASA                                               
         B     PHDR                                                             
         SPACE 3                                                                
PEST     DS    0H             EST HDR                                           
         MVC   HDRKPRD(5),PESTKPRD                                              
         MVC   HDRNAME,PESTNAME                                                 
         MVC   HDRBILP,PESTBILP                                                 
         CLI   BILNBSW,C'Y'        TEST IF FORMULA NOT FOR BILLS                
         BNE   *+10                                                             
         XC    BILBASA(5),BILBASA                                               
         XC    HDRACCT,HDRACCT                                                  
         SPACE 3                                                                
PHDR     DS    0H                                                               
         LA    R1,HDRKEY                                                        
         ST    R1,HDRPARS                                                       
         MVI   HDRPARS,1           SET TO ADD                                   
         GOTO1 ABINSRCH,HDRPARS                                                 
*                                                                               
         B     POSTX                                                            
         DROP  R3                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'PRNT, - PRINT INTERFACE'                                        
*                                  PRINT CONTROL                                
PBPRNT   CSECT                                                                  
         NMOD1 0,**PRNT                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         USING PBILWRKD,R8                                                      
         SPACE 2                                                                
         CLI   FORCEHED,C'Y'                                                    
         BE    PRNT2                                                            
*                                  CHECK EOP                                    
         TM    LNEED,X'80'         FORCE ON SAME PAGE                           
         BZ    *+12                                                             
         MVI   MAXLINES,99                                                      
         B     PRNT5                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         IC    RE,LINE                                                          
         IC    RF,LNEED            LINES NEEDED                                 
         AR    RE,RF                                                            
         STC   RE,BYTE                                                          
         CLC   BYTE,MAXLINES                                                    
         BL    *+8                                                              
PRNT2    DS    0H                                                               
         BAS   RE,PRNTHEAD                                                      
*                             CHECK MID LINES                                   
         CLC   MID1,SAVMID                                                      
         BE    PRNT4          JUST SET BY PRNTHEAD                              
         CLC   MID1,SPACES                                                      
         BE    PRNT5                                                            
         MVC   SAVMID,MID1                                                      
         LA    R2,SAVMID+50                                                     
         CLI   0(R2),C' '                                                       
         BH    *+8                                                              
         BCT   R2,*-8                                                           
         MVC   2(11,R2),=C'(CONTINUED)'                                         
*                                                                               
PRNT4    DS    0H                                                               
         MVI   FORCEMID,C'Y'                                                    
PRNT5    DS    0H                                                               
         GOTO1 REPORT                                                           
*                                                                               
PRNTX    DS    0H                                                               
         MVI   LNEED,1                                                          
         MVC   MAXLINES,SAVMAX                                                  
PRNTXX   XIT1                                                                   
         EJECT                                                                  
*                                  HEADLINES                                    
PRNTHEAD NTR1                                                                   
         SPACE 2                                                                
         LA    R0,14                                                            
         LA    R1,HLIN1                                                         
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         CLI   MODE,RUNLAST        INV REGISTER                                 
         BE    PH80                                                             
*                                                                               
         MVC   HLIN1+1(12),=C'INVOICE DATE'                                     
         GOTO1 DTCNV,DMCB,QINVDATE,(3,HLIN1+14)                                 
*                                                                               
         MVC   HLIN1+34(17),=C'MEDIA ADVERTISING'                               
*                                                                               
         MVC   HLIN1+65(7),=C'INVOICE'                                          
         MVC   HLIN1+73(10),PINVNO      SET IN GETINV                           
*                                       SPECIAL ACCT NO.                        
         CLI   PAGYACCT,C'0'                                                    
         BNE   *+14                                                             
         CLC   PAGYACCT+1(L'PAGYACCT-1),PAGYACCT                                
         BE    *+10                                                             
         MVC   HLIN2+65(18),PAGYACCT                                            
*                                                                               
         CLC   QDUEDAYS,=C'00'     NO DUE DATE                                  
         BE    PH3                                                              
         MVC   HLIN2+1(8),=C'DUE DATE'                                          
         PACK  DUB,QDUEDAYS                                                     
         CVB   R0,DUB                                                           
         GOTO1 ADDAY,DMCB,QINVDATE,WORK,(R0)                                    
*                                                                               
         GOTO1 DTCNV,DMCB,WORK,(3,HLIN2+14)                                     
*                                                                               
PH3      DS    0H                                                               
         CLC   QPRODUCT,SPACES                                                  
         BE    PH8                                                              
         MVC   HLIN4+46(20),PPRDBILL                                            
         MVC   HLIN5+46(30),PPRDLIN1                                            
         MVC   HLIN6+46(30),PPRDLIN2                                            
         MVC   HLIN7+46(24),PPRDATTN                                            
         LA    RF,HLIN6                                                         
         CLI   QDIV,C' '                                                        
         BNE   *+8                                                              
         LA    RF,HLIN5                                                         
         MVC   01(07,RF),=C'PRODUCT'                                            
         MVC   10(03,RF),PPRDKPRD                                               
         MVC   14(20,RF),PPRDNAME                                               
*                                                                               
         CLI   PAGYPROF+26,C'0'    TEST ACCT NO OPT                             
         BE    PH9                                                              
         CLI   PPRDACCT,C' '                                                    
         BNH   PH9                 NO NUMBER                                    
         LA    RF,34(RF)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   2(RF),C'('                                                       
         MVC   3(4,RF),PPRDACCT                                                 
         MVI   7(RF),C')'                                                       
*                                                                               
         CLI   PPRDACCT,X'FF'      TEST NUMERIC ACCT NO                         
         BNE   PH9                                                              
         LA    RF,3(RF)                                                         
         MVC   FULL,PPRDACCT                                                    
         MVI   FULL,0                                                           
         EDIT  (B4,FULL),(5,0(RF)),ALIGN=LEFT                                   
*                                                                               
         AR    RF,R0                                                            
         MVI   0(RF),C')'                                                       
*                                                                               
*                                                                               
         B     PH9                                                              
*                                                                               
PH8      DS    0H                                                               
         MVC   HLIN4+46(20),PCLTBNAM                                            
         MVC   HLIN5+46(30),PCLTLIN1                                            
         MVC   HLIN6+46(30),PCLTLIN2                                            
         MVC   HLIN7+46(24),PCLTATTN                                            
         MVI   PPRDKEY+1,0                                                      
*                                                                               
PH9      DS    0H                                                               
*                                  TEST SUPRESS MONTH OF SERVICE                
         CLI   PROGPROF+7,C'Y'                                                  
         BE    PH10D                                                            
         LA    R2,THISYM                                                        
         CLI   PRIORSW,C'S'                                                     
         BE    PH9B                                                             
         LA    R2,BSTART                                                        
PH9A     DS    0H                                                               
         CLI   PERSW,C'M'                                                       
         BNE   PH10B                                                            
         B     PH9C                                                             
PH9B     DS    0H                                                               
         CLC   THISYM,BSTART                                                    
         BE    PH9A                                                             
PH9C     DS    0H                                                               
         MVC   HLIN9+46(8),=C'MONTH OF'                                         
         GOTO1 DTCNV,DMCB,(1,(R2)),(5,HLIN9+55)                                 
*                                                                               
         CLI   PRIORSW,C'T'                                                     
         BNE   *+10                                                             
         MVC   HLIN9+62(11),=C'(AND PRIOR)'                                     
         B     PH10D                                                            
*                                  NON-MONTHLY PERIOD                           
PH10B    DS    0H                                                               
         MVC   HLIN9+46(7),=C'PERIOD-'                                          
         GOTO1 DTCNV,DMCB,QSTART,(3,HLIN9+54)                                   
*                                                                               
         MVC   HLIN9+59(5),=C' THRU'                                            
         GOTO1 (RF),(R1),QEND,(3,HLIN9+65)                                      
*                                                                               
         CLI   PRIORSW,C'T'                                                     
         BNE   PH10D                                                            
         MVC   HLIN9+74(11),=C'(AND PRIOR)'                                     
PH10D    DS    0H                                                               
*                                                                               
         CLC   QPROG,=C'04'                                                     
         BNE   PH11                                                             
*                                  SUMMARY BILLING                              
         MVC   HLIN11+7(7),=C'BILLING'                                          
         MVC   HLIN12+8(6),=C'PERIOD'                                           
         B     PH13                                                             
*                                  DETAIL BILLING                               
PH11     DS    0H                                                               
         CLI   HEADSW,C'D'                                                      
         BNE   PH13                NO DETAIL HLINLINES                          
         MVC   HLIN11+2(6),=C'INSERT'                                           
         CLI   QMEDIA,C'O'                                                      
         BNE   *+10                                                             
         MVC   HLIN11+2(7),=C'POSTING'                                          
         MVC   HLIN12+3(4),=C'DATE'                                             
         CLI   ESTSW,C'E'                                                       
         BNH   PH12                                                             
         MVC   HLIN12+13(3),=C'EST'                                             
         CLI   PRDSW,C'T'                                                       
         BL    PH12B                                                            
         MVC   HLIN12+11(7),=C'PRD-EST'                                         
PH12     DS    0H                                                               
         CLI   PRDSW,C'T'                                                       
         BL    PH12B                                                            
         MVC   HLIN12+11(3),=C'PRD'                                             
PH12B    DS    0H                                                               
         MVC   HLIN12+22(05),=C'SPACE'                                          
*                                                                               
PH13     DS    0H                                                               
         LA    R1,BCDETS                                                        
         LA    R0,4                                                             
         LA    R3,HLIN11+41                                                     
PH14     DS    0H                                                               
         SR    R2,R2                                                            
         IC    R2,0(R1)                                                         
         LTR   R2,R2                                                            
         BZ    PH15                                                             
         MH    R2,=H'20'                                                        
         LA    R2,HWRDS-20(R2)                                                  
         MVC   0(10,R3),0(R2)                                                   
         MVC   132(10,R3),10(R2)                                                
PH15     DS    0H                                                               
         LA    R1,1(R1)                                                         
         LA    R3,16(R3)                                                        
         BCT   R0,PH14                                                          
*                                                                               
*                                                                               
PH15B    DS    0H                                                               
*                                  PRINT HLINS 1 AT A TIME                      
         MVC   SAVEP,P                                                          
         MVC   SAVEP2,PSECOND                                                   
         MVC   SAVEM,MID1                                                       
         MVC   P,SPACES                                                         
         MVC   PSECOND,SPACES                                                   
         MVC   MID1,SPACES                                                      
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
         MVI   P,0                                                              
         MVI   PSECOND,0                                                        
         CLI   PAGYPROF+7,C'0'                                                  
         BE    PH16                                                             
*                                  ADDRESS ONLY                                 
         MVC   P+27(33),PAGYADDR                                                
         CLI   PAGYPROF+7,C'A'                                                  
         BE    PH15C                                                            
*                                  PRINT AGY NAME + ADDR                        
         MVC   P+27(33),PAGYNAME                                                
         MVC   PSECOND+27(33),PAGYADDR                                          
*                                                                               
PH15C    DS    0H                                                               
         OC    P+27(33),SPACES                                                  
         OC    PSECOND+27(33),SPACES                                            
         GOTO1 ACENTER,DMCB,P+27,33                                             
*                                                                               
         GOTO1 (RF),(R1),PSECOND+27,33                                          
*                                                                               
PH16     DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 REPORT                                                           
*                                                                               
*                                  ADJUST PAGE NUMBER                           
         MVC   HALF,PAGE                                                        
         LH    RF,HALF                                                          
         BCTR  RF,R0                                                            
         STH   RF,HALF                                                          
         MVC   PAGE,HALF                                                        
         LA    R0,12               12 HEAD LINES                                
         LA    R2,HLIN1                                                         
         MVC   SPROGTAB,IRSPROGS   INV REG                                      
         CLI   MODE,RUNLAST                                                     
         BE    PH16M                                                            
         MVC   SPROGTAB,RGSPROGS   REGULAR                                      
*                                  ADJUST SPORGS                                
         LA    RF,SPROGTAB+4                                                    
         CLI   QDIV,C' '                                                        
         BE    *+12                NO DIV                                       
         MVI   0(RF),5                                                          
         LA    RF,1(RF)                                                         
*                                                                               
         CLI   QPRODUCT,C' '                                                    
         BE    *+12                NO PRD                                       
         MVI   0(RF),6                                                          
         LA    RF,1(RF)                                                         
*                                                                               
         MVI   0(RF),7             ALWAYS EST                                   
         LA    RF,1(RF)                                                         
*                                                                               
         CLI   PESTNAM2,C' '                                                    
         BNH   PH16D                NO 2ND EST NAME                             
         CLI   ESTSW,C'T'                                                       
         BE    PH16D                                                            
         CLI   ESTSW,C'S'                                                       
         BE    PH16D                                                            
         MVI   0(RF),8                                                          
         LA    RF,1(RF)                                                         
*                                                                               
PH16D    DS    0H                                                               
         CLI   QREGION,C' '                                                     
         BE    *+12                NO REGION                                    
         MVI   0(RF),9                                                          
         LA    RF,1(RF)                                                         
*                                                                               
         CLI   QDIST,C' '                                                       
         BE    *+12                NO DIST                                      
         MVI   0(RF),10                                                         
         LA    RF,1(RF)                                                         
*                                                                               
PH16M    DS    0H                                                               
         LA    R3,SPROGTAB                                                      
PH17     DS    0H                                                               
         MVC   P,0(R2)                                                          
         MVI   P+131,0                                                          
         MVC   RCSUBPRG,0(R3)                                                   
         CLI   RCSUBPRG,8                                                       
         BNE   *+10                                                             
         MVC   P+14(20),PESTNAM2   2ND EST NAME                                 
         MVI   FORCEMID,C'Y'       FORCE EXECUTION OFSPECS                      
         GOTO1 REPORT                                                           
*                                                                               
         LA    R3,1(R3)                                                         
         LA    R2,132(R2)                                                       
         BCT   R0,PH17                                                          
*                                                                               
*                                  RE-ADJUST PAGE NUMBER                        
         MVC   HALF,PAGE                                                        
         LH    RF,HALF                                                          
         LA    RF,1(RF)                                                         
         STH   RF,HALF                                                          
         MVC   PAGE,HALF                                                        
         MVI   RCSUBPRG,0                                                       
         GOTO1 REPORT              1 SPACE                                      
*                                                                               
         MVC   P,SAVEP                                                          
         MVC   PSECOND,SAVEP2                                                   
         MVC   MID1,SAVEM                                                       
*                                                                               
         B     PH90                                                             
*                             INV REG HEADLINES                                 
PH80     DS    0H                                                               
         MVC   HLIN12+1(18),=C'PRD EST MONTH  NO.'                              
         MVC   HLIN11+15(4),=C'INV.'                                            
*                                                                               
         MVC   HLIN11+28(6),=C'ACTUAL'                                          
         MVC   HLIN12+25(11),=C'BILL AMOUNT'                                    
         MVC   HLIN12+44(8),=C'NET COST'                                        
         CLI   PAGYPROF+14,C'0'    TES CD OPT                                   
         BNE   *+16                                                             
         MVC   HLIN11+44(8),=C'NET LESS'                                        
         MVC   HLIN12+43(9),=C'CASH DISC'                                       
         MVC   HLIN11+61(6),=C'AGENCY'                                          
         MVC   HLIN12+59(10),=C'COMMISSION'                                     
         MVC   HLIN12+74(10),=C'GROSS COST'                                     
         MVC   HLIN11+94(4),=C'CASH'                                            
         MVC   HLIN12+92(8),=C'DISCOUNT'                                        
         B     PH15B                                                            
*                                                                               
*                             MID LINES                                         
PH90     DS    0H                                                               
         CLC   MID1,SPACES                                                      
         BNE   *+10                                                             
         MVC   MID1,SAVMID                                                      
         B     PHX                                                              
*                                                                               
PHX      DS    0H                                                               
         XIT1                                                                   
*                                                                               
IRSPROGS DC    AL1(101,102,103,104,105,106,107,108,109,110,111,112)             
RGSPROGS DC    AL1(1,2,3,4,99,99,99,99,99,99,11,12)                             
*                                                                               
HWRDS    DS    0C                                                               
         DC    C'          '                                                    
         DC    C'GROSS COST'                                                    
         DC    C'          '                                                    
         DC    C'  NET COST'                                                    
         DC    C'    CASH  '                                                    
         DC    C'  DISCOUNT'                                                    
         DC    C'          '                                                    
         DC    C'          '                                                    
         DC    C'GROSS LESS'                                                    
         DC    C'CASH DISC.'                                                    
         DC    C' NET LESS '                                                    
         DC    C'CASH DISC.'                                                    
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'PRTACC - PRINT ACCUMS'                                          
PRTACC   CSECT                                                                  
         NMOD1 0,**PACC                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         USING PBILWRKD,R8                                                      
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         SPACE 2                                                                
         MVC   SAVMID,SPACES                                                    
         OC    BSNUM,BSNUM         NOTHING IN TABLE                             
         BZ    PRAX                                                             
         MVC   HLDNXTYM,=2X'FF'                                                 
         XC    TADJBASA(16),TADJBASA                                            
         ZAP   TRCVBL1,=P'0'                                                    
         ZAP   TRCVBL2,=P'0'                                                    
         ZAP   TRCVBL3,=P'0'                                                    
         MVI   ADJCOL,0                                                         
         XC    BFORMSAV,BFORMSAV                                                
         L     R2,BSTAB            A(TABLE)                                     
         USING POSTKEYD,R2                                                      
PRA2     DS    0H                                                               
         CLI   POSTKPRD,0                                                       
         BE    PRA60               END OF TABLE                                 
         CLI   PRIORSW,C'S'        PRIOR SEP                                    
         BNE   PRA4                                                             
         CLC   NXTYM,POSTKYM                                                    
         BH    PRA40                                                            
         BE    PRA4                                                             
         MVC   HLDNXTYM,POSTKYM                                                 
         B     PRA60          ** NOTE- CHANGED FROM PRA40 ON 10/25/84           
PRA4     DS    0H                                                               
         CLI   PRDSW,C'T'          MULTI PROD                                   
         BNL   PRA5                YES                                          
         CLI   CMNTCD,C'C'         CD INV                                       
         BE    PRA9                YES                                          
         CLC   QPROG,=C'06'        NO- DETAIL BILL                              
         BNE   PRA9                                                             
         MVI   DUESW,C'D'                                                       
         B     PRA15               PRINT ONLY SUMMARIES                         
PRA5     DS    0H                                                               
         C     R2,BSTAB                                                         
         BE    PRA6                FIRST                                        
         LR    R4,R2                                                            
         S     R4,BSLEN                                                         
         CLC   POSTKPRD,0(R4)      TEST PRD VS LAST                             
         BE    PRA8                                                             
*                                                                               
PRA6     DS    0H                                                               
         MVI   LNEED,4                                                          
         MVI   DUESW,0                                                          
         CLI   POSTKPRD,X'FF'                                                   
         BNE   PRA7                                                             
         MVC   MID1+1(19),=C'** CLIENT TOTALS **'                               
         CLI   QDIV,C' '                                                        
         BE    *+10                                                             
         MVC   MID1+1(21),=C'** DIVISION TOTALS **'                             
         MVI   DUESW,C'D'                                                       
         B     PRA8                                                             
*                                                                               
PRA7     DS    0H                                                               
         MVC   WORK(3),POSTKPRD                                                 
         MVC   WORK+5(2),=2X'FF'                                                
         XC    WORK+3(2),WORK+3                                                 
         GOTO1 AGETFORM,DMCB,WORK       GET PRD NAME                            
*                                                                               
         L     R3,DMCB+4                                                        
         USING HDRKEYD,R3                                                       
         MVC   MID1+1(7),=C'PRODUCT'                                            
         MVC   MID1+9(3),POSTKPRD                                               
         MVC   MID1+14(20),HDRNAME                                              
         CLI   PAGYPROF+26,C'0'    TEST ACCT NO. OPT                            
         BE    PRA8                NO                                           
         CLI   HDRACCT,C' '                                                     
         BNH   PRA8                NO NUMBER                                    
         LA    RF,MID1+35                                                       
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   2(RF),C'('                                                       
         MVC   3(4,RF),HDRACCT                                                  
         MVI   7(RF),C')'                                                       
*                                                                               
         CLI   PPRDACCT,X'FF'      TEST NUMERIC ACCT NO                         
         BNE   PRA8                                                             
         LA    RF,3(RF)                                                         
         MVC   FULL,PPRDACCT                                                    
         MVI   FULL,0                                                           
         EDIT  (B4,FULL),(5,0(RF)),ALIGN=LEFT                                   
*                                                                               
         AR    RF,R0                                                            
         MVI   1(RF),C')'                                                       
*                                                                               
*                                                                               
PRA8     DS    0H                                                               
PRA8B    DS    0H                                                               
*                                                                               
PRA9     DS    0H                                                               
         CLI   POSTKEST,X'FF'                                                   
         BE    PRA9B                                                            
         CLI   ESTSW,C'E'                                                       
         BH    PRA40               IGNORE INDIVIDUAL ESTS                       
PRA9B    DS    0H                                                               
         BAS   RE,PRTMON                                                        
*                                                                               
         CLI   PRIORSW,C'T'                                                     
         BNE   PRA10                                                            
         CLI   POSTKYM,X'FF'                                                    
         BNE   PRA20                                                            
PRA10    DS    0H                                                               
         CLI   CMNTCD,C'C'                                                      
         BE    PRA18                                                            
         CLI   REVSW,C'R'          TEST PRINTING REVLST                         
         BNE   PRA17                                                            
PRA15    DS    0H                                                               
         CLI   POSTKEST,X'FF'                                                   
         BE    PRA15B                                                           
         CLI   ESTSW,C'E'                                                       
         BH    PRA40               IGNORE INDIVIDUAL ESTIMATES                  
PRA15B   DS    0H                                                               
         CLI   POSTKPRD,X'FF'                                                   
         BE    PRA17                                                            
PRA16    GOTO1 AREVPRT,DMCB,POSTKEY     PRINT REVERSALS                         
PRA17    DS    0H                                                               
         GOTO1 APRTDUE,DMCB,POSTKEY                                             
*                                                                               
PRA18    DS    0H                                                               
*                                                                               
PRA20    DS    0H                                                               
PRA40    DS    0H                                                               
         A     R2,BSLEN                                                         
         B     PRA2                                                             
*                                                                               
PRA60    DS    0H                                                               
         CLI   CMNTCD,C'C'         IF PRINTING SEP CD INV NOW                   
         BE    PRAX                JUST RETURN TO CDINV                         
         MVC   NXTYM,HLDNXTYM                                                   
PRAX     DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
PRTMON   NTR1                                                                   
         SPACE 2                                                                
         MVI   TOTSW,0                                                          
         MVI   SPACING,1                                                        
         CLI   PERSW,C'S'                                                       
         BNE   PRM2                                                             
         CLC   POSTKYM,BSTART                                                   
         BNE   PRM2                                                             
*                                  START-END                                    
         GOTO1 DTCNV,DMCB,(1,BSTART),(3,P+4)                                    
*                                                                               
         GOTO1 (RF),(R1),(1,BEND),(3,P+4+6)                                     
*                                                                               
         MVI   P+4+5,C'-'                                                       
         B     PRM4                                                             
*                                  MONTH                                        
PRM2     DS    0H                                                               
         CLI   POSTKYM,X'FF'                                                    
         BNE   PRM3                                                             
         CLI   PRIORSW,C'T'        TOTALS ONLY IF PRIOR MONTHS                  
         BNE   PRTMONX                                                          
         MVI   SPACING,2                                                        
         MVC   P+8(7),=C'*TOTAL*'                                               
         B     PRM5                                                             
PRM3     DS    0H                                                               
         GOTO1 DTCNV,DMCB,(1,POSTKYM),(5,P+8)                                   
*                                                                               
PRM4     DS    0H                                                               
PRM5     DS    0H                                                               
         CLI   POSTKYM,X'FF'                                                    
         BNE   *+8                                                              
         MVI   TOTSW,1                                                          
*                                                                               
         CLI   PRIORSW,C'T'                                                     
         BE    *+8                                                              
         MVI   SPACING,2                                                        
         NI    PREVSW,X'80'                                                     
         TM    PREVSW,X'80'        TEST HAVE PREVIOUS BILLING                   
         BZ    PRM6                NO                                           
         CLI   REVSW,C'R'          IF PRINTING REVERSALS - NO PREVIOUS          
         BNE   PRM5C                                                            
         CLI   POSTKPRD,X'FF'      UNLESS DOING CLIENT TOTALS                   
         BE    PRM5C                                                            
         CLI   CMNTCD,C'C'         OR SEP CASH DISC INV                         
         BE    PRM5C                                                            
         OI    PREVSW,X'40'                                                     
         B     PRM6                                                             
PRM5C    DS    0H                                                               
         MVI   LNEED,4                                                          
         MVC   P+21(7),=C'ORDERED'                                              
         MVI   SPACING,1                                                        
*                                                                               
PRM6     DS    0H                                                               
         CLC   POSTBY,POSTBL       IF ORDERED = BILLED                          
*                                  NOOP EQUAL TEST                              
         B     PRM7                DONT PRINT                                   
         CLC   QPROG,=C'06'        UNLESS DETAIL BILLING                        
         BNE   PRTMONX                                                          
PRM7     DS    0H                                                               
         MVI   DUESW,C'D'                                                       
         GOTO1 AFMTLIN,DMCB,POSTBY                                              
         GOTO1 APRNT                                                            
         TM    PREVSW,X'C0'                                                     
         BNM   PRTMONX                                                          
*                                                                               
         MVI   TOTSW,C'('                                                       
         MVC   P+21(16),=C'PREVIOUS BILLING'                                    
         GOTO1 AFMTLIN,(R1),POSTBL                                              
         GOTO1 APRNT                                                            
         MVC   X(24),POSTBY                                                     
         LM    R4,R6,X                                                          
         S     R4,X+12                                                          
         S     R5,X+16                                                          
         S     R6,X+20                                                          
         STM   R4,R6,X                                                          
         MVI   SPACING,2                                                        
         MVC   P+21(7),=C'BALANCE'                                              
         CLI   POSTKYM,X'FF'                                                    
         BNE   *+8                                                              
         MVI   TOTSW,1                                                          
         GOTO1 AFMTLIN,DMCB,X                                                   
*                                                                               
         GOTO1 APRNT                                                            
         SPACE 2                                                                
PRM8     DS    0H                                                               
PRTMONX  DS    0H                                                               
         MVC   P,SPACES                                                         
         XIT1                                                                   
         SPACE 3                                                                
         DROP  R2,R3                                                            
         LTORG                                                                  
         TITLE 'PRTDUE - FINISH PRODUCT OR INVOICE'                             
PRTDUE   CSECT                                                                  
         NMOD1 0,**PDUE                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         USING PBILWRKD,R8                                                      
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         L     R2,DMCB                                                          
         USING POSTKEYD,R2                                                      
         SPACE 2                                                                
         CLI   POSTKPRD,X'FF'                                                   
         BE    PD3                 CLT TOTS                                     
*                                                                               
         GOTO1 AGETFORM,DMCB,POSTKEY                                            
*                                  ADD TO ADJ TOTS                              
         LM    R4,R7,TADJBASA                                                   
         A     R4,ADJBASA                                                       
         A     R5,ADJBASB                                                       
         A     R6,ADJAMT                                                        
         A     R7,ADJBIL                                                        
         STM   R4,R7,TADJBASA                                                   
*                                                                               
         AP    TRCVBL1,RCVBL1                                                   
         AP    TRCVBL2,RCVBL2                                                   
         AP    TRCVBL3,RCVBL3                                                   
*                                                                               
PD3      DS    0H                                                               
         GOTO1 APRNT               SKIP A LINE                                  
         BAS   RE,PRTFORM                                                       
         CLI   POSTKPRD,X'FF'                                                   
         BE    PD4                                                              
         CLI   PRDSW,C'T'                                                       
         BNL   PDX                                                              
PD4      DS    0H                                                               
         LA    R3,MASTPRD                                                       
         USING HDRKEYD,R3                                                       
         CLI   BILRDSW,C'S'        SEP INV FOR REG/DST                          
         DROP  R3                                                               
         BE    PD4A                YES                                          
         MVI   PREGKEY,0           NO - SUPPRESS REG/DST                        
         MVI   PDSTKEY,0                                                        
PD4A     DS    0H                                                               
         MVC   LASTPINV,PINVNO                                                  
         MVC   SAVMID,SPACES                                                    
         BAS   RE,CDINV            C.D. BILL                                    
*                                                                               
PD5      DS    0H                                                               
         CP    RCVBL3,=P'0'                                                     
         BE    PDX                                                              
         BAS   RE,ADJINV           ADJ. BILL SEP                                
*                                                                               
PDX      DS    0H                                                               
         MVC   PREGKEY(1),PAGYKEY  RESTORE REG/DST HDRS                         
         MVC   PDSTKEY(1),PAGYKEY                                               
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
         SPACE 2                                                                
PRTFORM  NTR1                                                                   
         SPACE 2                                                                
         CLI   POSTKPRD,X'FF'      CLT TOTS                                     
         BNE   PF3                                                              
         MVC   BFORM,BFORMSAV                                                   
         MVC   ADJBASA(16),TADJBASA     MOVE TOTALS                             
         MVC   RCVBL1(15),TRCVBL1                                               
         B     PF4C                                                             
PF3      DS    0H                                                               
         CLI   BFORMSAV,0                                                       
         BNE   *+14                                                             
         MVC   BFORMSAV,BFORM                                                   
         B     PF4                                                              
         CLC   BFORM(1),BFORMSAV                                                
         BE    *+8                                                              
         MVI   BFORMSAV,C'U'            UNEQUAL BASA                            
         CLC   BFORM+1(1),BFORMSAV+1                                            
         BE    *+8                                                              
         MVI   BFORMSAV,C'U'          UNEQUAL BASB                              
         OC    BFORMSAV+2(1),BFORM+2                                            
PF4      DS    0H                                                               
         CLI   POSTKPRD,X'FF'                                                   
         BE    PF4C                                                             
         CLI   PRDSW,C'T'                                                       
         BL    PF4C                                                             
         CLI   FORMSW,C'0'                                                      
         BE    PFX                                                              
         CLI   SEPSW,C'S'                                                       
         BE    PFX                                                              
*                             ADJUST PRODUCT TOTALS ON MULTI-PRD INV            
*                              OR 1-PRD INV                                     
PF4C     DS    0H                                                               
         CLI   ADJCOL,0                                                         
         BNE   PF8                                                              
*                             FIND WHAT COL TO PUT ADJS IN                      
         MVC   BYTE,BFORM                                                       
         CLI   CDSEPSW,C'S'                                                     
         BNE   *+8                                                              
         NI    BYTE,X'FB'          REMOVE CD                                    
         LA    R4,BCDETS+1         START AT COL 2                               
         LA    R5,2                                                             
PF5      DS    0H                                                               
         CLC   BYTE,0(R4)          BILBASA COL                                  
         BE    PF6                                                              
         LA    R4,1(R4)                                                         
         BCT   R5,PF5                                                           
*                                  NO - USE 3 OR 2                              
         LA    R4,3                                                             
         CLI   BCDETS+2,0                                                       
         BNE   *+8                                                              
         LA    R4,2                                                             
         B     PF7                                                              
*                                                                               
PF6      DS    0H                                                               
         LA    R0,BCDETS-1                                                      
         SR    R4,R0                                                            
*                                                                               
PF7      DS    0H                                                               
         STC   R4,ADJCOL                                                        
         SLL   R4,4                                                             
         LA    R4,P+05(R4)                                                      
         ST    R4,ADJCOLA          A(ADJ COL - 16 BYTES)                        
*                                                                               
PF8      DS    0H                                                               
         MVI   HALF,0                                                           
         OC    BFORM+2(3),BFORM+2                                               
         BZ    PF10                NO ADJ                                       
         CLI   BFORM,C'U'                                                       
         BE    PF16                                                             
         OC    ADJBASA(16),ADJBASA     NO BASA,BASB,ADJ, OR DUE                 
         BZ    PF16                                                             
         CLI   SEPSW,C'S'                                                       
         BE    PF10                                                             
*                                  IS BASB SOMEWHERE ON BILL                    
         LA    R4,BCDETS                                                        
         LA    R5,3                                                             
PF9      DS    0H                                                               
         CLC   BFORM+1(1),0(R4)                                                 
         BE    PF10                YES                                          
         LA    R4,1(R4)                                                         
         BCT   R5,PF9                                                           
*                                  NO - PRINT IT                                
         SR    R4,R4                                                            
         IC    R4,BFORM+1                                                       
         MH    R4,=H'24'                                                        
         LA    R4,LINWRDS-24(R4)                                                
         L     R5,ADJCOLA                                                       
         MVC   2(12,R5),0(R4)           P                                       
         MVC   134(12,R5),12(R4)        PSECOND                                 
         L     R1,ADJBASB                                                       
         BAS   RE,PFEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
         MVI   HALF,C'P'        SET HAVE PRINTED BASEB                          
PF10     DS    0H                                                               
         MVC   BYTE,BFORM                                                       
         MVC   FULL,ADJBASA                                                     
         CLI   CDSEPSW,C'R'                                                     
         BE    PF10B                                                            
         CLI   CDSEPSW,C'C'                                                     
         BE    PF10B                                                            
         TM    BYTE,X'04'          TEST CD PRESENT                              
         BZ    PF10B               NO                                           
         NI    BYTE,X'FB'          REMOVE CD                                    
         MVC   DUB(4),POSTBY+8                                                  
         MVC   DUB+4(4),POSTBL+8                                                
         L     R0,FULL                                                          
         A     R0,DUB                                                           
         S     R0,DUB+4                                                         
         ST    R0,FULL                                                          
PF10B     DS    0H                                                              
         CLI   HALF,C'P'           TEST HAVE PRINTED BASB                       
         BNE   PF10C               NO                                           
         CLC   BYTE,BFORM+1        YES - US BASA=BASB                           
         BE    PF12                YES NO NEED TO PRINT IT                      
         B     PF11                NO - PRINT IT                                
PF10C    DS    0H                                                               
         SR    R4,R4                                                            
         IC    R4,ADJCOL                                                        
         LA    R4,BCDETS-1(R4)                                                  
*                                  IS BASA IN ADJ COL                           
         CLC   0(1,R4),BYTE                                                     
         BE    PF12                                                             
*                                                                               
PF11     DS    0H                  PRINT BASE A                                 
         SR    R4,R4                                                            
         IC    R4,BYTE                                                          
         MH    R4,=H'24'                                                        
         LA    R4,LINWRDS-24(R4)                                                
         L     R5,ADJCOLA                                                       
         MVC   2(12,R5),0(R4)                                                   
         MVC   134(12,R5),12(R4)                                                
         L     R1,FULL                                                          
         BAS   RE,PFEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                             PRINT ADJ PHRASE + AMT                            
*                             LESS (PLUS) XX.XXXX PERCENT OF (BASB)             
PF12     DS    0H                                                               
         OC    ADJAMT,ADJAMT                                                    
         BZ    PF16                                                             
         CLI   SEPSW,C'S'                                                       
         BE    PF16                                                             
         MVI   X,C' '                                                           
         MVC   X+1(L'X-1),X                                                     
         MVC   X(4),=C'LESS'                                                    
         TM    BFORM+2,X'80'                                                    
         BNZ   *+10                                                             
         MVC   X(4),=C'PLUS'                                                    
         CLI   POSTKPRD,X'FF'                                                   
         BNE   PF13                                                             
         MVC   X+5(10),=C'ADJUSTMENT'                                           
         B     PF14                                                             
PF13     DS    0H                                                               
         EDIT  (B3,BFORM+2),(8,X+5),4                                           
*                                                                               
         LA    R4,X+12                                                          
         CLI   0(R4),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(R4),C' '                                                       
         BCT   R4,*-12                                                          
*                                                                               
         CLI   0(R4),C'.'                                                       
         BNE   *+10                                                             
         MVI   0(R4),C' '                                                       
         BCTR  R4,R0                                                            
         MVC   2(10,R4),=C'PERCENT OF'                                          
         SR    R5,R5                                                            
         IC    R5,BFORM+1                                                       
         MH    R5,=H'15'                                                        
         LA    R5,ADJWRDS-15(R5)                                                
         MVC   13(15,R4),0(R5)                                                  
PF14     DS    0H                                                               
         LA    R4,X+39             MAX LEN US 40                                
         CLI   0(R4),C' '                                                       
         BH    *+8                                                              
         BCT   R4,*-8                                                           
*                                                                               
         LA    R0,X-1                                                           
         SR    R4,R0               R4 = LENGTH OF PHRASE                        
         L     R5,ADJCOLA                                                       
         LA    R6,14(R5)                                                        
         SR    R6,R4                                                            
         MVC   0(40,R6),X                                                       
         L     R1,ADJAMT                                                        
         BAS   RE,PFEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                  BOTTOM LINE                                  
PF16     DS    0H                                                               
         L     R5,ADJCOLA                                                       
         SH    R5,=H'5'                                                         
         MVC   0(19,R5),=C'   ** AMOUNT DUE **'                                 
         CP    RCVBL1,=P'0'        TEST CREDIT BILL                             
         BNL   *+10                                                             
         MVC   0(19,R5),=C'** CREDIT AMOUNT **'                                 
         CLI   POSTKPRD,X'FF'                                                   
         BNE   *+10                                                             
         MVC   0(19,R5),=C'** INVOICE TOTAL **'                                 
         L     R5,ADJCOLA                                                       
         ZAP   DUB,RCVBL1                                                       
         CVB   R1,DUB                                                           
*                                  TEST FOR SPECIAL CD HANDLING                 
         CLI   CDSEPSW,C'C'                                                     
         BNE   PF16B               NO                                           
*                                  PRINT DUE AMOUNT IF ANY FORMULAADJ           
         OC    ADJAMT,ADJAMT                                                    
         BZ    PF1600                                                           
         MVI   TOTSW,2                                                          
         BAS   RE,PFEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
PF1600   DS    0H                                                               
*                                  TEST CD COLUMN ON BILL                       
         MVI   CDCOLSW,0                                                        
         CLI   BCDETS+0,3                                                       
         BE    PF160A                                                           
         CLI   BCDETS+1,3                                                       
         BE    PF160A                                                           
         CLI   BCDETS+2,3                                                       
         BNE   PF160B                                                           
*                                                                               
PF160A   DS    0H                  IF CD COLUMN THEN                            
         MVI   CDCOLSW,C'Y'                                                     
         LTR   R1,R1               BILL MUST BE POSITIVE                        
         BZ    PF16A                                                            
         BM    PF16B                                                            
*                                                                               
PF160B   DS    0H                                                               
         MVC   DUB(4),POSTBY+8                                                  
         MVC   DUB+4(4),POSTBL+8                                                
         L     R6,DUB                                                           
         S     R6,DUB+4                                                         
*                                                                               
         CLI   CDCOLSW,C'Y'        IF CD COLUMN THEN                            
         BNE   PF160C                                                           
         LTR   R6,R6                                                            
         BNP   PF16B               CD MUST ALSO BE POSITIVE                     
PF160C   DS    0H                                                               
*                                                                               
         TM    BFORM,X'04'          TEST CD IN FORMUAL                          
         BZ    PF160D              NO                                           
*                                  HERE FOR SPECIAL NO C.D. BILLING             
*                                                                               
PF160    DS    0H                                                               
         SH    R5,=H'4'                                                         
         MVC   0(18,R5),=C'** GROSS AMOUNT **'                                  
         TM    BFORM,X'01'                                                      
         BNZ   *+10                                                             
         MVC   0(8,R5),=C'  ** NET'                                             
*                                                                               
         AR    R1,R6               PUT CD BACK IN                               
         L     R5,ADJCOLA                                                       
         BAS   RE,PFEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
PF160D   DS    0H                                                               
         L     R5,ADJCOLA                                                       
         SH    R5,=H'19'                                                        
         CLI   CDCOLSW,C'Y'        TEST HAVE CD COLUMN                          
         BNE   PF160E                                                           
PF160D2 DS     0H                                                               
         MVC   6(27,R5),=C'IF PAID BY DUE DATE, DEDUCT'                         
         B     PF160F                                                           
*                                  DIFFERENT MSGS IF NO CD COLUMN               
PF160E   DS    0H                                                               
         MVC   0(33,R5),SPACES                                                  
         LTR   R6,R6               IF NO CD THEN NO MSG                         
         BZ    PF16D                                                            
         BM    PF160E2                                                          
         MVC   13(20,R5),=C'IF PAID BY DUE DATE,'                               
         MVC   132+13(20,R5),=C'DEDUCT CASH DISCOUNT'                           
         B     PF160F                                                           
PF160E2  DS    0H                                                               
         MVC   0(33,R5),=C'CASH DISCOUNT PREVIOUSLY DEDUCTED'                   
PF160F   DS    0H                                                               
         L     R5,ADJCOLA                                                       
         LR    R1,R6                                                            
         MVI   TOTSW,0                                                          
         BAS   RE,PFEDIT                                                        
         GOTO1 APRNT                                                            
*                                  BJ SPECIAL                                   
         TM    BFORM,X'04'          ONLY IF CD NOT IN FORMULA                   
         BNZ   PF16D                                                            
         CLI   CDCOLSW,C'Y'        IF DONT HAVE CD COLUMN                       
         BE    PF16D                                                            
         LTR   R6,R6               AND CD IS CREDIT                             
         BNM   PF16D                                                            
*                                                                               
         GOTO1 APRNT                                                            
         L     R5,ADJCOLA                                                       
         SH    R5,=H'5'                                                         
         MVC   0(19,R5),=C'** ACTUAL AMOUNT **'                                 
         ZAP   DUB,RCVBL1                                                       
         CVB   R1,DUB                                                           
         SR    R1,R6                                                            
         L     R5,ADJCOLA                                                       
         BAS   RE,PFEDIT                                                        
         GOTO1 APRNT                                                            
*                                                                               
         B     PF16D                                                            
*                                                                               
PF16A    DS    0H                                                               
         CLI   DUESW,0                                                          
         BE    PF16D                                                            
PF16B    DS    0H                                                               
         MVI   TOTSW,2                                                          
         BAS   RE,PFEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
PF16D    DS    0H                                                               
         CLI   PRDSW,C'T'          NO COMMENTS ON MULTI-PROD BILL               
         BL    PF17                                                             
         CLI   POSTKPRD,X'FF'      EXCEPT AT CLT TOTS                           
         BNE   PFX                                                              
PF17     DS    0H                                                               
         MVI   CMNTCD,C'R'                                                      
         BAS   RE,PRTCMNT          PRINT COMMENTS                               
*                                                                               
PFX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*                             PRINT SEP CDINV                                   
         SPACE 2                                                                
CDINV    NTR1                                                                   
         SPACE 2                                                                
         CLI   CDSEPSW,C'S'                                                     
         BNE   CDINV4                                                           
         GOTO1 AGETNUM             GET NEW INV NO - N+1                         
*                                                                               
         CP    RCVBL2,=P'0'                                                     
         BE    CDINV4                                                           
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
         MVC   SVBCDETS,BCDETS                                                  
         MVC   BCDETS,=X'00030000' CD ONLY                                      
*                                                                               
*                                                                               
         MVI   SPACING,3                                                        
         GOTO1 APRNT                                                            
*                                                                               
         MVC   P+18(49),=C'**  THIS INVOICE REPRESENTS CASH DISCOUNTS OX        
               F  **'                                                           
         MVC   PSECOND+18(49),=C'**  ITEMS BILLED ON INVOICE NO. NN-NN-X        
               NNNN     **'                                                     
         MVC   PSECOND+18+32(10),LASTPINV                                       
         MVI   SPACING,3                                                        
         GOTO1 APRNT                                                            
*                                                                               
         MVI   CMNTCD,C'C'                                                      
         GOTO1 APRTACC                                                          
*                                                                               
         MVC   BCDETS,SVBCDETS                                                  
*                                                                               
         LA    R5,P+32                                                          
         MVC   0(19,R5),=C'   ** AMOUNT DUE **'                                 
         CP    RCVBL2,=P'0'                                                     
         BNL   *+10                                                             
         MVC   0(19,R5),=C'** CREDIT AMOUNT **'                                 
         CLI   POSTKPRD,X'FF'                                                   
         BNE   *+10                                                             
         MVC   0(19,R5),=C'** INVOICE TOTAL **'                                 
         LA    R5,P+37                                                          
         ZAP   DUB,RCVBL2                                                       
         CVB   R1,DUB                                                           
         BAS   RE,PFEDIT                                                        
         MVI   SPACING,3                                                        
         GOTO1 APRNT                                                            
*                                                                               
         BAS   RE,PRTCMNT                                                       
*                                                                               
CDINV4   DS    0H                                                               
         MVI   CMNTCD,C'A'                                                      
         XIT1                                                                   
         EJECT                                                                  
*                             PRINT SEP ADJ INV                                 
         SPACE 2                                                                
         MVI   TOTSW,2                                                          
ADJINV   NTR1                                                                   
         SPACE 2                                                                
         MVC   SVBCDETS,BCDETS                                                  
         XC    BCDETS,BCDETS                                                    
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         GOTO1 AGETNUM             GET NEW INVOICE NO. N+1                      
*                                                                               
         MVI   SPACING,3                                                        
         GOTO1 APRNT                                                            
*                                                                               
         MVC   P+26(32),=C'**  COMMISSION ADJUSTMENT OF  **'                    
         MVC   PSECOND+26(32),=C'**  INVOICE NO. NN-NN-NNNN    **'              
         MVC   PSECOND+26+16(10),LASTPINV                                       
         MVI   SPACING,3                                                        
         GOTO1 APRNT                                                            
*                                                                               
         SR    R3,R3                                                            
         IC    R3,BFORM+1          BASB                                         
         MH    R3,=H'24'                                                        
         LA    R3,LINWRDS-24(R3)                                                
*                                                                               
         LA    R5,P+37                                                          
         MVC   002(12,R5),0(R3)                                                 
         MVC   134(12,R5),12(R3)                                                
*                                                                               
         L     R1,ADJBASB                                                       
         MVI   TOTSW,0                                                          
         BAS   RE,PFEDIT                                                        
*                                                                               
         MVI   SPACING,3                                                        
         GOTO1 APRNT                                                            
*                                                                               
         MVI   X,C' '                                                           
         MVC   X+1(L'X-1),X                                                     
         MVI   X,C'('                                                           
         EDIT  (B3,BFORM+2),(8,X+1),4                                           
*                                                                               
         LA    R4,X+8                                                           
         CLI   0(R4),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(R4),C' '                                                       
         BCT   R4,*-12                                                          
*                                                                               
         CLI   0(R4),C'.'                                                       
         BNE   *+10                                                             
         MVI   0(R4),C' '                                                       
         BCTR  R4,R0                                                            
         MVC   2(17,R4),=C'PERCENT OF ABOVE)'                                   
         LA    R0,X-18                                                          
         SR    R4,R0               R4 = LENGTH                                  
         LA    RF,P+50                                                          
         SR    RF,R4                                                            
         MVC   132(27,RF),X        PSECOND                                      
         MVC   0(21,RF),=C'COMMISSION ADJUSTMENT'                               
*                                                                               
         L     R1,ADJAMT                                                        
         MVI   TOTSW,2                                                          
         BAS   RE,PFEDIT                                                        
         MVI   SPACING,3                                                        
         GOTO1 APRNT                                                            
*                                                                               
         MVI   CMNTCD,C'A'                                                      
         BAS   RE,PRTCMNT                                                       
*                                                                               
         MVC   BCDETS,SVBCDETS                                                  
         XIT1                                                                   
         SPACE 3                                                                
PFEDIT   DS    0H                                                               
         EDIT  (R1),(16,16(R5)),2,COMMAS=YES,CR=YES                             
*                                                                               
         CLI   TOTSW,0                                                          
         BER   RE                                                               
         LA    RF,30(R5)                                                        
         CLI   0(RF),C'C'          CR                                           
         BNE   *+8                                                              
         LA    RF,2(RF)                                                         
         MVI   0(RF),C'*'                                                       
         CLI   TOTSW,1                                                          
         BER   RE                                                               
         MVI   1(RF),C'*'                                                       
         BR    RE                                                               
         EJECT                                                                  
*                             PRINT COMMENTS                                    
         SPACE 2                                                                
PRTCMNT  NTR1                                                                   
         SPACE 2                                                                
         MVC   SAVMID,SPACES                                                    
         XC    SAVKEY,SAVKEY                                                    
         LA    R3,MASTHDR                                                       
         USING HDRKEYD,R3                                                       
         LA    R4,BILCMNTS                                                      
         LA    R5,3                                                             
PRTC2    DS    0H                                                               
         LA    RF,X'80'                                                         
         CLI   CMNTCD,C'R'         REG                                          
         BE    PRTC3                                                            
         LA    RF,X'40'                                                         
         CLI   CMNTCD,C'C'                                                      
         BE    PRTC3                                                            
         LA    RF,X'20'                                                         
PRTC3    DS    0H                                                               
         EX    RF,PRTCTM                                                        
         BZ    PRTC13                                                           
         MVC   WORK,KEY                                                         
         XC    KEY,KEY                                                          
         MVC   KEY(3),RCSVAGY                                                   
         MVI   KEY+3,X'40'                                                      
         MVC   KEY+4(6),1(R4)                                                   
         L     RF,ACOMREC                                                       
         CLC   KEY(25),0(RF)                                                    
         BE    PRTC4               ALREADY HAVE                                 
         OC    SAVKEY,SAVKEY                                                    
         BNZ   *+10                                                             
         MVC   SAVKEY,WORK                                                      
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BNE   PRTC13                                                           
*                                                                               
         XC    LASTDA,LASTDA       RESET LAST IO                                
         GOTO1 GET,DMCB,ACOMREC                                                 
*                                                                               
PRTC4    DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                  COUNT LINES NEEDED                           
         SR    RF,RF                                                            
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
         SR    R0,R0                                                            
PRTC6    DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    PRTC9                                                            
         CLI   0(R2),X'40'                                                      
         BNE   PRTC8                                                            
         LA    R0,1                                                             
         CLI   2(R2),C'+'                                                       
         BNE   PRTC7                                                            
         CLI   3(R2),C'1'                                                       
         BL    PRTC7                                                            
         MVC   BYTE,3(R2)                                                       
         NI    BYTE,X'0F'                                                       
         IC    R0,BYTE                                                          
PRTC7    DS    0H                                                               
         AR    RF,R0                                                            
PRTC8    DS    0H                                                               
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PRTC6                                                            
*                                                                               
PRTC9    DS    0H                                                               
         LA    RF,1(RF)                                                         
         STC   RF,LNEED            NUMBER OF LINES NEEDED                       
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
PRTC10   DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    PRTC13                                                           
         CLI   0(R2),X'40'                                                      
         BNE   PRTC12                                                           
         LA    R6,2                                                             
         CLI   2(R2),C'+'                                                       
         BNE   PRTC11                                                           
         CLI   3(R2),C'1'                                                       
         BL    PRTC11                                                           
         MVC   SPACING,3(R2)                                                    
         NI    SPACING,X'0F'                                                    
         GOTO1 APRNT                                                            
*                                                                               
         LA    R6,4                                                             
PRTC11   DS    0H                                                               
         IC    RF,1(R2)                                                         
         SR    RF,R6                                                            
         AR    R6,R2                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P+8(0),0(R6)                                                     
*                                                                               
         GOTO1 APRNT                                                            
*                                                                               
PRTC12   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PRTC10                                                           
*                                                                               
PRTC13   DS    0H                                                               
         LA    R4,7(R4)                                                         
         BCT   5,PRTC2                                                          
*                                                                               
*                                                                               
         OC    SAVKEY,SAVKEY                                                    
         BZ    PRTC20                                                           
         MVC   KEY,SAVKEY                                                       
         GOTO1 HIGH                                                             
*                                                                               
PRTC20   DS    0H                                                               
PRTCX    DS    0H                                                               
         XIT1                                                                   
PRTCTM   TM    0(R4),X'00'                                                      
         SPACE 3                                                                
*                                                                               
LINWRDS  DS    0C                                                               
         DC    CL12'GROSS AMOUNT'                                               
         DC    CL12'            '                                               
         DC    CL12'  NET AMOUNT'                                               
         DC    CL12'            '                                               
         DC    CL12'            '                                               
         DC    CL12'            '                                               
         DC    CL12'            '                                               
         DC    CL12'            '                                               
         DC    CL12'  GROSS LESS'                                               
         DC    CL12'  CASH DISC.'                                               
         DC    CL12'  NET LESS  '                                               
         DC    CL12'  CASH DISC.'                                               
*                                                                               
ADJWRDS  DS    0C                                                               
         DC    CL15'GROSS'                                                      
         DC    CL15'NET'                                                        
         DC    CL15' '                                                          
         DC    CL15' '                                                          
         DC    CL15'GROSS LESS C.D.'                                            
         DC    CL15'NET LESS C.D.'                                              
         SPACE 3                                                                
         DROP  R2                                                               
         LTORG                                                                  
         TITLE 'PRINTPAK BILLING - INTERFACE TAPE MODULE'                       
PBINTAP  CSECT                                                                  
         NMOD1 0,PBINTAP                                                        
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         USING PPFILED,RC,R9                                                    
         L     RC,PPFILEC                                                       
         USING PBILWRKD,R8                                                      
*                                                                               
         CLI   RCWRITE,C'Y'                                                     
         BNE   PBIEXIT                                                          
*                                                                               
         SPACE 2                                                                
         CLI   PAGYPROF+21,C'0'    NO INTERFACE                                 
         BE    PBIEXIT                                                          
*                                                                               
         OC    PBIFIL,PBIFIL       TEST FIRST                                   
         BNE   PBI8                NO                                           
*                                  FIRST TIME                                   
         LA    R3,PBIAGYS                                                       
PBI2     DS    0H                                                               
         CLC   PBILKAGY,0(R3)                                                   
         BE    PBI4                                                             
         CLI   0(R3),X'FF'         EOL                                          
         LA    R3,16(R3)                                                        
         BNE   PBI2                                                             
*                                  NO INTERFACE                                 
         LA    RE,PBIEXIT                                                       
         ST    RE,PBIPROC                                                       
         ST    RE,PBIEND                                                        
         MVI   PBIFIL,X'FF'                                                     
         B     PBIEXIT                                                          
*                                                                               
PBI4     DS    0H                                                               
         LM    R4,R6,4(R3)         A(DTF),A(PROC),A(END PROC)                   
*                                  RELOCATE                                     
         A     R4,RELO                                                          
         A     R5,RELO                                                          
         LTR   R6,R6                                                            
         BZ    *+8                                                              
         A     R6,RELO                                                          
*                                                                               
         STM   R4,R6,PBIFIL                                                     
*                                                                               
*&&DO                                                                           
         OPENR (R4)                                                             
*&&                                                                             
*&&OS                                                                           
         OPEN  ((R4),(OUTPUT))                                                  
*&&                                                                             
*                                                                               
         XC    PBIREC,PBIREC                                                    
*                                                                               
PBI8     DS    0H                                                               
         CLI   MODE,RUNLAST                                                     
         BE    PBI9                                                             
*                                  NORMAL PROC                                  
         L     RF,PBIPROC                                                       
         BASR  RE,RF                                                            
         B     PBIEXIT                                                          
*                                  END PROC                                     
PBI9     DS    0H                                                               
         L     RF,PBIEND                                                        
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         BASR  RE,RF                                                            
         B     PBICLOSE                                                         
*                                                                               
         SPACE 3                                                                
PBICLOSE DS    0H                                                               
*&&DO                                                                           
         L     R1,PBIFIL                                                        
         CLOSER (1)                                                             
*&&                                                                             
*&&OS                                                                           
         L     R2,PBIFIL                                                        
         CLOSE ((2),)                                                           
*&&                                                                             
*                                                                               
PBIEXIT  DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*                                **COMPTON**                                    
COMPROC  NTR1                                                                   
         SPACE 2                                                                
         CLI   PBILLMOD,C'E'       BYPASS EST BILLS IF PRODUCT                  
         BH    COMPRX                OR SERIES MODE                             
*                                  CLEAR RECORD                                 
         MVI   PBIREC,C' '                                                      
         MVC   PBIREC+1(L'PBIREC-1),PBIREC                                      
*                                  MEDIA                                        
         MVC   PBIREC(2),=C'03'    NEWS                                         
         CLI   PBILKMED,C'N'                                                    
         BE    COMPR2                                                           
         MVC   PBIREC(2),=C'05'    TRADE + SUPP                                 
         CLI   PBILKMED,C'T'                                                    
         BE    COMPR2                                                           
         CLI   PBILKMED,C'S'                                                    
         BE    COMPR2                                                           
         MVC   PBIREC(2),=C'04'    MAG                                          
         CLI   PBILKMED,C'M'                                                    
         BE    COMPR2                                                           
         MVC   PBIREC(2),=C'09'    OUTDOOR                                      
*                                                                               
COMPR2   DS    0H                                                               
*                                  EST                                          
         MVC   HALF,PBILKEST                                                    
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PBIREC+2(4),DUB                                                  
*                                                                               
         MVC   PBIREC+11(6),PBIZEROS                                            
*                                  MONTH OF SERVICE                             
         GOTO1 DTCNV,DMCB,(1,PBILKMOS),PBIREC+17                                
*                                                                               
         MVC   PBIREC+21(2),SPACES                                              
*                                  CLIENT                                       
         MVC   PBIREC+24(3),PBILKCLT                                            
*                                  PRODUCT                                      
         MVC   PBIREC+27(3),PBILKPRD                                            
*                                                                               
         MVC   PBIREC+030(03),PBIZEROS                                          
         MVC   PBIREC+078(06),PBIZEROS                                          
         MVC   PBIREC+091(11),PBIZEROS                                          
*                                                                               
*                                  ACTUAL                                       
         ZAP   DUB,PBILLRCV                                                     
         UNPK  PBIREC+102(09),DUB                                               
*                                                                               
*                                  CASH DISC.                                   
         MVC   PBIREC+111(07),PBIZEROS                                          
         CLI   PBILCDSW,C'N'       CD SUPPRESSED                                
         BE    COMPR3                                                           
         ZAP   DUB,PBILLGRS        GROSS                                        
         SP    DUB,PBILLBIL        LESS BILL = CD                               
         UNPK  PBIREC+111(07),DUB                                               
*                                                                               
*                                  NET                                          
COMPR3   DS    0H                                                               
         ZAP   DUB,PBILLNET                                                     
         UNPK  PBIREC+118(09),DUB                                               
*                                                                               
*                                                                               
         MVC   PBIREC+127(9),PBIZEROS                                           
         MVC   PBIREC+136(05),PBIZEROS                                          
*                                  TODAY M/D/Y                                  
         LA    R2,QINVDATE                                                      
         MVC   PBIREC+141(4),2(R2)                                              
         MVC   PBIREC+145(2),0(R2)                                              
*                                  INVOICE NUMBER                               
         MVC   HALF,PBILKBNO                                                    
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PBIREC+147(3),DUB                                                
*                                  ESTIMATE NAME                                
         OC    PBILKEST,PBILKEST                                                
         BZ    COMPR4                                                           
         MVC   WORK(3),PBILKPRD                                                 
         MVC   WORK+5(2),PBILKEST                                               
         XC    WORK+3(2),WORK+3                                                 
         GOTO1 AGETFORM,DMCB,WORK  GET EST HDR                                  
*                                                                               
         L     R3,DMCB+4                                                        
         USING HDRKEYD,R3                                                       
         MVC   PBIREC+150(11),HDRNAME                                           
         DROP  R3                                                               
*                                                                               
COMPR4   DS    0H                                                               
*                                  CLIENT NAME                                  
         MVC   PBIREC+161(16),PCLTNAME                                          
*                                                                               
*                                  WRITE RECORD                                 
         L     R1,PBIFIL                                                        
         LA    R0,PBIREC                                                        
         PUT   (1),(0)                                                          
*                                                                               
COMPRX   DS    0H                                                               
         B     PBIEXIT                                                          
         EJECT                                                                  
*                                **COMPTON DTF**                                
*&&DO                                                                           
COPBIT1  DTFMT BLKSIZE=200,RECFORM=FIXUNB,FILABL=NO,                   X        
               DEVADDR=SYS008,IOAREA1=PBIBLK,REWIND=UNLOAD,            X        
               TYPEFLE=OUTPUT,WORKA=YES                                         
*&&                                                                             
*&&OS                                                                           
COPBIT1  DCB   DDNAME=COPBIT1,         DOS SYS008                      X        
               DSORG=PS,                                               X        
               RECFM=FB,                                               X        
               LRECL=00200,                                            X        
               BLKSIZE=00000,          DOS BLKSIZE=00200               X        
               MACRF=PM                                                         
*&&                                                                             
*                                                                               
         EJECT                                                                  
*                                  **ROSS ROY**                                 
RRPROC   NTR1                                                                   
         SPACE 2                                                                
         MVI   PBIREC,C' '                                                      
         MVC   PBIREC+1(L'PBIREC-1),PBIREC                                      
*                                                                               
         MVC   PBIREC+1(1),PBILLDAT+3                                           
         CLI   PBILLDAT+2,C'0'                                                  
         BE    RRP4                                                             
         ZIC   RF,PBILLDAT+3                                                    
         SH    RF,=H'47'                0=A,1=B,2=C                             
         STC   RF,PBIREC+1                                                      
*                                                                               
RRP4     DS    0H                                                               
         MVC   HALF,PBILKBNO                                                    
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PBIREC+2(4),DUB          INV NO.                                 
*                                                                               
         GOTO1 DTCNV,DMCB,(1,PBILINVD),WORK                                     
         MVC   PBIREC+06(2),WORK+2                                              
         MVC   PBIREC+08(2),WORK+4                                              
         MVC   PBIREC+10(2),WORK+0                                              
*                                                                               
         MVI   PBIREC+12,C'0'                                                   
         MVC   PBIREC+13(3),PCLTNUM                                             
         MVC   PBIREC+16(2),=C'13'                                              
         CLI   PBILKMED,C'O'                                                    
         BE    RRP5                                                             
         MVC   PBIREC+16(2),=C'11'                                              
         CLI   PBILKMED,C'N'                                                    
         BE    RRP5                                                             
         MVC   PBIREC+16(2),=C'12'                                              
RRP5     DS    0H                                                               
*                                                                               
         GOTO1 DTCNV,DMCB,(1,PBILDUED),WORK                                     
         MVC   PBIREC+18(2),WORK+2                                              
         MVC   PBIREC+20(2),WORK+4                                              
         MVC   PBIREC+22(2),WORK+0                                              
*                                                                               
         ZAP   DUB,PBILLGRS                                                     
         SP    DUB,PBILLBIL                                                     
         UNPK  PBIREC+32(6),DUB         CD                                      
*                                                                               
         TM    PBILBASA,X'04'      TEST CD IN BASE                              
         BNZ   *+10                YES                                          
         ZAP   DUB,=P'0'           NO - CLEAR CD                                
         AP    DUB,PBILLRCV        RCVBL (+CD IF TAKEN OUT)                     
         UNPK  PBIREC+24(8),DUB                                                 
*                                                                               
         MVI   PBIREC+38,C'0'                                                   
         MVC   PBIREC+39(17),PBIREC+38                                          
         CLC   PBILBASA(5),NPFORM  TEST SKIP 'NETS'                             
         BE    RRP6                                                             
         UNPK  PBIREC+38(8),PBILLNET    NET-NET                                 
*                                                                               
         ZAP   DUB,PBILLGRS                                                     
         SP    DUB,PBILLBIL                                                     
         AP    DUB,PBILLNET                                                     
         UNPK  PBIREC+46(8),DUB    GROSS - AC                                   
*                                                                               
RRP6     DS    0H                                                               
         L     R1,PBIFIL                                                        
         LA    R0,PBIREC                                                        
         PUT   (1),(0)                                                          
*                                                                               
         B     PBIEXIT                                                          
NPFORM   DC    X'0101',FL3'-850000'                                             
         EJECT                                                                  
*                                  ** KENYON AND ECKHARDT **                    
KNPROC   NTR1                                                                   
         SPACE 2                                                                
         MVI   PBIREC,C' '                                                      
         MVC   PBIREC+1(L'PBIREC-1),PBIREC                                      
*                                                                               
         MVC   PBIREC(3),PCLTNUM                                                
*                                                                               
         MVC   WORK(3),PBILKPRD                                                 
         XC    WORK+3(2),WORK+3                                                 
         MVC   WORK+5(2),=2X'FF'                                                
         GOTO1 AGETFORM,DMCB,WORK  GET PRD HDR INFO                             
*                                                                               
         L     R3,DMCB+4                                                        
         USING HDRKEYD,R3                                                       
         MVC   PBIREC+3(2),HDRACCT+2                                            
         CLI   HDRACCT,X'FF'       TEST NUMERIC                                 
         BNE   KNPR2                                                            
         MVC   FULL,HDRACCT                                                     
         DROP  R3                                                               
         MVI   FULL,0                                                           
         L     R0,FULL                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(5),DUB                                                      
         MVC   PBIREC+3(2),WORK+3                                               
*                                                                               
KNPR2    DS    0H                                                               
         MVC   PBIREC+5(5),PBIREC                                               
         MVC   PBIREC+10(2),=C'NS'                                              
         CLI   QMEDIA,C'N'                                                      
         BE    KNPR4                                                            
         MVC   PBIREC+10(2),=C'MG'                                              
         CLI   QMEDIA,C'M'                                                      
         BE    KNPR4                                                            
         MVC   PBIREC+10(2),=C'MT'                                              
         CLI   QMEDIA,C'T'                                                      
         BE    KNPR4                                                            
         MVC   PBIREC+10(2),=C'SS'                                              
         CLI   QMEDIA,C'S'                                                      
         BE    KNPR4                                                            
         MVC   PBIREC+10(2),=C'OH'                                              
         CLI   QMEDIA,C'O'                                                      
         BE    KNPR4                                                            
KNPR4    DS    0H                                                               
         MVC   PBIREC+12(2),PBILLDAT+2                                          
         MVC   HALF,PBILKBNO                                                    
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PBIREC+14(4),DUB                                                 
*                                                                               
         GOTO1 DTCNV,DMCB,(1,PBILINVD),WORK       INV DATE                      
         MVC   PBIREC+19(4),WORK+2                                              
         MVC   PBIREC+23(2),WORK                                                
*                                                                               
         MVC   PBIREC+75(2),PBILLDAT+2       TODAY  MO                          
         MVC   PBIREC+77(2),PBILLDAT                YR                          
         MVI   PBIREC+79,C'K'                                                   
*                                                                               
         UNPK  PBIREC+28(10),PBILLGRS     GROSS                                 
         ZAP   DUB,PBILLGRS             GROSS                                   
         SP    DUB,PBILLBIL              -(G-CD)                                
         UNPK  PBIREC+38(7),DUB           = CD                                  
         ZAP   DUB,PBILLRCV                                                     
         SP    DUB,PBILLNET                                                     
         UNPK  PBIREC+45(10),DUB         RCVBL-NET=INCOME                       
         UNPK  PBIREC+55(10),PBILLNET     NET/NET                               
*                                                                               
         L     R1,PBIFIL                                                        
         LA    R0,PBIREC                                                        
         PUT   (1),(0)                                                          
*                                                                               
KNX      DS    0H                                                               
         B     PBIEXIT                                                          
         SPACE 3                                                                
*                                                                               
*&&DO                                                                           
KNPBIT1  DTFMT BLKSIZE=80,DEVADDR=SYS008,FILABL=STD,RECFORM=FIXUNB,    X        
               IOAREA1=PBIBLK,REWIND=UNLOAD,TYPEFLE=OUTPUT,            X        
               WORKA=YES                                                        
*&&                                                                             
*&&OS                                                                           
KNPBIT1  DCB   DDNAME=KNPBIT1,         DOS SYS008                      X        
               DSORG=PS,                                               X        
               RECFM=FB,                                               X        
               LRECL=00080,                                            X        
               BLKSIZE=00000,          DOS BLKSIZE=00080               X        
               MACRF=PM                                                         
*&&                                                                             
*                                                                               
         EJECT                                                                  
*&&DO                                                                           
RRPBIT1  DTFMT BLKSIZE=800,RECFORM=FIXBLK,RECSIZE=80,FILABL=NO,        X        
               DEVADDR=SYS008,IOAREA1=PBIBLK,REWIND=UNLOAD,            X        
               TYPEFLE=OUTPUT,WORKA=YES                                         
*&&                                                                             
*&&OS                                                                           
RRPBIT1  DCB   DDNAME=RRPBIT1,         DOS SYS008                      X        
               DSORG=PS,                                               X        
               RECFM=FB,                                               X        
               LRECL=00080,                                            X        
               BLKSIZE=00000,          DOS BLKSIZE=00800               X        
               MACRF=PM                                                         
*&&                                                                             
*                                                                               
         EJECT                                                                  
*                                  AGENCY LIST                                  
*                                   0- 1 = AGY CODE                             
*                                   4- 7  = A(DTF)                              
*                                   8-11  = A(PROC)                             
*                                  12-15  = A(END PROC)                         
PBIAGYS  DS    0F                                                               
*                                                                               
         DC    C'CO  ',A(COPBIT1),A(COMPROC),A(0)                               
         DC    C'RR  ',A(RRPBIT1),A(RRPROC),A(0)                                
*                                  ROSS ROY NY SAME AS COMPTON                  
         DC    C'RN  ',A(COPBIT1),A(COMPROC),A(0)                               
         DC    C'RH  ',A(COPBIT1),A(COMPROC),A(0)                               
         DC    C'KN  ',A(KNPBIT1),A(KNPROC),A(0)                                
         DC    X'FF'                                                            
*                                                                               
         SPACE 3                                                                
PBIFIL   DC    A(0)                                                             
PBIPROC  DC    A(0)                                                             
PBIEND   DC    A(0)                                                             
*                                                                               
PBIZEROS DC    20C'0'                                                           
*                                                                               
PBIREC   DS    CL200                                                            
*                                                                               
         SPACE 3                                                                
         LTORG                                                                  
*                                                                               
*                                                                               
*&&DO                                                                           
PBIBLK   DS    CL3000                                                           
*&&                                                                             
*                                                                               
         TITLE 'REVPRT - PRINT REVERSALS'                                       
REVPRT   CSECT                                                                  
         NMOD1 0,REVPRD                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         USING PBILWRKD,R8                                                      
         SPACE 2                                                                
         OC    REVNUM,REVNUM                                                    
         BZ    REVPRTX                                                          
         L     R2,0(R1)                                                         
         USING POSTKEYD,R2                                                      
         L     R3,REVTAB                                                        
         L     R5,REVNUM                                                        
         SR    RF,RF                                                            
RVP3     DS    0H                                                               
         CLC   0(5,R3),POSTKPRD    TEST PRD AND MOS                             
         BNE   *+8                                                              
         LA    RF,1(RF)            COUNT NO. FOR THIS PRODUCT                   
         A     R3,REVLEN                                                        
         BCT   R5,RVP3                                                          
*                                                                               
         LTR   RF,RF                                                            
         BZ    REVPRTX             NONE                                         
*                                  SET LINES NEEDED                             
         LA    RF,7(RF)                                                         
         STC   RF,LNEED                                                         
*                                                                               
         LA    R4,P+11                                                          
         CLI   BCDETS,0                                                         
         BNE   *+8                                                              
         LA    R4,16(R4)                                                        
*                                                                               
         MVC   0(13,R4),=C'LESS PREVIOUS'                                       
         GOTO1 APRNT                                                            
*                                                                               
         MVC   0(7,R4),=C'BILLING'                                              
         L     R3,REVTAB                                                        
         L     R5,REVNUM                                                        
RVP4     DS    0H                                                               
         CLC   0(5,R3),POSTKPRD    TEST PRD AND MOS                             
         BNE   RVP5                                                             
         MVC   14(10,R4),REVINUM-REVREC(R3)                                     
         LA    R1,REVGRS-REVREC(R3)                                             
         ST    R1,DMCB                                                          
         GOTO1 AFMTLIN,DMCB                                                     
         GOTO1 APRNT                                                            
*                                                                               
RVP5     A     R3,REVLEN                                                        
         BCT   R5,RVP4                                                          
*                                  UNDERLINE                                    
         LA    R4,P+37                                                          
         LA    R5,BCDETS                                                        
         LA    R6,4                                                             
RVP6     DS    0H                                                               
         CLI   0(R5),0                                                          
         BE    RVP8                                                             
         MVI   2(R4),C'-'                                                       
         MVC   2+1(11,R4),2(R4)                                                 
RVP8     DS    0H                                                               
         LA    R4,16(R4)                                                        
         LA    R5,1(R5)                                                         
         BCT   R6,RVP6                                                          
*                                                                               
         GOTO1 APRNT                                                            
*                                                                               
         MVC   X(24),POSTBY                                                     
         LM    R5,R7,X                                                          
         S     R5,X+12             SUBTRACT RVRSE                               
         S     R6,X+16                                                          
         S     R7,X+20                                                          
         STM   R5,R7,X                                                          
         GOTO1 AFMTLIN,DMCB,X                                                   
*                                                                               
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
REVPRTX  DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'START - INITIALIZATION ROUTINES'                                
START    CSECT                                                                  
         NMOD1 0,**STRT                                                         
         SPACE 2                                                                
         USING PPWORKD,RA                                                       
         L     RC,PPFILEC                                                       
         USING PPFILED,RC,R9                                                    
         USING PBILWRKD,R8                                                      
         SPACE 2                                                                
         CLI   MODE,RUNFRST                                                     
         BE    ST10                                                             
         CLI   MODE,FBUYREQ                                                     
         BE    ST20                                                             
         CLI   MODE,FBUYCLI                                                     
         BE    ST40                                                             
         CLI   MODE,FBUYPRO                                                     
         BE    ST60                                                             
         CLI   MODE,FBUYEST                                                     
         BE    ST70                                                             
         CLI   MODE,LBUYREQ                                                     
         BE    ST90                                                             
STARTX   DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*                                  RUNFRST                                      
ST10     DS    0H                                                               
         MVC   SAVMAX,MAXLINES                                                  
         OI    DMINBTS,X'08'       SET TO PASS DELETES                          
         OI    DMOUTBTS,X'FD'                                                   
         MVC   P,SPACES                                                         
         MVC   ETODAY+0,RCDATE+06       YM                                      
         MVC   ETODAY+2,RCDATE+00       MO                                      
         MVC   ETODAY+4,RCDATE+03       DA                                      
         GOTO1 DTCNV,DMCB,ETODAY,(1,BTODAY)                                     
*                                                                               
*                                  SET EXTERNAL ADDRESSES                       
         LA    R0,(ACONSX-ACONS)/4                                              
         LA    R2,ACONS                                                         
         LA    R3,RCONS                                                         
ST11     DS    0H                                                               
         L     RF,0(R2)                                                         
         A     RF,RELO                                                          
         ST    RF,0(R3)                                                         
         LA    R2,4(R2)                                                         
         LA    R3,4(R3)                                                         
         BCT   R0,ST11                                                          
*                                  SET DMGR CODES                               
         MVI   HIGH,1                                                           
         MVI   SEQ,2                                                            
         MVI   READ,3                                                           
         MVI   GET,4                                                            
         MVI   PUT,5                                                            
         MVI   ADD,6                                                            
*                                                                               
*                                  SET BINSRCH PARS                             
         SR    R2,R2               A(REC)                                       
         L     R3,ATAB             A(TABLE)                                     
         SR    R4,R4               NUMBER                                       
         LA    R5,31               LENGTH                                       
         LA    R6,7                L'KEY                                        
         LA    R7,PTMAX              MAX                                        
         STM   R2,R7,BSPARS                                                     
*                                                                               
*                                  SET HDR TAB PARS                             
         SR    R2,R2                                                            
         L     R3,AHDRTAB                                                       
         SR    R4,R4                                                            
         LA    R5,66          LENGTH                                            
         LA    R6,5           L'KEY                                             
         LA    R7,100         MAX                                               
         STM   R2,R7,HDRPARS                                                    
*                                  SET REVLST PARS                              
         LA    R2,REVREC                                                        
         L     R3,AREVLST                                                       
         SR    R4,R4                                                            
         LA    R5,L'REVREC                                                      
         LA    R6,15                                                            
         LA    R7,100                                                           
         STM   R2,R7,REVPARS                                                    
*                                                                               
         XC    SAVEDA,SAVEDA                                                    
         XC    INVNO,INVNO                                                      
         XC    LASTAMC,LASTAMC                                                  
         XC    VENTOTS(48),VENTOTS CLEAR ALL TOTALS                             
*                                  LINE-UP PATTERN                              
         LA    R2,2                DO PATTERN 2 TIMES                           
ST12     DS    0H                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVI   SKIPSPEC,C'Y'                                                    
         LA    R3,4                                                             
ST12B    DS    0H                                                               
         MVI   SPACING,3                                                        
         GOTO1 REPORT                                                           
*                                                                               
         BCT   R3,ST12B                                                         
*                                                                               
         MVC   SAVEP,SPACES                                                     
         MVI   SAVEP+022,C'*'                                                   
         MVC   SAVEP+023(14),SAVEP+022                                          
         MVC   SAVEP+038(15),SAVEP+022                                          
         MVC   SAVEP+054(15),SAVEP+022                                          
         MVC   SAVEP+070(15),SAVEP+022                                          
*                                                                               
         LA    R3,3                                                             
ST12D    DS    0H                                                               
         MVC   P,SAVEP                                                          
         GOTO1 REPORT                                                           
*                                                                               
         BCT   R3,ST12D                                                         
*                                                                               
         BCT   R2,ST12                                                          
*                                                                               
         B     STARTX                                                           
         EJECT                                                                  
*                                  FBUYREQ                                      
ST20     DS    0H                                                               
*                                                                               
         MVC   SAVQ,QRECORD                                                     
         MVI   LINE,99                                                          
         MVC   PAGE,=H'1'                                                       
         MVC   SAVMID,SPACES                                                    
         MVI   RACTSW,0                                                         
         MVI   MASTPRD,0           CLEAR MAST HDR                               
*                                                                               
ST25     DS    0H                  PERIOD                                       
         CLC   QSTART+4(2),SPACES                                               
         BNE   *+10                                                             
         MVC   QSTART+4(2),=C'01'                                               
         MVC   HIDAYS+2(2),=C'28'                                               
         PACK  DUB,QSTART(2)                                                    
         CVB   R0,DUB                                                           
         STC   R0,BYTE                                                          
         TM    BYTE,X'03'                                                       
         BNZ   *+10                                                             
         MVC   HIDAYS+2(2),=C'29'  LEAP YEAR                                    
         CLC   QEND,SPACES                                                      
         BNE   ST26                                                             
         MVC   QEND(4),QSTART                                                   
         PACK  DUB,QEND+2(2)                                                    
         CVB   R1,DUB                                                           
         SLL   R1,1                                                             
         LA    R1,HIDAYS-2(R1)                                                  
         MVC   QEND+4(2),0(R1)     SET EOM                                      
ST25M    MVI   PERSW,C'M'                                                       
         CLC   QSTART+4(2),=C'01'                                               
         BE    ST27                                                             
ST25S    MVI   PERSW,C'S'                                                       
         B     ST27                                                             
ST26     DS    0H                                                               
         CLC   QSTART(4),QEND                                                   
         BNE   CRDERR                                                           
         PACK  DUB,QEND+2(2)                                                    
         CVB   R1,DUB                                                           
         SLL   R1,1                                                             
         LA    R1,HIDAYS-2(R1)                                                  
         CLC   QEND+4(2),0(R1)                                                  
         BH    CRDERR                                                           
         BL    ST25S                                                            
         B     ST25M                                                            
*                                                                               
ST27     DS    0H                                                               
         GOTO1 DTCNV,DMCB,QSTART,(1,BSTART)                                     
*                                                                               
         GOTO1 (RF),(R1),QEND,(1,BEND)                                          
*                                                                               
         MVC   QINVDATE(8),QPUB+1  SET INV DATE AND DUE DAYS                    
         CLI   QPUB+1,C'8'         TEST HAVE INVOICE DATE                       
         BNL   *+10                (MIGHT BE RD=)                               
         MVC   QINVDATE,ETODAY                                                  
         CLC   QDUEDAYS,SPACES                                                  
         BNE   *+10                                                             
         MVC   QDUEDAYS,=C'10'                                                  
ST29     DS    0H                                                               
         MVI   FCRDBUY,C'Y'                                                     
         MVI   FCRDACTV,C'N'                                                    
         CLC   QPRODUCT,=C'ZZZ'                                                 
         BNE   *+10                                                             
         MVC   QPRODUCT,SPACES                                                  
         CLC   QPRODUCT,SPACES                                                  
         BNE   *+8                                                              
         MVI   FCRDACTV,C'Y'                                                    
*                                                                               
         B     STARTX                                                           
         SPACE 2                                                                
HIDAYS   DC    C'312831303130313130313031'                                      
         EJECT                                                                  
*                                  FBUYCLT                                      
ST40     DS    0H                                                               
         XC    BSNUM,BSNUM              RESET TABLE                             
         XC    HDRNUM,HDRNUM       RESET HDRTAB                                 
         XC    MASTHDR,MASTHDR                                                  
         XC    THISYM,THISYM                                                    
         MVI   DONESW,0                                                         
         MVC   FORMSW,PCLTPROF+10                                               
         CLC   QPRODUCT,SPACES                                                  
         BE    ST40A                                                            
         CLI   FORMSW,C'5'                                                      
         BNE   ST40A2                                                           
         MVI   FORMSW,C'2'         PRD=YES,SEP INV                              
         B     ST40A2                                                           
ST40A    DS    0H                                                               
         CLI   FORMSW,C'2'                                                      
         BNE   *+8                                                              
         MVI   FORMSW,C'5'         PRD=NO,SEP INV                               
ST40A2   DS    0H                                                               
         MVI   SEPSW,C'S'          ADJ SEPARATE                                 
         CLI   FORMSW,C'2'                                                      
         BE    ST40B                                                            
         CLI   FORMSW,C'5'                                                      
         BE    ST40B                                                            
         MVI   SEPSW,C'T'          ON SAME INV                                  
*                                                                               
ST40B    DS    0H                                                               
*                                                                               
*                                  ESTIMATE EDIT                                
         MVI   ESTSW,C'A'          ALL ESTS                                     
         CLC   QEST,=C'ALL'                                                     
         BE    ST41                                                             
         MVI   ESTSW,C'T'          TOGETHER                                     
         CLC   QEST,SPACES                                                      
         BE    ST41                                                             
         MVI   ESTSW,C'S'          SERIES                                       
         CLC   QESTEND,SPACES                                                   
         BNE   ST41                                                             
         MVI   ESTSW,C'E'          ONE                                          
ST41     DS    0H                                                               
         CLI   PCLTPROF+9,C'X'                                                  
         BE    ST43                                                             
         CLI   PCLTPROF+9,C'0'     0 = EST BILLING                              
         BNE   ST42                                                             
         CLI   ESTSW,C'S'                                                       
         BNL   ST42E                                                            
         B     ST43                                                             
*                                                                               
ST42     DS    0H                                                               
         CLI   ESTSW,C'S'                                                       
         BNL   ST43                                                             
         CLI   ESTSW,C'A'                                                       
         BNE   ST42E                                                            
         MVC   QEST,SPACES         CHANGE ALL TO 'NO'                           
         MVI   ESTSW,C'T'                                                       
         B     ST43                                                             
*                                                                               
ST42E    DS    0H                                                               
         CLI   QOPT1,C'I'          IGNORE ERROR                                 
         BE    ST43                                                             
         B     CRDERR                                                           
*                                  PRODUCT                                      
ST43     DS    0H                                                               
         MVI   PRDSW,C'A'          ALL                                          
         CLC   QPRODUCT,=C'ALL'                                                 
         BE    ST44                                                             
         MVI   PRDSW,C'T'          TOG                                          
         CLC   QPRODUCT,SPACES                                                  
         BE    ST44                                                             
         MVI   PRDSW,C'P'          PROD                                         
*                                                                               
ST44     DS    0H                                                               
*                                  SET PRIOR SW                                 
         MVI   PRIORSW,C'N'        NO PRIOR                                     
         CLI   QBILMODE,C'P'                                                    
         BNE   ST45                                                             
         MVI   PRIORSW,C'S'        SEPARATE                                     
         CLC   QPROG,=C'06'                                                     
         BE    ST45                                                             
         CLI   PCLTPROF+11,C'0'                                                 
         BNE   ST45                                                             
         CLI   PCLTPROF+10,C'2'         -SEP ADJ                                
         BE    ST45                                                             
         CLI   PCLTPROF+10,C'5'         -SEP ADJ                                
         BE    ST45                                                             
         MVI   PRIORSW,C'T'        TOGETHER                                     
*                                                                               
ST45     DS    0H                                                               
*                                  SET REVERSAL SWITCH                          
         MVI   REVSW,C'R'                                                       
         CLC   QPROG,=C'06'                                                     
         BE    ST45B                                                            
         CLI   PCLTPROF+11,C'2'                                                 
         BE    ST45B                                                            
         MVI   REVSW,0                                                          
*                                                                               
ST45B    DS    0H                                                               
*                                                                               
*                                  CHECK MANUAL AMOUNT                          
         XC    MANGRS(8),MANGRS                                                 
         CLC   QPAY,SPACES                                                      
         BE    *+10                                                             
         MVC   MANGRS,QPAY                                                      
         CLC   QOPT4(4),SPACES                                                  
         BE    *+10                                                             
         MVC   MANCD(4),QOPT4                                                   
         OC    MANGRS(8),MANGRS                                                 
         BZ    ST46                                                             
*                                                                               
         CLI   PRDSW,C'P'                                                       
         BNE   CRDERR                                                           
         CLI   ESTSW,C'E'                                                       
         BNE   CRDERR                                                           
         CLC   QPROG,=C'04'                                                     
         BNE   CRDERR                                                           
*                                                                               
ST46     DS    0H                                                               
*                                  GET FIRST INVOICE NUM                        
         CLC   QAGENCY(6),LASTAMC  AMC                                          
         BE    ST48                                                             
         CLC   QAGENCY(3),LASTAMC  AM                                           
         BNE   ST47                                                             
*                                  NEW CLIENT                                   
         CLI   PAGYPROF+5,C'0'     CLIENT INV NOS                               
         BNE   ST48                NO                                           
ST47     DS    0H                                                               
         XC    INVNO,INVNO                                                      
         GOTO1 AGETNUM                                                          
*                                                                               
ST48     DS    0H                                                               
         MVC   LASTAMC,QAGENCY                                                  
         B     STARTX                                                           
         EJECT                                                                  
*                                  FBUYPRD                                      
         SPACE 2                                                                
ST60     DS    0H                                                               
         GOTO1 APOST,DMCB,PPRDKEY                                               
*                                                                               
         CLI   PRDSW,C'T'                                                       
         BNL   STARTX                                                           
         MVI   DONESW,0                                                         
         XC    MASTHDR,MASTHDR                                                  
         XC    THISYM,THISYM                                                    
         B     STARTX                                                           
         SPACE 3                                                                
*                             FBUYEST                                           
ST70     DS    0H                                                               
         CLI   ESTSW,C'E'                                                       
         BH    STARTX                                                           
*                                                                               
         GOTO1 APOST,DMCB,PESTKEY                                               
*                                                                               
         MVI   DONESW,0                                                         
         XC    MASTHDR,MASTHDR                                                  
         XC    THISYM,THISYM                                                    
         B     STARTX                                                           
         EJECT                                                                  
*                                  LAST                                         
ST90     DS    0H                                                               
         CLI   RACTSW,0                                                         
         BNE   STARTX                                                           
         MVI   SKIPSPEC,C'Y'                                                    
         MVC   P(80),SAVQ                                                       
         MVC   PSECOND(40),=C'**NO BILLING GENERATED FOR THIS REQUEST*'         
         GOTO1 REPORT                                                           
*                                                                               
         B     STARTX                                                           
         SPACE 3                                                                
CRDERR   DS    0H                                                               
         MVC   P(80),SAVQ                                                       
         MVC   P+85(15),=C'INVALID REQUEST'                                     
         MVI   SKIPSPEC,C'Y'                                                    
         GOTO1 REPORT                                                           
*                                                                               
         MVI   MODE,LBUYREQ                                                     
         B     STARTX                                                           
         SPACE 3                                                                
*                                                                               
ACONS    DS    0F                                                               
         DC    A(PBDMGR)                                                        
         DC    A(PBDMGR)                                                        
         DC    A(PBDMGR)                                                        
         DC    A(PBDMGR)                                                        
         DC    A(PBDMGR)                                                        
         DC    A(PBDMGR)                                                        
         DC    A(PTAB)                                                          
         DC    A(HTAB)                                                          
         DC    A(RTAB)                                                          
         DC    A(PBPRNT)                                                        
         DC    A(PBPOST)                                                        
         DC    V(BINSRCH)                                                       
         DC    A(PRTACC)                                                        
         DC    A(GETFORM)                                                       
         DC    A(PRTDUE)                                                        
         DC    A(REVPRT)                                                        
         DC    A(FMTLIN)                                                        
         DC    A(ADBIL)                                                         
         DC    A(PBINTAP)                                                       
         DC    A(GETNUM)                                                        
         DC    A(BLDREV)                                                        
         DC    V(CENTER)                                                        
ACONSX   EQU   *                                                                
         SPACE 3                                                                
         LTORG                                                                  
         SPACE 3                                                                
PTAB     DS    3000CL31            $ POST TABLE                                 
PTMAX    EQU   3000                                                             
HTAB     DS    100CL64              HDR TABLE                                   
RTAB     DS    100CL27             REVERSAL LIST                                
*                                                                               
*                                                                               
       ++INCLUDE PBILWRK                                                        
*                                                                               
         PRINT OFF                                                              
       ++INCLUDE PPNEWFILE                                                      
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'036PBILFACN  05/01/02'                                      
         END                                                                    
