*          DATA SET DEGETNTI   AT LEVEL 067 AS OF 04/17/19                      
*PROCESS USING(WARN(15))           ENABLE ALL USING STATEMENT WARNINGS          
*CATALP DEGETNTI                                                                
DEGETNTI TITLE '- NTI READ CONTROLLER'                                          
GETNTI   RSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 MYWORKL,**GETNTI,RA,CLEAR=YES,RR=R2                              
         LR    R9,RC               SAVE SPANNING WORK AREAS                     
         LR    R7,R1                                                            
         L     RC,0(R1)                                                         
         USING DEGETD,RC           RC=A(W/S)                                    
         USING DBLOCKD,R6                                                       
         USING COMFACSD,R8                                                      
         USING MYWORK,R9           R9=LOCAL W/S                                 
         ST    R2,RELO1                                                         
*                                                                               
         CLI   0(R1),0             1ST TIME IN, INIT IO AREA                    
         BNE   *+18                                                             
         L     RE,DBAREC                                                        
         XC    0(30,RE),0(RE)                                                   
*                                                                               
         LA    R4,SPANAD                                                        
         STCM  R4,15,DBSPANAD      WORK AREA FOR SPANNED RECORDS                
         L     R4,DBAREC           ORIG USERS DBAREC                            
         CLI   SPNETFLG,0          FOR REP, PURE#=PRG#                          
         BE    *+18                                                             
         CLI   DBFUNCT,DBGETPUR                                                 
         BNE   *+10                                                             
         MVC   DBSELPRG,DBSELPUR                                                
*                                                                               
         CLI   DBFUNCT,DBGETOPI                                                 
         BE    GETOPI                                                           
*                                                                               
         CLI   0(R1),0                                                          
         BNE   GOTUNIV                                                          
         CLI   DBSELSTA+4,X'88'    LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   DBSELSTA+4,C'H'                                                  
         BNE   GOTUNIV                                                          
         TM    SPNETFLG,SPNHTQ     SPOT-NHT CALL?                               
         BO    *+12                                                             
         CLI   DBSELSRC,C'N'       OR REG NET-NHT CALL                          
         BNE   GOTUNIV                                                          
*                                                                               
GETNTU   LA    RE,SPANAD                                                        
         LA    RE,4(RE)                                                         
         ST    RE,DBAREC                                                        
         XC    DBKEY,DBKEY                                                      
         MVC   DBKEY(8),=C'PNNUUUUH'                                            
         CLI   DBSELSTA+4,X'88'    LOWER CASE 'H'= WEIGHTED HISP                
         BNE   *+8                                                              
         MVI   DBKEY+7,X'88'       READ WEIGHTED HISP UNIVERSES                 
         MVC   DBKEY+1(1),DBSELMED                                              
         MVC   DBKEY+10(2),DBSELBK                                              
         MVI   IOFLAG,DIR+HIGH                                                  
         GOTO1 AIO,IOFLAG                                                       
         BNE   GOTUFAIL                                                         
         CLC   DBKEY+10(2),DBSELBK                                              
         BNE   GOTUFAIL                                                         
         CLC   DBKEY(8),KEYSAVE                                                 
         BNE   GOTUFAIL                                                         
         MVC   SPANAD(4),=C'NTHU'                                               
         LA    RE,SPANAD+4                                                      
         MVC   DIRSAVE,DBKEY                                                    
         MVI   IOFLAG,FILE+READ                                                 
         GOTO1 AIO,IOFLAG                                                       
         BNE   GOTUFAIL                                                         
         XC    DBNDXDA,DBNDXDA                                                  
         XC    DBNDXDA2,DBNDXDA2                                                
         XC    DBSTATU2,DBSTATU2                                                
         LA    RE,SPANAD+4                                                      
         USING PRKEY,RE                                                         
         LA    RE,PRFRSTEL                                                      
         SR    RF,RF                                                            
GETNHTU1 CLI   0(RE),0             TEMP FIX FOR ELEMENT CODES                   
         BE    GOTUNIV                                                          
         CLI   0(RE),X'41'                                                      
         BNE   *+8                                                              
         MVI   0(RE),X'4B'                                                      
         CLI   0(RE),X'42'                                                      
         BNE   *+8                                                              
         MVI   0(RE),X'4C'                                                      
         IC    RF,1(RE)                                                         
         AR    RE,RF                                                            
         B     GETNHTU1                                                         
         DROP  RE                                                               
GOTUFAIL XC    DBNDXDA,DBNDXDA                                                  
         XC    DBNDXDA2,DBNDXDA2                                                
         XC    DBSTATU2,DBSTATU2                                                
*                                                                               
GOTUNIV  ST    R4,DBAREC           RESTORE ORIG/USERS DBAREC                    
         TM    SPNETFLG,SPNHTQ     GET A(DEFINE) TO LK UP NHTI WKS              
         BNO   GETNTIST            ON WKLY FILE FOR SPECIALS/BRKS               
         XC    WEEKS,WEEKS                                                      
         LA    R1,DMCB                                                          
         L     RF,CCALLOV                                                       
         MVC   DMCB+4(4),=X'D9000A26'                                           
         GOTO1 (RF),(R1),0         GET A(DEFINE) FROM CALLOV                    
         OC    DMCB(4),DMCB                                                     
         BZ    GETNTIST                                                         
         L     RF,DMCB             GET WEEKS FOR MONTH                          
         GOTO1 (RF),DMCB,=C'NDMON',DBLOCKD,WEEKS                                
*                                                                               
GETNTIST LR    R1,R7               RESTORE ORIG R1 PARM                         
         CLI   0(R1),0             START PROCESSING                             
         BNE   GETNTI4                                                          
         ZIC   R1,DBFUNCT          SAVE THE REQUESTED FUNCTION                  
         MVI   DBFUNCT,DBTSTACS    SET FOR VALIDATE                             
         GOTO1 ATSTACS             CALL TO VALIDATE ACCESS                      
         STC   R1,DBFUNCT          RESTORE ORIGINAL REQUEST                     
         CLI   DBERROR,0           EXIT IF NOT VALID                            
         BNE   GETX                                                             
*                                                                               
TVQLBK   OC    DBSELBK,DBSELBK     LATEST BOOK REQST VALID FOR TVQ ONLY         
         BNZ   TVQLBKX                                                          
         CLC   DBFILE,=C'NAD'                                                   
         BNE   TVQLBKX                                                          
         CLI   DBBTYPE,C'U'        TVQ LK UP?                                   
         BNE   TVQLBKX                                                          
         MVC   SVASRC,DBACTSRC                                                  
         MVC   SVINTMED,DBINTMED                                                
         MVI   DBACTSRC,C'Q'                                                    
         MVC   DBINTMED,DBSELSTA+4                                              
         XC    DBACTBK,DBACTBK                                                  
         GOTO1 AGETBOOK                                                         
         MVC   DBACTSRC,SVASRC                                                  
         MVC   DBINTMED,SVINTMED                                                
         CLI   DBERROR,0                                                        
         BNE   GETX                                                             
         LA    R1,DBACTBK          ACCESS ON LATEST TVQ BK                      
         B     *+8                                                              
TVQLBKX  LA    R1,DBSELBK          SET THE CONTOL TABLE                         
         L     RF,AGETCTRL                                                      
         OC    ACONHDR,ACONHDR                                                  
         BNZ   *+6                                                              
         BASR  RE,RF                                                            
*                                                                               
         CLI   DBSELSTA+4,C'D'                                                  
         BE    *+8                                                              
         CLI   DBSELSTA+4,C'T'     ONLY FOR REG. NETWORKS                       
         BE    *+8                                                              
         CLI   DBSELSTA+4,C'S'     AND SYNDICATORS                              
         BNE   GETNTIA                                                          
         CLC   DBSELBK,=X'5724'    DON'T NEED BTYPE PRIOR TO 8736               
         BL    GETNTIA                                                          
         CLC   DBSELBK,=X'5731'    CHECK FOR OUT OF ORDER WEEKS                 
         BE    GETNTIA                                                          
         CLC   DBSELBK,=X'5732'                                                 
         BE    GETNTIA                                                          
         CLC   DBSELBK,=X'5733'                                                 
         BE    GETNTIA                                                          
         CLI   DBBTYPE,C'D'        KILL DIARY AFTER THESE DATES                 
         BNE   *+8                                                              
         MVI   DBBTYPE,X'FE'                                                    
         CLI   DBBTYPE,0           ALLOW USER TO SPECIFY                        
         BNE   GETNTIA                                                          
         MVI   DBBTYPE,C'A'        FORCE TO A (NO DIARY USE PM)                 
*                                                                               
GETNTIA  CLI   DBBTYPE,C'D'        DIARY ONLY                                   
         BNE   *+8                                                              
         MVI   DBBTYPE,0           CHANGE TO REGULAR BOOK                       
*                                                                               
         OC    DBSEL1WK,DBSEL1WK   DBSEL1WK'S DAY REPLACES DBSELDAY             
         BZ    GETNTI1                                                          
         GOTO1 CDATCON,DMCB,(2,DBSEL1WK),(0,WORK)                               
         GOTO1 CGETDAY,DMCB,WORK,DUB                                            
         MVC   DBSELDAY,0(R1)      USE DAY RETURNED BY GETDAY                   
*                                                                               
GETNTI1  ICM   R3,15,DBAOPT        A(OPTIMIZATION AREA)                         
         BZ    GETNTI4                                                          
         OC    DBLOPT,DBLOPT       TEST OPT AREA LEN                            
         BNZ   *+14                                                             
         XC    DBAOPT,DBAOPT       NULLIFY OPTIMIZATION FOR MISSING LEN         
         B     GETNTI4                                                          
*                                                                               
         USING NOPTD,R3                                                         
         LR    R1,R3               SAVE A(OPT AREA) IN R1                       
         MVC   WORK(L'DBSELBK),DBSELBK                                          
         MVC   WORK+L'DBSELBK(L'DBSELSTA),DBSELSTA                              
         XC    2(2,R3),2(R3)       CLEAR DISP TO NEXT AVAILABLE NTRY            
         SR    R5,R5                                                            
         ICM   R5,3,0(R3)          LENGTH OF OPT USED SO FAR                    
         BZ    GETNTI2                                                          
         C     R5,=F'2000'         MAXIMUM REALLY USEFUL                        
         BH    GETNTI2                                                          
*                                                                               
         LA    R3,4(R3)            POINT PAST HEADER                            
         LA    R4,NOPTLEN          BXLE INCREMENT                               
         LA    R5,0(R1,R5)         POINT TO END OF AREA                         
         SR    R5,R4               BACK UP 1 NTRY AS BXLE LIMIT                 
         CLC   WORK(L'NOPTKEY),NOPTKEY                                          
         BE    GETNTI3             FOUND BOOK/NETWORK                           
         BXLE  R3,R4,*-10                                                       
         MVC   2(2,R1),0(R1)       DISP TO NXT NTRY IS LEN USED SO FAR          
         B     GETNTI4                                                          
         SPACE 1                                                                
GETNTI2  DS    0H                  FIRST OPT ENTRY LOGIC                        
         MVC   0(4,R3),=X'00040004'                                             
         LA    R3,4(R3)                                                         
         B     GETNTI4                                                          
         SPACE                                                                  
GETNTI3  DS    0H                                                               
         MVC   DBNDXDA2,NOPTDA     SET D/A FROM OPT ENTRY                       
         MVC   DBNDXDA,NOPTDA                                                   
         MVC   DBSTATU2,NOPTST                                                  
         MVC   DBSTATUS,NOPTST                                                  
         B     GETNTI4                                                          
         SPACE                                                                  
GETNTI4  DS    0H                                                               
         XC    DBFACTOR,DBFACTOR                                                
         CLI   DBLSTNXT,1          TEST FOR RENTRY-ALL PRGS FOR BK/STA          
         BE    GETNTI6                                                          
*                                                                               
         OC    DBSELPRG,DBSELPRG   TEST FOR PROGRAM NUMBER                      
         BNZ   GETNTI5                                                          
         CLC   DBFILE,=C'NTI'      NO FILTERING FOR WB1/ALL DAYS&TIMES          
         BNE   GETNTI4A            (SYNDICATION,FILTERS MAKE NO SENSE)          
         CLI   DBBTYPE,C'V'        WB1?                                         
         BE    GETNTI5                                                          
         CLI   DBBTYPE,C'T'        TCAR?                                        
         BE    GETNTI5                                                          
         CLC   =C'NCA S',DBSELSTA                                               
         BE    GETNTI5                                                          
GETNTI4A OC    DBSELDAY(5),DBSELDAY TEST FOR DAY/TIME                           
         BNZ   GETNTI10             FILTERING LOGIC                             
         OC    ADTLIST(4),ADTLIST   TEST FOR DAY/TIME LIST                      
         BNZ   GETNTI10             FILTERING LOGIC                             
         DROP  R3                                                               
         SPACE                                                                  
**********************************************************************          
*GETNTI5 -     READ THRU Q-RECDS FOR ALL PROGRAMS OR SPECIFIC ONE               
*        NO TIME/DAY FILTERING SO THE N-RECDS NOT USED HERE                     
**********************************************************************          
GETNTI5  DS    0H                                                               
*                                                                               
         BRAS  RE,FIXPROG          FIX POSTING FOR NTI#24861                    
         BE    *+12                                                             
         CLI   DBDAYOPT,DBDYOPE                                                 
         BNE   GETNTI5B                                                         
         GOTO1 AGETDQ,0             IF DTLIST, SET DAY                          
*                                                                               
GETNTI5B BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   GETNTI5C                                                         
         OC    DBSELPRG,DBSELPRG    IF PROG NUMBER GIVEN                        
         BZ    GETNTI5C                                                         
         GOTO1 AGETDQ,0             IF DTLIST, SET DAY                          
         OC    DBSELDAY,DBSELDAY    MUST ALSO HAVE A DAY                        
         BNZ   *+12                                                             
         MVI   DBERROR,EOF                                                      
         B     GETX                                                             
*                                                                               
GETITND  MVI   DAYCODE,X'40'                                                    
GETITND1 ZIC   R1,DAYCODE                                                       
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    DBSELDAY,0                                                       
         BO    GETNTI5C            USE THIS DAY                                 
GETITND3 MVI   DBLSTNXT,0          START FROM THE BEGINNING(NOT SEQ)            
         ZIC   R1,DAYCODE          TRY NEXT DAY                                 
         SRL   R1,1                                                             
         LTR   R1,R1                                                            
         BNZ   *+12                                                             
         MVI   DBERROR,EOF                                                      
         B     GETX                COVERED ALL DAYS IS DBSELDAY                 
         STC   R1,DAYCODE                                                       
         B     GETITND1                                                         
*                                                                               
GETNTI5C OC    DBSELPRG,DBSELPRG                                                
         BZ    *+8                                                              
         BRAS  RE,REDIRECT         REDIRECT ADJUSTED PROG NUMBERS               
*                                                                               
         CLI   DBSELSTA+4,X'88'    LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   DBSELSTA+4,C'H'     FOR NHI NAD                                  
         BE    *+8                                                              
         CLI   DBSELSTA+4,C'M'     FOR SYNDICATION NAD                          
         BE    *+8                                                              
         CLI   DBSELSTA+4,C'S'     OR SYNDICATION NTI                           
         BNE   GETNTI5Q                                                         
         OC    DBSELPRG,DBSELPRG   PROGRAM REQUESTS ONLY                        
         BZ    GETNTI5Q                                                         
         LA    R2,DBKEY            EQUATE SYNDICATION STATIONS                  
         USING PKKEY,R2            USING PROGRAM NUMBER                         
         XC    PKKMAJOR,PKKMAJOR                                                
         MVI   PKCODE,PKCODEQU                                                  
         MVC   PKMEDIA,INTMED                                                   
         CLI   PKMEDIA,C'H'                                                     
         BNE   *+8                                                              
         MVI   PKMEDIA,C'N'                                                     
         CLI   DBMEDOVR,0          OVERRIDE MEDIA                               
         BE    *+10                                                             
         MVC   PKMEDIA,DBMEDOVR                                                 
         CLI   DBSELMED,C'W'                                                    
         BNE   *+8                                                              
         MVI   PKMEDIA,C'W'                                                     
         MVC   PKSRC,DBACTSRC                                                   
*                                                                               
         CLI   SPNETFLG,0          SPOT->NET LK UP                              
         BE    *+8                                                              
         MVI   PKSRC,C'N'          ACTUAL SOURCE IS ALWAYS NIELSEN              
         MVC   PKBOOK,DBACTBK                                                   
         OC    DBACTBK,DBACTBK                                                  
         BNZ   *+10                                                             
         MVC   PKBOOK,DBSELBK                                                   
         MVC   PKSTAT,DBACTSTA                                                  
         OC    DBACTSTA,DBACTSTA                                                
         BNZ   *+10                                                             
         MVC   PKSTAT,DBSELSTA                                                  
         CLI   DBCABNUM,0          ONLY NEED TO CHECK FIRST BYTE                
         BE    *+10                                                             
         MVC   PKSTAT(4),DBCABNUM                                               
         MVC   PKBTYP,DBBTYPE      SET BOOK TYPE                                
         MVC   PKPNUM+1(2),DBSELPRG                                             
*                                                                               
         CLI   DBACTSRC,C'C'       MONITOR PLUS                                 
         BNE   *+12                                                             
         MVI   PKMEDIA,C'C'                                                     
         MVI   PKSRC,C'N'                                                       
*****                                                                           
*****                                                                           
* THIS CODE IS A TEMPORARY FIX FOR SYNDICATOR PROGRAMS THAT HAVE                
* DUPLICATE NTI NUMBERS. IT FORCES A MATCH ON THE STATION CODE                  
* FOR THE PROGRAMS THAT ARE AFFECTED.                                           
         L     RE,=A(SYNFIXT)      THIS CODE IS USED IN THE EVENT OF            
         A     RE,RELO1            DUPLICATE NTI NUMBERS ON FILE                
FIXLOOP  CLC   =X'FFFF',0(RE)                                                   
         BE    FIXLOOPX                                                         
         CLC   DBSELPRG,0(RE)                                                   
         BNE   *+14                                                             
         CLC   DBSELSTA,2(RE)                                                   
         BE    *+12                                                             
         LA    RE,L'SYNFIXT(RE)                                                 
         B     FIXLOOP                                                          
*                                                                               
         MVC   PKSTA,DBSELSTA      MATCH ON STATION                             
*                                                                               
FIXLOOPX DS    0H                                                               
******                                                                          
******                                                                          
ITNDAY   CLC   =C'SIN S',DBSELSTA                                               
         BNE   *+14                                                             
         MVC   PKSTA,=C'SIN S'                                                  
         B     ITNDAY1                                                          
         CLC   =C'ITN S',DBSELSTA                                               
         BNE   ITNDAYX                                                          
         MVC   PKSTA,=C'ITN S'                                                  
ITNDAY1  ZIC   R1,DAYCODE                                                       
         LA    RE,X'40'                                                         
         LA    R0,1                                                             
ITNDAY2  EX    RE,*+8                                                           
         B     *+8                                                              
         TM    DAYCODE,0                                                        
         BO    ITNDAY4                                                          
         SRL   RE,1                                                             
         LTR   RE,RE                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AHI   R0,1                                                             
         B     ITNDAY2                                                          
ITNDAY4  STC   R0,PKSTA+3                                                       
ITNDAYX  DS    0H                                                               
*                                                                               
         MVI   IOFLAG,DIR+HIGH                                                  
         GOTO1 AIO,IOFLAG                                                       
         BNE   GETX                                                             
         CLC   PKPNUM+1(2),DBSELPRG                                             
         BNE   GETNTI5Q                                                         
         MVC   DBACTSTA,PKSTA                                                   
         CLC   =C'SIN S',DBSELSTA                                               
         BE    *+10                                                             
         CLC   =C'ITN S',DBSELSTA                                               
         BE    *+14                                                             
         OC    DBACTSTA(4),=C'    '                                             
         B     GETNTI5Q            FOR ITN                                      
         CLC   KEYSAVE,PKKEY       NEED EXACT KEY, INCLUDING STATION            
         BNE   GETITND3                                                         
*                                                                               
         DROP  R2                                                               
         SPACE 1                                                                
GETNTI5Q LA    R2,DBKEY            BUILD 'Q' RECORD KEY                         
         USING PMKEY,R2                                                         
         XC    PMKMAJOR,PMKMAJOR                                                
         MVI   PMCODE,PMCODEQU                                                  
         MVC   PMMEDIA,INTMED                                                   
*                                                                               
         CLI   DBBTYPE,C'U'        TVQ LK UP?                                   
         BE    *+10                STATION TYPE NOT AVAILABLE                   
         MVC   PMSTYP,DBSTYPE                                                   
*                                                                               
         CLI   PMMEDIA,C'H'                                                     
         BNE   *+8                                                              
         MVI   PMMEDIA,C'N'                                                     
         CLI   DBMEDOVR,0          OVERRIDE MEDIA                               
         BE    *+10                                                             
         MVC   PMMEDIA,DBMEDOVR                                                 
         CLI   DBSELMED,C'W'                                                    
         BNE   *+8                                                              
         MVI   PMMEDIA,C'W'                                                     
         MVC   PMSRC,DBACTSRC                                                   
         CLI   SPNETFLG,0          SPOT->NET LK UP                              
         BE    *+8                                                              
         MVI   PMSRC,C'N'          ACTUAL SOURCE IS ALWAYS NIELSEN              
         MVC   PMBOOK,DBACTBK                                                   
         OC    DBACTBK,DBACTBK                                                  
         BNZ   *+10                                                             
         MVC   PMBOOK,DBSELBK                                                   
         MVC   PMSTAT,DBACTSTA                                                  
         OC    DBACTSTA,DBACTSTA                                                
         BNZ   *+10                                                             
         MVC   PMSTAT,DBSELSTA                                                  
         CLI   DBCABNUM,0          ONLY NEED TO CHECK FIRST BYTE                
         BE    *+10                                                             
         MVC   PMSTAT(4),DBCABNUM                                               
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   *+18                                                             
         OC    DBSELPRG,DBSELPRG                                                
         BNZ   *+8                                                              
         MVI   PMSTAT+3,1          START WITH MONDAY                            
         MVC   PMBTYP,DBBTYPE      SET BOOK TYPE                                
         TM    SPNETFLG,SPNHTQ+SPNADQ                                           
         BZ    *+8                 BYPASS FOR NAD OR NHT FILES                  
         MVI   PMBTYP,0            SET BOOK TYPE                                
*                                                                               
         CLI   DBACTSRC,C'C'       MONITOR PLUS                                 
         BNE   *+12                                                             
         MVI   PMMEDIA,C'C'                                                     
         MVI   PMSRC,C'N'                                                       
*                                                                               
*******************THESE FORCE OPI LOOKUP FOR TESTING***                        
*        MVI   PMBTYP,C'U'                             *                        
*        MVI   PMSTYP,1                                *                        
*        MVC   PMBOOK,=X'6601'                         *                        
*        MVC   PMBTYP+1(4),=C'A110'                    *                        
********************************************************                        
         MVC   DBMINKEY,DBSELPRG                                                
GETNTI5E MVI   IOFLAG,FILE+READ                                                 
         OC    DBSELPRG,DBSELPRG   TEST FOR PROGRAM NUMBER                      
         BNZ   *+8                                                              
         MVI   IOFLAG,FILE+HIGH    SWITCH TO READ HIGH                          
         GOTO1 AIO,IOFLAG                                                       
         BE    GETNT15R                                                         
*                                                                               
         LA    R1,KEYSAVE                                                       
*                                                                               
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   GETNTI5F                                                         
         OC    DBSELPRG,DBSELPRG                                                
         BNZ   GETNTI5F                                                         
         CLC   DBKEY(PMSTAT-PMKEY-2),KEYSAVE   MATCH UP TO DAY IN STATN         
         BNE   GETNTI5F                                                         
         MVC   DBKEY,KEYSAVE                                                    
         ZIC   RE,PMSTAT+3                                                      
         LA    RE,1(RE)                                                         
         CHI   RE,7                                                             
         BH    GETNTI5F                                                         
         STC   RE,PMSTAT+3                                                      
         XC    PMOPIID(11),PMOPIID        CLEAR REST OF KEY                     
         MVI   DBLSTNXT,0                 START OVER                            
         B     GETNTI5E                   GO READ FILE FOR NEXT DAY             
*                                                                               
GETNTI5F CLI   PMSTAT-PMKEY+4(R1),C'T'       NTI                                
         BNE   GETNTI5S                                                         
         CLI   DBKEY+(PMBTYP-PMKEY),C'U'                                        
         BE    *+14                                                             
         CLC   DBKEY(PMSTAT-PMKEY+4),KEYSAVE   LOOK UP DAILY'S?                 
         BE    GETNTI5S            NO, THERE'S ALREADY DATA FOR THE BK          
         BAS   RE,TSTDYL           TEST ACCESS TO DAILIES ALLOWED               
         BNE   GETNTI5S                                                         
         MVC   DBACTSTA,DBSELSTA                                                
         MVI   DBACTSTA+4,C'D'     LOOK UP DAILIES                              
         MVC   DBKEY,KEYSAVE                                                    
         MVC   PMSTAT,DBACTSTA                                                  
         B     GETNET6E            READ DIR FOR DAILY'S KEY                     
*                                                                               
GETNTI5S CLI   PMSTAT+4,C'T'       NTI- REGULAR, NOT DAILIES                    
         BE    *+8                                                              
         CLI   PMSTAT+4,C'S'       NTI-SYN                                      
         BE    *+8                                                              
         CLI   PMSTAT+4,C'D'       NTI-DAILIES                                  
         BE    *+8                                                              
         CLI   PMSTAT+4,X'88'      NHTI WEIGHTED                                
         BE    *+8                                                              
         CLI   PMSTAT+4,C'H'       NHTI                                         
         BE    *+8                                                              
         CLI   PMSTAT+4,C'I'       IAG                                          
         BE    *+8                                                              
         CLI   PMSTAT+4,C'N'       NAD                                          
         BE    *+12                                                             
         CLI   PMSTAT+4,C'M'       NAD-SYN                                      
         BNE   GETX                                                             
         MVC   DBKEY,KEYSAVE       RESTORE SEARCH KEY                           
         B     GETNTI6B                                                         
*                                                                               
GETNT15R MVC   DBNDXDA2,DBNDXDA    SAVE D/A                                     
         MVC   DBSTATU2,DBSTATUS   SAVE STATUS BYTE                             
         ICM   R7,15,DBAOPT        TEST FOR OPTIMIZATION                        
         BZ    GETNTI6             NO                                           
         SR    RE,RE                                                            
         ICM   RE,3,2(R7)          DISPLACMENT TO NEXT OPT ENTRY                
         BZ    GETNTI6             NONE-SO NO ENTRY TO BE ADDED                 
         LR    RF,R7               SAVE START OF AREA                           
         LA    RE,0(R7,RE)         RE NOW POINTS TO NEXT ENTRY                  
         LR    R1,RE               PUT A(NEXT OPT ENTRY) IN R1                  
         LA    RE,NOPTLEN(RE)      ADD LEN OF 1 ENTRY                           
         A     R7,DBLOPT           END OF OPT AREA                              
         CR    RE,R7               TEST FOR ENOUGH ROOM LEFT                    
         BH    GETNTI6             NO                                           
*                                                                               
         USING NOPTD,R1                                                         
         MVC   NOPTBK,PMBOOK                                                    
         MVC   NOPTSTA,PMSTAT                                                   
         MVC   NOPTDA,DBNDXDA                                                   
         MVC   NOPTST,DBSTATUS                                                  
         SR    RE,RF               LEN USED SO FAR                              
         STCM  RE,3,0(RF)                                                       
         XC    2(2,RF),2(RF)       CLEAR DISP TO NEXT OPT ENTRY                 
         DROP  R1                                                               
         SPACE 1                                                                
GETNTI6  DS    0H                                                               
         CLI   DBLSTNXT,1          RE-ENTRY ON ALL PRG FOR BK/STA               
         BNE   GETNTI7                                                          
GETNTI6A MVI   IOFLAG,FILE+SEQ     RETURN HERE FOR SIMPLE SEQUNTIAL             
         GOTO1 AIO,IOFLAG                                                       
         BE    GETNTI7                                                          
*                                                                               
         BRAS  RE,FIXPROG           FIX POSTING FOR NTI#24861                   
         BE    *+12                                                             
         CLI   DBDAYOPT,DBDYOPE                                                 
         BNE   *+14                                                             
         OC    DBSELPRG,DBSELPRG                                                
         BNZ   GETNTI6B                                                         
*                                                                               
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   GETNTI6B                                                         
         OC    DBSELPRG,DBSELPRG                                                
         BNZ   GETNTI6B                                                         
         MVC   DBKEY,KEYSAVE                                                    
         ZIC   RE,PMSTAT+3                                                      
         LA    RE,1(RE)                                                         
         CHI   RE,7                                                             
         BH    GETNTI6B                                                         
         STC   RE,PMSTAT+3                                                      
         XC    PMOPIID(11),PMOPIID        CLEAR REST OF KEY                     
         MVI   DBLSTNXT,0                 START OVER                            
         B     GETNTI5E                   GO READ FILE FOR NEXT DAY             
*                                                                               
GETNTI6B DS    0H                                                               
*        CLI   PMBTYP,C'U'         NO SPECIALS/BREAKOUTS FOR USER               
*        BE    GETX                                                             
         CLI   PMSTAT+4,C'C'       CABLE?                                       
         BE    GETNTI6C                                                         
         CLI   PMSTAT+4,C'D'       NTI-DAILIES?                                 
         BE    GETNTI6C                                                         
         CLI   PMSTAT+4,C'S'       EOF. FOR CERTAIN FILES LK UP SPCLS           
         BE    GETNTI6C                                                         
         CLI   PMSTAT+4,C'T'       NTI?                                         
         BE    GETNTI6C                                                         
         CLI   PMSTAT+4,X'88'      EOF. IF NHTI WEIGHTED                        
         BE    GETNTI6C                                                         
         CLI   PMSTAT+4,C'H'       EOF. IF NHTI:                                
         BE    GETNTI6C                                                         
         CLI   PMSTAT+4,C'N'       EOF. IF NAD:                                 
         BE    GETNTI6C                                                         
         CLI   PMSTAT+4,C'I'       EOF. IF IAG:                                 
         BE    GETNTI6C                                                         
         CLI   PMSTAT+4,C'M'       NAD-SYN?                                     
         BNE   GETX                FOR OTHER FILES, EOF                         
GETNTI6C XC    PMBTYP+1(PMDATA-PMBTYP+1),PMBTYP+1  CLEAR KEY FIELDS             
         MVI   DBERROR,EOF                                                      
         CLI   PMBTYP,C'U'         NO SPECIALS/BREAKOUTS FOR USER               
         BE    GETX                                                             
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   *+18                                                             
         OC    DBSELPRG,DBSELPRG                                                
         BZ    GETX                                                             
         B     GETITND3            FOR ITN & PROG, PROCESS NEXT DAY             
*                                                                               
         CLI   PMSTYP,X'00'        REGULAR PRMS?                                
         BNE   *+12                                                             
         MVI   PMSTYP,C'B'         YES, NOW READ FOR BREAKOUTS                  
         B     GETNET6E                                                         
         CLI   PMSTYP,C'B'         FINISHED READING FOR BREAKOUTS?              
         BNE   GETX                IF 'S' OR ANYTHING ELSE -> EOF               
         MVI   PMSTYP,C'S'         NOW READ FOR SPECIALS                        
         B     GETNET6E                                                         
*                                                                               
GETNET6E DS    0H                                                               
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   *+18                                                             
         OC    DBSELPRG,DBSELPRG                                                
         BNZ   *+8                                                              
         MVI   PMSTAT+3,1          START OVER FROM MONDAY                       
*                                                                               
GETNET6F MVI   IOFLAG,DIR+HIGH     RDHIGH ON NEW KEY                            
         GOTO1 AIO,IOFLAG                                                       
         MVC   DBNDXDA2,DBNDXDA    SAVE D/A                                     
         MVC   DBSTATU2,DBSTATUS   SAVE STATUS BYTE                             
         L     R1,DBAREC                                                        
         CLC   PMKEY(PMBTYP+1-PMKEY),KEYSAVE                                    
*        BE    *+14                NO BRKOUTS/SPCLS FOR THIS BOOK               
         BE    GETNET6G                                                         
         MVC   DBKEY,KEYSAVE       RESTORE KEY USED IN CALL                     
*        B     GETNTI6B                                                         
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   GETNTI6B                                                         
         OC    DBSELPRG,DBSELPRG                                                
         BNZ   GETNTI6B                                                         
         ZIC   RE,PMSTAT+3                                                      
         LA    RE,1(RE)                                                         
         CHI   RE,7                                                             
         BH    GETNTI6B                                                         
         STC   RE,PMSTAT+3                                                      
         B     GETNET6F                                                         
*                                                                               
GETNET6G DS    0H                                                               
         MVI   IOFLAG,FILE+HIGH                                                 
         MVC   DBMINKEY,DBSELPRG                                                
         OC    DBSELPRG,DBSELPRG   READ FOR SPECIFIC RECD                       
         BZ    *+8                                                              
         MVI   IOFLAG,FILE+READ                                                 
         GOTO1 AIO,IOFLAG                                                       
         BNE   GETNTI6B            NO RECDS OR NO SPEC PRGM RECD                
         LTR   R1,R1                                                            
*                                                                               
GETNTI7  DS    0H                                                               
         OC    DBCABNUM,DBCABNUM                                                
         BZ    GETNTI7A                                                         
         CLI   DBBTYPE,C'C'        MONITOR PLUS                                 
         BE    GETNTI7A                                                         
         L     RF,DBAREC   <-----  BYPASS NON PROGRAM RECORDS                   
         AH    RF,DBDTADSP <-----                                               
         CLI   0(RF),1     <-----                                               
         BNE   GETNTI6A    <-----                                               
         LA    RF,8(RF)    <-----                                               
         CLI   0(RF),X'0F' <-----                                               
         BNE   GETNTI6A    <-----                                               
         CLI   2(RF),0     <-----                                               
         BNE   GETNTI6A    <-----                                               
*                                                                               
GETNTI7A XC    DBAQUART,DBAQUART                                                
         GOTO1 ATSTMRKT            CHECK ACCESS                                 
         BNE   GETX                                                             
*        BAS   RE,GETNTID                                                       
         BRAS  RE,GETNTID                                                       
*                                                                               
         OC    DBSELPRG,DBSELPRG                                                
         BZ    *+14                                                             
         CLC   DBSELPRG,DBACTPRG                                                
         BNE   GETNTI6B                                                         
*                                                                               
         CLI   DBBTYPE,X'00'       NOT APPLICABLE TO DIARY                      
         BE    GETNTI7C                                                         
         CLI   DBBTYPE,C'U'        NOT APPLICABLE TO USER RECORDS               
         BE    GETNTI7C                                                         
         CLC   PMBOOK,=X'5721'     OPTIONAL DATA STARTS 87/33                   
         BL    GETNTI7C                                                         
*                                                                               
*** IGNORE P+S2 SETTING FROM DCON RECORD                                        
*** IT IS NO LONGER INFORCED FOR NATIONAL (PER JACK LUSHER FEB09)               
***      CLI   DBSATLIT,C'Y'       INDIVIDUAL DAYS AUTHORIZED                   
***      BNE   GETNTI7B            NO - BYPASS OPTION                           
*                                                                               
         CLI   DBDAYOPT,C'A'       ALL AVG + DAYS                               
         BE    GETNTI7C            DON'T DO FILTERING                           
*                                                                               
         BRAS  RE,FIXPROG          FIX POSTING FOR NTI#24861                    
         BE    *+12                                                             
         CLI   DBDAYOPT,DBDYOPE    EXACT DAYS AND PROGRAM                       
         BNE   *+16                                                             
         CLI   DBSELSTA+4,C'S'     FOR SYND USE WEEKLY AVGS                     
         BE    GETNTI7C                                                         
         B     *+12                                                             
         CLI   DBDAYOPT,C'I'       INDIVIDUAL DAYS ONLY                         
         BNE   GETNTI7B            NO - DO POCKETPIECE LINES                    
         CLI   DUB+2,X'10'         M-F                                          
         BL    GETNTI6A            SKIP IT                                      
         CLI   DUB+2,X'80'         M-S OR VAR                                   
         BNL   GETNTI6A                                                         
         B     GETNTI7C            INDIV. DAY - USE IT                          
         SPACE 1                                                                
GETNTI7B CLI   DUB+2,X'00'         M-F                                          
         BE    *+12                                                             
         CLI   DUB+2,X'80'         M-S OR VAR                                   
         BL    *+14                                                             
         MVC   WORK+4(2),DBACTPRG  SAVE PROGRAM NUMBER                          
         B     GETNTI7C                                                         
         CLI   DUB+2,X'70'         TEST INDIV. DAYS (MON THRU SUN)              
         BH    *+14                (BOGUS TEST)                                 
         CLC   WORK+4(2),DBACTPRG                                               
         BE    GETNTI6A            BYPASS INDIV. DAY                            
         XC    WORK+4(2),WORK+4                                                 
*                                                                               
GETNTI7C DS    0H                                                               
*                                                                               
         BRAS  RE,FIXPROG          FIX POSTING FOR NTI#24861                    
         BE    *+12                                                             
         CLI   DBDAYOPT,DBDYOPE    FOR EXACT OPTION,                            
         BNE   *+20                                                             
         BRAS  RE,DAYFILT          FILTER ON DAY                                
         BNE   GETNTI6A                                                         
         BRAS  RE,TIMEFILT         AND TIME                                     
         BNE   GETNTI6A                                                         
*                                                                               
         BAS   RE,SYNBFILT         FILTER SYND BREAKOUTS ON DAY                 
         BNE   GETNTI6A            NO MATCH ON DAY FOR SYND BKTS. RDSEQ         
*                                                                               
         CLI   DBSELSTA+4,X'88'    NTHI DATA?                                   
         BE    *+8                 LOWER CASE 'H'= WEIGHTED HISP                
         CLI   DBSELSTA+4,C'H'     UPPER CASE = REG HISPANIC                    
         BNE   GETNTI7D                                                         
         TM    DBCNTRL+2,X'04'     AUTHORIZED TO SPAN DOM DATA?                 
         BO    *+8                 YES                                          
         BAS   RE,DELSPDM          NO, DELETE OPTNL DATA FROM RECD              
*                                                                               
GETNTI7D MVC   DBACTDAY,DUB+2      RETURN DAY CODE FOR DEFINE                   
         ZIC   R1,DUB+3                                                         
         STH   R1,DBFACTOR                                                      
         AH    R1,DBDIVSOR                                                      
         STH   R1,DBDIVSOR                                                      
         MVI   DBMODE,DBMFRST                                                   
         MVI   DBRECTYP,DBRECNTI                                                
         MVI   DBMODE,DBMNEXT      SEQUENTIAL MODE                              
         MVI   DBLSTNXT,1          SET FOR RE-ENTRY(NO HOOK)                    
         MVC   WORKSV+10(2),DBINTFIL                                            
*                                                                               
         MVC   SVDQPTR,DBDQPTR                                                  
         MVI   RSTMB,0                                                          
         CLI   SPNETFLG,0          SPOT-NETWORK CALL?                           
         BE    USRHK                                                            
         MVI   DBDQPTR,1           FOR SPOT INDICATE ONLY ONE ENTRY             
         MVC   SVACTBK,DBACTBK                                                  
         MVC   SVACTSTA,DBACTSTA                                                
         L     RE,DBAREC           PT TO RECD TO PASS BACK                      
         MVC   DBACTBK,PMBOOK-PMKEY(RE)                                         
         MVC   DBACTSTA,PMSTAT-PMKEY(RE)                                        
         TM    SPNETFLG,SPNHTQ     SPOT-NHT CALL?                               
         BNO   USRHK                                                            
*        BAS   RE,GETMB            GET MKT BRK FOR CALL                         
         BRAS  RE,GETMB            GET MKT BRK FOR CALL                         
*        BZ    *+8              <-- BYPASS USER HOOK                            
         BZ    USRHS            <-- BYPASS USER HOOK                            
*                                                                               
USRHK    DS    0H                                                               
         MVI   DAYEFLAG,0                                                       
DAYEXCT  BRAS  RE,FIXPROG          FIX POSTING FOR NTI#24861                    
         BE    *+12                                                             
         CLI   DBDAYOPT,DBDYOPE    EXACT PROGRAM AND DAY                        
         BNE   DAYEXCTX                                                         
         CLI   DBSELSTA+4,C'S'     FOR SYNDICATION                              
         BE    *+12                                                             
         CLI   DBSELSTA+4,C'N'     AND NAD                                      
         BNE   DAYEXCTX                                                         
         MVI   DAYEFLAG,1          SEND ONE RECD FOR EACH DAY IN THE            
         MVC   WKDAYS,ACTDAY       WEEKLY AVERAGE                               
         MVI   CURRDAY,X'40'       START WITH MONDAY                            
         MVI   CURRDAY+1,X'10'                                                  
         ZIC   R1,CURRDAY          BYTE1: MON='40',TUE='20'...SUN=X'01'         
DAYEXCT1 LTR   R1,R1               BYTE2: MON='10',TUE='20'...SUN=X'70'         
         BZ    USRHS                                                            
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    WKDAYS,0                                                         
         BO    DAYEXCT3                                                         
DAYEXCT2 ZIC   RE,CURRDAY                                                       
         SRL   R1,1                                                             
         STC   R1,CURRDAY                                                       
         ZIC   R0,CURRDAY+1                                                     
         AHI   R0,X'10'                                                         
         STC   R0,CURRDAY+1                                                     
         B     DAYEXCT1                                                         
DAYEXCT3 MVC   ACTDAY,CURRDAY                                                   
         BRAS  RE,DAYFILT                                                       
         BNE   DAYEXCT2            TRY NEXT DAY                                 
         MVC   DBACTDAY,CURRDAY+1  ACTUAL DAY FOR DEFINE                        
         B     USRHGO                                                           
DAYEXCTX DS    0H                                                               
*                                  SAVE REGS & GO TO USER HOOK                  
*                                                                               
USRHGO   BAS   RE,GETX             HOOK TO USER FOR ALL PROGRAMS                
*                                                                               
*                                                                               
DAYEXCT5 CLI   DAYEFLAG,1                                                       
         BNE   USRHS                                                            
         B     DAYEXCT2            SEND RECORD FOR NEXT DAY                     
*                                                                               
USRHS    MVC   DBDQPTR,SVDQPTR                                                  
         MVC   DBINTFIL(2),WORKSV+10                                            
         CLI   SPNETFLG,0          SPOT-> NHT OR NAD CALL?                      
         BE    *+16                                                             
         MVC   DBACTBK,SVACTBK     RESTORE ORIGINAL VALUE                       
         MVC   DBACTSTA,SVACTSTA   RESTORE ORIGINAL VALUE                       
         CLI   RSTMB,C'Y'          RESET RCD PTR AFTER MKTBRK LK UP             
*        BNE   *+8                                                              
*        BAS   RE,RSETMB                                                        
         BNE   USRH1                                                            
         GOTO1 =A(RSETMB),RR=Y                                                  
USRH1    OC    DBSELPRG,DBSELPRG   TEST FOR PROGRAM NUMBER READ                 
         BZ    GETNTI6                                                          
         OC    DBFACTOR,DBFACTOR   AND PROGRAM NOT FOUND                        
         BZ    GETNTI6B            READ 'B' & 'S' RECDS FOR PRGM                
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BE    GETITND3                                                         
*                                                                               
         BRAS  RE,FIXPROG          FIX POSTING FOR NTI#24861                    
         BE    *+12                                                             
         CLI   DBDAYOPT,DBDYOPE    EXACT DAY/PROGRAM OPTION                     
         BNE   USRHEND                                                          
         B     GETNTI6A                                                         
*        CLI   DBERROR,0                                                        
*        BNE   GETNTI6A            CONTINUE READING THE OTHER DAYS              
*        B     GETNTI6B            GET BKOUTS AND SPECIALS NOW                  
                                                                                
USRHEND  MVI   DBERROR,EOF         OTHERWISE END                                
         B     GETX                                                             
         EJECT                                                                  
GETOPI   DS    0H                                                               
         XC    DBFACTOR,DBFACTOR                                                
*        OC    DBSELOPI,DBSELOPI   ONLY SUPPORT SINGLE PROGRAM                  
*        BZ    GETX                                                             
         LA    R2,DBKEY                                                         
         USING PMKEY,R2                                                         
         XC    PMKMAJOR,PMKMAJOR                                                
         MVI   PMCODE,PMCODEQU                                                  
         MVC   PMMEDIA,INTMED                                                   
*        CLI   PMMEDIA,C'H'                                                     
*        BNE   *+8                                                              
         MVI   PMMEDIA,C'N'                                                     
         CLI   DBMEDOVR,0                                                       
*        BNE   *+10                                                             
*        MVC   PMMEDIA,DBMEDOVR                                                 
         MVC   PMSRC,DBACTSRC      ?                                            
         MVC   PMBOOK,DBACTBK                                                   
         OC    DBACTBK,DBACTBK                                                  
         BNZ   *+10                                                             
         MVC   PMBOOK,DBSELBK                                                   
         MVC   PMSTAT,DBACTSTA                                                  
         OC    DBACTSTA,DBACTSTA                                                
         BNZ   *+10                                                             
         MVC   PMSTAT,DBSELSTA                                                  
         MVI   PMBTYP,C'U'         FILE SPECIFIC BTYPE                          
         MVI   PMSTYP,1            FILE SPECIFIC STYP                           
         MVC   PMOPIID,DBSELOPI    PROGRAM ID                                   
         MVC   DBMINKEY,=H'1'      ONLY ONE REC PER KEY                         
         OC    DBSELOPI,DBSELOPI                                                
         BZ    GETOPI5                                                          
         OC    PMOPIID(4),=CL6' '     FORCE ALPHA                               
         MVI   IOFLAG,FILE+READ                                                 
         GOTO1 AIO,IOFLAG                                                       
         BE    GETOPI6                                                          
         B     GETX                                                             
GETOPI5  MVI   IOFLAG,DIR+HIGH                                                  
         GOTO1 AIO,IOFLAG                                                       
         BE    *+8                                                              
         B     GETX                                                             
         MVI   IOFLAG,FILE+READ                                                 
         GOTO1 AIO,IOFLAG                                                       
         BE    *+8                                                              
         B     GETX                                                             
         L     R2,DBAREC                                                        
         MVI   DBERROR,EOF                                                      
         CLC   PMBOOK,DBSELBK                                                   
         BNE   GETX                                                             
         CLC   PMSTAT,DBSELSTA                                                  
         BNE   GETX                                                             
         LA    R2,DBKEY                                                         
         MVI   DBERROR,0                                                        
GETOPI6  CLI   DBLSTNXT,1          RE-ENTRY ON ALL PRG FOR BK/STA               
         BNE   GETOPI7                                                          
GETOPI6A MVI   IOFLAG,DIR+SEQ      RETURN HERE FOR SIMPLE SEQUNTIAL             
         GOTO1 AIO,IOFLAG                                                       
         BE    *+12                                                             
         MVI   DBERROR,EOF                                                      
         B     GETX                                                             
         MVI   IOFLAG,FILE+READ                                                 
         GOTO1 AIO,IOFLAG                                                       
         BE    *+8                                                              
         B     GETX                                                             
         L     R2,DBAREC                                                        
         MVI   DBERROR,EOF                                                      
         CLC   PMBOOK,DBSELBK                                                   
         BNE   GETX                                                             
         CLC   PMSTAT,DBSELSTA                                                  
         BNE   GETX                                                             
         LA    R2,DBKEY                                                         
         MVI   DBERROR,0                                                        
*                                                                               
GETOPI7  LHI   R1,1                                                             
         STH   R1,DBFACTOR                                                      
         AH    R1,DBDIVSOR                                                      
         STH   R1,DBDIVSOR                                                      
*        BAS   RE,GETNTID                                                       
         BRAS  RE,GETNTID                                                       
         MVI   DBRECTYP,DBRECNTI                                                
         OC    DBSELOPI,DBSELOPI                                                
         JNZ   *+8                                                              
         MVI   DBMODE,DBMNEXT      SEQUENTIAL MODE                              
         BAS   RE,GETX                                                          
         OC    DBSELOPI,DBSELOPI                                                
         JNZ   GETOPI8                                                          
         MVI   DBMODE,DBMNEXT      SEQUENTIAL MODE                              
         MVI   DBLSTNXT,1          SET FOR RE-ENTRY(NO HOOK)                    
         B     GETOPI6                                                          
GETOPI8  MVI   DBERROR,EOF                                                      
         B     GETX                                                             
*                                                                               
**********************************************************************          
* DAY/TIME FILTERING USING PASSIVE 'N' RECORDS                                  
**********************************************************************          
*                                                                               
GETNTI10 DS    0H                                                               
*        OC    AUSERRTN,AUSERRTN   TEST FOR USER HOOK                           
*        BNZ   *+6                                                              
*        DC    H'0'                BLOW UP FOR MISSING HOOK                     
         LA    R2,DBKEY                                                         
         USING PNKEY,R2                                                         
         XC    DBLSTDIR(L'DBKEY),DBLSTDIR   BUILD KEY AND READ FOR ANY          
         MVI   PNCODE,PNCODEQU     RECORDS FOR BOOK/STATION                     
         MVC   PNMEDIA,INTMED                                                   
         CLI   PNMEDIA,C'H'                                                     
         BNE   *+8                                                              
         MVI   PNMEDIA,C'N'                                                     
         CLI   DBMEDOVR,0          OVERRIDE MEDIA                               
         BE    *+10                                                             
         MVC   PNMEDIA,DBMEDOVR                                                 
         CLI   DBSELMED,C'W'                                                    
         BNE   *+8                                                              
         MVI   PNMEDIA,C'W'                                                     
         MVC   PNSRC,DBACTSRC                                                   
         CLI   SPNETFLG,0          SPOT->NET LK UP                              
         BE    *+8                                                              
         MVI   PNSRC,C'N'          ACTUAL SOURCE IS ALWAYS NIELSEN              
         MVI   PNIND,PNINDEQU                                                   
         MVC   PNBOOK,DBACTBK                                                   
         OC    DBACTBK,DBACTBK                                                  
         BNZ   *+10                                                             
         MVC   PNBOOK,DBSELBK                                                   
         MVC   PNSTAT,DBACTSTA                                                  
*                                                                               
         OC    DBACTSTA,DBACTSTA                                                
         BNZ   *+10                                                             
         MVC   PNSTAT,DBSELSTA                                                  
         CLI   DBCABNUM,0          ONLY NEED TO CHECK FIRST BYTE                
         BE    *+10                                                             
         MVC   PNSTAT(4),DBCABNUM                                               
         MVI   PNBTYP,0           INIT TO ZERO FOR NHT-SPOT CALL                
*                                                                               
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   *+10                                                             
         MVC   PNSTAT+3(2),=X'0000'  READ ANY DAY FIRST                         
*                                                                               
         CLI   DBBTYPE,C'C'        MONITOR PLUS FILE                            
         BNE   *+12                USE REGULAR POINTERS                         
         MVI   PNBTYP,C'A'                                                      
         B     MPLUSOK                                                          
*                                                                               
         TM    SPNETFLG,SPNHTQ+SPNADQ                                           
         BNZ   *+10                BYPASS FOR NAD OR NHT FILES                  
         MVC   PNBTYP,DBBTYPE      SET BOOK TYPE                                
MPLUSOK  MVI   IOFLAG,DIR+HIGH                                                  
         BAS   RE,RDBUF                                                         
         BNE   GETX                                                             
*                                                                               
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   *+18                                                             
         CLC   PNKEY(PNDW-PNKEY-2),KEYSAVE CHECK FOR HIT ON BOOK/STAT           
         BE    GETNT10A                    LESS DAY IN STATION NAME             
         B     GETDAYL                                                          
*                                                                               
         CLC   PNKEY(PNDW-PNKEY),KEYSAVE   CHECK FOR HIT ON BOOK/STAT           
         BE    GETNT10A                                                         
*                                                                               
GETDAYL  DS    0H                                                               
         CLI   DBSTYPE,X'00'                                                    
         BNE   GETNTI18                                                         
         LA    R1,KEYSAVE                                                       
         CLI   PNSTAT+4-PNKEY(R1),C'T'       SEARCHING FOR NTI DATA?            
         BNE   GETNTI18            EOF. GET BRKS OR SPECIALS NEXT               
         BAS   RE,TSTDYL           TEST SECURITY                                
         BNE   GETNTI18            ACCESS DENIED                                
         MVC   DBACTSTA,DBSELSTA   TRY DAILY DATA                               
         MVI   DBACTSTA+4,C'D'                                                  
         B     GETNTI10                                                         
*                                                                               
GETNT10A MVC   DIRSAVE,PNKEY                                                    
         GOTO1 AGETDQ,0                                                         
         MVI   DBACTDAY,0          RE-CLEAR ACTUAL DAY                          
         LA    R5,DBDQTAB          R5 POINTS TO DAY/QH TABLE                    
DBDQ     USING DBDQD,R5                                                         
         MVI   DBDQ.DBDQKDAY,X'10' START AT MONDAY                              
         MVI   DBDQ.DBDQDAYW,7     COUNTER OF DAYS TO PROCESS                   
         MVC   DBACTSQH,DBDQ.DBDQSQH    REQUESTED SQH                           
         MVC   DBACTEQH,DBDQ.DBDQEQH    REQUESTED EQH                           
         CLI   DBBEST,C'L'         TEST FOR LOOKUP OPTION                       
         BNE   GETNTI11                                                         
         MVI   DBDQ.DBDQKDAY,0     FOR LOOKUP START AT M-F                      
         MVI   DBDQ.DBDQDAYW,9     9 DAYS TO PROCESS                            
         B     GETNTI12                                                         
GETNTI11 CLI   DBSELDAY,X'90'      ARE WE DEALING WITH VAR                      
         BNE   GETNTI12                                                         
         MVI   DBDQ.DBDQKDAY,X'90' FOR LOOKUP START AT VAR                      
         MVI   DBDQ.DBDQDAYW,1     1 DAY TO LOOKUP                              
         SPACE                                                                  
GETNTI12 DS    0H                  FIND BIT SETTING FOR DAY CODE                
         L     RE,ADQPNNS          POINT AT FIRST ENTRY                         
         LA    RE,DQHDRLN(RE)                                                   
         USING DQDTAD,RE                                                        
         CLC   DBDQ.DBDQKDAY,DQKDAY  MATCH ON DAY CODE                          
         BE    *+12                                                             
         LA    RE,DQDTALN(RE)                                                   
         B     *-14                                                             
         MVC   WORK(1),DQDAY       EXTRACT BIT SETTING                          
         CLC   =C'ITN S',DBSELSTA                                               
         BNE   *+10                                                             
         CLC   =C'SIN S',DBSELSTA                                               
         BNE   *+10                                                             
         MVC   WORK+2(1),DQKDAY    (1=MON,...,7=SUN)                            
*&&DO                                                                           
         MVC   BYTE,DQKDAY         (1=MON,...,7=SUN)                            
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   *+10                                                             
         MVC   WORK+2(1),BYTE      (1=MON,...,7=SUN)                            
*&&                                                                             
         CLI   DBBEST,C'L'         TEST FOR LOOKUP OPTION                       
         BNE   GETNTBIT            NO, MATCH BITS INSTEAD                       
         TM    SPNETFLG,SPNHTQ                                                  
         BNO   *+12                                                             
         CLI   DBSELDAY,0                                                       
         BE    GETNTI15            ACCEPT ALL DAYS                              
         CLC   DQDAY,DBSELDAY      TEST FOR EXACT MATCH OF DAY                  
         BNE   GETNTI14            BUMP TO NEXT DAY                             
*                                                                               
GETNTBIT SR    R1,R1                                                            
         IC    R1,WORK             TEST FOR ANY MATCH AGAINST                   
         EX    R1,TSTOVER          DBSELDAY                                     
         BNZ   GETNTI15            READ FOR THE DAY CODE                        
         DROP  RE                                                               
         SPACE                                                                  
GETNTI14 DS    0H                  BUMP TO NEXT DAY                             
         ZIC   R1,DBDQ.DBDQKDAY                                                 
         LA    R1,X'10'(R1)                                                     
         STC   R1,DBDQ.DBDQKDAY                                                 
         ZIC   R1,DBDQ.DBDQDAYW    DECREMENT COUNTER                            
         SH    R1,=H'1'                                                         
         BZ    GETNTI18            EOF EXIT                                     
         STC   R1,DBDQ.DBDQDAYW    UPDATE COUNTER                               
         B     GETNTI12            PROCESS NEXT DAY                             
         SPACE                                                                  
TSTOVER  TM    DBSELDAY,0          EXECUTED                                     
         SPACE                                                                  
* FOR A GIVEN DAY, SEE IF ANY PROGRAMS FALL IN TIME RANGE                       
*                                                                               
GETNTI15 DS    0H                                                               
         MVC   PNDW,DBDQ.DBDQKDAY  SET DAY AND                                  
         MVC   PNSTIM,DBDQ.DBDQSQH FIRST QUARTER HOUR                           
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   GETNT15A                                                         
         ZIC   R1,WORK+2                                                        
         SRL   R1,4                                                             
         STC   R1,PNSTAT+3         DAY OF WEEK (MON=1,...,SUN=7)                
         MVI   PNSTAT+4,C'S'                                                    
GETNT15A DS    0H                                                               
*  930324...930330                                                              
         CLI   PNSTAT+4,X'88'      HISPANIC SEARCH ALL                          
         BE    *+8                 LOWER CASE 'H'= WEIGHTED HISP                
         CLI   PNSTAT+4,C'H'       UPPER CASE = REG HISPANIC                    
         BNE   GETNTI16                                                         
         ZIC   RE,DBDQ.DBDQSQH     BACK UP 4 HOURS MAX                          
         SH    RE,=H'16'           SO WE GET ALL PROGRAMS THAT                  
         BP    *+6                 CROSS THIS TIME PERIOD                       
         SR    RE,RE                                                            
         STC   RE,PNSTIM                                                        
*                                                                               
         SPACE                                                                  
GETNTI16 DS    0H                                                               
         XC    PNPNUM(PNKSTAT-PNPNUM),PNPNUM CLEAR REST OF KEY                  
GETNT16A MVI   IOFLAG,DIR+HIGH                                                  
         BAS   RE,RDBUF                                                         
*        GOTO1 AIO,IOFLAG                                                       
         BL    GETX                                                             
         BE    GETNTI17                                                         
         B     GETNTI18                                                         
         SPACE                                                                  
* TEST WHETHER RECORD CONFORMS TO DAY/TIME SPECS                                
*                                                                               
GETNTI17 DS    0H                                                               
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   *+18                                                             
         CLC   PNKEY(PNDW-PNKEY-2),KEYSAVE CHECK FOR HIT ON BOOK/STAT           
         BNE   GETNTI18                    LESS DAY IN STATION NAME             
         B     *+14                                                             
         CLC   PNKEY(PNDW-PNKEY),KEYSAVE     SAME BOOK/STATION                  
         BNE   GETNTI18                      EOF EXIT                           
         CLI   PNBSIND,C'B'                                                     
         BNE   *+8                                                              
         OI    BSSW,BREAKOUT       BREAKOUT EXIST                               
         CLI   PNBSIND,C'S'                                                     
         BNE   *+8                                                              
         OI    BSSW,SPECIAL        SPECIAL EXISTS                               
*                                                                               
         CLC   PNBSIND,DBSTYPE     SAME AS REQUESTED?                           
         BNE   GETNTI19            READ NEXT N-RECD                             
         CLI   PNSTAT+4,X'88'      NHI IS MULTI-PROGRAM/WEEK                    
         BE    *+8                   WEIGHTED HISP                              
         CLI   PNSTAT+4,C'H'         REGULAR HISP                               
         BE    *+8                                                              
         CLI   PNSTAT+4,C'S'       SYND IS MULTI-PROGRAM                        
         BE    *+8                                                              
         CLI   PNSTAT+4,C'M'       NAD SYND IS MULTI-PROGRAM/WEEK               
         BE    *+8                                                              
         CLI   PNSTAT+4,C'T'       REGIONAL PROGRAMS OVERLLAP                   
         BE    *+8                  (ADDED 10/19/95)                            
         CLI   PNSTAT+4,C'N'       NAD IS MULTI-WEEK                            
         BE    *+20                                                             
         TM    PNDW,X'0F'          TEST LO-ORDER NIBBLE OF DAY/WEEK             
         BZ    *+12                TO ELIMINATE DUP POINTERS                    
         CLI   PNACTDUR,14         TEST FOR 15 MIN. OR LONGER                   
         BH    GETNTI19            READ NEXT RECORD                             
         MVC   WORK(1),PNDW        EXTRACT DAY FROM RECORD                      
         NI    WORK,X'F0'                                                       
         CLC   DBDQ.DBDQKDAY,WORK  TEST FOR SAME DAY                            
         BNE   GETNTI14            NO-BUMP TO NEXT ONE                          
         TM    SPNETFLG,SPNHTQ     DON'T TAKE M-F FOR MON ETC                   
         BNO   *+24                                                             
         MVC   WORK+1(1),PNACTDAY                                               
         NI    WORK+1,X'F0'                                                     
         CLC   WORK(1),WORK+1                                                   
         BNE   GETNTI19                                                         
*                                                                               
* FOR SPOT-NHT, PARTIALLY HANDLES WKLY/MONTHLY N-PTR BOOK OVERLAP               
         TM    SPNETFLG,SPNHTQ     SPOT-NHT CALL?                               
         BNO   GETNTIM                                                          
         TM    PNDW,X'0F'          MAKE SURE WE HAVE AN ACTIVE WEEK             
         BNZ   GETNTIM                                                          
         CLI   WEEKS+12,0          IS THIS A 5 WK-MONTH?                        
         BNE   GETNTIM             MAYBE 5TH WK RECD, KEEP IT                   
         CLI   PNBSIND,0           BREAKOUT AND SPECIALS ARE OKAY               
         BNE   GETNTIM                                                          
         CLC   PNBOOK,=X'5E0C'     B & S HANDLING STARTS: DEC/94                
         BL    GETNTIM                                                          
         B     GETNTI19            ELSE BYPASS -> INDIV WK RECD                 
*                                                                               
GETNTIM  CLI   PNSTAT+4,X'88'      WEIGHTED HISP                                
         BE    *+8                                                              
         CLI   PNSTAT+4,C'H'       REGULAR HISP                                 
         BE    *+8                                                              
         CLI   PNSTAT+4,C'M'                                                    
         BE    *+8                                                              
         CLI   PNSTAT+4,C'N'                                                    
         BNE   GETNT17A                                                         
         CLC   PNDW,KEYSAVE+(PNDW-PNKEY) MULTI-WEEK                             
         BE    GETNT17A            MUST RESET ON CHANGE OF WEEK                 
         MVC   PNSTIM,DBDQ.DBDQSQH SET FIRST QH                                 
* 930324...930330                                                               
         CLI   PNSTAT+4,X'88'      LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   PNSTAT+4,C'H'       REGULAR HISP                                 
         BNE   GETNTI16                                                         
         ZIC   RE,DBDQ.DBDQSQH     ALWAYS START 4 HOURS EARLY                   
         SH    RE,=H'16'                                                        
         BP    *+6                                                              
         SR    RE,RE                                                            
         STC   RE,PNSTIM                                                        
*                                                                               
         B     GETNTI16            AND READ HIGH                                
*                                                                               
GETNT17A CLI   DBBEST,C'L'         TEST FOR LOOKUP OPTION                       
         BNE   *+14                                                             
         CLC   PNDW,PNACTDAY       TEST IF E.G. M-F PROGRAM SHOULD              
         BNE   GETNTI19            BE TAKEN FOR MON.                            
*                                                                               
         LA    R1,X'D0'            DEFAULT IS PROGRAM OF OVER 15 MIN.           
         CLI   DBSELDUR,X'FE'      TEST SELECT PROGRAMS LE 15 MIN.              
         BNE   *+8                                                              
         LA    R1,X'20'            YES-SET REJECTION BRANCH MASK TO BH          
         CLI   DBSELDUR,X'FF'      TEST SELECT ALL PROGRAMS                     
         BNE   *+8                                                              
         LA    R1,X'00'            YES-NOOP REJECTION BRANCH                    
*                                                                               
         CLC   PNSTAT(5),=C'HUTDN' DON'T CHECK NAD DAYPART DURATIONS            
         BE    MINDUR3                                                          
         CLI   DBSELDUR,0                                                       
         BE    MINDUR2                                                          
         CLI   DBSELDUR,240                                                     
         BH    MINDUR2                                                          
         LA    R1,X'50'                                                         
         CLC   PNACTDUR,DBSELDUR                                                
         EX    R1,NTIBRAN1                                                      
         B     MINDUR3                                                          
MINDUR2  CLI   PNACTDUR,15         TEST FOR 15 MINUTE PROGRAM                   
         EX    R1,NTIBRAN1         BRANCH TO REJECT USING MASK                  
MINDUR3  MVC   DIRSAVE,PNKEY       SAVE 'N' KEY                                 
* 930324                                                                        
         CLI   PNSTAT+4,X'88'      LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   PNSTAT+4,C'H'       REGULAR HISP                                 
         BE    GETNT17AH                                                        
         CLC   PNSTIM,DBDQ.DBDQSQH TEST REC SQH VS REQSTD SQH                   
         BL    GETNTI19            READ NEXT (CASE OF DW OF 31 AFTER 30         
*                                                                               
* 950901 STOP DAY READ 1/2 HOUR AFTER END QH                                    
*        ZIC   RE,PNSTIM       THIS DIDN'T WORK BECAUSE OF WEEK                 
*        ZIC   RF,DBDQEQH       BITS SET IN DAY. I'LL REVISIT WHEN              
*        SR    RE,RF            I HAVE MORE TIME                                
*        CH    RE,=H'2'                                                         
*        BH    GETNTI14                                                         
*                                                                               
GETNT17AH CLC   PNSTIM,DBDQ.DBDQEQH  TEST SQH AGAINST REQSTD EQH                
         BH    GETNTI19            READ NEXT RECORD                             
*                                                                               
***********************************************************************         
* RECORD CHECKS OUT NOW.  HOWEVER, TO PREVENT LOOPS ON OLD            *         
* FILE, AN EXTRA CHECK IS MADE BELOW TO STOP READING THE SAME         *         
* PROGRAM RECORD IN SUCCESSION.                                       *         
***********************************************************************         
*                                                                               
         CLC   DBACTDAY,WORK       TEST IF DAY IS SAME AS LST RECD READ         
         BNE   GETNT17B                                                         
         CLC   DBACTPRG,PNPNUM     TEST IF PROG NUM IS SAME AS LST RECD         
         BNE   GETNT17B                                                         
         CLC   WORK+18(1),PNBSIND  SAME BRK-OUT/SPC IND VALUE?                  
         BE    GETNTI32                                                         
*                                                                               
GETNT17B MVC   DBACTDAY,WORK       RETURN DAY FOR DEFINE                        
         B     GETNTI20            RECORD CHECKS OUT                            
         SPACE                                                                  
GETNTI18 DS    0H                  EOF EXIT                                     
*                                                                               
GETBRKSP XC    DBNDXDA,DBNDXDA    CLEAR SAVED INDEX                             
         XC    DBNDXDA2,DBNDXDA2  CLEAR SAVED INDEX                             
         XC    DBSTATU2,DBSTATU2  CLEAR SAVED STATUS                            
         CLI   DBBTYPE,C'U'        IF TVQ, DON'T CLR ACTBK                      
         BNE   *+20                                                             
         OC    DBSELBK,DBSELBK                                                  
         BZ    *+10                                                             
         XC    DBACTBK,DBACTBK                                                  
         CLI   DBSELSTA+4,C'D'     NTI DAILIES                                  
         BE    *+8                                                              
         CLI   DBSELSTA+4,C'T'       CHECK FOR NETWORK                          
         BE    *+8                  FIX DUP POINTERS                            
         CLI   DBSELSTA+4,C'S'       CHECK FOR SYND OR                          
         BE    *+14                 FIX DUP POINTERS                            
         OC    DBCABNUM,DBCABNUM   NEW CABLE DATA                               
         BZ    *+18                                                             
         ICM   RE,15,DBSPANAD      YES                                          
         LA    RE,200(RE)          ONLY PROCESS PROGRAM 1 TIME                  
         XC    0(10,RE),0(RE)      CLEAR BUFFER                                 
*                                                                               
         CLI   DBSTYPE,X'00'      ALREADY READ REGULAR PRGMS?                   
         BNE   GETBRSP1                                                         
         MVI   DBSTYPE,C'B'        NOW READ FOR BREAKOUTS                       
         TM    BSSW,BREAKOUT       ANY BREAKOUTS PRESENT                        
         BZ    GETBRSP1                                                         
         B     GETNTI10            GO BACK TO READ N-RECS FROM TOP              
GETBRSP1 CLI   DBSTYPE,C'B'        ALREADY READ BRKOUTS?                        
         BNE   GETEOF              ELSE EXIT WITH END OF FILE                   
         MVI   DBSTYPE,C'S'        NOW READ SPECIALS                            
         TM    BSSW,SPECIAL        ANY SPECIALS PRESENT                         
         BZ    GETEOF                                                           
         B     GETNTI10            GO BACK TO READ N-RECS FROM TOP              
*                                                                               
GETEOF   MVI   DBERROR,EOF                                                      
         MVI   DBSTYPE,X'00'       RESET                                        
         B     GETX                                                             
*                                                                               
GETNTI19 DS    0H                  READ SEQUENTIAL                              
         MVI   IOFLAG,DIR+SEQ                                                   
         BAS   RE,RDBUF                                                         
*        GOTO1 AIO,IOFLAG                                                       
         BL    GETX                                                             
         BE    GETNTI17                                                         
         B     GETNTI18                                                         
         SPACE                                                                  
* READ Q-RECD (PRG RECD) POINTED AT BY N-RECD (PASSIVE DAY/TIME PTR)            
*                                                                               
GETNTI20 DS    0H                                                               
         LA    R2,DIRSAVE          MAKE SAVED 'N' KEY ADDRESSABLE               
         LA    R3,DBKEY                                                         
         USING PMKEY,R3                                                         
         XC    DBLSTDIR(L'DBKEY),DBLSTDIR                                       
*                                                                               
******   XC    DBNDXDA2,DBNDXDA2   DEAL W/DATA ON SEPARATE FILES, I.E.          
*                                   DIFFERENT STATUS NUMBERS                    
         BRAS  RE,CHKSTA           ITN OR SIN?                                  
         BNE   *+22                                                             
         XC    DBNDXDA,DBNDXDA     NEED TO BE CLEARED BECAUSE MAY HAVE          
         XC    DBNDXDA2,DBNDXDA2   D/A OF PREVIOUS WEEKDAY                      
         XC    DBSTATU2,DBSTATU2                                                
*                                                                               
         MVI   PMCODE,PMCODEQU                                                  
         MVC   PMMEDIA,INTMED                                                   
         CLI   PMMEDIA,C'H'                                                     
         BNE   *+8                                                              
         MVI   PMMEDIA,C'N'                                                     
         CLI   DBMEDOVR,0          OVERRIDE MEDIA                               
         BE    *+10                                                             
         MVC   PMMEDIA,DBMEDOVR                                                 
         CLI   DBSELMED,C'W'                                                    
         BNE   *+8                                                              
         MVI   PMMEDIA,C'W'                                                     
         MVC   PMSRC,DBACTSRC                                                   
         CLI   SPNETFLG,0          SPOT->NET LK UP                              
         BE    *+8                                                              
         MVI   PMSRC,C'N'          ACTUAL SOURCE IS ALWAYS NIELSEN              
         MVC   PMBOOK,PNBOOK                                                    
         MVC   PMSTAT,PNSTAT                                                    
         MVC   PMBTYP,PNBTYP       SET BOOK TYPE FROM POINTER                   
         CLI   DBBTYPE,C'C'        MONITOR PLUS COST FILE REQUESTED             
         BNE   *+8                  DOES DAY/TIME FILTER ON NTI PASSIVE         
         MVI   PMBTYP,C'C'          FORCE THE BOOKTYPE                          
         MVC   DBMINKEY,PNPNUM     PROGRAM NUMBER                               
         MVC   DBNDXDA,DBNDXDA2    SAVED D/A IF ANY                             
         OC    DBSTATU2,DBSTATU2                                                
         BZ    *+10                                                             
         MVC   DBSTATUS,DBSTATU2   SAVED STATUS BYTE IF ANY                     
         MVC   PMSTYP,PNBSIND      N-RECD BRKOUT/SPCL BIT                       
*                                                                               
         CLI   PMSTAT+4,C'D'       CHECK FOR NETWORK - DAILIES                  
         BE    *+8                  FIX DUP POINTERS                            
         CLI   PMSTAT+4,C'T'       CHECK FOR NETWORK                            
         BE    *+8                  FIX DUP POINTERS                            
         CLI   PMSTAT+4,C'S'       CHECK FOR SYND OR                            
         BE    *+14                 FIX DUP POINTERS                            
         OC    DBCABNUM,DBCABNUM   NEW CABLE DATA                               
         BZ    GETNT20A                                                         
         ICM   RE,15,DBSPANAD      YES                                          
         LA    RE,200(RE)          ONLY PROCESS PROGRAM 1 TIME                  
*                                                                               
OPTPNUM  OC    0(2,RE),0(RE)                                                    
         BZ    OPTPNUM2                                                         
         CLC   DBDQ.DBDQKDAY(1),2(RE)                                           
         BNE   *+10                                                             
         CLC   PNPNUM,0(RE)                                                     
         BNE   *+10                                                             
         CLC   PNBSIND,3(RE)       SEPERATE ENTRIES FOR REG/BRK/SPCLS           
         BE    GETNT20B                                                         
         LA    RE,5(RE)                                                         
         B     OPTPNUM                                                          
OPTPNUM2 MVC   0(2,RE),PNPNUM                                                   
         MVC   2(1,RE),DBDQ.DBDQKDAY                                            
         MVC   3(1,RE),PNBSIND     SAVE BRKOUT/SPECIAL INDICATOR                
         XC    4(5,RE),4(RE)       CLEAR NEXT SET OF BYTES                      
*                                                                               
GETNT20A MVI   IOFLAG,FILE+READ                                                 
         GOTO1 AIO,IOFLAG                                                       
         BL    GETX                                                             
         BE    GETNTI21            FOUND PROGRAM RECORD                         
*                                                                               
GETNT20B MVC   DBKEY,DIRSAVE       RESTORE 'N' KEY AND MAKE IT                  
         LA    R2,DBKEY            ADDRESSABLE.                                 
         SR    R1,R1               ATTEMPT TO RECOVER BY READING 'N'            
         CLC   PNPNUM,=X'FFFF'     PROTECT FROM LIMIT                           
         BNE   GETNT20C                                                         
         ZIC   R1,PNSTIM           JUST BUMP THE DAY                            
         LA    R1,1(R1)                                                         
         STC   R1,PNSTIM                                                        
         XC    PNPNUM,PNPNUM                                                    
GETNT20C ICM   R1,3,PNPNUM         REC AFTER PTR W MISSING PROGRAM.             
         LA    R1,1(R1)            BUMP THE PROGRAM NO BY 1 AND                 
         STCM  R1,3,PNPNUM         CLEAR REST OF KEY                            
         XC    PNACTDAY(PNKSTAT-PNACTDAY),PNACTDAY                              
         MVI   IOFLAG,DIR+HIGH                                                  
         BAS   RE,RDBUF                                                         
*        GOTO1 AIO,IOFLAG                                                       
         BNE   GETX                                                             
         B     GETNTI17            TEST NEXT KEY FOR QUALIFYING RECORD          
         SPACE 1                                                                
*                                                                               
GETNTI21 DS    0H                                                               
         GOTO1 ATSTMRKT                                                         
         BNE   GETX                                                             
         MVC   DBNDXDA2,DBNDXDA    SAVE D/A                                     
         MVC   DBSTATU2,DBSTATUS   SAVE STATUS BYTE                             
         ICM   R7,15,DBAOPT        TEST FOR OPTIMIZATION                        
         BZ    GETNTI22            NO                                           
         SR    RE,RE                                                            
         ICM   RE,3,2(R7)          DISPLACMENT TO NEXT OPT ENTRY                
         BZ    GETNTI22            NONE-SO NO ENTRY TO BE ADDED                 
         LR    RF,R7               SAVE OPT AREA START                          
         LA    RE,0(R7,RE)         RE NOW POINTS TO NEXT ENTRY                  
         LR    R1,RE               PUT A(NEXT OPT ENTRY) IN R1                  
         LA    RE,NOPTLEN(RE)      ADD LEN OF 1 ENTRY                           
         A     R7,DBLOPT           END OF OPT AREA                              
         CR    RE,R7               TEST FOR ENOUGH ROOM LEFT                    
         BH    GETNT21A            NO                                           
         USING NOPTD,R1                                                         
         MVC   NOPTBK,PMBOOK                                                    
         MVC   NOPTSTA,PMSTAT                                                   
         MVC   NOPTDA,DBNDXDA                                                   
         MVC   NOPTST,DBSTATUS                                                  
         SR    RE,RF               LEN USED SO FAR                              
         STCM  RE,3,0(RF)                                                       
         XC    2(2,RF),2(RF)       CLEAR DISP TO NEXT ENTRY                     
         DROP  R1                                                               
         B     GETNTI22                                                         
GETNT21A L     RE,DBAOPT           JUST REST THE BUFFER                         
         L     RF,DBLOPT                                                        
         XCEF                                                                   
         SPACE                                                                  
GETNTI22 XC    DBAQUART,DBAQUART                                                
*        ******TEMP***********                                                  
         CLC   DBKEY(3),=C'QCN'                                                 
         BE    *+10                                                             
         CLC   DBKEY(3),=C'QC1'                                                 
         BE    *+10                                                             
         CLC   DBKEY(3),=C'QC7'                                                 
         BNE   GETNTI22A                                                        
         L     RF,DBAREC                                                        
         AH    RF,DBDTADSP                                                      
         LA    RF,8(RF)                                                         
         CLI   0(RF),4                                                          
         BNE   GETNTI22A                                                        
         MVI   IOFLAG,FILE+SEQ                                                  
         GOTO1 AIO,IOFLAG                                                       
*                                                                               
*ETNTI22A BAS   RE,GETNTID                                                      
GETNTI22A BRAS  RE,GETNTID                                                      
*                      ADDITIONAL AVERAGES START 8733                           
         CLC   DIRSAVE+(PNBOOK-PNKEY)(2),=X'5721'                               
         BL    GETNTI23                                                         
         CLI   DBBTYPE,C' '        N/A FOR DIARY SAMPLE                         
         BL    GETNTI23                                                         
         CLI   DBBTYPE,C'M'        TREAT MOVIEGOER JUST LIKE WKLY NAD           
         BE    GETNTI23                                                         
         L     R1,ADQPNNS          CHECK FOR OVERLAP ON DAY                     
         LA    R1,DQHDRLN(R1)                                                   
         USING DQDTAD,R1                                                        
*                                                                               
         MVC   DMCB(1),DIRSAVE+(PNDW-PNKEY)   DAY FROM N-REC                    
         CLI   PMSTAT+4,C'S'     SYNDICATION                                    
         BNE   *+8                                                              
         CLI   PMBTYP,C'A'       NTI                                            
         BNE   *+8                                                              
         CLI   PMSTYP,C'B'       BREAKOUTS                                      
         BNE   *+8                                                              
         NI    DMCB,X'F0'        DAY 10-70 = MON-SUN                            
*                                                                               
GETNT22A CLI   DQDAY,0             ??? TREAT AS AN OVERLAP                      
         BE    GETNTI23                                                         
*        CLC   DIRSAVE+(PNDW-PNKEY)(1),DQKDAY    KEY DAY = REC DAY              
         CLC   DMCB(1),DQKDAY KEY  DAY = REC DAY                                
         BE    GETNT22B                                                         
         LA    R1,DQDTALN(R1)      NO - TRY NEXT                                
         B     GETNT22A                                                         
         USING NTELEM,RF                                                        
GETNT22B ZIC   RE,DQDAY            DAY IN THIS RECORD                           
         EX    RE,*+8                                                           
         B     *+8                                                              
         TM    NTDAY,0                                                          
         BZ    GETNT22C            NO - READ NEXT PROGRAM AVERAGE               
         DROP  R1,RF                                                            
*                                                                               
*                                                                               
*** IGNORE P+S2 SETTING FROM DCON RECORD                                        
*** IT IS NO LONGER INFORCED FOR NATIONAL (PER JACK LUSHER FEB09)               
***      CLI   DBSATLIT,C'Y'       AUTHORIZED FOR INDIV. DAY                    
***      BNE   GETNTI23            NO - ACCEPT FIRST RECORD                     
*                                                                               
* MUST GET CORRECT ONE IF OPTIONS ARE SET                                       
         CLI   DBDAYOPT,C'A'       ALL DAYS                                     
         BE    *+8                                                              
         CLI   DBDAYOPT,C'I'       INDIV DAYS                                   
         BNE   GETNTI23                                                         
         CLC   DBACTDAY,DUB+2      SELECT THIS DAY                              
         BE    GETNTI23            YES - PROCESS IT                             
GETNT22C MVI   IOFLAG,FILE+SEQ     OTHERWISE READ NEXT ONE                      
         GOTO1 AIO,IOFLAG                                                       
*        BNH   *+6                                                              
*        DC    H'0'                ERROR ****DAY NOT FOUND*****                 
         BNH   *+8                                                              
***      B     GETNTI18            ERROR ****DAY NOT FOUND*****                 
         B     GETNTI32            DAY/PROG NOT FOUND. CONTINUE N-RECS          
         B     GETNTI21                                                         
*                                                                               
GETNTI23 MVC   DBACTSQC,DUB        CURRENT RECORD SQH                           
         MVC   DBACTEQC,DUB+6      CURRENT RECORD EQH                           
* 930324                                                                        
* HISPANIC HAS ONLY ONE POINTER FOR A DAY/PROGRAM                               
         CLI   PNSTAT+4,X'88'      LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   PNSTAT+4,C'H'       REGULAR HISP                                 
         BNE   GETNT23A                                                         
         CLC   DUB+6(1),DBDQ.DBDQSQH                                            
         BL    GETNTI25                                                         
         CLC   DUB(1),DBDQ.DBDQEQH                                              
         BH    GETNTI25                                                         
         B     GETNT23B                                                         
*                                                                               
* POCKETPIECE HAS HALF HOUR POINTERS FOR DAY/PROGRAM                            
GETNT23A CLI   DBPRGDUR,C'Y'       INCLUDE FULL DURATION      950901            
         BE    GETNT23C             FOR ANY OVELAPPING PROGRAMS                 
*                                                                               
         CLC   DUB(1),DBDQ.DBDQSQH TEST IF PROG STARTED BEFORE PERIOD           
         BL    GETNTI25            NOTE-HR PROG HAS 2 'N' RECS                  
*                                                                               
GETNT23B CLC   DUB+6(1),DBDQ.DBDQEQH  CALCULATE QUARTER HOUR OVERLAP            
         BL    *+10                WITH REQUESTED PERIOD                        
         MVC   DUB+6(1),DBDQ.DBDQEQH                                            
*                                                                               
GETNT23C CLI   PNSTAT+4,X'88'      HISPANIC INCLUDES ONLY THE                   
         BE    *+8                 ACTIVE PORTION                               
         CLI   PNSTAT+4,C'H'                                                    
         BNE   GETNT23D                                                         
         CLC   DUB(1),DBDQ.DBDQSQH                                              
         BNL   *+10                                                             
         MVC   DUB(1),DBDQ.DBDQSQH                                              
*                                                                               
GETNT23D ZIC   R1,DUB+6                                                         
         ZIC   R0,DUB                                                           
         SR    R1,R0               EQH LESS SQH                                 
         MVI   DBRECTYP,DBRECNTI                                                
         MVI   DBMODE,DBMNEXT      SEQUENTIAL                                   
         LTR   R1,R1              PROTECT AGAINST ILLOGICAL CONDITIONS          
         BM    GETNTI25                                                         
         LA    R1,1(R1)            PLUS 1 FOR DURATION                          
         STH   R1,DBFACTOR                                                      
         AH    R1,DBDIVSOR                                                      
         STH   R1,DBDIVSOR                                                      
         OC    DBCABNUM,DBCABNUM                                                
         BNZ   GETCAB                                                           
*                                                                               
GTN24H   DS    0H                                                               
         MVI   RSTMB,0                                                          
         MVC   SVDQPTR,DBDQPTR                                                  
         CLI   DBSELSTA+4,X'88'    LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   DBSELSTA+4,C'H'     REGULAR HISP                                 
         BNE   *+16                                                             
         CLI   DBXQHR,C'Y'         AUTHORIZED TO SPDM DATA?                     
         BE    *+8                                                              
         BAS   RE,DELSPDM          NO, DELETE OPTNL DATA FROM RECD              
*                                                                               
         CLI   SPNETFLG,0          SPOT-NETWORK CALL?                           
         BE    USERHOOK                                                         
         MVI   DBDQPTR,1           FOR SPOT INDICATE ONLY ONE ENTRY             
         MVC   SVACTBK,DBACTBK                                                  
         MVC   SVACTSTA,DBACTSTA                                                
         L     RE,DBAREC           PT TO RECD TO PASS TO USER                   
         MVC   DBACTBK,PMBOOK-PMKEY(RE)                                         
         MVC   DBACTSTA,PMSTAT-PMKEY(RE)                                        
         TM    SPNETFLG,SPNHTQ+SPNADQ    SPOT-> NHT OR NAD CALL?                
         BZ    *+12                                                             
*        BAS   RE,GETMB            GET MKT BRK FOR CALL                         
         BRAS  RE,GETMB            GET MKT BRK FOR CALL                         
         BZ    NOUSR            <-- BYPASS USER HOOK                            
*                                                                               
USERHOOK DS    0H                                                               
         MVC   WORKSV+10(2),DBINTFIL                                            
         BAS   RE,GETX             USER HOOK                                    
         MVC   DBINTFIL(2),WORKSV+10                                            
*                                                                               
NOUSR    MVC   DBDQPTR,SVDQPTR     RESTORE                                      
         CLI   SPNETFLG,0          SPOT-> NHT OR NAD CALL?                      
         BE    *+16                                                             
         MVC   DBACTBK,SVACTBK     RESTORE ORIGINAL VALUE                       
         MVC   DBACTSTA,SVACTSTA     RESTORE ORIGINAL VALUE                     
         CLI   RSTMB,C'Y'          RESET RCD PTR AFTER MKTBRK LK UP             
*        BNE   *+8                                                              
*        BAS   RE,RSETMB                                                        
         BNE   GETNTI25                                                         
         GOTO1 =A(RSETMB),RR=Y                                                  
*                                                                               
GETNTI25 DS    0H                                                               
         B     GETNTI32      <---- ALLOW DAY/TIME OVERLAPS                      
         CLI   PNSTAT+4,C'C'       CHECK FOR NHI FILE                           
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,C'H'       CHECK FOR NHI FILE                           
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,X'88'      CHECK FOR NHI WEIGHTED FILE                  
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,C'S'       CHECK FOR SYNDICATOR FILE                    
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,C'M'       CHECK FOR NAD SYNDICATOR FILE                
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,C'N'       CHECK FOR NAD FILE                           
         BE    GETNTI32                                                         
         MVI   IOFLAG,FILE+SEQ                                                  
         GOTO1 AIO,IOFLAG                                                       
         MVC   DBKEY,DIRSAVE       RESTORE 'N' KEY                              
         LA    R2,DBKEY            BUMP EQH OF LAST RECORD UNLESS IT            
         ZIC   R1,DBACTEQC         IS LESS THAN THE SQH OF LAST 'N'             
         CLM   R1,1,PNSTIM         KEY.  IF TRUE, BUMP THE 'N' SQH SO           
         BNH   GETNTI29            ALWAYS READING FORWARD (PROGRAMS             
*                                  WITH VARYING START TIMES).                   
         CLI   DBSELDAY,X'90'      ARE WE DEALING WITH VAR                      
         BE    GETNTI29                                                         
         B     GETNTI30                                                         
         SPACE 1                                                                
GETNTI27 DS    0H                  LOOP DEFENCE CODE                            
         B     GETNTI32   <------  ALLOW DAY/TIME OVERLAPS                      
         CLI   PNSTAT+4,C'C'       CHECK FOR NHI FILE                           
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,C'H'       CHECK FOR NHI FILE                           
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,X'88'      CHECK FOR NHI WEIGHTED FILE                  
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,C'S'       CHECK FOR SYNDICATOR FILE                    
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,C'M'       CHECK FOR NAD SYNDICATOR FILE                
         BE    GETNTI32                                                         
         CLI   PNSTAT+4,C'N'       CHECK FOR NAD FILE                           
         BE    GETNTI32                                                         
         MVC   DBKEY,DIRSAVE       RESTORE 'N' KEY                              
         LA    R2,DBKEY                                                         
         SPACE 1                                                                
GETNTI29 ZIC   R1,PNSTIM           BUMP CURRENT START TIME                      
         SPACE 1                                                                
GETNTI30 DS    0H                                                               
         LA    R1,1(R1)                                                         
         STC   R1,PNSTIM                                                        
         B     GETNTI16            GO DO READ HIGH                              
         SPACE 1                                                                
GETNTI32 MVC   DBKEY,DIRSAVE       RESTORE THE KEY                              
         LA    R2,DBKEY                                                         
         SR    R1,R1                                                            
         CLI   PNSTAT+4,C'S'                                                    
         BE    *+8                                                              
         CLI   PNSTAT+4,C'T'                                                    
         BE    *+8                                                              
         CLI   PNSTAT+4,X'88'      LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   PNSTAT+4,C'H'       REGULAR HISP                                 
         BE    *+8                                                              
         CLI   PNSTAT+4,C'M'                                                    
         BE    *+8                                                              
         CLI   PNSTAT+4,C'N'                                                    
         BNE   GETNTI33                                                         
         IC    R1,PNBSIND                                                       
         LA    R1,1(R1)                                                         
         STC   R1,PNBSIND                                                       
         B     GETNT16A                                                         
*                                                                               
GETNTI33 ICM   R1,3,PNPNUM                                                      
         LA    R1,1(R1)                                                         
         STCM  R1,3,PNPNUM                                                      
         MVI   PNACTDAY,0                                                       
         B     GETNT16A                                                         
         DROP  R3,DBDQ                                                          
         SPACE 2                                                                
NTIBRAN1 BC    0,GETNTI19          EXECUTED                                     
         EJECT                                                                  
GETCAB   ICM   RF,15,DBSPANAD      SET UP FOR SPANNED RECORDS                   
         XC    0(94,RF),0(RF)                                                   
         MVC   0(3,RF),=C'CAB'                                                  
*                                                                               
         L     RF,DBAREC           SET UP FOR PROGRAM                           
         AH    RF,DBDTADSP                                                      
         CLI   0(RF),1             BYPASS MARKET ELEMENT                        
         BNE   GETNTI25                                                         
         ZIC   R0,1(RF)                                                         
         AR    RF,R0                                                            
         CLI   0(RF),X'0F'                                                      
         BNE   GETNTI25                                                         
         ST    RF,DBAQUART                                                      
GETCNUM  ZIC   R0,1(RF)            DON'T REPROCESS A PROGRAM                    
         AR    RF,R0                                                            
         CLI   0(RF),X'00'                                                      
         BE    GETNTI25                                                         
         CLI   0(RF),X'10'         FIND THE NTI PROG NUMBER                     
         BNE   GETCNUM                                                          
         USING PHTELEM,RF                                                       
         ICM   RE,15,DBSPANAD      FIND THE SPANNING TABLE                      
         LA    RE,200(RE)                                                       
GETCNUM2 OC    0(5,RE),0(RE)       OPEN SLOT - DATA NOT PROCESSED               
         BZ    GETCNUMX                                                         
         CLC   PHTNTI,0(RE)        MATCHED SLOT - BYPASS PROG                   
         BE    GETNTI25                                                         
         LA    RE,5(RE)                                                         
         B     GETCNUM2                                                         
GETCNUMX MVC   0(5,RE),PHTNTI                                                   
         DROP  RF                                                               
*                                                                               
         MVI   PVNORMAL,1          SET TO DO PROGRAM/TRACKAGE                   
         L     RF,DBAQUART                                                      
*        BAS   RE,CABSPAN                                                       
         BRAS  RE,CABSPAN                                                       
*                                                                               
GETCAB1  IC    R0,1(RF)                                                         
         AR    RF,R0                                                            
         CLI   0(RF),X'0F'         FOUND TRACK/TEL BEFORE PROG DEMOS            
         BNE   *+12                                                             
         MVI   PVNORMAL,2          SET TO DO TELECAST                           
         B     *+12                                                             
         CLI   0(RF),X'5E'         FOUND PROG DEMOS IGNORE TELECASTS            
         BNE   GETCAB1                                                          
         L     RF,DBAQUART                                                      
*                                                                               
GETCAB6  ST    RF,DBAQUART                                                      
*ETCAB7  BAS   RE,CABSPAN          SAVE SPANNING INFO                           
GETCAB7  BRAS  RE,CABSPAN          SAVE SPANNING INFO                           
         L     RF,DBAQUART                                                      
         SR    R0,R0                                                            
*                                                                               
GETCAB7A IC    R0,1(RF)                                                         
         AR    RF,R0                                                            
         CLI   0(RF),X'0F'         IGNORE IF NO DEMS ON THIS LEVEL              
         BE    GETCAB7P                                                         
         CLI   0(RF),X'5E'         FOUND DEMOS ON THIS LEVEL                    
         BNE   GETCAB7A                                                         
         LR    RE,RF               SAVE LAST DEMO ELEMENT                       
         L     RF,DBAQUART         NOW CHECK FOR DUP DEMS                       
         CLI   0(RF),X'0F'         JUST TO BE SAFE                              
         BNE   GETCAB7E                                                         
         CLI   2(RF),0             ONLY ON PROGRAM LEVEL                        
         BNE   GETCAB7E                                                         
GETCAB7B ICM   R0,1,1(RE)          EOR - GET NEXT                               
         BZ    GETCAB7P                                                         
         AR    RE,R0                                                            
         CLI   0(RE),X'0F'                                                      
         BNE   GETCAB7B                                                         
         CLI   2(RE),1             NO TRACK - IT'S OK                           
         BNE   GETCAB7E                                                         
*                                                                               
         CLI   DBSELPTT,C'T'       ONLY WANT TRACKS                             
         BE    GETCAB7P             ZIP PAST PROGRAM                            
*                                                                               
GETCAB7C ICM   R0,1,1(RF)          JUST IN CASE                                 
         BZ    GETCAB7E                                                         
         AR    RF,R0                                                            
         CLI   0(RF),X'57'         UNIVERSE ON FIRST ONLY                       
         BE    GETCAB7P                                                         
         CLI   0(RF),X'5E'         DEMOS MATCH - BYPASS PROGRAM                 
         BE    GETCAB7P                                                         
         CLI   0(RF),X'30'         1ST TIME - POS TO 1ST DEMO ELEM              
         BL    GETCAB7C                                                         
GETCAB7D ICM   R0,1,1(RE)                                                       
         BZ    GETCAB7E            NO MATCH                                     
         AR    RE,R0                                                            
         CLI   0(RE),X'30'         1ST TIME - POS. TO 1ST DEMO ELEM             
         BL    GETCAB7D                                                         
         ZIC   R1,1(RF)            GET ELEMENT LENGTH                           
         BCTR  R1,0                                                             
         EX    R1,*+8              COMPARE ELEMENT DATA                         
         B     *+10                                                             
         CLC   0(0,RF),0(RE)       **EXECUTED**                                 
         BNE   *+8                                                              
         B     GETCAB7C                                                         
*                                                                               
GETCAB7E MVC   DMCB,DBAQUART                                                    
*        BAS   RE,GETNTID                                                       
         BRAS  RE,GETNTID                                                       
         L     RF,DMCB                                                          
         ST    RF,DBAQUART                                                      
         CLC   DUB+6(1),DBDQSQH                                                 
         BL    GETCAB8                                                          
         CLC   DUB(1),DBDQEQH                                                   
         BH    GETCAB8                                                          
         MVC   WORKSV+10(2),DBINTFIL                                            
         BAS   RE,GETX             USER HOOK                                    
         MVC   DBINTFIL(2),WORKSV+10                                            
         L     RF,DBAQUART                                                      
         CLI   DBSELPTT,C'P'       ONLY WANT PROGRAM                            
         BNE   *+12                                                             
         CLI   2(RF),0             AND HAD PROGRAM                              
         BE    GETNTI25            NEXT PROGRAM                                 
         B     GETCAB8                                                          
*                                                                               
GETCAB7P L     RF,DBAQUART                                                      
*        BAS   RE,CABSPAN                                                       
         BRAS  RE,CABSPAN                                                       
GETCAB8  ZIC   R0,1(RF)                                                         
         AR    RF,R0                                                            
GETCAB8A CLI   0(RF),0                                                          
         BE    GETCAB9                                                          
GETCAB8B CLI   0(RF),X'0F'         SEGMENT HEADER                               
         BNE   GETCAB8                                                          
         CLI   2(RF),X'FF'         LAST SEGMENT - GET NEXT PROG                 
         BE    GETNTI25                                                         
         ST    RF,DBAQUART                                                      
*        BAS   RE,CABSPAN                                                       
         BRAS  RE,CABSPAN                                                       
         L     RF,DBAQUART                                                      
         LR    RE,RF                                                            
GETCAB8C IC    R0,1(RE)                                                         
         AR    RE,R0                                                            
         CLI   0(RE),X'10'         TEST FOR BREAKOUT                            
         BH    GETCAB8D                                                         
         BNE   GETCAB8C                                                         
         USING PHTELEM,RE                                                       
         TM    PHTRSF,X'01'                                                     
         BNZ   GETCAB6             USE BREAKOUT TELECAST                        
         TM    PHTDTYP,X'04'                                                    
         BNZ   GETCAB6             USE SPECIAL TELECAST                         
         DROP  RE                                                               
GETCAB8D CLC   2(1,RF),PVNORMAL    DO I WANT THIS SEGMENT LEVEL                 
         BH    GETCAB8              NO - TRY NEXT                               
         B     GETCAB6                                                          
         SPACE 2                                                                
GETCAB9  MVI   IOFLAG,FILE+SEQ                                                  
         GOTO1 AIO,IOFLAG                                                       
         L     RF,DBAREC           SET UP FOR NEXT RECORD                       
         AH    RF,DBDTADSP                                                      
         B     GETCAB8A                                                         
         SPACE                                                                  
*                                                                               
* FILTER SYNDICATION BREAKOUTS ON DAY                                           
*                                                                               
SYNBFILT NTR1                                                                   
         CLI   DBSELSTA+4,C'S'     SYNDICATION                                  
         BNE   SYNCONT                                                          
         CLI   DBBTYPE,C'A'        NTI                                          
         BNE   SYNCONT                                                          
         CLI   DBSTYPE,C'B'         BREAKOUTS                                   
         BNE   SYNCONT                                                          
*                                                                               
         BRAS  RE,DAYFILT                                                       
         BE    SYNCONT                                                          
         B     SYNNEXT                                                          
*                                                                               
SYNCONT  CR    RB,RB               MATCH ON DAY/TIME OR NOT SYND BKOUT          
         B     XIT                                                              
SYNNEXT  CHI   RB,0                NO MATCH ON DAY/TIME. TRY NEXT RECD          
         B     XIT                                                              
*                                                                               
XIT      XIT1                                                                   
         EJECT                                                                  
*&&DO                                                                           
* GET VALUES FROM AN NETWORK PROGRAM RECORD (-Q-).                              
*                                                                               
* ON EXIT DUB+0(1)=START QTR HOUR OF THIS RECORD                                
*         DUB+2(1)=DAY CODE FOR RECORD                                          
*         DUB+3(1)=DURATION IN QTR HOURS                                        
*         DUB+6(1)=END QTR HOUR OF RECORD                                       
*         DUB+7(1)=DATA TYPE (BIT0 1=OPTIONAL)                                  
*                                                                               
GETNTID  L     RF,DBAREC                                                        
         MVI   DTYPE,0                                                          
         MVC   DBACTPRG,PMPNUM-PMKEY(RF)                                        
         MVC   WORK+18(1),PMSTYP-PMKEY(RF)                                      
*                                                                               
         ICM   RF,15,DBAQUART                                                   
         BNZ   *+16                                                             
         L     RF,DBAREC                                                        
         AH    RF,DBDTADSP                                                      
         ST    RF,DBAQUART         <-----INITIALIZE                             
         MVI   DUB+3,1             <-----INITIALIZE                             
         SR    R0,R0                                                            
         USING PHTELEM,RF                                                       
GETNTID2 CLI   0(RF),0             FIND 3 ELEMENTS                              
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   PHTCODE,PHTCODEQ    FIND PROGRAM TYPE ELEMENT (X'10')            
         BNE   GETNTID3                                                         
         MVC   DUB+7(1),PHTDTYP    DATA TYPE (BIT 0 - 1=OPTIONAL)               
         TM    PHTDTYP,X'04'       SPECIAL?                                     
         BNO   *+8                                                              
         OI    DTYPE,X'04'                                                      
         TM    PHTRSF,X'01'        BREAKOUT?                                    
         BNO   *+8                                                              
         OI    DTYPE,X'01'                                                      
         B     GETNTID5                                                         
         USING PHELEM,RF                                                        
GETNTID3 CLI   PHCODE,PHCODEQ      FIND QTR HOUR ELEMENT (X'20')                
         BNE   GETNTID4                                                         
         ST    RF,DBAQUART                                                      
         MVC   DUB+3(1),PHDUR      QUARTER HOUR DURATION                        
         B     GETNTID5                                                         
         USING NTELEM,RF                                                        
GETNTID4 CLI   NTCODE,NTCODEQU     FIND RUN TIME ELEMENT (X'22')                
         BE    GETNTID6                                                         
GETNTID5 IC    R0,1(RF)                                                         
         AR    RF,R0                                                            
         B     GETNTID2                                                         
*                                                                               
GETNTID6 DS    0H                                                               
         MVC   MILSTIM,NTSTIM      NEEDED FOR DAY/TIME FILTERING                
         MVC   MILETIM,NTETIM      FOR SYNDICATION BREAKOUTS                    
         MVC   ACTDAY,NTDAY                                                     
*                                                                               
         MVC   DUB(1),NTSQH                                                     
         MVC   DUB+6(1),NTEQH                                                   
         SR    R1,R1                                                            
         CLI   PNSTAT+4,X'88'      LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   PNSTAT+4,C'H'       REGULAR HISP                                 
         BNE   GETNTD6A                                                         
         IC    R1,DUB+6                                                         
         BCTR  R1,0                                                             
         STC   R1,DUB+6                                                         
GETNTD6A MVI   DUB+2,X'90'         SET DAY CODE TO VAR                          
         TM    NTDAY,X'80'         TEST FOR INVALID DATE IN ELEM                
         BO    GETNTID8                                                         
         L     R1,ADQPNNS          FIND DAY CODE FOR BIT SETTING                
         LA    R1,DQHDRLN(R1)                                                   
         USING DQDTAD,R1                                                        
*                                                                               
GETNTID7 CLI   DQDAY,0             TEST FOR END OF TABLE                        
         BE    GETNTID8                                                         
         CLC   NTDAY,DQDAY         TEST FOR MATCH AGAINST TABLE                 
         BE    *+12                                                             
         LA    R1,DQDTALN(R1)                                                   
         B     GETNTID7                                                         
         MVC   DUB+2(1),DQKDAY     EXTRACT DAY CODE FOR BIT SETTING             
*                                                                               
GETNTID8 BR    RE                                                               
         DROP  R1,R2,RF                                                         
         EJECT                                                                  
*&&                                                                             
         DROP  R2                                                               
GETX     CLI   DBERROR,0           TEST IF ERROR SET                            
         JE    *+14                                                             
         XC    DBAQUART,DBAQUART   YES - CLEAR QTR HOUR ADDRESS                 
         MVI   DBMODE,DBMFRST      AND RESET SEQUENTIAL MODE                    
         MVC   DBLSTFNC,DBFUNCT    EQUATE LAST FUNCTION TO THIS                 
         OC    AUSERRTN,AUSERRTN   TEST IF USER HOOK SUPPLIED                   
         JZ    GETXX               NO - RETURN TO CALLER                        
         CLI   DBERROR,0           TEST IF ERROR SET                            
         JNE   GETXX               YES - RETURN TO CALLER                       
         CLI   DBMODE,DBMNEXT      TEST IF SEQUENTIAL MODE                      
         JE    *+8                                                              
         LA    RE,GETXX            NO - SET RETURN TO EXIT                      
*                                                                               
         NTR1                                                                   
         L     RF,AUSERRTN                                                      
         L     RE,ROOTRD                                                        
         LR    R0,RE               R0=A(CALLER'S RD)                            
         LM    R1,RC,24(RE)        R1-RC=CALLERS REGISTERS                      
         BASR  RE,RF               GO TO USER HOOK                              
         XIT1  ,                   EXIT TO CALLER OR DEMAND                     
*                                                                               
GETXX    DS    0H                                                               
         ICM   RE,15,ADTLIST       ANY DAY/TIME LIST                            
         JZ    GETXXX                                                           
         USING DBXTLD,RE                                                        
         ZIC   R1,DBXTLIDX         BUMP THE INDEX                               
         LA    R1,1(R1)                                                         
         STC   R1,DBXTLIDX                                                      
         MH    R1,=H'5'                                                         
         AR    R1,RE                                                            
         CLI   DBXTLIST-DBXTLID(R1),0    EOL                                    
         JE    GETXXX                                                           
         MVI   DBERROR,0           RESET ERROR                                  
         MVI   DBLSTNXT,0          RESET FIRST TIME                             
         ICM   RE,15,DBSPANAD      REPROCESS PROGRAM FOR NEW DAY/TIM            
         JZ    GETNTI4                                                          
         LA    RE,200(RE)          ONLY PROCESS PROGRAM 1 TIME                  
         XC    0(15,RE),0(RE)                                                   
*                                                                               
         J     GETNTI4                                                          
         DROP  RE                                                               
         SPACE 2                                                                
GETXXX   XIT1  ,                   EXIT TO CALLER                               
         LTORG                                                                  
                                                                                
SYNFIXT  DS    0XL7                                                             
         DC    AL2(06584),C'SPT S'                                              
         DC    AL2(06594),C'NBU S'                                              
         DC    AL2(06602),C'2/T S'                                              
         DC    X'FFFF'                                                          
*&&DO                                                                           
SYNFIXT  DS    0XL7                                                             
         DC    AL2(02921),C'FXS S'                                              
         DC    AL2(02921),C'M/N S'                                              
         DC    AL2(02922),C'FXS S'                                              
         DC    AL2(02922),C'BDM S'                                              
         DC    AL2(02933),C'FXS S'                                              
         DC    AL2(02933),C'BVT S'                                              
         DC    AL2(02961),C'FXS S'                                              
         DC    AL2(02961),C'M/N S'                                              
         DC    AL2(02962),C'FXS S'                                              
         DC    AL2(02962),C'K/T S'                                              
         DC    AL2(02965),C'FXS S'                                              
         DC    AL2(02965),C'BV  S'                                              
         DC    AL2(02966),C'FXS S'                                              
         DC    AL2(02966),C'TEC S'                                              
         DC    AL2(02967),C'FXS S'                                              
         DC    AL2(02967),C'TEC S'                                              
         DC    AL2(02968),C'FXS S'                                              
         DC    AL2(02968),C'TEC S'                                              
         DC    X'FFFF'                                                          
*&&                                                                             
         EJECT                                                                  
***********************************************************************         
*DELSPDM- REMOVE OPTIONAL SPANISH DOMINANAT DATA FROM RECORD                    
*         NAMELY: 51/52 PRG PUT ELEMS FROM 23/03/05 MKT BRK                     
***********************************************************************         
DELSPDM  NTR1                                                                   
         SR    R0,R0                                                            
         L     R2,DBAREC                                                        
         USING PRKEY,R2                                                         
         CLI   0(R2),C'P'          P-RECD?                                      
         BNE   DELSPD5                                                          
         CLI   PRSTAT+4,X'88'      LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   PRSTAT+4,C'H'       REGULAR HISP                                 
         BNE   DELSPDX                                                          
         CLC   PRSTAT(3),=C'TEL'                                                
         BE    *+10                                                             
         CLC   PRSTAT(3),=C'TF '                                                
         BE    *+14                                                             
         CLC   PRSTAT(3),=C'UNI'                                                
         BNE   DELSPDX                                                          
         LA    R2,PRFRSTEL                                                      
         B     DELSPD10                                                         
         DROP  R2                                                               
*                                                                               
DELSPD5  CLI   0(R2),C'Q'          Q-RECD?                                      
         BNE   DELSPDX                                                          
         USING PMKEY,R2                                                         
         CLI   PMSTAT+4,X'88'      LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   PMSTAT+4,C'H'       REGULAR HISP                                 
         BNE   DELSPDX             NOT HISP RECD                                
         LA    R2,PMDATA                                                        
         DROP  R2                                                               
*                                                                               
DELSPD10 CLI   0(R2),0             EOF                                          
         BE    DELSPD50                                                         
         CLI   0(R2),X'23'                                                      
         BNE   *+8                                                              
         MVI   DUB,0                                                            
         CLC   0(3,R2),=X'230305'                                               
         BNE   *+8                                                              
         MVI   DUB,1               WITHIN SPDM MKT BRK                          
         CLI   DBKEY,C'Q'          IF Q-RECD, ONLY DELETE PUTS                  
         BE    DELSPD25                                                         
         CLI   DBKEY,C'P'          IF P-RECD, DELETE ENTIRE BRK                 
         BE    DELSPD30              NOT A P-RECD -- DON'T MESS W/IT            
         B     DELSPD40                                                         
*                                                                               
*                                                                               
DELSPD25 CLI   0(R2),X'51'         ONLY DELETE PUTS                             
         BE    DELSPD30                                                         
         CLI   0(R2),X'52'                                                      
         BE    DELSPD30                                                         
         B     DELSPD40                                                         
*                                                                               
DELSPD30 CLI   DUB,1                                                            
         BNE   *+8                                                              
         MVI   0(R2),X'FF'         MARK ELEM FOR DELETE                         
*                                                                               
DELSPD40 IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     DELSPD10                                                         
*                                                                               
DELSPD50 DS    0H                  REMOVE X'FF' ELEMS FROM RECD                 
         GOTO1 CHELLO,DMCB,(C'D',=C'PAVFIL  '),(X'FF',DBAREC),0,0               
*                                                                               
DELSPDX  B     XIT                                                              
*                                                                               
***********************************************************************         
*TSTDYL- TEST ACCESS TO DAILY DATA (DCON SECURITY)                              
*        IF GRANTED, CONDITION CODE NONZERO                                     
***********************************************************************         
         SPACE 1                                                                
TSTDYL   NTR1  ,                                                                
         OC    ALET,ALET           SSBTBLET RESOLVED?                           
         BNZ   TSTDYL02            YES                                          
         XC    DUB,DUB             SPECIAL CALL FOR SYSFACS                     
         MVC   DUB(4),=XL4'FEFFFFFF'                                            
         OC    CSWITCH,CSWITCH                                                  
         BNZ   TSTDYL01                                                         
         ICM   RF,15,CMASTC                                                     
         ICM   RF,15,MCSSB-MASTD(RF)       RF=ASSB                              
         MVC   ALET,SSBTBLET-SSBD(RF)                                           
         B     TSTDYL02                                                         
*                                                                               
TSTDYL01 GOTO1 CSWITCH,DUB                                                      
         L     RF,0(R1)            RF=V(SYSFACS)                                
         L     RF,VSSB-SYSFACD(RF) RF=V(SSB)                                    
         MVC   ALET,SSBTBLET-SSBD(RF)                                           
*                                                                               
TSTDYL02 L     R2,ACONHDR          R2=A(CONTROL TABLE)                          
         USING CONHDRD,R2                                                       
         LAM   AR2,AR2,ALET                                                     
         LA    R3,CONHDRD+CONHDRLN                                              
         CPYA  AR3,AR2                                                          
         SAC   512                                                              
         USING CONDTAD,R3                                                       
         MVI   DEMOFLAG,0                                                       
         LA    R4,3                                                             
         XR    R5,R5                                                            
         ICM   R5,7,CONAET                                                      
         CR    R3,R5               NO LISTS?? --JUST DISALLOW                   
         BE    TSTDYLX                                                          
*                                                                               
TSTDYL04 CLI   CONINDIC,0          PROCESS VALID MARKET LIST                    
         BNE   TSTDYLX             NOT VALID                                    
         OI    DEMOFLAG,X'80'                                                   
         CLC   CONMRKT,=H'221'     DAILY MKT VALID?                             
         BE    *+10                                                             
         CLC   CONMRKT,=H'222'     DAILY MKT VALID?                             
         BNE   *+12                                                             
         OI    DEMOFLAG,X'40'                                                   
         B     *+8                                                              
         BXLE  R3,R4,TSTDYL04                                                   
*                                                                               
TSTDYLX  LAM   AR2,AR3,=2F'0'                                                   
         SAC   0                                                                
         CLI   DEMOFLAG,X'C0'      TEST MARKET NUMBERS VALID                    
         XIT1                                                                   
         EJECT                                                                  
**********************************************************************          
*RDBUF - READS WHAT BUFFER???                                                   
**********************************************************************          
         PRINT GEN                                                              
RDBUF    NTR1  WORK=(R3,10)                                                     
         USING RDBUFD,R3                                                        
         PRINT NOGEN                                                            
         CLC   DBKEY(3),=C'NNN'    ONLY BUFFER DAY/TIME ITEMS                   
         BNE   RDBUF1                                                           
         CLC   DBLOPT,=F'18999'    NEED A MIN SIZED AREA                        
         BH    RDBUF2                                                           
RDBUF1   GOTO1 AIO,IOFLAG          JUST READ IF NOT THERE                       
         B     RDBUFX                                                           
         SPACE 1                                                                
RDBUF2   L     RE,DBAOPT                                                        
         A     RE,=F'3000'                                                      
         ST    RE,ARDBF                                                         
         LA    R4,4(RE)                                                         
         MVC   RDBKEY,DBKEY                                                     
         MVC   RDBFLAG,IOFLAG                                                   
         CLC   4(PNDW-PNKEY,RE),DBKEY BUFFER OK?                                
         BE    RDBUF8                                                           
         ST    R4,0(RE)                                                         
         XC    DBKEY,DBKEY                                                      
         MVC   DBKEY(PNDW-PNKEY),RDBKEY                                         
         MVI   IOFLAG,DIR+HIGH                                                  
         GOTO1 AIO,IOFLAG                                                       
         BNE   *+14                                                             
         CLC   DBKEY(PNDW-PNKEY),KEYSAVE                                        
         BE    RDBUF6                                                           
         MVC   DBKEY,RDBKEY                                                     
         MVC   IOFLAG,RDBFLAG                                                   
         B     RDBUF1                                                           
         SPACE 2                                                                
RDBUF4   MVI   IOFLAG,DIR+SEQ                                                   
         GOTO1 AIO,IOFLAG                                                       
RDBUF6   MVC   0(18,R4),DBKEY                                                   
         LA    R4,18(R4)                                                        
         CLC   DBKEY(PNDW-PNKEY),KEYSAVE                                        
         BE    RDBUF4                                                           
         MVC   0(18,R4),=18X'FF'                                                
         L     RE,ARDBF                                                         
         MVC   DBKEY,RDBKEY                                                     
         MVC   IOFLAG,RDBFLAG                                                   
         SPACE 2                                                                
RDBUF8   L     R4,ARDBF                                                         
         CLI   IOFLAG,SEQ+DIR                                                   
         BNE   RDBUF10                                                          
         L     R4,0(R4)            PICK UP LAST READ + 1                        
         MVC   DBKEY,0(R4)                                                      
         L     RE,ARDBF                                                         
RDBUF9   L     RF,DBAREC                                                        
         MVC   0(18,RF),0(R4)                                                   
         MVC   DBKEY(18),0(R4)                                                  
         LA    R4,18(R4)                                                        
         ST    R4,0(RE)                                                         
         MVI   DBERROR,0                                                        
         CLI   DBKEY,X'FF'                                                      
         BNE   *+8                                                              
         MVI   DBERROR,X'80'                                                    
         CLI   DBERROR,0                                                        
         B     RDBUFX                                                           
         SPACE 1                                                                
RDBUF10  L     R4,ARDBF            POINT TO THE BUFFER                          
         LA    R4,4(R4)            GET PAST SEQ LINK                            
         MVC   KEYSAVE,DBKEY                                                    
         CLI   IOFLAG,HIGH+DIR     MAKE SURE IT'S A READ HIGH                   
         BE    *+6                                                              
         DC    H'0'                                                             
RDBUF12  CLC   DBKEY(18),0(R4)                                                  
         BNH   *+12                                                             
         LA    R4,18(R4)                                                        
         B     RDBUF12                                                          
         L     RE,ARDBF                                                         
         B     RDBUF9                                                           
         SPACE 2                                                                
RDBUFX   XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*&&DO                                                                           
SYNFIXT  DS    0XL7                                                             
         DC    AL2(03806),C'UNE S'                                              
         DC    AL2(03806),C'T/U S'                                              
         DC    AL2(03807),C'FXS S'                                              
         DC    AL2(03807),C'NBU S'                                              
         DC    AL2(03808),C'FXS S'                                              
         DC    AL2(03808),C'WB  S'                                              
         DC    AL2(03809),C'FXS S'                                              
         DC    AL2(03809),C'NBU S'                                              
         DC    AL2(03810),C'FXS S'                                              
         DC    AL2(03810),C'PRM S'                                              
         DC    AL2(03811),C'FXS S'                                              
         DC    AL2(03811),C'MGM S'                                              
         DC    AL2(03812),C'FXS S'                                              
         DC    AL2(03812),C'MGM S'                                              
         DC    AL2(03813),C'FXS S'                                              
         DC    AL2(03813),C'2/T S'                                              
         DC    AL2(03814),C'FXS S'                                              
         DC    AL2(03814),C'2/T S'                                              
         DC    AL2(03815),C'FXS S'                                              
         DC    AL2(03815),C'NBU S'                                              
         DC    AL2(03816),C'FXS S'                                              
         DC    AL2(03816),C'2/T S'                                              
         DC    AL2(03817),C'FXS S'                                              
         DC    AL2(03817),C'KIN S'                                              
         DC    AL2(03818),C'FXS S'                                              
         DC    AL2(03818),C'SPT S'                                              
         DC    AL2(03819),C'FXS S'                                              
         DC    AL2(03819),C'MGM S'                                              
         DC    AL2(03820),C'NBU S'                                              
         DC    AL2(03820),C'PRM S'                                              
         DC    AL2(03821),C'FXS S'                                              
         DC    AL2(03821),C'SPT S'                                              
         DC    AL2(03822),C'FXS S'                                              
         DC    AL2(03822),C'BV  S'                                              
         DC    AL2(03823),C'FXS S'                                              
         DC    AL2(03823),C'PRM S'                                              
         DC    AL2(03825),C'NBU S'                                              
         DC    AL2(03825),C'PRM S'                                              
         DC    AL2(03826),C'T/L S'                                              
         DC    AL2(03826),C'MGM S'                                              
         DC    AL2(03828),C'NBU S'                                              
         DC    AL2(03828),C'MGM S'                                              
         DC    AL2(03829),C'FXS S'                                              
         DC    AL2(03829),C'NBU S'                                              
         DC    AL2(03830),C'FXS S'                                              
         DC    AL2(03830),C'NBU S'                                              
         DC    AL2(03831),C'FXS S'                                              
         DC    AL2(03831),C'MGM S'                                              
         DC    AL2(03832),C'FXS S'                                              
         DC    AL2(03832),C'2/T S'                                              
         DC    AL2(03833),C'FXS S'                                              
         DC    AL2(03833),C'NBU S'                                              
         DC    AL2(03834),C'FXS S'                                              
         DC    AL2(03834),C'UNL S'                                              
         DC    AL2(03835),C'FXS S'                                              
         DC    AL2(03835),C'UNL S'                                              
         DC    AL2(03844),C'FXS S'                                              
         DC    AL2(03844),C'CON S'                                              
         DC    AL2(03845),C'FXS S'                                              
         DC    AL2(03845),C'NBU S'                                              
         DC    AL2(03846),C'FXS S'                                              
         DC    AL2(03846),C'NBU S'                                              
         DC    AL2(03847),C'FXS S'                                              
         DC    AL2(03847),C'CON S'                                              
         DC    X'FFFF'                                                          
*&&                                                                             
         DROP  RB,RA                                                            
         EJECT                                                                  
**********************************************************************          
*ITN OR SIN?                                                                    
**********************************************************************          
CHKSTA   NTR1  BASE=*,LABEL=*                                                   
         CLC   =C'SIN S',DBSELSTA     FOR SIN                                   
         BE    EXITY                                                            
         CLC   =C'ITN S',DBSELSTA     FOR ITN                                   
         BE    EXITY                                                            
         J     EXITN                                                            
         LTORG                                                                  
**********************************************************************          
*GETMB  - GET MARKET BREAK SECTION LEAD ELEM AS REQSTD IN DBBTYPE               
**********************************************************************          
GETMB    NTR1 BASE=*,LABEL=*                                                    
         XC    SVNDXDA,SVNDXDA                                                  
         L     R2,DBAREC                                                        
         USING PMKEY,R2                                                         
         MVC   FILKEY,0(R2)        SAVE ORIGINAL KEY                            
         XC    DBAQUART,DBAQUART                                                
         CLI   DTYPE,0             IF SPECIAL/BREAKOUT, NON ZERO                
         JE    GETMB2                                                           
         TM    SPNETFLG,SPNHTQ     LK UP WKLY RECD FOR BRK/SPCL ON NHT          
         JNO   GETMB2                                                           
*                            LOOK UP WEEKLY RECD FOR NHTI BRKS & SPCLS          
NHTWK    OC    WEEKS+4(2),WEEKS+4                                               
         JZ    NHTWKX              IF NOT THERE, DON'T DO A THING               
         MVC   SVNDXDA,DBNDXDA                                                  
         LA    R2,DBKEY                                                         
         LA    R5,WEEKS+4          PT TO START WEEK                             
         MVI   WKBIT,X'08'         WK AIRED BIT FOR X'20' ELEM                  
*                                                                               
NHTWK10  CLI   0(R5),0             DONE WITH WEEKS?                             
         JE    NHTWKX              WKLY RECD NOT FOUND                          
         XC    DBNDXDA,DBNDXDA                                                  
         MVC   DBKEY,FILKEY                                                     
         MVI   PMKEY+1,C'W'        LOOK UP : QWN RECDS                          
         MVC   PMBOOK,0(R5)        MOVE IN WEEK BOOK                            
         XC    PMKSTAT(5),PMKSTAT                                               
         MVI   RSTMB,C'Y'          WILL NEED TO RESET FILE PTR LATER            
         MVI   IOFLAG,DIR+READ     READ/DIRECTORY                               
         GOTO1 AIO,IOFLAG                                                       
         JL    GETX                READ ERROR                                   
         CLC   DBKEY(PMKSTAT-PMKEY),KEYSAVE                                     
         BNE   NHTNXTWK            NOT FOUND FOR THIS WEEK                      
         MVI   IOFLAG,FILE+READ    READ/FILE                                    
         GOTO1 AIO,IOFLAG                                                       
         JE    NHTWKX              DONE, GOT THE RECD WE WANT! YIPPEE!          
         J     NHTNXTWK            PROGRAM NUMBER NOT FND IN THIS WK            
*                                                                               
NHTNXTWK DS    0H                                                               
         LA    R5,2(R5)            BUMP WEEK TABLE POINTER                      
         SR    R0,R0                                                            
         IC    R0,WKBIT            BUMP TO NEXT BIT FOR WK AIRED                
         SRL   R0,1                                                             
         STC   R0,WKBIT                                                         
         J     NHTWK10                                                          
*                                                                               
NHTWKX   DS    0H                                                               
*                                                                               
GETMB2   L     R2,DBAREC                                                        
         MVC   FILMB(1),DBBTYPE    DEFAULT IS TO INVALID                        
         CLI   FILMB,0                                                          
         JNE   *+12                                                             
         MVI   FILMB,1                                                          
         J     GETMB5                                                           
         TM    SPNETFLG,SPNHTQ     NHTI FILE BKTYPE EQUATES                     
         JNO   GETMB5                                                           
         LA    RE,NHTBRKS          TRANSLATE BKTYPE TO INTERNAL CODE            
GETMB3   CLI   0(RE),X'FF'           AND SAVE IN FILMB                          
         JE    GETMB5               -USE DDBTYPE STRAIGHT                       
         CLC   DBBTYPE,0(RE)                                                    
         JE    *+12                                                             
         LA    RE,L'NHTBRKS(RE)                                                 
         J     GETMB3                                                           
         MVC   FILMB(1),1(RE)                                                   
*                                                                               
GETMB5   L     R2,DBAREC                                                        
         LA    R1,PMDATA                                                        
         MVI   INBRK,C'N'                                                       
         SR    RE,RE                                                            
*                                                                               
GETMB10  CLI   0(R1),0             LOOP THRU LKING FOR X'23'                    
         JE    GETMB40             TO COMPARE ON MKT BREAK                      
         CLI   0(R1),X'23'         GET SECTION LEAD ELEM                        
         JNE   GETMB20                                                          
         MVI   0(R1),X'FF'         DELETE X'23' ELEM LATER                      
         CLC   FILMB(1),2(R1)      MATCH MKT BREAK TO SECTN LEAD                
         JNE   GETMB20                                                          
         ST    R1,DBAQUART         SAVE START OF MKT BRK ELEMS, FOR NOW         
         MVI   INBRK,C'Y'                                                       
*                                                                               
GETMB20  DS    0H                                                               
         CLI   INBRK,C'Y'          ARE WE WITHIN MKT BRK SECTION?               
         JNE   GETMB25                                                          
         CLI   0(R1),X'5E'         END OF GOOD SECTION                          
         BNE   GETMB30                                                          
         MVI   INBRK,C'N'                                                       
         J     GETMB30             DON'T MARK FOR DELETION                      
*                                                                               
GETMB25  CLI   0(R1),X'30'                                                      
         JL    *+8                 DON'T DELETE THE NAME/TIME ELEMS             
         MVI   0(R1),X'FF'         MARK OTHER MKT BRK ELEMS FOR DEL             
*                                                                               
GETMB30  IC    RE,1(R1)            BUMP TO NEXT ELEM IN RECD                    
         AR    R1,RE                                                            
         J     GETMB10                                                          
*                                                                               
GETMB40  CLC   DBAQUART,BZEROS     COMPARE TO BINARY ZEROS                      
         JNE   GETMB50                                                          
         LA    R2,DBKEY                                                         
         ZIC   R1,PMBTYP           BUMP BOOKTYPE FIELD IN KEY                   
         LA    R1,1(R1)                                                         
         STC   R1,PMBTYP                                                        
         XC    PMKSTAT(5),PMKSTAT                                               
         MVI   RSTMB,C'Y'          WILL NEED TO RESET FILE PTR LATER            
         MVI   IOFLAG,DIR+READ     READ/DIRECTORY                               
         GOTO1 AIO,IOFLAG                                                       
         JL    GETX                                                             
         JNE   GETMBNX             MKT BRK NOT AVAILABLE/NOT FOUND              
         MVI   IOFLAG,FILE+READ    READ/FILE                                    
         GOTO1 AIO,IOFLAG                                                       
         JE    GETMB5                                                           
         JNE   GETMBNX             MKT BRK NOT AVAILABLE/NOT FOUND              
*                                                                               
GETMB50  DS    0H                  DEL X'FF' ELEMS FROM RECD                    
         GOTO1 CHELLO,DMCB,(C'D',=C'PAVFIL  '),(X'FF',DBAREC),0,0               
         CLI   DMCB+12,0                                                        
         JE    *+6                                                              
         DC    H'0'                                                             
         DROP  R2                                                               
*                                                                               
         ICM   R2,15,DBSPANAD      FIND MKT BRK UNIVS AND PUT ON RECD           
         LA    R2,4(R2)            BUMP PASS LABEL                              
         USING PRKEY,R2                                                         
         LA    R2,PRFRSTEL                                                      
         SR    RF,RF                                                            
         MVI   INBRK,C'N'                                                       
GETMB60  CLI   0(R2),0                                                          
         JE    GETMB80             NO UNIVS FOUND                               
         CLI   0(R2),X'23'                                                      
         JNE   GETMB62                                                          
         MVI   INBRK,C'N'          RE-SET DEFAULT                               
         CLC   FILMB,2(R2)         GET CORRECT MKT BREAK UNIVS                  
         JL    GETMB80             IT' NOT GOING TO BE THERE--EXIT              
         JH    GETMB65             KEEP LKG                                     
         MVI   INBRK,C'Y'          WE ARE W/IN THE CORRECT MKT BRK              
         J     GETMB65             BUMP TO NEXT ELEM                            
*                                                                               
GETMB62  CLI   INBRK,C'Y'          ARE WE W/IN THE BRK?                         
         JNE   GETMB65                                                          
         CLI   0(R2),X'4B'         YES: XFER 4B & 4C ELEMS ONLY                 
         JE    *+12                                                             
         CLI   0(R2),X'4C'                                                      
         JNE   GETMB65                                                          
         GOTO1 CHELLO,DMCB,(C'P',=C'PAVFIL  '),DBAREC,(R2),0                    
         CLI   0(R2),X'4C'                                                      
         JE    GETMB80             DONE XFERING                                 
         SR    RF,RF                                                            
*                                                                               
GETMB65  IC    RF,1(R2)            LK FOR MKT BRK MATCH OR 4B/4C                
         AR    R2,RF                                                            
         J     GETMB60                                                          
         DROP  R2                                                               
*                                                                               
GETMB80  L     R2,DBAREC           SET DBAQUART                                 
         USING PMKEY,R2                                                         
         LA    R1,PMDATA                                                        
         SR    RE,RE                                                            
GETMB85  CLI   0(R1),0                                                          
         JE    GETMBNX                                                          
         CLI   0(R1),X'20'                                                      
         JE    *+14                                                             
         IC    RE,1(R1)                                                         
         AR    R1,RE                                                            
         J     GETMB85                                                          
         ST    R1,DBAQUART                                                      
         CLI   PMKEY+1,C'W'                                                     
         JNE   GETMBX                                                           
         MVI   PMKEY+1,C'N'        RESET SO THEY THINK IT'S MNTHLY RECD         
         MVC   PMBOOK,DBSELBK                                                   
         MVC   PHDWKS-PHELEM(1,R1),WKBIT  SET WEEK ACTIVE BIT                   
         J     GETMBX                                                           
*                                                                               
GETMBNX  DS    0H                  MKT BREAK RECD NOT FOUND                     
         MVI   RSTMB,C'F'          FUDGE A RECD W/NO DEMOS                      
*        BAS   RE,RSETMB                                                        
         GOTO1 =A(RSETMB),RR=Y                                                  
*                                                                               
GETMBX   OC    DBAQUART,DBAQUART   WAS A RECD FOUND?                            
         XIT1                                                                   
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*RSETMB - RESET POINTER TO '00' MKT BREAK WHERE WE WERE BEFORE GETMBK           
**********************************************************************          
RSETMB   NTR1 BASE=*,LABEL=*                                                    
         OC    SVNDXDA,SVNDXDA                                                  
         JZ    *+10                                                             
         MVC   DBNDXDA,SVNDXDA                                                  
         MVC   DBKEY,FILKEY                                                     
         LA    R2,DBKEY                                                         
         USING PMKEY,R2                                                         
         XC    PMKSTAT(5),PMKSTAT                                               
         MVI   IOFLAG,DIR+READ     READ/DIRECTORY                               
         GOTO1 AIO,IOFLAG                                                       
         JL    GETX                                                             
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   DBMINKEY(2),FILKEY+18                                            
         MVI   IOFLAG,FILE+READ    READ/FILE                                    
         GOTO1 AIO,IOFLAG                                                       
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   RSTMB,C'F'          MKTBRK NOT FOUND, RTN RECD W/NO DEMS         
         JNE   RSETMBX             FUDGE RECD W/JUST PRG INFO IN IT             
         L     R2,DBAREC                                                        
         LA    R1,PMDATA                                                        
         SR    RE,RE                                                            
         SR    RF,RF                                                            
*                                                                               
RSET20   CLI   0(R1),0             DELETE DEMO ELEMS SAVE PRG ELEMS             
         JE    RSET35                                                           
         CLI   0(R1),X'20'                                                      
         JNE   *+8                                                              
         ST    R1,DBAQUART                                                      
         CLI   0(R1),X'23'         DELETE LEAD ELEM TOO                         
         JE    RSET25                                                           
         CLI   0(R1),X'5E'         END OF SECTION --> EXIT                      
         JNE   RSET22                                                           
         LTR   RF,RF               DID WE GET ONE 5E ALREADY?                   
         JNZ   RSET25              YES, DELETE THE REST                         
         LA    RF,1                                                             
         J     RSET30              SAVE THIS ONE                                
RSET22   CLI   0(R1),X'30'                                                      
         JL    RSET30              SAVE HEADER ELEMS                            
RSET25   MVI   0(R1),X'FF'         DELETE ELEM                                  
*                                                                               
RSET30   IC    RE,1(R1)            BUMP TO NEXT ELEM IN RECD                    
         AR    R1,RE                                                            
         J     RSET20                                                           
*                                                                               
RSET35   GOTO1 CHELLO,DMCB,(C'D',=C'PAVFIL  '),(X'FF',DBAREC),0,0               
*                                                                               
         ICM   R2,15,DBSPANAD      PUT UNIV ON RECD                             
         LA    R2,4(R2)            BUMP PASS LABEL                              
         USING PRKEY,R2                                                         
         LA    R2,PRFRSTEL                                                      
         SR    RF,RF                                                            
         MVI   INBRK,C'N'                                                       
         CLI   FILMB,0                                                          
         JNE   *+8                                                              
         MVI   FILMB,X'01'         UNIV RECD TOT-SMPL IS X'01'                  
RSET60   CLI   0(R2),0                                                          
         JE    RSETMBX             NO UNIVS FOUND                               
         CLI   0(R2),X'23'                                                      
         JNE   RSET62                                                           
         MVI   INBRK,C'N'          RE-SET DEFAULT                               
         CLC   FILMB,2(R2)         GET CORRECT MKT BREAK UNIVS                  
         JL    RSETMBX             IT' NOT GOING TO BE THERE--EXIT              
         JH    RSET65              KEEP LKG                                     
         MVI   INBRK,C'Y'          WE ARE W/IN THE CORRECT MKT BRK              
         J     RSET65              BUMP TO NEXT ELEM                            
*                                                                               
RSET62   CLI   INBRK,C'Y'          ARE WE W/IN THE BRK?                         
         JNE   RSET65                                                           
         CLI   0(R2),X'4B'         YES: XFER 4B & 4C ELEMS ONLY                 
         JE    *+12                                                             
         CLI   0(R2),X'4C'                                                      
         JNE   RSET65                                                           
         GOTO1 CHELLO,DMCB,(C'P',=C'PAVFIL  '),DBAREC,(R2),0                    
         CLI   0(R2),X'4C'                                                      
         JE    RSETMBX             DONE XFERING                                 
         SR    RF,RF                                                            
*                                                                               
RSET65   IC    RF,1(R2)            LK FOR MKT BRK MATCH OR 4B/4C                
         AR    R2,RF                                                            
         J     RSET60                                                           
*                                                                               
RSETMBX  MVI   RSTMB,0                                                          
         XIT1                                                                   
         DROP  R2                                                               
         LTORG                                                                  
         EJECT                                                                  
CABSPAN  NTR1 BASE=*,LABEL=*       DIG OUT AND FORMAT NAMES                     
         L     RF,DBAQUART                                                      
         ICM   R1,15,DBSPANAD                                                   
         LR    RE,RF                                                            
         CLI   0(RF),X'0F'                                                      
         JNE   CABSX                                                            
         CLI   2(RF),1             SET FOR UNTITLED TRACKS                      
         JNE   CABSPAN2                                                         
         XC    34(30,R1),34(R1)                                                 
         MVC   34(15,R1),=C'UNTITLED TRACKS'                                    
*                                                                               
CABSPAN2 ZIC   R0,1(RE)                                                         
         AR    RE,R0                                                            
         CLI   0(RE),X'10'                                                      
         JE    CABSPAN7                                                         
         CLI   0(RE),X'21'                                                      
         JE    CABSPAN3                                                         
         CLI   0(RE),X'00'                                                      
         JE    CABSX                                                            
         CLI   0(RE),X'0F'                                                      
         JE    CABSX                                                            
         J     CABSPAN2                                                         
*                                                                               
CABSPAN3 MVC   3(1,R1),2(RF)                                                    
         CLI   2(RF),0                                                          
         JNE   CABSPAN4                                                         
         XC    4(90,R1),4(R1)                                                   
         ZIC   R4,1(RE)                                                         
         SH    R4,=H'3'                                                         
         EX    R4,CABM1                                                         
         EX    R4,CABM2                                                         
         EX    R4,CABM3                                                         
         J     CABSX                                                            
CABSPAN4 CLI   2(RF),1                                                          
         JNE   CABSPAN5                                                         
         XC    34(30,R1),34(R1)                                                 
         ZIC   R4,1(RE)                                                         
         SH    R4,=H'3'                                                         
         EX    R4,CABM2                                                         
         J     CABSX                                                            
CABSPAN5 CLI   2(RF),2                                                          
         JNE   CABSX                                                            
         XC    64(30,R1),64(R1)                                                 
         ZIC   R4,1(RE)                                                         
         SH    R4,=H'3'                                                         
         EX    R4,CABM3                                                         
         J     CABSX                                                            
*                                                                               
CABM1    MVC   4(0,R1),2(RE)                                                    
CABM2    MVC   34(0,R1),2(RE)                                                   
CABM3    MVC   64(0,R1),2(RE)                                                   
*                                                                               
         USING PHTCODE,RE          DIG OUT NTI/TRK/EPIS NUMBER                  
CABSPAN7 MVC   WORK(5),PHTNTI                                                   
         MVI   WORK+5,X'0F'                                                     
         UNPK  WORK+6(11),WORK(6)                                               
         ZIC   R0,2(RF)                                                         
         MH    R0,=H'10'                                                        
         AR    R1,R0                                                            
         MVC   94(10,R1),WORK+6                                                 
         ICM   R1,15,DBSPANAD                                                   
         J     CABSPAN2                                                         
         DROP  RE                                                               
*                                                                               
CABSX    XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
* FILTER ON SELECTED DAYS                                                       
DAYFILT  NTR1  BASE=*,LABEL=*                                                   
         CLI   DBSELDAY,0          FILTER ON DAY                                
         JE    EXITY               ACCEPT ALL DAYS                              
         ZIC   R1,ACTDAY                                                        
         ZIC   R0,DBSELDAY                                                      
         NR    R1,R0               CHECK OVERLAP ON DAYS                        
         LTR   R1,R1                                                            
         JZ    EXITN                                                            
         J     EXITY                                                            
         LTORG EJECT                                                            
*                                                                               
* FILTER ON SELECTED TIMES                                                      
TIMEFILT NTR1  BASE=*,LABEL=*                                                   
         OC    DBSELTIM,DBSELTIM                                                
         JZ    EXITY               ACCEPT ALL TIMES                             
*                                                                               
         MVC   REQSTIME,DBSELTIM                                                
         MVC   REQETIME,DBSELTIM+2                                              
         MVC   RECSTIME,MILSTIM                                                 
         MVC   RECETIME,MILETIM                                                 
*                                                                               
         SR    RE,RE               ADJUST TIMES                                 
         ICM   RE,3,REQSTIME                                                    
         CHI   RE,0600                                                          
         BNL   *+12                                                             
         AHI   RE,2400                                                          
         STCM  RE,3,REQSTIME                                                    
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,REQETIME                                                    
         CHI   RE,0600                                                          
         BNL   *+12                                                             
         AHI   RE,2400                                                          
         STCM  RE,3,REQETIME                                                    
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,RECSTIME                                                    
         CHI   RE,0600                                                          
         BNL   *+12                                                             
         AHI   RE,2400                                                          
         STCM  RE,3,RECSTIME                                                    
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,3,RECETIME                                                    
         CHI   RE,0600                                                          
         BNL   *+12                                                             
         AHI   RE,2400                                                          
         STCM  RE,3,RECETIME                                                    
*                                                                               
         CLC   RECSTIME,REQETIME                                                
         JNL   EXITN                                                            
         CLC   RECETIME,REQSTIME                                                
         JNH   EXITN                                                            
         J     EXITY                                                            
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* GET VALUES FROM AN NETWORK PROGRAM RECORD (-Q-).                              
*                                                                               
* ON EXIT DUB+0(1)=START QTR HOUR OF THIS RECORD                                
*         DUB+2(1)=DAY CODE FOR RECORD                                          
*         DUB+3(1)=DURATION IN QTR HOURS                                        
*         DUB+6(1)=END QTR HOUR OF RECORD                                       
*         DUB+7(1)=DATA TYPE (BIT0 1=OPTIONAL)                                  
***********************************************************************         
GETNTID  NTR1 BASE=*,LABEL=*                                                    
         USING PNKEY,R2                                                         
         L     RF,DBAREC                                                        
         MVI   DTYPE,0                                                          
         MVC   DBACTPRG,PMPNUM-PMKEY(RF)                                        
         MVC   WORK+18(1),PMSTYP-PMKEY(RF)                                      
*                                                                               
         ICM   RF,15,DBAQUART                                                   
         BNZ   *+16                                                             
         L     RF,DBAREC                                                        
         AH    RF,DBDTADSP                                                      
         ST    RF,DBAQUART         <-----INITIALIZE                             
         MVI   DUB+3,1             <-----INITIALIZE                             
         SR    R0,R0                                                            
         USING PHTELEM,RF                                                       
GETNTID2 CLI   0(RF),0             FIND 3 ELEMENTS                              
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   PHTCODE,PHTCODEQ    FIND PROGRAM TYPE ELEMENT (X'10')            
         BNE   GETNTID3                                                         
         MVC   DUB+7(1),PHTDTYP    DATA TYPE (BIT 0 - 1=OPTIONAL)               
         TM    PHTDTYP,X'04'       SPECIAL?                                     
         BNO   *+8                                                              
         OI    DTYPE,X'04'                                                      
         TM    PHTRSF,X'01'        BREAKOUT?                                    
         BNO   *+8                                                              
         OI    DTYPE,X'01'                                                      
         B     GETNTID5                                                         
         USING PHELEM,RF                                                        
GETNTID3 CLI   PHCODE,PHCODEQ      FIND QTR HOUR ELEMENT (X'20')                
         BNE   GETNTID4                                                         
         ST    RF,DBAQUART                                                      
         MVC   DUB+3(1),PHDUR      QUARTER HOUR DURATION                        
         B     GETNTID5                                                         
         USING NTELEM,RF                                                        
GETNTID4 CLI   NTCODE,NTCODEQU     FIND RUN TIME ELEMENT (X'22')                
         BE    GETNTID6                                                         
GETNTID5 IC    R0,1(RF)                                                         
         AR    RF,R0                                                            
         B     GETNTID2                                                         
*                                                                               
GETNTID6 DS    0H                                                               
         MVC   MILSTIM,NTSTIM      NEEDED FOR DAY/TIME FILTERING                
         MVC   MILETIM,NTETIM      FOR SYNDICATION BREAKOUTS                    
         MVC   ACTDAY,NTDAY                                                     
*                                                                               
         MVC   DUB(1),NTSQH                                                     
         MVC   DUB+6(1),NTEQH                                                   
         SR    R1,R1                                                            
         CLI   PNSTAT+4,X'88'      LOWER CASE 'H'= WEIGHTED HISP                
         BE    *+8                                                              
         CLI   PNSTAT+4,C'H'       REGULAR HISP                                 
         BNE   GETNTD6A                                                         
         IC    R1,DUB+6                                                         
         BCTR  R1,0                                                             
         STC   R1,DUB+6                                                         
GETNTD6A MVI   DUB+2,X'90'         SET DAY CODE TO VAR                          
         TM    NTDAY,X'80'         TEST FOR INVALID DATE IN ELEM                
         BO    GETNTID8                                                         
         L     R1,ADQPNNS          FIND DAY CODE FOR BIT SETTING                
         LA    R1,DQHDRLN(R1)                                                   
         USING DQDTAD,R1                                                        
*                                                                               
GETNTID7 CLI   DQDAY,0             TEST FOR END OF TABLE                        
         BE    GETNTID8                                                         
         CLC   NTDAY,DQDAY         TEST FOR MATCH AGAINST TABLE                 
         BE    *+12                                                             
         LA    R1,DQDTALN(R1)                                                   
         B     GETNTID7                                                         
         MVC   DUB+2(1),DQKDAY     EXTRACT DAY CODE FOR BIT SETTING             
*                                                                               
GETNTID8 XIT1  REGS=(RF)           RETURN POINTER TO NTELEM                     
         DROP  R1,R2,RF                                                         
         LTORG                                                                  
         EJECT                                                                  
                                                                                
**********************************************************************          
* REDIRECT PROGRAM READS TO CORRECTED PROGRAM NUMBERS                           
* THIS IS AFTER A FILE FIX THAT RENUMBERED SEVERAL PROGRAMS                     
* BECAUSE THERE ARE BUYS THAT USE THE OLD NUMBER, WE WILL REDIRECT THEM         
* TO READ THE NEW PROGRAM NUMBERS WHEN POSSIBLE                                 
**********************************************************************          
                                                                                
REDIRECT NTR1  BASE=*,LABEL=*                                                   
         CLI   DBSELSTA+4,C'S'                                                  
         BE    REDSYN                                                           
         CLI   DBSELSTA+4,C'T'                                                  
         BE    REDNET                                                           
         B     REDRCTX                                                          
*                                                                               
REDSYN   L     R4,=A(NUMTABS)      REDIRECT SYNDICATION PROGRAMS                
         A     R4,RELO1                                                         
         B     REDRCT10                                                         
*                                                                               
REDNET   L     R4,=A(NUMTABN)      REDIRECT NETWORK PROGRAMS                    
         A     R4,RELO1                                                         
         B     REDRCT10                                                         
*                                                                               
         USING NUMTABD,R4                                                       
REDRCT10 CLI   0(R4),X'FF'                                                      
         BE    REDRCTX             DON'T REDIRECT                               
         CLC   DBSELPRG,OLDNTI                                                  
         BE    REDRCT30                                                         
*                                                                               
REDRCT20 LA    R4,DATELIST-NUMTABD(R4)                                          
REDRCT23 CLI   0(R4),0                                                          
         BE    REDRCT25                                                         
         CLI   0(R4),1                                                          
         BNE   *+8                                                              
         LA    R4,1(R4)                                                         
         LA    R4,L'DATELIST(R4)                                                
         B     REDRCT23                                                         
*                                                                               
REDRCT25 LA    R4,1(R4)                                                         
         B     REDRCT10                                                         
*                                                                               
REDRCT30 LA    R3,DATELIST                                                      
REDRCT33 CLI   0(R3),0             NO BOOKS                                     
         BE    REDRCTX                                                          
         CLI   0(R3),1             NO BOOKS TO REDIRECT                         
         BE    REDRCTX                                                          
*                                                                               
         OC    VNETWEEK,VNETWEEK                                                
         BNZ   REDRCT35                                                         
         LHI   R0,QNETWEEK         CORE-RESIDENT PHASE FOR NETWEEK              
         ICM   R0,B'1110',=X'D9000A'                                            
         GOTO1 CCALLOV,DMCB,0,(R0)                                              
         MVC   VNETWEEK,0(R1)      REMEMBER THAT WE FOUND THIS                  
*                                                                               
REDRCT35 GOTO1 VNETWEEK,DMCB,0(R3),CGETDAY,CADDAY                               
         LA    RE,DBACTBK                                                       
         OC    DBACTBK,DBACTBK                                                  
         BNZ   *+8                                                              
         LA    RE,DBSELBK                                                       
*                                                                               
         CLC   0(1,RE),DMCB+4      YEAR                                         
         BNE   REDRCT38                                                         
         CLC   1(1,RE),DMCB+12     WEEK                                         
         BE    REDRCT40            REDIRECT                                     
                                                                                
REDRCT38 LA    R3,6(R3)                                                         
         B     REDRCT33                                                         
*                                                                               
REDRCT40 MVC   DBSELPRG,NEWNTI                                                  
*                                                                               
REDRCTX  J     EXIT                                                             
         DROP  R4                                                               
*                                                                               
EXITY    CR    RB,RB                                                            
         J     EXIT                                                             
*                                                                               
EXITN    CHI   RB,0                                                             
         J     EXIT                                                             
*                                                                               
EXIT     XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* FIX POSTING FOR NTI#24861                                                     
* PROGRAM "AMERICA'S TOUGHEST JOBS" FOR THE WEEK OF SEP15/08 HAS TWO            
* SEPARATE AIRINGS. THIS ROUTINE WILL CAUSE A MATCH ON THE DAY SO               
* THAT THE BUY CAN POST CORRECTLY.                                              
**********************************************************************          
                                                                                
FIXPROG  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLC   DBFILE,=C'NTI'                                                   
         BNE   FIXPRGN                                                          
         CLC   DBSELBK,=AL1(108,38)    WK OF SEP15/08                           
         BNE   FIXPRGN                                                          
         CLC   DBSELSTA,=C'NBC T'                                               
         BNE   FIXPRGN                                                          
         CLC   DBSELPRG,=AL2(24861)                                             
         BNE   FIXPRGN                                                          
         B     FIXPRGY                 FIX THIS PROGRAM                         
*                                                                               
FIXPRGY  CR    RE,RE                                                            
         B     FIXPROGX                                                         
FIXPRGN  CHI   RB,0                                                             
FIXPROGX J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*LOCAL WORK AREA - SMALL PART OF ALLOC AT TOP OF GETNTI                         
**********************************************************************          
*                                                                               
NHTBRKS  DS    0CL2         WHEN SPTNHT ACTIVE, ALLOW CHAR BKTYPES              
         DC    C'1',X'01'          CONVERT CHAR TO NUMERIC                      
         DC    C'5',X'05'                                                       
         DC    C'6',X'06'                                                       
         DC    C'7',X'07'                                                       
         DC    C'H',X'05'                                                       
         DC    C'E',X'06'                                                       
         DC    C'B',X'07'                                                       
         DC    X'FFFFF'                                                         
*                                                                               
BZEROS   DC    XL20'00'                                                         
* DDCOREQUS                                                                     
       ++INCLUDE DDCOREQUS                                                      
* SYNDICATION FIX TABLE AND DSECT                                               
       ++INCLUDE DEDUPLFIXT                                                     
*                                                                               
MYWORK   DSECT                                                                  
RELO1    DS    A                                                                
AUSERF   DS    F                   ADDRESS OF USER FILE IO AREA                 
SPANAD   DS    CL2000              STORE UNIVERSES                              
FILKEY   DS    XL23                ORIGINAL KEY                                 
INBRK    DS    C                   FLAG=N IF NOT IN DESIRED MKT BRK             
RSTMB    DS    C                   RESET POINTER TO MKBRK 1ST RECD              
FILMB    DS    C                   MKT BREAK NUMBER ON FILE                     
WKBIT    DS    X                   WEEK AIRED TO SLOT INTO B/S RECD             
WEEKS    DS    CL14                WEEKS FROM DEFINE                            
DTYPE    DS    X                   X'04'= SPECIAL X'01'=BREAKOUT ELSE 0         
SVDQPTR  DS    X                   FOR SPOT DBDQPTR OVERRIDEN TO 1              
SVACTBK  DS    XL2                 BOOK ORIG IN DBACTBK FIELD                   
SVACTSTA DS    CL5                 PREV STATION IN ACTSTA FLD                   
SVASRC   DS    C                   DBACTSRC                                     
SVINTMED DS    C                   DBINTMED                                     
SVNDXDA  DS    F                                                                
BSSW     DS    C                                                                
BREAKOUT EQU   X'01'                                                            
SPECIAL  EQU   X'02'                                                            
MILSTIM  DS    XL(L'NTSTIM)         MILITARY START TIME (FROM RECD)             
MILETIM  DS    XL(L'NTETIM)         MILITARY END TIME (FROM RECD)               
ACTDAY   DS    XL(L'NTDAY)                                                      
DAYCODE  DS    X                                                                
REQSTIME DS    XL2                 REQUESTED START TIME                         
REQETIME DS    XL2                 REQUESTED END TIME                           
RECSTIME DS    XL2                 RECORD START TIME                            
RECETIME DS    XL2                 RECORD END TIME                              
WKDAYS   DS    X                   DAYS IN WEEKLY AVERAGE                       
CURRDAY  DS    XL2                                                              
DAYEFLAG DS    X                                                                
VNETWEEK DS    A                                                                
*                                                                               
MYWORKL  EQU   *-MYWORK                                                         
         SPACE 2                                                                
*                                                                               
RDBUFD   DSECT                                                                  
ARDBF    DS    F                                                                
RDBKEY   DS    XL23                                                             
RDBFLAG  DS    XL1                                                              
*                                                                               
* LITERALS ETC.                                                                 
*                                                                               
         EJECT                                                                  
       ++INCLUDE DEGETD            REMOVED 'B' TO ASM CLEAN                     
         PRINT OFF                                                              
       ++INCLUDE FASSB                                                          
       ++INCLUDE FASYSFAC                                                       
       ++INCLUDE DEDBEXTRAD                                                     
       ++INCLUDE DDMASTD                                                        
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'067DEGETNTI  04/17/19'                                      
         END                                                                    
