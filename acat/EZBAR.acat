*          DATA SET EZBAR      AT LEVEL 003 AS OF 02/18/92                      
*          DATA SET EZLOAD     AT LEVEL 026 AS OF 02/05/92                      
*CATALP EZBAR                                                                   
*        TITLE 'EASI - BAR TAPE TO EASI FILE FORMAT'                            
***********************************************************************         
*                                                                     *         
*  REGISTER USAGE                                                     *         
*  R0 - OS & WORK                                                     *         
*  R1 - OS & WORK                                                     *         
*  R2 - WORK                                                          *         
*  R3 - WORK                                                          *         
*  R4 - WORK                                                          *         
*  R5 - WORK                                                          *         
*  R6 - WORK                                                          *         
*  R7 - WORK                                                          *         
*  R8 -               NOT USED                                        *         
*  R9 - SECOND BASE                                                   *         
*  RA - DPRINT                                                        *         
*  RB - FIRST BASE REG                                                *         
*  RC - EZLDWKD DSECT FROM NMOD CHAIN                                 *         
*  RD - STD REG SAVE CHAIN                                            *         
*  RE - OS & WORK                                                     *         
*  RF - OS & WORK                                                     *         
*                                                                     *         
***********************************************************************         
*                                                                     *         
* LEV 00    FEB17/92                                                  *         
*                                                                     *         
***********************************************************************         
         TITLE 'EASI - BAR TAPE TO EASI FILE FORMAT'                            
EZBAR    CSECT                                                                  
         ENTRY UTL                                                              
*                                                                               
         PRINT NOGEN                                                            
         NBASE EZLDWKL,**EZBAR*,=A(REGSAVE),R9                                  
         USING EZLDWKD,RC                                                       
         L     RA,=V(CPRINT)                                                    
         USING DPRINT,RA                                                        
         GOTO1 =A(INIT),DMCB,(RC)                                               
         SPACE                                                                  
         L     R2,=A(EZINPUTF)     FIXED BLOCKED DCF                            
         ST    R2,AEZINPT                                                       
         OPEN  ((R2),(INPUT))                                                   
         SPACE                                                                  
         LTR   RF,RF               GOOD OPEN                                    
         BZ    EZL90                YES                                         
         SPACE                                                                  
         MVC   P(19),=C'EZBARIN OPEN FAILED'                                    
         GOTO1 =V(PRINTER)                                                      
         BE    BARREAD                                                          
         SPACE                                                                  
EOJ      GOTO1 =V(PRINT),DMCB,=C'CLOSE'                                         
         CLI   ABNDOPT,C'Y'                                                     
         BNE   *+6                                                              
         DC    H'0'                                                             
         XBASE                                                                  
*                                                                               
XIT      XIT1                                                                   
         EJECT                                                                  
*              READ INPUT DATA SET                                              
         SPACE 2                                                                
BARREAD  DS    0H                                                               
         MVI   FDELIM,X'5E'        FIELD DELIMITER - SEMI COLON                 
         MVI   RDELIM,X'15'        RECORD DELIMITER - NEW LINE                  
         LA    RE,RFVALS                                                        
         LA    RF,RFVALSL                                                       
         XCEF                                                                   
*                                                                               
         L     RE,=A(EZOTREC)                                                   
         ST    RE,WRCURPOS                                                      
         ST    RE,WRECST                                                        
         LA    RF,EZOTRECL                                                      
         XCEF                                                                   
*                                                                               
         ZAP   TOTDOLS,=P'0'                                                    
         ZAP   TDOLS,=P'0'                                                      
         ZAP   LDOLS,=P'0'                                                      
         ZAP   IBYTS,=P'0'                                                      
         ZAP   OBYTS,=P'0'                                                      
*                                                                               
         GOTO1 =V(SORTER),DMCB,SORTCARD,RECCARD                                 
*                                                                               
EZR010   DS    0H                                                               
         SPACE                                                                  
         L     R2,AEZINPT                                                       
         L     R6,=A(EZINREC)                                                   
         XC    0(256,R6),0(R6)                                                  
*                                                                               
         GET   (R2),(R6)                                                        
*                                                                               
         BAS   RE,TRCREAD          TRACE BAR FILE RECORD                        
*                                                                               
*                                                                               
         BAS   RE,ENDREC                                                        
         L     RE,=A(EZOTREC)                                                   
         ST    RE,WRCURPOS                                                      
         ST    RE,WRECST                                                        
         LA    RF,EZOTRECL                                                      
         XCEF                                                                   
         B     EZR010                                                           
*                                                                               
*                                  HANDLE FIELD                                 
*                                  ------------                                 
*        NOTE- THIS CODE INVOLVING RECORD TYPES AND                             
*              FIELD NUMBERS IS NOT EXACTLY SOFT                                
*                                                                               
*                                                                               
EZR014   DS    0H                                                               
         BAS   RE,ENDINV           FINISH OLD INVOICE                           
         CLC   STAFLDS,OLDSTA      TEST CHANGE OF STATION                       
         BNE   EZR024                                                           
         CLC   AGYFLDS,OLDAGY      OR AGENCY                                    
         BE    EZR010                                                           
*                                                                               
EZR024   DS    0H                  NEW BATCH                                    
         SPACE                                                                  
         GOTO1 =A(ENDBTCH),DMCB,(RC)  PROCESS END OF BATCH                      
         SPACE                                                                  
         BAS   RE,NEWIND           SET NEW WORKER INDEX AND PRINT               
         B     EZR010                                                           
*                                                                               
EZR026   DS    0H                                                               
         CLC   RECTYP,SPTRTYP      TEST SPOT DETAIL REC                         
         BNE   EZR010                                                           
         L     RF,ISPTS            BUMP SPOT COUNT                              
         LA    RF,1(,RF)                                                        
         ST    RF,ISPTS                                                         
         B     EZR010                                                           
*                                                                               
EZR030   DS    0H                                                               
         CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR031                                                           
         MVC   STATION,RFDATA      SAVE STATION                                 
         B     EZR010                                                           
*                                                                               
EZR031   DS    0H                                                               
         CLC   RECTYP,TRTOTYP      TEST TRANSMISSION TOTAL REC                  
         BNE   EZR010                                                           
         SPACE                                                                  
         SPACE                                                                  
         ST    R0,TOTINVS                                                       
         B     EZR010                                                           
*                                                                               
EZR032   DS    0H                                                               
         CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR034                                                           
         MVC   MEDIA,RFDATA        SAVE MEDIA                                   
         CLI   MEDIA,C'A'          IF AM, FORCE TO  RADIO                       
         BE    *+12                                                             
         CLI   MEDIA,C'F'          IF FM, FORCE TO  RADIO                       
         BNE   EZR010                                                           
         MVC   MEDIA,=C'R '                                                     
         B     EZR010                                                           
*                                                                               
EZR034   DS    0H                                                               
         CLC   RECTYP,AGYRTYP      TEST AGENCY RECORD                           
         BNE   EZR036                                                           
         MVC   AGYNAME,RFDATA      SAVE AGENCY NAME                             
         B     EZR010                                                           
*                                                                               
EZR036   DS    0H                                                               
         CLC   RECTYP,INTRTYP      TEST INVOICE TOTAL                           
         BNE   EZR038                                                           
         SPACE                                                                  
         SPACE                                                                  
         SPACE                                                                  
         SPACE                                                                  
         B     EZR010                                                           
*                                                                               
EZR038   DS    0H                                                               
         CLC   RECTYP,TRTOTYP      TEST TRANSMISSION TOTAL REC                  
         BNE   EZR010                                                           
         SPACE                                                                  
         AP    TOTDOLS,DUB                                                      
         B     EZR010                                                           
*                                                                               
EZR040   DS    0H                                                               
         CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR042                                                           
         MVC   BAND,RFDATA         SAVE BAND                                    
         B     EZR010                                                           
*                                                                               
EZR042   DS    0H                                                               
         CLC   RECTYP,AGYRTYP      TEST AGENCY RECORD                           
         BNE   EZR044                                                           
         MVC   AGYLIN1,RFDATA      SAVE AGENCY ADDR 1                           
         B     EZR010                                                           
*                                                                               
EZR044   DS    0H                                                               
         CLC   RECTYP,INVRTYP      TEST INVOICE RECORD                          
         BNE   EZR010                                                           
         MVC   ADVNAM,RFDATA       SAVE ADVERTISER NAME                         
         B     EZR010                                                           
*                                                                               
EZR050   DS    0H                                                               
         EJECT                                                                  
* END OF INPUT EASI TAPE *                                                      
         SPACE                                                                  
EZR090   DS    0H                  EOFILE                                       
         BAS   RE,ENDINV           FINISH ANY OLD INVOICE                       
         SPACE                                                                  
         GOTO1 =A(ENDBTCH),DMCB,(RC)  PROCESS END OF BATCH                      
         SPACE                                                                  
         L     R2,AEZINPT                                                       
         CLOSE (R2)                                                             
*                                                                               
         MVC   LINE,=PL2'200'      FORCE NEW PAGE                               
         MVC   P(10),=C'RUN TOTALS'                                             
         GOTO1 =V(PRINTER)                                                      
         MVC   P(10),DASHES                                                     
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
         MVC   P(14),=C'TOTAL INVOICES'                                         
         L     R2,TINVS                                                         
         LA    R3,P+24                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         MVC   P+35(12),=C'CLIENT CODES'                                        
         L     R2,TCLTCDS                                                       
         LA    R3,P+49                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         MVC   P+63(13),=C'PRODUCT CODES'                                       
         L     R2,TPRDCDS                                                       
         LA    R3,P+78                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         MVC   P+96(14),=C'ESTIMATE CODES'                                      
         L     R2,TESTCDS                                                       
         LA    R3,P+105                                                         
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         MVC   P+6(5),=C'SPOTS'                                                 
         L     R2,TSPTS                                                         
         LA    R3,P+24                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         MVC   P+6(7),=C'DOLLARS'                                               
         LA    R2,TDOLS                                                         
         LA    R3,P+16                                                          
         BAS   RE,EDIT2A                                                        
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
         MVC   P(13),=C'TOTAL BATCHES'                                          
         L     R2,TBTCHS                                                        
         LA    R3,P+24                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         EDIT  (P8,IBYTS),(13,P+40),ZERO=NOBLANK,COMMAS=YES                     
         MVC   P+54(14),=C'RECEIVED BYTES'                                      
         EDIT  (P8,OBYTS),(13,P+70),ZERO=NOBLANK,COMMAS=YES                     
         MVC   P+84(12),=C'WORKER BYTES'                                        
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
         OC    TDELINV,TDELINV     WERE THERE ANY DEL PREV INVOICES             
         BZ    EZR092               NO                                          
         SPACE                                                                  
         MVC   P(13),=C'TOTAL DEL INV'                                          
         L     R2,TDELINV                                                       
         LA    R3,P+24                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
EZR092   GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
         SR    R4,R4                                                            
         SR    R5,R5                                                            
         OC    TBDBAT,TBDBAT       ANY BAD BATCH TOTAL                          
         BZ    EZR094                                                           
         MVC   P(13),=C'TOTAL BATCHES'                                          
         MVC   P+14(14),=C'UNKNOWN AGENCY'                                      
         L     R2,TBDBAT                                                        
         LA    R3,P+30                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         LA    R4,=C'* UNKNOWN AGENCY - NO LOAD *'                              
         SPACE                                                                  
EZR094   OC    TMAXERRS,TMAXERRS   ANY BAD ERRORS                               
         BZ    EZR100                                                           
         LTR   R4,R4               IF PREV ERROR, PRINT IT                      
         BZ    EZR096                                                           
         GOTO1 =V(PRINTER)                                                      
EZR096   MVC   P(11),=C'DATA ERRORS'                                            
         L     R2,TMAXERRS                                                      
         LA    R3,P+30                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         LA    R5,=C'* BAD DATA ERROR - NO LOAD *'                              
         SPACE                                                                  
EZR100   LTR   R4,R4                                                            
         BNZ   *+10                                                             
         LTR   R5,R5                                                            
         BZ    EZR110                                                           
         MVI   P+40,C'*'                                                        
         MVC   P+41(27),P+40                                                    
         GOTO1 =V(PRINTER)                                                      
         MVI   P+40,C'*'                                                        
         MVI   P+67,C'*'                                                        
         GOTO1 =V(PRINTER)                                                      
         LTR   R4,R4                                                            
         BZ    EZR104                                                           
         MVC   P+40(28),0(R4)                                                   
         GOTO1 =V(PRINTER)                                                      
EZR104   LTR   R5,R5                                                            
         BZ    EZR106                                                           
         MVC   P+40(28),0(R5)                                                   
         GOTO1 =V(PRINTER)                                                      
EZR106   MVI   P+40,C'*'                                                        
         MVI   P+67,C'*'                                                        
         GOTO1 =V(PRINTER)                                                      
         MVI   P+40,C'*'                                                        
         MVC   P+41(27),P+40                                                    
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR110   MVC   P(15),=C'LOADED INVOICES'                                        
         L     R2,LINVS                                                         
         LA    R3,P+24                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         MVC   P+7(5),=C'SPOTS'                                                 
         L     R2,LSPTS                                                         
         LA    R3,P+24                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         MVC   P+7(7),=C'DOLLARS'                                               
         LA    R2,LDOLS                                                         
         LA    R3,P+16                                                          
         BAS   RE,EDIT2A                                                        
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         MVC   P+7(7),=C'BATCHES'                                               
         L     R2,LBTCHS                                                        
         LA    R3,P+24                                                          
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
         OC    TOTINVS,TOTINVS     ANY TRANS TOT REC                            
         BZ    EZR120               NO                                          
*                                                                               
         CLC   TINVS,TOTINVS       WE FIND ALL THE INVOICES                     
         BNE   EZR124               YES                                         
*                                                                               
EZR120   CP    TOTDOLS,=P'0'       ANY TRANS TOT REC                            
         BE    EZR130               NO                                          
*                                                                               
         CP    TDOLS,TOTDOLS       WE FIND ALL THE INVOICES                     
         BE    EZR130               YES                                         
*                                                                               
EZR124   DS    0H                                                               
         L     R2,TOTINVS                                                       
         LA    R3,P+1                                                           
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         MVC   P+8(16),=C'INVOICES ON TAPE'                                     
         SPACE                                                                  
         LA    R2,TOTDOLS                                                       
         LA    R3,P+40                                                          
         BAS   RE,EDIT2A                                                        
         SPACE                                                                  
         MVC   P+55(15),=C'DOLLARS ON TAPE'                                     
         GOTO1 =V(PRINTER)                                                      
         DC    H'0'                                                             
         SPACE                                                                  
* PRINT STATION AND AGENCY TOTALS                                               
         SPACE                                                                  
EZR130   LA    R2,100                                                           
         L     R3,=A(EZSTATAB)                                                  
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         MVC   P+4(7),=C'STATION'                                               
         MVC   P+12(8),=C'INVOICES'                                             
         MVC   P+23(5),=C'SPOTS'                                                
         MVC   P+38(7),=C'DOLLARS'                                              
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
EZR132   OC    0(5,R3),0(R3)       END OF ENTRIES                               
         BZ    EZR134                                                           
         MVC   P+4(4),0(R3)                                                     
         LA    R1,P+8                                                           
         CLI   3(R3),0                                                          
         BH    *+6                                                              
         BCTR  R1,0                                                             
         MVI   0(R1),C'-'                                                       
         MVC   1(1,R1),4(R3)                                                    
         CLI   1(R1),C' '                                                       
         BH    *+8                                                              
         MVI   1(R1),C'T'                                                       
         SPACE                                                                  
         ICM   R4,15,5(R3)                                                      
         EDIT  (R4),(5,P+15),COMMAS=YES                                         
         SPACE                                                                  
         ICM   R4,15,9(R3)                                                      
         EDIT  (R4),(5,P+23),COMMAS=YES                                         
         SPACE                                                                  
         ICM   R4,15,13(R3)                                                     
         EDIT  (R4),(13,P+32),2,COMMAS=YES                                      
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
         LA    R3,18(,R3)                                                       
         BCT   R2,EZR132                                                        
EZR134   DS    0H                                                               
         LA    R2,100                                                           
         L     R3,=A(EZAGYTAB)                                                  
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         MVC   P+4(6),=C'AGENCY'                                                
         MVC   P+12(8),=C'INVOICES'                                             
         MVC   P+23(5),=C'SPOTS'                                                
         MVC   P+38(7),=C'DOLLARS'                                              
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
EZR136   OC    0(8,R3),0(R3)       END OF ENTRIES                               
         BZ    EZR138                                                           
         MVC   P+4(8),0(R3)                                                     
         ICM   R4,15,8(R3)                                                      
         EDIT  (R4),(5,P+15),COMMAS=YES                                         
         SPACE                                                                  
         ICM   R4,15,12(R3)                                                     
         EDIT  (R4),(5,P+23),COMMAS=YES                                         
         SPACE                                                                  
         ICM   R4,15,16(R3)                                                     
         EDIT  (R4),(13,P+32),2,COMMAS=YES                                      
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
         LA    R3,20(,R3)                                                       
         BCT   R2,EZR136                                                        
EZR138   B     EOJ                                                              
         SPACE                                                                  
EDIT0    NTR1                                                                   
         EDIT  ((R2)),(5,(R3)),ZERO=NOBLANK                                     
EDITX    XIT1                                                                   
EDIT2    NTR1                                                                   
         EDIT  ((R2)),(14,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES             
         B     EDITX                                                            
EDIT2A   NTR1                                                                   
         EDIT  (P8,0(R2)),(14,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
         B     EDITX                                                            
         EJECT                                                                  
*        ENDREC - ROUTINE AT END OF RECORD                                      
*                                                                               
         DS    0H                                                               
ENDREC   NTR1                                                                   
         L     RF,WRCURPOS         CURRENT POS                                  
         S     RF,WRECST           LESS REC START                               
         BNP   ENDRX               = RECORD LENGTH (SKIP IF NONE)               
         ST    RF,RECLEN                                                        
*                                                                               
         BAS   RE,SAVREC           SAVE SOME RECORDS                            
         CLI   SAVSW,C'Y'          IF SAVED THIS REC, DONE                      
         BE    ENDRX               ELSE WRITE TO FILE                           
*                                                                               
*                                  ELSE WRITE TO FILE                           
*                                                                               
         CLC   STAFLDS,OLDSTA      TEST CHANGE OF STATION                       
         BNE   ENDR4                                                            
         CLC   AGYFLDS,OLDAGY      OR AGENCY                                    
         BE    ENDR6                                                            
*                                                                               
ENDR4    DS    0H                  NEW BATCH                                    
         L     RF,WRECST           UNLESS TRIGGERED BY NEW INVOICE              
         CLC   0(2,RF),INVRTYP                                                  
         BE    *+8                                                              
         BAS   RE,ENDINV           FINISH ANY OLD INVOICE                       
         SPACE                                                                  
         GOTO1 =A(ENDBTCH),DMCB,(RC)  PROCESS END OF BATCH                      
         SPACE                                                                  
         BAS   RE,NEWIND           SET NEW WORKER INDEX AND PRINT               
*                                                                               
ENDR6    DS    0H                                                               
         BAS   RE,PUTSAV           DO SAVED RECORDS FIRST                       
         L     R1,WKRREC           THEN THIS ONE                                
         BAS   RE,SAVRN            MOVE TO RECORD AREA                          
         BAS   RE,INVPROC          HANDLE INVOICE HEADER REC                    
         SPACE                                                                  
         CLC   RECTYP,TRTOTYP      TEST TRANSMISSION TOTAL REC                  
         BE    ENDRX                DON'T PUT IT TO WORKER FILE                 
         SPACE                                                                  
         BAS   RE,ADDWKR                                                        
*                                                                               
ENDRX    DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*        SAVREC - SAVE CERTAIN RECORDS                                          
*                                                                               
SAVREC   DS    0H                                                               
         MVI   SAVSW,C'Y'          SET HAVE SAVED                               
*                                                                               
         CLC   RECTYP,STARTYP      STATION RECORD                               
         BNE   SAVR2                                                            
         L     R1,=A(SAVSTA)                                                    
         OI    SVRECSW,X'80'                                                    
         B     SAVRN                                                            
*                                                                               
SAVR2    DS    0H                                                               
         CLC   RECTYP,PAYRTYP      PAYEE                                        
         BNE   SAVR4                                                            
         L     R1,=A(SAVPAY)                                                    
         OI    SVRECSW,X'40'                                                    
         B     SAVRN                                                            
*                                                                               
SAVR4    DS    0H                                                               
         CLC   RECTYP,AGYRTYP      AGENCY                                       
         BNE   SAVR6                                                            
         L     R1,=A(SAVAGY)                                                    
         OI    SVRECSW,X'20'                                                    
         B     SAVRN                                                            
*                                                                               
SAVR6    DS    0H                                                               
         MVI   SAVSW,C'N'          SET NOT SAVED                                
         BR    RE                                                               
*                                                                               
         DS    0H                                                               
SAVRN    NTR1                                                                   
         L     RE,WRECST           START OF RECORD = FROM ADDRESS               
         L     RF,RECLEN           FROM LENGTH                                  
         LA    RF,2(RF)                                                         
         CH    RF,=H'1024'         CANNOT BE MORE THAN 1024                     
         BNH   *+6                                                              
         DC    H'0'                FOR NOW BLOW UP                              
         STH   RF,0(R1)                                                         
         SH    RF,=H'2'                                                         
         LA    R0,2(R1)            TO ADDRESS                                   
         LA    R1,1022             TO LENGTH                                    
         MVCL  R0,RE                                                            
         CR    RD,RD               SET CC =                                     
         XIT1                                                                   
         EJECT                                                                  
*        PUTSAV - PUT SAVED RECORDS                                             
*                                                                               
PUTSAV   NTR1                                                                   
         TM    SVRECSW,X'20'       TEST NEED AGENCY                             
         BZ    PSV2                                                             
         NI    SVRECSW,X'DF'                                                    
         L     R2,=A(SAVAGY)       AGENCY - FROM ADDRESS                        
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,1024             TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
PSV2     DS    0H                                                               
         TM    SVRECSW,X'80'       TEST NEED STATION                            
         BZ    PSV4                                                             
         NI    SVRECSW,X'7F'                                                    
         L     R2,=A(SAVSTA)       STATION - FROM ADDRESS                       
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,1024             TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
PSV4     DS    0H                                                               
         TM    SVRECSW,X'40'       TEST NEED PAYEE                              
         BZ    PSV6                                                             
         NI    SVRECSW,X'BF'                                                    
         L     R2,=A(SAVPAY)       PAYEE - FROM ADDRESS                         
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,1024             TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
PSV6     DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*        INVPROC - HANDLE INVOICE HEADER RECORD                                 
*                (ADD 12 BYTE STATUS FIELD + DELIMITER, AND PRINT)              
*                                                                               
INVPROC  DS    0H                                                               
         CLC   RECTYP,INVRTYP      TEST INVOICE HEADER                          
         BNER  RE                                                               
*                                                                               
         NTR1                                                                   
         L     RF,BINVS            BUMP INVOICE COUNT                           
         LA    RF,1(RF)                                                         
         ST    RF,BINVS                                                         
*                                                                               
         L     R2,WKRREC           FROM WKRREC                                  
         LH    R3,0(R2)            FROM LENGTH                                  
         CH    R3,=H'1024'         MAX LENGTH                                   
         BL    *+6                                                              
         DC    H'0'                                                             
         L     R0,=A(RECWRK)       TO WORK AREA                                 
         LR    R1,R3               TO LENGTH                                    
         MVCL  R0,R2                                                            
*                                                                               
         L     R2,WKRREC                                                        
         CLC   4(1,R2),FDELIM      FIELD DELIMITER AFTER REC CODE               
         BE    *+6                 AT END OF REC CODE                           
         DC    H'0'                BAD RECORD                                   
*                                                                               
         XC    5(12,R2),5(R2)      SET TWELVE BYTE STATUS FIELD                 
         OI    5(R2),X'80'         EZMOD DROPS LEADING BLANKS                   
         MVC   17(1,R2),FDELIM                                                  
*                                                                               
         LH    RF,0(R2)            BUMP RECORD LENGTH                           
         LA    RF,13(RF)                                                        
         STH   RF,0(R2)                                                         
*                                                                               
         LA    R0,18(R2)           TO ADDRESS                                   
         L     R2,=A(RECWRK)                                                    
         LH    R3,0(R2)                                                         
         LA    R2,5(R2)            FROM ADDRESS                                 
         SH    R3,=H'5'            FROM LENGTH                                  
         LR    R1,R3               TO LENGTH = FROM LENGTH                      
         CH    R3,=H'1024'                                                      
         BL    *+6                                                              
         DC    H'0'                                                             
         MVCL  R0,R2                                                            
*                                                                               
         XIT1                                                                   
         EJECT                                                                  
*        ENDINV  - END OF AN INVOICE                                            
*                                                                               
ENDINV   DS    0H                                                               
         OC    INVFLDS,INVFLDS                                                  
         BZR   RE                                                               
*                                                                               
         NTR1                                                                   
         CLI   EXCLSW,C'Y'         SKIP EXPRESSLY EXCLUDED BATCHES              
         BE    ENDI40                                                           
*                                                                               
         MVC   ILADV,ADVNAM                                                     
         MVC   ILPRD,PRDNAM                                                     
         MVC   ILINV,INVNO                                                      
         MVC   ILMOS,INVMOS                                                     
         SPACE                                                                  
         CLI   INVDEL,C'Y'         SET AS DELETE PREV INV                       
         BNE   ENDI02                                                           
         MVC   ERRLINE(32),=C'* NOTE * DELETE PREVIOUS INVOICE'                 
         SPACE                                                                  
ENDI02   OC    ADVCD,ADVCD         ANY ADVERTISER CODE                          
         BZ    ENDI10                                                           
         MVC   ILADVCD,ADVCD                                                    
         SPACE                                                                  
* CHECK FOR OBVIOUS ERRORS *                                                    
         SPACE                                                                  
         CLI   ADVCD,C'A'                                                       
         BL    ENDI08                                                           
         CLI   ADVCD,C'Z'                                                       
         BH    ENDI08                                                           
         CLI   ADVCD+1,C'A'                                                     
         BL    ENDI08                                                           
         CLI   ADVCD+1,C'Z'                                                     
         BH    ENDI08                                                           
         CLI   ADVCD+2,0                                                        
         BE    ENDI06                                                           
         CLI   ADVCD+2,C' '                                                     
         BE    ENDI06                                                           
         CLI   ADVCD+3,C' '                                                     
         BH    ENDI08                                                           
         CLI   ADVCD+2,C'A'                                                     
         BL    ENDI08                                                           
         CLI   ADVCD+2,C'9'                                                     
         BH    ENDI08                                                           
ENDI06   L     R1,TCLTCDS                                                       
         LA    R1,1(,R1)                                                        
         ST    R1,TCLTCDS                                                       
         B     ENDI10                                                           
ENDI08   MVC   ERRLINE+ILADVCD-P(3),=C'***'                                     
*                                                                               
ENDI10   OC    PRDCD,PRDCD         ANY PRODUCT CODE(S)                          
         BZ    ENDI20                                                           
         MVC   ILPRDCD,PRDCD                                                    
         SPACE                                                                  
* CHECK FOR OBVIOUS ERRORS *                                                    
         SPACE                                                                  
         CLI   PRDCD,C'A'                                                       
         BL    ENDI12                                                           
         CLI   PRDCD,C'Z'                                                       
         BH    ENDI12                                                           
         CLI   PRDCD+1,C'A'                                                     
         BL    ENDI12                                                           
         CLI   PRDCD+1,C'Z'                                                     
         BH    ENDI12                                                           
         CLI   PRDCD+2,0                                                        
         BE    ENDI11                                                           
         CLI   PRDCD+2,C' '                                                     
         BE    ENDI11                                                           
         CLI   PRDCD+3,C' '                                                     
         BH    ENDI12                                                           
         CLI   PRDCD+2,C'A'                                                     
         BL    ENDI12                                                           
         CLI   PRDCD+2,C'Z'                                                     
         BH    ENDI12                                                           
ENDI11   L     R1,TPRDCDS                                                       
         LA    R1,1(,R1)                                                        
         ST    R1,TPRDCDS                                                       
         B     ENDI13                                                           
ENDI12   MVC   ERRLINE+ILPRDCD-P(3),=C'***'                                     
*                                                                               
ENDI13   LA    R0,8                                                             
         LA    RF,PRDCD                                                         
ENDI14   CLI   0(RF),C' '          LOOK FOR BLANK SEPARATOR                     
         BNH   *+16                                                             
         LA    RF,1(,RF)                                                        
         BCT   R0,ENDI14                                                        
         B     ENDI20                                                           
         LA    RF,1(,RF)                                                        
         BCTR  R0,0                                                             
         LTR   R0,R0                                                            
         BZ    ENDI20           GET OUT IF END OF FIELD                         
*                                                                               
ENDI16   CLI   0(RF),C' '          LOOK FOR NON-BLK PROD2                       
         BH    *+16                                                             
         LA    RF,1(,RF)                                                        
         BCT   R0,ENDI16                                                        
         B     ENDI20                                                           
*                                                                               
         XC    WORK,WORK                                                        
         LA    RE,WORK                                                          
         MVC   0(1,RE),0(RF)                                                    
         LA    RE,1(,RE)                                                        
         LA    RF,1(,RF)                                                        
         BCT   R0,*-14                                                          
*                                                                               
         CLI   WORK,C'A'                                                        
         BL    ENDI18                                                           
         CLI   WORK,C'Z'                                                        
         BH    ENDI18                                                           
         CLI   WORK+1,C'A'                                                      
         BL    ENDI18                                                           
         CLI   WORK+1,C'Z'                                                      
         BH    ENDI18                                                           
         CLI   WORK+2,0                                                         
         BE    ENDI20                                                           
         CLI   WORK+2,C' '                                                      
         BE    ENDI20                                                           
         CLI   WORK+2,C'A'                                                      
         BL    ENDI18                                                           
         CLI   WORK+2,C'Z'                                                      
         BNH   ENDI20                                                           
ENDI18   MVC   ERRLINE+ILPRDCD-P(3),=C'***'                                     
*                                                                               
ENDI20   OC    ESTNO,ESTNO         ANY ESTIMATE                                 
         BZ    ENDI30                                                           
         MVC   ILEST,ESTNO                                                      
         XC    FULL,FULL                                                        
         LA    R0,10                                                            
         LA    R1,FULL                                                          
         LA    RE,ESTNO                                                         
         LA    RF,3                                                             
         MVI   BYTE,0                                                           
         SPACE                                                                  
         CLI   0(RE),C' '                                                       
         BH    ENDI21                                                           
         LA    RE,1(,RE)                                                        
         BCT   R0,*-12                                                          
         DC    H'0'                                                             
ENDI21   CLI   0(RE),C'0'                                                       
         BNE   ENDI22                                                           
         LA    RE,1(,RE)                                                        
         BCT   R0,*-12                                                          
         MVI   BYTE,1                                                           
         B     ENDI26                                                           
         SPACE                                                                  
ENDI22   CLI   0(RE),C'0'                                                       
         BL    ENDI24                                                           
         CLI   0(RE),C'9'                                                       
         BH    ENDI25                                                           
         MVC   0(1,R1),0(RE)                                                    
         LA    R1,1(,R1)                                                        
         LA    RE,1(,RE)                                                        
         BCT   RF,*+8              GET FIRST 3 DIGITS ONLY                      
         B     ENDI24                                                           
         BCT   R0,ENDI22           ALLOW MAX EST FIELD LENGTH                   
ENDI24   LA    R0,3                                                             
         LA    R1,FULL                                                          
         SR    RF,RF                                                            
         CLI   0(R1),0                                                          
         BE    *+14                                                             
         LA    R1,1(,R1)                                                        
         BCTR  RF,0                                                             
         BCT   R0,*-14                                                          
         LPR   RF,RF                                                            
         BZ    ENDI28                                                           
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  DUB,FULL(0)                                                      
         CVB   R0,DUB                                                           
         CH    R0,=H'256'                                                       
         BL    ENDI26                                                           
         SPACE                                                                  
ENDI25   MVI   BYTE,1                                                           
         SPACE                                                                  
ENDI26   DS    0H                                                               
         CLI   BYTE,1                                                           
         BNE   ENDI29                                                           
ENDI28   MVC   ERRLINE+ILEST-P(3),=C'***'                                       
         B     ENDI30                                                           
ENDI29   L     R1,TESTCDS                                                       
         LA    R1,1(,R1)                                                        
         ST    R1,TESTCDS                                                       
         SPACE                                                                  
ENDI30   DS    0H                                                               
         L     R2,ISPTS                                                         
         LA    R3,ILSPTS                                                        
         BAS   RE,EDIT0                                                         
         SPACE                                                                  
         L     R2,IDOLS                                                         
         LA    R3,ILDOLS                                                        
         BAS   RE,EDIT2                                                         
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
         CLI   INVDEL,C'Y'         SET AS DELETE PREV INV                       
         BNE   ENDI34                                                           
         OC    IDOLS,IDOLS         WAS THIS ZERO INVOICE                        
         BZ    ENDI34               YES                                         
         MVC   ERRLINE+ILDOLS-P-14(26),=C'ERROR-DEL INV MUST BE ZERO'           
         SPACE                                                                  
ENDI34   OC    ERRLINE,ERRLINE                                                  
         BZ    ENDI40                                                           
         MVC   P,ERRLINE                                                        
         XC    ERRLINE,ERRLINE                                                  
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDI40   DS    0H                                                               
         XC    INVFLDS,INVFLDS                                                  
         L     RF,ISPTS            ROLL UP TO BATCH TOTALS                      
         A     RF,BSPTS                                                         
         ST    RF,BSPTS                                                         
         L     RF,IDOLS            ROLL UP TO BATCH TOTALS                      
         A     RF,BDOLS                                                         
         ST    RF,BDOLS                                                         
         SPACE                                                                  
         BAS   RE,ADDSTA           ADD TO STATION COUNTERS                      
         SPACE                                                                  
         BAS   RE,ADDAGY           ADD TO AGENCY COUNTERS                       
         SPACE                                                                  
         XC    IDOLS,IDOLS                                                      
         XC    ISPTS,ISPTS                                                      
*                                                                               
         XIT1                                                                   
         EJECT                                                                  
*        TRCRET- ROUTINE TO TRACE GETFLD RETURNS                                
*                                                                               
TRCRET   TM    RFCNTL,X'20'      FIELD ERROR                                    
         BNZ   TRCRETN                                                          
         CLI   TRACEFLD,C'Y'     TEST TRACING FIELDS                            
         BNER  RE                                                               
         CLI   EXCLSW,C'Y'       SKIP EXPRESSLY EXCLUDED BATCHES                
         BER   RE                                                               
*                                                                               
TRCRETN  NTR1                                                                   
         MVC   P,SPACES                                                         
         TM    RFCNTL,X'20'        FIELD ERROR                                  
         BZ    TRCRETN1                                                         
         OC    RFERRMSG,RFERRMSG                                                
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   P+7(L'RFERRMSG),RFERRMSG                                         
         GOTO1 =V(PRINTER)                                                      
         MVC   P,SPACES                                                         
TRCRETN1 MVC   P(6),=C'GETFLD'                                                  
         GOTO1 =V(HEXOUT),DMCB,RFCNTL,P+7,1,=C'N'                               
         GOTO1 =V(HEXOUT),DMCB,RFCNTL2,P+10,1,=C'N'                             
         EDIT  (B1,RFFLDNO),(3,P+13),FILL=0                                     
         EDIT  (B1,RFLEN),(3,P+17),FILL=0                                       
         MVC   P+21(100),RFDATA                                                 
         GOTO1 =V(PRINTER)                                                      
         MVC   P,SPACES                                                         
*                                                                               
         XIT1                                                                   
         EJECT                                                                  
*        TRCREAD- ROUTINE TO TRACE INPUT FILE READS                             
*                                                                               
TRCREAD  CLI   TRACEREC,C'Y'       TEST TRACING FIELDS                          
         BNER  RE                                                               
*                                                                               
TRCREADN NTR1                                                                   
         MVC   P,SPACES                                                         
         GOTO1 =V(PRINTER)                                                      
         L     R6,=A(EZINREC)                                                   
         L     R2,AEZINPT                                                       
         LH    R2,82(R2)           LENGTH IF UNDEFINED                          
         CLI   RECFM,C'U'                                                       
         BE    TRD5                                                             
         LH    R2,0(R6)            LENGTH IF VARIABLE FMT                       
*                                                                               
TRD5     DS    0H                                                               
         MVC   P(5),=C'INPUT'                                                   
         EDIT  (R2),(4,P+6),FILL=0                                              
         LA    R3,0(R6,R2)         EOR                                          
*                                                                               
TRD6     LR    R4,R3                                                            
         SR    R4,R6                                                            
         BNP   TRD8                                                             
         CH    R4,=H'100'                                                       
         BNH   *+8                                                              
         LA    R4,100                                                           
*                                                                               
         BCTR  R4,R0                                                            
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   P+11(0),0(R6)                                                    
         LA    R4,1(R4)                                                         
         GOTO1 =V(PRINTER)                                                      
         MVC   P,SPACES                                                         
         LA    R6,0(R6,R4)                                                      
         B     TRD6                                                             
*                                                                               
TRD8     DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P,SPACES                                                         
         XIT1                                                                   
         EJECT                                                                  
         EJECT                                                                  
*        CHKSTA- CHECK STATION IN IDELEM                                        
*        (R6 POINTS TO STATION-MEDIA)                                           
*                                                                               
         DS    0H                                                               
CHKSTA   NTR1                                                                   
         SR    R2,R2               START AT LEVEL 0                             
         CLC   0(4,R6),=C'ALL '    STATION MUST BE ALL                          
         BE    CKS10                                                            
         CLC   0(4,R6),STATION     OR = TO THIS STATION                         
         BNE   CKSX                                                             
         LA    R2,10             IF FOR STATION START AT HIGHER LEVEL           
*                                                                               
CKS10    DS    0H                                                               
         LA    R2,1(R2)                                                         
         CLI   4(R6),C' '          MEDIA BLANK IS LOWEST SPECIFICITY            
         BE    CKSX                                                             
         LA    R5,ID               CHECK VS MEDIA IN ID                         
         USING EZWKRIXD,R5                                                      
         LA    R2,1(R2)                                                         
         CLI   4(R6),C'R'          ALL RADIO IS NEXT                            
         BNE   CKS12                                                            
         CLI   EZWIMED,C'A'          AM                                         
         BE    CKSX                                                             
         CLI   EZWIMED,C'F'          FM                                         
         BE    CKSX                                                             
         B     CKS14                                                            
         SPACE                                                                  
CKS12    CLI   4(R6),C'N'          ALL NETWORK IS NEXT                          
         BNE   CKS14                                                            
         CLI   EZWIMED,C'N'          NETWORK                                    
         BE    CKSX                                                             
         CLI   EZWIMED,C'C'          CABLE                                      
         BE    CKSX                                                             
         CLI   EZWIMED,C'S'          SYNDICATION                                
         BE    CKSX                                                             
         SPACE                                                                  
CKS14    DS    0H                                                               
         LA    R2,1(R2)            THEN ACTUAL MEDIA/BAND                       
         CLC   4(1,R6),EZWIMED                                                  
         BE    CKSX                                                             
*                                                                               
         SR    R2,R2               ELSE FAILS ON MEDIA                          
*                                                                               
CKSX     DS    0H                                                               
         STC   R2,BYTE                                                          
         XIT1                                                                   
         DROP  R5                                                               
         EJECT                                                                  
*        NEWIND - BUILD NEW WORKER INDEX AND PRINT HEADLINES                    
         SPACE 2                                                                
         DS    0H                                                               
NEWIND   NTR1                                                                   
         MVI   SVRECSW,X'FF'       SET NEED TO PUT ALL SAVES                    
         XC    ID,ID                                                            
         LA    R4,ID                                                            
         USING EZWKRIXD,R4                                                      
*                                                                               
         MVC   EZWISTN,STATION     CALL LETTERS                                 
         MVI   EZWIDAY,X'99'       DAY = 99                                     
         MVI   EZWIMED,C'T'        MEDIA                                        
         CLI   MEDIA,C'T'                                                       
         BE    NI10                                                             
         CLI   MEDIA,0             ZERO IS TV ALSO                              
         BE    NI10                                                             
         CLI   MEDIA,C' '          BLANK IS TV ALSO                             
         BE    NI10                                                             
         MVI   EZWIMED,C'N'        MEDIA                                        
         CLI   MEDIA,C'N'          NETWORK                                      
         BE    NI10                                                             
         MVI   EZWIMED,C'C'        MEDIA                                        
         CLI   MEDIA,C'C'          NETWORK CABLE                                
         BE    NI10                                                             
         MVC   EZWIMED,BAND        FOR RADIO USE BAND AS MEDIA                  
*                                                                               
NI10     DS    0H                      TEST FOR STATION INCL/EXCL               
         MVI   EXCLSW,C'N'                                                      
         OC    STTPARS+8(4),STTPARS+8  TEST HAVE ANY STATION LIST               
         BZ    NI24                NO, OK                                       
         MVC   WORK(4),EZWISTN     SEE IF THIS ONE IN LIST                      
         OI    WORK+3,X'40'                                                     
         MVC   WORK+4(1),EZWIMED                                                
         GOTO1 =V(BINSRCH),STTPARS,WORK                                         
         CLI   0(R1),0                                                          
         BNE   NI20                                                             
*                                  STATION IS IN LIST                           
         CLI   STMODE,C'+'       TEST TO INCLUDE ONLY THOSE IN LIST             
         BE    NI24                                                             
         MVI   EXCLSW,C'Y'                                                      
         B     NIX                                                              
*                                                                               
NI20     DS    0H                  STATION NOT IN LIST                          
         CLI   STMODE,C'+'         TEST TO INCLUDE ONLY THOSE IN LIST           
         BNE   NI24                                                             
         MVI   EXCLSW,C'Y'                                                      
         B     NIX                                                              
*                                                                               
NI24     DS    0H                                                               
         BAS   RE,GETUID                                                        
         CLI   EXCLSW,C'N'         EXCLUDE SWITCH                               
         BNE   NI50                DON'T OPEN                                   
         MVC   EZWIUID,USIDNO                                                   
         USING UKRECD,R4                                                        
         OI    UKFLAG,X'28'        SET DATE, COMMENT                            
         CLI   RERUN,C'Y'          UNLESS RERUN                                 
         BE    *+8                                                              
         OI    UKFLAG,X'01'        ALLOW DUPES                                  
*                                                                               
         L     R5,WKRREC                                                        
         LA    R5,28(R5)           SKIP OVER FIRST 28 BYTES                     
         USING WKRECD,R5                                                        
         XC    0(96,R5),0(R5)                                                   
         MVC   WKAGED,TODAYP                                                    
         MVC   WKAGET,TIMEP                                                     
*                                                                               
         LA    R5,WKCOMNT          COMMENT AREA                                 
         USING EZWKRCMD,R5                                                      
*                                  NO COMMENT DATA AT THIS POINT                
         OC    SOURCE,SOURCE       ANY SOURCE CODE                              
         BZ    NI30                                                             
         XC    EZWCMNT,EZWCMNT                                                  
         MVI   EZWCSTAT,X'80'      STOP EZMOD FROM DROPPING BLANKS              
         MVC   EZWCSRCE,SOURCE                                                  
         SPACE                                                                  
         MVC   LINE,=PL2'200'      FORCE NEW PAGE                               
         MVC   P(6),=C'SOURCE'                                                  
         MVC   P+10(4),SOURCE                                                   
         CLI   TEST,C'Y'                                                        
         BNE   *+10                                                             
         MVC   P+47(10),=C'(TEST RUN)'                                          
         GOTO1 =V(PRINTER)                                                      
         SPACE                                                                  
*                                                                               
NI30     DS    0H                                                               
         CLI   TEST,C'Y'                                                        
         BE    NI50                                                             
         GOTO1 =V(DATAMGR),DMCB,=C'OPEN',WKRFIL,ID,WKRREC,WKRBUF                
         SPACE                                                                  
         SR    R0,R0                                                            
         ICM   R0,3,ID+WKFILNO-WKRECD                                           
         BNZ   NI40                                                             
         MVI   EXCLSW,C'*'         SET TO EXCLUDE WORKER FILE FULL              
         MVC   P+35(38),=C'* WORKER FILE FULL, BATCH NOT LOADED *'              
NI40     CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         MVC   P+20(8),=C'WKR SEQ='                                             
         UNPK  P+28(4),DUB                                                      
         SPACE                                                                  
NI50     DS    0H                                                               
         MVC   P(7),=C'STATION'                                                 
         MVC   P+10(4),STATION                                                  
         MVI   P+14,C'-'                                                        
         USING EZWKRIXD,R4                                                      
         MVC   P+15(1),EZWIMED     MEDIA                                        
         OC    SOURCE,SOURCE       ANY SOURCE CODE                              
         BNZ   NI54                                                             
         MVC   LINE,=PL2'200'      FORCE NEW PAGE                               
         CLI   TEST,C'Y'                                                        
         BNE   NI54                                                             
         MVC   P+47(10),=C'(TEST RUN)'                                          
         SPACE                                                                  
NI54     DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P(7),=C'USER ID'                                                 
         MVC   P+10(8),USID                                                     
         MVI   P+19,C'('                                                        
         MVI   P+24,C')'                                                        
         EDIT  (B2,USIDNO),(4,P+20),FILL=0                                      
         GOTO1 =V(PRINTER)                                                      
         MVC   P(7),=C'AGENCY '                                                 
         MVC   P+10(25),AGYNAME                                                 
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,AGYLIN1          AGENCY ADDRESS LINES                         
         LA    R5,4                                                             
*                                                                               
NI60     DS    0H                                                               
         CLI   0(R4),C' '                                                       
         BNH   NI64                                                             
         MVC   P+10(30),0(R4)                                                   
         GOTO1 =V(PRINTER)                                                      
NI64     DS    0H                                                               
         LA    R4,30(R4)                                                        
         BCT   R5,NI60                                                          
*                                                                               
         CLI   EXCLSW,C'N'                                                      
         BE    NI70                                                             
         GOTO1 =V(PRINTER)                                                      
         MVC   P(36),=C'** BATCH NOT ADDED TO WORKER FILE **'                   
         GOTO1 =V(PRINTER)                                                      
*                                                                               
NI70     DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
         L     R4,=A(COLHDS1)                                                   
         MVC   P,0(R4)             COLUMN HEADINGS                              
         GOTO1 =V(PRINTER)                                                      
         MVC   P,132(R4)                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
NIX      DS    0H                                                               
         XIT1                                                                   
         DROP  R4,R5                                                            
         EJECT                                                                  
* END OF FILE ROUTINE FOR LOAD TAPE *                                           
         SPACE                                                                  
GETEOF   DS    0H                  END OF FILE                                  
         SPACE                                                                  
*                                                                               
         B     GETFX                                                            
*                                                                               
GETEOF20 DS    0H                                                               
         B     GETFX                                                            
         SPACE                                                                  
         EJECT                                                                  
*        CONSTANTS FOR SOME RECORD TYPES                                        
*                                                                               
TYPETABL DS    0CL2                                                             
TRTOTYP  DC    CL2'12'                                                          
AGYRTYP  DC    CL2'21'                                                          
STARTYP  DC    CL2'22'                                                          
PAYRTYP  DC    CL2'23'                                                          
         DC    CL2'24'                                                          
         DC    CL2'25'                                                          
INVRTYP  DC    CL2'31'                                                          
         DC    CL2'32'                                                          
         DC    CL2'33'                                                          
INTRTYP  DC    CL2'34'                                                          
         DC    CL2'41'                                                          
         DC    CL2'42'                                                          
SPTRTYP  DC    CL2'51'                                                          
         DC    CL2'52'                                                          
TYPETLEN EQU   (*-TYPETABL)/2                                                   
         SPACE 2                                                                
PATCH1   DS    CL32                                                             
SORTCARD DC    CL80'SORT FIELDS=(4,12,A),FORMAT=BI,WORK=1'                      
RECCARD  DC    CL80'RECORD TYPE=F,LENGTH=200'                                   
         SPACE                                                                  
         LTORG                                                                  
         SPACE                                                                  
         DROP  R9,RB,RC                                                         
         EJECT                                                                  
* INITIALIZE PROGRAM                                                            
         SPACE                                                                  
INIT     NMOD1 0,**INIT**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
         LA    RE,EZLDWKD          CLEAR WORK                                   
         LA    RF,EZLDWKL                                                       
         XCEF                                                                   
*                                                                               
         MVI   SPACES,C' '                                                      
         MVC   SPACES+1(L'SPACES-1),SPACES                                      
*                                                                               
         MVC   TITLE(38),=C'EASI - CONVERT BAR TAPE TO EASI FORMAT'             
         MVI   DASHES,C'-'                                                      
         MVC   DASHES+1(L'DASHES-1),DASHES                                      
         XC    COUNTS,COUNTS                                                    
         XC    INVFLDS,INVFLDS                                                  
*                                                                               
         SPACE 3                                                                
*              READ PARAMETER CARDS                                             
         SPACE                                                                  
         MVC   P(13),=C'CONTROL CARDS'                                          
         GOTO1 =V(PRINTER)                                                      
         MVC   P(13),DASHES                                                     
         GOTO1 =V(PRINTER)                                                      
         SPACE 2                                                                
EZL10    DS    0H                                                               
         GOTO1 =V(CARDS),DMCB,CARD,=C'RE00'                                     
         CLC   =C'/*',CARD                                                      
         BE    EZL60                                                            
         MVC   P(80),CARD                                                       
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CLC   =C'TRACE=',CARD                                                  
         BNE   EZL14                                                            
         MVC   TRACES,CARD+6     RECORDS,FIELDS,WORKER RECS                     
         B     EZL10                                                            
*                                                                               
EZL14    DS    0H                                                               
         CLC   =C'DUMP=',CARD                                                   
         BNE   EZL20                                                            
         MVC   ABNDOPT,CARD+5                                                   
         B     EZL10                                                            
*                                                                               
EZL20    DS    0H                                                               
         CLC   =C'TEST=',CARD                                                   
         BNE   EZL24                                                            
         MVC   TEST,CARD+5                                                      
         B     EZL10                                                            
*                                                                               
EZL24    DS    0H                                                               
         CLC   =C'DATE=',CARD                                                   
         BNE   EZL30                                                            
         MVC   TODAY,CARD+5                                                     
         B     EZL10                                                            
*                                                                               
EZL30    DS    0H                                                               
         CLC   =C'RERUN=',CARD                                                  
         BNE   EZL34                                                            
         MVC   RERUN,CARD+6                                                     
         B     EZL10                                                            
*                                                                               
EZL34    DS    0H                                                               
         CLC   =C'STXIT',CARD                                                   
         BNE   EZL50                                                            
         L     RF,=A(EZBAR)                                                     
         ST    RF,WORK                                                          
         MVC   WORK+4(4),=A(EZBARX)                                             
         OI    WORK+4,X'80'        EOL                                          
         GOTO1 =V(STXITER),DMCB,WORK                                            
         B     EZL10                                                            
*                                                                               
EZL50    DS    0H                                                               
*                                                                               
         MVC   P(8),=C'BAD CARD'                                                
         GOTO1 =V(PRINTER)                                                      
         B     BADINIT                                                          
         SPACE 3                                                                
EZL60    DS    0H                                                               
         CLI   TODAY,0             TEST DATE GIVEN                              
         BNE   EZL64                                                            
         GOTO1 =V(DATCON),DMCB,(5,0),(0,TODAY)                                  
*                                                                               
EZL64    DS    0H                                                               
         PACK  WORK(4),TODAY(7)                                                 
         MVC   TODAYP,WORK                                                      
*                                                                               
         CLI   DMGOPT,C'N'                                                      
         BE    EZL70                                                            
         GOTO1 =V(DATAMGR),DMCB,=C'DMOPEN',=C'CONTROL',A(FILIST),WKRBUF         
EZL70    DS    0H                                                               
         SPACE                                                                  
BADINIT  CR    RB,RD               SET BAD COND CODE FOR INIT                   
         SPACE                                                                  
EZL90    XIT1                                                                   
         DROP  RB,RC                                                            
         EJECT                                                                  
*        ENDBTCH - END OF BATCH ROUTINE                                         
*                                                                               
         DS    0H                                                               
ENDBTCH  NMOD1 0,**ENDB**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
         OC    ID,ID                                                            
         BZ    ENDB24                                                           
         CLI   EXCLSW,C'Y'         SKIP EXPRESSLY EXCLUDED BATCHES              
         BE    ENDB10                                                           
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P(17),=C'INVOICES IN BATCH'                                      
         L     R2,BINVS                                                         
         LA    R3,P+24                                                          
         EDIT  ((R2)),(5,(R3)),ZERO=NOBLANK                                     
         SPACE                                                                  
         EDIT  (B4,BINVS),(5,P+24),ZERO=NOBLANK                                 
         GOTO1 =V(PRINTER)                                                      
         MVC   P(5),=C'SPOTS'                                                   
         L     R2,BSPTS                                                         
         EDIT  ((R2)),(5,(R3)),ZERO=NOBLANK                                     
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
         MVC   P(7),=C'DOLLARS'                                                 
         L     R2,BDOLS                                                         
         LA    R3,P+16                                                          
         EDIT  ((R2)),(14,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES             
         SPACE                                                                  
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDB10   CLI   EXCLSW,C'N'         IF NOT LOADED                                
         BNE   ENDB20               SKIP CLOSE AND COUNTS                       
         CLI   TEST,C'Y'           IF TEST RUN                                  
         BE    ENDB20               SKIP CLOSE AND COUNTS                       
*                                                                               
         L     RF,LBTCHS           BUMP LOADED BATCH TOTAL                      
         LA    RF,1(RF)                                                         
         ST    RF,LBTCHS                                                        
*                                                                               
         L     RF,BINVS            ROLL UP LOADED INV COUNT                     
         A     RF,LINVS                                                         
         ST    RF,LINVS                                                         
         L     RF,BSPTS            AND LOADED SPOT COUNT                        
         A     RF,LSPTS                                                         
         ST    RF,LSPTS                                                         
         L     RF,BDOLS            AND LOADED SPOT DOLLARS                      
         CVD   RF,DUB                                                           
         AP    LDOLS,DUB                                                        
*                                                                               
         GOTO1 =V(DATAMGR),DMCB,=C'CLOSE',WKRFIL,ID,WKRREC,WKRBUF               
*                                                                               
ENDB20   L     RF,BINVS            ROLL UP INVOICE COUNT                        
         A     RF,TINVS                                                         
         ST    RF,TINVS                                                         
         L     RF,BSPTS            ROLL UP SPOT COUNT                           
         A     RF,TSPTS                                                         
         ST    RF,TSPTS                                                         
         L     RF,BDOLS            ROLL UP SPOT DOLLARS                         
         CVD   RF,DUB                                                           
         AP    TDOLS,DUB                                                        
         XC    BINVS,BINVS                                                      
         XC    BSPTS,BSPTS                                                      
         XC    BDOLS,BDOLS                                                      
*                                                                               
         L     RF,TBTCHS           BUMP TOTAL BATCH COUNT                       
         LA    RF,1(RF)                                                         
         ST    RF,TBTCHS                                                        
*                                                                               
ENDB24   MVC   OLDSTA,STAFLDS                                                   
         MVC   OLDAGY,AGYFLDS                                                   
*                                                                               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
* DCB DSECT WITH ADRESSABLE LABELS *                                            
         SPACE 2                                                                
         PRINT GEN                                                              
         DCBD  DSORG=PS,DEVD=DA,TA                                              
         PRINT NOGEN                                                            
         SPACE                                                                  
*              DSECT FOR PROGRAM                                                
         SPACE 2                                                                
EZLDWKD  DSECT                                                                  
DUB      DS    D                                                                
DOUBLE   DS    D                                                                
FULL     DS    F                                                                
DMCB     DS    6F                                                               
HALF     DS    H                                                                
BYTE     DS    X                                                                
         DS    0F                                                               
IDTPARS  DS    6F                                                               
STTPARS  DS    6F                                                               
ERRLINE  DS    XL132                                                            
         DS    XL124                                                            
WORK     DS    XL64                                                             
CARD     DS    CL80                                                             
ID       DS    CL16                                                             
WKRFIL   DS    CL8                                                              
CTSAVE   DS    CL25                                                             
TODAY    DS    CL6                                                              
TODAYP   DS    CL3                                                              
EOR      DS    A                                                                
AEZINPT  DS    A                                                                
TRACES   DS    0CL3                                                             
TRACEREC DS    CL1                                                              
TRACEFLD DS    CL1                                                              
TRACEWKR DS    CL1                                                              
TEST     DS    CL1                                                              
ABNDOPT  DS    CL1                                                              
DMGOPT   DS    CL1                                                              
RERUN    DS    CL1                                                              
SVRECSW  DS    XL1                                                              
SAVSW    DS    CL1                                                              
USIDNO   DS    XL2                                                              
USID     DS    CL8                                                              
STMODE   DS    CL1                                                              
IDMODE   DS    CL1                                                              
EXCLSW   DS    CL1                                                              
STALEV   DS    X                                                                
SOURCE   DS    CL4                                                              
RECFM    DS    CL1                                                              
SVIDSTA  DS    CL5                                                              
DASHES   DS    CL60                                                             
KEY      DS    XL64                                                             
KEYSAVE  DS    XL64                                                             
DMWORK   DS    12D                                                              
*                                                                               
         DS    0F                                                               
COUNTS   DS    0XL32                                                            
ISPTS    DS    F                   INVOICE SPOTS                                
IDOLS    DS    F                           DOLLARS                              
BSPTS    DS    F                   BATCH SPOTS                                  
BDOLS    DS    F                         DOLLARS                                
BINVS    DS    F                         INVOICES                               
TSPTS    DS    F                   TOTAL                                        
TDOLS    DS    PL8                                                              
TINVS    DS    F                                                                
TBTCHS   DS    F                   TOTAL BATCHES                                
TBDBAT   DS    F                   TOTAL BAD BATCHES (UNKNOWN AGENCY)           
TDELINV  DS    F                   TOTAL DELETE PREVIOUS INVOICE RECS           
TMAXERRS DS    F                   TOTAL BAD ERRORS FOUND ON TAPE               
TCLTCDS  DS    F                                                                
TPRDCDS  DS    F                                                                
TESTCDS  DS    F                                                                
LBTCHS   DS    F                   LOADED BATCHES                               
LINVS    DS    F                                                                
LSPTS    DS    F                                                                
LDOLS    DS    PL8                                                              
IBYTS    DS    PL8                 INPUT BYTES REC                              
OBYTS    DS    PL8                 OUTPUT BYTES REC                             
*                                                                               
RDELIM   DS    CL1                 RECORD DELIMITER                             
FDELIM   DS    CL1                 FIELD DELIMITER                              
HOLDSIGN DS    CL1                                                              
*                                                                               
* RECORD FIELD DATA AREA - EACH FIELD BUILT HERE TO PRINT IF NEEDED *           
*                                                                               
RFVALS   DS    0D                                                               
RFDATA   DS    XL256                                                            
RFLEN    DS    XL1                                                              
RFCNTL   DS    X                   EXTERNAL SWITCHES                            
*        80 - END OF FILE                                                       
*        40 - END OF RECORD                                                     
*        20 - FIELD ERROR                                                       
*        10 - END OF FIELD                                                      
RFCNTL2  DS    X                   INTERNAL SWITCHES                            
*        04 - NEED TO READ NEXT TAPE BLOCK/RECORD                               
*        02 - END OF FILE                                                       
*        01 - END OF RECORD                                                     
RFERRMSG DS    CL20                                                             
RFVALSL  EQU   *-RFVALS                                                         
*                                                                               
RECLEN   DS    F                                                                
RECTYP   DS    CL2                                                              
*                                                                               
* WORKER RECORD POINTERS *                                                      
*                                                                               
WFVALS   DS    0D                                                               
WRECST   DS    F                   WORKER RECORD START                          
WRCURPOS DS    F                   WORKER RECORD NEXT FIELD PTR                 
WFVALSL  EQU   *-WFVALS                                                         
*                                  INVOICE FIELDS                               
INVFLDS  DS    0CL91                                                            
INVNO    DS    CL10                                                             
INVMOS   DS    CL4                                                              
INVDEL   DS    CL1                                                              
ADVNAM   DS    CL25                                                             
ADVCD    DS    CL8                                                              
PRDNAM   DS    CL25                                                             
PRDCD    DS    CL8                                                              
ESTNO    DS    CL10                                                             
*                                  SAVED DATA FIELDS                            
STAFLDS  DS    0CL8                                                             
STATION  DS    CL4                                                              
MEDIA    DS    CL2                                                              
BAND     DS    CL2                                                              
*                                                                               
AGYFLDS  DS    0CL150                                                           
AGYNAME  DS    CL30                                                             
AGYLIN1  DS    CL30                                                             
AGYLIN2  DS    CL30                                                             
AGYLIN3  DS    CL30                                                             
AGYLIN4  DS    CL30                                                             
*                                                                               
TOTFLDS  DS    0D                                                               
TOTINVS  DS    F                                                                
TOTDOLS  DS    PL8                                                              
*                                                                               
OLDSTA   DS    CL8                                                              
OLDAGY   DS    CL150                                                            
         SPACE                                                                  
* WORK AREA TO ALLOW FIELDS TO SPAN RECORDS *                                   
* EACH FIELD IS BUILT HERE                  *                                   
         SPACE                                                                  
WLEN     DS    H                                                                
WDATA    DS    CL256                                                            
         DS    CL512               BUFFER FOR SLOPPY INPUT                      
*                                                                               
EZLDWKL  EQU   *-EZLDWKD                                                        
         SPACE 3                                                                
         EJECT                                                                  
*                                                                               
       ++INCLUDE SPGENEZ                                                        
*                                                                               
         EJECT                                                                  
       ++INCLUDE DDDPRINT                                                       
         ORG   P                                                                
ILADV    DS    CL25        7                                                    
         DS    CL1                                                              
ILADVCD  DS    CL8                                                              
         DS    CL1                                                              
ILPRD    DS    CL25                                                             
         DS    CL2                                                              
ILPRDCD  DS    CL8                                                              
         DS    CL2                                                              
ILEST    DS    CL10                                                             
         DS    CL1                                                              
ILINV    DS    CL10                                                             
         DS    CL2                                                              
ILMOS    DS    CL4                                                              
         DS    CL3                                                              
ILSPTS   DS    CL5                                                              
ILDOLS   DS    CL12                                                             
         EJECT                                                                  
EZBAR    CSECT                                                                  
         DS    0D                                                               
*                                                                               
COLHDS1  DC    CL132'ADVERTISER NAME           CODE     PRODUCT NAME   C        
                           CODE      EST        INVOICE    MONTH   SPOTC        
               S    GROSS'                                                      
COLHDS2  DC    CL132'---------------           ----     ------------   C        
                           -------   ---        -------    -----   ----C        
               -    ---------'                                                  
         SPACE 3                                                                
EZBARIN  DCB   DDNAME=EZBARIN,DSORG=PS,RECFM=FB,MACRF=GM,EODAD=GETEOF           
EZOTPUT  DCB   DDNAME=EZOTPUT,DSORG=PS,RECFM=VB,MACRF=PM,EODAD=GETEOF           
*                                                                               
UTL      DS    0D                                                               
         DC    F'0'                                                             
         DC    X'0A'               CONTROL SYSTEM                               
*                                                                               
         DC    CL8'*RECWRK*'                                                    
RECWRK   DS    1024X                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVSTA*'                                                    
SAVSTA   DS    1024X                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVPAY*'                                                    
SAVPAY   DS    1024X                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVAGY*'                                                    
SAVAGY   DS    1024X                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*GENREC*'                                                    
GENREC   DS    1024X                                                            
*                                                                               
*                                                                               
         DS    0D                                                               
         DC    CL8'**EZIN**'                                                    
         DC    F'0'                                                             
EZINREC  DS    CL33000                                                          
         DC    64X'00'             MAY USE TO MARK EOR                          
         DC    CL8'**EOR***'                                                    
         SPACE                                                                  
         DS    0D                                                               
         DC    CL8'*STATAB*'                                                    
         DC    F'0'                                                             
EZSTATAB DC 100XL17'00'        STATION TABLE                                    
         DC    CL8'*ENDSTA*'    5-STA, 4 # INV, 4 #SPTS, 4 DOLS                 
         SPACE                                                                  
         DS    0D                                                               
         DC    CL8'*AGYTAB*'                                                    
         DC    F'0'                                                             
EZAGYTAB DC 100XL20'00'        AGENCY TABLE                                     
         DC    CL8'*ENDAGY*'    8-USID, 4 # INV, 4 #SPTS, 4 DOLS                
*                                                                               
* RECORD BUILT HERE (TO ALLOW SPANNED FIELDS/RECORDS FROM BLOCK TO              
*                    BLOCK)                                                     
*                                                                               
         DS    0D                                                               
         DC    CL8'**EZOT**'                                                    
EZOTREC  DS    CL1024                                                           
EZOTRECL EQU   1024                                                             
*                                                                               
         DS    0D                                                               
         DC    CL8'*REGSAV*'                                                    
REGSAVE  DS    XL30000                                                          
*                                                                               
EZBARX   DS    0D                                                               
*                                                                               
BARD     DSECT                                                                  
BARPARC  DS    CL4                                                              
BARPARN  DS    CL35                                                             
BARBRNC  DS    CL5                                                              
BARBRNN  DS    CL36                                                             
         DS    CL5                 CLASS CODE                                   
         DS    CL1                 SPARE                                        
         DS    CL24                SHOWNAME                                     
         DS    CL2                 SHOWKIND                                     
         DS    CL5                 SHOWCODE                                     
BARNET   DS    CL4                                                              
         DS    CL1                 SPARE                                        
         DS    CL4                 SUSPAR                                       
BARSHWTM DS    CL4                                                              
BARSHWMD DS    CL1                                                              
BARSHWLN DS    CL3                                                              
BARSHWDT DS    CL6                 YR MO DA                                     
BARSHWDC DS    CL1                                                              
BARSHWDY DS    CL3                                                              
BARSPTM1 DS    CL4                                                              
BARSPTM3 DS    CL4                                                              
BARSPTMC DS    CL1                                                              
BARDAYNT DS    CL1                                                              
BARDAYPT DS    CL1                                                              
BARCOMTP DS    CL3                                                              
BARSPTLN DS    CL3                                                              
BARBUCKS DS    CL7                                                              
         DS    CL32                SPARE                                        
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'003EZBAR     02/18/92'                                      
         END                                                                    
