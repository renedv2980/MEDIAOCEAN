*          DATA SET SPBYGENS   AT LEVEL 119 AS OF 05/01/02                      
*CATALP SPBYGENB                                                                
*INCLUDE PRNTBL                                                                 
*INCLUDE PRINT                                                                  
         TITLE 'SPBYGEN (LINK) --- CREATE OR UPDATE SPOT BUYS'                  
*                                                                               
**********************************************************************          
*                                                                    *          
*  SPBYGEN (LINKED ROUTINE) --- ADD OR UPDATE SPOTPAK BUYS FROM      *          
*                               DATA SUPPLIED IN THE INTERFACE BLOCK *          
*                                                                    *          
* ------------------------------------------------------------------ *          
*                                                                    *          
* PARAMS(INPUT):                                                     *          
*                                                                    *          
*  P1       =   A(SPBUYGEND BLOCK)                                   *          
*                                                                    *          
*  P2       =   IF 'NOWR' BYPASS WRITES TO THE FILE.                 *          
*                                                                    *          
*  P3       =   A(REPORT) FOR TRACE DISPLAYS                         *          
*                                                                    *          
*  P4       =   A(PRINTLINE) FOR TRACE DISPLAYS                      *          
*                                                                    *          
*  P5       =   IF 'DISP' PUT OUT TRACE DISPLAYS, ELSE SKIP THEM     *          
*                                                                    *          
**********************************************************************          
**********************************************************************          
*****  SAMPLE DISPLAY CODE:             ******************************          
*****    CLC   =C'DISP',DISPOPT         ******************************          
*****    BNE   MAIN                     ******************************          
*****    L     RF,APLINE                ******************************          
*****    MVC   0(10,RF),=C'BILL UHR  '  ******************************          
*****    GOTO1 AREPORT                  ******************************          
**********************************************************************          
**********************************************************************          
*                                                                    *          
*                                                                    *          
* PARAMS(OUTPUT):                                                    *          
*                                                                    *          
*  P1       =  RETURN VALUE                                          *          
*              00  =  ADD/UPDATE PERFORMED                           *          
*                                                                    *          
*  P2       =  IF = 'NOWR' THEN BYPASS WRITES TO THE FILE            *          
*                                                                    *          
*                                                                    *          
*  CONDITION CODE ALSO SET ON RETURN:                                *          
*    ZERO     = GOOD                                                 *          
*    NON-ZERO = ERROR CONDITION (SEE P1)                             *          
*                                                                    *          
* ------------------------------------------------------------------ *          
*                                                                    *          
* ERROR CODES                                                        *          
* -----------                                                        *          
*                                                                    *          
* ERROR CODE PLACED IN SPERROUT, SUB CODE PLACED IN SPERROUT+1       *          
*                                                                    *          
* 1  - INVALID NUMBER OF WEEKS                                       *          
* 2  - INVALID SCHED SEQ NUMBER                                      *          
* 3  - INVALID START DATE                                            *          
* 4  - SCHEDULES REQUIRED                                            *          
* 5  - NEED AT LEAST 1 VALID DEMO TYPE                               *          
* 6  - TOO MANY BUY LINES                                            *          
* 7  - INVALID RE-TRANSFER:                                          *          
*      1  - NO PRODUCT CODE                                          *          
*      2  - PRODUCT CODES DO NOT MATCH                               *          
*      3  - POOL FLAG INCORRECT                                      *          
*      4  - LAST TRANSFER DATE AND TIME DO NOT MATCH                 *          
*      5  - BUY RECORD NO LONGER ON FILE                             *          
*      6  - REQUIRED DATA MISSING FROM THE SPOT BUY RECORD           *          
*      7  - TRANSFER DATE IN CONFLICT WITH THE BUY RECORD            *          
*      8  - SPOTS ALREADY PAID                                       *          
*      9  - TABLE PROBLEM, BUY RECORD MAY NOT BE ON FILE             *          
*           (GENERATES 'NOTIFY DDS - ERROR <<9 ON REPORT)            *          
*      10 - SPOTS ALREADY PAID, RATE CHANGE INVALID                  *          
*      11 - SPOTS ALREADY PAID, LEN  CHANGE INVALID                  *          
* 8  - TOO MANY SPOTS                                                *          
* 9  - COMBO STATION                                                 *          
* 10 - MULTIPLE DAY/TIMES                                            *          
* 11 - SPOT LENGTH TOO LONG                                          *          
* 12 - ALT WEEK FLAG BAD                                             *          
* 13 - BUY CANCELLED                                                 *          
* 14 - CANCELLED BUY MISSING                                         *          
* 15 - STATION NOT IN SPOTPAK                                        *          
* 16 - MARKET NOT IN SPOTPAK                                         *          
* 17 - CLIENT CODE IS BAD                                            *          
* 18 - CLIENT NOT IN SPOTPAK                                         *          
* 19 - PRODUCT NOT IN SPOTPAK                                        *          
* 20 - ESTIMATE NOT IN SPOTPAK                                       *          
* 21 - ADV IN REPPAK NOT FOUND                                       *          
* 22 - PRD IN REPPAK NOT FOUND                                       *          
* 23 - PPERSON NOT IN REPPAK                                         *          
* 24 - CONTRACT NOT IN REP                                           *          
* 25 - PAID SPOTS:  BUY XCLED                                        *          
* 26 - STATION SKIPPED:  TEMP                                        *          
* 27 - BUY CONTAINS CREDITS                                          *          
*                                                                    *          
* ------------------------------------------------------------------ *          
*                                                                    *          
* REGISTER USAGE: (R7 THRU RD ARE USED)                              *          
*                                                                    *          
*     R7 = COVERS SPBUYDTD                                           *          
*     RA = COVERS SPBUYBLK                                           *          
*                                                                    *          
*     RC = COVERS WORKING STORE                                      *          
*                                                                    *          
*     RB,R9,R8 = BASE REGS                                           *          
*                                                                    *          
* ------------------------------------------------------------------ *          
*                                                                    *          
*  MOD LOG                                                           *          
*  -------                                                           *          
*                                                                    *          
*  SEP12/91 (WH+MRR) --- >THIS LINK ROUTINE DEVELOPED FROM CTMAD06   *          
*                                                                    *          
*  APR21/92 (BU ) --- REPLACE 'HELLO' CALLS WITH 'RECUP' TO ADD      *          
*                     BUY ELEMENTS TO SPOT-SIDE RECORD               *          
*                                                                    *          
*  MAY07/92 (BU ) --- ADD 'CANCEL' TYPE 25                           *          
*                                                                    *          
*  JUN05/92 (BU ) --- FOR SPOTS WITH NEGATIVE DOLLARS, SET BDCIND    *          
*                     MINUS SPOT BIT.                                *          
*                                                                    *          
*  JUN10/92 (BU ) --- SKIP DATE AND TIME TESTS                       *          
*                                                                    *          
*  MAR09/93 (BU ) --- ELIMINATE DSECT FOR TRACE ELEMENT.  NOW IN     *          
*                     SPGENBUY.                                      *          
*                                                                    *          
*  MAR24/93 (BU ) --- PASS IN ADDRESS OF 'REPORT' AND PRINTLINE FOR  *          
*                     ERROR/TRACE DISPLAYS.                          *          
*                     RESET FORMAT OF TRACE ELEMENT.                 *          
*                                                                    *          
*  APR08/93 (BU ) --- ERROR: EXCESS BUYLINES GEN'D WHEN NUM SPOTS    *          
*                     PER WEEK > 47 ( OR SO ).                       *          
*                                                                    *          
*  JUL29/93 (BU ) --- FIX 'NO FIND:  X'98' ELEMENT                   *          
*                                                                    *          
*  SEP16/93 (BU ) --- FIX BUYLINE TABLE SEARCH, WHICH TERMINATES     *          
*                     INCORRECTLY ON A EMPTY SLOT.                   *          
*                                                                    *          
*  SEP15/94 (BU ) --- FIX INCORRECTLY-POINTING R4 IN BFOREST RTN     *          
*                                                                    *          
*  APR12/95 (BU ) --- SEND ERROR MESSAGE FROM RECUP WHEN RECORD      *          
*                     OVERFLOWS...                                   *          
*                                                                    *          
*  MAR31/98 (BU ) --- DISPLAY OF OUTPUT RECORDS ON OPTION            *          
*                                                                    *          
*  NOV12/99 (BU ) --- REMOVE 'CLEANUP' ROUTINE (OF QUESTIONABLE      *          
*                     VALUE)                                         *          
*                                                                    *          
*  APR17/00 (BU ) --- INCREASE RECORD SIZE TO 4K FOR SPOT RECORDS    *          
*                                                                    *          
*  APR20/00 (BU ) --- INCREASE MAXBELEM TO 170 FROM 51               *          
*                                                                    *          
*  JUL24/01 (BU ) --- CLEAR BDCIND NEGATIVE SPOT COST.               *          
*                                                                    *          
*                     **  END TOMBSTONE  **                          *          
**********************************************************************          
*                                                                               
         PRINT NOGEN                                                            
SPBYGEN  CSECT                                                                  
         NMOD1 WORKDLEN,*SPBYGEN,R9,R8,RR=R2,CLEAR=YES                          
*                                                                               
         USING WORKD,RC            WORKING STORE                                
         ST    R1,PASSPARM         SAVE THE PASSED PARAM LIST ADDR              
         ST    R2,RELO                                                          
         L     RA,0(R1)            GET SPBUYGEND BLOCK ADDR                     
         USING SPBUYBLK,RA                                                      
         MVI   NOWRITE,X'00'                                                    
         CLC   4(4,R1),=C'NOWR'                                                 
         BNE   SPBY0010                                                         
         MVI   NOWRITE,X'FF'                                                    
SPBY0010 EQU   *                                                                
         MVC   AREPORT,8(R1)       LOAD A(REPORT) FROM DM3                      
         MVC   APLINE,12(R1)       LOAD A(PRINTLINE) FROM DM4                   
         MVC   DISPOPT,16(R1)      LOAD DISPLAY OPTION FROM DM5                 
*                                                                               
*   TEST BITFLAG DISPLAY                                                        
**       L     RF,APLINE                                                        
**       MVC   0(10,RF),=C'TESTSPBYGN'                                          
**       GOTO1 AREPORT                                                          
*   TEST BITFLAG DISPLAY                                                        
*                                                                               
         EJECT                                                                  
***********************************************************************         
* MAIN DRIVER - CALLS THE THREE SUBROUTINES THAT HANDLE EACH OF THE             
* THREE MODES THAT THE CONTROLLER CALLS AN OVERLAY WITH (START, MIDDLE,         
* AND END).                                                                     
***********************************************************************         
MAIN     DS    0H                                                               
         BAS   RE,INIT             INITIALIZE OVERLAY                           
*                                                                               
         L     R7,SPBUYDET                                                      
         USING SPBUYDTD,R7                                                      
*                                                                               
         BAS   RE,BLDBLTAB         BUILD THE BUYLINE TABLE                      
*                                                                               
MAIN10   EQU   *                                                                
         OC    0(256,R7),0(R7)     ANYTHING IN TABLE?                           
         BZ    MAIN100                                                          
*                                                                               
*   TEST                                                                        
         CLC   =C'BUYS',DISPOPT                                                 
         BNE   MAIN20                                                           
         L     RF,APLINE                                                        
         MVC   0(13,RF),=C'BUYLINE DATA='                                       
         GOTO1 AREPORT                                                          
         L     RF,APLINE                                                        
         MVC   0(96,RF),0(R7)                                                   
         GOTO1 AREPORT                                                          
         L     RF,APLINE                                                        
         MVC   0(96,RF),96(R7)                                                  
         GOTO1 AREPORT                                                          
         L     RF,APLINE                                                        
         MVC   0(96,RF),192(R7)                                                 
         GOTO1 AREPORT                                                          
MAIN20   EQU   *                                                                
*                                                                               
         CLI   SPMEMO,13           BUYLINE CANCELED?                            
         BE    MAIN90              YES, SKIP IT                                 
*                                                                               
         CLI   SPMEMO,25           BUYLINE CANCELED/PAID SPOTS?                 
         BE    MAIN90              YES, SKIP IT                                 
*                                                                               
         BAS   RE,STARTDAT         VALIDATE BUY/TRANSFER START DATE             
         BNZ   MAIN90                                                           
*                                                                               
         BAS   RE,BLDBRECS         BUILD THE BUY RECORDS                        
*                                                                               
MAIN90   EQU   *                                                                
         LA    R7,SPDETBKL(R7)                                                  
         B     MAIN10                                                           
*                                                                               
MAIN100  EQU   *                                                                
*                                                                               
MAINRTN  EQU   *                                                                
         ZIC   R1,ERRORRTN                                                      
         L     R2,PASSPARM                                                      
         STM   R1,15,0(R2)                                                      
         LTR   R1,R1                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE INITIALIZES VARIABLES IN THIS OVERLAY THAT NEED                  
* INITIALIZATION.                                                               
***********************************************************************         
INIT     NTR1                                                                   
*                                                                               
         MVI   ERRORRTN,0                                                       
*                                                                               
         L     RF,SPCOMFAC                                                      
         USING COMFACSD,RF                                                      
         MVC   DATAMGR,CDATAMGR                                                 
         MVC   DATCON,CDATCON                                                   
         MVC   HELLO,CHELLO                                                     
         MVC   GETDAY,CGETDAY                                                   
         MVC   ADDAY,CADDAY                                                     
         MVC   PERVERT,CPERVERT                                                 
         DROP  RF                                                               
*                                                                               
         CLC   =C'DISP',DISPOPT                                                 
         BNE   INIT0005                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(08,RF),=C'DATAMGR:'                                            
         MVC   10(04,RF),DATAMGR                                                
         GOTO1 AREPORT                                                          
INIT0005 EQU   *                                                                
*                                                                               
*                                                                               
         LA    RF,IOAREA1                                                       
         ST    RF,AIO1                                                          
         ST    RF,AIO                                                           
         L     RF,=A(IOAREA2-WORKD)                                             
         AR    RF,RC                                                            
         ST    RF,AIO2                                                          
         L     RF,=A(IOAREA3-WORKD)                                             
         AR    RF,RC                                                            
         ST    RF,AIO3                                                          
         L     RF,=A(BLNTBL-WORKD)                                              
         AR    RF,RC                                                            
         ST    RF,ABLNTBL                                                       
*                                                                               
         OC    SPPOLP#,SPPOLP#                                                  
         BZ    INIT10                                                           
         MVC   KEYPRD,SPPOLP#                                                   
         OI    BITFLAG,X'80'                                                    
         B     INIT15                                                           
INIT10   EQU   *                                                                
         MVC   KEYPRD,SPPRD#                                                    
INIT15   EQU   *                                                                
*                                                                               
         MVI   BINPBPRD,0          CLEAR PIGGYBACK CODE FIRST                   
         OC    SPPRDP#,SPPRDP#     IF NO PRODUCT SPECIFIED                      
         BZ    INIT20                                                           
         MVC   BINPBPRD,SPPRDP#    SAVE PIGGY BACK BINARY CODE                  
INIT20   EQU   *                                                                
*                                                                               
         GOTO1 VALIPOL                                                          
*                                                                               
*        INIT EXIT                                                              
*                                                                               
INITGOOD B     TESTGOOD                                                         
         EJECT                                                                  
***********************************************************************         
* VALIDATES THE BUY/TRANSFER START DATE.                                        
*                                                                               
* RETURNS:     BDAY1               START DATE'S DAY NUMBER                      
***********************************************************************         
STARTDAT NTR1                                                                   
*                                                                               
         GOTO1 DATCON,DMCB,(3,SPSTADAT),(0,WORK)                                
         GOTO1 DATCON,DMCB,(3,SPENDDAT),(0,WORK+6)                              
*                                                                               
         CLC   WORK(6),SPESTSTR    IF BUY START DATE < ESTIMATE'S START         
         BL    SDATBAD             THEN ERROR                                   
*                                                                               
         CLC   WORK(6),SPESTEND    IF BUY START DATE > ESTIMATE'S END           
         BH    SDATBAD             THEN ERROR                                   
*                                                                               
         CLC   WORK+6(6),SPESTEND  IF BUY END DATE > ESTIMATE'S END             
         BH    SDATBAD             THEN ERROR                                   
*                                                                               
*                                  CALCULATE DAY NUMBER FOR BUY START           
         GOTO1 GETDAY,DMCB,WORK,WORK+6                                          
*                                                                               
         CLI   SPESTOWK,0          IF NO OUT OF WEEK ROTATOR                    
         BNE   SDAT100                                                          
*                                                                               
**       ZIC   R2,0(R1)            CONVERT BUY START DATE TO MON. DATE          
**       BCTR  R2,0                                                             
**       LNR   R2,R2                                                            
**       GOTO1 ADDAY,DMCB,WORK,WORK+6,(R2)                                      
**       GOTO1 DATCON,DMCB,(0,WORK+6),(3,SPSTADAT)                              
**       MVI   BDAY1,1             MONDAY IS BUY START DAY                      
**       B     SDAT200                                                          
*                                                                               
SDAT100  MVC   BDAY1,0(R1)         SAVE BUY START DAY                           
*                                                                               
SDAT200  EQU   *                                                                
         ZICM  R2,SPWEEKS,1                                                     
         BNZ   SDAT250                                                          
         XC    WORK(12),WORK                                                    
         GOTO1 DATCON,DMCB,(3,SPSTADAT),(0,WORK)                                
         GOTO1 DATCON,DMCB,(3,SPENDDAT),(0,WORK+6)                              
         GOTO1 PERVERT,DMCB,WORK,WORK+6                                         
         ZICM  R2,DM4,2                                                         
         OC    DM3+2(2),DM3+2                                                   
         BZ    SDAT250                                                          
         LA    R2,1(R2)                                                         
SDAT250  EQU   *                                                                
         STC   R2,BNUMWKS                                                       
*                                                                               
SDATGOOD EQU   *                                                                
         B     TESTGOOD                                                         
SDATBAD  EQU   *                                                                
         MVI   ERRORRTN,EREQSTDT                                                
         MVI   SPERROUT,EREQSTDT                                                
         B     TESTBAD                                                          
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE BUILDS THE BUY RECORDS BASED ON THE INFORMATION FROM THE         
* SCHEDULE OBJECTS.                                                             
***********************************************************************         
BLDBRECS NTR1                                                                   
*                                                                               
         L     RE,AIO1                                                          
         L     RF,=F'4008'                                                      
         XCEFL                                                                  
         L     RE,AIO2                                                          
         L     RF,=F'4008'                                                      
         XCEFL                                                                  
         L     RE,AIO3                                                          
         L     RF,=F'4008'                                                      
         XCEFL                                                                  
*                                                                               
         BAS   RE,BLDTRACE         BUILD X'98' ELEMENT                          
         BNZ   BLDBBAD                                                          
*                                                                               
         OC    SPSPECL,SPSPECL                                                  
         BZ    BLDB10                                                           
         L     RF,SPSPECL                                                       
         ST    RF,AMODETAB                                                      
         B     BLDB20                                                           
BLDB10   EQU   *                                                                
         BAS   RE,BLDMODT                                                       
BLDB20   EQU   *                                                                
*                                                                               
*   SPBUYD IS ZERO FOR A NEW LINE AT THIS POINT.  AFTER ROUTINE                 
*     'BFOREST' THE FIELD IS SET BY THE LINE TO WHICH THIS IS                   
*      BEING APPLIED.  IT IS NO LONGER A GOOD FLAG AT THAT POINT.               
*                                                                               
         MVI   RETRANIT,C'N'       SET RETRANSFER FLAG TO 'NO'                  
         BAS   RE,DISPDET          DISPLAY OPTION OUTPUT                        
         OC    SPBUYD,SPBUYD       RETRANSFER IF NON-ZERO                       
         BZ    BLDB50                                                           
         MVI   RETRANIT,C'Y'       SET RETRANSFER FLAG TO 'YES'                 
         BAS   RE,RETRANS          THEN PREPARE FOR RETRANSFER                  
         BNZ   BLDBBAD                                                          
         B     BLDB60                                                           
*                                                                               
BLDB50   EQU   *                                                                
         BAS   RE,GETBLINE         GET THE BUY LINE                             
         BNZ   BLDBBAD                                                          
         BAS   RE,BLDDESC          BUILD A PARTIAL DESCRIPTION ELEMENT          
         BNZ   BLDBBAD                                                          
         BAS   RE,BLDDEMO          BUILD THE DEMO ELEMENT                       
         BNZ   BLDBBAD                                                          
*                                                                               
         CLI   BINPBPRD,0          IF PIGGYBACK PRODUCT REQUESTED               
         BE    BLDB60                                                           
         BAS   RE,BLDPIGS          THEN BUILD THE PIGGYBACK ELEMENT             
         BNZ   BLDBBAD                                                          
*                                                                               
BLDB60   EQU   *                                                                
         BAS   RE,BFOREST          BUILD THE BUY RECORDS                        
         BNZ   BLDBBAD                                                          
*                                                                               
         CLI   RETRANIT,C'N'       RETRANSFER DONE?                             
         BE    BLDB70              NO                                           
***      BAS   RE,CLEANUP          YES - CLEANUP WHAT'S LEFT                    
***      BNZ   BLDBBAD                                                          
*                                                                               
BLDB70   EQU   *                                                                
         LA    RF,TRCEELEM                                                      
         USING BTRXELEM,RF                                                      
         MVC   SPXFERD,BTRXDATE                                                 
         MVC   SPXFERT,BTRXTIME                                                 
         DROP  RF                                                               
*                                                                               
BLDBGOOD EQU   *                                                                
         B     TESTGOOD            RETURN 'YES' TO CALLER                       
BLDBBAD  EQU   *                                                                
         B     TESTBAD             RETURN 'NO' TO CALLER                        
*                                                                               
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE BUILDS THE BUYLINE TABLE BY GOING THROUGH ALL THE                
* BUYLINES FOR A GIVEN MASTER KEY.                                              
*                                                                               
* FORMAT OF BUYLINE TABLE                                                       
* -----------------------                                                       
* BYTE 0  - 2 BYTES - SCHEDULE SEQUENCE NUMNBER                                 
* BYTE 2  - 3 BYTES - TRANSACTION DATE                                          
* BYTE 5  - 4 BYTES - TRANSACTION TIME                                          
* BYTE 9  - 1 BYTE  - MASTER PRODUCT CODE                                       
* BYTE 10 - 1 BYTE  - PIGGYBACK PRODUCT CODE                                    
* BYTE 11 - 1 BYTE  - LINE NUMBER                                               
***********************************************************************         
*                                                                               
BLDBLTAB NTR1                                                                   
*                                                                               
         XC    ALSTNTRY,ALSTNTRY   SET TABLE ADDR TO 'EMPTY'                    
         LA    R4,KEY              BUILD KEY FOR THE MASTER KEY                 
         USING BUYHDRD,R4                                                       
         XC    KEY,KEY                                                          
         MVC   BUYKAM,SPAM                                                      
         MVC   BUYKCLT,SPCLT                                                    
         MVC   BUYKPRD,KEYPRD                                                   
         MVC   BUYMSTA,SPMSTA                                                   
         MVC   BUYKEST,SPEST                                                    
*                                                                               
         MVC   PARTKEY,KEY         MAKE A COPY OF KEY - DETAILS                 
*                                                                               
         GOTO1 HIGH                GET 1ST KEY THAT MATCHES MASTER KEY          
*                                                                               
BBLLOOP  CLC   PARTKEY,KEY         IF SAME MASTER KEY                           
         BNE   BBLGOOD                                                          
*                                                                               
         ZIC   R2,BUYKEST+2        R2 = A(BUYLINE ENTRY)                        
         BCTR  R2,0                                                             
         MH    R2,=Y(BLNENTRY)                                                  
         A     R2,ABLNTBL                                                       
         LR    RF,R2               SET NEXT ENTRY TO                            
*                                     'END OF TABLE'                            
         LA    RF,BLNENTRY(RF)                                                  
         ST    RF,ALSTNTRY         SAVE A(END OF TABLE)                         
*                                                                               
         GOTO1 GREC                GET THE RECORD                               
*                                                                               
         MVC   BLTLNUM(1,R2),BUYKBUY+1   BUYLINE NUMBER                         
         CLI   KEYPRD,X'FF'              IF PRODUCT IN KEY IS NOT POL           
         BE    BBL10                                                            
         MVC   BLTMPRD(1,R2),KEYPRD      THEN COPY THE PRODUCT CODE             
         B     BBL20                                                            
*                                                                               
BBL10    EQU   *                   ELSE GET IT FROM DESCRIPTION ELEM            
         GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'01',AIO),(0,0),(0,0)                
         CLI   DM4,0                                                            
         BE    *+6                                                              
         DC    H'0'                DIE IF NO DESCRIPTION ELEMENT                
         L     R6,DM4                                                           
         USING BDELEM,R6                                                        
         MVC   BLTMPRD(1,R2),BDMASPRD                                           
         DROP  R6                                                               
*                                                                               
BBL20    EQU   *                   GET PIGGYBACK CODE IF ANY                    
         GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'04',AIO),(0,0),(0,0)                
         CLI   DM4,0                                                            
         BNE   BBL30                                                            
         L     R6,DM4                                                           
         USING PBELEM,R6                                                        
         MVC   BLTPPRD(1,R2),PBPROD                                             
         DROP  R6                                                               
*                                                                               
BBL30    EQU   *                   GET TRACE ELEMENT (X'98')                    
         GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'98',AIO),(0,0),(0,0)                
         CLI   DM4,0                                                            
         BNE   BBLNEXT                                                          
         L     R6,DM4                                                           
         USING BTRXELEM,R6                                                      
         MVC   BLTSCHED(2,R2),BTRXSEQN    EXTRACT SCHEDULE SEQUENCE #           
         MVC   BLTTRAND(3,R2),BTRXDATE    ORIGINAL TRANSFER DATE                
         MVC   BLTTRANT(4,R2),BTRXTIME    ORIGINAL TRANSFER TIME                
         DROP  R6                                                               
*                                                                               
BBLNEXT  GOTO1 SEQ                                                              
         B     BBLLOOP                                                          
*                                                                               
BBLGOOD  DS    0H                  RETURN TO CALLER                             
         CLC   =C'DUMP',DISPOPT    DUMP TEST?                                   
         BNE   TESTGOOD            NO  -                                        
         CLC   =C'WRC',SPSTA       YES - STATION FOR DUMP?                      
         BNE   TESTGOOD            NO  -                                        
         DC    H'0'                YES  - DUMP IT OUT...                        
         B     TESTGOOD                                                         
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE PREPARES FOR THE RETRANSFER OF BUYS.                             
***********************************************************************         
RETRANS  NTR1                                                                   
         MVC   AIO,AIO2            CURRENT I/O AREA IS I/O AREA 2               
*                                                                               
*                                  SAVE RETRANSFER START DT BIN & COMPR         
         MVI   SPOTPAID,C'N'       SET 'NO PAID SPOTS'                          
         MVC   TRNSTRTB,SPSTADAT                                                
         GOTO1 DATCON,DMCB,(3,SPSTADAT),(2,TRNSTRTC)                            
*                                                                               
         L     R4,ABLNTBL          R4 = A(BUYLINE TABLE)                        
         ZIC   R5,SPBUYD+1         R5 = BUY LINE NUMBER TO BUMP THROUGH         
*                                                                               
RETR10   EQU   *                                                                
         OC    SPBUYD+1(1),SPBUYD+1    BUY LINE NUMBER HERE?                    
         BZ    RETR20                  NO, CAN'T RETRANSFER W/O LINE #          
         CLC   SPBUYD+1(1),BLTLNUM(R4) NOW FIND THE TABLE ENTRY THAT            
         BE    RETR100                 MATCHES THIS LINE#                       
RETR15   EQU   *                                                                
         LA    R4,BLNENTRY(R4)         BUMP TO NEXT                             
         L     RF,ALSTNTRY             CHECK FOR END OF TABLE                   
         CR    R4,RF                                                            
         BNL   RETR20                  END OF TABLE REACHED                     
         OC    0(BLNENTRY,R4),0(R4)    ENTRY IN SLOT?                           
         BNZ   RETR10                  YES - CHECK IT                           
         B     RETR15              NO  - BUMP TO NEXT SLOT                      
RETR20   EQU   *                                                                
         LA    RF,TREQBTAB                                                      
         B     RTBAD                                                            
*                                                                               
RETR100  EQU   *                                                                
         CLI   9(R4),0             IF THERE IS NO PRODUCT FOR BUYLINE           
         BNE   RETR110             THEN WE MUST GET OUT                         
         LA    RF,TREQNPC                                                       
         B     RTBAD                                                            
*                                                                               
RETR110  EQU   *                                                                
         CLI   NOWRITE,0           NO WRITE MODE MAY BE RE-RUN, DATE            
         BNE   RETR130              AND TIME WILL NOT MATCH                     
*                                                                               
         CLC   SPXFERD(3),=X'FFFFFF'                                            
         BE    RETR130              SPECIAL SKIP DATE AND TIME FLAG             
*                                                                               
         B     RETR130              SKIP DATE AND TIME TESTS: B UHR             
*                                                                               
         CLC   SPXFERD,BLTTRAND(R4) AND ORIGINAL TRANSFER DATE MATCHES          
         BE    RETR120                                                          
         LA    RF,TREQXFER                                                      
         B     RTBAD                                                            
*                                                                               
RETR120  EQU   *                                                                
         CLC   SPXFERT,BLTTRANT(R4) AND ORIGINAL TRANSFER TIME MATCHES          
         BE    RETR130                                                          
         LA    RF,TREQXFER                                                      
         B     RTBAD                                                            
*                                                                               
RETR130  EQU   *                                                                
         CLC   SPPRD#,BLTMPRD(R4)   AND PRODUCT CODE MATCHES                    
         BE    RETR140                                                          
         LA    RF,TREQBPC                                                       
         B     RTBAD                                                            
*                                                                               
RETR140  EQU   *                                                                
         CLI   POLFLAG,X'FF'                                                    
         BE    RETR150                                                          
         CLC   BINPBPRD,BLTPPRD(R4)                                             
         BE    RETR150                                                          
         LA    RF,TREQBPOL                                                      
         B     RTBAD                                                            
RETR150  EQU   *                                                                
*                                                                               
         STC   R5,NEWLINE          THEN SAVE THE BUYLINE WE FOUND               
*                                                                               
         BAS   RE,BLDBKEY          LOOK AT THE BUY RECORD                       
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BE    RETR160                                                          
         LA    RF,TREQNBUY                                                      
         B     RTBAD                                                            
RETR160  EQU   *                                                                
         BAS   RE,DISPRET          DISPLAY OPTION OUTPUT                        
         GOTO1 GREC                READ RECORD                                  
*                                                                               
         GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'01',AIO),(0,0),(0,0)                
         CLI   DM4,0                                                            
         BE    RETR170                                                          
         LA    RF,TREQBREC                                                      
         B     RTBAD                                                            
RETR170  EQU   *                                                                
******>  CLI   NOWRITE,0           NO WRITE MODE MAY BE RE-RUN,                 
******>  BNE   RETR500              ...ELEMENTS MAY ALREADY BE GONE             
*                                                                               
*        CHECK BUY ELEMENTS AGAINST LIST                                        
*                                                                               
RETR200  EQU   *                   GET FIRST SPOT                               
         GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'0B',AIO),(0,0),(0,0)                
         CLI   DM4,0                                                            
         BNE   RETR500             NO SPOT ELEMENTS TO PROCESS                  
         L     R6,DM4                                                           
         USING REGELEM,R6                                                       
         L     R5,AMODETAB                                                      
RETR220  EQU   *                                                                
         OC    RPAY,RPAY                                                        
         BZ    RETR270             NOT PAID - PROCESS                           
****>>   BNZ   RETR250             PAID - SET ERROR ACCORDINGLY                 
****>>   OC    RPBILL,RPBILL                                                    
****>>   BZ    RETR270                                                          
RETR250  EQU   *                                                                
         MVI   SPOTPAID,C'Y'       SET 'PAID SPOT(S) IN LINE'                   
         CLC   RDATE,0(R5)                                                      
         BH    RETR260        ERROR/PAID-BILLED SPOT MISSING FROM LIST          
         BL    RETR280        NO ERROR/ADDED SPOT-GET NEXT ELEMENT              
         ZICM  RF,2(R5),1     GET NUMBER OF SPOTS REMAINING                     
         BZ    RETR260        ERROR/PAID-BILLED SPOT MISSING                    
         BCTR  RF,0           SUBTRACT ONE FROM NUMBER OF SPOTS                 
         STC   RF,2(R5)                                                         
         LTR   RF,RF                                                            
         BNZ   RETR280           LOOP/GET NEXT SPOT                             
         MVC   0(2,R5),=X'FEFE'  ELSE MARK THIS ENTRY USED UP                   
         LA    R5,3(R5)          AND GO TO NEXT TABLE ENTRY                     
         B     RETR280           GET NEXT SPOT                                  
RETR260  EQU   *                                                                
         LA    RF,TREQBPAY                                                      
         B     RTBAD                                                            
RETR270  EQU   *                                                                
*                                                                               
*   'RIDSPOT' WILL DELETE AN X'0B' ELEMENT AND ALL ITS POSITIONALLY             
*     RELATED X'10'-X'1F' ELEMENTS.  IF THE DELETED ELEMENTS ARE                
*     FOLLOWED BY ANOTHER X'0B' ELEMENT, THIS WILL BE IN THE LOCATION           
*     OF THE ORIGINAL ELEMENT WHICH WAS DELETED.  MUST TEST TO                  
*     ENSURE THAT A 'NEXTSPOT' CALL DOESN'T SKIP THAT X'0B'.                    
*                                                                               
         GOTO1 RIDSPOT,DMCB,(R6) GET RID OF THIS SPOT, ET AL                    
         L     RF,FULL             IS NEXT SPOT ALSO AN X'0B'?                  
         LTR   RF,RF                                                            
         BNZ   RETR220             YES - DON'T 'NEXTSPOT'                       
RETR280  EQU   *                                                                
         BAS   RE,NEXTSPOT                                                      
         BE    RETR220                                                          
         B     RETR500           NO MORE SPOTS, MOVE ON                         
*                                                                               
         DROP  R6                                                               
*                                                                               
*        UPDATE GENERAL DATA                                                    
*                                                                               
RETR500  EQU   *                   UPDATE DATA IN DESCRIPTION ELEM              
         GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'01',AIO),(0,0),(0,0)                
         CLI   DM4,0                                                            
         BE    RETR520                                                          
         LA    RF,TREQBREC                                                      
         B     RTBAD                                                            
RETR520  EQU   *                                                                
         L     R6,DM4                                                           
         USING BDELEM,R6                                                        
*                                                                               
*                                                                               
*   CHECK RATE AND LENGTH IN DESCRIPTIVE ELEMENT VS. NEW VALUES:                
*     IF PAID SPOTS EXIST IN LINE, REJECT CHANGE                                
*                                                                               
         CLI   SPOTPAID,C'N'       NO PAID SPOTS?                               
         BE    RETR525             YES - NO PAID SPOTS                          
         CLC   BDSEC,SPLEN         SPOT LENGTH CHANGE?                          
         BE    RETR522             NO                                           
         LA    RF,TREQSLEN         YES - DON'T PERMIT TRANSFER                  
         B     RTBAD                                                            
RETR522  EQU   *                                                                
         CLC   BDCOST,SPCOST       SPOT RATE   CHANGE?                          
         BE    RETR525             NO                                           
         LA    RF,TREQCOST         YES - DON'T PERMIT TRANSFER                  
         B     RTBAD                                                            
RETR525  EQU   *                                                                
         MVC   BDSTART,SPSTADAT                                                 
         MVC   BDEND,SPENDDAT                                                   
*                                  SET START+END DAY IF NEEDED                  
         GOTO1 DATCON,DMCB,(3,BDSTART),(0,WORK)                                 
         XC    DMCB(8),DMCB                                                     
         GOTO1 GETDAY,DMCB,WORK,WORK+6                                          
         CLI   DMCB,1                     MONDAY?                               
         BE    RETR530                    YES, NOTHING ELSE TO DO               
         MVC   WORK+10(1),DMCB            GET START DAY NUMBER                  
         GOTO1 DATCON,DMCB,(3,BDEND),(0,WORK)                                   
         XC    DMCB(8),DMCB                                                     
         GOTO1 GETDAY,DMCB,WORK,WORK+6                                          
         MVC   WORK+11(1),DMCB                                                  
         CLC   WORK+10(1),WORK+11                                               
         BNH   RETR530                                                          
         ZIC   RF,WORK+10                                                       
         SLL   RF,4                                                             
         STC   RF,BDSEDAY                                                       
         OC    BDSEDAY(1),WORK+11                                               
RETR530  EQU   *                                                                
*                                                                               
         MVC   BDWKIND,SPALT                                                    
         MVC   BDDAY,SPDAY                                                      
         MVC   BDWKS,BNUMWKS                                                    
         MVC   BDSEC,SPLEN                                                      
         MVC   BDCOST,SPCOST                                                    
         NI    BDCIND,X'FF'-X'01'  CLEAR LOW ORDER BIT                          
*                                                                               
*   TEST                                                                        
****     CLC   =X'182F68',SPCOST                                                
****     BNE   *+6                                                              
****     DC    H'0'                                                             
*   TEST END                                                                    
*                                                                               
         TM    SPCOST,X'80'        IS COST NEGATIVE?                            
         BNO   RETR532             NO                                           
         OI    BDCIND,X'01'        YES - SET 'MINUS SPOT' INDICATOR             
         ZICM  RF,SPCOST,3         SWAP/RELOAD COST AS POSITIVE VALUE           
         SLL   RF,8                SHIFT VALUE TO HIGH ORDER                    
         SRA   RF,8                SHIFT BACK TO PROPAGATE SIGN                 
         LPR   RF,RF               LOAD THE POSITIVE VALUE                      
         STCM  RF,7,BDCOST         SAVE LAST THREE BYTES                        
RETR532  EQU   *                                                                
         MVC   BDNTAX,SPTAX                                                     
         MVC   BDREP,SPESTREP           LOAD ESTIMATE REP                       
         TM    SPFLAGS,X'80'            TRADE BUY?                              
         BNO   RETR534                  NO  - LEAVE ESTIMATE REP                
         OC    SPSPECRP,SPSPECRP        YES - SPECIAL TRADE REP FOUND?          
         BZ    RETR534                  NO  - LEAVE ESTIMATE REP                
         MVC   BDREP,SPSPECRP           YES - LOAD TRADE REP                    
RETR534  EQU   *                                                                
         MVC   BDTIMST(L'BDTIMST+L'BDTIMEND),SPSTATIM                           
         MVC   BDPROGRM,SPDESC                                                  
         OC    BDPROGRM,BDPROGRM                                                
         BNZ   RETR540                                                          
         MVC   BDPROGRM,SPACES                                                  
RETR540  EQU   *                                                                
         GOTO1 DATCON,DMCB,(5,0),(3,BDCHG)                                      
         MVI   BDWHY,0                                                          
         MVI   BDWHY2,0                                                         
         MVI   BDWHY3,X'80'                  SCHED CHANGE                       
         MVC   BDDAYPT,SPDAYPT                                                  
         DROP  R6                                                               
*                                                                               
RETR600  EQU   *                   UPDATE INFORMATION IN TRACE ELEMENT          
         GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'98',AIO),(0,0),(0,0)                
         CLI   DM4,0               ELEMENT FOUND?                               
         BNE   RETR650             NO  - SKIP TRACE ELEMENT UPDATE              
         L     R6,DM4                                                           
         USING BTRXELEM,R6                                                      
         LA    R2,TRCEELEM                                                      
         MVC   BTRXDATE(L'BTRXDATE+L'BTRXTIME),(BTRXDATE-BTRXELEM)(R2)          
         DROP  R6                                                               
*                                                                               
RETR650  EQU   *                   UPDATE INFORMATION IN TRACE ELEMENT          
         BAS   RE,WRITBREC         WRITE BACK BUY RECORD                        
         L     RE,AIO2                                                          
         L     RF,AIO1                                                          
         L     R1,=F'4008'                                                      
         MOVE  ((RF),(R1)),(RE)                                                 
*                                                                               
         ST    R4,AENTRY           SAVE INFO TO CNF OBJ & BUYLINE TABLE         
         BAS   RE,CHGBTBL                                                       
*                                                                               
         B     RTGOOD              ALL DONE WITH THIS BUYLINE                   
*                                                                               
RTBAD    EQU   *                                                                
         MVC   AIO,AIO1            RESTORE CURRENT I/O AREA TO AREA 1           
         MVI   ERRORRTN,EREQRETR                                                
         MVI   SPERROUT,EREQRETR                                                
         STC   RF,SPERROUT+1                                                    
         B     TESTBAD                                                          
*                                                                               
RTGOOD   EQU   *                                                                
         MVC   AIO,AIO1            RESTORE CURRENT I/O AREA TO AREA 1           
         B     TESTGOOD            RETURN TO CALLER                             
         SPACE 2                                                                
RTMOVE   MVC   0(0,R2),0(R3)                                                    
         EJECT                                                                  
*                                                                               
*        NEXTSPOT --- GET NEXT SPOT ELEMENT                                     
*                                                                               
NEXTSPOT DS    0H                                                               
*                                                                               
         ZIC   RF,1(R6)                                                         
         AR    R6,RF                                                            
         CLI   0(R6),X'0B'          BUY ELEMENT?                                
         BE    NSPTEX               YUP, TELL THE CALLER                        
         CLI   0(R6),0              END OF RECORD?                              
         BE    NSPTE100             YUP, GET OUT WITH NOT-EQUAL                 
         CLI   0(R6),X'1F'          IF EL CODE <= X'1F', MIGHT BE A             
         BNH   NEXTSPOT              X'0B' EL LATER IN THE REC                  
NSPTE100 EQU   *                                                                
         LTR   RE,RE                SET NOT-EQ CON. CODE                        
NSPTEX   EQU   *                                                                
         BR    (RE)                                                             
         EJECT                                                                  
*                                                                               
*        RIDSPOT --- REMOVE THIS SPOT FROM THE RECORD WITH ALL                  
*                     ASSOCIATED ELEMENTS                                       
*                                                                               
*        P1      =   A(SPOT ELEMENT)                                            
*                                                                               
*                                                                               
RIDSPOT  NTR1                                                                   
*                                                                               
         L     R2,0(R1)             GET PASSED ADDR                             
         XC    FULL,FULL            SET 'NEXT=X'0B'' TO NO                      
         CLI   0(R2),X'0B'          SPOT EL?                                    
         BNE   RSPTBAD                                                          
*                                                                               
RSPT100  EQU   *                                                                
         GOTO1 =V(RECUP),DMCB,(C'S',AIO),(R2),0,0,RR=RELO                       
         CLI   0(R2),0              END OF RECORD?                              
         BE    RSPTGOOD             YES - ALL DONE                              
         CLI   0(R2),X'0B'          NEXT SPOT?                                  
         BE    RSPTX0B              YES - ALL DONE                              
         CLI   0(R2),X'1F'          ELS WITH CODE <= X'1F', NEED TO             
         BNH   RSPT100               BE REMOVED, ELSE GET OUT                   
*                                                                               
RSPTGOOD EQU   *                                                                
         B     TESTGOOD                                                         
RSPTBAD  EQU   *                                                                
         B     TESTBAD                                                          
RSPTX0B  EQU   *                                                                
         ST    R2,FULL             SET 'NEXT=X'0B'' TO YES                      
         B     TESTGOOD                                                         
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE GETS THE BUY LINE FROM THE BUYLINE TABLE.                        
*                                                                               
* FORMAT OF BUYLINE TABLE                                                       
* -----------------------                                                       
* BYTE 0  - 2 BYTES - SCHEDULE SEQUENCE NUMBER                                  
* BYTE 2  - 3 BYTES - TRANSACTION DATE                                          
* BYTE 5  - 4 BYTES - TRANSACTION TIME                                          
* BYTE 9  - 1 BYTES - MASTER PRODUCT CODE                                       
* BYTE 10 - 1 BYTES - PIGGYBACK PRODUCT CODE                                    
*                                                                               
* RETURNS:     AENTRY              A(ENTRY IN BUYLINE TABLE)                    
*              NEWLINE             NEXT BUY LINE AVAILABLE                      
***********************************************************************         
GETBLINE NTR1                                                                   
         L     R2,ABLNTBL          R2 = A(BUYLINE TABLE)                        
         LA    R4,255              R4 = MAXIMUM NUMBER OF BUYLINES              
         LA    R3,1                R3 = CURRENT BUYLINE NUMBER                  
*                                                                               
         CLI   RETRANIT,C'N'       RETRANSFER?                                  
         BE    GTBLP               NO                                           
*                                                                               
GTBLPR   CLI   9(R2),0             IF THERE IS NO PRODUCT FOR BUYLINE           
         BE    GTBNXT              THEN CHECK NEXT BUYLINE                      
*                                                                               
*****    BAS   RE,DISPCOMP                                                      
*                                                                               
         CLC   SPSCHLN,0(R2)       IF SCHEDULE #'S MATCH                        
         BNE   GTBNXT                                                           
*                                                                               
         CLC   SPXFERD,2(R2)       AND ORIGINAL TRANSFER DATE MATCHES           
         BNE   GTBNXT                                                           
*                                                                               
         CLC   SPXFERT,5(R2)       AND ORIGINAL TRANSFER TIME MATCHES           
         BNE   GTBNXT                                                           
*                                                                               
         B     GTB20               THEN SAVE THE BUYLINE WE FOUND               
*                                                                               
GTBNXT   LA    R2,BLNENTRY(R2)     CHECK NEXT BUYLINE ENTRY                     
         LA    R3,1(R3)                                                         
         BCT   R4,GTBLPR           LOOP IF MORE BUYLINES TO CHECK               
*                                                                               
         L     R2,ABLNTBL          R2 = A(BUYLINE TABLE)                        
         LA    R4,255              R4 = MAXIMUM NUMBER OF BUYLINES              
         LA    R3,1                R3 = CURRENT BUYLINE NUMBER                  
*                                                                               
GTBLP    CLI   9(R2),0             IF THERE IS A PRODUCT IN BUYLINE             
         BE    GTB20                                                            
         LA    R2,BLNENTRY(R2)     THEN CHECK NEXT BUYLINE ENTRY                
         LA    R3,1(R3)                                                         
         BCT   R4,GTBLP            LOOP UNTIL WE GET ONE THAT DOESN'T           
         MVI   ERRORRTN,EREQFULL                                                
         MVI   SPERROUT,EREQFULL                                                
         B     GTBBAD              ELSE ERROR                                   
*                                                                               
GTB20    STC   R3,NEWLINE          SAVE BUYLINE TO USE                          
         ST    R2,AENTRY           SAVE A(BUYLINE ENTRY)                        
         BAS   RE,DISPGET          DISPLAY OPTION OUTPUT                        
*                                                                               
GTBX     EQU   *                                                                
         B     TESTGOOD                                                         
GTBBAD   EQU   *                                                                
         B     TESTBAD                                                          
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE BUILDS A PARTIAL DESCRIPTION ELEMENT FOR THE BUY RECORD.         
* THE THING THAT IS MISSING IS THE NUMBER OF SPOTS PER WEEK (MODE).             
***********************************************************************         
BLDDESC  NTR1                                                                   
         LA    R6,DESCELEM         BUILD THE DESCRIPTION ELEMENT USING          
         USING BDELEM,R6               ONE WEEK & # OF WKS METHOD               
         XC    DESCELEM,DESCELEM                                                
         MVI   BDCODE,X'01'                                                     
         MVI   BDLEN,X'46'                                                      
*                                                                               
*                                  STORE DATA INTO DESCRIPTION ELEMENT          
         MVC   BDSTART,SPSTADAT                                                 
         MVC   BDEND,SPENDDAT                                                   
*                                  SET START+END DAY IF NEEDED                  
         GOTO1 DATCON,DMCB,(3,BDSTART),(0,WORK)                                 
         XC    DMCB(8),DMCB                                                     
         GOTO1 GETDAY,DMCB,WORK,WORK+6                                          
         CLI   DMCB,1                     MONDAY?                               
         BE    BDES10                     YES, NOTHING ELSE TO DO               
         MVC   WORK+10(1),DMCB            GET START DAY NUMBER                  
         GOTO1 DATCON,DMCB,(3,BDEND),(0,WORK)                                   
         XC    DMCB(8),DMCB                                                     
         GOTO1 GETDAY,DMCB,WORK,WORK+6                                          
         MVC   WORK+11(1),DMCB                                                  
         CLC   WORK+10(1),WORK+11                                               
         BNH   BDES10                                                           
         ZIC   RF,WORK+10                                                       
         SLL   RF,4                                                             
         STC   RF,BDSEDAY                                                       
         OC    BDSEDAY(1),WORK+11                                               
BDES10   EQU   *                                                                
         MVI   BDINPUT,2                                                        
         MVC   BDWKIND,SPALT                                                    
         MVC   BDDAY,SPDAY                                                      
         MVC   BDWKS,BNUMWKS                                                    
         MVC   BDSEC,SPLEN                                                      
         MVC   BDCOST,SPCOST                                                    
*                                                                               
         NI    BDCIND,X'FF'-X'01'  CLEAR LOW ORDER BIT                          
         TM    SPCOST,X'80'        IS COST NEGATIVE?                            
         BNO   BDES12              NO                                           
         OI    BDCIND,X'01'        YES - SET 'MINUS SPOT' INDICATOR             
         ZICM  RF,SPCOST,3         SWAP/RELOAD COST AS POSITIVE VALUE           
         SLL   RF,8                SHIFT VALUE TO HIGH ORDER                    
         SRA   RF,8                SHIFT BACK TO PROPAGATE SIGN                 
         LPR   RF,RF               LOAD THE POSITIVE VALUE                      
         STCM  RF,7,BDCOST         SAVE LAST THREE BYTES                        
BDES12   EQU   *                                                                
         MVC   BDNTAX,SPTAX                                                     
         MVC   BDREP,SPESTREP           LOAD ESTIMATE REP                       
         TM    SPFLAGS,X'80'            TRADE BUY?                              
         BNO   BDES13                   NO  - LEAVE ESTIMATE REP                
         OC    SPSPECRP,SPSPECRP        YES - SPECIAL TRADE REP FOUND?          
         BZ    BDES13                   NO  - LEAVE ESTIMATE REP                
         MVC   BDREP,SPSPECRP           YES - LOAD TRADE REP                    
BDES13   EQU   *                                                                
         MVC   BDTIMST(L'BDTIMST+L'BDTIMEND),SPSTATIM                           
         MVC   BDPROGRM,SPDESC                                                  
         OC    BDPROGRM,BDPROGRM                                                
         BNZ   BDES15                                                           
         MVC   BDPROGRM,SPACES                                                  
BDES15   EQU   *                                                                
*                                                                               
         OI    BDCIND,X'20'        PLAIN SPOTS = CASH SPOTS?                    
*                                                                               
         MVI   BDWHY,X'80'         NEW BUY CREATED TODAY                        
         XC    DMCB(24),DMCB                                                    
         GOTO1 DATCON,DMCB,(5,0),(3,BDCHG)                                      
         OI    BDSTAT,X'08'        SO MEL KNOWS IT'S $MAD RADIO BUY             
*                                                                               
         CLI   KEYPRD,X'FF'        IF POOL AND NOT UNALLOCATED                  
         BNE   BDES20                                                           
         CLI   SPPRDCDS+1,X'FF'                                                 
         BE    BDES20                                                           
*                                  THEN SET POOL MASTER PRODUCT CODE            
         MVC   BDMASPRD(1),SPPRDCDS+1                                           
*                                                                               
BDES20   EQU   *                                                                
         MVC   BDDAYPT,SPDAYPT                                                  
*                                                                               
         L     RF,SPACPROF                                                      
         CLI   0(RF),C'0'          IF 0(CLIENT PROFILE) <> C'0'                 
         BE    BDESGOOD                                                         
         L     RF,SPAAPROF                                                      
         CLI   11(RF),C'Y'         AND IF 11(AGENCY PROFILE) = C'Y'             
         BNE   BDESGOOD                                                         
*                                                                               
         OI    BDSTAT,X'80'        THEN SET FLAGS TO USE HIGH ORDER 5           
         OI    BITFLAG,X'40'           5 BITS IN RPCOST FOR # OF SPOTS          
*                                                                               
BDESGOOD EQU   *                                                                
         B     TESTGOOD            RETURN TO CALLER                             
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE BUILDS THE DEMOGRAPHICS ELEMENT FOR THE BUY RECORD.              
***********************************************************************         
BLDDEMO  NTR1                                                                   
         LA    R6,DEMOELEM         BUILD 'ORIGINAL' DEMO ELEMENT                
         USING NDELEM,R6                                                        
         XC    DEMOELEM,DEMOELEM                                                
         MVI   NDCODE,X'02'                                                     
*                                                                               
         MVI   NUMDCATS,0                                                       
         SR    RF,RF                                                            
         LA    RE,SPESTDEM                                                      
BLDD10   EQU   *                                                                
         OC    0(3,RE),0(RE)                                                    
         BZ    BLDD20                                                           
         LA    RE,3(RE)                                                         
         LA    RF,1(RF)                                                         
         STC   RF,NUMDCATS                                                      
         B     BLDD10                                                           
BLDD20   EQU   *                                                                
*                                                                               
         ZIC   R1,NUMDCATS         STORE LENGTH OF OUR DEMO ELEMENT             
         SLL   R1,3                                                             
         LA    R1,NDEMNO-NDELEM(R1)                                             
         STC   R1,NDLEN                                                         
*                                                                               
         MVC   NDBOOK,SPESTBK      RATING BOOK                                  
*                                                                               
         ZICM  R4,NUMDCATS,1       # DEMO CATEGORIES                            
         BZ    BDMGOOD             IF ZERO, NOTHING MORE TO DO                  
*                                                                               
         LA    R2,SPESTDEM         A(1ST OF 20 3-BYTE DEMOGRAPHIC)              
         LA    R3,NDEMNO           A(WHERE TO PUT DEMOS)                        
*                                                                               
BLDD50   EQU   *                                                                
         MVC   0(3,R3),0(R2)                                                    
         LA    R2,3(R2)                                                         
         LA    R3,8(R3)                                                         
         BCT   R4,BLDD50                                                        
*                                                                               
BDMGOOD  DS    0H                  RETURN 'YES' TO CALLER                       
         B     TESTGOOD                                                         
BDMBAD   DS    0H                  RETURN 'NO' TO CALLER                        
         MVI   ERRORRTN,EREQDTYP                                                
         MVI   SPERROUT,EREQDTYP                                                
         B     TESTBAD                                                          
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE BUILDS THE PIGGYBACK ELEMENT IF NEEDED.                          
***********************************************************************         
BLDPIGS  NTR1                                                                   
         LA    R6,PIGELEM          THEN BUILD PIGGBACK ELEMENT                  
         USING PBELEM,R6                                                        
         MVI   PBCODE,X'04'                                                     
         MVI   PBLEN,L'PIGELEM                                                  
         MVC   PBPROD,BINPBPRD                                                  
         MVC   PBEST,SPEST                                                      
         MVC   PBTIME,SPLEN                                                     
         ZIC   R0,SPLEN                                                         
         ZIC   R1,SPMSLEN                                                       
         SR    R0,R1                                                            
         STC   R0,PBCOST                                                        
         MVC   PBPRD,SPPRDP                                                     
*                                                                               
BLDPGX   B     TESTGOOD                                                         
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
*   THIS ROUTINE BUILDS THE BUY RECORDS BASED ON THE NUMBER OF WEEKS            
***********************************************************************         
BFOREST  NTR1                                                                   
*                                                                               
*                                                                               
*   TEST BITFLAG DISPLAY                                                        
***      L     RF,APLINE                                                        
***      MVC   0(10,RF),=C'BITFLAG=  '                                          
***      MVC   8(1,RF),BITFLAG                                                  
***      GOTO1 AREPORT                                                          
*   TEST BITFLAG DISPLAY                                                        
*                                                                               
         MVI   CURBELS,0                                                        
         L     R6,AMODETAB                                                      
*                                                                               
BFOR50   EQU   *                                                                
         OC    0(3,R6),0(R6)       WHILE LAST WEEK NOT COMPLETED                
         BZ    BFORGOOD                                                         
*                                                                               
         CLC   0(3,R6),=X'FEFEFE'  ENTRY REMOVED BY RETRANSFER?                 
         BE    BFOR200             YES, SKIP IT                                 
*                                                                               
         CLI   RETRANIT,C'Y'       RETRANSFER?                                  
         BE    BFOR60              YES                                          
         BAS   RE,BLDBKEY          BUILD BUY KEY                                
         BAS   RE,MOVKIO2          MOVE BUY KEY TO IO2                          
BFOR60   EQU   *                                                                
*                                                                               
BFOR70   OC    0(3,R6),0(R6)       WHILE LAST WEEK NOT COMPLETED                
         BZ    BFOR250                                                          
*                                                                               
         CLC   0(3,R6),=X'FEFE00'  NULL ENTRY PLACED BY RETRANSFER              
         BE    BFOR200             IF SO, SKIP THIS ENTRY                       
*                                                                               
         MVC   CURBDATE(2),0(R6)                                                
         MVC   CURBSPTS(1),2(R6)                                                
         MVC   MODESPW,2(R6)       MODE SPOTS PER WEEK                          
         ZIC   R3,2(R6)                                                         
*                                                                               
         LTR   R3,R3               IF THERE ARE NO SPOTS                        
         BZ    BFOR200             THEN GO TO THE NEXT WEEK                     
*                                                                               
         ZIC   RF,CURBELS                                                       
         LA    RF,1(RF)                                                         
         STC   RF,CURBELS                                                       
         CLI   CURBELS,MAXBELEM                                                 
         BH    BFOR250                                                          
         TM    BITFLAG,X'80'       IF POOL                                      
         BZ    BFOR190                                                          
*                                                                               
         TM    BITFLAG,X'40'       IF HIGH ORDER 5 BITS USED                    
         BZ    BFOR160                                                          
*                                                                               
BFOR110  DS    0H                  -- POOL BUY W/ HIGH ORDER 5 BITS --          
****>>>  CLI   0(R4),MAX5BITS      THEN IF IT CAN'T FIT IN ONE ELEM             
         CLI   SPSPWEEK,MAX5BITS   THEN IF IT CAN'T FIT IN ONE ELEM             
         BNH   BFOR120                                                          
*                                                                               
*                                  ELSE ADD THE ELEMENT WITH MAXIMUM #          
*                                                                               
         GOTO1 DISPBUYS,DMCB,0                                                  
*                                                                               
         GOTO1 ADDBUYS,DMCB,MAX5BITS                                            
*                                                                               
         S     R3,=A(MAX5BITS)     STORE # OF SPOTS NOT ADDED FOR LATER         
****>>>  STC   R3,0(R4)                                                         
         STC   R3,SPSPWEEK                                                      
*                                                                               
         B     BFOR70              LOOP BACK TO ADD THOSE NOT ADDED             
*                                                                               
BFOR120 EQU    *                                                                
*                                  ELSE ADD THE ELEMENT WITH # OF BUYS          
*                                                                               
         GOTO1 DISPBUYS,DMCB,1                                                  
*                                                                               
         GOTO1 ADDBUYS,DMCB,(R3)                                                
*                                                                               
         B     BFOR200             GO TO THE NEXT WEEK                          
*                                                                               
BFOR160 EQU    *                   -- REGULAR POOL BUY --                       
*                                                                               
****>>>  CLI   0(R4),MAXBELEM      IF # OF SPOTS > MAX(# OF BUY ELEMS)          
         CLI   SPSPWEEK,MAXBELEM   IF # OF SPOTS > MAX(# OF BUY ELEMS)          
         BNH   BFOR170                                                          
*                                                                               
         CLI   CURBELS,1               AND IF NEW BUY LINE                      
         BNE   BFOR170                                                          
*                                  THEN ADD THE MAX(# OF BUY ELEMENTS)          
*                                                                               
         GOTO1 DISPBUYS,DMCB,2                                                  
*                                                                               
         GOTO1 ADDBUYS,DMCB,MAXBELEM                                            
*                                                                               
         S     R3,=A(MAXBELEM)     STORE # OF SPOTS NOT ADDED FOR LATER         
****>>>  STC   R3,0(R4)                                                         
         STC   R3,SPSPWEEK                                                      
*                                                                               
         B     BFOR250             WRITE THE BUYLINE OUT                        
*                                                                               
BFOR170 EQU    *                   R2 = # OF SPOTS IN THIS BUYLINE              
         ZIC   R2,CURBELS                                                       
         AR    R2,R3               R2 = # OF SPOTS IN THIS BUYLINE              
*                                                                               
         C     R2,=A(MAXBELEM)     IF # OF SPOTS GOES OVER                      
         BH    BFOR250             THEN WRITE THE BUYLINE OUT                   
*                                                                               
*                                                                               
         GOTO1 DISPBUYS,DMCB,3                                                  
*                                                                               
         GOTO1 ADDBUYS,DMCB,(R3)   ELSE ADD SPOTS TO THIS BUYLINE               
*                                                                               
         B     BFOR200             GO TO THE NEXT WEEK                          
*                                                                               
BFOR190 DS     0H                  -- NON-POOL BUY --                           
*                                                                               
*                                  ELSE ADD THE ELEMENT WITH # OF BUYS          
*                                                                               
         GOTO1 DISPBUYS,DMCB,4                                                  
*                                                                               
         GOTO1 ADDBUYS,DMCB,(R3)                                                
*                                                                               
BFOR200  EQU   *                                                                
         LA    R6,3(R6)                                                         
         B     BFOR70              LOOP BACK                                    
*                                                                               
BFOR250  EQU   *                                                                
         LA    R5,DESCELEM         R5 = A(DESCRIPTION ELEMENT)                  
         USING BDELEM,R5                                                        
*                                                                               
         BAS   RE,CALCBDYE         CALCULATE BUY END DAY                        
*                                                                               
         ZIC   R2,MOREDAYS         CALCULATE BUY END DATE                       
*                                                                               
         MVC   BDNOWK,MODESPW      STORE MODE SPOTS PER WEEK                    
         DROP  R5                                                               
*                                                                               
         MVC   AIO,AIO2                                                         
*                                                                               
         CLI   RETRANIT,C'Y'       RETRANSFER?                                  
         BE    BFOR330             YES                                          
*                                                                               
BFOR300  EQU   *                   NO  - ADD ADDITIONAL ELEMENTS                
*                                  ADD DESCRIPTION ELEMENT                      
         GOTO1 HELLO,DMCB,(C'P',SPTFILE),AIO,DESCELEM,ADDCODE                   
*                                  ADD DEMO ELEMENT                             
         GOTO1 HELLO,DMCB,(C'P',SPTFILE),AIO,DEMOELEM,ADDCODE                   
*                                  ADD PIGGYBACK IF NEEDED                      
*****>   TM    BITFLAG,X'80'                                                    
*****>   BZ    BFOR310                                                          
*****>   GOTO1 HELLO,DMCB,(C'P',SPTFILE),AIO,PIGELEM,ADDCODE                    
*                                  ADD TRACE ELEMENT                            
BFOR310  EQU   *                                                                
         GOTO1 HELLO,DMCB,(C'P',SPTFILE),AIO,TRCEELEM,ADDCODE                   
         MVI   SPBUYD,C'*'                                                      
         MVC   SPBUYD+1(1),NEWLINE                                              
BFOR330  EQU   *                                                                
         OC    SPIDDATA,SPIDDATA                                                
         BZ    BFOR335                                                          
*                                                                               
*   TEST                                                                        
***      L     RF,APLINE           A(PRINT LINE)                                
***      MVC   0(08,RF),=C'DOIDEL :'                                            
***      MVC   10(32,RF),SPIDDATA                                               
***      GOTO1 AREPORT                                                          
*   TEST END                                                                    
*                                                                               
         BAS   RE,DOIDEL                                                        
BFOR335  EQU   *                                                                
         BAS   RE,CHGBTBL          ADD BUYLINE TO CONFIRMATION                  
*                                                                               
         BAS   RE,DISPFOR          DISPLAY OPTION OUTPUT                        
         BAS   RE,COMMENTS         INSERT COMMENTS, IF NECESSARY                
         BAS   RE,WRITBREC         WRITE OUT THE BUY RECORD                     
         BAS   RE,GETBLINE         GET NEXT AVAILABLE BUYLINE                   
         BNZ   BFORBAD                                                          
         MVI   CURBELS,0                                                        
*                                                                               
         B     BFOR50              LOOP BACK                                    
*                                                                               
BFORGOOD EQU   *                                                                
         MVC   AIO,AIO1            DEFAULT IS I/O AREA 1                        
         B     TESTGOOD            RETURN TO CALLER                             
BFORBAD  EQU   *                                                                
         MVC   AIO,AIO1            DEFAULT IS I/O AREA 1                        
         B     TESTBAD                                                          
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE BUILDS THE SPOTS/DATE TABLE                                      
***********************************************************************         
BLDMODT  NTR1                                                                   
*                                                                               
         LA    R2,MODETAB                                                       
         ST    R2,AMODETAB                                                      
*                                                                               
         XC    MODETAB,MODETAB                                                  
*                                                                               
         MVI   NUMWEEKS,0                                                       
         MVC   THISDATE,SPSTADAT   SET BUY START DATE FOR WEEK                  
*                                                                               
BMODT10  EQU   *                                                                
         GOTO1 DATCON,DMCB,(0,THISDATE),(2,0(R2))                               
         MVC   2(1,R2),SPSPWEEK                                                 
*                                                                               
         LA    R2,3(R2)                                                         
         GOTO1 ADDAY,DMCB,THISDATE,THISDATE,7                                   
*                                                                               
         ZIC   R1,NUMWEEKS                                                      
         LA    R1,1(R1)                                                         
         STC   R1,NUMWEEKS                                                      
         CLC   NUMWEEKS,BNUMWKS                                                 
         BH    BMODT10                                                          
*                                                                               
         B     TESTGOOD                                                         
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE BUILDS THE BUY KEY.                                              
***********************************************************************         
BLDBKEY  NTR1                                                                   
         LA    R6,KEY              BUILD BUY KEY                                
         USING BUYKEY,R6                                                        
         XC    KEY,KEY                                                          
         MVC   BUYKAM,SPAM                                                      
         MVC   BUYKCLT,SPCLT                                                    
         MVC   BUYKPRD,KEYPRD                                                   
         MVC   BUYMSTA,SPMSTA                                                   
         MVC   BUYKEST,SPEST                                                    
*                                                                               
         MVC   BUYKBUY+1(L'NEWLINE),NEWLINE                                     
         MVI   BUYKBUY+2,X'01'                                                  
*                                                                               
BBKX     B     TESTGOOD            RETURN TO CALLER                             
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* MOVE BUY KEY TO IO2                                                           
***********************************************************************         
MOVKIO2  NTR1                                                                   
         L     RE,AIO2             CLEAR IO2                                    
         LA    RF,LIOS                                                          
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
*                                                                               
         L     R6,AIO2             MOVE KEY TO IO2                              
         USING BUYREC,R6                                                        
         MVC   BUYKEY(10),KEY                                                   
*                                  SHIFT OVER BUYLINE                           
         MVC   BUYKEY+10(2),KEY+11                                              
         MVI   BUYKEY+12,0                                                      
         LA    R0,BDELEM-BUYREC    STORE DISPLACEMENT TO 1ST ELEMENT            
         STCM  R0,3,BUYRLEN                                                     
*                                                                               
*   TEST DISPLAY                                                                
         CLC   BUYRLEN,=X'0FA0'    4K RECORD CHECK                              
         BL    TEST0020                                                         
         L     RF,APLINE                                                        
         MVC   0(13,RF),=C'LINE TOO LONG'                                       
         MVC   20(60,RF),KEY                                                    
         GOTO1 AREPORT                                                          
TEST0020 EQU   *                                                                
*   TEST DISPLAY END                                                            
         MVC   BUYALPHA,SPAGY      INSERT AGENCY CODE                           
         B     TESTGOOD                                                         
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE ADDS BUY ELEMENTS TO THE BUY RECORD.                             
***********************************************************************         
ADDBUYS  NTR1                                                                   
         LA    R6,BUYELEM          R6 = A(BUY ELEMENT)                          
         USING REGELEM,R6                                                       
*                                                                               
         L     R2,0(R1)            R2 = # OF SPOTS TO BUY                       
         LA    RF,1                TEST FOR AT LEAST 1 SPOT                     
         CR    R2,RF                                                            
         BL    ADBY0040            # OF SPOTS .LT. 1                            
*                                                                               
         BAS   RE,BLDBUYE          BUILD THE BUY ELEMENT                        
*                                                                               
         MVC   AIO,AIO2                                                         
*                                                                               
*                                                                               
*  LOCATE THE APPROPRIATE X'0B' OR X'0C' ELEMENT WHICH THE NEW                  
*    BUY ELEMENT IS TO --PRECEDE--!!                                            
*                                                                               
         L     R5,AIO              A(RECORD)                                    
         LA    R5,24(R5)           A(1ST ELEMENT IN RECORD)                     
ADBY0004 EQU   *                                                                
         CLI   0(R5),0             END OF RECORD?                               
         BE    ADBY0016            YES - INSERT HERE                            
         CLI   0(R5),X'0B'         POOL ORIGINAL ELEMENT?                       
         BE    ADBY0012            YES - CHECK THE DATE                         
         CLI   0(R5),X'0C'         POOL OTO ELEMENT?                            
         BE    ADBY0012            YES - CHECK THE DATE                         
         BL    ADBY0008            < X'0B': BUMP TO NEXT ELEMENT                
         CLI   0(R5),X'1F'         > X'0C': X'10'-X'1F'?                        
         BH    ADBY0016            NO  - >: MUST BE X'20' OR >: INSERT          
ADBY0008 EQU   *                                                                
         ZIC   RF,1(R5)            BUMP TO NEXT ELEMENT                         
         AR    R5,RF                                                            
         B     ADBY0004            GO BACK FOR NEXT                             
ADBY0012 EQU   *                                                                
         CLC   RDATE,2(R5)         NEW BUY VS RECORD ELEMENT BUY                
         BH    ADBY0008            NEW BUY AFTER RECORD ELEMENT BUY             
ADBY0016 EQU   *                                                                
         TM    BITFLAG,X'C0'       IF POOL                                      
         BZ    ADBY0032                                                         
*                                                                               
         CLI   SPPRD#,X'FF'        UNALLOCATED POOL                             
         BE    ADBY0020                                                         
         MVC   RPPRD,SPPRD#        THEN PUT IN THE BRAND PRODUCT CODE           
         MVC   RPTIME,SPLEN            AND SPOT LENGTH                          
*                                                                               
ADBY0020 EQU   *                                                                
         TM    BITFLAG,X'80'       IF PLAIN POOL (NOT POL-NPW)                  
         BZ    ADBY0028                                                         
*                                  THEN ADD (R2) NUMBER OF BUY ELEMENTS         
ADBY0024 EQU   *                                                                
         PRINT GEN                                                              
         GOTO1 =V(RECUP),DMCB,(C'S',AIO),BUYELEM,(C'R',(R5)),0,RR=RELO          
         PRINT NOGEN                                                            
         CLI   DMCB+8,C'R'         RECORD OVERFLOW OCCURRED?                    
         BNE   ADBY0026            YES                                          
         BCT   R2,ADBY0024                                                      
         B     ADBY0040            DONE ADDING BUYS                             
ADBY0026 EQU   *                                                                
         MVI   ERRORRTN,EREQOFLW   OVERFLOW - SET ERROR MESSAGE                 
         MVI   SPERROUT,EREQOFLW                                                
         MVC   AIO,AIO1            DEFAULT IS I/O AREA 1                        
         B     TESTBAD                                                          
*                                                                               
ADBY0028 LR    R1,R2               STORE NUMBER OF SPOTS IN HIGH ORDER          
         SLL   R1,3                    5 BITS AND ADD THE BUY ELEMENT           
         STC   R1,RPCOST                                                        
         B     ADBY0036                                                         
*                                                                               
ADBY0032 STC   R2,RNUM             STORE NUMBER OF SPOTS                        
*                                                                               
*                                  ADD THE BUY ELEMENT                          
ADBY0036 EQU   *                                                                
         GOTO1 =V(RECUP),DMCB,(C'S',AIO),BUYELEM,(R5),0,RR=RELO                 
*                                                                               
ADBY0040 MVC   AIO,AIO1            DEFAULT IS I/O AREA 1                        
         B     TESTGOOD            RETURN TO CALLER                             
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE BUILDS THE  ORIGINAL  BUY ELEMENT (X'06' OR X'0B').              
***********************************************************************         
BLDBUYE  NTR1                                                                   
         LA    R6,BUYELEM          SET UP BUY ELEMENT WITH                      
         USING REGELEM,R6              BUY DATE                                 
         XC    BUYELEM,BUYELEM                                                  
         MVI   RCODE,X'06'                                                      
         MVI   RLEN,X'0A'                                                       
*                                                                               
         TM    BITFLAG,X'80'       IF POOL PRODUCT                              
         BZ    BBY10                                                            
*                                                                               
         MVI   RCODE,X'0B'         THEN SET UP BUY ELEMENT AS POOL              
         CLI   SPPRD#,X'FF'        POOL?                                        
         BE    BBY10               YES, THEN SHORT EL                           
         MVI   RLEN,X'0E'                                                       
         MVC   RPPRD,SPPRD#                                                     
         MVC   RPTIME,SPLEN                                                     
*                                  CONVERT BUY START DATE TO COMPRESSED         
BBY10    MVC   RDATE(2),CURBDATE                                                
*                                                                               
BBYX     B     TESTGOOD            RETURN TO CALLER                             
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE CALCULATES THE BUY END DAY AND HOW MANY MORE DAYS FROM           
* BUY START DAY.                                                                
*                                                                               
* RETURNS:     MOREDAYS            NUMBER OF DAYS BUY END DAY IS FROM           
*                                      BUY START DAY                            
*              BDAYX               BUY END DATE'S DAY NUMBER                    
***********************************************************************         
CALCBDYE NTR1                                                                   
         ZICM  R1,SPDAY,(8)        HOB(R1) = 0 + DAYS BITWISE                   
*                                                                               
         CLI   BDAY1,1             IF BUY START NOT ON A MONDAY                 
         BE    CBD10                                                            
*                                                                               
         SLDL  R0,9                THEN MAKE ANOTHER WEEK                       
         STC   R0,BDAYX                >> R0 = DAYS BITWISE + 0 <<              
*                                                                               
         ZICM  R1,SPDAY,(8)        HO2B(R1) = 0 +(2 WEEKS DAYS BITWISE)         
         ICM   R1,4,BDAYX                                                       
*                                                                               
CBD10    ZIC   R3,BDAY1            HOB(R1) = FULL WEEK WITH HIGH ORDER          
CBD15    SLDL  R0,1                BIT BEING START DAY                          
         BCT   R3,CBD15                                                         
*                                                                               
CBD20    SR    R0,R0               IF DAY BIT IS SET                            
         SLDL  R0,1                                                             
         LTR   R0,R0                                                            
         BZ    *+8                                                              
         STC   R3,MOREDAYS         THEN STORE # OF DAYS FROM START DAY          
*                                                                               
         LA    R3,1(R3)            BUMP NUMBER OF DAYS FROM START DAY           
*                                                                               
         CH    R3,=H'7'            IF NOT FINISHED WITH A WEEK                  
         BL    CBD20               THEN LOOP BACK TO CHECK NEXT DAY BIT         
*                                                                               
         ZIC   R0,BDAY1            ELSE CALCULATE BUY END DAY                   
         ZIC   R1,MOREDAYS                                                      
         AR    R0,R1                                                            
         CH    R0,=H'7'                                                         
         BNH   *+8                                                              
         SH    R0,=H'7'                                                         
         STC   R0,BDAYX            STORE BUY END DAY                            
*                                                                               
CBDX     B     TESTGOOD            RETURN TO CALLER                             
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE WRITES THE BUY RECORD TO THE FILE.                               
***********************************************************************         
WRITBREC NTR1                                                                   
         OI    DMINBTS,X'08'       READ DELETED RECORDS                         
         GOTO1 HIGH                                                             
*                                  IF RECORD ISN'T ALREADY THERE                
         CLC   KEY(L'BUYKEY),KEYSAVE                                            
         BE    WBR10                                                            
*                                                                               
         CLI   SPMED,C'T'          LOOK UP DEMOS ONLY FOR TV ADD'S              
         BNE   WBR05                                                            
*                                                                               
         XC    DMCB,DMCB                                                        
         MVC   DM1,SPSPONCR                                                     
         MVC   DM2,=F'3'                                                        
         L     RF,SPAADBUY                                                      
         L     R5,0(RF)                                                         
         MVC   0(4,RF),AIO2                                                     
         L     RF,SPMEDGB                                                       
         GOTO1 (RF),DMCB                                                        
         L     RF,SPAADBUY                                                      
         ST    R5,0(RF)                                                         
         L     R4,SPMEDBUF                                                      
         USING MEDBLOCK,R4                                                      
         L     R6,MEDADEMO                                                      
         DROP  R4                                                               
         L     R6,4(R6)                                                         
         LTR   R6,R6                                                            
         BZ    WBR05                      NO DEMOS                              
         MVI   0(R6),2                                                          
         XC    DMCB,DMCB                                                        
         GOTO1 HELLO,DMCB,(C'D',SPTFILE),(X'02',AIO2)                           
         GOTO1 HELLO,DMCB,(C'P',SPTFILE),AIO2,(R6),ADDCODE                      
WBR05    EQU   *                                                                
*                                                                               
*                                                                               
         L     R4,AIO2             A(RECORD)                                    
         CLC   13(2,R4),=X'0FA0'   MAX 4000 BYTES                               
         BL    TEST0040                                                         
         CLC   =C'BUYS',DISPOPT    DISPLAY BUY OUTPUT?                          
**       BNE   WBRX                NO  - SKIP RECORD                            
         L     RE,APLINE           YES - DISPLAY AND SKIP                       
         MVC   0(11,RE),=C'BUY TO SKIP'                                         
         GOTO1 AREPORT                                                          
         ZICM  RF,13(R4),2         SET L(RECORD)                                
         GOTO1 =V(PRNTBL),DMCB,(0,(R4)),(R4),C'DUMP',(RF),=C'1D',RR=Y           
         B     WBRX                SKIP THIS RECORD                             
*                                                                               
TEST0040 EQU   *                                                                
         MVC   AIO,AIO2            THEN ADD IT                                  
         GOTO1 AREC                                                             
         B     WBRX                                                             
*                                                                               
WBR10    MVC   AIO,AIO3                                                         
         TM    KEY+L'BUYKEY,X'80'  IF DELETED                                   
         BZ    WBR20                                                            
*                                  THEN UNDELETE IT AND WRITE RECORD            
         NI    KEY+L'BUYKEY,X'FF'-X'80'                                         
         GOTO1 WRITE                                                            
*                                                                               
WBR20    GOTO1 GREC                READ OLD RECORD                              
*                                                                               
         MVC   AIO,AIO2            WRITE OUR RECORD IN ITS PLACE                
         GOTO1 PREC                                                             
*                                  DON'T READ DELETED RECORDS                   
WBRX     EQU   *                                                                
         CLC   =C'BUYS',DISPOPT    DISPLAY BUY OUTPUT?                          
         BNE   WBRX0020            NO                                           
*                                                                               
***>>>                                                                          
         L     R4,AIO              A(RECORD)                                    
         ZICM  RF,13(R4),2         SET L(RECORD)                                
         GOTO1 =V(PRNTBL),DMCB,(0,(R4)),(R4),C'DUMP',(RF),=C'1D',RR=Y           
***>>>                                                                          
*                                                                               
**       L     RF,AIO              YES - SET A(RECORD ADDRESS)                  
***      L     RE,APLINE                                                        
***      MVC   0(08,RE),=C'BUY OUT='                                            
***      MVC   10(70,RE),0(RF)     MOVE DATA TO PRINTLINE                       
**       GOTO1 AREPORT                                                          
WBRX0020 EQU   *                                                                
         NI    DMINBTS,X'FF'-X'08'                                              
         B     TESTGOOD            RETURN TO CALLER                             
         EJECT                                                                  
*                                                                               
*   COMMENTS:  IF BUY COMMENTS PRESENT, THEY ARE INSERTED INTO                  
*        THE BUY RECORD BEING BUILT.                                            
*   R7 -->  BUY BEING ADDED                                                     
*                                                                               
COMMENTS NTR1                                                                   
*                                                                               
*   TEST                                                                        
***>>>                                                                          
*        L     RF,APLINE           A(PRINT LINE)                                
*        MVC   0(08,RF),=C'PRE-DEL:'                                            
*        GOTO1 AREPORT                                                          
*        L     R4,AIO              A(RECORD)                                    
*        ZICM  RF,13(R4),2         SET L(RECORD)                                
*        GOTO1 =V(PRNTBL),DMCB,(0,(R4)),(R4),C'DUMP',(RF),=C'1D',RR=Y           
***>>>                                                                          
*   TEST END                                                                    
*                                                                               
         XC    DMCB,DMCB                                                        
         GOTO1 HELLO,DMCB,(C'D',SPTFILE),(X'66',AIO)                            
*                                  DELETE ANY EXISTING COMMENT ELTS             
*                                     WILL BE REPLACED IF PRESENT               
*                                                                               
*   TEST                                                                        
***>>>                                                                          
*        L     RF,APLINE           A(PRINT LINE)                                
*        MVC   0(08,RF),=C'PST-DEL:'                                            
*        GOTO1 AREPORT                                                          
*        L     R4,AIO              A(RECORD)                                    
*        ZICM  RF,13(R4),2         SET L(RECORD)                                
*        GOTO1 =V(PRNTBL),DMCB,(0,(R4)),(R4),C'DUMP',(RF),=C'1D',RR=Y           
***>>>                                                                          
*   TEST END                                                                    
*                                                                               
         OC    SPBYCOM1,SPBYCOM1   ANY COMMENTS?                                
         BZ    COMM0200            NO  - DON'T OUTPUT ANY                       
         LA    RF,60               YES - DETERMINE LENGTH OF COMMENT1           
         LA    RE,SPBYCOM1+59     SET A(LAST CHARACTER)                         
COMM0020 EQU   *                                                                
         CLI   0(RE),0             CHARACTER = NULL?                            
         BNE   COMM0040            NO  - LAST CHAR FOUND                        
         BCTR  RE,0                YES - BACK UP 1 CHARACTER                    
         BCTR  RF,0                DECREMENT COUNT                              
         LTR   RF,RF               ANYTHING LEFT?                               
         BNZ   COMM0020            YES - GO BACK FOR NEXT                       
         DC    H'0'                SHOULDN'T HAPPEN                             
COMM0040 EQU   *                                                                
         XC    SPCOMELT,SPCOMELT   CLEAR THE ELEMENT BUILD AREA                 
         MVI   SPCOMELT,X'66'      INSERT COMMENT ID                            
         LA    RF,3(RF)            ADD 3 FOR CONTROL                            
         STC   RF,SPCOMELT+1       INSERT LENGTH INTO ELEMENT                   
         MVI   SPCOMELT+2,1        INSERT COMMENT NUMBER # 1                    
         SH    RF,=H'3'            SUBTRACT 3 FOR MOVE BY LENGTH                
         LA    RE,SPBYCOM1         RESET A(COMMENT TO MOVE)                     
         EX    RF,COMM0800         MOVE BY LENGTH                               
         GOTO1 HELLO,DMCB,(C'P',SPTFILE),AIO,SPCOMELT,ADDCODE                   
*                                                                               
         OC    SPBYCOM2,SPBYCOM2   ANY SECOND COMMENT?                          
         BZ    COMM0200            NO  - DON'T OUTPUT ANY                       
         LA    RF,60               YES - DETERMINE LENGTH OF COMMENT1           
         LA    RE,SPBYCOM1+59     SET A(LAST CHARACTER)                         
COMM0060 EQU   *                                                                
         CLI   0(RE),0             CHARACTER = NULL?                            
         BNE   COMM0080            NO  - LAST CHAR FOUND                        
         BCTR  RE,0                YES - BACK UP 1 CHARACTER                    
         BCTR  RF,0                DECREMENT COUNT                              
         LTR   RF,RF               ANYTHING LEFT?                               
         BNZ   COMM0060            YES - GO BACK FOR NEXT                       
         DC    H'0'                SHOULDN'T HAPPEN                             
COMM0080 EQU   *                                                                
         XC    SPCOMELT,SPCOMELT   CLEAR THE ELEMENT BUILD AREA                 
         MVI   SPCOMELT,X'66'      INSERT COMMENT ID                            
         LA    RF,3(RF)            ADD 3 FOR CONTROL                            
         STC   RF,SPCOMELT+1       INSERT LENGTH INTO ELEMENT                   
         MVI   SPCOMELT+2,2        INSERT COMMENT NUMBER # 2                    
         SH    RF,=H'3'            SUBTRACT 3 FOR MOVE BY LENGTH                
         LA    RE,SPBYCOM2         RESET A(COMMENT TO MOVE)                     
         EX    RF,COMM0800         MOVE BY LENGTH                               
         GOTO1 HELLO,DMCB,(C'P',SPTFILE),AIO,SPCOMELT,ADDCODE                   
*                                                                               
*                                                                               
COMM0200 EQU   *                                                                
         XIT1                                                                   
COMM0800 EQU   *                                                                
         MVC   SPCOMELT+3(0),0(RE)                                              
         EJECT                                                                  
***********************************************************************         
* THIS ROUTINE ALTERS THE BUYLINE TABLE ENTRY POINTED BY AENTRY.                
***********************************************************************         
CHGBTBL  NTR1                                                                   
         L     R2,AENTRY           SAVE BUYLINE TABLE INFORMATION               
         LTR   R2,R2                                                            
         BZ    CHGBX                                                            
         LA    R3,TRCEELEM                                                      
         USING BTRXELEM,R3                                                      
         MVC   00(L'BTRXSEQN,R2),BTRXSEQN                                       
         MVC   02(L'BTRXDATE,R2),BTRXDATE                                       
         MVC   05(L'BTRXTIME,R2),BTRXTIME                                       
         MVC   09(L'SPPRD#,R2),SPPRD#                                           
         MVC   10(L'BINPBPRD,R2),BINPBPRD                                       
*                                                                               
CHGBX    B     TESTGOOD            RETURN TO CALLER                             
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* CLEAN OUT BUY LINES THAT WERE ON THE FILE BUT NO LONGER SHOULD BE             
***********************************************************************         
CLEANUP  NTR1                                                                   
*                                                                               
         BAS   RE,DISPCLEN         DISPLAY OPTION OUTPUT                        
CLUPLP   BAS   RE,GETBLINE         GET THE LEFTOVERS                            
         BNZ   CLBAD                                                            
*                                                                               
         L     R2,AENTRY           IF PRODUCT IN ENTRY                          
         CLI   9(R2),0                                                          
         BE    CLX                                                              
*                                                                               
         BAS   RE,BLDBKEY          BUILD BUY KEY                                
         GOTO1 HIGH                                                             
*                                                                               
CL10     EQU   *                                                                
         BAS   RE,DISPDELE         DISPLAY OPTION OUTPUT                        
         OI    KEY+13,X'80'        WRITE IT BACK AS DELETED KEY                 
         GOTO1 WRITE                                                            
*                                                                               
         GOTO1 GREC                GET RECORD                                   
*                                                                               
         L     R6,AIO              WRITE RECORD BACK AS DELETED RECORD          
         OI    15(R6),X'80'                                                     
         GOTO1 PREC                                                             
*                                  CLEAR BUYLINE TABLE ENTRY                    
         XC    0(BLNENTRY,R2),0(R2)                                             
         B     CLUPLP              LOOP UNTIL NO MORE                           
*                                                                               
CLX      EQU   *                                                                
         B     TESTGOOD            RETURN TO CALLER                             
CLBAD    EQU   *                                                                
         B     TESTBAD                                                          
         EJECT                                                                  
*                                                                               
*        BLDTRACE --- BUILD THE BUY TRACE ELEMENT                               
*                                                                               
BLDTRACE NTR1                                                                   
*                                                                               
         XC    TRCEELEM,TRCEELEM                                                
         LA    R6,TRCEELEM                                                      
         USING BTRXELEM,R6                                                      
         MVI   BTRXCODE,BTRXCODQ                                                
         MVC   BTRXSEQN(2),SPSCHLN                                              
BLDT10   EQU   *                                                                
         TIME  DEC                                                              
         STCM  R1,15,WORK                                                       
         OC    WORK(3),WORK                                                     
         BZ    BLDT10                                                           
         STCM  R0,15,BTRXTIME                                                   
         GOTO1 DATCON,DMCB,(6,WORK),(3,BTRXDATE)                                
         ZIC   R2,SPTRACEL                    GET TRACE DATA LEN                
         LR    R3,R2                                                            
         L     R4,SPTRACED                                                      
         BCTR  R3,0                                                             
         EX    R3,BLDTEX                                                        
         LA    R2,BTRXTRAC-BTRXELEM(R2)                                         
         STC   R2,BTRXLEN                                                       
*                                                                               
         B     TESTGOOD                                                         
         SPACE 2                                                                
BLDTEX   MVC   BTRXTRAC(0),0(R4)                                                
         SPACE 2                                                                
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*        DOIDEL --- BUILD AND ADD A BUY ID ELEMENT                              
*                                                                               
DOIDEL   NTR1                                                                   
*                                                                               
         XC    SPIDELEM,SPIDELEM                                                
         LA    R6,SPIDELEM                                                      
         MVI   0(R6),X'70'                                                      
         MVI   1(R6),X'0F'                                                      
         MVC   3(12,R6),SPIDDATA                                                
         OC    3(12,R6),=12C' '                                                 
         OC    SPIDSUP,SPIDSUP                                                  
         BZ    DOID10                                                           
         MVC   15(6,R6),SPIDSUP                                                 
         OC    15(6,R6),=12C' '                                                 
         MVI   1(R6),X'15'                   SET TO LONGER LENGTH               
DOID10   EQU   *                                                                
*                                                                               
         GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'70',AIO),(0,0),(0,0)                
         CLI   DM4,0                                                            
         BNE   DOID0100            NO ID ELEMENT IN RECORD                      
*                                                                               
*   TEST                                                                        
**       L     R6,DM4                                                           
**       L     RF,APLINE           A(PRINT LINE)                                
**       MVC   0(09,RF),=C'ID FOUND:'                                           
**       MVC   12(32,RF),0(R6)                                                  
**       GOTO1 AREPORT                                                          
*   TEST END                                                                    
*                                                                               
         GOTO1 HELLO,DMCB,(C'D',SPTFILE),(X'70',AIO)                            
*                                  DROP EXISTING ID ELEMENT                     
DOID0100 EQU   *                                                                
         GOTO1 HELLO,DMCB,(C'P',SPTFILE),AIO,SPIDELEM,ADDCODE                   
*                                                                               
*                                                                               
*   TEST                                                                        
**       GOTO1 HELLO,DMCB,(C'G',SPTFILE),(X'70',AIO),(0,0),(0,0)                
**       CLI   DM4,0                                                            
**       BE    *+6                 ID ELEMENT IN RECORD                         
**       DC    H'0'                                                             
**       L     R6,DM4                                                           
**       L     RF,APLINE           A(PRINT LINE)                                
**       MVC   0(09,RF),=C'NEW ID  :'                                           
**       MVC   12(32,RF),0(R6)                                                  
**       GOTO1 AREPORT                                                          
*   TEST END                                                                    
*                                                                               
*                                                                               
         B     TESTGOOD                                                         
         EJECT                                                                  
***********************************************************************         
*                                                                               
* CHECK FOR A POOL ESTIMATE                                                     
*                                                                               
* LOADS:       ESTDYMNU            DAYPART MENU NUMBER                          
*              ESTSTRT             PERIOD START DATE (YYMMDD)                   
*              ESTEND              PERIOD END DATE (YYMMDD)                     
*              ESTBOOK             RATING BOOK FOR YEAR/MONTH                   
*              ESTOWKSD            OUT OF WEEK START DAY IN HOB                 
*              ESTREPCD            SPECIAL REP CODE                             
*              ESTDEMOS            ESTIMATE'S DEMO CATEGORIES                   
***********************************************************************         
VALIPOL  NTR1                                                                   
*                                                                               
         MVC   POLFLAG,SPPRD#                                                   
*                                                                               
*                                                                               
         CLC   =C'DISP',DISPOPT                                                 
         BNE   VPOL0010                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(08,RF),=C'SPGENBK:'                                            
         MVC   10(30,RF),SPGENBK                                                
         MVC   45(08,RF),=C'DATAMGR:'                                           
         MVC   55(04,RF),DATAMGR                                                
         GOTO1 AREPORT                                                          
VPOL0010 EQU   *                                                                
*                                                                               
         XC    KEY,KEY             BUILD ESTIMATE KEY                           
         LA    R4,KEY                                                           
         USING ESTHDRD,R4                                                       
         MVC   EKEYAM,SPAM                                                      
         MVC   EKEYCLT,SPCLT                                                    
         MVC   EKEYPRD,=C'POL'                                                  
         MVC   EKEYEST,SPEST                                                    
*                                                                               
         CLC   =C'DISP',DISPOPT                                                 
         BNE   VPOL0012                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(11,RF),=C'KEY SOUGHT:'                                         
         MVC   15(30,RF),KEY                                                    
         GOTO1 AREPORT                                                          
VPOL0012 EQU   *                                                                
*                                                                               
         DROP  R4                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(L'EKEY),KEYSAVE                                              
         BNE   VPOLEXIT            NO RECORD: EXIT                              
*                                                                               
         CLC   =C'DISP',DISPOPT                                                 
         BNE   VPOL0020                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(21,RF),=C'POL RECORD KEY FOUND:'                               
         GOTO1 AREPORT                                                          
VPOL0020 EQU   *                                                                
*                                                                               
         GOTO1 GREC                GET THE RECORD                               
*                                                                               
         MVI   POLFLAG,X'FF'                                                    
         L     R6,AIO              EXTRACT INFO FROM THE ESTIMATE REC           
         USING ESTHDRD,R6                                                       
*                                                                               
         CLC   =C'DISP',DISPOPT                                                 
         BNE   VPOL0040                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(21,RF),=C'POL RECORD DETAILS  :'                               
         MVC   22(1,RF),EDAYMENU                                                
         MVC   24(6,RF),ESTART                                                  
         MVC   31(6,RF),EEND                                                    
         MVC   38(2,RF),EBOOK                                                   
         MVC   41(1,RF),EOWSDAY                                                 
         MVC   43(2,RF),EREP                                                    
         MVC   46(3,RF),EDEMLST                                                 
*                                                                               
         GOTO1 AREPORT                                                          
VPOL0040 EQU   *                                                                
*                                                                               
         MVC   SPESTDMU,EDAYMENU                                                
         MVC   SPESTSTR,ESTART                                                  
         MVC   SPESTEND,EEND                                                    
         MVC   SPESTBK,EBOOK                                                    
         MVC   SPESTOWK,EOWSDAY                                                 
         MVC   SPESTREP,EREP                                                    
         MVC   SPESTDEM,EDEMLST                                                 
         DROP  R6                                                               
*                                                                               
VPOLEXIT EQU   *                                                                
         B     TESTGOOD                                                         
         EJECT                                                                  
*                                                                               
*   DISPDET:  DISPLAY OPTION OUTPUT                                             
*                                                                               
DISPDET  NTR1                                                                   
         CLC   =C'DISP',DISPOPT                                                 
         BNE   DIDE0099                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(4,RF),=C'RET='                                                 
         MVC   4(1,RF),RETRANIT    SET 'RETRANIT'                               
         MVC   6(7,RF),=C'SPBUYD='                                              
         MVC   13(3,RF),SPBUYD                                                  
         GOTO1 AREPORT                                                          
DIDE0099 XIT1                                                                   
         EJECT                                                                  
*                                                                               
*                                                                               
*   DISPCOMP:   DISPLAY OPTION OUTPUT                                           
*                                                                               
DISPCOMP NTR1                                                                   
         CLC   =C'DISP',DISPOPT                                                 
         BNE   DICO0099                                                         
         L     R3,APLINE           A(PRINT LINE)                                
         MVC   0(5,R3),=C'COMP:'                                                
         EDIT  SPSCHLN,(5,6(R3))                                                
         EDIT  (2,0(R2)),(5,11(R3))                                             
         MVC   20(3,R3),SPXFERD                                                 
         MVC   24(3,R3),2(R2)                                                   
         MVC   30(3,R3),SPXFERT                                                 
         MVC   34(3,R3),5(R2)                                                   
         GOTO1 AREPORT                                                          
DICO0099 XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   DISPRET:  DISPLAY OPTION OUTPUT                                             
*                                                                               
DISPRET  NTR1                                                                   
         CLC   =C'DISP',DISPOPT                                                 
         BNE   DIRE0099                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         LA    R6,KEY              BUILD BUY KEY                                
         USING BUYKEY,R6                                                        
         MVC   0(10,RF),=C'BUILD BUY='                                          
         MVC   10(1,RF),BUYKAM                                                  
         MVC   11(2,RF),BUYKCLT                                                 
         MVC   13(1,RF),BUYKPRD                                                 
         MVC   15(5,RF),BUYMSTA                                                 
         EDIT  BUYKEST,(3,22(RF))                                               
         MVC   26(2,RF),BUYKBUY+1                                               
         MVI   BUYKBUY+2,X'01'                                                  
         GOTO1 AREPORT                                                          
         DROP  R6                                                               
DIRE0099 XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   DISPDFOR  DISPLAY OPTION OUTPUT                                             
*                                                                               
DISPFOR  NTR1                                                                   
         CLC   =C'DISP',DISPOPT                                                 
         BNE   DIFO0099                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(4,RF),=C'FOR:'                                                 
         MVC   5(4,RF),=C'RET='                                                 
         MVC   9(1,RF),RETRANIT    SET 'RETRANIT'                               
         MVC   11(7,RF),=C'SPBUYD='                                             
         MVC   18(3,RF),SPBUYD                                                  
         GOTO1 AREPORT                                                          
DIFO0099 XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   DISPCLEN: DISPLAY OPTION OUTPUT                                             
*                                                                               
DISPCLEN NTR1                                                                   
         CLC   =C'DISP',DISPOPT                                                 
         BNE   DICL0099                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(4,RF),=C'CLE='                                                 
         GOTO1 AREPORT                                                          
DICL0099 XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   DISPCLEN: DISPLAY OPTION OUTPUT                                             
*                                                                               
DISPDELE NTR1                                                                   
         CLC   =C'DISP',DISPOPT                                                 
         BNE   DIDL0099                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(4,RF),=C'DEL='                                                 
         GOTO1 AREPORT                                                          
DIDL0099 XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   DISPGET:  DISPLAY OPTION OUTPUT                                             
*                                                                               
DISPGET  NTR1                                                                   
         CLC   =C'DISP',DISPOPT                                                 
         BNE   DIGE0099                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(4,RF),=C'GET='                                                 
         GOTO1 AREPORT                                                          
DIGE0099 XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   DISPBUYS: DISPLAY OPTION OUTPUT                                             
*                                                                               
DISPBUYS NTR1                                                                   
         L     R2,0(R1)            RETRIEVE COUNTER                             
         CLC   =C'BUYS',DISPOPT                                                 
         BNE   DIBU0099                                                         
         L     RF,APLINE           A(PRINT LINE)                                
         MVC   0(5,RF),=C'BUYS='                                                
         LA    RE,DIBUTABL         FIGURE DISPLAY                               
         SLL   R2,2                MULT BY FOUR                                 
         AR    RE,R2               BUMP INTO TABLE                              
         MVC   5(4,RF),0(RE)       LOAD TABLE VALUE                             
         GOTO1 AREPORT                                                          
DIBU0099 XIT1                                                                   
*                                                                               
DIBUTABL DC    CL20'B110B120B160B170B190'                                       
         EJECT                                                                  
*                                                                               
*        COMMON CODE                                                            
*                                                                               
TESTGOOD DS    0H                                                               
         SR    R0,R0                                                            
         B     TESTEXIT                                                         
TESTBAD  DS    0H                                                               
         LA    R0,1                                                             
TESTEXIT DS    0H                                                               
         LTR   R0,R0                                                            
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*        IO INTERFACE                                                           
*                                                                               
         SPACE                                                                  
*        COMMUNICATION WITH DATA MANAGER (DIRECTORY)                            
         SPACE                                                                  
READ     MVC   COMMAND(8),DMREAD                                                
         B     DIRCTRY                                                          
         SPACE 2                                                                
SEQ      MVC   COMMAND(8),DMRSEQ                                                
         B     DIRCTRY                                                          
         SPACE 2                                                                
HIGH     MVC   COMMAND(8),DMRDHI                                                
         MVC   KEYSAVE,KEY                                                      
         B     DIRCTRY                                                          
         SPACE 2                                                                
ADD      MVC   COMMAND(8),DMADD                                                 
         CLI   NOWRITE,X'00'                                                    
         BE    DIRCTRY                                                          
         BR    RE                                                               
         SPACE 2                                                                
WRITE    MVC   COMMAND(8),DMWRT                                                 
         CLI   NOWRITE,X'00'                                                    
         BE    DIRCTRY                                                          
         BR    RE                                                               
         SPACE 2                                                                
DIRCTRY  NTR1                                                                   
         IC    R4,DMINBTS                                                       
         MVC   KEYSAVE,KEY                                                      
         GOTO1 DATAMGR,DMCB,((R4),COMMAND),SPTDIR,KEYSAVE,KEY                   
         B     RGENIODM                                                         
         EJECT                                                                  
*        COMMUNICATION WITH DATA MANAGER (FILE)                                 
         SPACE 3                                                                
GREC     MVC   COMMAND(8),GETREC                                                
         B     FILE                                                             
         SPACE 2                                                                
PREC     MVC   COMMAND(8),PUTREC                                                
         CLI   NOWRITE,X'00'                                                    
         BE    FILE                                                             
         BR    RE                                                               
         SPACE 2                                                                
AREC     MVC   COMMAND(8),ADDREC                                                
         CLI   NOWRITE,X'00'                                                    
         BE    FILE                                                             
         BR    RE                                                               
         SPACE 2                                                                
FILE     NTR1                                                                   
         LA    R2,KEY+14                                                        
         CLI   COMMAND,C'A'                                                     
         BNE   *+8                                                              
         LA    R2,KEY                                                           
         IC    R4,DMINBTS                                                       
         ICM   R5,15,AIO                                                        
         GOTO1 DATAMGR,DMCB,((R4),COMMAND),SPTFILE,(R2),(R5),          X        
               DMWORK                                                           
         SPACE 2                                                                
*                  DATA MANAGER ERRORS AND EXIT                                 
         SPACE 3                                                                
RGENIODM OC    DMCB+8(1),DMCB+8                                                 
*                                                                               
         XIT1                      RETURN                                       
*                                                                               
         EJECT                                                                  
*                                                                               
*        USED LITERALS                                                          
*                                                                               
SPTFILE  DC    CL8'SPTFILE '                                                    
SPTDIR   DC    CL8'SPTDIR  '                                                    
ADDCODE  DC    CL8'ADD=CODE'                                                    
DMREAD   DC    CL8'DMREAD  '                                                    
DMRSEQ   DC    CL8'DMRSEQ  '                                                    
DMRDHI   DC    CL8'DMRDHI  '                                                    
DMADD    DC    CL8'DMADD   '                                                    
DMWRT    DC    CL8'DMWRT   '                                                    
GETREC   DC    CL8'GETREC  '                                                    
PUTREC   DC    CL8'PUTREC  '                                                    
ADDREC   DC    CL8'ADDREC  '                                                    
SPACES   DC    18C' '                                                           
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*        WORKING STORE                                                          
* ---------------------------------------------------------                     
*        EQUATES                                                                
*                                                                               
MAXWEEKS EQU   52                  MAXIMUM NUMBER OF WEEKS                      
MAXBELEM EQU   170                 65% OF MAX # OF BUY ELEMENTS                 
*                                  65% COMMENT NO LONGER APPLICABLE             
MAX5BITS EQU   31                  MAX FOR HIGH ORDER 5 BITS                    
MAXBKEYS EQU   52                  MAX BUY KEYS PER HEADER                      
MAXBLINE EQU   10                  MAX NUM OF BUYLINES/SCHED                    
MAXDTYPS EQU   20                  MAX NUM VALID DEMO TYPES                     
BLNENTRY EQU   12                  LEN OF BUYLINE TABLE ENTRY                   
LENBKEY  EQU   L'BUYKAM+L'BUYKCLT+L'BUYKPRD+L'BUYMSTA+L'BUYKEST                 
*                                                                               
*        BUYLINE TABLE OFFSET EQUATES                                           
*                                                                               
BLTSCHED EQU   0                                                                
BLTTRAND EQU   2                                                                
BLTTRANT EQU   5                                                                
BLTMPRD  EQU   9                                                                
BLTPPRD  EQU   10                                                               
BLTLNUM  EQU   11                                                               
*                                                                               
* ---------------------------------------------------------                     
*        ERROR EQUATES                                                          
*                                                                               
EREQWKS  EQU   01                  INVALID NUMBER OF WEEKS                      
EREQSSEQ EQU   02                  INVALID SCHED SEQ NUMBER                     
EREQSTDT EQU   03                  INVALID START DATE                           
EREQNSCH EQU   04                  CAN'T BUILD W/O SCHEDULES                    
EREQDTYP EQU   05                  NEED >= 1 VALID DEMO TYPE                    
EREQFULL EQU   06                  BINSRCH TABLE IS FULL                        
EREQRETR EQU   07                  INVALID RETRANSFER                           
EREQOFLW EQU   08                  BUY RECORD OVERFLOW OCCURRED                 
*                                                                               
TREQNPC  EQU   01                  NO PRODUCT CODE                              
TREQBPC  EQU   02                  PRODUCT CODES DO NOT MATCH                   
TREQBPOL EQU   03                  POOL FLAG INCORRECT                          
TREQXFER EQU   04                  LAST XFER DATE AND TIME DO NOT MATCH         
TREQNBUY EQU   05                  BUY RECORD NO LONGER ON FILE                 
TREQBREC EQU   06                  REQUIRED DATA MISSING FROM SPOT BUY          
TREQXDAT EQU   07                  TRANSFER DATE IN CONFLICT WITH REC           
TREQBPAY EQU   08                  SPOTS ALREADY PAID                           
TREQBTAB EQU   09                  TABLE PROBLE, ENTRY MISSING                  
TREQCOST EQU   10                  SPOTS ALREADY PAID, COST CHANGE              
TREQSLEN EQU   11                  SPOTS ALREADY PAID, SPOT LEN CHG             
*                                                                               
* ---------------------------------------------------------                     
*        USUAL STUFF                                                            
*                                                                               
WORKD    DSECT                                                                  
DMCB     DS    0CL24                                                            
DM1      DS    F                                                                
DM2      DS    F                                                                
DM3      DS    F                                                                
DM4      DS    F                                                                
DM5      DS    F                                                                
DM6      DS    F                                                                
DUB      DS    D                                                                
FULL     DS    F                                                                
WORD     DS    F                                                                
HALF     DS    H                                                                
HALF2    DS    H                                                                
WORK     DS    CL64                                                             
THREE    DS    CL3                                                              
BYTE     DS    CL1                                                              
COMMAND  DS    CL8                                                              
*                                                                               
DMWORK   DS    12D                                                              
DMINBTS  DS    CL1                                                              
NOWRITE  DS    CL1                                                              
*                                                                               
*        ADDRS                                                                  
*                                                                               
DATAMGR  DS    A                                                                
DATCON   DS    A                                                                
HELLO    DS    A                                                                
ADDAY    DS    A                                                                
PERVERT  DS    A                                                                
GETDAY   DS    A                                                                
PASSPARM DS    A                                                                
RELO     DS    A                                                                
AIO      DS    A                                                                
AIO1     DS    A                                                                
AIO2     DS    A                                                                
AIO3     DS    A                                                                
AENTRY   DS    A                                                                
ABLNTBL  DS    A                                                                
ALSTNTRY DS    A                                                                
AMODETAB DS    A                                                                
AREPORT  DS    A                                                                
APLINE   DS    A                                                                
DISPOPT  DS    F                   DISPLAY OPTION:                              
*                                  'DISP' = EXECUTE DISPLAYS                    
*                                                                               
*        KEYS                                                                   
*                                                                               
KEY      DS    CL32                                                             
KEYSAVE  DS    CL32                                                             
KEY2     DS    CL32                                                             
KEY2SAVE DS    CL32                                                             
*                                                                               
*                   BINARY EQUIVALENTS                                          
*                                                                               
ERRORRTN DS    XL1                 RETURN'ABLE ERROR CODE                       
KEYPRD   DS    XL1                 PRODUCT CODE TO BE IN THE KEY                
BNUMWKS  DS    XL1                 # OF WEEKS WITHIN ESTIMATE PERIOD            
BDAY1    DS    XL1                 BUY START DAY                                
BDAYX    DS    XL1                 BUY END DAY                                  
BDAYT1   DS    XL1                 NON-ADJUSTED BUY START DAY                   
BDAYTX   DS    XL1                 NON-ADJUSTED BUY END DAY                     
CURBELS  DS    XL1                 CURRENT COUNT OF BUY ELEMENTS                
CURBSPTS DS    XL1                 CURRENT BUY NUMBER OF SPOTS                  
CURBDATE DS    XL2                 CURRENT BUY DATE                             
*                                                                               
*                   ELEMENTS                                                    
*                                                                               
DESCELEM DS    XL256               DESCRIPTION ELEMENT                          
DEMOELEM DS    XL256               DEMO ELEMENT                                 
PIGELEM  DS    XL(PBPRD+L'PBPRD-PBELEM)  PIGGYBACK ELEMENT                      
TRCEELEM DS    XL50                TRACE ELEMENT                                
BUYELEM  DS    XL15                BUY ELEMENT                                  
SPIDELEM DS    XL15                SPOT BUY ID ELEMENT                          
SPCOMELT DS    XL62                SPOT BUY COMMENT ELEMENT                     
*                                                                               
*                   MISCELLANEOUS                                               
*                                                                               
MODETAB  DS    XL256               TABLE TO FIGURE OUT MODE SPOTS/WEEK          
MODENUM  DS    XL1                 CURRENT MODE                                 
MODESPW  DS    XL1                 MODE SPOTS PER WEEK                          
NUMSCHED DS    XL1                 NUMBER OF SCHEDULE OBJECTS                   
NUMWEEKS DS    XL1                 NUMBER OF WEEKS USED FOR LOOP                
POLFLAG  DS    XL1                 POOL BUY FLAG                                
*                                   X'FF' = POOL                                
SPOTPAID DS    CL1                 SPOTS PAID FLAG                              
*                                  Y  =  YES                                    
*                                  N  =  NO                                     
THISDATE DS    CL6                 DATE USED FOR BUMPING                        
THEMRKT  DS    CL4                 THE MARKET IN EBCDIC HEX                     
PARTKEY  DS    CL(L'BUYKEY-L'BUYKBUY)   PARTIAL MASTER KEY                      
NEWLINE  DS    XL1                 BUYLINE FOR RECORD                           
NUMDCATS DS    XL1                 NUMBER OF VALID DATA CATEGORIES              
TRNSTRTB DS    XL3                 RETRANSFER START DATE IN BINARY              
TRNSTRTC DS    XL2                 RETRANSFER START DATE IN COMPRESSED          
MOREDAYS DS    XL1                 NUMBER OF DAYS FROM START DAY                
ENDSCHED DS    CL1                 NO MORE SCHEDULES (Y/N)                      
BINPBPRD DS    XL1                 PIGGYBACK PRODUCT CODE                       
BITFLAG  DS    XL1                 FLAG CARRIER                                 
*                                   X'80' = POOL                                
*                                   X'40' = USE 5 BITS IN RPCOST                
SVMENU   DS    XL37                NEW DAYPART MENU (X'00' - EOT)               
*                                                                               
RETRANIT DS    CL1                 RETRANSFER FLAG                              
*                                                                               
DTYPLIST DS    (MAXDTYPS+1)XL3     DEMO TYPE LIST AND ROOM FOR X'FF'            
*                                                                               
*        IO AREAS                                                               
*                                                                               
IOAREA1  DS    4008C                                                            
IOAREA1X EQU   *                                                                
IOAREA2  DS    4008C                                                            
IOAREA2X EQU   *                                                                
IOAREA3  DS    4008C                                                            
IOAREA3X EQU   *                                                                
LIOS     EQU   IOAREA1X-IOAREA1                                                 
*                                                                               
*        BUY TABLE AREA                                                         
*                                                                               
BLNTBL   DS    255XL(BLNENTRY)                                                  
*                                                                               
*        WORKD END                                                              
*                                                                               
WORKDX   EQU   *                                                                
WORKDLEN EQU   WORKDX-WORKD                                                     
         EJECT                                                                  
         PRINT ON                                                               
BUYHDRD  DSECT                                                                  
       ++INCLUDE SPGENBUY                                                       
         ORG   BTRCLUID                                                         
BTRCTRAC DS    0CL1                TRACE DATA - SPECIAL SETUP                   
*                                     FOR REP-TO-SPOT....                       
ESTHDRD  DSECT                                                                  
       ++INCLUDE SPGENEST                                                       
         EJECT                                                                  
       ++INCLUDE SPBUYGEND                                                      
         EJECT                                                                  
       ++INCLUDE SPBUYDETDA                                                     
         EJECT                                                                  
       ++INCLUDE DDCOMFACS                                                      
         EJECT                                                                  
       ++INCLUDE FAFACTS                                                        
         EJECT                                                                  
       ++INCLUDE SPMEDBLOCK                                                     
         EJECT                                                                  
*                                                                               
*                                                                               
*   ORIGINAL TRACE ELEMENT PUT BACK.  CAUSED PROBLEM BASED ON TIME              
*     BEING NOT SPECIFIC ENOUGH TO CREATE SEPARATION.                           
*                                                                               
BTRXELEM DSECT                     TRACE ELEMENT                                
BTRXCODE DS    XL1                 ELEMENT CODE (X'98')                         
BTRXCODQ EQU   X'98'                                                            
BTRXLEN  DS    XL1                 ELEMENT LENGTH                               
BTRXSEQN DS    XL2                 SCHEDULE SEQUENCE NUMBER                     
BTRXDATE DS    XL3                 DATE CREATED                                 
BTRXTIME DS    XL4                 TIME CREATED                                 
BTRXLUID DS    0CL8                WHO CREATED THE BUY                          
BTRXLINE DS    CL4                 LINE ID                                      
BTRXADDR DS    CL4                 TERMINAL ADDRESS                             
         ORG   BTRXLUID                                                         
BTRXTRAC DS    0CL1                TRACE DATA                                   
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'119SPBYGENS  05/01/02'                                      
         END                                                                    
