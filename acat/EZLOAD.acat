*          DATA SET EZLOAD     AT LEVEL 191 AS OF 03/22/18                      
*CATALP EZLOAD                                                                  
*        TITLE 'EASI - TAPE TO WORKER FILE'                                     
***********************************************************************         
*                                                                     *         
*  REGISTER USAGE                                                     *         
*  R0 - OS & WORK                                                     *         
*  R1 - OS & WORK                                                     *         
*  R2 - WORK                                                          *         
*  R3 - WORK                                                          *         
*  R4 - WORK                                                          *         
*  R5 - WORK                                                          *         
*  R6 - WORK                                                          *         
*  R7 - LITERALS + COMMON VARIABLES                                   *         
*  R8 -               NOT USED                                        *         
*  R9 - SECOND BASE                                                   *         
*  RA - DPRINT                                                        *         
*  RB - FIRST BASE REG                                                *         
*  RC - EZLDWKD DSECT FROM NMOD CHAIN                                 *         
*  RD - STD REG SAVE CHAIN                                            *         
*  RE - OS & WORK                                                     *         
*  RF - OS & WORK                                                     *         
*                                                                     *         
***********************************************************************         
         TITLE 'EASI - TAPE TO WORKER FILE'                                     
EZLOAD   CSECT                                                                  
         ENTRY UTL                                                              
         ENTRY SSB                                                              
*                                                                               
         PRINT NOGEN                                                            
         NBASE EZLDWKL,**EZLD,=A(REGSAVE),R9                                    
         USING EZLDWKD,RC                                                       
         L     RA,=V(CPRINT)                                                    
         USING DPRINT,RA                                                        
         L     R7,=A(COMMON)                                                    
         USING COMMON,R7                                                        
*                                                                               
         GOTO1 =A(INIT),DMCB,(RC)                                               
         BE    EZREAD                                                           
*                                                                               
EOJ      GOTO1 =V(PRINT),DMCB,=C'CLOSE'                                         
         CLI   ABNDOPT,C'Y'                                                     
         BNE   *+6                                                              
         DC    H'0'                                                             
         XBASE                                                                  
*                                                                               
EQXIT    CR    RB,RB                                                            
         J     EXIT                                                             
NEQXIT   LTR   RB,RB                                                            
EXIT     XIT1                                                                   
         LTORG                                                                  
*                                                                               
*              READ INPUT DATA SET                                              
*                                                                               
EZREAD   DS    0H                                                               
         CLI   WRITEFL,C'N'                                                     
         BNE   *+8                                                              
         MVI   TEST,C'Y'                                                        
*                                                                               
         MVI   FDELIM,X'5E'        FIELD DELIMITER - SEMI COLON                 
         MVI   RDELIM,X'15'        RECORD DELIMITER - NEW LINE                  
*                                                                               
         LA    RE,RFVALS                                                        
         LA    RF,RFVALSL                                                       
         XCEF                                                                   
*                                                                               
         XC    SVRECTYP,SVRECTYP                                                
*                                                                               
         L     RE,=A(EZOTREC)                                                   
         ST    RE,WRCURPOS                                                      
         ST    RE,WRECST                                                        
         LA    RF,EZOTRECL                                                      
         XCEF                                                                   
*                                                                               
EZR010   DS    0H                                                               
         GOTO1 =A(GETFLD),DMCB,(RC)                                             
*                                                                               
         TM    RFCTL,RFCTLFER      FIELD ERROR                                  
         BZ    EZR011                                                           
*                                                                               
         CLI   TRACEFLD,C'Y'     TEST TRACING FIELDS                            
         BNE   EZR011                                                           
         CLI   EXCLSW,C'Y'       SKIP EXPRESSLY EXCLUDED BATCHES                
         BE    EZR011                                                           
         BRAS  RE,TRCRETN          TRACE GETFLD RETURNS                         
*                                                                               
EZR011   DS    0H                                                               
         TM    RFCTL,RFCTLEOR      TEST END OF A RECORD                         
         BZ    EZR012                                                           
*                                                                               
         BAS   RE,ENDREC                                                        
         L     RE,=A(EZOTREC)                                                   
         ST    RE,WRCURPOS                                                      
         ST    RE,WRECST                                                        
         LA    RF,EZOTRECL                                                      
         XCEF                                                                   
*                                                                               
         TM    RFCTL,RFCTLEOF      TEST EOFILE                                  
         BZ    EZR010                                                           
*                                                                               
EZR012   DS    0H                                                               
         TM    RFCTL,RFCTLEOF      TEST EOFILE                                  
         BNZ   EZR090                                                           
*                                                                               
*                                  HANDLE FIELD                                 
*                                  ------------                                 
*        NOTE- THIS CODE INVOLVING RECORD TYPES AND                             
*              FIELD NUMBERS IS NOT EXACTLY SOFT                                
*                                                                               
*                                                                               
EZR014   DS    0H                                                               
         CLI   RFFLDNO,1           FLD 1 IS RECORD TYPE                         
         BNE   EZR030                                                           
*                                                                               
         CLI   RFLEN,2             RECORD TYPE MUST BE 2 CHARS LONG             
         BE    EZR015                                                           
         CLC   SOURCE,=C'STRA'                                                  
         BNE   TYPLENER                                                         
         CLI   RFDATA+3,C'*'       THIS POSSIBLE STRATA BUY REC                 
         BNE   TYPLENER                                                         
*                                                                               
* CHECK FOR INTERMIXED STRATA BUY DATA GARBAGE                                  
*                                                                               
         CLC   =C'BUY',RFDATA                                                   
         BE    STRATAG              DROP IT                                     
         CLC   =C'DEM',RFDATA                                                   
         BE    STRATAG              DROP IT                                     
         CLC   =C'EOF',RFDATA                                                   
         BE    STRATAG              DROP IT                                     
         CLC   =C'HDR',RFDATA                                                   
         BE    STRATAG              DROP IT                                     
         CLC   =C'SKD',RFDATA                                                   
         BNE   TYPLENER                                                         
*                                                                               
STRATAG  DS   0H                                                                
         OI    RFCTL2,RFCTL2RD        SET NEED READ NEXT REC                    
         NI    RFCTL2,X'FF'-RFCTL2ER  SET OFF END OF RECORD                     
         MVI   EXCLSW,C'Y'            SET BYPASS ALL ADDS                       
         B     EZR010                                                           
*                                                                               
EZR015   DS    0H                                                               
         LA    R0,TYPETLEN                                                      
         LA    R1,TYPETABL                                                      
EZR016   CLC   RFDATA(2),0(R1)                                                  
         BE    EZR018                                                           
         LA    R1,2(,R1)                                                        
         BCT   R0,EZR016                                                        
         B     TYPLENER                                                         
*                                                                               
EZR018   MVC   RFRECST,RFFLDST     SET START OF RECORD                          
         MVC   SVRECTYP,RECTYP     SAVE RECORD TYPE                             
         MVC   RECTYP,RFDATA       SAVE RECORD TYPE                             
*                                                                               
         CLC   RECTYP,SCTRTYP      STANDARD TOP COMMENT                         
         BNE   EZR020                                                           
*                                                                               
* WILL READ AND SAVE UP TO 5 STD TOP COMMENTS                                   
* IF ANOTHER SET IS READ, THE SAVED ONES ARE CLEARED,                           
* AND THE NEW SET IS SAVED                                                      
*                                                                               
         TM    STDCMTSW,STDCMTOP   READING STD TOP COMMENTS                     
         BO    EZR010                                                           
         L     RE,=A(SAVSCT)                                                    
         LA    RF,SAVSCTLN         GET LENGTH                                   
         XCEF                                                                   
         OI    STDCMTSW,STDCMTOP   SET ON READING STD TOP COMMENTS              
         B     EZR010                                                           
*                                                                               
EZR020   DS    0H                                                               
         CLC   RECTYP,SCBRTYP      STANDARD BOTTOM COMMENT                      
         BNE   EZR021                                                           
*                                                                               
         TM    STDCMTSW,STDCMBOT   READING STD TOP COMMENTS                     
         BO    EZR010                                                           
         L     RE,=A(SAVSCB)                                                    
         LA    RF,SAVSCBLN         GET LENGTH                                   
         XCEF                                                                   
         OI    STDCMTSW,STDCMBOT   SET ON READING STD BOTTOM COMMENTS           
         B     EZR010                                                           
*                                                                               
EZR021   DS    0H                                                               
         NI    STDCMTSW,X'FF'-STDCMTOP-STDCMBOT  SET OFF STD COMMENT SW         
*                                                                               
         CLC   RECTYP,STARTYP      FOR STATION RECORD                           
         BNE   EZR022                                                           
*                                                                               
         CLI   TOSVMED,C'Y'                                                     
         BNE   *+10                                                             
         MVC   OLDMEDIA,MEDIA                                                   
*                                                                               
         MVI   TOSVMED,C'N'                                                     
         XC    STAFLDS,STAFLDS     CLEAR STATION FIELDS                         
         XC    STAFLDSA,STAFLDSA                                                
         XC    SVSTAFLD,SVSTAFLD                                                
         NI    UNKNSW,X'FF'-UNKNSTAQ RE-SET UNKNOWN SWITCH                      
         B     EZR010                                                           
*                                                                               
EZR022   DS    0H                                                               
         CLC   RECTYP,AGYRTYP      FOR AGENCY RECORD                            
         BNE   EZR023                                                           
*                                                                               
         MVI   UNKNSW,X'00'        RE-SET UNKNOWN SWITCH                        
         CLC   SVRECTYP,IDBTYP     IS AGY RECORD PRECEEDED BY IDB REC?          
         BE    EZR022A             YES                                          
* NO CLEAR ALL SAVED DATA FROM PREVIOUS IDB RECORD                              
         XC    IDBFLDS(IDBFLDLQ),IDBFLDS                                        
         L     RE,=A(SAVIDB)                                                    
         LA    RF,SAVIDBLN                                                      
         XCEF                                                                   
         NI    SVRECSW,X'FF'-SVRECIDB                                           
*                                                                               
EZR022A  DS    0H                                                               
         XC    AGYFLDS,AGYFLDS     CLEAR AGENCY FIELDS                          
         B     EZR010                                                           
*                                                                               
EZR023   DS    0H                                                               
         CLC   RECTYP,IDBTYP       IDB NUMBER                                   
         BNE   EZR023A                                                          
         XC    IDBFLDS(IDBFLDLQ),IDBFLDS                                        
         B     EZR010                                                           
*                                                                               
EZR023A  DS    0H                                                               
         CLC   RECTYP,VERTYP       INVOICE VERSION                              
         BNE   EZR024                                                           
         MVI   INVVER,X'00'                                                     
         B     EZR010                                                           
*                                                                               
EZR024   DS    0H                                                               
         CLC   RECTYP,INVRTYP      TEST INVOICE HEADER                          
         BNE   EZR029                                                           
*                                                                               
         CLC   SVRECTYP,VERTYP     PRECEDED BY VERSION NUMBER REC?              
         BE    *+8                 YES - WE NEED THE VERSION SAVED              
         MVI   INVVER,X'00'        NO - CLEAR VERSION NUMBER                    
*                                                                               
* BOTH AGY AND STATION RECORDS HAVE BEEN READ                                   
* CHECK IF WE NEED TO CHANGE THE MEDIA                                          
*                                                                               
         CLI   REDIRFLG,C'Y'       ARE WE REDIRECTING?                          
         BNE   EZR025              NO                                           
         CLI   MEDIA,C'N'          NET?                                         
         BE    *+12                YES - CHANGE MEDIA                           
         CLI   MEDIA,C'C'          CABLE?                                       
         BNE   EZR025              NO                                           
*                                                                               
         MVC   MEDIA,=C'T '         YES - CHANGE MEDIA TO SPOT                  
         MVC   BAND,=C'T '          YES - CHANGE MEDIA TO SPOT                  
         MVC   OLDMEDIA,=C'T '                                                  
*                                                                               
EZR025   DS    0H                                                               
         BAS   RE,ENDINV           FINISH OLD INVOICE                           
         MVC   OLDSRC,SOURCE                                                    
*                                                                               
         MVC   SVUSID,USID        SAVE LAST ID                                  
         MVC   SVEXCLSW,EXCLSW    SAVE LAST EXCLUDE SW STATE                    
*                                                                               
         CLI   EXCLSW,C'D'         DISK ERROR ON THIS INVOICE?                  
         BNE   *+8                 NO                                           
         MVI   NEWBATSW,C'Y'       YES - FORCE IT INTO A SEPARATE BATCH         
*                                                                               
         GOTO1 =A(GETUID),DMCB,(RC)                                             
*                                                                               
         CLI   EXCLSW,C'Y'         BAD BATCH                                    
         BE    EZR026                                                           
         CLI   EXCLSW,C'*'         UNKNOWN AGENCY                               
         BE    EZR026                                                           
         CLI   EXCLSW,C'I'         EXCLUDE USER ID                              
         BE    EZR026                                                           
         CLI   EXCLSW,C'S'         EXCLUDE STATION                              
         BE    EZR026                                                           
*                                                                               
*        SEE IF CHANGED ADVERT SHOULD FORCE NEW BAT *                           
*                                                                               
         CLC   SOURCE,=C'WIM '     WIM SOURCE IS ALL WIBIS                      
         BE    EZR026                                                           
*                                                                               
         GOTO1 =A(CKADV),DMCB,(RC)                                              
*                                                                               
EZR026   DS    0H                                                               
         BRAS  RE,CLTREDIR                                                      
*                                                                               
         CLC   SVUSID,USID         CHANGE FROM LAST ID                          
         BNE   EZR027                                                           
*                                                                               
         CLC   SVINVMOS,INVMOS     CHANGE OF MONTH OF SERVICE                   
         BNE   EZR027                                                           
*                                                                               
         CLC   STAFLDS,OLDSTA      TEST CHANGE OF STATION                       
         BNE   EZR027                                                           
*                                                                               
         CLI   NEWBATSW,C'Y'       FORCED NEW BATCH (READING HOLD FILE)         
         BE    EZR027               YES, CHANGED DATE OR SOURCE                 
*                                                                               
         CLC   BRECS,=F'2700'      NO MORE BIG BATCHES (BAT MOV PROB)           
         BH    EZR027               YES, BREAK IT UP                            
*                                                                               
         CP    BBYTS,=P'140000'    NO MORE BIG BATCHES (BAT MOV PROB)           
         BH    EZR027               YES, BREAK IT UP                            
*                                                                               
         CLC   AGYFLDS,OLDAGY      OR AGENCY                                    
         BE    EZR010                                                           
*                                                                               
EZR027   DS    0H                     NEW BATCH                                 
         MVI   NEWBATSW,C'N'          SET OFF AGAIN                             
*                                                                               
         GOTO1 =A(ENDBTCH),DMCB,(RC)  PROCESS END OF BATCH                      
*                                                                               
         CLI   EXCLSW,C'D'                                                      
         BNE   *+8                                                              
         MVI   EXCLSW,C'N'                                                      
*                                                                               
         GOTO1 =A(NEWIND),DMCB,(RC)   SET NEW WORKER INDEX AND PRINT            
         MVC   SVINVMOS,INVMOS     SAVE MONTH OF SERVICE                        
         B     EZR010                                                           
*                                                                               
EZR029   CLC   RECTYP,SRCETYP      THIS A SOURCE RECORD                         
         BNE   EZR010                                                           
*                                                                               
         OC    SVSRCE,SVSRCE       MUST BE WORKING ON HOLD FILE                 
         BNZ   EZR010               OK                                          
         DC    H'0'                                                             
*                                                                               
EZR030   DS    0H                                                               
         CLI   RFFLDNO,2           TEST FIELD 2                                 
         BNE   EZR032                                                           
         CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR031                                                           
*                                                                               
         CLI   RFLEN,0                                                          
         BE    *+14                                                             
         CLC   RFDATA,=4C' '                                                    
         BH    *+12                                                             
         OI    UNKNSW,UNKNSTAQ    NO STA CALL LETTERS - SEND TO UNKNOWN         
         B     EZR010                                                           
*                                                                               
         MVC   STATION,RFDATA      SAVE STATION                                 
         CLI   STATION+3,C' '      IF 3 CHAR STATION                            
         BNE   *+8                                                              
         MVI   STATION+3,0         FORCE TO NULL                                
*                                                                               
         BAS   RE,CKSTA            CK FOR LOCAL CABLE NUMERICS                  
         B     EZR010                                                           
*                                                                               
EZR031   DS    0H                                                               
         CLC   RECTYP,TRTOTYP      TEST TRANSMISSION TOTAL REC                  
         BNE   EZR031A                                                          
*                                                                               
         CLI   RFLEN,0             IF NO INPUT                                  
         BE    EZR010               BYPASS                                      
*                                                                               
         CLI   RFLEN,5             MAX LEN                                      
         BH    EZR010               TOO MUCH, BYPASS                            
*                                                                               
         ZIC   RF,RFLEN                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  DUB,RFDATA(0)                                                    
         CVB   R0,DUB                                                           
         A     R0,TOTINVS          NOW ACCUMULATE TOTALS                        
         ST    R0,TOTINVS                                                       
         B     EZR010                                                           
*                                                                               
EZR031A  DS    0H                                                               
         CLC   RECTYP,SPTRTYP      THIS A SPOT DETAIL RECORD                    
         BNE   EZR031B                                                          
*                                                                               
         CLI   RFLEN,0             IF NO INPUT                                  
         BE    EZR010               BYPASS                                      
*                                                                               
         CLI   RFDATA,C'Y'         DID THIS SPOT RUN?                           
         BNE   EZR010               BYPASS                                      
*                                                                               
         L     RF,ISPTS            BUMP SPOT COUNT                              
         LA    RF,1(,RF)                                                        
         ST    RF,ISPTS                                                         
         B     EZR010                                                           
*                                                                               
EZR031B  DS    0H                                                               
         CLC   RECTYP,SRCETYP      THIS A SOURCE RECORD                         
         BNE   EZR031C                                                          
*                                                                               
         CLI   RFLEN,0             IF NO INPUT                                  
         BNE   *+6                  BIG PROBLEM                                 
         DC    H'0'                                                             
*                                                                               
         OC    SVSRCE,SVSRCE       MUST BE WORKING ON HOLD FILE                 
         BNZ   *+6                  OK                                          
         DC    H'0'                                                             
*                                                                               
         MVC   SOURCE,RFDATA                                                    
         B     EZR010                                                           
*                                                                               
EZR031C  DS    0H                                                               
         CLC   RECTYP,IDBTYP       TEST IDB NUMBER                              
         BNE   EZR031D                                                          
*                                                                               
         ZIC   RF,RFLEN                                                         
         CHI   RF,0                                                             
         BNH   EZR010                                                           
*                                                                               
         CHI   RF,L'IDBAGYN                                                     
         BNH   *+8                                                              
         LHI   RF,L'IDBAGYN                                                     
*                                                                               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   IDBAGYN(0),RFDATA                                                
         OC    IDBAGYN,SPACES                                                   
         B     EZR010                                                           
*                                                                               
EZR031D  DS    0H                                                               
         CLC   RECTYP,VERTYP       TEST INVOICE VERSION NUMBER                  
         BNE   EZR031E                                                          
         CLI   RFLEN,0             IF NO INPUT                                  
         BE    EZR010               BYPASS                                      
*                                                                               
         CLI   RFLEN,3             MAX LEN                                      
         BH    EZR010               TOO MUCH, BYPASS                            
*                                                                               
         ZIC   RF,RFLEN                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  DUB,RFDATA(0)                                                    
         CVB   R0,DUB                                                           
         CHI   R0,0                                                             
         BNH   EZR010                                                           
         CHI   R0,250                                                           
         BH    EZR010                                                           
         STC   R0,INVVER                                                        
*                                                                               
EZR031E  DS    0H                                                               
         CLC   RECTYP,SCTRTYP      STANDARD COMMENT TOP                         
         BNE   EZR031F                                                          
*                                                                               
         CLI   RFLEN,130                                                        
         BNH   EZR010                                                           
         MVC   ERRLINE,=CL132'STD TOP COMMENT LONGER THAN 130 CHARS'            
         B     FATALERR                                                         
*                                                                               
EZR031F  DS    0H                                                               
         CLC   RECTYP,SCBRTYP      STANDARD COMMENT BOTTOM                      
         BNE   EZR010                                                           
*                                                                               
         CLI   RFLEN,130                                                        
         BNH   EZR010                                                           
         MVC   ERRLINE,=CL132'STD BOTTOM COMMENT LONGER THAN 130 CHARS'         
         B     FATALERR                                                         
*                                                                               
EZR032   DS    0H                                                               
         CLI   RFFLDNO,3           TEST FIELD 3                                 
         BNE   EZR040                                                           
*                                                                               
         CLC   RECTYP,SPTRTYP      THIS A SPOT DETAIL RECORD                    
         BNE   EZR033                                                           
         CLC   RUNDATLO,RFDATA                                                  
         BL    *+10                                                             
         MVC   RUNDATLO,RFDATA                                                  
         CLC   RUNDATHI,RFDATA                                                  
         BH    *+10                                                             
         MVC   RUNDATHI,RFDATA                                                  
*                                                                               
EZR033   DS    0H                                                               
         CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR034                                                           
*                                                                               
         CLI   RFLEN,0             MEDIA MUST BE PRESENT                        
         BNE   *+12                                                             
         OI    UNKNSW,UNKNSTAQ                                                  
         B     EZR010                                                           
*                                                                               
         CLI   STATION,C'0'        IF CABLE HEAD, FORCE TO TV                   
         BL    *+10                                                             
         MVC   RFDATA(2),=C'TV'                                                 
         MVC   MEDIA,RFDATA        SAVE MEDIA                                   
*                                                                               
         CLI   MEDIA,C'L'                                                       
         BNE   EZR010                                                           
         MVC   MEDIA,=C'TV'                                                     
*                                                                               
         B     EZR010                                                           
*                                                                               
EZR034   DS    0H                                                               
         CLC   RECTYP,AGYRTYP      TEST AGENCY RECORD                           
         BNE   EZR035                                                           
*                                                                               
         MVI   REDIRFLG,C'N'                                                    
         MVC   AGYNAME,RFDATA      SAVE AGENCY NAME                             
         MVI   IDBFLAG,C'N'                                                     
         CLC   SVRECTYP,IDBTYP     AGY RECORD PRECEDED BY IDB RECORD?           
         BNE   *+8                 NO                                           
         MVI   IDBFLAG,C'Y'        YES- SET THE IDB FLAG                        
*                                                                               
         CLC   =CL20'*** UNKNOWN AGY! ***',AGYNAME                              
         BNE   *+12                                                             
         OI    UNKNSW,UNKNAGYQ    21 RECORD WAS MISSING                         
         B     EZR010                                                           
*                                                                               
         BRAS  RE,CHKREDIR                                                      
*                                                                               
         B     EZR010                                                           
*                                                                               
EZR035   DS    0H                                                               
         CLC   RECTYP,IDBTYP       TEST IDB NUMBER                              
         BNE   EZR036                                                           
*                                                                               
         ZIC   RF,RFLEN                                                         
         CHI   RF,0                                                             
         BNH   EZR010                                                           
*                                                                               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   IDBOFFN(0),RFDATA                                                
         MVC   IDBOFFNL,RFLEN                                                   
         OC    IDBOFFN,SPACES                                                   
         B     EZR010                                                           
*                                                                               
EZR036   DS    0H                                                               
         CLC   RECTYP,INTRTYP      TEST INVOICE TOTAL                           
         BNE   EZR038                                                           
         CLI   RFLEN,0             IF NO INPUT                                  
         BE    EZR010               BYPASS                                      
*                                                                               
         BAS   RE,CKMINUS          CHECK FOR MINUS SIGN                         
*                                                                               
         ZIC   RF,RFLEN                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  DUB,RFDATA(0)                                                    
*                                                                               
         OC    SVSRCE,SVSRCE       ARE WE WORKING ON HOLD FILE                  
         BNZ   EZR037              YES - NO $21M CHECK                          
*                                                                               
         CP    DUB,=P'2147483647'  MAX 4-BYTE SIGNED VALUE                      
         BNH   EZR037                                                           
*                                                                               
         MVC   WORK,SPACES                                                      
         MVC   WORK(30),=CL30'AUTONOTE*TZIHDDNY:$21M ERROR, '                   
*                                                                               
* EXTRACT JOB NUMBER                                                            
*                                                                               
         ST    RD,FULL                                                          
         LINK  EP=FWRGETJI,PARAM=(JOBNAME)                                      
         L     RD,FULL                                                          
         MVC   WORK+30(L'JOBNAME),JOBNAME                                       
         MVC   WORK+30(3),=C'JOB'                                               
         MVI   WORK+38,C','                                                     
         MVC   WORK+39(L'INVNO),INVNO                                           
         OC    WORK,SPACES                                                      
         MVI   BYTE,L'WORK                                                      
         GOTO1 =V(DATAMGR),DMCB,=C'OPMSG',(BYTE,WORK)                           
*                                                                               
EZR037   DS    0H                                                               
         CLI   HOLDSIGN,C'-'       WAS THERE A MINUS                            
         BNE   *+8                  NO                                          
         XI    DUB+7,X'02'         FORCE TO MINUS VALUE                         
*                                                                               
         AP    IDOLG,DUB                                                        
         B     EZR010                                                           
*                                                                               
EZR038   DS    0H                                                               
         CLC   RECTYP,TRTOTYP      TEST TRANSMISSION TOTAL REC                  
         BNE   EZR039                                                           
*                                                                               
         CLI   RFLEN,0             IF NO INPUT                                  
         BE    EZR010               BYPASS                                      
*                                                                               
         ZIC   RF,RFLEN                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  DUB,RFDATA(0)                                                    
         AP    TOTDOLS,DUB                                                      
         B     EZR010                                                           
*                                                                               
EZR039   CLC   RECTYP,SRCETYP      THIS A SOURCE RECORD                         
         BNE   EZR010                                                           
*                                                                               
         CLI   RFLEN,0             IF NO INPUT                                  
         BNE   *+6                  BIG PROBLEM                                 
         DC    H'0'                                                             
         OC    SVSRCE,SVSRCE       MUST BE WORKING ON HOLD FILE                 
         BNZ   *+6                  OK                                          
         DC    H'0'                                                             
         CLC   HOLDDATE,RFDATA     DIFFERENT DATE?                              
         BE    EZR010                                                           
*                                                                               
         MVI   NEWBATSW,C'Y'       FORCE NEW BATCH                              
         MVC   HOLDDATE,RFDATA     SAVE ORIGINAL DATE                           
         B     EZR010                                                           
*                                                                               
*                                                                               
EZR040   DS    0H                                                               
         CLI   RFFLDNO,4           TEST FIELD 4                                 
         BNE   EZR050                                                           
         CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR042                                                           
*                                                                               
         CLI   STATION,C'0'        IF CABLE HEAD, FORCE TO TV                   
         BL    *+10                                                             
         MVC   RFDATA(2),=C'TV'                                                 
*                                                                               
         MVC   BAND,RFDATA         SAVE BAND                                    
*                                                                               
* ===================================================================           
* SET BAND                                                                      
* TV CAN HAVE 'T' OR 'D'                                                        
* RADIO - 'A', 'F', OR 'S'                                                      
* ALL OTHERS - BAND IS EQUATED TO MEDIA                                         
* ===================================================================           
*                                                                               
         CLI   MEDIA,C'T'                                                       
         BNE   EZR040R                                                          
*                                                                               
         CLI   BAND,C'D'                                                        
         BE    EZR010                                                           
         MVI   BAND,C'T'                                                        
         B     EZR010                                                           
*                                                                               
EZR040R  CLI   MEDIA,C'R'                                                       
         BNE   EZR040S                                                          
*                                                                               
         CLI   BAND,C'A'                                                        
         BE    EZR010                                                           
         CLI   BAND,C'F'                                                        
         BE    EZR010                                                           
         CLI   BAND,C'S'                                                        
         BE    EZR010                                                           
         CLI   BAND,C'C'                                                        
         BNE   EZR040X                                                          
         MVI   BAND,C'1'           RADIO BAND 'CM' SAVED AS '1'                 
         B     EZR010                                                           
*                                                                               
EZR040S  DS    0H                                                               
         MVC   BAND,MEDIA                                                       
         B     EZR010                                                           
*                                                                               
EZR040X  DS    0H                                                               
         OI    UNKNSW,UNKNSTAQ                                                  
         B     EZR010                                                           
*                                                                               
*                                                                               
         B     EZR010                                                           
*                                                                               
EZR042   DS    0H                                                               
         CLC   RECTYP,AGYRTYP      TEST AGENCY RECORD                           
         BNE   EZR044                                                           
         MVC   AGYLIN1,RFDATA      SAVE AGENCY ADDR 1                           
         B     EZR010                                                           
*                                                                               
EZR044   DS    0H                                                               
         CLC   RECTYP,INVRTYP      TEST INVOICE RECORD                          
         BNE   EZR010                                                           
         MVC   ADVNAM,RFDATA       SAVE ADVERTISER NAME                         
         B     EZR010                                                           
*                                                                               
EZR050   DS    0H                                                               
         CLI   RFFLDNO,5           FIELD 5                                      
         BNE   EZR056                                                           
         CLC   RECTYP,AGYRTYP      AGENCY RECORD                                
         BNE   EZR052                                                           
         MVC   AGYLIN2,RFDATA      SAVE AGENCY ADDR 2                           
         B     EZR010                                                           
*                                                                               
EZR052   DS    0H                                                               
         CLC   RECTYP,INVRTYP      INVOICE RECORD                               
         BNE   EZR054                                                           
         MVC   PRDNAM,RFDATA       SAVE PRODUCT NAME                            
         B     EZR010                                                           
*                                                                               
EZR054   DS    0H                                                               
         CLC   RECTYP,INTRTYP      TEST INVOICE TOTAL                           
         BNE   EZR055                                                           
*                                                                               
         CLI   RFLEN,0             IF NO INPUT                                  
         BE    EZR010               BYPASS                                      
*                                                                               
         BAS   RE,CKMINUS          CHECK FOR MINUS SIGN                         
*                                                                               
         ZIC   RF,RFLEN                                                         
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  DUB,RFDATA(0)                                                    
*                                                                               
         CLI   HOLDSIGN,C'-'       WAS THERE A MINUS                            
         BNE   *+8                  NO                                          
         XI    DUB+7,X'02'         FORCE TO MINUS VALUE                         
*                                                                               
         AP    IDOLN,DUB                                                        
         B     EZR010                                                           
*                                                                               
EZR055   CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR010                                                           
         MVC   STANAME,RFDATA      SAVE STATION NAME                            
         B     EZR010                                                           
*                                                                               
EZR056   DS    0H                                                               
         CLI   RFFLDNO,6           FIELD 6                                      
         BNE   EZR058                                                           
         CLC   RECTYP,AGYRTYP      AGENCY RECORD                                
         BNE   EZR057                                                           
         MVC   AGYLIN3,RFDATA      SAVE AGENCY ADDR 3                           
         B     EZR010                                                           
*                                                                               
EZR057   CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR010                                                           
         MVC   STALIN1,RFDATA      SAVE STATION ADDR LINE 1                     
         B     EZR010                                                           
*                                                                               
EZR058   DS    0H                                                               
         CLI   RFFLDNO,7           FIELD 7                                      
         BNE   EZR060                                                           
         CLC   RECTYP,AGYRTYP      AGENCY RECORD                                
         BNE   EZR059                                                           
         MVC   AGYLIN4,RFDATA      SAVE AGENCY ADDR 4                           
         B     EZR010                                                           
*                                                                               
EZR059   CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR010                                                           
         MVC   STALIN2,RFDATA      SAVE STATION ADDR LINE 2                     
         B     EZR010                                                           
*                                                                               
EZR060   DS    0H                                                               
         CLI   RFFLDNO,8           FIELD 8                                      
         BNE   EZR064                                                           
         CLC   RECTYP,INVRTYP      INVOICE RECORD                               
         BNE   EZR062                                                           
         MVC   ESTNO,RFDATA        SAVE ESTIMATE NUMBER                         
         B     EZR010                                                           
*                                                                               
EZR062   CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR010                                                           
         MVC   STALIN3,RFDATA      SAVE STATION ADDR LINE 3                     
         B     EZR010                                                           
*                                                                               
EZR064   DS    0H                                                               
         CLI   RFFLDNO,9           FIELD 9                                      
         BNE   EZR066                                                           
         CLC   RECTYP,INVRTYP      INVOICE HEADER RECORD                        
         BNE   EZR065                                                           
         MVC   INVNO,RFDATA        SAVE INVOICE NUMBER                          
*                                                                               
         CLI   RFLEN,11            IS INVOICE NUMBER TOO LONG                   
         BL    EZR010               NO, JUST FINE                               
         BAS   RE,FIXINVNO                                                      
         B     EZR010                                                           
*                                                                               
EZR065   CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR010                                                           
         MVC   STALIN4,RFDATA      SAVE STATION ADDR LINE 4                     
         B     EZR010                                                           
*                                                                               
EZR066   DS    0H                                                               
         CLI   RFFLDNO,10          FIELD 10                                     
         BNE   EZR068                                                           
         CLC   RECTYP,INVRTYP      INVOICE HEADER RECORD                        
         BNE   EZR067                                                           
         MVC   INVMOS,RFDATA       SAVE MONTH OF SERVICE                        
         B     EZR010                                                           
*                                                                               
EZR067   CLC   RECTYP,STARTYP      TEST STATION RECORD                          
         BNE   EZR010                                                           
         MVC   STACSYS,RFDATA      SAVE STATION COMPUTER SYSTEM                 
         B     EZR010                                                           
*                                                                               
EZR068   DS    0H                                                               
         CLI   RFFLDNO,17          FIELD 17                                     
         BNE   EZR069                                                           
         CLC   RECTYP,INVRTYP      INVOICE HEADER RECORD                        
         BNE   EZR010                                                           
         CLC   =C'BILLING INVOICE REVERSAL',RFDATA  THIS DELETE PRE INV         
         BNE   EZR010                                NO                         
         MVI   INVDEL,C'Y'         SET AS DELETE PREV INV                       
         L     RF,TDELINV          BUMP DEL PREV INVOICE COUNT                  
         LA    RF,1(,RF)                                                        
         ST    RF,TDELINV                                                       
         B     EZR010                                                           
*                                                                               
EZR069   DS    0H                                                               
         CLI   RFFLDNO,22          FIELD 22                                     
         BNE   EZR069A                                                          
         CLC   RECTYP,INVRTYP      INVOICE HEADER RECORD                        
         BNE   EZR010                                                           
         MVC   REPORDER,RFDATA     SAVE REP ORDER NUMBER                        
*                                                                               
EZR069A  DS    0H                                                               
         CLI   RFFLDNO,23          FIELD 23                                     
         BNE   EZR070                                                           
         CLC   RECTYP,INVRTYP      INVOICE HEADER RECORD                        
         BNE   EZR010                                                           
         MVC   STAORDER,RFDATA     SAVE STATION ORDER NUMBER                    
*                                                                               
EZR070   DS    0H                                                               
         CLI   RFFLDNO,25          FIELD 25                                     
         BNE   EZR074                                                           
         CLC   RECTYP,INVRTYP      TEST INVOICE HEADER                          
         BNE   EZR010                                                           
         MVC   ADVCD,RFDATA        SAVE INTERNAL ADVERTISER CODE                
         B     EZR010                                                           
*                                                                               
EZR074   DS    0H                                                               
         CLI   RFFLDNO,27          FIELD 27                                     
         BNE   EZR076                                                           
         CLC   RECTYP,INVRTYP      TEST INVOICE HEADER                          
         BNE   EZR010                                                           
         MVC   PRDCD,RFDATA        SAVE INTERNAL PRODUCT CODE                   
         B     EZR010                                                           
*                                                                               
EZR076   DS    0H                                                               
         CLI   RFFLDNO,31          FIELD 31                                     
         BNE   EZR080                                                           
         CLC   RECTYP,INVRTYP      TEST INVOICE HEADER                          
         BNE   EZR010                                                           
         MVC   STANET,RFDATA       SAVE CABLE HEAD NETWORK                      
         B     EZR010                                                           
*                                                                               
EZR080   DS    0H                                                               
         CLI   RFFLDNO,40          FIELD 40 MAX EXPECTED                        
         BNH   EZR010                                                           
*                                                                               
         MVC   ERRLINE,=CL132'MORE THAN 40 FIELDS'                              
         B     FATALERR                                                         
*                                                                               
* END OF INPUT EZHOLDR FILE, THEN EASI TAPE *                                   
*                                                                               
EZR090   DS    0H                  EOFILE                                       
*                                                                               
* PUT CHECK HERE FOR EZHOLD FILE, IF SO CLOSE IT,                               
* RESET SOURCE, AND START READING AEZINPT                                       
*                                                                               
         OC    SVSRCE,SVSRCE       ARE WE WORKING ON HOLD FILE                  
         BZ    EZR096                                                           
*                                                                               
         MVC   SOURCE,SVSRCE   RESTORE SOURCE TO ORIGINAL (SRCE= CARD)          
         MVI   TOSVMED,C'N'                                                     
         XC    SVSRCE,SVSRCE       ZERO OUT SOURCE                              
         XC    HOLDDATE,HOLDDATE        AND DATE                                
         XC    OLDSTA,OLDSTA       FORCE CHANGE OF STATION                      
         XC    OLDAGY,OLDAGY       AND AGENCY                                   
*                                                                               
         L     R2,=A(EZHOLDR)                                                   
         CLOSE ((R2),)                                                          
*                                                                               
         NI    RFCTL2,X'FF'-RFCTL2EF     SET OFF DO EOFILE AFTER                
         NI    RFCTL,X'FF'-RFCTLEOF      SET OFF EOFILE                         
         OI    SVRECSW,SVRECSRC          SET NEED TO SAVE SOURCE & DATE         
         B     EZREAD                                                           
*                                                                               
EZR096   DS    0H                  EOFILE                                       
         BAS   RE,ENDINV           FINISH ANY OLD INVOICE                       
         MVC   OLDSRC,SOURCE                                                    
*                                                                               
         MVC   SVUSID,USID        SAVE LAST ID                                  
         MVC   SVEXCLSW,EXCLSW    SAVE LAST EXCLUDE SW STATE                    
*                                                                               
         GOTO1 =A(ENDBTCH),DMCB,(RC)  PROCESS END OF BATCH                      
*                                                                               
         L     R2,AEZINPT                                                       
         CLOSE ((R2),)                                                          
*                                                                               
         MVC   LINE,=PL2'200'      FORCE NEW PAGE                               
*                                                                               
         SR    R2,R2                                                            
         CLI   TEST,C'Y'           THIS A TEST RUN                              
         BE    EZR110                                                           
*                                                                               
         L     R2,=A(EZBILLF)                                                   
         CLOSE ((R2),)                                                          
*                                                                               
         L     R2,=A(EZWORKW)                                                   
         CLOSE ((R2),)                                                          
         FREEPOOL (R2)                                                          
*                                                                               
         SR    R2,R2                                                            
         LM    R3,R4,=A(EZWORKR,EZHOLDW)                                        
*                                                                               
         OPEN  ((R3),(INPUT))                                                   
         LTR   RF,RF               WAS OPEN GOOD                                
         BZ    *+6                                                              
         DC    H'0'                                                             
         OPEN  ((R4),(OUTPUT))                                                  
         LTR   RF,RF               WAS OPEN GOOD                                
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R5,=A(EZINREC)                                                   
         XC    0(256,R5),0(R5)                                                  
*                                                                               
EZR100   DS   0H                                                                
         GET   (R3),(R5)                                                        
*                                                                               
         LA    R2,1(,R2)                                                        
*                                                                               
         CLI   TRACEHLD,C'Y'                                                    
         BNE   EZR104                                                           
         CVD   R2,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+1(4),DUB                                                       
         LH    R0,0(R5)                                                         
         SH    R0,=H'4'                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         CH    R0,=H'372'                                                       
         BNH   *+6                                                              
         DC    H'0'                                                             
         UNPK  P+6(3),DUB                                                       
         MVC   P+10(3),=C'LEN'                                                  
         MVI   P+14,C'H'                                                        
         MVC   P+16(80),4(R5)                                                   
         OC    P+16(80),SPACES                                                  
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR104   DS   0H                                                                
         PUT   (R4),(R5)                                                        
         XC    0(256,R5),0(R5)                                                  
         B     EZR100                                                           
*                                                                               
EOFWORK  DS    0H                                                               
         CLOSE ((R3),)                                                          
*                                                                               
         LTR   R2,R2               ANY HOLD RECS                                
         BZ    EZR108               NO                                          
*                                                                               
* WRITE OUT '12' TOTALS RECORD FOR CONTENTS OF HOLD FILE *                      
*                                                                               
         XC    0(256,R5),0(R5)                                                  
         MVI   1(R5),26                                                         
         MVC   4(3,R5),=X'F1F25E'                                               
*                                                                               
         L     RF,HOINVS                                                        
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  7(5,R5),DUB                                                      
         MVI   12(R5),X'5E'                                                     
*                                                                               
         OI    HODOLG+7,X'0F'                                                   
         UNPK  13(11,R5),HODOLG                                                 
         MVC   24(2,R5),=X'5E15'                                                
*                                                                               
         CLI   TRACEHLD,C'Y'                                                    
         BNE   EZR106                                                           
         LA    RF,1(,R2)                                                        
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+1(4),DUB                                                       
         LH    R0,0(R5)                                                         
         SH    R0,=H'4'                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         CH    R0,=H'372'                                                       
         BNH   *+6                                                              
         DC    H'0'                                                             
         UNPK  P+6(3),DUB                                                       
         MVC   P+10(3),=C'LEN'                                                  
         MVI   P+14,C'H'                                                        
         MVC   P+16(80),4(R5)                                                   
         OC    P+16(80),SPACES                                                  
*                                                                               
EZR106   DS   0H                                                                
         PUT   (R4),(R5)                                                        
*                                                                               
EZR108   DS   0H                                                                
         CLOSE ((R4),)                                                          
*                                                                               
         CLI   NOHOLDCK,C'Y'                                                    
         BE    EZR110                                                           
*                                                                               
         L     R1,WORKCT                                                        
         A     R1,WORKCT9                                                       
         CR    R2,R1                                                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
EZR110   DS   0H                                                                
         GOTO1 =A(RUNTOT),DMCB,(RC)                                             
*                                                                               
         B     EOJ                                                              
*                                                                               
JOBNAME  DC    CL8'        '                                                    
*                                                                               
*                                                                               
* CHECK STATION FOR NUMERICS, AND IF SO, FORCE TO 4 DIGITS                      
*                                                                               
         DS    0H                                                               
CKSTA    NTR1                                                                   
         CLI   RFDATA,4            IF ALREADY 4 CHARACTERS, DONE                
         BE    EXIT                                                             
*                                                                               
         ZIC   R0,RFLEN                                                         
         LA    R1,RFDATA                                                        
CKSTA10  CLI   0(R1),C'0'          SEE IF ALL NUMERIC                           
         BL    EXIT                 NO, GET OUT                                 
         LA    R1,1(,R1)                                                        
         BCT   R0,CKSTA10                                                       
*                                                                               
         MVC   STATION,=C'0000'    PRE FILL ZEROS                               
         ZIC   RF,RFLEN                                                         
         LA    RE,RFDATA-1(RF)     START FROM END OF FIELD                      
*                                                                               
         CLI   RFLEN,4             CAN'T MOVE MORE THAN 4                       
         BNH   *+8                                                              
         LA    RF,4                                                             
*                                                                               
         LA    R1,STATION+3        ALSO START FROM END                          
CKSTA20  MVC   0(1,R1),0(RE)                                                    
         BCTR  R1,0                                                             
         BCTR  RE,0                                                             
         BCT   RF,CKSTA20                                                       
         B     EXIT                                                             
*                                                                               
* INVOICE # IS MORE THAN 10 BYTES, REMOVE ANY BLANKS/ SPEC CHAR                 
* AND REFORMAT 31 (INV HDR) RECORD                                              
*                                                                               
FIXINVNO NTR1                                                                   
         ZIC   R0,RFLEN                                                         
         LA    R1,RFDATA                                                        
         LA    RE,WORK                                                          
         SR    RF,RF                                                            
         XC    WORK,WORK                                                        
FXI010   CLI   0(R1),C' '          DROP SPACES                                  
         BE    FXI020                                                           
         CLI   0(R1),C'-'          AND DASHES                                   
         BE    FXI020                                                           
         MVC   0(1,RE),0(R1)                                                    
         LA    RE,1(,RE)                                                        
         LA    RF,1(,RF)           ADD TO COUNT                                 
*                                                                               
FXI020   LA    R1,1(,R1)                                                        
         BCT   R0,FXI010                                                        
*                                                                               
         STC   RF,BYTE             STORE NEW LEN                                
*                                                                               
         CLI   BYTE,10             THIS GET IT UNDER 10                         
         BH    EXIT                 NO, CAN'T FIX IT                            
*                                                                               
         STC   RF,RFLEN                                                         
         MVC   OLDINVNO,RFDATA                                                  
         MVC   INVNO,WORK                                                       
         XC    RFDATA,RFDATA                                                    
         MVC   RFDATA(L'WORK),WORK                                              
*                                                                               
         L     R2,WRCURPOS                                                      
         LH    R1,WLEN                                                          
         SR    R2,R1                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         XC    0(0,R2),0(R2)       CLEAR INV NO + 1                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),WORK        MOVE IN SHORTER INV NO                       
*                                                                               
         LA    R6,1(R2,RF)                                                      
         MVC   0(L'FDELIM,R6),FDELIM                                            
         LA    RF,L'FDELIM+1(,RF)      ADD LENGTH                               
         LA    R2,0(R2,RF)                                                      
         STH   RF,WLEN               SET WORK FIELD LENGTH                      
         ST    R2,WRCURPOS                                                      
         B     EXIT                                                             
*                                                                               
*        ENDREC - ROUTINE AT END OF RECORD                                      
*                                                                               
         DS    0H                                                               
ENDREC   NTR1                                                                   
*        CLC   RECTYP,IDBTYP       IDB NUMBER                                   
*        BE    ENDRX                                                            
*        CLC   RECTYP,VERTYP       INVOICE VERSION NUMBER                       
*        BE    ENDRX                                                            
*                                                                               
         CLC   RECTYP,STARTYP      STATION?                                     
         BNE   ENDR10                                                           
         CLC   BAND,SPACES                                                      
         BH    ENDR10                                                           
         OI    UNKNSW,UNKNSTAQ                                                  
*                                                                               
ENDR10   DS    0H                                                               
         L     RF,WRCURPOS         CURRENT POS                                  
         S     RF,WRECST           LESS REC START                               
         BNP   ENDRX               = RECORD LENGTH (SKIP IF NONE)               
         ST    RF,RECLEN                                                        
*                                                                               
         BAS   RE,SAVREC           SAVE SOME RECORDS                            
         CLI   SAVSW,C'Y'          IF SAVED THIS REC, DONE                      
         BE    ENDRX                YES                                         
*                                                                               
*                                  ELSE WRITE TO FILE                           
*                                                                               
         BAS   RE,PUTSAV           DO SAVED RECORDS FIRST                       
*                                                                               
         CLI   SAVSW,C'Y'          IF SAVED THIS REC, DONE                      
         BE    ENDRX                DON'T PUT IT TO WORKER FILE                 
*                                                                               
         L     R1,WKRREC           THEN THIS ONE                                
         BAS   RE,SAVRN            MOVE TO RECORD AREA                          
         BAS   RE,INVPROC          HANDLE INVOICE HEADER REC                    
*                                                                               
         CLC   RECTYP,TRTOTYP      TEST TRANSMISSION TOTAL REC                  
         BE    ENDRX                DON'T PUT IT TO WORKER FILE                 
*        CLC   RECTYP,IDBTYP       TEST IDB NUMBER RECORD                       
*        BE    ENDRX                DON'T PUT IT TO WORKER FILE                 
*                                                                               
         BAS   RE,ADDWKR                                                        
*                                                                               
ENDRX    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
*        SAVREC - SAVE CERTAIN RECORDS                                          
*                                                                               
SAVREC   DS    0H                                                               
         MVI   SAVSW,C'Y'          SET HAVE SAVED                               
*                                                                               
         CLC   RECTYP,SRCETYP      THIS A SOURCE RECORD (HOLD FILE)             
         BER   RE                   ALREADY SAVED, DO NOT PROCESS               
*                                                                               
         CLC   RECTYP,STARTYP      STATION RECORD                               
         BNE   SAVR20                                                           
         L     R1,=A(SAVSTA)                                                    
         OI    SVRECSW,SVRECSTA                                                 
         B     SAVRN                                                            
*                                                                               
SAVR20   DS    0H                                                               
         CLC   RECTYP,VERTYP       INVOICE VERSION NUMBER                       
         BNE   SAVR30                                                           
         L     R1,=A(SAVVER)                                                    
         OI    SVRECSW,SVRECVER                                                 
         B     SAVRN                                                            
*                                                                               
SAVR30   DS    0H                                                               
         CLC   RECTYP,PAYRTYP      PAYEE                                        
         BNE   SAVR40                                                           
         L     R1,=A(SAVPAY)                                                    
         OI    SVRECSW,SVRECPAY                                                 
         B     SAVRN                                                            
*                                                                               
SAVR40   DS    0H                                                               
         CLC   RECTYP,AGYRTYP      AGENCY                                       
         BNE   SAVR60                                                           
         L     R1,=A(SAVAGY)                                                    
         OI    SVRECSW,SVRECAGY                                                 
         B     SAVRN                                                            
*                                                                               
SAVR60   DS    0H                                                               
         CLC   RECTYP,SCTRTYP      STANDARD COMMENT TOP                         
         BNE   SAVR70                                                           
*                                                                               
         L     R1,=A(SAVSCT)                                                    
         LA    R0,5                SAVE 5 MAX                                   
SAVR66   OC    0(140,R1),0(R1)                                                  
         BZ    SAVR68                                                           
         LA    R1,140(,R1)                                                      
         BCT   R0,SAVR66                                                        
         SH    R1,=H'140'          STORE ALL OVER 5 IN LAST SLOT                
*                                                                               
SAVR68   OI    SVRECSW,SVRECSCT                                                 
         B     SAVRN                                                            
*                                                                               
SAVR70   DS    0H                                                               
         CLC   RECTYP,SCBRTYP      STANDARD COMMENT BOTTOM                      
         BNE   SAVR80                                                           
*                                                                               
         L     R1,=A(SAVSCB)                                                    
         LA    R0,5                SAVE 5 MAX                                   
SAVR76   OC    0(140,R1),0(R1)                                                  
         BZ    SAVR78                                                           
         LA    R1,140(,R1)                                                      
         BCT   R0,SAVR76                                                        
         SH    R1,=H'140'          STORE ALL OVER 5 IN LAST SLOT                
*                                                                               
SAVR78   OI    SVRECSW,SVRECSCB                                                 
         B     SAVRN                                                            
*                                                                               
SAVR80   DS    0H                                                               
         CLC   RECTYP,IDBTYP      76 RECORD?                                    
         BNE   SAVR90                                                           
         L     R1,=A(SAVIDB)                                                    
         OI    SVRECSW,SVRECIDB                                                 
         B     SAVRN                                                            
*                                                                               
SAVR90   DS    0H                                                               
         MVI   SAVSW,C'N'          SET NOT SAVED                                
         BR    RE                                                               
*                                                                               
         DS    0H                                                               
SAVRN    NTR1                                                                   
         L     RE,WRECST           START OF RECORD = FROM ADDRESS               
         L     RF,RECLEN           FROM LENGTH                                  
         LA    RF,4(RF)                                                         
         CH    RF,=H'1024'         CANNOT BE MORE THAN 1024                     
         BNH   *+6                                                              
         DC    H'0'                FOR NOW BLOW UP                              
         STH   RF,0(R1)                                                         
         SH    RF,=H'4'                                                         
         LA    R0,4(R1)            TO ADDRESS                                   
         LA    R1,1020             TO LENGTH                                    
*                                                                               
         CLC   RECTYP,SCBRTYP      STANDARD COMMENT BOTTOM                      
         BE    SAVRN10                                                          
         CLC   RECTYP,SCTRTYP      STANDARD COMMENT TOP                         
         BNE   SAVRN20                                                          
*                                                                               
SAVRN10  LA    R1,140              TO LENGTH                                    
*                                                                               
SAVRN20  MVCL  R0,RE                                                            
*                                                                               
         CR    RD,RD               SET CC =                                     
         B     EXIT                                                             
*                                                                               
*        PUTSAV - PUT SAVED RECORDS                                             
*                                                                               
         DS    0H                                                               
PUTSAV   NTR1                                                                   
         TM    SVRECSW,SVRECIDB    TEST NEED 76 (IDF) RECORD                    
         BZ    PSV10                                                            
         NI    SVRECSW,X'FF'-SVRECIDB                                           
         L     R2,=A(SAVIDB)       STATION - FROM ADDRESS                       
*                                                                               
         LTR   R2,R2               IS THERE A SAVED IDB RECORD?                 
         BZ    PSV10               NO - DON'T LOAD IT                           
*                                                                               
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,SAVIDBLN         TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
PSV10    DS    0H                                                               
         TM    SVRECSW,SVRECAGY    TEST NEED AGENCY                             
         BZ    PSV20                                                            
         NI    SVRECSW,X'FF'-SVRECAGY                                           
         L     R2,=A(SAVAGY)       AGENCY - FROM ADDRESS                        
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,SAVAGYLN         TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
PSV20    DS    0H                                                               
         TM    SVRECSW,SVRECSTA    TEST NEED STATION                            
         BZ    PSV40                                                            
         NI    SVRECSW,X'FF'-SVRECSTA                                           
         L     R2,=A(SAVSTA)       STATION - FROM ADDRESS                       
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,SAVSTALN         TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
PSV40    DS    0H                                                               
         TM    SVRECSW,SVRECPAY    TEST NEED PAYEE                              
         BZ    PSV60                                                            
         NI    SVRECSW,X'FF'-SVRECPAY                                           
         L     R2,=A(SAVPAY)       PAYEE - FROM ADDRESS                         
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,SAVPAYLN         TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
PSV60    DS    0H                                                               
         TM    SVRECSW,SVRECSCT    TEST NEED STD CMT TOP                        
         BZ    PSV70                                                            
         NI    SVRECSW,X'FF'-SVRECSCT                                           
         L     R2,=A(SAVSCT)       STD CMT TOP - FROM ADDRESS                   
         LA    R4,5                MAX RECS                                     
*                                                                               
PSV64    LR    R6,R2                                                            
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,140              TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
         LA    R2,140(R6)                                                       
         OC    0(140,R2),0(R2)     ANOTHER REC                                  
         BZ    PSV70                NO                                          
         BCT   R4,PSV64                                                         
*                                                                               
PSV70    DS    0H                                                               
         TM    SVRECSW,SVRECSCB    TEST NEED STD CMT BOTTOM                     
         BZ    PSV80                                                            
         NI    SVRECSW,X'FF'-SVRECSCB                                           
         L     R2,=A(SAVSCB)       STD CMT BOT - FROM ADDRESS                   
         LA    R4,5                MAX RECS                                     
*                                                                               
PSV74    LR    R6,R2                                                            
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,140              TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
         LA    R2,140(R6)                                                       
         OC    0(140,R2),0(R2)     ANOTHER REC                                  
         BZ    PSV80                NO                                          
         BCT   R4,PSV74                                                         
*                                                                               
PSV80    DS    0H                                                               
         TM    SVRECSW,SVRECVER    TEST NEED INVOICE VERSION                    
         BZ    PSV90                                                            
         NI    SVRECSW,X'FF'-SVRECVER                                           
         L     R2,=A(SAVVER)       VERSION - FROM ADDRESS                       
         LH    R3,0(R2)            FROM LENGTH                                  
         L     R0,WKRREC           TO ADDRESS                                   
         LA    R1,SAVVERLN         TO LENGTH                                    
         MVCL  R0,R2                                                            
         BAS   RE,ADDWKR                                                        
*                                                                               
PSV90    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
*        INVPROC - HANDLE INVOICE HEADER RECORD                                 
*                (ADD 12 BYTE STATUS FIELD + DELIMITER, AND PRINT)              
*                                                                               
INVPROC  DS    0H                                                               
         CLC   RECTYP,INVRTYP      TEST INVOICE HEADER                          
         BNER  RE                                                               
*                                                                               
         DS    0H                                                               
INVP     NTR1                                                                   
         L     RF,BINVS            BUMP INVOICE COUNT                           
         LA    RF,1(RF)                                                         
         ST    RF,BINVS                                                         
*                                                                               
* CHECK IF THERE ARE 36 FIELDS.  IF LESS - INSERT SEMICOLONS                    
         L     R2,WKRREC           FROM WKRREC                                  
         LH    R1,0(R2)            REC LEN                                      
         AR    R1,R2               R1 POINTS TO THE END OF RECORD               
         LA    R2,4(R2)            SKIP THE 4 REC LENGTH BYTES                  
         SR    R0,R0               FIELD COUNTER = FIELDS PROCESSED             
*                                                                               
INVP10   CR    R2,R1               REACHED EOR?                                 
         BNL   INVP15              YES=FEWER THAN 35 FIELDS, ADD SEMIS          
         CLC   0(1,R2),RDELIM      EOR?                                         
         BE    INVP15                                                           
         CLC   0(1,R2),FDELIM      EOF?                                         
         BNE   INVP12                                                           
         AHI   R0,1                YES, INCREMENT FIELD COUNTER                 
         CHI   R0,35               ARE WE AT FLD 36? (35 ALREADY DONE)          
         BL    INVP12              NO                                           
* ADVANCE TO EITHER THE DELIMITER *AFTER* FIELD 36 OR TO THE                    
* FIRST CHARACTER OF THIS FIELD                                                 
         LA    R2,1(R2)                                                         
         B     INVP20                                                           
*                                                                               
INVP12   LA    R2,1(R2)            NO, MOVE ON TO NEXT CHARACTER                
         B     INVP10                                                           
*                                                                               
* REACHED EOR BEFORE ENCOUNTERING FIELD 36 HERE                                 
* R2 POINTS TO EITHER X'15', LAST SEMICOLON OR                                  
INVP15   DS    0H                                                               
         L     RF,WKRREC           ORIGINAL RECORD                              
         LH    RE,0(RF)            LENGTH                                       
         CLC   0(1,R2),RDELIM      EOR?                                         
         BNE   *+6                                                              
* DECREMENT LENGTH. REC DELIM IS REPLACED WITH FIELD DELIM HERE,                
* BUT IT WILL BE ADDED LATER, AND LENGTH UPDATED ACCORDINGLY                    
         BCTR  RE,0                                                             
*                                                                               
INVP17   DS    0H                  REACHED EOR BEFORE FIELD 36 HERE             
         MVC   0(1,R2),FDELIM      PUT A SEMICOLON IN                           
         AHI   RE,1                INCREMENT REC LEN                            
         AHI   R0,1                FIELD COUNTER                                
         LA    R2,1(R2)            ADVANCE TO NEXT CHARACTER                    
         CHI   R0,35               ARE WE AT FIELD 36 YET?                      
         BL    INVP17                                                           
*                                                                               
* REACHED FIELD 36 HERE                                                         
         MVC   0(1,R2),RDELIM      RECORD DELIMITER                             
         AHI   RE,1                UPDATE REC LEN                               
         STH   RE,0(RF)                                                         
*                                                                               
* AT THIS POINT WE SHOULD HAVE AT LEAST 35 SEMICOLON-DELIMITED FIELDS           
* R2 ADDRESSES DELIMITER AFTER FIELD 36, OR ITS FIRST CHARACTER                 
*                                                                               
INVP20   DS    0H                                                               
         L     R4,WKRREC                                                        
         SR    R4,R2                                                            
         LPR   R4,R4               R4 = DISPLACEMENT OF FIELD 36                
*                                                                               
* MAKE A COPY OF THE INV HEADER RECORD                                          
*                                                                               
         L     R2,WKRREC           FROM WKRREC                                  
         LH    R3,0(R2)            FROM LENGTH                                  
         CH    R3,=H'1024'         MAX LENGTH                                   
         BL    *+6                                                              
         DC    H'0'                                                             
         L     R0,=A(RECWRK)       TO WORK AREA                                 
         LR    R1,R3               TO LENGTH                                    
         MVCL  R0,R2                                                            
*                                                                               
         L     R2,WKRREC                                                        
         CLC   6(1,R2),FDELIM      FIELD DELIMITER AFTER REC CODE               
         BE    *+6                 AT END OF REC CODE                           
         DC    H'0'                BAD RECORD                                   
*                                                                               
         XC    7(12,R2),7(R2)      SET TWELVE BYTE STATUS FIELD                 
         OI    7(R2),X'80'         EZMOD DROPS LEADING BLANKS                   
*                                                                               
         CLI   IDBFLAG,C'Y'                                                     
         BNE   *+8                                                              
         OI    7(R2),X'01'         INVOICE CAME FROM IM                         
*                                                                               
         MVC   19(1,R2),FDELIM                                                  
*                                                                               
         LH    RF,0(R2)            BUMP RECORD LENGTH                           
         LA    RF,13(RF)                                                        
         STH   RF,0(R2)                                                         
*                                                                               
         LA    R0,20(R2)           TO ADDRESS                                   
         L     R2,=A(RECWRK)                                                    
         LH    R3,0(R2)                                                         
         LA    R2,7(,R2)           FROM ADDRESS                                 
         SH    R3,=H'7'            FROM LENGTH                                  
         LR    R1,R3               TO LENGTH = FROM LENGTH                      
         CH    R3,=H'1024'                                                      
         BL    *+6                                                              
         DC    H'0'                                                             
         MVCL  R0,R2                                                            
*                                                                               
* INSERT THE SECOND SAVE FIELD AT COLUMN 36. R4 SHOULD HAVE ITS DISPL           
*                                                                               
         L     R1,WKRREC           RECORD BUILD AREA                            
         LH    R0,0(R1)            BUMP RECORD LENGTH                           
         AHI   R0,13                                                            
         STH   R0,0(R1)                                                         
         CHI   R0,1024                                                          
         BL    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R1,0(R1,R4)         A(FIELD 36) IN REC BUILD AREA                
* NEW RECORD HAS EXTRA 12-BYTE FIELD + DELIMITER                                
         AHI   R1,13                                                            
         XC    0(12,R1),0(R1)                                                   
         MVC   12(1,R1),FDELIM                                                  
*                                                                               
         CLC   SVRECTYP,VERTYP                                                  
         BNE   *+10                                                             
         MVC   9(1,R1),INVVER                                                   
*                                                                               
* COPY THE REST OF THE RECORD                                                   
         LA    R0,13(R1)           R0 = "TO" ADDRESS                            
         L     R2,=A(RECWRK)       R2 = "FROM" ADDRESS                          
         LH    R1,0(R2)            R1=REC LEN                                   
         AR    R2,R4               R2 = FIELD 36 IN "FROM" RECORD               
*                                                                               
         SR    R1,R4               REC LEN - A(FIELD 36)                        
         LR    R3,R1                                                            
         CHI   R1,0                                                             
         BH    *+6                                                              
         DC    H'0'     THERE SHOULD BE AT LEAT THE EOR DELIMITER               
         MVCL  R0,R2                                                            
*                                                                               
         B     EXIT                                                             
*                                                                               
*        ENDINV  - END OF AN INVOICE                                            
*                                                                               
ENDINV   DS    0H                                                               
*                                                                               
         CLI   TOSVMED,C'Y'                                                     
         BNE   *+10                                                             
         MVC   OLDMEDIA,MEDIA                                                   
         MVI   TOSVMED,C'Y'                                                     
*                                                                               
         OC    INVFLDS(INVFLDLQ),INVFLDS                                        
         BZR   RE                                                               
*                                                                               
         DS    0H                                                               
ENDI     NTR1                                                                   
         CLI   EXCLSW,C'N'         SKIP EXPRESSLY EXCLUDED BATCHES              
         BE    ENDI01                                                           
*                                                                               
         MVC   ILADV,ADVNAM                                                     
         MVC   ILADVCD,ADVCD                                                    
         MVC   ILPRD,PRDNAM                                                     
         MVC   ILPRDCD,PRDCD                                                    
         MVC   ILINV,INVNO                                                      
         MVC   ILMOS,INVMOS                                                     
         GOTO1 =V(PRINTER)                                                      
         B     ENDI40                                                           
*                                                                               
ENDI01   DS    0H                                                               
         MVC   ILADV,ADVNAM                                                     
         MVC   ILPRD,PRDNAM                                                     
         MVC   ILINV,INVNO                                                      
*                                                                               
         OC    OLDINVNO,OLDINVNO   WAS INV # LONGER THAN 10                     
         BZ    *+10                                                             
         MVC   ERRLINE+ILINV-5-P(20),OLDINVNO                                   
*                                                                               
         MVC   ILMOS,INVMOS                                                     
*                                                                               
         CLI   INVDEL,C'Y'         SET AS DELETE PREV INV                       
         BNE   ENDI02                                                           
         MVC   ERRLINE(32),=C'* NOTE * DELETE PREVIOUS INVOICE'                 
*                                                                               
ENDI02   OC    ADVCD,ADVCD         ANY ADVERTISER CODE                          
         BZ    ENDI10                                                           
         MVC   ILADVCD,ADVCD                                                    
*                                                                               
* CHECK FOR OBVIOUS ERRORS *                                                    
*                                                                               
         LA    R1,ADVCD                                                         
         BRAS  RE,CHK3COD                                                       
         BNE   ENDI08                                                           
*                                                                               
ENDI06   L     R1,TCLTCDS                                                       
         LA    R1,1(,R1)                                                        
         ST    R1,TCLTCDS                                                       
         B     ENDI10                                                           
*                                                                               
ENDI08   MVC   ERRLINE+ILADVCD-P(3),=C'***'                                     
*                                                                               
ENDI10   OC    PRDCD,PRDCD         ANY PRODUCT CODE(S)                          
         BZ    ENDI20                                                           
         MVC   ILPRDCD,PRDCD                                                    
*                                                                               
* CHECK FOR OBVIOUS ERRORS *                                                    
*                                                                               
         LA    R1,PRDCD                                                         
         BRAS  RE,CHK3COD                                                       
         BNE   ENDI12                                                           
*                                                                               
ENDI11   L     R1,TPRDCDS                                                       
         LA    R1,1(,R1)                                                        
         ST    R1,TPRDCDS                                                       
         B     ENDI13                                                           
*                                                                               
ENDI12   MVC   ERRLINE+ILPRDCD-P(3),=C'***'                                     
*                                                                               
ENDI13   LA    R0,8                                                             
         LA    RF,PRDCD                                                         
*                                                                               
ENDI14   CLI   0(RF),C' '          LOOK FOR BLANK SEPARATOR                     
         BNH   *+16                                                             
         LA    RF,1(,RF)                                                        
         BCT   R0,ENDI14                                                        
         B     ENDI20                                                           
         LA    RF,1(,RF)                                                        
         BCTR  R0,0                                                             
         LTR   R0,R0                                                            
         BZ    ENDI20           GET OUT IF END OF FIELD                         
*                                                                               
ENDI16   CLI   0(RF),C' '          LOOK FOR NON-BLK PROD2                       
         BH    *+16                                                             
         LA    RF,1(,RF)                                                        
         BCT   R0,ENDI16                                                        
         B     ENDI20                                                           
*                                                                               
         XC    WORK,WORK                                                        
         LA    RE,WORK                                                          
         MVC   0(1,RE),0(RF)                                                    
         LA    RE,1(,RE)                                                        
         LA    RF,1(,RF)                                                        
         BCT   R0,*-14                                                          
*                                                                               
         LA    R1,WORK                                                          
         BRAS  RE,CHK3COD                                                       
         BE    ENDI20                                                           
*                                                                               
*                                                                               
ENDI18   MVC   ERRLINE+ILPRDCD-P(3),=C'***'                                     
*                                                                               
ENDI20   OC    ESTNO,ESTNO         ANY ESTIMATE                                 
         BZ    ENDI30                                                           
         MVC   ILEST,ESTNO                                                      
         XC    FULL,FULL                                                        
         LA    R0,10                                                            
         LA    R1,FULL                                                          
         LA    RE,ESTNO                                                         
         LA    RF,3                                                             
         MVI   BYTE,0                                                           
*                                                                               
         CLI   0(RE),C' '                                                       
         BH    ENDI21                                                           
         LA    RE,1(,RE)                                                        
         BCT   R0,*-12                                                          
*                                                                               
         DC    H'0'                                                             
*                                                                               
ENDI21   CLI   0(RE),C'0'                                                       
         BNE   ENDI22                                                           
         LA    RE,1(,RE)                                                        
         BCT   R0,*-12                                                          
         MVI   BYTE,1                                                           
         B     ENDI26                                                           
*                                                                               
ENDI22   CLI   0(RE),C'0'                                                       
         BL    ENDI24                                                           
         CLI   0(RE),C'9'                                                       
         BH    ENDI25                                                           
         MVC   0(1,R1),0(RE)                                                    
         LA    R1,1(,R1)                                                        
         LA    RE,1(,RE)                                                        
         BCT   RF,*+8              GET FIRST 3 DIGITS ONLY                      
         B     ENDI24                                                           
         BCT   R0,ENDI22           ALLOW MAX EST FIELD LENGTH                   
*                                                                               
ENDI24   LA    R0,3                                                             
         LA    R1,FULL                                                          
         SR    RF,RF                                                            
         CLI   0(R1),0                                                          
         BE    *+14                                                             
         LA    R1,1(,R1)                                                        
         BCTR  RF,0                                                             
         BCT   R0,*-14                                                          
         LPR   RF,RF                                                            
         BZ    ENDI28                                                           
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  DUB,FULL(0)                                                      
         CVB   R0,DUB                                                           
         CH    R0,=H'256'                                                       
         BL    ENDI26                                                           
*                                                                               
ENDI25   MVI   BYTE,1                                                           
*                                                                               
ENDI26   DS    0H                                                               
         CLI   BYTE,1                                                           
         BNE   ENDI29                                                           
*                                                                               
ENDI28   MVC   ERRLINE+ILEST-P(3),=C'***'                                       
         B     ENDI30                                                           
*                                                                               
ENDI29   L     R1,TESTCDS                                                       
         LA    R1,1(,R1)                                                        
         ST    R1,TESTCDS                                                       
*                                                                               
ENDI30   DS    0H                                                               
         L     R2,ISPTS                                                         
         LA    R3,ILSPTS                                                        
         BAS   RE,EDIT0                                                         
*                                                                               
         LA    R2,IDOLN                                                         
         LA    R3,ILDOLS                                                        
         BAS   RE,EDITP                                                         
*                                                                               
         MVC   ILNET,STANET                                                     
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CLI   INVDEL,C'Y'         SET AS DELETE PREV INV                       
         BNE   ENDI34                                                           
         CP    IDOLG,=P'0'         WAS THIS ZERO INVOICE                        
         BE    ENDI34               YES                                         
         MVC   ERRLINE+ILDOLS-P-14(26),=C'ERROR-DEL INV MUST BE ZERO'           
*                                                                               
ENDI34   OC    ERRLINE,ERRLINE                                                  
         BZ    ENDI40                                                           
         MVC   P,ERRLINE                                                        
         XC    ERRLINE,ERRLINE                                                  
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDI40   DS    0H                                                               
         OC    SVSRCE,SVSRCE       ARE WE WORKING ON HOLD FILE                  
         BNZ   ENDI50                                                           
*                                                                               
         CLI   EXCLSW,C'Y'         BAD BATCH                                    
         BE    ENDI50                                                           
         CLI   EXCLSW,C'*'         UNKNOWN AGENCY                               
         BE    ENDI50                                                           
         CLI   EXCLSW,C'I'         EXCLUDE USER ID                              
         BE    ENDI50                                                           
         CLI   EXCLSW,C'S'         EXCLUDE STATION                              
         BE    ENDI50                                                           
*                                                                               
         L     RF,=A(MOSTABLE)                                                  
         LA    RE,MOSTABLN                                                      
*                                                                               
CTMOS10  DS    0H                                                               
         OC    0(4,RF),0(RF)                                                    
         BZ    CTMOS20                                                          
         CLC   SVINVMOS,0(RF)                                                   
         BE    CTMOS30                                                          
         LA    RF,6(,RF)           NEXT ENTRY                                   
         BCT   RE,CTMOS10                                                       
         DC    H'0'                MAKE MOSTABLE LARGER                         
*                                                                               
CTMOS20  MVC   0(4,RF),SVINVMOS                                                 
*                                                                               
CTMOS30  DS    0H                                                               
         LH    R1,4(RF)                                                         
         LA    R1,1(,R1)                                                        
         STH   R1,4(RF)                                                         
*                                                                               
ENDI50   DS    0H                                                               
         CLI   TEST,C'Y'           SKIP BILLING IF TEST RUN                     
         BE    ENDI60                                                           
*                                                                               
         CLI   EXCLSW,C'N'         SKIP BILLING IF EXCLUDE                      
         BNE   ENDI60                                                           
*                                                                               
* LOOK UP ACCESS RECORD, AND CHECK THE UAT FLAG                                 
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING CT5REC,R4                                                        
         MVI   CT5KTYP,CT5KTYPQ                                                 
         MVC   CT5KALPH,AGENCY                                                  
*                                                                               
         L     R4,=A(GENREC2)                                                   
         GOTO1 =V(DATAMGR),DMCB,=C'DMREAD',=C'CTFILE',KEY,(R4),DMWORK           
         CLI   8(R1),0                                                          
         BNE   ENDI59                                                           
*                                                                               
         LA    R6,CT5DATA                                                       
*                                                                               
ENDI55   DS    0H                                                               
         CLI   0(R6),0             EOR                                          
         BE    ENDI59                                                           
*                                                                               
         CLI   0(R6),CTAGDELQ      AGY GROUP DETAIL ELEM? (X'B4')               
         BE    *+16                                                             
         LLC   R0,1(R6)                                                         
         AR    R6,R0                                                            
         B     ENDI55                                                           
*                                                                               
         TM    CTAGOPTS-CTAGDD(R6),CTAGUAT    UAT AGENCY?                       
         BO    ENDI60                                                           
*                                                                               
* BUILD AND WRITE EZ BILLING RECORD TO SEQUENTIAL FILE                          
*                                                                               
ENDI59   DS    0H                                                               
         XC    EZBILL(256),EZBILL                                               
         XC    EZBILL+256(256),EZBILL+256                                       
         LA    R2,EZBILL                                                        
         USING EZBILLD,R2                                                       
*                                                                               
         MVC   EZBAGY,USID                                                      
         MVC   EZBSRC,OLDSRC                                                    
         MVC   EZBMEDIA,OLDMEDIA                                                
         MVC   EZBCALL,BILSTA                                                   
         MVC   EZBNET,STANET                                                    
         MVC   EZBMOS,INVMOS                                                    
         MVC   EZBTODAY,TODAY                                                   
         MVC   EZBADVNM,ADVNAM                                                  
         MVC   EZBPRDNM,PRDNAM                                                  
         MVC   EZBINVNO,INVNO                                                   
         L     R0,ISPTS                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  EZBNSPTS,DUB                                                     
         OI    IDOLG+7,X'0F'                                                    
         UNPK  EZBGDOL,IDOLG                                                    
         OI    IDOLN+7,X'0F'                                                    
         UNPK  EZBNDOL,IDOLN                                                    
         MVC   EZBAGYNM,SVAGYFL                                                 
*                                                                               
         MVC   EZBEST,ESTNO                                                     
         MVC   EZBREPOR,REPORDER                                                
         MVC   EZBSTAOR,STAORDER                                                
         MVC   EZBADVCD,ADVCD                                                   
         MVC   EZBPRDCD,PRDCD                                                   
         MVC   EZBLDATE,RUNDATLO                                                
         MVC   EZBHDATE,RUNDATHI                                                
*                                                                               
         L     R0,=A(EZBILLF)                                                   
         PUT   (0),EZBILL                                                       
         DROP  R2                                                               
         XC    EZBILL(256),EZBILL                                               
         XC    EZBILL+256(256),EZBILL+256                                       
*                                                                               
ENDI60   DS    0H                                                               
         XC    INVFLDS(INVFLDLQ),INVFLDS                                        
         MVC   RUNDATLO,=X'FFFFFFFFFFFF'                                        
         L     RF,ISPTS            ROLL UP TO BATCH TOTALS                      
         A     RF,BSPTS                                                         
         ST    RF,BSPTS                                                         
         AP    BDOLN,IDOLN                                                      
         AP    BDOLG,IDOLG                                                      
*                                                                               
         CLI   EXCLSW,C'N'         SKIP EXPRESSLY EXCLUDED BATCHES              
         BNE   ENDI80                                                           
*                                                                               
* ADD BOTH UNKNOWN AGENCY AND WORKER FILE FULL COUNTS                           
*                                                                               
         BAS   RE,ADDSTA           ADD TO STATION COUNTERS                      
*                                                                               
         BAS   RE,ADDAGY           ADD TO AGENCY COUNTERS                       
*                                                                               
ENDI80   DS    0H                                                               
*        XC    ITOTS,ITOTS         CLEAR INVOICE TOTALS                         
         XC    ISPTS,ISPTS                                                      
*                                                                               
         ZAP   IDOLN,=P'0'                                                      
         ZAP   IDOLG,=P'0'                                                      
*                                                                               
         CLI   EXCLSW,C'D'         DISK ERROR?                                  
         BE    *+12                ADD TO UNKNOWNS COUNTER                      
         CLI   EXCLSW,C'*'         UNKNOWN AGENCY                               
         BNE   ENDI84                                                           
*                                                                               
         L     RF,TUNKINV                                                       
         LA    RF,1(,RF)                                                        
         ST    RF,TUNKINV                                                       
*                                                                               
ENDI84   DS    0H                                                               
         CLI   EXCLSW,C'#'         FULL WORKER FILE                             
         BNE   ENDI86                                                           
*                                                                               
         L     RF,TFULINV                                                       
         LA    RF,1(,RF)                                                        
         ST    RF,TFULINV                                                       
*                                                                               
ENDI86   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
EDIT0    NTR1                                                                   
         EDIT  ((R2)),(5,(R3)),ZERO=NOBLANK                                     
         B     EXIT                                                             
EDIT2    NTR1                                                                   
         EDIT  ((R2)),(14,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES             
         B     EXIT                                                             
EDITP    NTR1                                                                   
         EDIT  (P8,0(R2)),(14,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
         B     EXIT                                                             
*                                                                               
*        ADDWKR - ADD RECORD TO WORKER FILE                                     
*                                                                               
         DS    0H                                                               
ADDWKR   NTR1                                                                   
         L     R4,WKRREC                                                        
         LH    R5,0(R4)            LENGTH                                       
         CH    R5,=H'6'            SKIP IF NO REAL RECORD                       
         BNH   ADDWKRX                                                          
         CH    R5,=H'1020'         MAX REC SIZE                                 
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   EXCLSW,C'N'         SKIP ADDS IF EXCLUDE                         
         BNE   ADDW20                                                           
*                                                                               
         CLC   4(2,R4),=C'30'      30 (VERSION NUMBER) RECORD?                  
         BE    ADDWKRX             YES, DO NOT WRITE IT TO WKR FILE             
*                                                                               
         L     R1,BRECS            ADD 1 TO BATCH RECORDS                       
         LA    R1,1(,R1)           CAN'T MAKE BATCH TOO LARGE                   
         ST    R1,BRECS            BATCH MOVE CAN'T HANDLE IT                   
*                                                                               
         CVD   R5,DUB              GET BYTES                                    
         AP    BBYTS,DUB           ADD TO TOTAL BATCH BYTES                     
*                                                                               
         CLI   TEST,C'Y'           SKIP ADDS IF TESTING                         
         BE    ADDW10                                                           
*                                                                               
         MVI   WRKIACTN,WRKIAADD                                                
         GOTO1 EZWRKIO,WRKIOB                                                   
         CLI   WRKIERRS,0                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
ADDW10   BAS   RE,DMPREC                                                        
         B     ADDWKRX                                                          
*                                                                               
* WRITE TO HOLD FILE HERE IF UNKNOWN AGENCY OR FULL WORKER FILE *               
*                                                                               
ADDW20   DS    0H                                                               
         OC    HOLDDATE,HOLDDATE   OLD BATCH?                                   
         BZ    ADDW23              NO                                           
*                                                                               
         CLC   HOLDDATE,HOLDCUT                                                 
         BL    ADDWKRX                                                          
*                                                                               
ADDW23   DS    0H                                                               
         CLI   EXCLSW,C'Y'         SKIP EXPRESSLY EXCLUDED BATCHES              
         BE    ADDWKRX                                                          
*                                                                               
         CLI   EXCLSW,C'I'         SET TO EXCLUDE USER ID                       
         BE    ADDWKRX                                                          
*                                                                               
         CLI   EXCLSW,C'S'         SET TO EXCLUDE STATION                       
         BE    ADDWKRX                                                          
*                                                                               
         CLI   EXCLSW,C'#'         SET TO EXCLUDE WORKER FILE FULL              
         BE    ADDW24                                                           
*                                                                               
         CLI   EXCLSW,C'*'         SET TO EXCLUDE UNKNOWN                       
         BE    ADDW24                                                           
*                                                                               
         CLI   EXCLSW,C'D'         SET TO EXCLUDE DISK ERRORS                   
         BE    ADDW24                                                           
*                                                                               
         DC    H'0'                                                             
*                                                                               
ADDW24   TM    SVRECSW,SVRECSRC                                                 
         BZ    ADDW40                                                           
*                                                                               
         NI    SVRECSW,X'FF'-SVRECSRC                                           
         L     R2,=A(HLDREC)                                                    
         XC    0(256,R2),0(R2)                                                  
         MVI   1(R2),20                                                         
         MVC   4(3,R2),=X'F9F95E'   C'99'                                       
         MVC   7(4,R2),SOURCE                                                   
         MVI   11(R2),X'5E'                                                     
         MVC   12(6,R2),HOLDDATE                                                
*                                                                               
         OC    HOLDDATE,HOLDDATE   IS THIS AN OLD BATCH?                        
         BNZ   *+10                 YES                                         
         MVC   12(6,R2),TODAY                                                   
*                                                                               
         MVC   18(2,R2),=X'5E15'                                                
*                                                                               
         L     RF,WORKCT9                                                       
         LA    RF,1(,RF)                                                        
         ST    RF,WORKCT9                                                       
*                                                                               
         CLI   TRACEWRK,C'Y'       PRINT OUT WORK FILE                          
         BNE   ADDW30                                                           
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+1(4),DUB                                                       
         LH    R0,0(R2)                                                         
         SH    R0,=H'4'                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         CH    R0,=H'372'                                                       
         BNH   *+6                                                              
         DC    H'0'                                                             
         UNPK  P+6(3),DUB                                                       
         MVC   P+10(3),=C'LEN'                                                  
         MVI   P+14,C'W'                                                        
         MVC   P+16(80),4(R2)                                                   
         OC    P+16(80),SPACES                                                  
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ADDW30   DS    0H                                                               
         CLI   TEST,C'Y'           THIS A TEST RUN                              
         BE    ADDW40                                                           
*                                                                               
         L     R0,=A(EZWORKW)                                                   
         PUT   (0),(R2)                                                         
*                                                                               
* MOVE TO WRITE RECORD AREA, ADD 4 TO LEN, SAVE IT, ZERO NEXT 2 BYTES           
* MOVE REST OF RECORD TO +4                                                     
*                                                                               
ADDW40   L     R2,=A(HLDREC)                                                    
         XC    0(256,R2),0(R2)                                                  
         STH   R5,0(,R2)           STORE LENGTH                                 
         LA    R0,4(,R2)           POINT TO START OF RECORD                     
         AHI   R5,-4               GET RECORD LEN                               
         LA    R4,4(,R4)           MOVE RECORD ONLY                             
         LR    R1,R5                                                            
*                                                                               
         CLC   =X'F3F15E',0(R4)    THIS INVOICE HEADER REC                      
         BNE   ADDW50               NOPE                                        
*                                                                               
* NEED TO DROP 12 BYTE SAVE AREA FIELD + SEMI-COLON *                           
*                                                                               
         AHI   R5,-9               GET NEW LEN WITHOUT 12 BYTE FIELD            
         STH   R5,0(,R2)           STORE NEW LENGTH + 4                         
         AHI   R5,-4               NOW SUB 4 FOR REAL LEN                       
         LR    RF,R0                                                            
         MVC   0(3,RF),0(R4)       DROP                                         
         LA    R0,3(,RF)                INTERNAL                                
         LA    R4,16(,R4)                        12 BYTE FIELD                  
         AHI   R5,-3                                                            
         LR    R1,R5                                                            
*                                                                               
ADDW50   MVCL  (R0),(R4)                                                        
         L     RF,=A(HLDREC)                                                    
         CLC   =X'F3F15E',4(RF)    THIS INVOICE HEADER REC                      
         BNE   ADDW58               NOPE                                        
*                                                                               
* FIND FIELD 36 (THE 12-BYTE SAVE FIELD) AND SKIP IT                            
         LH    R1,0(RF)            REC LEN                                      
         AR    R1,RF               R1 POINTS TO THE END OF RECORD               
         LA    RF,4(RF)            SKIP THE 4 REC LENGTH BYTES                  
         SR    R0,R0               FIELD COUNTER = FIELDS PROCESSED             
*                                                                               
ADDW52   CR    RF,R1               REACHED EOR?                                 
         BL    *+6                                                              
         DC    H'0'                MUST HAVE 36 FIELDS                          
         CLC   0(1,RF),RDELIM      EOR?                                         
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   0(1,RF),FDELIM      EOF?                                         
         BNE   ADDW54                                                           
         AHI   R0,1                YES, INCREMENT FIELD COUNTER                 
         CHI   R0,35               ARE WE AT FLD 36? (35 ALREADY DONE)          
         BNL   ADDW56              NO                                           
*                                                                               
ADDW54   LA    RF,1(RF)            NO, MOVE ON TO NEXT CHARACTER                
         B     ADDW52                                                           
*                                                                               
ADDW56   DS    0H                  RF -> DELIMITER AFTER FIELD 35               
         LR    R0,RF               R0 = COPY TO                                 
         LA    RE,13(RF)           RE = COPY FROM                               
         SR    R1,RF               BYTES LEFT IN THE RECORD                     
         SHI   R1,13               LESS THE SECOND SAVE FIELD                   
         LR    RF,R1                                                            
         CHI   R1,0                                                             
         BNL   *+6                 LENGTH MUST BE POSITIVE                      
         DC    H'0'                                                             
*                                                                               
         MVCL  R0,RE                                                            
         LH    R0,0(R2)                                                         
         SHI   R0,13                                                            
         STH   R0,0(R2)                                                         
*                                                                               
ADDW58   DS    0H                                                               
*                                                                               
         L     RF,WORKCT                                                        
         LA    RF,1(,RF)                                                        
         ST    RF,WORKCT                                                        
*                                                                               
         CLI   TRACEWRK,C'Y'       PRINT OUT WORK FILE                          
         BNE   ADDW60                                                           
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+1(4),DUB                                                       
         LH    R0,0(R2)                                                         
         SH    R0,=H'4'                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         CH    R0,=H'372'                                                       
         BNH   *+6                                                              
         DC    H'0'                                                             
         UNPK  P+6(3),DUB                                                       
         MVC   P+10(3),=C'LEN'                                                  
         MVI   P+14,C'W'                                                        
         MVC   P+16(80),4(R2)                                                   
         OC    P+16(80),SPACES                                                  
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ADDW60   DS   0H                                                                
         CLI   TEST,C'Y'           THIS A TEST RUN                              
         BE    ADDWKRX                                                          
*                                                                               
         L     R0,=A(EZWORKW)                                                   
         PUT   (0),(R2)                                                         
*                                                                               
ADDWKRX  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
*        DMPREC - RECORD ADDED TO WORKER FILE                                   
*                                                                               
DMPREC   CLI   TRACEWKR,C'Y'                                                    
         BNER  RE                                                               
*                                                                               
         DS    0H                                                               
DMP      NTR1                                                                   
         L     R6,WKRREC                                                        
         MVC   P(4),=C'WRKR'                                                    
         EDIT  (B2,0(R6)),(4,P+6),FILL=0                                        
         MVC   P+12(120),2(R6)                                                  
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         B     EXIT                                                             
*                                                                               
*        CKMINUS - CHECK FOR MINUS AT START OR END OF RFDATA                    
*                                                                               
*                                                                               
CKMINUS  MVI   HOLDSIGN,0                                                       
         ZIC   RF,RFLEN                                                         
         CLI   RFDATA,C'-'         PRECEDED BY MINUS                            
         BNE   CKMIN10                                                          
*                                                                               
         EX    RF,CKMMVC                                                        
         BCTR  RF,0                                                             
         B     CKMIN20                                                          
*                                                                               
CKMIN10  BCTR  RF,0                                                             
         LA    R1,RFDATA(RF)                                                    
         CLI   0(R1),C'-'          LAST CHAR A MINUS                            
         BNE   CKMINX                                                           
         MVI   0(R1),0             BLANK MINUS                                  
CKMIN20  STC   RF,RFLEN                                                         
         MVI   HOLDSIGN,C'-'                                                    
*                                                                               
CKMINX   BR    RE                                                               
*                                                                               
CKMMVC   MVC   RFDATA(0),RFDATA+1                                               
*                                                                               
*        ADDSTA - ADD TO STATION TABLE - 1 FOR INVOICE, SPOTS, $                
*                                                                               
ADDSTA   LA    R0,EZSTALEN-1                                                    
         L     R1,=A(EZSTATAB)                                                  
ADDSTA10 OC    0(5,R1),0(R1)       EMPTY ENTRY                                  
         BZ    ADDSTA20                                                         
         CLC   OLDSTA(5),0(R1)                                                  
         BE    ADDSTA24                                                         
         LA    R1,29(R1)                                                        
         BCT   R0,ADDSTA10                                                      
*                                                                               
         MVC   0(5,R1),=C'*****'                                                
         B     ADDSTA24                                                         
*                                                                               
ADDSTA20 MVC   0(5,R1),OLDSTA                                                   
*                                                                               
ADDSTA24 DS   0H                                                                
         CLI   EXCLSW,C'N'         IF EXCLSW NE N, NOT LOADED                   
         BNER  RE                   SKIP COUNTS                                 
*                                                                               
         ICM   RF,15,5(R1)                                                      
         LA    RF,1(,RF)                                                        
         STCM  RF,15,5(R1)                                                      
         ICM   RF,15,9(R1)                                                      
         A     RF,ISPTS                                                         
         STCM  RF,15,9(R1)                                                      
*        ICM   RF,15,13(R1)                                                     
*        A     RF,IDOLN                                                         
*        STCM  RF,15,13(R1)                                                     
         AP    13(8,R1),IDOLN                                                   
*        ICM   RF,15,17(R1)                                                     
*        A     RF,IDOLG                                                         
*        STCM  RF,15,17(R1)                                                     
         AP    21(8,R1),IDOLG                                                   
         BR    RE                                                               
*                                                                               
*        ADDAGY - ADD TO AGENCY TABLE - 1 FOR INVOICE, SPOTS, $                 
*                                                                               
ADDAGY   DS   0H                                                                
         CLI   EXCLSW,C'N'         IF EXCLSW NE N, NOT LOADED                   
         BNER  RE                   SKIP COUNTS                                 
         LA    R0,100                                                           
         L     R1,=A(EZAGYCTB)                                                  
*                                                                               
ADDAGY10 OC    0(8,R1),0(R1)       EMPTY ENTRY                                  
         BZ    ADDAGY20                                                         
         CLC   USID,0(R1)                                                       
         BE    ADDAGY24                                                         
         LA    R1,32(,R1)                                                       
         BCT   R0,ADDAGY10                                                      
         DC    H'0'                                                             
*                                                                               
ADDAGY20 MVC   0(8,R1),USID                                                     
*                                                                               
ADDAGY24 DS   0H                                                                
*                                                                               
         ICM   RF,15,8(R1)                                                      
         LA    RF,1(,RF)                                                        
         STCM  RF,15,8(R1)                                                      
         ICM   RF,15,12(R1)                                                     
         A     RF,ISPTS                                                         
         STCM  RF,15,12(R1)                                                     
         AP    16(8,R1),IDOLN                                                   
         AP    24(8,R1),IDOLG                                                   
*                                                                               
*        ADDAGY - ADD TO AGENCY NAME TABLE - 1 FOR INVOICE, SPOTS, $            
*                                                                               
ADDAGY26 LA    R0,EZAGYNLN                                                      
         L     R1,=A(EZAGYNTB)                                                  
         OC    SVAGYFL(130),SPACES                                              
         OC    SVAGYFL+130(20),SPACES                                           
ADDAGY30 OC    0(150,R1),0(R1)      EMPTY ENTRY                                 
         BZ    ADDAGY40                                                         
*                                                                               
         CLC   SVAGYFL,0(R1)                                                    
         BE    ADDAGY44                                                         
         LA    R1,178(,R1)                                                      
         BCT   R0,ADDAGY30                                                      
         DC    H'0'                                                             
*                                                                               
ADDAGY40 MVC   0(150,R1),SVAGYFL                                                
*                                                                               
ADDAGY44 DS   0H                                                                
         ICM   RF,15,152(R1)                                                    
         LA    RF,1(,RF)                                                        
         STCM  RF,15,152(R1)                                                    
         ICM   RF,15,156(R1)                                                    
         A     RF,ISPTS                                                         
         STCM  RF,15,156(R1)                                                    
         AP    160(8,R1),IDOLN                                                  
         AP    168(8,R1),IDOLG                                                  
*                                                                               
ADDAGY46 MVC   176(2,R1),USIDNO     USE FOR UNKNOWN AGENCY (ZEROS)              
         MVC   150(1,R1),SVMEDIA                                                
                                                                                
*        ADDMED - ADD TO MEDIA TABLE - 1 FOR INVOICE, SPOTS, $                  
*                                                                               
         LA    R0,10                                                            
         L     R1,=A(EZMEDCTB)                                                  
ADDMED10 CLI   0(R1),0              EMPTY ENTRY                                 
         BE    ADDMED20                                                         
*                                                                               
         CLC   SVMEDIA(1),0(R1)                                                 
         BE    ADDMED24                                                         
         LA    R1,21(,R1)                                                       
         BCT   R0,ADDMED10                                                      
         DC    H'0'                                                             
*                                                                               
ADDMED20 MVC   0(1,R1),SVMEDIA                                                  
*                                                                               
ADDMED24 DS   0H                                                                
         CLI   EXCLSW,C'N'         IF EXCLSW NE N, NOT LOADED                   
         BNER  RE                   SKIP COUNTS                                 
*                                                                               
         ICM   RF,15,1(R1)                                                      
         LA    RF,1(,RF)                                                        
         STCM  RF,15,1(R1)                                                      
         ICM   RF,15,5(R1)                                                      
         A     RF,ISPTS                                                         
         STCM  RF,15,5(R1)                                                      
         AP    9(6,R1),IDOLN                                                    
         AP    15(6,R1),IDOLG                                                   
*                                                                               
         BR    RE                                                               
*                                                                               
*                                                                               
*                                                                               
* FOUND TYPE CODE WITH LENGTH OTHER THAN 2 *                                    
*                                                                               
TYPLENER DS    0H                                                               
         MVC   ERRLINE,=CL132'UNKNOWN RECORD TYPE'                              
*                                                                               
FATALERR DS    0H                                                               
         MVC   P,SPACES                                                         
         GOTO1 =V(PRINTER)                                                      
         MVC   P(10),=CL10'*ERROR*'                                             
         GOTO1 =V(PRINTER)                                                      
         MVC   P,ERRLINE                                                        
         GOTO1 =V(PRINTER)                                                      
         BRAS  RE,PRTREC                                                        
         DC    H'0'                                                             
*                                                                               
*                                                                               
*                                                                               
*        CONSTANTS FOR SOME RECORD TYPES                                        
*                                                                               
TYPETABL DS    0CL2                                                             
TRTOTYP  DC    CL2'12'                                                          
AGYRTYP  DC    CL2'21'                                                          
STARTYP  DC    CL2'22'                                                          
PAYRTYP  DC    CL2'23'                                                          
SCTRTYP  DC    CL2'24'                                                          
SCBRTYP  DC    CL2'25'                                                          
INVRTYP  DC    CL2'31'                                                          
         DC    CL2'32'                                                          
         DC    CL2'33'                                                          
INTRTYP  DC    CL2'34'                                                          
         DC    CL2'41'                                                          
         DC    CL2'42'                                                          
SPTRTYP  DC    CL2'51'                                                          
         DC    CL2'52'                                                          
IDBTYP   DC    CL2'76'          IDB-based spelling of anyname,offname           
VERTYP   DC    CL2'30'          INVOICE VERSION NUMBER RECORD                   
SRCETYP  DC    CL2'99'             SOURCE - ONLY ON UNKNOWN AGENCY FILE         
TYPETLEN EQU   (*-TYPETABL)/2                                                   
*                                                                               
         DROP  R9,RB,RC                                                         
*                                                                               
*                                                                               
* INITIALIZE PROGRAM                                                            
*                                                                               
         DS    0H                                                               
INIT     NMOD1 0,**INIT**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
*                                                                               
         LA    RE,EZLDWKD          CLEAR WORK                                   
         LHI   RF,EZLDWKL                                                       
         XCEFL                                                                  
*                                                                               
         XCEFL WRKIOB,'WRKIOBL'                                                 
*                                                                               
         MVI   WRKIFTYP,WRKIFTEZ                                                
         LAY   RE,CFACSTRT                                                      
         ST    RE,WRKIACOM                                                      
         MVC   WRKIAREC,=A(WKRRECC)                                             
         MVC   WRKIABUF,=A(WKRBUFC)                                             
*                                                                               
         MVC   DUB,=CL8'T00A2C'    WORKIO                                       
         GOTO1 =V(LOADER),DMCB,DUB,0,0                                          
         MVC   EZWRKIO,DMCB+4                                                   
*                                                                               
         MVI   IDBFLAG,C'N'                                                     
         MVI   NOHOLDCK,C'N'                                                    
*                                                                               
         MVI   SPACES,C' '                                                      
         MVC   SPACES+1(L'SPACES-1),SPACES                                      
*                                                                               
         L     RF,=A(WKRBUFC)                                                   
         ST    RF,WKRBUF                                                        
         L     RF,=A(WKRRECC)                                                   
         ST    RF,WKRREC                                                        
*                                                                               
         MVC   TIMEP,=X'0100'      DEFAULT TIME                                 
         MVC   WKRFIL,=CL8'WRKF  '                                              
         MVC   TITLE(38),=C'EASI - LOAD INPUT TAPE TO WORKER FILES'             
         MVI   DASHES,C'-'                                                      
         MVC   DASHES+1(L'DASHES-1),DASHES                                      
         XC    COUNTS,COUNTS                                                    
*                                                                               
         ZAP   TOTDOLS,=P'0'                                                    
         ZAP   TDOLN,=P'0'                                                      
         ZAP   TDOLG,=P'0'                                                      
         ZAP   HODOLN,=P'0'                                                     
         ZAP   HODOLG,=P'0'                                                     
         ZAP   HIDOLN,=P'0'                                                     
         ZAP   HIDOLG,=P'0'                                                     
         ZAP   CDOLN,=P'0'                                                      
         ZAP   CDOLG,=P'0'                                                      
         ZAP   IDOLN,=P'0'                                                      
         ZAP   IDOLG,=P'0'                                                      
         ZAP   LDOLN,=P'0'                                                      
         ZAP   LDOLG,=P'0'                                                      
         ZAP   IBYTS,=P'0'                                                      
         ZAP   OBYTS,=P'0'                                                      
         ZAP   BBYTS,=P'0'                                                      
         ZAP   BDOLN,=P'0'                                                      
         ZAP   BDOLG,=P'0'                                                      
*                                                                               
         MVC   ID-8(8),=C'*WKINDX*'                                             
*                                                                               
         LA    R0,EZSTALEN                                                      
         L     R1,=A(EZSTATAB)                                                  
INIT20   DS    0H                                                               
         XC    0(29,R1),0(R1)                                                   
         ZAP   13(8,R1),=P'0'                                                   
         ZAP   21(8,R1),=P'0'                                                   
         LA    R1,29(,R1)                                                       
         BCT   R0,INIT20                                                        
*                                                                               
         LA    R0,EZAGYCLN                                                      
         L     R1,=A(EZAGYCTB)                                                  
INIT30   DS    0H                                                               
         XC    0(32,R1),0(R1)                                                   
         ZAP   16(8,R1),=P'0'                                                   
         ZAP   24(8,R1),=P'0'                                                   
         LA    R1,32(,R1)                                                       
         BCT   R0,INIT30                                                        
*                                                                               
         LA    R0,EZAGYNLN                                                      
         L     R1,=A(EZAGYNTB)                                                  
INIT40   DS    0H                                                               
         XC    0(178,R1),0(R1)                                                  
         ZAP   160(8,R1),=P'0'                                                  
         ZAP   168(8,R1),=P'0'                                                  
         LA    R1,178(,R1)                                                      
         BCT   R0,INIT40                                                        
*                                                                               
         MVC   RUNDATLO,=X'FFFFFFFFFFFF'                                        
         MVI   STMODE,C'+'         SET MODES AT INCLUDE                         
         MVI   IDMODE,C'+'                                                      
         MVI   RECFM,C'U'          DEFAULT TO UNDEFINED RECORD FORMAT           
*                                                                               
         SR    R0,R0               INITIALIZE ID TABLE BINSRCH PARS             
         L     R1,=A(IDTAB)                                                     
         SR    R2,R2                                                            
         LA    R3,8                                                             
         LA    R4,8                                                             
         LA    R5,IDTABMX                                                       
         STM   R0,R5,IDTPARS                                                    
*                                                                               
         SR    R0,R0               INITIALIZE STATION TAB BNSRCH PARS           
         L     R1,=A(STTAB)                                                     
         SR    R2,R2                                                            
         LA    R3,5                                                             
         LA    R4,5                                                             
         LA    R5,STTABMX                                                       
         STM   R0,R5,STTPARS                                                    
*                                                                               
*              READ PARAMETER CARDS                                             
*                                                                               
         MVC   P(13),=C'CONTROL CARDS'                                          
         GOTO1 =V(PRINTER)                                                      
         MVC   P(13),DASHES                                                     
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZL10    DS    0H                                                               
         GOTO1 =V(CARDS),DMCB,CARD,=C'RE00'                                     
         CLC   =C'/*',CARD                                                      
         BE    EZL79                                                            
         MVC   P(80),CARD                                                       
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CLI   CARD,C'*'                                                        
         BE    EZL10                                                            
*                                                                               
         CLC   =C'TRACE=',CARD                                                  
         BNE   EZL14                                                            
         MVC   TRACES,CARD+6     RECORDS,FIELDS,WORKER RECS                     
         B     EZL10                                                            
*                                                                               
EZL14    DS    0H                                                               
         CLC   =C'DUMP=',CARD                                                   
         BNE   EZL16                                                            
         MVC   ABNDOPT,CARD+5                                                   
         B     EZL10                                                            
*                                                                               
EZL16    DS    0H                                                               
         CLC   =C'DMGR=',CARD                                                   
         BNE   EZL18                                                            
         MVC   DMGOPT,CARD+5                                                    
         B     EZL10                                                            
*                                                                               
EZL18    DS    0H                                                               
         CLC   =C'DDSIO=',CARD                                                  
         BNE   EZL20                                                            
         ICM   RF,15,VDDSIO                                                     
         BZ    EZL10                                                            
         MVC   0(8,RF),CARD+6                                                   
         B     EZL10                                                            
*                                                                               
EZL20    DS    0H                                                               
         CLC   =C'TEST=',CARD                                                   
         BNE   EZL24                                                            
         MVC   TEST,CARD+5                                                      
         B     EZL10                                                            
*                                                                               
EZL24    DS    0H                                                               
         CLC   =C'DATE=',CARD                                                   
         BNE   EZL26                                                            
         MVC   TODAY,CARD+5                                                     
         B     EZL10                                                            
*                                                                               
EZL26    DS    0H                                                               
         CLC   =C'TIME=',CARD                                                   
         BNE   EZL30                                                            
         PACK  WORK(3),CARD+5(5)  PWOS TIME                                     
         MVC   TIMEP,WORK                                                       
         B     EZL10                                                            
*                                                                               
EZL30    DS    0H                                                               
         CLC   =C'RERUN=',CARD                                                  
         BNE   EZL34                                                            
         MVC   RERUN,CARD+6                                                     
         B     EZL10                                                            
*                                                                               
EZL34    DS    0H                                                               
         CLC   =C'STXIT',CARD                                                   
         BNE   EZL36                                                            
         L     RF,=A(EZLOAD)                                                    
         ST    RF,WORK                                                          
         L     RF,=A(EZLOADX)                                                   
         LA    RF,40(,RF)          SHOW LEVEL=, DATE=                           
         ST    RF,WORK+4                                                        
         OI    WORK+4,X'80'        EOL                                          
         GOTO1 =V(STXITER),DMCB,WORK                                            
         B     EZL10                                                            
*                                                                               
EZL36    DS    0H                                                               
         CLC   =C'STATION=',CARD                                                
         BNE   EZL44                                                            
         CLI   CARD+8,C'+'         MODE SETTERS                                 
         BE    EZL40                                                            
         CLI   CARD+8,C'-'                                                      
         BE    EZL40                                                            
*                                                                               
         MVC   WORK(5),CARD+8                                                   
         GOTO1 =V(BINSRCH),STTPARS,(1,WORK)                                     
         OC    1(3,R1),1(R1)       TEST ROOM                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         B     EZL10                                                            
*                                                                               
EZL40    DS    0H                  MODE SETTERS                                 
         CLI   CARD+9,C' '         MUST NOT BE FOLLOWED BY STATION              
         BNE   EZL56                                                            
         MVC   STMODE,CARD+8                                                    
         B     EZL10                                                            
*                                                                               
EZL44    DS    0H                                                               
         CLC   =C'USERID=',CARD                                                 
         BNE   EZL50                                                            
         CLI   CARD+7,C'+'         MODE SETTERS                                 
         BE    EZL46                                                            
         CLI   CARD+7,C'-'                                                      
         BE    EZL46                                                            
*                                                                               
         MVC   WORK(8),CARD+7                                                   
         GOTO1 =V(BINSRCH),IDTPARS,(1,WORK)                                     
         OC    1(3,R1),1(R1)       TEST ROOM                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         B     EZL10                                                            
*                                                                               
EZL46    DS    0H                  MODE SETTERS                                 
         CLI   CARD+8,C' '         MUST NOT BE FOLLOWED BY STATION              
         BNE   EZL56                                                            
         MVC   IDMODE,CARD+7                                                    
         B     EZL10                                                            
*                                                                               
EZL50    DS    0H                                                               
         CLC   =C'SOURCE=',CARD                                                 
         BNE   EZL52                                                            
         MVC   SOURCE,CARD+7                                                    
         B     EZL10                                                            
*                                                                               
EZL52    DS    0H                                                               
         CLC   =C'DSPACE=',CARD                                                 
         BNE   EZL54                                                            
*                                                                               
         ICM   RF,15,=V(SSB)       DSPACE=                                      
         BZ    EZL10                                                            
         CLI   SSOXTND-SSOOFF(RF),X'FF'                                         
         BNE   EZL10                                                            
         MVC   SSODSPAC-SSOOFF(1,RF),CARD+7                                     
         B     EZL10                                                            
*                                                                               
EZL54    DS    0H                                                               
         CLC   =C'RECFM=',CARD                                                  
         BNE   EZL56                                                            
         MVC   RECFM,CARD+6                                                     
         CLI   RECFM,C'F'                                                       
         BE    EZL10                                                            
         CLI   RECFM,C'U'                                                       
         BE    EZL10                                                            
         CLI   RECFM,C'V'                                                       
         BE    EZL10                                                            
         MVC   P(15),=C'MUST BE F, U, V'                                        
         GOTO1 =V(PRINTER)                                                      
         B     BADINIT                                                          
*                                                                               
EZL56    DS    0H                                                               
         CLC   =C'WRITE=',CARD                                                  
         BNE   EZL58                                                            
*                                                                               
         CLI   CARD+6,C'N'                                                      
         BNE   EZL10                                                            
         MVI   WRITEFL,C'N'                                                     
         B     EZL10                                                            
*                                                                               
EZL58    DS    0H                                                               
* NOTE: WORKS ONLY WITH DMGR=N OPTION                                           
         CLC   =C'FORCEID=',CARD                                                
         BNE   EZL60                                                            
*                                                                               
* NOTE: USER ID LOOKUP IS DONE LATER, AFTER DMOPEN CALL                         
*                                                                               
         MVC   FCUID,CARD+8                                                     
         B     EZL10                                                            
*                                                                               
EZL60    DS    0H                                                               
         CLC   =C'NOHOLDCHECK',CARD                                             
         BNE   EZL78                                                            
         MVI   NOHOLDCK,C'Y'                                                    
         B     EZL10                                                            
*                                                                               
EZL78    DS    0H                                                               
         MVC   P(8),=C'BAD CARD'                                                
         GOTO1 =V(PRINTER)                                                      
         B     BADINIT                                                          
*                                                                               
EZL79    DS    0H                                                               
         CLI   TODAY,0             TEST DATE GIVEN                              
         BNE   EZL79A                                                           
         GOTO1 =V(DATCON),DMCB,(5,0),(0,TODAY)                                  
*                                                                               
EZL79A   DS    0H                                                               
         GOTO1 =V(DATCON),DMCB,(0,TODAY),(2,TODAYC)                             
*                                                                               
* KEEP 9 MONTHS OF INVOICES ON HOLD FILE                                        
         LHI   RF,HOLDCUTQ                                                      
         LNR   RF,RF                                                            
         GOTO1 =V(ADDAY),DMCB,(C'M',TODAY),HOLDCUT,(RF)                         
*                                                                               
         OC    SOURCE,SOURCE       WAS THERE A SOURCE CARD                      
         BZ    SRCERR                                                           
*                                                                               
         L     R2,=A(EZINPUTF)     FIXED BLOCKED DCF                            
         CLI   RECFM,C'F'                                                       
         BE    EZL80                                                            
         L     R2,=A(EZINPUTU)     UNDEFINED DCF                                
         CLI   RECFM,C'U'                                                       
         BE    EZL80                                                            
         L     R2,=A(EZINPUTV)     VARIABLE DCF                                 
         CLI   RECFM,C'V'                                                       
         BE    EZL80                                                            
         DC    H'0'                                                             
*                                                                               
EZL80    DS    0H                                                               
         GOTO1 =V(DATAMGR),DMCB,=C'DMOPEN',=C'CONTROL',A(FILIST),WKRBUF         
*                                                                               
* LOOKUP FOR FORCEID= CARD                                                      
*                                                                               
         OC    FCUID,FCUID                                                      
         BZ    EZL81                                                            
*                                                                               
         XC    LKAGYBLK,LKAGYBLK                                                
         MVC   LKAGYUID,SPACES                                                  
         MVC   LKAGYUID(8),FCUID                                                
         BRAS  RE,LKAGY2                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   FCBID,LKAGYBID                                                   
         MVC   FCAGY,LKAGYAGY                                                   
*                                                                               
EZL81    DS    0H                                                               
*                                  CHECK FOR HFS FILENAME                       
         GOTO1 =V(DDINFO),DMCB,=C'EZINPUT',(0,=X'C017'),0                       
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     RE,DMCB+8                                                        
         CLC   =C'/u/',0(RE)       HFS PATHNAME?                                
         BNE   EZL83                                                            
*                                  CHECK FOR FILEDATA                           
         GOTO1 =V(DDINFO),DMCB,=C'EZINPUT',(0,=X'C01D'),0                       
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     RE,DMCB+8                                                        
         ICM   RF,1,DMCB+8                                                      
         BNZ   *+6                                                              
         DC    H'0'                NO FILEDATA PARAM                            
*                                                                               
         CLI   0(RE),X'40'                                                      
         BE    *+6                                                              
         DC    H'0'                FILEDATA MUST BE TEXT                        
*                                                                               
         MVI   RECFM,C'V'          OVERRIDE RECFM                               
         L     R2,=A(EZINPUTV)     VARIABLE DCF                                 
         USING IHADCB,R2           R2=INPUT DCB                                 
         MVC   DCBBLKSI,=H'25500'  BLKSIZE=25500                                
         MVC   DCBLRECL,=H'2550'   LRECL=2550                                   
         DROP  R2                                                               
*                                                                               
EZL83    ST    R2,AEZINPT                                                       
         OPEN  ((R2),(INPUT))                                                   
*                                                                               
         LTR   RF,RF               GOOD OPEN                                    
         BZ    EZL84                YES                                         
*                                                                               
         MVC   P(19),=C'EZINPUT OPEN FAILED'                                    
         GOTO1 =V(PRINTER)                                                      
         B     BADINIT                                                          
*                                                                               
EZL84    DS   0H                                                                
         XC    SVSRCE,SVSRCE       SET SVSRCE ZERO (USED AS FLAG)               
*                                                                               
* 06/15/2005 - WE WANT THE IVNOICES ON HOLD FILE DISPLAYED TOO                  
*                                                                               
*        CLI   TEST,C'Y'           IS THIS A TEST RUN                           
*        BE    EZL90                YES, HOLD/WORK FILES                        
*                                                                               
         MVC   SVSRCE,SOURCE                                                    
*                                                                               
         OPEN  (EZHOLDR,(INPUT))                                                
*                                                                               
         LTR   RF,RF               GOOD OPEN                                    
         BZ    EZL86                YES                                         
*                                                                               
         MVC   P(19),=C'EZHOLDR OPEN FAILED'                                    
         GOTO1 =V(PRINTER)                                                      
         B     BADINIT                                                          
*                                                                               
EZL86    DS    0H                                                               
         CLI   TEST,C'Y'           IS THIS A TEST RUN                           
         BE    EZL90               DO NOT OPEN WORK FILE                        
*                                                                               
         OPEN  (EZWORKW,(OUTPUT))                                               
         LTR   RF,RF               GOOD OPEN                                    
         BZ    EZL90                YES                                         
         MVC   P(19),=C'EZWORKW OPEN FAILED'                                    
         GOTO1 =V(PRINTER)                                                      
         B     BADINIT                                                          
*                                                                               
EZL90    DS    0H                                                               
         CLI   TEST,C'Y'           IS THIS A TEST RUN                           
         BE    EZL96                YES, NO BILLING                             
*                                                                               
         OPEN  (EZBILLF,(OUTPUT))                                               
*                                                                               
         LTR   RF,RF               GOOD OPEN                                    
         BZ    EZL96                YES                                         
*                                                                               
         MVC   P(18),=C'EZBILL OPEN FAILED'                                     
         GOTO1 =V(PRINTER)                                                      
         B     BADINIT                                                          
*                                                                               
SRCERR   MVC   P(19),=C'NO SOURCE PARM CARD'                                    
         GOTO1 =V(PRINTER)                                                      
         B     BADINIT                                                          
*                                                                               
EZL96    DS    0H                                                               
* STORAGE FOR REDIRECT UID AND ID/CLT TABLES                                    
* 1 table for 8-char user IDs                                                   
* 1 table for client code-user id pairs (3+1+8)                                 
         ICM   R0,15,=AL4(IDUIDMAXQ*L'IDID11FW+IDCLTMAXQ*IDCLTLQ)               
         STORAGE OBTAIN,LENGTH=(R0),LOC=31,COND=YES                             
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* INITIALIZE BINSEARCH PARAMETERS FOR UIDS TABLE                                
*                                                                               
         XC    BSPARS1,BSPARS1     BINSRCH PARAMETERS FOR ID TABLE              
         ST    R1,BP1_2            A(TABLE), R1 FROM STORAGE MACRO              
         MVI   BP1_4+3,L'IDID11FW  RECORD LENGTH = TABLE ENTRY SIZE             
         MVI   BP1_5+3,L'IDID11FW  L'KEY = TABLE ENTRY SIZE                     
         MVC   BP1_6+2(2),=AL2(IDUIDMAXQ) MAX ENTRIES IN TABLE                  
*                                                                               
* INITIALIZE BINSEARCH PARAMETERS FOR CLIENT-UID TABLE                          
*                                                                               
         XC    BSPARS2,BSPARS2     BINSRCH PARMS FOR CLIENT-ID TABLE            
         L     R1,BP1_2            START OF OBTAINED STORAGE                    
         AHI   R1,IDUIDMAXQ*L'IDID11FW MOVE PAST UID TABLE                      
         ST    R1,BP2_2            A(TABLE)                                     
         MVI   BP2_4+3,IDCLTLQ     RECORD LENGTH                                
         MVI   BP2_5+3,L'IDCCLT      L'KEY                                      
         MVC   BP2_6+2(2),=AL2(IDCLTMAXQ) MAX ENTRIES IN TABLE                  
*                                                                               
         OPEN  (EZCLTUID,(INPUT))  UID, CLT/UID FILE                            
         LTR   RF,RF               GOOD OPEN                                    
         BZ    *+6                                                              
         DC    H'0'           CLIENT REDIRECT INPUT FILE FAILED TO OPEN         
*                                                                               
EZL97    DS    0H                                                               
         LAY   R2,EZCLTUID                                                      
         GET   (R2),CARD                                                        
*                                                                               
         CLI   CARD,C'*'           COMMENT?                                     
         BE    EZL97               SKIP IT                                      
         CLI   CARD,C' '           EMPTY LINE?                                  
         BNH   EZL97               SKIP IT                                      
*                                                                               
         CLI   CARD,C'I'           USER ID?                                     
         BNE   EZL97B                                                           
*                                                                               
         MVI   BP1_4,1             ADD IF NOT FOUND                             
         SAM31                                                                  
         GOTO1 =V(BINSR31),BSPARS1,CARD+2                                       
         SAM24                                                                  
         OC    1(3,R1),1(R1)       TEST TABLE FULL                              
         BNZ   EZL97                                                            
         DC    H'0'                TABLE FULL                                   
*                                                                               
EZL97B   DS    0H                                                               
         CLI   CARD,C'C'           CLT/UID PAIR?                                
         BNE   EZL97               NO - IGNORE THIS ENTRY                       
*                                                                               
         MVI   BP2_4,1             ADD IF NOT FOUND                             
         SAM31                                                                  
         GOTO1 =V(BINSR31),BSPARS2,CARD+2                                       
         SAM24                                                                  
         OC    1(3,R1),1(R1)       TEST TABLE FULL                              
         BNZ   EZL97                                                            
         DC    H'0'                TABLE FULL                                   
*                                                                               
EZL97X   DS    0H                  EZCLTUID EOF                                 
         J     EQXIT                                                            
*                                                                               
BADINIT  J     NEQXIT              SET BAD COND CODE FOR INIT                   
*                                                                               
VDDSIO   DC    V(DDSIO)                                                         
         DROP  RB,RC                                                            
*                                                                               
*                                                                               
*        GETFLD- RETURN A SINGLE FIELD                                          
*                                                                               
*        REGS - R2 = FIELD LENGTH                                               
*               R3 = CURRENT BYTE POINTER                                       
*               R4 = START OF FIELD                                             
*               R5 = WORK REG FOR TRAILING BLANKS                               
*               R6 = OUTPUT FIELD POINTER                                       
*                                                                               
         DS    0H                                                               
GETFLD   NMOD1 0,**GETF**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
*                                                                               
         XC    RFDATA,RFDATA                                                    
         MVI   RFLEN,0                                                          
         XC    WLEN,WLEN                                                        
         XC    WDATA,WDATA                                                      
*                                                                               
         TM    RFCTL2,RFCTL2RD     TEST NEED READ NEXT REC                      
         BO    *+14                                                             
*                                                                               
         OC    RFCURPOS,RFCURPOS   TEST FIRST TIME                              
         BNZ   GETF10               NO                                          
*                                                                               
*  GET INPUT BLOCK OR RECORD FROM TAPE *                                        
*                                                                               
GETF00   DS    0H                                                               
         BAS   RE,GBL              YES- GET INPUT FILE BLOCK                    
*                                                                               
         L     R3,RFCURPOS         START WITH NEW BLOCK                         
*                                                                               
GETF10   DS    0H                                                               
         TM    RFCTL2,RFCTL2ER        TEST NEED TO SEND EOR                     
         BZ    GETF12                                                           
         NI    RFCTL2,X'FF'-RFCTL2ER  SET OFF END OF RECORD                     
         B     GETF36                  SET UP FOR EOR                           
*                                                                               
GETF12   DS    0H                                                               
         TM    RFCTL2,RFCTL2EF     TEST NEED TO SEND END OF FILE                
         BZ    GETF14                                                           
         NI    RFCTL2,X'FF'-RFCTL2EF  SET OFF EOF                               
*                                                                               
         OI    RFCTL,RFCTLEOF      SET END OF FILE                              
         B     GETFX               RETURN                                       
*                                                                               
GETF14   DS    0H                                                               
         TM    RFCTL,RFCTLEOR      AFTER EOR                                    
         BZ    GETF16                                                           
         MVI   RFFLDNO,0           RESET FIELD NUMBER                           
*                                                                               
GETF16   DS    0H                                                               
         TM    RFCTL,RFCTLEOF      END OF FILE SET                              
         BNZ   GETFX               RETURN                                       
*                                                                               
         L     R3,RFCURPOS                                                      
         ST    R3,RFFLDST          SAVE START OF FIELD                          
         SR    R2,R2               BYTE COUNTER                                 
         LA    R6,WDATA                                                         
         LR    R4,R6                                                            
*                                                                               
GETF20   DS    0H                                                               
         C     R3,EOR              TEST AT END OF PHYS BLOCK                    
         BL    GETF30               NO                                          
*                                                                               
         OI    RFCTL2,RFCTL2RD     SET NEED TO READ NEXT REC                    
*                                                                               
         LTR   R2,R2               TEST HAVE FIELD TO HANDLE                    
         BZ    GETF24               NO, CK END OF RECORD                        
*                                                                               
         OI    RFCTL2,RFCTL2ER     SET DO EOR LATER                             
*                                                                               
         OI    RFCTL,X'10'         SET END OF FIELD                             
         B     GETF70              RETURN FIELD                                 
*                                                                               
GETF24   DS    0H                                                               
         TM    RFCTL,RFCTLEOR      TEST HAVE SENT EOR                           
         BZ    GETF36                                                           
*                                                                               
         TM    RFCTL2,RFCTL2EF     TEST NEED TO SEND END OF FILE                
         BZ    GETF26                                                           
         NI    RFCTL2,X'FF'-RFCTL2EF   SET OFF EOF                              
         OI    RFCTL,RFCTLEOF      SET END OF FILE                              
         B     GETFX               RETURN                                       
*                                                                               
GETF26   DS    0H                                                               
         TM    RFCTL,RFCTLEOF      END OF FILE SET                              
         BNZ   GETFX               RETURN                                       
         B     GETF00                                                           
*                                                                               
GETF30   CLC   RDELIM,0(R3)        TEST HAVE RECORD DELIM                       
         BNE   GETF40                                                           
*                                                                               
         LA    R3,L'RDELIM(,R3)    BUMP PAST RECORD DELIMITER                   
         ST    R3,RFCURPOS                                                      
*                                                                               
         CLI   RECFM,C'F'          FIXED BLOCKED RECS                           
         BNE   GETF32                                                           
         MVC   RFCURPOS,EOR        FORCE END OF RECORD                          
*                                                                               
GETF32   LTR   R2,R2               TEST HAVE FIELD TO HANDLE                    
         BZ    GETF34               NO                                          
*                                                                               
         OI    RFCTL2,RFCTL2ER     SET TO DO EOR LATER                          
         B     GETF70              RETURN FIELD                                 
*                                                                               
GETF34   DS    0H                  NO FIELD TO HANDLE                           
         CLI   RFFLDNO,0           HAVE THERE BEEN ANY FLDS                     
         BE    GETF20              NO- IGNORE                                   
*                                                                               
GETF36   DS    0H                                                               
         OI    RFCTL,RFCTLEOR      SEND EOR                                     
         L     RF,WRCURPOS                                                      
         MVC   0(L'RDELIM,RF),RDELIM                                            
         LA    RF,L'RDELIM(,RF)                                                 
         ST    RF,WRCURPOS                                                      
         B     GETFX                                                            
*                                                                               
GETF40   DS    0H                                                               
         CLC   FDELIM,0(R3)        TEST HAVE FIELD DELIM                        
         BE    GETF60                                                           
*                                  NO DELIMITER, CONTINUE                       
         LTR   R2,R2               IF HAVE NO DATA YET                          
         BNZ   GETF50                                                           
*                                                                               
* DO NOT STRIP BLANKS FROM DAY OF WEEK FIELD OF SCHEDULE LINE *                 
*                                                                               
         CLI   RFFLDNO,2           TEST FIELD 3 (BUT STILL SET AS 2)            
         BNE   GETF44                                                           
         CLC   RECTYP,SCHDTYP      TEST SCHEDULE LINE RECORD                    
         BE    GETF50               LEAVE BLANKS THERE                          
*                                                                               
GETF44   CLI   0(R3),C' '          IGNORE LEADING BLANKS                        
         BNH   GETF54                                                           
*                                                                               
GETF50   DS    0H                                                               
         MVC   0(1,R6),0(R3)                                                    
*                                                                               
         CLI   0(R3),C' '          DON'T FORCE                                  
         BNH   GETF52                                                           
         OI    0(R6),X'40'         FORCE ALL DATA TO UPPER CASE                 
*                                                                               
GETF52   LA    R2,1(,R2)           BUMP FIELD LENGTH                            
         LA    R6,1(,R6)           BUMP OUTPUT POINTER                          
         AP    OBYTS,=P'1'         ADD TO OUTPUT BYTES                          
GETF54   DS    0H                                                               
         LA    R3,1(,R3)           NEXT POS                                     
         AP    IBYTS,=P'1'         ADD TO INPUT BYTES                           
         B     GETF20                                                           
SCHDTYP  DC    CL2'41'                                                          
*                                                                               
GETF60   DS    0H                                                               
         LA    R3,L'FDELIM(,R3)    BUMP PAST FIELD DELIM                        
         ST    R3,RFCURPOS         SET NEW POS                                  
*                                                                               
GETF70   DS    0H                                                               
         LTR   R2,R2                                                            
         BNP   GETF80                                                           
*                                                                               
* DO NOT STRIP BLANKS FROM DAY OF WEEK FIELD OF SCHEDULE LINE *                 
*                                                                               
         CLI   RFFLDNO,2           TEST FIELD 3 (BUT STILL SET AS 2)            
         BNE   GETF72                                                           
         CLC   RECTYP,SCHDTYP      TEST SCHEDULE LINE RECORD                    
         BE    GETF76               LEAVE BLANKS THERE                          
*                                                                               
*                                  STRIP TRAILING BLANKS                        
GETF72   DS    0H                                                               
         LA    R5,0(R2,R4)                                                      
         BCTR  R5,0                R5 AT LAST BYTE                              
*                                                                               
GETF74   DS    0H                                                               
         CLI   0(R5),C' '                                                       
         BH    GETF76                                                           
         BCTR  R2,0                DECR LENGTH                                  
         BCT   R5,GETF74           PREVIOUS BYTE                                
*                                                                               
GETF76   DS    0H                                                               
         CH    R2,=H'255'                                                       
         BNH   GETF80                                                           
         OI    RFCTL,RFCTLFER      SET FIELD ERROR                              
         MVC   RFERRMSG,=CL20'ERR FLD LEN = XXXX'                               
         CVD   R2,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  RFERRMSG+14(4),DUB                                               
         L     R1,TMAXERRS                                                      
         LA    R1,1(,R1)                                                        
         ST    R1,TMAXERRS                                                      
         LA    R2,255                                                           
*                                                                               
GETF80   DS    0H                                                               
         NI    RFCTL,X'3F'         CLEAR END CONTROLS                           
         ZIC   RF,RFFLDNO          BUMP FIELD NUMBER                            
         LA    RF,1(RF)                                                         
         STC   RF,RFFLDNO                                                       
         STC   R2,RFLEN            SET FIELD LENGTH                             
*                                                                               
         LTR   R2,R2                                                            
         BNP   GETF84                                                           
         LR    RF,R2                                                            
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   RFDATA(0),0(R4)                                                  
*                                                                               
GETF84   DS    0H                                                               
         LTR   R2,R2                                                            
         BP    *+6                                                              
         SR    R2,R2                                                            
         LA    R6,WDATA(R2)                                                     
         MVC   0(L'FDELIM,R6),FDELIM                                            
         LA    R2,L'FDELIM(,R2)      ADD LENGTH                                 
         STH   R2,WLEN               SET WORK FIELD LENGTH                      
*                                                                               
* NOW BUILD RECORD ITSELF                                                       
*                                                                               
         LH    RE,WLEN                                                          
         BCTR  RE,0                                                             
         L     RF,WRCURPOS                                                      
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),WDATA                                                    
         LA    RE,1(RE,RF)                                                      
         ST    RE,WRCURPOS                                                      
*                                                                               
GETFX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
* GET BLOCK FROM TAPE *                                                         
*                                                                               
         DS    0H                                                               
GBL      NTR1                                                                   
*                                                                               
         NI    RFCTL2,X'FF'-RFCTL2RD  SET OFF NEED READ NEXT REC                
*                                                                               
         L     R2,AEZINPT                                                       
*                                                                               
         OC    SVSRCE,SVSRCE       MUST BE WORKING ON HOLD FILE                 
         BZ    *+8                  NO                                          
         L     R2,=A(EZHOLDR)                                                   
*                                                                               
         L     R6,=A(EZINREC)                                                   
*                                                                               
GBL02    DS    0H                                                               
         XC    0(256,R6),0(R6)                                                  
*                                                                               
         GET   (R2),(R6)                                                        
*                                                                               
         OI    RFCTL,RFCTLREC      SET RECORD READ                              
*                                                                               
         OC    SVSRCE,SVSRCE       MUST BE WORKING ON HOLD FILE                 
         BZ    GBL04                NO                                          
*                                                                               
         MVI   HOLDSW,C'H'         H=HOLD FILE FOR BATCH TOTALS                 
*                                                                               
         CLC   =X'F9F95E',4(R6)    DO NOT COUNT SOURCE/DATE RECS                
         BE    GBL08                                                            
         CLC   =X'F1F25E',4(R6)    DO NOT COUNT FILE TOTALS RECS                
         BE    GBL08                                                            
         L     RF,HDRDCT                                                        
         LA    RF,1(,RF)                                                        
         ST    RF,HDRDCT                                                        
         B     GBL08                                                            
*                                                                               
GBL04    CLC   =X'F1F25E',4(R6)    DO NOT COUNT FILE TOTALS RECS                
         BE    GBL08                                                            
         CLC   SOURCE,=C'STRA'                                                  
         BNE   GBL06                                                            
         CLI   3(R6),C'*'          THIS POSSIBLE STRATA BUY REC                 
         BNE   GBL06                                                            
*                                                                               
* CHECK FOR INTERMIXED STRATA BUY DATA GARBAGE                                  
*                                                                               
         CLC   =C'BUY',0(R6)                                                    
         BE    GBL05                DROP IT                                     
         CLC   =C'DEM',0(R6)                                                    
         BE    GBL05                DROP IT                                     
         CLC   =C'EOF',0(R6)                                                    
         BE    GBL05                DROP IT                                     
         CLC   =C'HDR',0(R6)                                                    
         BE    GBL05                DROP IT                                     
         CLC   =C'SKD',0(R6)                                                    
         BNE   GBL06                                                            
*                                                                               
GBL05    DS   0H                                                                
         L     RF,EZBYCT                                                        
         LA    RF,1(,RF)                                                        
         ST    RF,EZBYCT                                                        
         B     GBL02                DROP IT                                     
*                                                                               
GBL06    DS   0H                                                                
         L     RF,EZRDCT                                                        
         LA    RF,1(,RF)                                                        
         ST    RF,EZRDCT                                                        
*                                                                               
* CHECK IF FIXED (BLOCKED) UNDEFINED OR VARIABLE BLOCK FORMAT *                 
*                                                                               
GBL08    LR    RF,R6               SET STARTING POS                             
*                                                                               
         OC    SVSRCE,SVSRCE       WORKING ON HOLD FILE                         
         BZ    GBL10                TREAT AS VAR BLK (IT IS, TOO)               
         LA    RF,4(,RF)           SKIP PAST LENGTH                             
         ST    RF,RFCURPOS                                                      
         B     GBL16                                                            
*                                                                               
GBL10    CLI   RECFM,C'V'          IF VARIABLE FMT                              
         BNE   *+8                                                              
         LA    RF,4(,RF)           SKIP PAST LENGTH                             
         ST    RF,RFCURPOS                                                      
*                                                                               
         LH    RE,DCBLRECL-IHADCB(,R2)  REC LEN-FIXED/UNDEFINED FMT             
         CLI   RECFM,C'U'                                                       
         BE    GBL20                                                            
         LH    RE,82(,R2)          LENGTH OF RECORD IF FIXED BLOCKED            
*                                                                               
         CLI   RECFM,C'F'                                                       
         BE    GBL20                                                            
         CLI   RECFM,C'V'                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
GBL16    LH    RE,0(,R6)           LENGTH IF VARIABLE FMT                       
         SH    RE,=H'4'                                                         
*                                                                               
GBL20    DS    0H                                                               
         AR    RF,RE                                                            
         ST    RF,EOR              SET EOR                                      
         BAS   RE,TRCREAD          TRACE WORKER FILE RECORD                     
*                                                                               
* FIX SET END OF RECORD AND END OF FILE                                         
*                                                                               
         B     GETFX                                                            
*                                                                               
* END OF FILE ROUTINE FOR LOAD TAPE *                                           
*                                                                               
GETEOFH  DS    0H                  END OF HOLD FILE                             
*                                                                               
*                                  CLEAR STD TOP COMMENTS                       
         L     RE,=A(SAVSCT)                                                    
         LA    RF,SAVSCTLN         GET LENGTH                                   
         XCEF                                                                   
*                                  CLEAR STD BOTTOM COMMENTS                    
*                                                                               
         L     RE,=A(SAVSCB)                                                    
         LA    RF,SAVSCBLN         GET LENGTH                                   
         XCEF                                                                   
         MVC   OLDMEDIA,MEDIA                                                   
         MVI   TOSVMED,C'N'                                                     
         XC    STAFLDS,STAFLDS     CLEAR STATION FIELDS                         
         XC    STAFLDSA,STAFLDSA                                                
         XC    AGYFLDS,AGYFLDS     CLEAR AGENCY FIELDS                          
         L     RE,=A(SAVPAY)                                                    
         LA    RF,SAVPAYLN                                                      
         XCEF                                                                   
         L     RE,=A(SAVAGY)                                                    
         LA    RF,SAVAGYLN                                                      
         XCEF                                                                   
*                                                                               
* INITIALIZE SAVED AGYNAME TO UNKNOWN                                           
         L     RE,=A(SAVAGY)                                                    
         MVC   0(4,RE),=X'001E0000'                                             
         MVC   4(4,RE),=X'F2F15E5E'      21,SEMI,SEMI                           
         MVC   8(20,RE),=CL20'*** UNKNOWN AGY! ***'                             
         MVC   28(2,RE),=X'5E5E'         SEMI,SEMI                              
         OI    SVRECSW,SVRECAGY                                                 
*                                                                               
         L     RE,=A(SAVIDB)                                                    
         LA    RF,SAVIDBLN                                                      
         XCEF                                                                   
*                                                                               
GETEOF   DS    0H                  END OF FILE                                  
*                                                                               
         TM    RFCTL,RFCTLREC      WAS A RECORD READ                            
         BZ    GETEOF20             NO                                          
*                                                                               
         TM    RFCTL,RFCTLEOR       TEST HAVE SENT EOR                          
         BNZ   GETEOF30                                                         
*                                                                               
         TM    RFCTL2,RFCTL2ER      IS SEND EOR NEXT SET                        
         BO    GETEOF10                                                         
*                                                                               
* TEST HERE FOR FOUND DELIMITER                                                 
*                                                                               
*                                                                               
* FIX SET END OF RECORD AND END OF FILE                                         
*                                                                               
         OI    RFCTL,RFCTLFER       SET FIELD ERROR                             
         MVC   RFERRMSG,=CL20'ERR NO REC DELIMITER'                             
         TM    RFCTL,RFCTLEFL       END OF FIELD SET                            
         BZ    *+10                                                             
         MVC   RFERRMSG,=CL20'ERR NO FLD/REC DELIM'                             
         L     R1,TMAXERRS                                                      
         LA    R1,1(,R1)                                                        
         ST    R1,TMAXERRS                                                      
*                                                                               
         OI    RFCTL,RFCTLEOR       SET EOR NOW                                 
         OI    RFCTL2,RFCTL2EF      AND DO EOFILE AFTER                         
         B     GETFX                                                            
*                                                                               
GETEOF10 OI    RFCTL,RFCTLEOR         SET EOR NOW                               
         NI    RFCTL2,X'FF'-RFCTL2ER  SET OFF EOR LATER                         
         OI    RFCTL2,RFCTL2EF        AND DO EOFILE AFTER                       
         B     GETFX                                                            
*                                                                               
GETEOF20 DS    0H                                                               
         OI    RFCTL2,RFCTL2RD        SET ON NEED READ NEXT REC                 
*                                                                               
GETEOF30 DS    0H                                                               
         OI    RFCTL,RFCTLEOF      SET EOFILE                                   
         B     GETFX                                                            
*                                                                               
*        TRCREAD- ROUTINE TO TRACE INPUT FILE READS                             
*                                                                               
TRCREAD  CLI   TRACEREC,C'Y'       TEST TRACING FIELDS                          
         BNER  RE                                                               
*                                                                               
         DS    0H                                                               
TRCREADN NTR1                                                                   
         MVC   P,SPACES                                                         
         GOTO1 =V(PRINTER)                                                      
         L     R6,=A(EZINREC)                                                   
*                                                                               
         OC    SVSRCE,SVSRCE       READING HOLD FILE                            
         BNZ   TRD3                 YES                                         
*                                                                               
         L     R2,AEZINPT                                                       
         LH    R2,82(R2)           LENGTH IF UNDEFINED                          
         CLI   RECFM,C'U'                                                       
         BE    TRD5                                                             
*                                                                               
         CLI   RECFM,C'F'          LENGTH IF FIXED                              
         BE    TRD5                                                             
*                                                                               
TRD3     LH    R2,0(R6)            LENGTH IF VARIABLE FMT                       
*                                                                               
TRD5     DS    0H                                                               
         MVC   P(5),=C'INPUT'                                                   
         EDIT  (R2),(4,P+6),FILL=0                                              
         LA    R3,0(R6,R2)         EOR                                          
*                                                                               
TRD6     LR    R4,R3                                                            
         SR    R4,R6                                                            
         BNP   TRD8                                                             
         CH    R4,=H'100'                                                       
         BNH   *+8                                                              
         LA    R4,100                                                           
*                                                                               
         BCTR  R4,R0                                                            
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   P+11(0),0(R6)                                                    
         LA    R4,1(R4)                                                         
         GOTO1 =V(PRINTER)                                                      
         MVC   P,SPACES                                                         
         LA    R6,0(R6,R4)                                                      
         B     TRD6                                                             
*                                                                               
TRD8     DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P,SPACES                                                         
         XIT1                                                                   
         DROP  RB,RC                                                            
*                                                                               
*        ENDBTCH - END OF BATCH ROUTINE                                         
*                                                                               
         DS    0H                                                               
ENDBTCH  NMOD1 0,**ENDB**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
*                                                                               
* ROLL INVOICE COUNTS AND DOLLARS FOR POSSIBLE TOT REC CHECK                    
*                                                                               
*        L     RF,BDOLG            BATCH SPOT DOLLARS (GROSS)                   
*        CVD   RF,DUB                                                           
         AP    CDOLG,BDOLG                                                      
*        L     RF,BDOLN            BATCH SPOT DOLLARS (GROSS)                   
*        CVD   RF,DUB                                                           
*        AP    CDOLN,DUB                                                        
         AP    CDOLN,BDOLN                                                      
         L     RF,BINVS            AND INVOICE COUNT FOR TOTAL CK               
         A     RF,CINVS                                                         
         ST    RF,CINVS                                                         
*                                                                               
         OC    ID,ID                                                            
         BZ    ENDB24                                                           
         CLI   SVEXCLSW,C'N'       SKIP EXPRESSLY EXCLUDED BATCHES              
         BNE   ENDB10                                                           
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P(17),=C'INVOICES IN BATCH'                                      
*                                                                               
         EDIT  (B4,BINVS),(5,P+24),ZERO=NOBLANK                                 
         GOTO1 =V(PRINTER)                                                      
         MVC   P(5),=C'SPOTS'                                                   
*                                                                               
         EDIT  (B4,BSPTS),(5,P+24),ZERO=NOBLANK                                 
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P(7),=C'DOLLARS'                                                 
*                                                                               
         EDIT  (P8,BDOLN),(14,P+16),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDB10   DS   0H                                                                
         CLI   TEST,C'Y'           IF TEST RUN                                  
         BE    ENDB20               SKIP CLOSE AND COUNTS                       
*                                                                               
         CLI   BATHSW,C'Y'         WAS BATCH OPENED                             
         BE    ENDB14                                                           
*                                                                               
         CLI   SVEXCLSW,C'Y'       IF EXCLSW WAS Y                              
         BE    ENDB20               SKIP ALL, WAS BYPASSED ON INPUT             
*                                                                               
         CLI   SVEXCLSW,C'I'       IF EXCLSW WAS EXCLUDE USER ID                
         BE    ENDB20                                                           
*                                                                               
         CLI   SVEXCLSW,C'S'       IF EXCLSW WAS EXCLUDE STATION                
         BE    ENDB20                                                           
*                                                                               
         CLI   SVEXCLSW,C'*'       IF EXCLSW WAS * UNKNOWN                      
         BE    ENDB16               SKIP CLOSE AND LOADED COUNTS                
*                                                                               
         CLI   SVEXCLSW,C'#'       IF EXCLSW WAS FULL WORKER FILE               
         BE    ENDB16                                                           
*                                                                               
         CLI   SVEXCLSW,C'D'       IF EXCLSW WAS DISK ERROR                     
         BE    ENDB16                                                           
*                                                                               
         DC    H'0'                BIG PROBLEM                                  
*                                                                               
ENDB14   DS   0H                                                                
         CLI   SVEXCLSW,C'N'       EXCLSW MUST HAVE BEEN N                      
         BE    *+6                                                              
         DC    H'0'                                                             
         L     RF,LBTCHS           BUMP LOADED BATCH TOTAL                      
         LA    RF,1(RF)                                                         
         ST    RF,LBTCHS                                                        
*                                                                               
         L     RF,BINVS            ROLL UP LOADED INV COUNT                     
         A     RF,LINVS                                                         
         ST    RF,LINVS                                                         
         L     RF,BSPTS            AND LOADED SPOT COUNT                        
         A     RF,LSPTS                                                         
         ST    RF,LSPTS                                                         
*        L     RF,BDOLN            AND LOADED SPOT DOLLARS                      
*        CVD   RF,DUB                                                           
         AP    LDOLN,BDOLN                                                      
*        L     RF,BDOLG            AND LOADED SPOT DOLLARS                      
*        CVD   RF,DUB                                                           
         AP    LDOLG,BDOLG                                                      
*                                                                               
*        GOTO1 =V(DATAMGR),DMCB,=C'CLOSE',WKRFIL,0,WKRREC,WKRBUF                
*        CLI   8(R1),0                                                          
*        BE    *+6                                                              
*        DC    H'0'                                                             
*                                                                               
         MVI   WRKIACTN,WRKIACLO                                                
         GOTO1 EZWRKIO,WRKIOB                                                   
         CLI   WRKIERRS,0                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* temp debug: re-writing source back to zero out empty fields                   
* 05/29/2013 skipping WRKIADSC call                                             
*            source is written to the batch with wrkianew call                  
*            this is not needed                                                 
*        B     ENDB20                                                           
*                                                                               
*                                                                               
         MVC   WORK(L'EZWCSRCE),WRKEZDSC+EZWCSRCE-EZWCMNT                       
         XC    WRKEZDSC,WRKEZDSC                                                
         MVC   WRKEZDSC+EZWCSRCE-EZWCMNT(L'EZWCSRCE),WORK                       
*                                                                               
         MVI   WRKIACTN,WRKIADSC                                                
         GOTO1 EZWRKIO,WRKIOB                                                   
         CLI   WRKIERRS,0                                                       
         BE    ENDB20                                                           
         DC    H'0'                                                             
*                                                                               
ENDB16   DS   0H                   ADD TO HELD TOTALS                           
         L     RF,HOBAT                                                         
         LA    RF,1(RF)                                                         
         ST    RF,HOBAT                                                         
         L     RF,BINVS                                                         
         A     RF,HOINVS                                                        
         ST    RF,HOINVS                                                        
         L     RF,BSPTS                                                         
         A     RF,HOSPTS                                                        
         ST    RF,HOSPTS                                                        
*        L     RF,BDOLN                                                         
*        CVD   RF,DUB                                                           
         AP    HODOLN,BDOLN                                                     
*        L     RF,BDOLG                                                         
*        CVD   RF,DUB                                                           
         AP    HODOLG,BDOLG                                                     
*                                                                               
ENDB20   DS   0H                                                                
         CLI   HOLDSW,C'H'         H=HOLD FILE FOR BATCH TOTALS                 
         BNE   ENDB22               NO                                          
*                                                                               
         MVI   HOLDSW,0            RESET                                        
         L     RF,BINVS            ROLL UP TO HOLD INPUT TOTALS                 
         A     RF,HIINVS                                                        
         ST    RF,HIINVS                                                        
         L     RF,BSPTS                                                         
         A     RF,HISPTS                                                        
         ST    RF,HISPTS                                                        
*        L     RF,BDOLN                                                         
*        CVD   RF,DUB                                                           
         AP    HIDOLN,BDOLN                                                     
*        L     RF,BDOLG                                                         
*        CVD   RF,DUB                                                           
         AP    HIDOLG,BDOLG                                                     
*                                                                               
         L     RF,HIBAT            BUMP HOLD INPUT BATCH COUNT                  
         LA    RF,1(RF)                                                         
         ST    RF,HIBAT                                                         
         B     ENDB23                                                           
*                                                                               
ENDB22   L     RF,BINVS            ROLL UP INVOICE COUNT                        
         A     RF,TINVS                                                         
         ST    RF,TINVS                                                         
         L     RF,BSPTS            ROLL UP SPOT COUNT                           
         A     RF,TSPTS                                                         
         ST    RF,TSPTS                                                         
*        L     RF,BDOLN            ROLL UP SPOT DOLLARS                         
*        CVD   RF,DUB                                                           
         AP    TDOLN,BDOLN                                                      
*        L     RF,BDOLG            ROLL UP SPOT DOLLARS                         
*        CVD   RF,DUB                                                           
         AP    TDOLG,BDOLG                                                      
*                                                                               
ENDB23   DS    0H                                                               
         L     RF,TBTCHS           BUMP TOTAL BATCH COUNT                       
         LA    RF,1(RF)                                                         
         ST    RF,TBTCHS                                                        
*                                                                               
         XC    BTOTS,BTOTS                                                      
         ZAP   BBYTS,=P'0'                                                      
         ZAP   BDOLN,=P'0'                                                      
         ZAP   BDOLG,=P'0'                                                      
*                                                                               
ENDB24   MVC   OLDSTA,STAFLDS                                                   
*        MVC   OLDSTAD,STAFLDSA                                                 
         MVC   OLDAGY,AGYFLDS                                                   
*                                                                               
* SEE IF THERE WAS A TOTAL RECORD                                               
*                                                                               
         OC    TOTINVS,TOTINVS     ANY TRANS TOTALS                             
         BNZ   ENDB200              NO                                          
         CP    TOTDOLS,=P'0'       ANY TRANS TOT REC                            
         BE    ENDB400              NO                                          
*                                                                               
ENDB200  LA    R2,TOTFILES                                                      
         LA    R0,L'TOTFILES                                                    
ENDB204  CLI   0(R2),0                                                          
         BE    ENDB206                                                          
         LA    R2,1(,R2)                                                        
         BCT   R0,ENDB204                                                       
         DC    H'0'                MAKE TOTFILES LARGER AREA (NOW 512)          
ENDB206  OI    0(R2),X'80'                                                      
*                                                                               
         OC    TOTINVS,TOTINVS     ANY TRANS TOTALS                             
         BZ    ENDB210              NO                                          
         CLC   CINVS,TOTINVS       WE FIND ALL THE INVOICES                     
         BNE   ENDB300              YES                                         
*                                                                               
ENDB210  CP    TOTDOLS,=P'0'       ANY TRANS TOT REC                            
         BE    ENDB360              NO                                          
*                                                                               
         CP    CDOLG,TOTDOLS       WE FIND ALL THE DOLLARS                      
         BE    ENDB360              YES                                         
*                                                                               
ENDB300  DS    0H                                                               
         OI    0(R2),X'08'          SET BAD FLAG                                
         MVI   P+1,C'*'                                                         
         MVC   P+2(99),P+1                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         L     R2,CINVS                                                         
         LA    R3,P+1                                                           
         BAS   RE,EDIT0B                                                        
*                                                                               
         MVC   P+8(13),=C'INVOICES READ'                                        
*                                                                               
         LA    R2,CDOLG                                                         
         LA    R3,P+40                                                          
         BAS   RE,EDIT2AB                                                       
*                                                                               
         MVC   P+55(12),=C'DOLLARS READ'                                        
         GOTO1 =V(PRINTER)                                                      
         L     R2,TOTINVS                                                       
         LA    R3,P+1                                                           
         BAS   RE,EDIT0B                                                        
*                                                                               
         MVC   P+8(20),=C'STATED INVOICES SENT'                                 
*                                                                               
         LA    R2,TOTDOLS                                                       
         LA    R3,P+40                                                          
         BAS   RE,EDIT2AB                                                       
*                                                                               
         MVC   P+55(19),=C'STATED DOLLARS SENT'                                 
         GOTO1 =V(PRINTER)                                                      
         MVI   P+1,C'*'                                                         
         MVC   P+2(99),P+1                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDB360  XC    CINVS,CINVS                                                      
         ZAP   CDOLN,=P'0'                                                      
         ZAP   CDOLG,=P'0'                                                      
         XC    TOTINVS,TOTINVS     CLEAR BOTH TOTAL INVOICES & DOLLARS          
         ZAP   TOTDOLS,=P'0'                                                    
*                                                                               
ENDB400  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    0H                                                               
EDIT0B   NTR1                                                                   
         EDIT  ((R2)),(5,(R3)),ZERO=NOBLANK                                     
EDITXB   XIT1                                                                   
*                                                                               
         DS    0H                                                               
EDIT2AB  NTR1                                                                   
         EDIT  (P8,0(R2)),(14,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
         B     EDITXB                                                           
         DROP  RB,RC                                                            
*                                                                               
*        CKADV - READ GENDIR/FIL FOR ADVNAME RECORD   *                         
*                THIS MAY FORCE INVOICE TO ANOTHER ID *                         
*                                                                               
CKADV    NMOD1 0,**CKADV*                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
*                                                                               
         MVC   SVADVAGY,AGENCY                                                  
         XC    SVADVID,SVADVID                                                  
         XC    SVADVIDN,SVADVIDN                                                
*                                                                               
         L     R1,RFRECST          START OF RECORD = FROM ADDRESS               
*                                                                               
         CLI   RECFM,C'U'          REC TYPE = U                                 
         BNE   CKADV14                                                          
*                                                                               
CKADV10  DS   0H                                                                
         CLI   0(R1),0                                                          
         BH    CKADV14                                                          
         LA    R1,0(R1)                                                         
         B     CKADV10                                                          
*                                                                               
CKADV14  DS   0H                                                                
         CLI   TRACEADV,C'Y'       TRACE ADV PROCESSING                         
         BNE   CKADV16                                                          
*                                                                               
         MVC   P+1(5),=C'CKADV'                                                 
         MVC   P+12(08),=C'STAFLDS='                                            
         MVC   P+20(8),STAFLDS                                                  
         MVC   P+30(09),=C'SVSTAFLD='                                           
         MVC   P+39(8),SVSTAFLD                                                 
         MVC   P+49(05),=C'USID='                                               
         MVC   P+54(8),USID                                                     
         MVC   P+61(09),=C'SVEQVSTA='                                           
         MVC   P+70(4),SVEQVSTA                                                 
         MVC   P+74(1),SVEQVMED                                                 
         GOTO1 =V(PRINTER)                                                      
*                                                                               
CKADV16  DS   0H                                                                
*        CLC   =C'31',0(R1)        THIS REALLY AN INVOICE REC                   
         CLC   =C'31',RFDATA       THIS REALLY AN INVOICE REC                   
         BNE   CKADVX                                                           
*                                                                               
         XC    HALF,HALF                                                        
         XC    DUB,DUB                                                          
* INITIALIZE SVADVUID TO USER ID RESULTING FROM AGYNAM, OFFNAM RECS             
         MVC   SVADVUID,USIDNO                                                  
*                                                                               
         LA    R0,3                FIELDS BEFORE ADV NAME                       
*                                                                               
CKADV20  CLI   0(R1),X'5E'         THIS A FIELD DELIMITER                       
         BE    CKADV24                                                          
         CLI   0(R1),X'15'         THIS A RECORD DELIMITER                      
         BE    CKADVX               GET OUT                                     
         LA    R1,1(,R1)                                                        
         B     CKADV20                                                          
*                                                                               
CKADV24  LA    R1,1(,R1)                                                        
         BCT   R0,CKADV20                                                       
*                                                                               
* NOW PULL ADVNAME OUT OF RECORD                                                
*                                                                               
         MVC   NWADVNM,SPACES                                                   
*                                                                               
         LA    R0,25                                                            
         LA    RE,NWADVNM                                                       
*                                                                               
CKADV26  DS   0H                                                                
         CLI   0(R1),X'5E'                                                      
         BE    CKADV30                                                          
         CLI   0(R1),X'15'         THIS A RECORD DELIMITER                      
         BE    CKADV30                                                          
         MVC   0(1,RE),0(R1)                                                    
         LA    R1,1(,R1)                                                        
         LA    RE,1(,RE)                                                        
         BCT   R0,CKADV26                                                       
*                                                                               
CKADV30  DS   0H                                                                
         MVC   SVADVNM,NWADVNM                                                  
         OC    NWADVNM,SPACES                                                   
*                                                                               
         LA    R0,9                FIELDS BEFORE MOS                            
         L     R1,RFRECST          START OF RECORD = FROM ADDRESS               
*                                                                               
         CLI   RECFM,C'U'          REC TYPE = U                                 
         BNE   CKADV36                                                          
CKADV34  DS   0H                                                                
         CLI   0(R1),0                                                          
         BH    CKADV36                                                          
         LA    R1,0(R1)                                                         
         B     CKADV34                                                          
*                                                                               
CKADV36  DS   0H                                                                
         MVC   WORK(4),SPACES                                                   
*                                                                               
CKADV40  CLI   0(R1),X'5E'         THIS A FIELD DELIMITER                       
         BE    CKADV42                                                          
         CLI   0(R1),X'15'         THIS A RECORD DELIMITER                      
         BE    CKADV48              NOT GOING TO FIND IT                        
         LA    R1,1(,R1)                                                        
         B     CKADV40                                                          
*                                                                               
CKADV42  LA    R1,1(,R1)                                                        
         BCT   R0,CKADV40                                                       
*                                                                               
* NOW PULL MOS OUT OF RECORD                                                    
*                                                                               
         LA    R0,4                                                             
         LA    RE,WORK                                                          
CKADV44  MVC   0(1,RE),0(R1)                                                    
         LA    R1,1(,R1)                                                        
         LA    RE,1(,RE)                                                        
         CLI   0(R1),X'5E'                                                      
         BE    CKADV46                                                          
         CLI   0(R1),X'15'         THIS A RECORD DELIMITER                      
         BE    CKADV46                                                          
         BCT   R0,CKADV44                                                       
*                                                                               
CKADV46  DS   0H                                                                
         MVC   INVMOS,WORK                                                      
*                                                                               
CKADV48  DS   0H                                                                
         CLI   DMGOPT,C'N'         FOR TESTING                                  
         BE    CKADVX               EXIT                                        
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING EZDNMD,R4                                                        
         MVC   EZDKTYP,=C'ZD'      ADVNAME RECORD                               
         MVC   EZDKAGY,AGENCY                                                   
         MVC   EZDKNAM,NWADVNM                                                  
         MVC   KEYSAVE,KEY                                                      
         GOTO1 =V(DATAMGR),DMCB,=C'DMRDHI',=C'GENDIR',KEY,KEY,DMWORK            
         CLC   KEY(32),KEYSAVE                                                  
         BE    CKADV50                                                          
*                                                                               
         OC    KEY(32),SPACES                                                   
         OC    KEYSAVE(32),SPACES                                               
         CLC   KEY(32),KEYSAVE                                                  
         BE    CKADV50                                                          
*                                                                               
         OC    SVADVIDN,SVADVIDN   IF NO PREV CHANGE, NONE NOW                  
         BZ    CKADVX                                                           
         XC    SVADVID,SVADVID                                                  
         XC    SVADVIDN,SVADVIDN                                                
         XC    SVIDSTA,SVIDSTA                                                  
         B     CKADVX                                                           
*                                                                               
CKADV50  DS    0H                                                               
         L     R4,=A(GENREC)                                                    
         GOTO1 =V(DATAMGR),DMCB,=C'GETREC',=C'GENFIL',KEY+EZDDDA-EZDKEYX        
               ,(R4),DMWORK                                                     
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R5,EZDELS                                                        
         MVI   SVSTALEV,0                                                       
*                                                                               
CKADV60  CLI   0(R5),0             EOR                                          
         BE    CKADVX                                                           
*                                                                               
         CLI   0(R5),X'02'         AGY ID ELEM                                  
         BNE   CKADV64                                                          
*                                                                               
         USING EZDIDEL,R5                                                       
         LA    R6,EZDSTA                                                        
         GOTO1 =A(CHKSTA),DMCB,(RC)                                             
*                                                                               
         CLC   STALEV,SVSTALEV     TEST LEVEL OF STATION INFO                   
         BNH   CKADV64              IF NOT HIGH, IGNORE                         
*                                                                               
         MVC   SVSTALEV,STALEV                                                  
*                                                                               
         MVC   HALF,EZDORIG                                                     
         MVC   SVADVUID,HALF                                                    
         MVC   DUB,EZDUID                                                       
         MVC   SVIDSTA,EZDSTA      SAVE STATION,ETC OF BEST ELEM                
*                                                                               
         XC    LKAGYBLK,LKAGYBLK                                                
         MVC   LKAGYBID,HALF                                                    
         BRAS  RE,LKAGY                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   SVADVAGY,LKAGYAGY                                                
*                                                                               
CKADV64  ZIC   R0,1(R5)                                                         
         LTR   R0,R0                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R5,R0                                                            
         B     CKADV60                                                          
*                                                                               
CKADVX   DS  0H                                                                 
         DROP  R4,R5                                                            
*                                                                               
*        CKEQV - READ GENDIR/FIL FOR STATION EQUIVALENCE RECORD *               
*                THIS MAY FORCE INVOICE TO ANOTHER ID           *               
*                                                                               
* ALREADY GOT ADVERTISER NAME IN CKADV ROUTINE *                                
*                                                                               
         CLI   DMGOPT,C'N'         FOR TESTING                                  
         BE    CKEQVX               EXIT                                        
*                                                                               
         XC    SVEQVSTA,SVEQVSTA   CLEAR EQUIVALENT STATION                     
         XC    SVEQVMED,SVEQVMED   CLEAR EQUIVALENT MEDIA                       
         MVI   EQVSTASW,C'N'                                                    
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING EZSTAD,R4                                                        
         MVC   EZSKTYP,=C'ZS'                                                   
*        MVC   EZSKAGY,AGENCY                                                   
         MVC   EZSKAGY,SVADVAGY                                                 
*                                                                               
         OC    SVSTAFLD,SVSTAFLD   IS THIS AN EQUIVALENT STATION                
         BZ    CKEQV10                                                          
*                                                                               
         MVC   STAFLDS,SVSTAFLD    WORK WITH ORIG STATION                       
*                                                                               
CKEQV10  DS    0H                                                               
         MVC   EZSKSTA,STATION                                                  
         MVC   EZSKSTA+4(1),BAND                                                
         CLI   EZSKSTA+4,C'C'                                                   
         BNE   *+8                                                              
         MVI   EZSKSTA+4,C'N'                                                   
*                                                                               
CKEQV20  DS    0H                                                               
         OC    KEY(32),SPACES                                                   
         MVC   KEYSAVE,KEY                                                      
         GOTO1 =V(DATAMGR),DMCB,=C'DMRDHI',=C'GENDIR',KEY,KEY,DMWORK            
*                                                                               
         CLI   TRACEADV,C'Y'       TRACE ADV PROCESSING                         
         BNE   CKEQV30                                                          
         MVC   P+3(3),=C'KEYSAVE'                                               
         MVC   P+11(32),KEY                                                     
         GOTO1 =V(PRINTER)                                                      
         MVC   P+3(7),=C'KEYSAVE'                                               
         MVC   P+11(32),KEYSAVE                                                 
         GOTO1 =V(PRINTER)                                                      
*                                                                               
CKEQV30  DS    0H                                                               
*                                                                               
* TEMP CODE FOR HY, TO FIX FT, G4, H2 AND W STATIONS                            
* CODE WILL REPLACE TRAILING DOTS WITH NULLS                                    
*                                                                               
*        CLC   LKAGYAGY,=C'HY'                                                  
         CLC   LKAGYAGY,=AL2(AGYALPH_HY)                                        
         BNE   CKEQV40                                                          
*                                                                               
         LA    RE,EZSKSTA+L'EZSKSTA-2 LAST CHAR OF STA NAME                     
         LHI   R0,L'EZSKSTA-1                                                   
*                                                                               
CKEQV35  CLI   0(RE),C'A'                                                       
         BH    CKEQV40                                                          
         CLI   0(RE),X'00'                                                      
         BE    *+12                                                             
         CLI   0(RE),X'4B'                                                      
         BNE   *+8                                                              
         MVI   0(RE),X'40'                                                      
         BCTR  RE,0                BACK UP ONE CHAR                             
         BCT   R0,CKEQV35                                                       
*                                                                               
CKEQV40  DS    0H                                                               
         CLC   KEY(32),KEYSAVE                                                  
         BNE   CKEQV70                                                          
*                                                                               
CKEQV50  DS    0H                                                               
         L     R4,=A(GENREC)                                                    
         GOTO1 =V(DATAMGR),DMCB,=C'GETREC',=C'GENFIL',EZSDDA-EZSKEY+KEYX        
               ,(R4),DMWORK                                                     
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R5,EZSELS                                                        
         CLI   0(R5),X'02'         STATION ELEM                                 
         BE    *+6                                                              
         DC    H'0'                                                             
         USING EZSIDEL,R5                                                       
         MVC   SVEQVSTA,EZSCALL    SAVE EQUIVALENT STATION                      
         MVC   SVEQVMED,EZSMED     SAVE EQUIVALENT MEDIA                        
*                                                                               
         MVI   EQVSTASW,C'N'                                                    
*                                                                               
CKEQV60  CLI   0(R5),0             EOR                                          
         BE    CKEQV70                                                          
*                                                                               
         CLI   0(R5),X'22'         AGY ID ELEM                                  
         BNE   CKEQV64                                                          
*                                                                               
         USING EZAUDEL,R5                                                       
         OC    EZAUADV,SPACES                                                   
*                                                                               
         MVC   WORK,SPACES                                                      
         MVC   WORK(3),=C'ALL'                                                  
         CLC   EZAUADV,WORK       ADVNAME = ALL?                                
         BE    CKEQV62                                                          
*                                                                               
         CLC   NWADVNM,EZAUADV    THIS SAME ADVERTISER NAME?                    
         BNE   CKEQV64              NOPE                                        
*                                                                               
CKEQV62  DS    0H                                                               
         MVC   HALF,EZAUORIG                                                    
         MVC   DUB,EZAUUID                                                      
*                                                                               
         MVI   EQVSTASW,C'Y'                                                    
         B     CKEQV68                                                          
*                                                                               
CKEQV64  DS    0H                                                               
         CLI   0(R5),X'32'         AGY ID/STA ELEM                              
         BNE   CKEQV66                                                          
*                                                                               
         USING EZAUSEL,R5                                                       
         OC    EZAUSADV,SPACES                                                  
*                                                                               
         MVC   WORK,SPACES                                                      
         MVC   WORK(3),=C'ALL'                                                  
         CLC   EZAUSADV,WORK      ADVNAME = ALL?                                
         BE    CKEQV65                                                          
*                                                                               
         CLC   NWADVNM,EZAUSADV    THIS SAME ADVERTISER NAME?                   
         BNE   CKEQV68              NOPE                                        
*                                                                               
CKEQV65  DS    0H                                                               
         MVC   HALF,EZAUSORG                                                    
         MVC   DUB,EZAUSUID                                                     
         MVC   SVEQVSTA,EZSSCALL   SAVE EQUIVALENT STATION                      
         MVC   SVEQVMED,EZSSMED     AND MEDIA BAND                              
*                                                                               
         MVI   EQVSTASW,C'Y'                                                    
         B     CKEQV68              NOPE                                        
*                                                                               
CKEQV66  DS    0H                                                               
         CLI   0(R5),X'34'                                                      
         BNE   CKEQV67                                                          
*                                                                               
         USING EZA2SEL,R5                                                       
         OC    EZA2SADV,SPACES                                                  
*                                                                               
         MVC   WORK,SPACES                                                      
         MVC   WORK(3),=C'ALL'                                                  
         CLC   EZA2SADV,WORK      ADVNAME = ALL?                                
         BE    CKEQV66A                                                         
*                                                                               
         CLC   NWADVNM,EZA2SADV    THIS SAME ADVERTISER NAME?                   
         BNE   CKEQV68              NOPE                                        
*                                                                               
CKEQV66A DS    0H                                                               
         MVC   HALF,EZA2SORG                                                    
         MVC   DUB,EZA2SUID                                                     
         MVC   SVEQVSTA,EZS2CALL   SAVE EQUIVALENT STATION                      
         MVC   SVEQVMED,EZS2MED     AND MEDIA BAND                              
*                                                                               
         MVI   EQVSTASW,C'Y'                                                    
         B     CKEQV68              NOPE                                        
*                                                                               
CKEQV67  DS    0H                                                               
         CLI   0(R5),X'42'         AGY ID/STA ELEM                              
         BNE   CKEQV68                                                          
*                                                                               
         USING EZRDEL,R5                                                        
         CLC   SVADVUID,EZRDBUID                                                
         BNE   CKEQV68                                                          
*                                                                               
         MVC   HALF,EZRDBUID                                                    
         MVC   DUB,EZRDUID                                                      
         MVC   SVEQVSTA,EZRDCALL   SAVE EQUIVALENT STATION                      
         MVC   SVEQVMED,EZRDMED     AND MEDIA BAND                              
         MVI   EQVSTASW,C'Y'                                                    
         B     CKEQV68                                                          
*                                                                               
CKEQV68  DS    0H                                                               
         ZIC   R0,1(R5)                                                         
         LTR   R0,R0                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R5,R0                                                            
         B     CKEQV60                                                          
*                                                                               
CKEQV70  DS   0H                                                                
         CLI   TRACEADV,C'Y'       TRACE ADV PROCESSING                         
         BNE   CKEQV74                                                          
*                                                                               
         MVC   P+1(7),=C'CKEQV70'                                               
         MVC   P+9(9),=C'EQVSTASW='                                             
         MVC   P+18(1),EQVSTASW                                                 
         MVC   P+22(08),=C'STAFLDS='                                            
         MVC   P+30(8),STAFLDS                                                  
         MVC   P+40(09),=C'SVSTAFLD='                                           
         MVC   P+49(8),SVSTAFLD                                                 
         MVC   P+59(05),=C'USID='                                               
         MVC   P+64(8),USID                                                     
         MVC   P+71(09),=C'SVEQVSTA='                                           
         MVC   P+80(4),SVEQVSTA                                                 
         MVC   P+84(1),SVEQVMED                                                 
         GOTO1 =V(PRINTER)                                                      
*                                                                               
CKEQV74  DS   0H                                                                
         OC    HALF,HALF           IF NOTHING FOUND                             
         BZ    CKEQV80              SEE IF SAVED STATION                        
*                                                                               
         MVC   USIDNO,HALF                                                      
         MVC   USID,DUB                                                         
*                                                                               
         CLI   EQVSTASW,C'Y'        USE EQUIVALENT STATION                      
         BNE   CKEQV80                                                          
*                                                                               
         OC    SVSTAFLD,SVSTAFLD   WAS STATION ALREADY SAVED                    
         BNZ   CKEQV76                                                          
*                                                                               
         MVC   SVSTAFLD,STAFLDS                                                 
*                                                                               
CKEQV76  DS   0H                                                                
         MVC   STATION,SVEQVSTA    USE EQUIVALENT STATION                       
         MVC   MEDIA(1),SVEQVMED                                                
         MVC   BAND(1),SVEQVMED                                                 
         B     CKEQVX                                                           
*                                                                               
CKEQV80  DS   0H                                                                
         CLI   TRACEADV,C'Y'       TRACE ADV PROCESSING                         
         BNE   CKEQV84                                                          
*                                                                               
         MVC   P+1(7),=C'CKEQV80'                                               
         MVC   P+9(9),=C'EQVSTASW='                                             
         MVC   P+18(1),EQVSTASW                                                 
         MVC   P+22(08),=C'STAFLDS='                                            
         MVC   P+30(8),STAFLDS                                                  
         MVC   P+40(09),=C'SVSTAFLD='                                           
         MVC   P+49(8),SVSTAFLD                                                 
         MVC   P+59(05),=C'USID='                                               
         MVC   P+64(8),USID                                                     
         MVC   P+71(09),=C'SVEQVSTA='                                           
         MVC   P+80(4),SVEQVSTA                                                 
         MVC   P+84(1),SVEQVMED                                                 
         GOTO1 =V(PRINTER)                                                      
CKEQV84  DS   0H                                                                
         OC    SVSTAFLD,SVSTAFLD   WAS STATION ALREADY SAVED                    
         BZ    CKEQVX               NO, NO RESTORE NEEDED                       
*                                                                               
         MVC   STAFLDS,SVSTAFLD    RESTORE STATION AS SAVED                     
         XC    SVSTAFLD,SVSTAFLD                                                
*                                                                               
CKEQVX   DS  0H                                                                 
         XIT1                                                                   
         DROP  R4,R5,RB,RC                                                      
*                                                                               
*              READ GENDIR/FIL FOR USER ID FOR AGENCY/OFFICE                    
*                                                                               
GETUID   NMOD1 0,**GETU**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
         CLC   SOURCE,=C'WIM '     WIM SOURCE IS ALL WIBIS                      
         BNE   GU010                                                            
*                                                                               
         MVC   USIDNO,=H'4001'                                                  
         MVC   USID,=CL8'WIBIS'                                                 
*        MVC   AGENCY,=C'WI'                                                    
         MVC   AGENCY,=AL2(AGYALPH_WI)                                          
         B     GU034                                                            
*                                                                               
GU010    DS    0H                                                               
         CLC   SOURCE,=C'BDS '     BDS, MEDIA C, N OR S, FORCE TO SJR           
         BNE   GU020                                                            
*                                                                               
         CLI   MEDIA,C'C'                                                       
         BE    GU030                                                            
         CLI   MEDIA,C'N'                                                       
         BE    GU030                                                            
         CLI   MEDIA,C'S'                                                       
         BE    GU030                                                            
*                                                                               
GU020    DS    0H                                                               
         CLI   DMGOPT,C'N'         FOR TESTING                                  
         BNE   GU040                                                            
*                                                                               
GU030    DS    0H                                                               
         OC    FCBID,FCBID                                                      
         BZ    GU031                                                            
*                                                                               
         MVC   USIDNO,FCBID                                                     
         MVC   USID,FCUID                                                       
         MVC   AGENCY,FCAGY                                                     
         B     GU034                                                            
*                                                                               
GU031    DS    0H                                                               
         MVC   USIDNO,=X'0011'       SJR                                        
         MVC   USID,=CL8'SJR'                                                   
*        MVC   AGENCY,=C'SJ'                                                    
         MVC   AGENCY,=AL2(AGYALPH_SJ)                                          
*                                                                               
GU034    DS    0H                                                               
         CLI   EXCLSW,C'#'         IS THIS WORKER FILE FULL                     
         BE    GETUIDX                                                          
*                                                                               
         CLI   UNKNSW,X'00'                                                     
         BNE   GU040                                                            
*                                                                               
         MVI   EXCLSW,C'N'                                                      
         B     GETUIDX                                                          
*                                                                               
* USER ID NOT HARD-CODED HERE                                                   
*                                                                               
GU040    DS    0H                                                               
         CLI   EXCLSW,C'#'         TEST WORKER FILE FULL                        
         BE    GETUIDX                                                          
*                                                                               
         XC    USIDNO,USIDNO                                                    
         MVC   USID,=CL8'*UNKNOWN'                                              
*                                                                               
         CLI   UNKNSW,X'00'        SENDING TO UNKNOWNS?                         
         BNE   GU300                                                            
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING EZANMD,R4                                                        
         MVC   EZAKTYP,=C'ZA'                                                   
         MVC   EZAKNAM,AGYNAME                                                  
*                                                                               
         CLI   IDBFLAG,C'Y'        DO WE HAVE AGY NAME FROM 76 RECORD?          
         BNE   GU055               NO - USE DATA FROM AGY NAME RECORD           
         CLC   IDBAGYN,SPACES      ANYTHING THERE?                              
         BNH   GU300               NO - SEND TO UNKNOWNS FILE                   
         MVC   EZAKNAM,IDBAGYN                                                  
*                                                                               
GU055    DS    0H                                                               
         MVC   KEYSAVE,KEY                                                      
         GOTO1 =V(DATAMGR),DMCB,=C'DMRDHI',=C'GENDIR',KEY,KEY,DMWORK            
         CLC   KEY(32),KEYSAVE                                                  
         BE    GU060                                                            
         OC    KEY(32),SPACES                                                   
         OC    KEYSAVE(32),SPACES                                               
         CLC   KEY(32),KEYSAVE                                                  
         BNE   GU300                                                            
*                                                                               
GU060    DS    0H                                                               
         GOTO1 =V(DATAMGR),DMCB,=C'GETREC',=C'GENFIL',EZADDA,          X        
               A(GENREC),DMWORK                                                 
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R4,=A(GENREC)                                                    
         LA    R5,EZAELS           FIRST ELEMENT                                
         MVI   SVSTALEV,0          SET LEVEL OF STATION INFO                    
*                                                                               
GU080    DS    0H                                                               
         CLI   0(R5),0             EOR                                          
         BE    GU200                                                            
         CLI   0(R5),X'02'         AGY ID ELEM                                  
         BE    GU120                                                            
         CLI   0(R5),X'05'         OFFICE ID ELEM                               
         BE    GU130                                                            
*                                                                               
GU090    DS    0H                                                               
         ZIC   R0,1(R5)                                                         
         LTR   R0,R0                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R5,R0                                                            
         B     GU080                                                            
*                                                                               
         USING EZAIDEL,R5                                                       
GU120    LA    R6,EZASTA                                                        
         GOTO1 =A(CHKSTA),DMCB,(RC)                                             
*                                                                               
         CLC   STALEV,SVSTALEV     TEST LEVEL OF STATION INFO                   
         BNH   GU090               IF NOT HIGH, IGNORE                          
*                                                                               
         MVC   SVSTALEV,STALEV                                                  
*                                                                               
         MVC   USIDNO,EZAORIG      ELSE SAVE ORIGIN                             
         MVC   USID,EZAUID                                                      
         MVC   SVIDSTA,EZASTA      SAVE STATION,ETC OF BEST ELEM                
         B     GU090                                                            
*                                                                               
         USING EZOIDEL,R5                                                       
GU130    DS    0H                                                               
         CLI   IDBFLAG,C'Y'                                                     
         BNE   GU140                                                            
         CLI   IDBOFFNL,0                                                       
         BNH   GU090                                                            
         ZIC   RF,IDBOFFNL                                                      
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   IDBOFFN(0),EZONAM                                                
         BNE   GU090               NEXT ELEM                                    
         B     GU150                                                            
*                                                                               
GU140    DS    0H                                                               
*                                  TEST AGY ADDRESS FOR OFFICE NAME             
         ZIC   RF,1(R5)                                                         
         SH    RF,=Y(EZONAM-EZOIDEL)    RF HAS NAME LENGTH                      
         STC   RF,BYTE                                                          
         GOTO1 =V(TSCAN),DMCB,AGYLIN1,120,(BYTE,EZONAM),(BYTE,EZONAM)           
*                                                                               
         CLI   DMCB+16,0           TEST NAME FOUND                              
         BE    GU090               NO- NEXT ELEM                                
*                                                                               
GU150    DS    0H                                                               
         LA    R6,EZOSTA                                                        
         GOTO1 =A(CHKSTA),DMCB,(RC)                                             
*                                                                               
         CLC   STALEV,SVSTALEV     TEST LEVEL OF STATION INFO                   
         BNH   GU090               IF NOT HIGH, IGNORE                          
*                                                                               
         MVC   SVSTALEV,STALEV                                                  
*                                                                               
         MVC   USIDNO,EZOORIG      ELSE SAVE ORIGIN                             
         MVC   USID,EZOUID                                                      
         MVC   SVIDSTA,EZOSTA      SAVE STATION,ETC OF BEST ELEM                
         B     GU090                                                            
         DROP  R5                                                               
*                                                                               
*                                  NOW CHECK FOR INCLUSION/EXCLUSION            
*                                                                               
GU200    DS    0H                                                               
         OC    USIDNO,USIDNO       TEST ID FOUND                                
         BZ    GU300                NO                                          
*                                                                               
         CLI   EXCLSW,C'#'         TEST WORKER FILE FULL                        
         BE    GETUIDX                                                          
*                                                                               
         CLI   EXCLSW,C'S'         TEST STATION EXCLUDED                        
         BE    GETUIDX                                                          
*                                                                               
         MVI   EXCLSW,C'N'                                                      
*                                                                               
         OC    IDTPARS+8(4),IDTPARS+8  TEST HAVE ANY ID LIST                    
         BZ    GU400                    NO, OK                                  
*                                                                               
         MVC   WORK(8),USID        SEE IF THIS ONE IN LIST                      
         GOTO1 =V(BINSRCH),IDTPARS,WORK                                         
         CLI   0(R1),0                                                          
         BNE   GU220                                                            
*                                  ID IS IN LIST                                
         CLI   IDMODE,C'+'       TEST TO INCLUDE ONLY THOSE IN LIST             
         BE    GU400                                                            
         B     GU240                                                            
*                                                                               
GU220    DS    0H                  ID NOT IN LIST                               
         CLI   IDMODE,C'+'         TEST TO INCLUDE ONLY THOSE IN LIST           
         BNE   GU400                                                            
*                                                                               
GU240    MVI   EXCLSW,C'I'         EXCLUDE USER ID                              
         B     GETUIDX                                                          
*                                                                               
GU300    DS    0H                                                               
         MVI   EXCLSW,C'*'         SET TO EXCLUDE BECAUSE NOT FOUND             
         B     GETUIDX                                                          
*                                                                               
GU400    DS    0H                                                               
         XC    LKAGYBLK,LKAGYBLK                                                
         MVC   LKAGYBID,USIDNO                                                  
         BRAS  RE,LKAGY                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   AGENCY,LKAGYAGY                                                  
*                                                                               
GETUIDX  DS    0H                                                               
         XIT1                                                                   
*        DROP  R4,R6,RB,RC                                                      
         DROP  R4,RB,RC                                                         
*                                                                               
*                                                                               
*                                                                               
*        CHKSTA- CHECK STATION IN IDELEM                                        
*        (R6 POINTS TO STATION-MEDIA)                                           
*                                                                               
         DS    0H                                                               
CHKSTA   NMOD1 0,**CKST**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
*                                                                               
         MVC   BYTE,MEDIA                                                       
         CLI   BYTE,C'C'                                                        
         BNE   *+8                                                              
         MVI   BYTE,C'N'                                                        
*                                                                               
         SR    R2,R2               START AT LEVEL 0                             
*                                                                               
         CLI   0(R5),X'05'         THIS AN OFFICE ELEMENT (EZOIDEL)             
         BNE   *+8                                                              
         AHI   R2,10               OFFICE IS MORE SPECIFIC THAN AGENCY          
*                                                                               
         CLC   0(4,R6),=C'ALL '    ALL STATIONS?                                
         BNE   CKS10                                                            
*                                                                               
         AHI   R2,1                ALL-A, LEVEL 1                               
*                                                                               
         CLI   4(R6),C' '          ALL MEDIA?                                   
         BE    CKSX                                                             
         CLI   4(R6),C'A'          ALL MEDIA?                                   
         BE    CKSX                                                             
*                                                                               
         AHI   R2,1                ALL-M, LEVEL 2                               
*                                                                               
         CLC   4(1,R6),BYTE                                                     
         BE    CKSX                                                             
         B     CKS60                                                            
*                                                                               
* SPECIFIC STATION HERE                                                         
*                                                                               
CKS10    DS    0H                                                               
         AHI   R2,3                SPECIFIC STATION, LEVEL 3                    
*                                                                               
         MVC   FULL,0(R6)          SAVE STATION CALL LETTERS                    
         CLI   FULL+3,C' '         IF BLANK                                     
         BNE   *+8                                                              
         MVI   FULL+3,0            FORCE TO NULL                                
*                                                                               
         CLC   FULL,STATION        OR = TO THIS STATION                         
         BNE   CKS60                                                            
*                                                                               
CKS20    DS    0H                                                               
         CLC   4(1,R6),BAND                                                     
         BE    CKSX                                                             
*                                                                               
CKS60    SR    R2,R2               ELSE FAILS ON MEDIA                          
*                                                                               
CKSX     DS    0H                                                               
         STC   R2,STALEV                                                        
         J     EQXIT                                                            
         DROP  RB,RC                                                            
*                                                                               
*                                                                               
*                                                                               
*        NEWIND - BUILD NEW WORKER INDEX AND PRINT HEADLINES                    
*                                                                               
         DS    0H                                                               
NEWIND   NMOD1 0,**NEWI**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
         MVI   SVRECSW,X'FF'       SET NEED TO PUT ALL SAVES                    
*                                                                               
         XC    ID,ID                                                            
         LA    R4,ID                                                            
         USING EZWKRIXD,R4                                                      
*                                                                               
         MVI   BATHSW,C'N'         SET TO NO BATCH OPEN                         
*                                                                               
         MVC   EZWISTN,STATION     CALL LETTERS                                 
         MVI   EZWIDAY,X'99'       DAY = 99                                     
         MVC   EZWIMED,BAND        FOR RADIO USE BAND AS MEDIA                  
*                                                                               
NI10     DS    0H                      TEST FOR STATION INCL/EXCL               
         MVC   BILSTA(4),EZWISTN                                                
         MVC   BILSTA+4(1),EZWIMED                                              
*                                                                               
         CLI   EXCLSW,C'*'         THIS UNKNOWN AGENCY                          
         BE    NI24                                                             
*                                                                               
         MVI   EXCLSW,C'N'                                                      
*                                                                               
         OC    IDTPARS+8(4),IDTPARS+8   TEST HAVE ANY ID LIST                   
         BZ    NI16                      NO, OK                                 
         MVC   WORK(8),USID             SEE IF THIS ONE IN LIST                 
*                                                                               
         GOTO1 =V(BINSRCH),IDTPARS,WORK                                         
         CLI   0(R1),0                                                          
         BNE   NI12                                                             
*                                  ID IS IN LIST                                
         CLI   IDMODE,C'+'       TEST TO INCLUDE ONLY THOSE IN LIST             
         BE    NI16                                                             
*                                  ID IS IN LIST                                
         B     NI14                                                             
*                                                                               
NI12     DS    0H                  ID NOT IN LIST                               
         CLI   IDMODE,C'+'         TEST TO INCLUDE ONLY THOSE IN LIST           
         BNE   NI16                                                             
*                                                                               
NI14     MVI   EXCLSW,C'I'         EXCLUDED USER ID                             
         B     NIX                                                              
*                                                                               
NI16     OC    STTPARS+8(4),STTPARS+8  TEST HAVE ANY STATION LIST               
         BZ    NI24                NO, OK                                       
         MVC   WORK(4),EZWISTN     SEE IF THIS ONE IN LIST                      
         OI    WORK+3,X'40'                                                     
         MVC   WORK+4(1),EZWIMED                                                
         GOTO1 =V(BINSRCH),STTPARS,WORK                                         
         CLI   0(R1),0                                                          
         BNE   NI20                                                             
*                                                                               
         DROP  R4                                                               
*                                  STATION IS IN LIST                           
         CLI   STMODE,C'+'       TEST TO INCLUDE ONLY THOSE IN LIST             
         BE    NI24                                                             
         B     NI22                                                             
*                                                                               
NI20     DS    0H                  STATION NOT IN LIST                          
         CLI   STMODE,C'+'         TEST TO INCLUDE ONLY THOSE IN LIST           
         BNE   NI24                                                             
NI22     MVI   EXCLSW,C'S'         EXCLUDE STATION                              
         B     NIX                                                              
*                                                                               
NI24     DS    0H                                                               
         MVC   LINE,=PL2'200'      FORCE NEW PAGE                               
         MVC   P(6),=C'SOURCE'                                                  
         MVC   P+10(4),SOURCE                                                   
         MVC   P+20(L'STACSYS),STACSYS  DISPLAY STATION COMPUTER SYSTEM         
*                                                                               
         OC    HOLDDATE,HOLDDATE   IS THIS AN OLD BATCH                         
         BZ    NI30                 NO                                          
*                                                                               
         MVC   P+40(9),=C'EZLOAD OF'                                            
         GOTO1 =V(DATCON),DMCB,(0,HOLDDATE),(5,P+50)                            
*                                                                               
         CLI   EXCLSW,C'N'                                                      
         BE    NI30                                                             
         CLC   HOLDDATE,HOLDCUT                                                 
         BNL   NI30                                                             
*                                                                               
         EDIT  (B4,=AL4(HOLDCUTQ)),MSG001B                                      
         MVC   P+70(L'MSG001),MSG001                                            
         B     NI30                                                             
*                                                                               
MSG001   DC    0CL(MSG001LQ)                                                    
MSG001A  DC    C'DISCARDING: DATA OLDER THAN '                                  
MSG001B  DC    C'  '                                                            
MSG001C  DC    C' MONTHS'                                                       
MSG001LQ EQU   *-MSG001A                                                        
*                             ----+----1----+----2----+----3----+----4          
*                                                                               
NI30     DS    0H                                                               
         CLI   TEST,C'Y'                                                        
         BNE   NI34                                                             
         MVC   P+59(10),=C'(TEST RUN)'                                          
NI34     DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CLI   EXCLSW,C'*'         EXCLUDE SWITCH = UNKNOWN AGY                 
         BE    NI50                DON'T OPEN                                   
*                                                                               
         CLI   EXCLSW,C'I'         EXCLUDE SWITCH = EXCLUDE USER ID             
         BE    NI50                DON'T OPEN                                   
*                                                                               
         CLI   EXCLSW,C'S'         EXCLUDE SWITCH = EXCLUDE STATION             
         BE    NI50                DON'T OPEN                                   
*                                                                               
         MVC   ID(2),USIDNO                                                     
*                                                                               
*        GOTO1 =V(DATAMGR),DMCB,(0,=C'GFILE'),=C'WRKFIL',ID,WKRREC,    C        
               WKRBUF                                                           
*        CLI   8(R1),0                                                          
*        BE    *+6                                                              
*        DC    H'0'                                                             
*                                                                               
*        USING UKRECD,R4                                                        
*        MVC   WKRFIL,UKUSRINF                                                  
*        DROP  R4                                                               
*                                                                               
* FAKE INDEX CALL TO GET THE FILE NUMBER                                        
*                                                                               
         XC    WRKEZKEY,WRKEZKEY                                                
         MVC   WRKEZUID,ID                                                      
         MVI   WRKIACTN,WRKIANDX                                                
         GOTO1 EZWRKIO,WRKIOB                                                   
         CLI   WRKIERRS,WRKIEEOF                                                
         BE    *+14                                                             
         CLI   WRKIERRS,0                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   WKRFIL,WRKIFILE                                                  
*                                                                               
         CLI   EXCLSW,C'N'         EXCLUDE SWITCH                               
         BNE   NI49                DON'T OPEN                                   
*                                                                               
         CLI   TEST,C'Y'                                                        
         BE    NI49                                                             
*                                                                               
         L     R5,WKRREC                                                        
         XC    0(WLSOFEND-WLHDRD,R5),0(R5)                                      
         USING WLHDRD,R5                                                        
*                                                                               
         MVC   WLINDEX,ID                                                       
*                                                                               
         MVC   WLAGELD,TODAYC                                                   
         MVC   WLDATEL,TODAYC                                                   
*        MVC   WLAGEDD,=X'FFFF'                                                 
         XC    WLUDATA,WLUDATA                                                  
*                                                                               
         XC    SVPMOS,SVPMOS                                                    
*                                                                               
         LA    R0,4                                                             
         LA    R1,INVMOS                                                        
NI35     BRAS  RE,ISNUM            SEE IF 4 DIGITS                              
         JNE   *+2                                                              
         LA    R1,1(,R1)                                                        
         BCT   R0,NI35                                                          
*                                                                               
         CLC   INVMOS+2(2),=C'01'                                               
         JL    *+2                                                              
         CLC   INVMOS+2(2),=C'12'                                               
         JH    *+2                                                              
*                                                                               
         CLC   INVMOS(2),=C'15'                                                 
         BH    NI35A               DO NOT FILL IN THE 1-BYTE MOS                
*                                                                               
* 1-BYTE MOS                                                                    
* PROCESS YEAR                                                                  
         PACK  DUB,INVMOS(2)                                                    
         CVB   R1,DUB                                                           
         SLL   R1,4                                                             
         STCM  R1,1,WLUDATA                                                     
* PROCES MONTH                                                                  
         PACK  DUB,INVMOS+2(2)                                                  
         CVB   R1,DUB                                                           
         STCM  R1,1,BYTE                                                        
*                                                                               
         OC    WLUDATA(1),BYTE                                                  
*                                                                               
* 2-BYTE MOS FIELD                                                              
NI35A    DS    0H                                                               
         PACK  DUB,INVMOS                                                       
         SRP   DUB,1,0                                                          
         MVC   SVPMOS,DUB+L'DUB-3                                               
*                                                                               
NI35C    DS    0H                                                               
         MVC   WLAGELT,=X'FFFF'                                                 
         MVC   WLRETNL,=X'FFFF'                                                 
         MVC   WLRETND,=X'FFFF'                                                 
*                                                                               
         LA    RE,WLDESC           COMMENT AREA                                 
         USING EZWKRCMD,RE                                                      
         XC    EZWCMNT,EZWCMNT                                                  
         MVC   EZWCSRCE,SOURCE                                                  
         DROP  RE                  EZWKRCMD,RE                                  
*                                                                               
*        GOTO1 =V(DATAMGR),DMCB,=C'OPEN',WKRFIL,0,WKRREC,WKRBUF                 
*        CLI   DMCB+8,0            ANY ERROR                                    
*        BE    NI40                 NO                                          
*                                                                               
         XC    WRKEZKEY(WRKUSINF-WRKEZKEY),WRKEZKEY                             
         MVC   WRKEZKEY,ID                                                      
         MVC   WRKEZUDT,WLUDATA                                                 
         MVC   WRKEZMOS,SVPMOS                                                  
*                                                                               
         MVC   WRKEZDSC,WLDESC     ORIGINAL DESCRIPTION                         
         MVC   WRKEZBDT,WLAGELD    BATCH DATE                                   
         MVI   WRKIACTN,WRKIANEW                                                
         GOTO1 EZWRKIO,WRKIOB                                                   
         CLI   WRKIERRS,0                                                       
         BE    NI40                                                             
*                                                                               
* ERROR ON WRKF 'OPEN', DO NOT RECOVER                                          
         DC    H'0'                                                             
*                                                                               
         DROP  R5                  WLHDRD,R5                                    
*                                                                               
*                                                                               
NI40     DS   0H                                                                
         MVI   BATHSW,C'Y'         SET TO BATCH OPEN                            
*                                                                               
         MVC   P+20(8),=C'WKR SEQ='                                             
         EDIT  WRKEZSQN,(6,P+28),ALIGN=LEFT                                     
*                                                                               
* ADD TO WORKER FILE TABLE COUNT *                                              
*                                                                               
NI49     LA    R0,16                                                            
         LA    R1,WKRTAB                                                        
         CLC   0(1,R1),WKRFIL+4    THIS THE FILE                                
         BE    *+14                 YES, ADD 1 TO COUNT                         
         LA    R1,4(,R1)                                                        
         BCT   R0,*-14             TRY 16 TIMES                                 
         DC    H'0'                                                             
         AP    1(3,R1),=P'1'                                                    
*                                                                               
         MVC   P+38(5),WKRFIL                                                   
*                                                                               
NI50     DS    0H                                                               
         MVC   P(7),=C'STATION'                                                 
         MVC   P+10(4),STATION                                                  
         MVI   P+14,C'-'                                                        
*                                                                               
         LA    R1,BAND                                                          
         ICM   R1,8,=AL1(EZMTBNDQ)                                              
         GOTO1 =V(GETMED)                                                       
         BNE   *+14                                                             
         MVC   P+15(L'EZMTPMED),EZMTPMED-EZMEDTBD(RF)                           
         B     *+10                                                             
         MVC   P+15(2),MEDIA       THEN USE MEDIA                               
*                                                                               
*        MVC   P+15(2),BAND        SHOW -AM/-FM/-TV/-N/-C/-S                    
*                                                                               
*        CLC   BAND,SPACES         IS THERE ANYTHING IN BAND                    
*        BH    *+10                                                             
*        MVC   P+15(2),MEDIA       THEN USE MEDIA                               
*                                                                               
         CLI   EQVSTASW,C'Y'       THIS EQUIVALENT STATION                      
         BNE   NI54                 NOPE                                        
*                                                                               
         MVC   P+60(19),=C'EQUIVALENT  SENT AS'                                 
         MVC   P+80(5),SVSTAFLD                                                 
*                                                                               
NI54     DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P(7),=C'USER ID'                                                 
         MVC   P+10(8),USID                                                     
         MVI   P+19,C'('                                                        
         MVI   P+24,C')'                                                        
         EDIT  (B2,USIDNO),(4,P+20),FILL=0                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CLI   IDBFLAG,C'Y'                                                     
         BNE   NI55                                                             
         MVC   P(7),=C'76 REC '                                                 
         MVC   P+10(25),IDBAGYN                                                 
         OC    P+10(25),SPACES                                                  
         GOTO1 =V(PRINTER)                                                      
*                                                                               
NI55     DS    0H                                                               
         MVC   P(7),=C'AGENCY '                                                 
         MVC   P+10(25),AGYNAME                                                 
         OC    P+10(25),SPACES                                                  
*                                                                               
         MVC   SVAGYFL,AGYFLDS     SAVE FOR ADDING TO AGENCY NAME TABLE         
         MVC   SVMEDIA,MEDIA                                                    
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,AGYLIN1          AGENCY ADDRESS LINES                         
         LA    R5,4                                                             
*                                                                               
NI60     DS    0H                                                               
         CLI   0(R4),C' '                                                       
         BNH   NI64                                                             
         MVC   P+10(30),0(R4)                                                   
         OC    P+10(30),SPACES                                                  
         GOTO1 =V(PRINTER)                                                      
NI64     DS    0H                                                               
         LA    R4,30(R4)                                                        
         BCT   R5,NI60                                                          
*                                                                               
         CLI   EXCLSW,C'N'                                                      
         BE    NI70                                                             
         GOTO1 =V(PRINTER)                                                      
         MVC   P(36),=C'** BATCH NOT ADDED TO WORKER FILE **'                   
         GOTO1 =V(PRINTER)                                                      
*                                                                               
NI70     DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
         L     R4,=A(COLHDS1)                                                   
         MVC   P,0(R4)             COLUMN HEADINGS                              
         GOTO1 =V(PRINTER)                                                      
         MVC   P,132(R4)                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
NIX      DS    0H                                                               
         XIT1                                                                   
*                                                                               
* COUNTS OF BATCHES TO WHICH WORKER FILE *                                      
*                                                                               
WKRTAB   DC    C'1',PL3'0'                                                      
         DC    C'2',PL3'0'                                                      
         DC    C'3',PL3'0'                                                      
         DC    C'4',PL3'0'                                                      
         DC    C'5',PL3'0'                                                      
         DC    C'6',PL3'0'                                                      
         DC    C'7',PL3'0'                                                      
         DC    C'8',PL3'0'                                                      
         DC    C'9',PL3'0'                                                      
         DC    C'A',PL3'0'                                                      
         DC    C'B',PL3'0'                                                      
         DC    C'C',PL3'0'                                                      
         DC    C'D',PL3'0'                                                      
         DC    C'E',PL3'0'                                                      
         DC    C'F',PL3'0'                                                      
         DC    C'G',PL3'0'                                                      
*                                                                               
*        RUNTOT - PRINT ALL RUN TOTALS *                                        
*                                                                               
         DS    0H                                                               
RUNTOT   NMOD1 0,**RUNT**                                                       
         L     RC,0(,R1)                                                        
         USING EZLDWKD,RC                                                       
*                                                                               
         MVC   P+2(10),=C'RUN TOTALS'                                           
         GOTO1 =V(PRINTER)                                                      
         MVC   P+2(10),DASHES                                                   
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+15(9),=C'**INPUT**'                                            
         GOTO1 =V(PRINTER)                                                      
         MVC   P+10(19),DASHES                                                  
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+2(7),=C'EZINPUT'                                               
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+2(14),=C'TOTAL INVOICES'                                       
         L     R2,TINVS                                                         
         LA    R3,P+26                                                          
         BAS   RE,EDIT0R                                                        
*                                                                               
         MVC   P+35(12),=C'CLIENT CODES'                                        
         L     R2,TCLTCDS                                                       
         LA    R3,P+47                                                          
         BAS   RE,EDIT0R                                                        
*                                                                               
         MVC   P+60(13),=C'PRODUCT CODES'                                       
         L     R2,TPRDCDS                                                       
         LA    R3,P+74                                                          
         BAS   RE,EDIT0R                                                        
*                                                                               
         MVC   P+90(14),=C'ESTIMATE CODES'                                      
         L     R2,TESTCDS                                                       
         LA    R3,P+104                                                         
         BAS   RE,EDIT0R                                                        
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P+8(5),=C'SPOTS'                                                 
         L     R2,TSPTS                                                         
         LA    R3,P+26                                                          
         BAS   RE,EDIT0R                                                        
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P+8(7),=C'DOLLARS'                                               
         LA    R2,TDOLN                                                         
         LA    R3,P+16                                                          
         EDIT  (P8,0(R2)),(16,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
         LA    R2,TDOLG                                                         
         LA    R3,P+32                                                          
         EDIT  (P8,0(R2)),(16,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+8(7),=C'BATCHES'                                               
         L     R2,TBTCHS                                                        
         LA    R3,P+26                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+8(7),=C'RECORDS'                                               
         L     R2,EZRDCT           EZINPUT FILE RECORD COUNT                    
         LA    R3,P+24                                                          
         BAS   RE,EDIT0RB                                                       
         LA    R2,IBYTS            INPUT BYTES                                  
         LA    R3,P+40                                                          
         BAS   RE,EDIT8                                                         
         MVC   P+54(14),=C'RECEIVED BYTES'                                      
         LA    R2,OBYTS            OUTPUT BYTES                                 
         LA    R3,P+70                                                          
         BAS   RE,EDIT8                                                         
         MVC   P+84(12),=C'WORKER BYTES'                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         OC    EZBYCT,EZBYCT       EZINPUT FILE BUYS?                           
         MVC   P+4(3),=C'BUY'                                                   
         MVC   P+8(7),=C'RECORDS'                                               
         L     R2,EZBYCT                                                        
         LA    R3,P+26                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
RUNT00   DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CLI   BADBATSW,0          ANY BAD (MISSING) BATCHES                    
         BE    RUNT10               NO                                          
         MVI   P+5,C'*'                                                         
         MVC   P+6(44),P+5                                                      
         GOTO1 =V(PRINTER)                                                      
         MVC   P+5(44),=C'* BATCHES LOADED ARE MISSING FROM THE FILE *'         
         GOTO1 =V(PRINTER)                                                      
         MVI   P+5,C'*'                                                         
         MVC   P+6(44),P+5                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
RUNT10   DS    0H                                                               
         LA    R2,16              16 WORKER FILES NOW                           
         L     R3,=A(WKRTAB)      WORKER FILE COUNTER TABLE                     
         LA    R4,P+3                                                           
RUNT20   MVC   0(6,R4),=C'WRKFN='                                               
         MVC   4(1,R4),0(R3)                                                    
         EDIT  (P3,1(R3)),(6,6(R4)),COMMAS=YES,ALIGN=LEFT,ZERO=NOBLANK          
         LA    R3,4(,R3)                                                        
         LA    R4,13(,R4)                                                       
         BCT   R2,RUNT20                                                        
         GOTO1 =V(PRINTER)                                                      
RUNT60   GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+2(10),=C'HOLD INPUT'                                           
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
         MVC   P+2(14),=C'TOTAL INVOICES'                                       
         L     R2,HIINVS                                                        
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
         MVC   P+8(5),=C'SPOTS'                                                 
         L     R2,HISPTS                                                        
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+8(7),=C'DOLLARS'                                               
         LA    R2,HIDOLN                                                        
         LA    R3,P+16                                                          
         BAS   RE,EDIT2A                                                        
         LA    R2,HIDOLG                                                        
         LA    R3,P+30                                                          
         BAS   RE,EDIT2A                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+8(7),=C'BATCHES'                                               
         L     R2,HIBAT                                                         
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+8(7),=C'RECORDS'                                               
         L     R2,HDRDCT           INPUT HOLD FILE RECORD COUNT                 
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
         OC    TDELINV,TDELINV     WERE THERE ANY DEL PREV INVOICES             
         BZ    EZR140               NO                                          
*                                                                               
         MVC   P(13),=C'TOTAL DEL INV'                                          
         L     R2,TDELINV                                                       
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
*                                                                               
         GOTO1 =V(PRINTER)                                                      
EZR140   GOTO1 =V(PRINTER)                                                      
         CLI   TEST,C'Y'           IF TEST RUN                                  
         BE    EZR150               SKIP OUTPUT COUNTS                          
*                                                                               
* PRINT OUTPUT TOTALS HERE (NONE FOR TEST RUN) *                                
*                                                                               
         MVC   P+15(10),=C'**OUTPUT**'                                          
         GOTO1 =V(PRINTER)                                                      
         MVC   P+10(20),DASHES                                                  
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+2(15),=C'LOADED INVOICES'                                      
         L     R2,LINVS                                                         
         LA    R3,P+26                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+9(5),=C'SPOTS'                                                 
         L     R2,LSPTS                                                         
         LA    R3,P+26                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
         MVC   P+9(7),=C'DOLLARS'                                               
         LA    R2,LDOLN                                                         
         LA    R3,P+16                                                          
         EDIT  (P8,0(R2)),(16,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
*                                                                               
         LA    R2,LDOLG                                                         
         LA    R3,P+32                                                          
         EDIT  (P8,0(R2)),(16,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P+9(7),=C'BATCHES'                                               
         L     R2,LBTCHS                                                        
         LA    R3,P+26                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+2(11),=C'HOLD OUTPUT'                                          
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
         MVC   P+2(13),=C'HELD INVOICES'                                        
         L     R2,HOINVS                                                        
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+7(5),=C'SPOTS'                                                 
         L     R2,HOSPTS                                                        
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+7(7),=C'DOLLARS'                                               
         LA    R2,HODOLN                                                        
         LA    R3,P+16                                                          
         BAS   RE,EDIT2A                                                        
         LA    R2,HODOLG                                                        
         LA    R3,P+32                                                          
         BAS   RE,EDIT2A                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+7(7),=C'BATCHES'                                               
         L     R2,TUNKINV                                                       
         A     R2,TFULINV                                                       
         C     R2,HOINVS                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R2,HOBAT                                                         
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+7(7),=C'RECORDS'                                               
         L     R2,WORKCT           OUTPUT HOLD FILE RECORD COUNT                
         LA    R3,P+24                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
*                                                                               
EZR150   DS   0H                                                                
         GOTO1 =V(PRINTER)                                                      
         MVC   P+2(13),=C'INVOICE MONTH'                                        
         MVC   P+24(5),=C'COUNT'                                                
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         L     R2,=A(MOSTABLE)                                                  
         LA    R3,MOSTABLN                                                      
         LR    RE,R2                                                            
         LR    RF,R3                                                            
         SR    R4,R4                                                            
*                                                                               
         OC    0(4,RE),0(RE)                                                    
         BZ    *+18                                                             
         LA    RE,6(,RE)                                                        
         LA    R4,1(,R4)                                                        
         BCT   RF,*-18                                                          
         DC    H'0'                                                             
         GOTO1 =V(QSORT),DMCB,(R2),(R4),6,4,0                                   
*                                                                               
PTMOS10  DS    0H                                                               
         OC    0(4,R2),0(R2)                                                    
         BZ    PTMOS20                                                          
         MVC   P+11(4),0(R2)                                                    
         EDIT  (B2,4(R2)),(6,P+23),COMMAS=YES                                   
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R2,6(,R2)                                                        
         BCT   R3,PTMOS10                                                       
         DC    H'0'                                                             
PTMOS20  DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
* PRINT STATION AND AGENCY TOTALS                                               
*                                                                               
         LA    R0,EZSTALEN                                                      
         L     R4,=A(EZSTATAB)                                                  
*                                                                               
         LR    R1,R4                                                            
         SR    R5,R5                                                            
         OC    0(5,R1),0(R1)                                                    
         BZ    *+16                                                             
         LA    R5,1(,R5)                                                        
         LA    R1,29(,R1)                                                       
         BCT   R0,*-18                                                          
         LR    R6,R5                                                            
         GOTO1 =V(QSORT),DMCB,(R4),(R5),29,5,0                                  
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P+4(7),=C'STATION'                                               
         MVC   P+12(8),=C'INVOICES'                                             
         MVC   P+23(5),=C'SPOTS'                                                
         MVC   P+42(19),=C'NET - DOLLARS - GRS'                                 
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR160   OC    0(5,R4),0(R4)       END OF ENTRIES                               
         BZ    EZR161                                                           
         MVC   P+4(4),0(R4)                                                     
         LA    R1,P+8                                                           
         CLI   3(R4),0                                                          
         BH    *+6                                                              
         BCTR  R1,0                                                             
         MVI   0(R1),C'-'                                                       
         MVC   1(1,R1),4(R4)                                                    
         CLI   1(R1),C' '                                                       
         BH    *+8                                                              
         MVI   1(R1),C'T'                                                       
*                                                                               
* EDIT # INVOICES                                                               
*                                                                               
         ICM   R2,15,5(R4)                                                      
         LA    R3,P+15                                                          
         BAS   RE,EDIT0R                                                        
*        EDIT  (R4),(5,P+15),COMMAS=YES                                         
*                                                                               
* EDIT # SPOTS                                                                  
*                                                                               
         ICM   R2,15,9(R4)                                                      
         LA    R3,P+23                                                          
         BAS   RE,EDIT0R                                                        
*        EDIT  (R4),(5,P+23),COMMAS=YES                                         
*                                                                               
* EDIT NET DOLLARS                                                              
*                                                                               
*        ICM   R2,15,13(R4)                                                     
         LA    R2,13(,R4)                                                       
         LA    R3,P+32                                                          
         BAS   RE,EDIT2A                                                        
*        EDIT  (R4),(13,P+32),2,COMMAS=YES                                      
*                                                                               
* EDIT GROSS DOLLARS                                                            
*                                                                               
*        ICM   R2,15,17(R4)                                                     
         LA    R2,21(,R4)                                                       
         LA    R3,P+48                                                          
         BAS   RE,EDIT2A                                                        
*        EDIT  (R4),(13,P+48),2,COMMAS=YES                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,29(,R4)                                                       
         BCT   R5,EZR160                                                        
*                                                                               
EZR161   MVC   P+16(8),=C'STATIONS'                                             
         LR    R2,R6                                                            
         LA    R3,P+10                                                          
         BAS   RE,EDIT0R                                                        
*        EDIT  (R5),(13,P+2),COMMAS=YES                                         
         GOTO1 =V(PRINTER)                                                      
EZR162   DS    0H                                                               
         LA    R0,100                                                           
         L     R4,=A(EZAGYCTB)                                                  
*                                                                               
         LR    R1,R4                                                            
         SR    R5,R5                                                            
         OC    0(8,R1),0(R1)                                                    
         BZ    *+16                                                             
         LA    R5,1(,R5)                                                        
         LA    R1,32(,R1)                                                       
         BCT   R0,*-18                                                          
         GOTO1 =V(QSORT),DMCB,(R4),(R5),32,8,0                                  
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P+4(6),AGY                                                       
         MVC   P+12(8),=C'INVOICES'                                             
         MVC   P+23(5),=C'SPOTS'                                                
         MVC   P+42(19),=C'NET - DOLLARS - GRS'                                 
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR164   OC    0(8,R4),0(R4)       END OF ENTRIES                               
         BZ    EZR165                                                           
         MVC   P+4(8),0(R4)                                                     
*                                                                               
* EDIT # INVOICES                                                               
*                                                                               
         ICM   R2,15,8(R4)                                                      
         LA    R3,P+15                                                          
         BAS   RE,EDIT0R                                                        
*        EDIT  (R4),(5,P+15),COMMAS=YES                                         
*                                                                               
* EDIT # SPOTS                                                                  
*                                                                               
         ICM   R2,15,12(R4)                                                     
         LA    R3,P+23                                                          
         BAS   RE,EDIT0R                                                        
*        EDIT  (R4),(5,P+23),COMMAS=YES                                         
*                                                                               
* EDIT NET DOLLARS                                                              
*                                                                               
*        ICM   R2,15,16(R4)                                                     
         LA    R2,16(,R4)                                                       
         LA    R3,P+32                                                          
         BAS   RE,EDIT2A                                                        
*        EDIT  (R4),(13,P+32),2,COMMAS=YES                                      
*                                                                               
* EDIT GROSS DOLLARS                                                            
*                                                                               
*        ICM   R2,15,20(R4)                                                     
         LA    R2,24(,R4)                                                       
         LA    R3,P+48                                                          
         BAS   RE,EDIT2A                                                        
*        EDIT  (R4),(13,P+48),2,COMMAS=YES                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,32(,R4)                                                       
         BCT   R5,EZR164                                                        
*                                                                               
EZR165   LA    R0,EZAGYNLN                                                      
         L     R4,=A(EZAGYNTB)                                                  
*                                                                               
         LR    R1,R4                                                            
         SR    R5,R5                                                            
         SR    R6,R6               UNKNOWN AGENCY COUNTER                       
         OC    0(150,R1),0(R1)                                                  
         BZ    *+16                                                             
         LA    R5,1(,R5)                                                        
         LA    R1,178(,R1)                                                      
         BCT   R0,*-18                                                          
         GOTO1 =V(QSORT),DMCB,(R4),(R5),178,150,0                               
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P+4(6),AGY                                                       
         MVC   P+11(4),=C'NAME'                                                 
         MVC   P+40(8),=C'INVOICES'                                             
         MVC   P+51(5),=C'SPOTS'                                                
         MVC   P+66(19),=C'NET - DOLLARS - GRS'                                 
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR166   OC    0(30,R4),0(R4)      END OF ENTRIES                               
         BZ    EZR168                                                           
*                                                                               
         MVC   P+4(30),0(R4)                                                    
         ICM   R2,15,152(R4)                                                    
         LA    R3,P+43                                                          
         BAS   RE,EDIT0R                                                        
*                                                                               
         ICM   R2,15,156(R4)                                                    
         LA    R3,P+51                                                          
         BAS   RE,EDIT0R                                                        
*                                                                               
         LA    R2,160(,R4)                                                      
         LA    R3,P+60                                                          
         BAS   RE,EDIT2A                                                        
*                                                                               
         LA    R2,168(,R4)                                                      
         LA    R3,P+76                                                          
         BAS   RE,EDIT2A                                                        
*                                                                               
         OC    176(2,R4),176(R4)     WAS THIS A UNKNOWN AGENCY                  
         BNZ   *+14                                                             
         MVC   P+36(7),=C'UNKNOWN'                                              
         LA    R6,1(,R6)             ADD TO UNKNOWN AGENCY COUNT                
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P+4(30),30(R4)                                                   
         LA    R0,6                                                             
         MVC   P+36(1),150(R4)                                                  
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CLC   60(30,R4),SPACES                                                 
         BE    EZR166E                                                          
         MVC   P+4(30),60(R4)                                                   
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR166E  CLC   90(30,R4),SPACES                                                 
         BE    EZR166G                                                          
         MVC   P+4(30),90(R4)                                                   
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR166G  CLC   120(30,R4),SPACES                                                
         BE    EZR166I                                                          
         MVC   P+4(30),120(R4)                                                  
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR166I  GOTO1 =V(PRINTER)                                                      
         LA    R4,178(,R4)                                                      
         BCT   R5,EZR166                                                        
*                                                                               
EZR168   LA    R0,10                                                            
         L     R4,=A(EZMEDCTB)                                                  
*                                                                               
         LR    R1,R4                                                            
         SR    R5,R5                                                            
         CLI   0(R1),0                                                          
         BE    *+16                                                             
         LA    R5,1(,R5)                                                        
         LA    R1,21(,R1)                                                       
         BCT   R0,*-16                                                          
         GOTO1 =V(QSORT),DMCB,(R4),(R5),21,1,0                                  
*                                                                               
         GOTO1 =V(PRINTER)                                                      
         MVC   P+4(5),=C'MEDIA'                                                 
         MVC   P+10(8),=C'INVOICES'                                             
         MVC   P+22(5),=C'SPOTS'                                                
         MVC   P+38(19),=C'NET - DOLLARS - GRS'                                 
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR169   CLI   0(R4),0             END OF ENTRIES                               
         BE    EZR170                                                           
         MVC   P+6(1),0(R4)                                                     
         ICM   R2,15,1(R4)                                                      
         LA    R3,P+11                                                          
         BAS   RE,EDIT7                                                         
*        EDIT  (R4),(7,P+11),COMMAS=YES                                         
*                                                                               
         ICM   R2,15,5(R4)                                                      
         LA    R3,P+20                                                          
         BAS   RE,EDIT7                                                         
*        EDIT  (R4),(7,P+20),COMMAS=YES                                         
*                                                                               
         LA    R2,OBYTS                                                         
         ZAP   OBYTS,9(6,R4)                                                    
         LA    R3,P+32                                                          
         BAS   RE,EDIT2A                                                        
*        EDIT  (P6,9(R3)),(13,P+32),2,COMMAS=YES                                
*                                                                               
         ZAP   OBYTS,15(6,R4)                                                   
         LA    R3,P+48                                                          
         BAS   RE,EDIT2A                                                        
*        EDIT  (P6,15(R3)),(13,P+48),2,COMMAS=YES                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,21(,R4)                                                       
         BCT   R5,EZR169                                                        
*                                                                               
EZR170   SR    R4,R4                                                            
         SR    R5,R5                                                            
         OC    TUNKINV,TUNKINV     ANY BAD INVOICES TOTAL                       
         BZ    EZR174                                                           
         GOTO1 =V(PRINTER)                                                      
         L     R2,TUNKINV                                                       
         LA    R3,P+3                                                           
         BAS   RE,EDIT0R                                                        
         MVC   P+9(8),=C'INVOICES'                                              
         LR    R2,R6                                                            
         LA    R3,P+20                                                          
         BAS   RE,EDIT0R                                                        
         MVC   P+26(16),=C'UNKNOWN AGENCIES'                                    
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,UNKAGYMS                                                      
*                                                                               
EZR174   OC    TMAXERRS,TMAXERRS   ANY BAD ERRORS                               
         BZ    EZR180                                                           
*                                                                               
EZR176   MVC   P(11),=C'DATA ERRORS'                                            
         L     R2,TMAXERRS                                                      
         LA    R3,P+30                                                          
         BAS   RE,EDIT0R                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R5,BADATMS                                                       
*                                                                               
EZR180   LTR   R4,R4                                                            
         BNZ   EZR182                                                           
         LTR   R5,R5                                                            
         BZ    EZR190                                                           
EZR182   MVI   P+40,C'*'                                                        
         MVC   P+41(30),P+40                                                    
         GOTO1 =V(PRINTER)                                                      
         MVI   P+40,C'*'                                                        
         MVI   P+70,C'*'                                                        
         GOTO1 =V(PRINTER)                                                      
         LTR   R4,R4                                                            
         BZ    EZR184                                                           
         MVC   P+40(31),0(R4)                                                   
         GOTO1 =V(PRINTER)                                                      
EZR184   LTR   R5,R5                                                            
         BZ    EZR186                                                           
         MVC   P+40(31),0(R5)                                                   
         GOTO1 =V(PRINTER)                                                      
EZR186   MVI   P+40,C'*'                                                        
         MVI   P+70,C'*'                                                        
         GOTO1 =V(PRINTER)                                                      
         MVI   P+40,C'*'                                                        
         MVC   P+41(30),P+40                                                    
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR190   LA    R4,TOTFILES                                                      
         LA    R5,L'TOTFILES                                                    
*                                                                               
EZR194   CLI   0(R4),0                                                          
         BE    EZR200                                                           
         TM    0(R4),X'08'         WAS THIS A BAD FILE                          
         BZ    EZR196               NOPE                                        
         LR    R1,R4                                                            
         LA    R0,TOTFILES-1                                                    
         SR    R1,R0                                                            
         CVD   R1,DUB                                                           
         MVC   P+8(23),=C'FILE 000 HAD BAD TOTALS'                              
         OI    DUB+7,X'0F'                                                      
         UNPK  P+13(3),DUB                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EZR196   LA    R4,1(,R4)                                                        
         BCT   R5,EZR194                                                        
EZR200   XIT1                                                                   
         DS    0H                                                               
EDIT0R   NTR1                                                                   
         EDIT  ((R2)),(5,(R3)),ZERO=NOBLANK                                     
         B     EZR200                                                           
*                                                                               
EDIT0RB  NTR1                                                                   
         EDIT  ((R2)),(7,(R3)),ZERO=NOBLANK                                     
         B     EZR200                                                           
*                                                                               
         DS    0H                                                               
EDIT7    NTR1                                                                   
         EDIT  (R2),(7,(R3)),COMMAS=YES                                         
         B     EZR200                                                           
*                                                                               
         DS    0H                                                               
EDIT2R   NTR1                                                                   
         EDIT  ((R2)),(14,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES             
         B     EZR200                                                           
         DS    0H                                                               
EDIT2A   NTR1                                                                   
         EDIT  (P8,0(R2)),(14,(R3)),2,COMMAS=YES,ZERO=NOBLANK,MINUS=YES         
         B     EZR200                                                           
         DS    0H                                                               
EDIT8    NTR1                                                                   
         EDIT  (P8,0(R2)),(13,0(R3)),ZERO=NOBLANK,COMMAS=YES                    
         B     EZR200                                                           
*                                                                               
AGY      DC    C'AGENCY '                                                       
UNKAGYMS DC    CL31'* UNKNOWN AGENCY - NOT LOADED *'                            
BADATMS  DC    CL31'* BAD DATA ERROR - NOT LOADED *'                            
         DROP  RB,RC                                                            
*                                                                               
* DCB DSECT WITH ADRESSABLE LABELS *                                            
*                                                                               
*        PRINT GEN                                                              
         DCBD  DSORG=PS,DEVD=DA,TA                                              
         PRINT NOGEN                                                            
*                                                                               
*                                                                               
EZLOAD   CSECT                                                                  
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
* READ AGENCY NAME RECORD FOR REDIRECT FLAG                                     
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
CHKREDIR NTR1  BASE=*,LABEL=*                                                   
         USING EZLDWKD,RC                                                       
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING EZANMD,R4                                                        
         MVC   EZAKTYP,=C'ZA'                                                   
         MVC   EZAKNAM,AGYNAME                                                  
*                                                                               
         CLI   IDBFLAG,C'Y'        DO WE HAVE AGY NAME FROM 76 RECORD?          
         BNE   RED10               NO - USE DATA FROM AGY NAME RECORD           
         CLC   IDBAGYN,SPACES      ANYTHING THERE?                              
         BNH   REDX                NO - NO REDIRECTING                          
         MVC   EZAKNAM,IDBAGYN                                                  
*                                                                               
RED10    DS    0H                                                               
         MVC   KEYSAVE,KEY                                                      
         GOTO1 =V(DATAMGR),DMCB,=C'DMRDHI',=C'GENDIR',KEY,KEY,DMWORK            
         CLC   KEY(32),KEYSAVE                                                  
         BE    RED20                                                            
         OC    KEY(32),SPACES                                                   
         OC    KEYSAVE(32),SPACES                                               
         CLC   KEY(32),KEYSAVE                                                  
         BNE   REDX                                                             
*                                                                               
RED20    DS    0H                                                               
         GOTO1 =V(DATAMGR),DMCB,=C'GETREC',=C'GENFIL',EZADDA,          X        
               A(GENREC),DMWORK                                                 
         CLI   8(R1),0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,=A(GENREC)                                                    
         MVI   ELCODE,X'07'        OPTIONS ELEMENT                              
         MVC   DATADISP,=AL2(42)   42 FOR GENDIR/GENFIL                         
*                                                                               
         BRAS  RE,GETEL                                                         
         BNE   REDX                                                             
*                                                                               
         TM    EZOPTFL-EZOPTEL(R6),EZOPTFSQ  REDIRECT SET TO SPOT?              
         BZ    REDX                                                             
         MVI   REDIRFLG,C'Y'       INDICATE WE'RE REDIRECTING                   
*                                                                               
REDX     DS    0H                                                               
         J     EXIT                                                             
*                                                                               
*                                                                               
         GETEL (R6),DATADISP,ELCODE                                             
*                                                                               
*        TRCRET- ROUTINE TO TRACE GETFLD RETURNS                                
*                                                                               
*                                                                               
TRCRETN  NTR1  BASE=*,LABEL=*                                                   
         MVC   P,SPACES                                                         
         TM    RFCTL,RFCTLFER       FIELD ERROR                                 
         BZ    TRCRETN1                                                         
         OC    RFERRMSG,RFERRMSG                                                
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   P+7(L'RFERRMSG),RFERRMSG                                         
         GOTO1 =V(PRINTER)                                                      
         MVC   P,SPACES                                                         
*                                                                               
TRCRETN1 MVC   P(6),=C'GETFLD'                                                  
         GOTO1 =V(HEXOUT),DMCB,RFCTL,P+7,1,=C'N'                                
         GOTO1 =V(HEXOUT),DMCB,RFCTL2,P+10,1,=C'N'                              
         EDIT  (B1,RFFLDNO),(3,P+13),FILL=0                                     
         EDIT  (B1,RFLEN),(3,P+17),FILL=0                                       
         MVC   P+21(100),RFDATA                                                 
         GOTO1 =V(PRINTER)                                                      
         MVC   P,SPACES                                                         
*                                                                               
         J     EXIT                                                             
*                                                                               
*                                                                               
CHK3COD  DS    0H                                                               
         LHI   RF,3                                                             
*                                                                               
CHK3C10  CLI   0(R1),C' '          SPACE?                                       
         JH    CHK3C20             NO - SEE IF ALPHA                            
         CHI   RF,1                ONLY 3RD CHAR CAN BE A SPACE                 
         JNE   CHK3NEQ                                                          
         J     CHK3C30             PROCEED TO NEXT CHARACTER                    
*                                                                               
* NON-SPACE HERE                                                                
CHK3C20  CLI   0(R1),C'A'          BELOW 'A'                                    
         JL    CHK3NEQ             YES - ALWAYS INVALID                         
         CLI   0(R1),C'Z'          'A' TO 'Z'?                                  
         JL    CHK3C30             YES - ALWAYS VALID                           
*                                                                               
* NON-ALPHA HERE                                                                
         CHI   RF,3                IF FIRST CHAR NON-ALPHA = INVALID            
         JE    CHK3NEQ                                                          
*                                                                               
* CHARS 2,3 CAN BE NUMERIC                                                      
         CLI   0(R1),C'0'                                                       
         JL    CHK3NEQ             NON-NUMERIC = INVALID                        
         CLI   0(R1),C'9'                                                       
         JH    CHK3NEQ             INVALID                                      
*                                                                               
CHK3C30  LA    R1,1(R1)                                                         
         BCTR  RF,0                                                             
         CHI   RF,0                                                             
         JH    CHK3C10                                                          
*                                                                               
CHK3EQ   CR    RB,RB                                                            
         BR    RE                                                               
CHK3NEQ  LTR   RB,RB                                                            
         BR    RE                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
* AGENCY INFORMATION LOOKUP SUBROUTINE                                          
* TAKES IN 2-BYTE BINARY USER ID (IN LKAGYBLK,LKAGYBID)                         
* RETURNS 10-CHARACTER USER ID ADN 2-CHAR AGENCY POWER CODE                     
* LKAGYBLK IS FILLED IN WITH 2-CHAR AGY AND 10-CHAR USER ID                     
* LKAGYBLK WILL HAVE X'FF' IF LOOKUP UNSUCCESSFUL                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
LKAGY    NTR1  BASE=*,LABEL=*                                                   
         MVI   LKAGYAGY,X'FF'      DEFAULT TO NO LOOKUP                         
         MVC   LKAGYUID,=C'UNKNOWN  '                                           
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING CTIKEY,R4                                                        
         MVI   CTIKTYP,C'I'                                                     
         MVC   CTIKID+8(2),LKAGYBID                                             
         L     R4,=A(GENREC2)                                                   
         GOTO1 =V(DATAMGR),DMCB,=C'DMREAD',=C'CTFILE',KEY,(R4),DMWORK           
         CLI   8(R1),0                                                          
         BNE   LKXIT                                                            
         LA    R6,CTIDATA                                                       
*                                                                               
LK500    DS    0H                                                               
         CLI   0(R6),0             EOR                                          
         BE    LKXIT                                                            
*                                                                               
         CLI   0(R6),X'02'         DESCRIPTION ELEM                             
         BNE   *+16                                                             
         MVC   LKAGYUID,2(R6)                                                   
         OC    LKAGYUID,SPACES                                                  
*                                                                               
         CLI   0(R6),X'06'         AGY ID ELEM                                  
         BNE   *+10                                                             
         MVC   LKAGYAGY,2(R6)                                                   
*                                                                               
         ZIC   R0,1(R6)                                                         
         AR    R6,R0                                                            
         B     LK500                                                            
         USING CTAGYD,R6                                                        
*                                                                               
LKXIT    DS    0H                                                               
         CLI   LKAGYAGY,X'FF'                                                   
         JNE   EQXIT                                                            
         J     NEQXIT                                                           
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
* AGENCY INFORMATION LOOKUP SUBROUTINE                                          
* TAKES IN 10-CHAR USER ID (IN LKAGYBLK,LKAGYUID)                               
* RETURNS 2-BYTE BINARY ID ADN 2-CHAR AGENCY POWER CODE                         
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
LKAGY2   NTR1  BASE=*,LABEL=*                                                   
         MVI   LKAGYAGY,X'FF'      DEFAULT TO NO LOOKUP                         
         MVC   LKAGYBID,=X'FFFF'                                                
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
         USING CTIKEY,R4                                                        
         MVI   CTIKTYP,C'I'                                                     
         MVC   CTIKID,LKAGYUID                                                  
         L     R4,=A(GENREC2)                                                   
         GOTO1 =V(DATAMGR),DMCB,=C'DMREAD',=C'CTFILE',KEY,(R4),DMWORK           
         CLI   8(R1),0                                                          
         BNE   LK2XIT                                                           
         LA    R6,CTIDATA                                                       
*                                                                               
LK250    DS    0H                                                               
         CLI   0(R6),0             EOR                                          
         BE    LK2XIT                                                           
*                                                                               
         CLI   0(R6),X'02'         DESCRIPTION ELEM                             
         BNE   *+10                                                             
         MVC   LKAGYBID,2(R6)                                                   
*                                                                               
         CLI   0(R6),X'06'         AGY ID ELEM                                  
         BNE   *+10                                                             
         MVC   LKAGYAGY,2(R6)                                                   
*                                                                               
         ZIC   R0,1(R6)                                                         
         AR    R6,R0                                                            
         B     LK250                                                            
*                                                                               
LK2XIT   DS    0H                                                               
         CLI   LKAGYAGY,X'FF'                                                   
         JNE   EQXIT                                                            
         J     NEQXIT                                                           
*                                                                               
*                                                                               
*                                                                               
ISALPHA  CLI   0(R1),C'A'                                                       
         JL    ISNEQX                                                           
         CLI   0(R1),C'Z'                                                       
         JH    ISNEQX                                                           
         J     ISEQX                                                            
*                                                                               
ISNUM    CLI   0(R1),C'0'                                                       
         JL    ISNEQX                                                           
         CLI   0(R1),C'9'                                                       
         JH    ISNEQX                                                           
*                                                                               
ISEQX    CR    RB,RB                                                            
         BR    RE                                                               
ISNEQX   LTR   RB,RB                                                            
         BR    RE                                                               
*                                                                               
*                                                                               
PRTREC   NTR1  BASE=*,LABEL=*                                                   
         MVC   P(10),=CL10'LINE #'                                              
         EDIT  EZRDCT,(8,P+10),ALIGN=LEFT                                       
         GOTO1 =V(PRINTER)                                                      
         L     R1,=A(EZINREC)                                                   
         MVC   P(10),=CL10'RECORD: '                                            
         MVC   P+10(L'P-10),0(R1)                                               
         GOTO1 =V(PRINTER)                                                      
         J     EQXIT                                                            
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
* FOLLOWING SUBROUTINE WILL CHANGE USER ID BASED ON CLIENT CODE                 
* SENT IN 31 RECORD (FIELD 25, AGENCY ADVERTISER CODE)                          
* USER ID EXPECTED TO BE IN USID                                                
* IF REDIRECT SUCCESSFUL, USIDNO, USID AND AGENCY WILL BE FILLED IN             
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *             
CLTREDIR NTR1  BASE=*,LABEL=*                                                   
* FIRST SEE IF WE EVEN NEED TO RE-DIRECT                                        
         OC    FCBID,FCBID                                                      
         JNZ   NEQXIT                                                           
*                                                                               
         CLC   SOURCE,=C'SDIY'                                                  
         JE    NEQXIT                                                           
         CLC   SOURCE,=C'SDIJ'                                                  
         JE    NEQXIT                                                           
*                                                                               
         CLI   MEDIA,C'T'                                                       
         BE    *+12                                                             
         CLI   MEDIA,C'R'                                                       
         JNE   NEQXIT                                                           
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(L'IDID11FW),USID                                            
         MVI   BP1_4,0             FIND A RECORD                                
         SAM31                                                                  
         GOTO1 =V(BINSR31),BSPARS1,WORK ENTRY POINT CHANGE IN LKEZLOAD          
         SAM24                                                                  
         TM    BP1_1,X'80'         TEST RECORD NOT FOUND                        
         JO    EQXIT               NOT FOUND = NOT REDIRECTING                  
*                                                                               
         L     R1,RFRECST          START OF RECORD = FROM ADDRESS               
         CLC   =C'31',0(R1)                                                     
         JNE   NEQXIT                                                           
*                                                                               
         LHI   R0,10               MOS                                          
         BRAS  RE,FINDFLD                                                       
         JNE   NEQXIT                                                           
         CLI   BYTE,4                                                           
         JNE   NEQXIT                                                           
         MVC   HALF,WORK           YEAR OF SERVICE                              
*                                                                               
         XC    WORK,WORK                                                        
         L     R1,RFRECST          START OF RECORD = FROM ADDRESS               
         LHI   R0,25               CLIENT CODE                                  
         BRAS  RE,FINDFLD                                                       
         JNE   NEQXIT                                                           
         CLI   BYTE,2                                                           
         JL    NEQXIT                                                           
         CLI   BYTE,3                                                           
         JH    NEQXIT                                                           
*                                                                               
         OC    WORK,SPACES                                                      
*                                                                               
         MVI   BP2_4,0             FIND A RECORD                                
         SAM31                                                                  
         GOTO1 =V(BINSR31),BSPARS2,WORK ENTRY POINT CHANGE IN LKEZLOAD          
         SAM24                                                                  
         TM    BP2_1,X'80'         TEST RECORD NOT FOUND                        
         JO    NEQXIT              NOT FOUND = NOT REDIRECTING                  
*                                                                               
         XC    LKAGYBLK,LKAGYBLK                                                
         MVC   LKAGYUID,SPACES                                                  
         SAM31                                                                  
         L     RF,BP2_1                                                         
         MVC   LKAGYUID(8),IDID11FW-IDCLTD(RF)                                  
         SAM24                                                                  
*                                                                               
         CLC   LKAGYUID,SPACES                                                  
         JNH   NEQXIT              NO UID FOR THIS YEAR - NO REDIRECT           
*                                                                               
         BRAS  RE,LKAGY2                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   AGENCY,LKAGYAGY                                                  
         MVC   USID,LKAGYUID                                                    
         MVC   USIDNO,LKAGYBID                                                  
         J     EQXIT                                                            
*                                                                               
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* R1 EXPECTED TO HAVE A(RECORD)                                                 
* R0 EXPECTED TO HAVE FIELD NUMBER                                              
* ON EXIT BYTE WILL HAVE FIELD'S ACTUAL LENGTH                                  
*         WORK WILL HAVE FIELD'S VALUE                                          
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
FINDFLD  NTR1  BASE=*,LABEL=*                                                   
         MVI   BYTE,X'00'                                                       
         MVC   WORK,SPACES                                                      
         CLC   =C'31',0(R1)                                                     
         JNE   NEQXIT                                                           
         BCTR  R0,0                                                             
*                                                                               
FF10     CLC   FDELIM,0(R1)        THIS A FIELD DELIMITER                       
         BE    FF20                                                             
         CLC   RDELIM,0(R1)        THIS A RECORD DELIMITER                      
         JE    NEQXIT              FIELD NOT FOUND                              
         CLI   0(R1),C' '                                                       
         JL    NEQXIT                                                           
         LA    R1,1(,R1)                                                        
         B     FF10                                                             
*                                                                               
FF20     LA    R1,1(,R1)                                                        
         BCT   R0,FF10                                                          
*                                                                               
* R1 = START OF THE FIELD                                                       
*                                                                               
         LA    RE,WORK                                                          
         LR    R2,R1               SAVE START OF THE FIELD                      
*                                                                               
FF30     CLC   FDELIM,0(R1)                                                     
         BE    FF40                EOF                                          
         CLC   RDELIM,0(R1)                                                     
         BE    FF40                EOF                                          
         CLI   0(R1),C' '                                                       
         BL    FF40                                                             
         MVC   0(1,RE),0(R1)                                                    
         LA    R1,1(,R1)                                                        
         LA    RE,1(,RE)                                                        
         B     FF30                                                             
*                                                                               
* ALL CHARACTERS COPIED, NOW FIND FIELD'S LENGTH                                
*                                                                               
FF40     DS    0H                                                               
         LR    R0,R1                                                            
         SR    R0,R2               R0 = LENGTH OF THE FIELD                     
         BCTR  R1,0                BACK UP TO LAST CHAR OF THE FIELD            
*                                                                               
FF50     CR    R1,R2                                                            
         BNH   FFX                                                              
         CLI   0(R1),C' '                                                       
         BH    FFX                                                              
         BCTR  R0,0                                                             
         BCTR  R1,0                                                             
         B     FF50                                                             
*                                                                               
FFX      STC   R0,BYTE                                                          
         J     EQXIT                                                            
*                                                                               
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
* CLIENT REDIRECT TABLE DSECT                                                   
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *           
*                                                                               
IDUIDMAXQ EQU  50                  UID TABLE SIZE                               
IDCLTMAXQ EQU  4000                CLT-UID TABLE SIZE                           
*                                                                               
IDCLTD   DSECT                     BINSRCH TABLE DSECT                          
IDCCLT   DS    CL3                 CLIENT CODE                                  
         DS    C                                                                
IDID11FW DS    CL8                 USER ID                                      
IDCLTLQ  EQU   *-IDCLTD                                                         
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*              DSECT FOR PROGRAM                                                
*                                                                               
EZLDWKD  DSECT                                                                  
DUB      DS    D                                                                
DOUBLE   DS    D                                                                
FULL     DS    F                                                                
DMCB     DS    6F                                                               
HALF     DS    H                                                                
BYTE     DS    X                                                                
         DS    0F                                                               
IDTPARS  DS    6F                                                               
STTPARS  DS    6F                                                               
ERRLINE  DS    XL132                                                            
         DS    XL124                                                            
WORK     DS    XL64                                                             
CARD     DS    CL80                                                             
         DS    CL8                                                              
ID       DS    CL42                                                             
WKRFIL   DS    CL8                                                              
TODAY    DS    CL6                                                              
HOLDCUT  DS    CL6                 HOLD FILE CUTOFF DATE                        
HOLDCUTQ EQU   9                   NUMBER OF MONTHS                             
TODAYC   DS    XL2                                                              
TIMEP    DS    XL2                                                              
HOLDDATE DS    CL6                                                              
SVPMOS   DS    XL2                                                              
*                                                                               
EZWRKIO  DS    A                                                                
EZCLTTAB DS    A                                                                
WKRBUF   DS    A                                                                
WKRREC   DS    A                                                                
EOR      DS    A                                                                
AEZINPT  DS    A                                                                
TRACES   DS    0CL6                                                             
TRACEREC DS    CL1                                                              
TRACEFLD DS    CL1                                                              
TRACEWKR DS    CL1                                                              
TRACEHLD DS    CL1                 HOLD FILE                                    
TRACEWRK DS    CL1                 WORK FILE FOR UNKNOWNS/WORKER FULL           
TRACEADV DS    CL1                 TRACE ADVNAM                                 
TEST     DS    CL1                                                              
ABNDOPT  DS    CL1                                                              
DMGOPT   DS    CL1                                                              
RERUN    DS    CL1                                                              
NOHOLDCK DS    CL1                                                              
SVRECSW  DS    XL1                                                              
SVRECSTA EQU   X'80'                                                            
SVRECPAY EQU   X'40'                                                            
SVRECAGY EQU   X'20'                                                            
SVRECSRC EQU   X'10'                                                            
SVRECSCT EQU   X'08'                                                            
SVRECSCB EQU   X'04'                                                            
SVRECIDB EQU   X'02'                                                            
SVRECVER EQU   X'01'                                                            
*                                                                               
STDCMTSW DS    XL1                                                              
STDCMTOP EQU   X'80'                                                            
STDCMBOT EQU   X'40'                                                            
*                                                                               
NEWBATSW DS    CL1                 READING HOLD FILE,                           
*                                  READ DIFFERENT DATE OR SOURCE                
*                                  NEED TO FORCE END OF BATCH                   
SAVSW    DS    CL1                                                              
*                                                                               
NWADVNM  DS    CL25                                                             
*                                                                               
SVADVNM  DS    CL25                                                             
SVADVID  DS    CL8                                                              
SVADVIDN DS    XL2                                                              
AGENCY   DS    CL2                                                              
USIDNO   DS    XL2                                                              
USID     DS    CL8                                                              
SVUSID   DS    CL8                 FROM LAST INVOICE (COMPARE FOR BRK)          
SVINVMOS DS    CL4                 FROM LAST INVOICE                            
SVADVUID DS    XL2                 USER ID LOOKED UP FROM ADVNAME REC           
SVADVAGY DS    CL2                 AGY ID LOOKED UP FROM ADVNAME REC            
*                                                                               
HDUSID   DS    CL8                 HOLD USID WHEN DOING ENDINV                  
STMODE   DS    CL1                                                              
IDMODE   DS    CL1                                                              
SVEXCLSW DS    CL1                 SAVED BEFORE GETUID/CKADV                    
*                                                                               
EXCLSW   DS    CL1                 SET TO N IF GOOD BATCH/OKAY TO LOAD          
*                                  SET TO * FOR UNKNOWN AGENCY                  
*                                         # FOR FULL WORKER FILE                
*                                         D FOR DISK ERRORS                     
*                                  SET TO Y IF EXPRESSLY EXCLUDED               
*                                         S IF STATION EXCLUDED                 
*                                         A IF AGENCY ID EXCLUDED               
*                                                                               
UNKNSW   DS    CL1                 UNKNOWN SWITCH                               
UNKNAGYQ EQU   X'80'               AGENCY RECORD                                
UNKNSTAQ EQU   X'40'               STATION RECORD                               
*                                                                               
BATHSW   DS    CL1                 SET TO Y BATCH OPENED                        
*                                         N IF BATCH BYPASSED                   
*                          USED TO BYPASS CLOSE, OR FORCE CLOSE                 
*                          EVEN IF NEXT BATCH BYPASSED                          
*                          EVEN IF NEXT BATCH BYPASSED                          
BADBATSW DS    CL1                 SET TO '*' IF ANY BATCH MISSING              
*                                                                               
* STALEV IS USED TO SAVE SPECIFICITY LEVEL OF AGY/ADV RECS                      
*                                                                               
STALEV   DS    X                                                                
SVSTALEV DS    X                                                                
* AGENCY NAME                     1 = ALL-A                                     
*                                 2 = ALL-R/T/N                                 
*                                10 = STATION SPECIFIC                          
* OFFICE NAME 10 MORE THAN AGENCY                                               
* ADV    NAME STARTS WITH A BASE OF 30                                          
*                                                                               
SOURCE   DS    CL4                                                              
SVSRCE   DS    CL4                 SOURCE SAVED HERE WHEN READING HOLD          
HOLDSW   DS    CL1                 H=HOLD FILE, 0=EZINPUT                       
RECFM    DS    CL1                                                              
SVIDSTA  DS    CL5                                                              
DASHES   DS    CL60                                                             
         DS    0D                                                               
KEY      DS    XL64                                                             
KEYSAVE  DS    XL64                                                             
DMWORK   DS    12D                                                              
OLDSRC   DS    CL4                                                              
TOSVMED  DS    C                                                                
OLDMEDIA DS    CL2                                                              
INVVER   DS    X                                                                
WRITEFL  DS    C                                                                
*                                                                               
FCBID    DS    XL2                                                              
FCAGY    DS    CL2                                                              
FCUID    DS    CL8                                                              
*                                                                               
         DS    0F                                                               
COUNTS   DS    0XL(ENDCTS)                                                      
*                                                                               
* COUNTS FOR 1 INVOICE (CURRENT)                                                
*                                                                               
*ITOTS    DS    0XL12                                                           
ISPTS    DS    F                   INVOICE SPOTS                                
IDOLN    DS    PL8                         DOLLARS (NET)                        
IDOLG    DS    PL8                         DOLLARS (GROSS)                      
*                                                                               
*                                                                               
* COUNTS FOR 1 BATCH (CURRENT)                                                  
*                                                                               
BTOTS    DS    0XL28                                                            
BSPTS    DS    F                   BATCH SPOTS                                  
BDOLN    DS    PL8                       DOLLARS (NET)                          
BDOLG    DS    PL8                       DOLLARS (GROSS)                        
BINVS    DS    F                         INVOICES                               
BRECS    DS    F                         RECORDS IN THIS BATCH                  
BBYTS    DS    PL8                       BYTES OUTPUT                           
*                                                                               
*                                                                               
* COUNTS TOTAL RUN                                                              
*                                                                               
TSPTS    DS    F                   TOTAL FOR NEW DATA SET                       
TDOLN    DS    PL8                                                              
TDOLG    DS    PL8                                                              
TINVS    DS    F                                                                
EZRDCT   DS    F                   RECORDS READ FROM EZINPUT FILE               
EZBYCT   DS    F                   STRATA BUY RECS - EZINPUT FILE               
*                                                                               
*                                                                               
* COUNTS FOR INPUT HOLD FILE *                                                  
*                                                                               
HIBAT    DS    F                   TOTAL ON HOLD FILE (UNKNOWS OR FULL)         
HISPTS   DS    F                                                                
HIDOLN   DS    PL8                                                              
HIDOLG   DS    PL8                                                              
HIINVS   DS    F                                                                
HDRDCT   DS    F                   RECORDS READ FROM HOLD FILE                  
*                                                                               
*                                                                               
* COUNTS FOR OUTPUT HOLD FILE *                                                 
*                                                                               
HOBAT    DS    F                   TOTAL ON HOLD FILE (UNKNOWS OR FULL)         
HOSPTS   DS    F                                                                
HODOLN   DS    PL8                                                              
HODOLG   DS    PL8                                                              
HOINVS   DS    F                                                                
*                                                                               
* COUNT OF RECORDS ON THE WORK FILE - UNKNOWN OR FULL EASIWK *                  
* THIS WILL BE THE COUNT OF RECORDS ON NEW HOLD FILE         *                  
*                                                                               
WORKCT   DS    F                   COUNT OF RECORDS ON WORK FILE                
WORKCT9  DS    F                   COUNT OF 99 RECORDS ON WORK FILE             
*                                                                               
TBTCHS   DS    F                   TOTAL BATCHES                                
TUNKINV  DS    F                   TOTAL BAD INVOICES (UNKNOWN AGENCY)          
TFULINV  DS    F                   TOTAL WORKER FILE FULL INVOICES              
TFULBAT  DS    F                   TOTAL WORKER FILE FULL BATCHES               
*                                                                               
TDELINV  DS    F                   TOTAL DELETE PREVIOUS INVOICE RECS           
TMAXERRS DS    F                   TOTAL BAD ERRORS FOUND ON TAPE               
TCLTCDS  DS    F                                                                
TPRDCDS  DS    F                                                                
TESTCDS  DS    F                                                                
*                                                                               
* LOADED BATCH TOTALS                                                           
*                                                                               
LBTCHS   DS    F                   LOADED BATCHES                               
LINVS    DS    F                          INVOICES                              
LSPTS    DS    F                          SPOTS                                 
ENDCTS   EQU   *-ISPTS                                                          
LDOLN    DS    PL8                                                              
LDOLG    DS    PL8                                                              
*                                                                               
* LOADED BATCH TOTALS                                                           
*                                                                               
IBYTS    DS    PL8                 INPUT BYTES REC                              
OBYTS    DS    PL8                 OUTPUT BYTES REC                             
*                                                                               
RDELIM   DS    CL1                 RECORD DELIMITER                             
FDELIM   DS    CL1                 FIELD DELIMITER                              
HOLDSIGN DS    CL1                                                              
*                                                                               
* RECORD FIELD DATA AREA - EACH FIELD BUILT HERE TO PRINT IF NEEDED *           
*                                                                               
RFVALS   DS    0D                                                               
RFDATA   DS    XL256                                                            
RFLEN    DS    XL1                                                              
RFCTL    DS    X                   EXTERNAL SWITCHES                            
RFCTLEOF EQU   X'80' - END OF FILE                                              
RFCTLEOR EQU   X'40' - END OF RECORD                                            
RFCTLFER EQU   X'20' - FIELD ERROR                                              
RFCTLEFL EQU   X'10' - END OF FIELD                                             
RFCTLREC EQU   X'08' - RECORD WAS READ FROM FILE                                
*                                                                               
RFCTL2   DS    X                   INTERNAL SWITCHES                            
RFCTL2RD EQU   X'04' - NEED TO READ NEXT TAPE BLOCK/RECORD                      
RFCTL2EF EQU   X'02' - END OF FILE                                              
RFCTL2ER EQU   X'01' - END OF RECORD                                            
RFFLDNO  DS    X                                                                
RFCURPOS DS    F                                                                
RFFLDST  DS    F                                                                
RFRECST  DS    F                                                                
RFERRMSG DS    CL20                                                             
RFVALSL  EQU   *-RFVALS                                                         
*                                                                               
RECLEN   DS    F                                                                
RECTYP   DS    CL2                                                              
SVRECTYP DS    CL2                                                              
*                                                                               
* WORKER RECORD POINTERS *                                                      
*                                                                               
WFVALS   DS    0D                                                               
WRECST   DS    F                   WORKER RECORD START                          
WRCURPOS DS    F                   WORKER RECORD NEXT FIELD PTR                 
WFVALSL  EQU   *-WFVALS                                                         
*                                  INVOICE FIELDS                               
INVFLDS  DS    0H                                                               
INVNO    DS    CL10                                                             
INVMOS   DS    CL4                                                              
INVDEL   DS    CL1                                                              
ADVNAM   DS    CL25                                                             
ADVCD    DS    CL8                                                              
PRDNAM   DS    CL25                                                             
PRDCD    DS    CL8                                                              
ESTNO    DS    CL10                                                             
STANET   DS    CL4                                                              
OLDINVNO DS    CL20                                                             
*                                                                               
REPORDER DS    CL10                                                             
STAORDER DS    CL10                                                             
RUNDATLO DS    CL6                                                              
RUNDATHI DS    CL6                                                              
*                                                                               
INVFLDLQ EQU   *-INVFLDS                                                        
*                                  SAVED DATA FIELDS                            
*                                  SAVED DATA FIELDS                            
*                                  SAVED DATA FIELDS                            
STAFLDS  DS    0CL8                                                             
STATION  DS    CL4                                                              
MEDIA    DS    CL2                                                              
BAND     DS    CL2                                                              
*                                                                               
* SAVED BECAUSE EQUIVALENT STATION RECORD WITH ADVERTISER FOUND *               
*                                                                               
SVSTAFLD DS    CL8                                                              
SVEQVSTA DS    CL4                                                              
SVEQVMED DS    CL1                                                              
*                                                                               
EQVSTASW DS    CL1                 SET TO Y IF USING EQUIV STA/ADVERT           
*                                                                               
*                                  SAVED DATA FIELDS                            
STAFLDSA DS    0CL150                                                           
STANAME  DS    CL30                                                             
STALIN1  DS    CL30                                                             
STALIN2  DS    CL30                                                             
STALIN3  DS    CL30                                                             
STALIN4  DS    CL30                                                             
STACSYS  DS    CL15                STATION COMPUTER SYSTEM (SOURCE?)            
*                                                                               
*                                                                               
BILSTA   DS    CL5                                                              
*                                                                               
IDBFLDS  DS    0C                                                               
IDBAGYN  DS    CL25                                                             
IDBOFFNL DS    X                                                                
IDBOFFN  DS    CL18                                                             
IDBFLDLQ EQU   *-IDBFLDS                                                        
*                                                                               
IDBFLAG  DS    C                                                                
*                                                                               
REDIRFLG DS    C                                                                
*                                                                               
DATADISP DS    H                                                                
ELCODE   DS    X                                                                
*                                                                               
AGYFLDS  DS    0CL150                                                           
AGYNAME  DS    CL30                                                             
AGYLIN1  DS    CL30                                                             
AGYLIN2  DS    CL30                                                             
AGYLIN3  DS    CL30                                                             
AGYLIN4  DS    CL30                                                             
*                                                                               
SVAGYFL  DS    0CL150                                                           
SVAGYNM  DS    CL30                                                             
         DS    CL120                                                            
SVMEDIA  DS    CL1                                                              
*                                                                               
* TOTALS FROM INPUT DATA SET 12 TOTALS RECORD                                   
*                                                                               
TOTINVS  DS    F                                                                
TOTDOLS  DS    PL8                                                              
*                                                                               
*                  TOTALS FROM START OF RUN OR SINCE LAST TOTAL RECORD          
*                                                                               
CFLDS    DS    0F                                                               
CINVS    DS    F                                                                
CDOLN    DS    PL8                                                              
CDOLG    DS    PL8                                                              
*                                                                               
OLDSTA   DS    CL8                                                              
*OLDSTAD  DS    CL150                                                           
OLDAGY   DS    CL150                                                            
*                                                                               
* WORK AREA TO ALLOW FIELDS TO SPAN RECORDS *                                   
* EACH FIELD IS BUILT HERE                  *                                   
*                                                                               
WLEN     DS    H                                                                
WDATA    DS    CL256                                                            
EZBILL   DS    CL512               BUFFER REC WAS 419, NOW 149                  
*                                                                               
* AGENCY LOOKUP  BLOCK                                                          
LKAGYBLK DS    0CL14                                                            
LKAGYBID DS    CL2                 BINARY USER ID                               
LKAGYAGY DS    CL2                 AGY ALPHA                                    
LKAGYUID DS    CL10                ALPHA USER ID                                
*                                                                               
* CKADV UID AGENCY BLOCK                                                        
CKADVBLK DS    0CL14                                                            
CKADVBID DS    CL2                 BINARY USER ID                               
CKADVAGY DS    CL2                 AGY ALPHA                                    
CKADVUID DS    CL10                ALPHA USER ID                                
*                                                                               
         DS    0F                  ALIGN ON A FULLWORD                          
BSPARS1  DS    XL24                BINSRCH PARAMETERS - 1                       
         ORG   BSPARS1                                                          
BP1_1    DS    F                   A(RECORD)                                    
BP1_2    DS    F                   A(TABLE)                                     
BP1_3    DS    F                   NUMBER OF RECORDS                            
BP1_4    DS    F                   RECORD LENGTH                                
BP1_5    DS    F                   KEY LENGTH                                   
BP1_6    DS    F                   MAX ENTRIES                                  
*                                                                               
         DS    0F                  ALIGN ON A FULLWORD                          
BSPARS2  DS    XL24                BINSRCH PARAMETERS - 2                       
         ORG   BSPARS2                                                          
BP2_1    DS    F                   A(RECORD)                                    
BP2_2    DS    F                   A(TABLE)                                     
BP2_3    DS    F                   NUMBER OF RECORDS                            
BP2_4    DS    F                   RECORD LENGTH                                
BP2_5    DS    F                   KEY LENGTH                                   
BP2_6    DS    F                   MAX ENTRIES                                  
*                                                                               
       ++INCLUDE DDWRKIOD                                                       
*                                                                               
* 1 BYTE EACH FILE - 80 SET ON FOR EACH FILE, 08 IF TOTALS UNEQUAL              
*                                                                               
         DS    0F                                                               
TOTFILES DS    CL2048                                                           
EZLDWKL  EQU   *-EZLDWKD                                                        
*                                                                               
*                                                                               
*                                                                               
*                                                                               
       ++INCLUDE DMWRKFD                                                        
       ++INCLUDE DMWRKFK                                                        
       ++INCLUDE DMWRKFL                                                        
       ++INCLUDE CTGENFILE                                                      
*                                                                               
       ++INCLUDE SPGENEZ                                                        
*                                                                               
*                                                                               
       ++INCLUDE DDDPRINT                                                       
         ORG   P                                                                
ILADV    DS    CL25                                                             
         DS    CL1                                                              
ILADVCD  DS    CL8                                                              
         DS    CL1                                                              
ILPRD    DS    CL25                                                             
         DS    CL2                                                              
ILPRDCD  DS    CL8                                                              
         DS    CL2                                                              
ILEST    DS    CL10                                                             
         DS    CL1                                                              
ILINV    DS    CL10                                                             
         DS    CL2                                                              
ILMOS    DS    CL4                                                              
         DS    CL3                                                              
ILSPTS   DS    CL5                                                              
ILDOLS   DS    CL12                                                             
         DS    CL3                                                              
ILNET    DS    CL4                                                              
*                                                                               
EZLOAD   CSECT                                                                  
         DS    0D                                                               
FILIST   DC    CL8'NGENDIR'                                                     
         DC    CL8'NGENFIL'                                                     
         DC    CL8'NCTFILE'                                                     
         DC    CL10'X'                                                          
*                                                                               
COLHDS1  DC    CL132'ADVERTISER NAME           CODE     PRODUCT NAME   C        
                           CODE      EST        INVOICE    MONTH   SPOTC        
               S       NET'                                                     
COLHDS2  DC    CL132'---------------           ----     ------------   C        
                           -------   ---        -------    -----   ----C        
               -    ---------'                                                  
*                                                                               
         DS    0D                                                               
EZINPUTF DCB   DDNAME=EZINPUT,DSORG=PS,RECFM=FB,MACRF=GM,EODAD=GETEOF           
         DS    0D                                                               
EZINPUTU DCB   DDNAME=EZINPUT,DSORG=PS,RECFM=U,MACRF=GM,EODAD=GETEOF            
         DS    0D                                                               
EZINPUTV DCB   DDNAME=EZINPUT,DSORG=PS,RECFM=VB,MACRF=GM,EODAD=GETEOF           
         DS    0D                                                               
EZBILLF  DCB   DDNAME=EZBILL,                                          C        
               DSORG=PS,                                               C        
               LRECL=256,                                              C        
               RECFM=FB,                                               C        
               MACRF=PM                                                         
*                                                                               
         DS    0D                                                               
EZHOLDR  DCB   DDNAME=EZHOLD,                                          C        
               DSORG=PS,                                               C        
               EODAD=GETEOFH,                                          C        
               LRECL=512,                                              C        
               RECFM=VB,                                               C        
               MACRF=GM                                                         
*                                                                               
         DS    0D                                                               
EZHOLDW  DCB   DDNAME=EZHOLD,                                          C        
               DSORG=PS,                                               C        
               LRECL=512,                                              C        
               RECFM=VB,                                               C        
               MACRF=PM                                                         
*                                                                               
         DS    0D                                                               
EZWORKW  DCB   DDNAME=EZWORK,                                          C        
               DSORG=PS,                                               C        
               LRECL=512,                                              C        
               RECFM=VB,                                               C        
               MACRF=PM                                                         
*                                                                               
         DS    0D                                                               
EZWORKR  DCB   DDNAME=EZWORK,                                          C        
               DSORG=PS,                                               C        
               EODAD=EOFWORK,                                          C        
               LRECL=512,                                              C        
               RECFM=VB,                                               C        
               MACRF=GM                                                         
*                                                                               
         DS    0D                                                               
EZCLTUID DCB   DDNAME=EZCLTUID,                                        C        
               DSORG=PS,                                               C        
               RECFM=FB,                                               C        
               MACRF=GM,                                               C        
               EODAD=EZL97X                                                     
*                                                                               
       ++INCLUDE FASSBOFF                                                       
         ORG   SSOOFF                                                           
SSB      DC    XL(SSOOFFX-SSOOFF)'00'                                           
         ORG   SSOXTND                                                          
         DC    X'FF'               SET EXTENDED OFFLINE SSB                     
         ORG                                                                    
SSBL     EQU   *-SSB                                                            
*                                                                               
UTL      DS    0D                                                               
         DC    F'0'                                                             
         DC    X'0A'               CONTROL SYSTEM                               
*                                                                               
         DS    0D                                                               
         DC    CL8'*WKRBUF*'                                                    
WKRBUFC  DS    14336X                                                           
*                                                                               
         DC    CL8'*WKRREC*'                                                    
WKRRECC  DS    4096X                                                            
*                                                                               
         DC    CL8'*RECWRK*'                                                    
RECWRK   DS    1024X                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVVER*'                                                    
SAVVER   DS    1024X                                                            
SAVVERLN EQU   *-SAVVER                                                         
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVSTA*'                                                    
SAVSTA   DS    1024X                                                            
SAVSTALN EQU   *-SAVSTA                                                         
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVPAY*'                                                    
SAVPAY   DS    1024X                                                            
SAVPAYLN EQU   *-SAVPAY                                                         
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVAGY*'                                                    
SAVAGY   DS    1024X                                                            
SAVAGYLN EQU   *-SAVAGY                                                         
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVIDB*'                                                    
SAVIDB   DS    1024X                                                            
SAVIDBLN EQU   *-SAVIDB                                                         
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVSCT*'       STANDARD COMMENT TOP                         
SAVSCT   DS    5XL140                                                           
SAVSCTLN EQU   *-SAVSCT                                                         
*                                                                               
         DS    0D                                                               
         DC    CL8'*SAVSCB*'       STANDARD COMMENT BOTTOM                      
SAVSCB   DS    5XL140                                                           
SAVSCBLN EQU   *-SAVSCB                                                         
*                                                                               
         DS    0D                                                               
         DC    CL8'*GENREC*'                                                    
GENREC   DS    1024X                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*GENRE2*'                                                    
GENREC2  DS    4096X                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*HLDREC*'                                                    
HLDREC   DS    1024X                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*STTAB**'                                                    
STTAB    DS    50CL5                                                            
STTABMX  EQU   50                                                               
*                                                                               
         DS    0D                                                               
         DC    CL8'*IDTAB**'                                                    
IDTAB    DS    50CL8                                                            
IDTABMX  EQU   50                                                               
*                                                                               
         DS    0D                                                               
         DC    CL8'**EZIN**'                                                    
         DC    F'0'                                                             
EZINREC  DS    CL33000                                                          
         DC    64X'00'             MAY USE TO MARK EOR                          
         DC    CL8'**EOR***'                                                    
*                                                                               
         DS    0D                                                               
         DC    CL8'*STATAB*'                                                    
         DC    F'0'                                                             
EZSTATAB DC    1800XL29'00'        STATION TABLE WAS 900, NOW 1800              
EZSTALEN EQU   1800                                                             
EZSTAELN EQU   29                                                               
         DC    CL8'*ENDSTA*'  5-STA, 4 #INV, 4 #SPTS, 4 NET DOLS, 4 GRS         
*        ENTRY WAS 21, NOW 29                         8           8             
*                                                                               
         DS    0D                                                               
         DC    CL8'*AGYCTB*'                                                    
         DC    F'0'                                                             
EZAGYCTB DC 100XL32'00'        AGENCY TABLE                                     
EZAGYCLN EQU   100                                                              
         DC    CL8'*ENDAGY*'    8-USID, 4 #INV, 4 #SPTS, 8 NET, 8 GRS           
*                                                                               
         DS    0D                                                               
         DC    CL8'*AGYNTB*'                                                    
         DC    F'0'                                                             
EZAGYNTB DC 500XL178'00'           AGENCY NAME TABLE                            
EZAGYNLN EQU   500                 AGENCY NAME TABLE ENTRIES                    
         DC    CL8'*ENDAGY*' 150-NAME & ADDRESS                                 
*                              1 FOR MEDIA BITS                                 
*                              1 SPARE                                          
*                              8  - 4 EACH FOR # INV, SPTS                      
*                              16 - 8 EACH FOR NET & GROSS $                    
*                              2-USID (UNKNOWN INDICATOR)                       
         DS    0D                                                               
         DC    CL8'*MEDCTB*'                                                    
         DC    F'0'                                                             
*                                                                               
* MONTH OF SERVICE TABLE                                                        
*                                                                               
MOSTABLE DC  40XL6'00'                                                          
MOSTABLN EQU 40                                                                 
* MEDIA TABLE                                                                   
*                                                                               
EZMEDCTB DC  10XL21'00000000000000000000000000000F00000000000F'                 
         DC    CL8'*ENDMED*'   1-MEDIA 4 # INV, 4 #SPTS, 6 NET, 6 GRS           
*                               BINARY  BINARY   PACKED                         
*                                                                               
* RECORD BUILT HERE (TO ALLOW SPANNED FIELDS/RECORDS FROM BLOCK TO              
*                    BLOCK)                                                     
*                                                                               
         DS    0D                                                               
         DC    CL8'**EZOT**'                                                    
EZOTREC  DS    CL1024                                                           
EZOTRECL EQU   1024                                                             
*                                                                               
         DS    0D                                                               
         DC    CL8'*REGSAV*'                                                    
*REGSAVE  DS    XL30000                                                         
REGSAVE  DS    XL50000                                                          
*                                                                               
       ++INCLUDE DDCOMFACSC                                                     
*                                                                               
COMMON   DS    0D                                                               
         LTORG                                                                  
*                                                                               
EZLOADX  DS    0D                                                               
*                                                                               
       ++INCLUDE EZBILLD                                                        
       ++INCLUDE DDAGYALPH                                                      
       ++INCLUDE SPEZDSCTS                                                      
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'191EZLOAD    03/22/18'                                      
         END                                                                    
