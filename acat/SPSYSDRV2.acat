*          DATA SET SPSYSDRV2  AT LEVEL 080 AS OF 11/08/19                      
*CATALP SPSYSD2                                                                 
         TITLE 'SPSYSDRV2 - SYSTEM DRIVER FOR SPOTPAK WRITER PART 2'            
*                                                                               
*********************************************************************           
*                                                                   *           
*          SPSYSDRV2 - SYSTEM DRIVER FOR SPOT WRITER (PART 2)       *           
*                                                                   *           
*-------------------------------------------------------------------*           
***********************************************************************         
* USER     JIRA       DATE                 CHANGE LOG                 *         
* ---- ------------ -------- ---------------------------------------- *         
* AKAT SPEC-30530   11/08/19 SUPPORT FOR 2 DECIMAL IMPRESSIONS        *         
* AKAT SPEC-31519   11/07/19 NEW NET2CPP KEYWORD SUPPORT              *         
* AKAT SPEC-24312   10/23/18 REPORT SPOTS WHEN USING NETWORK=NWK      *         
* AKAT SPEC-16250   05/30/18 NEW COST2 KEYWORDS SUPPORT               *         
* AKAT SPEC-21520   03/20/18 HONOR MKT WEIGHTING FOR COMSCORE GOALS   *         
* AKAT SPEC-12212   02/16/18 COMSCORE SUPPORT FOR GOALS               *         
* AKAT SPEC-11692   02/16/18 NEW TARGET3 & TARGET4 KEYWORD SUPPORT    *         
* AKAT SPEC-13312   05/26/17 FIX SQAD EQUIVALENCING BUG               *         
* AKAT SPEC-6939    03/02/17 SUPPORT COMSCORE DEMO LOOKUPS FOR 17.1.5 *         
* AKAT SPEC-9011    02/10/17 UPDATE TO CANADIAN NATIONAL DEMOS        *         
* AKAT SPEC-15      02/10/17 SUPPORT NEW SQAD CPM                     *         
* AKAT CUSTENH-3341 10/28/16 SUPPORT NEW CANADIAN NATIONAL DEMOS      *         
***********************************************************************         
* 30OCT14 70 AKT -- COMSEQ MOVED TO SPWRIWORKD                      *           
* 25JUN14 69 AKT -- EXCLUDE NTWK BUYS IN CPP CALCULATIONS           *           
* 05SEP12 68 AKT -- SUPPORT SQADLEN OPTION                          *           
* 08FEB12 67 AKT -- SUPPORT COST2 CPP                               *           
* 05DEC11 66 AKT -- SUPPORT COST2 FOR BILL KEYWORDS                 *           
* 02JUN11 65 AKT -- SUPPORT NEW CLEARANCE STATUS FORMAT             *           
* 05MAY11 64 AKT -- PROGRAM EXCHANGE HAS THEIR OWN FIELDS NOW       *           
* 15APR11 63 AKT -- CHANGE BYNET KEYWORD BACK                       *           
* 16MAR11 62 AKT -- SUPPORT CALCULATED NET FOR BILLED EXCHANGE      *           
* 01MAR10 61 AKT -- ALWAYS PRINT MCOM/SCOM LINE WHEN DOWNLOADING    *           
* 19DEC07 60 AKT -- GM BILLING RESTRUCTURE SUPPORT                  *           
* 08OCT07 59 AKT -- FIX 2 DECIMAL DEMOS BUG WHEN USING TARGET       *           
* 24SEP07 58 AKT -- FIX 2 DECIMAL DEMOS BUG FROM PREVIOUS VERSION   *           
* 06SEP07 57 AKT -- FIX 2 DECIMAL DEMOS BUG FOR TARGET KEYWORD      *           
* 27FEB07 56 AKT -- BILLGST NOW FULLWORD INSTEAD OF XL3             *           
* 18DEC06 55 AKT -- MCOM/SCOM SHOULD HONOR RECORD HIERARCHY         *           
* 13SEP06 54 AKT -- SUPPORT NEW GOAL LOCKIN KEYWORDS                *           
* 28AUG06 53 AKT -- MAKE SURE PRD IN SCOM KEY GETS SET CORRECTLY    *           
* 11JUL06 52 EFJ -- USE CHOPPER FOR OMCOM OUTPUT                    *           
* 13JUN06 51 EFJ -- SUPPORT TRADEGV KEYWORD FOR PROGRAM EXCAHNGE    *           
* 24MAY06 50 AKT -- STOP PASSING CHOPPER 132 LINES AS PRNTLINE WIDTH*           
* 10MAY06 49 AKT -- CPP KEYWORDS SHOULD HONOR 2 DECIMAL DEMOS ONLY  *           
*                -- FOR RATINGS AND EXTENDED RATINGS                *           
* 04APR06 48 AKT -- NEW SCOM KEYWORD SUPPORT                        *           
* 12DEC05 47 AKT -- 2 DECIMAL DEMOS SUPPORT FOR STACKING KEYWORDS   *           
* 01NOV05 46 AKT -- USE DEMNAMES WHEN CHECKING RATING TYPE          *           
* 30SEP05 45 AKT -- SQAD SHOULD NOT HONOR 2 DECIMAL DEMO FLAG!      *           
* 03FEB05 44 AKT -- EXTENDED RATING SHOULD SUPPORT 2 DECIMAL DEMOS  *           
*                -- MORE SUPPORT FOR 2 DECIMAL DEMOS                *           
* 07APR04 43 EFJ -- SUPPORT FOR 2 DECIMAL DEMOS                     *           
*                -- MOVE SOME STUFF AROUND FOR ADDRESSABILITY       *           
* 23FEB04 42 AKT -- MAKE SURE NT IS HONORED IN OCPP BY CLEARING R2  *           
* 24NOV03 41 EFJ -- FILL IN DATE TWICE FOR IBILNVDT (FOR OPER)      *           
* 05NOV03 40 AKT -- READ BCOM AT CLI LEVEL IF FLAG IS SET           *           
* 04NOV03 39 AKT -- FIXED STACKED NEGATIVE AMOUNT AND ROUNDING      *           
* 29SEP03 38 AKT -- 60 SECOND SPOTS FOR SQAD RADIO                  *           
* 24SEP03 37 PWE -- PST                                             *           
* 15SEP03 36 AKT -- TEST FOR CASHIER CONTROL BLOCK IN ISTABINV      *           
* 11SEP03 35 AKT -- SET EDITOR TO ROUND OFF IF NUMBER GETS TOO BIG  *           
* 13NOV03 34 EFJ -- FIX GNDOL STACK KEYWORD                         *           
* 11OCT02 32 EFJ -- FIX BILBLSPT KEYWORD                            *           
* 13JUN02 31 EFJ -- MORE BUY COMMENT FIX                            *           
* 11JUN02 30 EFJ -- FIX BUY COMMENT KEYWORDS                        *           
* 03JUN02 29 EFJ -- STATION LOCKIN DOLLARS IN STACK                 *           
*                -- MAKE SOME ROOM                                  *           
* 16MAY02 28 BOB -- FIX SQAD ROUNDING                               *           
* 30APR02 26 EFJ -- DON'T PROCESS DEMOS FOR MKT 0 BUYS              *           
*                -- CHANGE BAL/BALR TO BAS/BASR                     *           
* 31JAN02 25 EFJ -- ESTIMATE HEADER CONVERSION                      *           
* 09OCT01 24 EFJ -- CHANGE *+4 TO *+8 FOR IDF                       *           
* 21JUN01 23 EFJ -- FIX CHOPPER CALL FOR COMMENTS > 255 CHARS       *           
* 30OCT00 22 BOB -- SQAD CPP'S WITH WEIGHTED AVERAGING              *           
* 13OCT00 21 EFJ -- NEW STATION LOCKIN KEYWORDS                     *           
* 16MAY00 20 BOB -- CDN NETWK AND WHEN TO PRINT SPOTS               *           
* 01MAY00 19 BOB -- STATION BILL EDI     DATE                       *           
* 31MAR00 18 BOB -- STATION BILL INVOICE DATE                       *           
* 24MAR00 14 BOB -- DROP SQAD DATA FROM DPT TOTAL RECS              *           
* 24NOV99 13 BOB -- SQAD DEMOS INPUT ROUTINE                        *           
* 24NOV98 12 EFJ -- ONLY SHOW SRC COMMENT WHEN FILTERING BY SRC     *           
* 17SEP98 11 EFJ -- NOP CHILD SPOT CPP CODE (USE PACKED VERSIONS)   *           
* 03JUN98 10 NRK -- NET THE BUY CPP IF REQUESTED                    *           
* 06MAY98 09 EFJ -- MOVE DL ROUTINES TO DRV4 (INCL Y2K CODE)        *           
* 04MAY98 08 EFJ -- DON'T ROUND BYDOL IF COST ROW                   *           
* 04FEB98 07 EFJ -- ONLY DROP SRC= FROM COMMENT (NOT SRC=N)         *           
* 20NOV97 06 EFJ -- SUPPORT PAIDTDY                                 *           
* 12NOV97 05 EFJ -- ONLY PROCESS SBPROCB1 IN IBILL IF GLARG+2=X'01' *           
* 11NOV97 04 EFJ -- DROP SRC=N FROM COMMENTS WHEN FILTERING ON SRC  *           
* 12JUN97 03 EFJ -- SUPPORT 'E' MODIFIER FOR MKT WEIGHTING          *           
* 23APR97 02 EFJ -- FIX BUG - DON'T ROUND GLNET                     *           
* 23APR97 01 EFJ -- LEVEL RESET                                     *           
*-------------------------------------------------------------------*           
* 27AUG96 22 EFJ -- BYNET- KEYWORD                                  *           
* 22MAY96 21 EFJ -- SUPPORT FOR PW STACK KEYWORDS                   *           
* 06MAY96 20 EFJ -- CK FOR CANADA FOR SPOTS KEYWORD FOR MEDIA N     *           
* 19MAR96 19 EFJ -- FIX OVERFLOW PROBLEM IN IGLNET                  *           
* 26JAN96 18 EFJ -- REMOVE PREVIOUS "FIX" (LCONN CAN'T DECIDE...)   *           
* 16JAN96 17 EFJ -- GOAL $ IN ST$STACK SHOULD BE STGDOL, NOT STGOAL *           
* 11JAN96 16 EFJ -- SUPPORT NEW STACK FEATURES                      *           
* 14DEC95 15 EFJ -- DON'T DIE ON BAD CBL COUNT                      *           
* 17OCT95 14 EFJ -- NEW TOTALLING FOR CSPOTS                        *           
* 11OCT95 13 EFJ -- NO TOTALS FOR CSPOTS                            *           
* 07SEP95 12 EFJ -- SUPPORT FOR CABLE AGGREGATE                     *           
* 25JUL95 11 EFJ -- DON'T FORCE ZERO=NOBLANK IF DL FOR SPOTS        *           
*                   (IE: UNDO LEVEL 10)                             *           
* 14JUN95 10 EFJ -- FORCE ZERO=NOBLANK IF DOWNLOADING FOR SPOTS     *           
* 06APR95 09 EFJ -- CLEAR SVCOMKEY 1ST TIME THROUGH                 *           
* 24MAR95 08 EFJ -- FIX BUG IN OMCOM                                *           
* 20MAR95 07 EFJ -- MOVE WIPW ROUTINES TO DRV3 FOR MORE ROOM        *           
* 16MAR95 06 EFJ -- UPDATE ICLTBUY TO REPORT OVERRIDE $$$           *           
* 14DEC94 05 EFJ -- NEW KEYWORD SUPPORT - BCOM                      *           
* 28OCT94 04 EFJ -- DON'T PUT '1' IN FOR STDATA                     *           
* 25JUL94 03 EFJ -- TRY TO FIX TOTALING BUG IN BYADEM               *           
* 14JUL94 02 EFJ -- SUPPORT WESTERN PW                              *           
*                                                                   *           
*                                                                   *           
*********************************************************************           
SPSYSD2  CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,**SPD2**,R7,R8                                                 
         USING GLOBALD,RA                                                       
         L     RC,GLAWORKD                                                      
         USING GEND,RC                                                          
         L     R9,ASYSD                                                         
         USING SYSD,R9                                                          
*                                                                               
         CLI   GLHOOK,GLRESOLV     RESOLVE ADDRESSES                            
         BE    RESOLVE                                                          
*                                                                               
         CLI   GLHOOK,GLROUT       EXECUTE ROUTINES                             
         BE    EXEC                                                             
*                                                                               
         CLI   GLHOOK,GLINCOMP     INTERNAL COMPUTES                            
         BE    EXEC                                                             
*                                                                               
XIT      XIT1  ,                                                                
         EJECT                                                                  
* RESOLVE ROUTINE ADDRESSES                                                     
* ON INPUT, R2 = A(ROUTINE TABLE ENTRY)                                         
*                                                                               
         SPACE 1                                                                
         USING WRIRTBD,R2                                                       
RESOLVE  SR    R1,R1                                                            
         ICM   R1,3,WRRNUM                                                      
         SLL   R1,1                                                             
         LAY   R1,ROUTTAB-2(R1)                                                 
         MVC   *+8(2),0(R1)                                                     
         LA    RF,0                                                             
         ST    RF,GLAROUT                                                       
*                                                                               
         XC    SVCOMKEY,SVCOMKEY                                                
         XC    SVMCOMKY,SVMCOMKY                                                
         XC    SVCMKT,SVCMKT                                                    
         XC    SVCSTA,SVCSTA                                                    
*                                                                               
         B     XIT                                                              
         DROP  R2                                                               
         EJECT                                                                  
* EXECUTING ROUTINES                                                            
* ON EXIT,  CC EQ - EXECUTE GENOUT ROUTINE IN THE ROOT                          
*           CC NE - JUST EXIT WITHOUT FURTHER PROCESSING                        
*                                                                               
         SPACE 1                                                                
EXEC     MVI   WORK,X'40'          PRESET WORK AREA                             
         MVC   WORK+1(L'WORK-1),WORK                                            
         ST    R1,ALVLSWS          SAVE A(PUT TO SORT SWITCHES)                 
         L     RF,GLAROUT          RF=A(ROUTINE)                                
         CLI   GLMODE,GLINPUT      TEST INPUT ROUTINE                           
         BNE   EXEC2                                                            
         L     R4,SBACURCH         YES-ADDRESS THE CHUNKS                       
         USING SCHUNKD,R4                                                       
         LR    R5,R4                                                            
         USING SGLCHNKD,R5                                                      
         L     R1,GLADTENT                                                      
         USING DRIND,R1                                                         
         MVC   INLEVEL,DRINLEV     SAVE LEVEL                                   
         DROP  R1                                                               
*                                                                               
EXEC2    BR    RF                  EXECUTE THE ROUTINES                         
*                                                                               
GENOUT   CR    RB,RB               CC EQ                                        
         B     XIT                                                              
*                                                                               
EXIT     LTR   RB,RB               CC NE                                        
         B     XIT                                                              
         EJECT                                                                  
* MEDIA COMMENTS I/O ROUTINES                                                   
*                                                                               
IMCOM    MVI   0(R2),1             DUMMY INPUT ROUTINE                          
         CLI   GLARGS,C'T'         DOING SCOM?                                  
         BNE   *+10                NO                                           
         MVC   1(3,R2),SBBSTA      YES - NEED STATION                           
         B     EXIT                                                             
*                                                                               
OMCOM    BRAS  RE,OUTMCOM                                                       
         B     EXIT                                                             
* I/O ROUTINES FOR BUYLINE COMMENTS                                             
*                                                                               
         SPACE 1                                                                
ICOM     L     RE,SBAIO1           ** INPUT **                                  
         USING BUYRECD,RE                                                       
         XC    0(2,R2),0(R2)                                                    
         CLI   GLARGS+1,X'FF'                                                   
         BNE   *+10                                                             
         XC    0(4,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   EXIT                                                             
         CLC   BUYKEY,SVBUYKEY     TEST CHANGE OF BUY RECORD                    
         BNE   ICOM4                                                            
         CLI   GLARGS+1,X'FF'      NO-COMMENT SEQUENCE NUMBERS MAY              
         BNE   ICOM2                  ALREADY BE SET                            
         CLI   COMSW+5,C'Y'                                                     
         BNE   EXIT                                                             
         MVC   0(2,R2),COMSEQ1                                                  
         MVC   2(2,R2),COMSEQX                                                  
         B     EXIT                                                             
*                                                                               
ICOM2    LLC   RF,GLARGS+1                                                      
         BCTR  RF,0                                                             
         LA    R1,COMSW(RF)                                                     
         CLI   0(R1),C'Y'                                                       
         BNE   ICOM7               TRY TO FIND IT!                              
***         BNE   EXIT                                                          
         SLL   RF,1                                                             
         LA    RF,COMSEQ1(RF)                                                   
         MVC   0(2,R2),0(RF)                                                    
         B     EXIT                                                             
*                                                                               
ICOM4    MVC   SVBUYKEY,BUYKEY     NEW BUY RECORD                               
         LA    R0,6                CLEAR SAVED SEQUENCE NUMBERS                 
         LA    R1,COMSEQ1                                                       
         LA    RF,COMSW                                                         
*                                                                               
ICOM6    XC    0(2,R1),0(R1)                                                    
         MVI   0(RF),C'N'                                                       
         LA    R1,2(R1)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,ICOM6                                                         
*                                                                               
ICOM7    LA    R1,WORK2                                                         
         MVI   0(R1),C'C'                                                       
         LA    R6,BDELEM           SEARCH BUYLINE FOR COMMENT ELEMENTS          
         SR    R0,R0                                                            
         SR    R3,R3                                                            
*                                                                               
ICOM8    CLI   0(R6),0                                                          
         BE    ICOM12                                                           
         CLI   0(R6),X'66'                                                      
         BNE   ICOM10                                                           
         USING COMELEM,R6                                                       
         CLI   GLARGS+1,X'FF'      TEST ALL COMMENTS                            
         BE    *+14                                                             
         CLC   CMNUM,GLARGS+1      NO-MATCH COMMENT NUMBER                      
         BNE   ICOM10                                                           
         LLC   RE,CMLEN                                                         
         SHI   RE,3                                                             
         BNP   ICOM10                                                           
         LH    R3,COMSEQ           NEXT COMMENT SEQUENCE NUMBER                 
         LA    R3,1(R3)                                                         
         CHI   R3,32766                                                         
         BNH   *+6                                                              
         DC    H'0'                                                             
         STH   R3,COMSEQ                                                        
         STH   R3,1(R1)                                                         
         STC   RE,3(R1)                                                         
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   4(0,R1),CMDATA                                                   
         GOTO1 PUTGENEL            SAVE COMMENT IN NAME POOL                    
*                                                                               
         LLC   RE,CMNUM            SAVE RELATIVE COMMENT NUMBER                 
         BCTR  RE,0                                                             
         LA    RF,COMSW(RE)                                                     
         MVI   0(RF),C'Y'                                                       
         SLL   RE,1                                                             
         LA    RE,COMSEQ1(RE)                                                   
         STH   R3,0(RE)                                                         
*                                                                               
         CLI   GLARGS+1,X'FF'      TEST ALL COMMENTS                            
         BE    *+12                                                             
         STH   R3,0(R2)            NO-PASS COMMENT SEQ TO DRIVER                
         B     EXIT                                                             
         OC    0(2,R2),0(R2)       YES-PASS FIRST COMMENT SEQ TO DRIVER         
         BNZ   ICOM10                                                           
         STH   R3,0(R2)                                                         
*                                                                               
ICOM10   IC    R0,1(R6)                                                         
         AR    R6,R0                                                            
         B     ICOM8                                                            
*                                                                               
ICOM12   CLI   GLARGS+1,X'FF'      TEST ALL COMMENTS                            
         BNE   EXIT                                                             
         LTR   R3,R3               AND THERE'S AT LEAST ONE COMMENT             
         BZ    EXIT                                                             
         STH   R3,2(R2)            YES-PASS LAST COMMENT SEQ TO DRIVER          
         STH   R3,COMSEQX                                                       
         MVI   COMSW+5,C'Y'                                                     
         B     EXIT                                                             
         DROP  R6,RE                                                            
         SPACE 2                                                                
OCOM     DS    0H                  ** OUTPUT **                                 
         SR    R4,R4                                                            
         SR    R5,R5                                                            
         ICM   R5,3,0(R2)                                                       
         BZ    EXIT                                                             
         L     R6,AIO3                                                          
         MVI   0(R6),C' '                                                       
         MVC   1(255,R6),0(R6)                                                  
         MVC   256(256,R6),255(R6)                                              
*                                                                               
OCOM2    XC    WORK2,WORK2         COMMENT IS IN GENERAL ELEMENT                
         LA    R1,WORK2            IN NAME POOL                                 
         MVI   0(R1),C'C'                                                       
         STH   R5,1(R1)            COMMENT SEQ NUM                              
         MVI   3(R1),0                                                          
         GOTO1 GETGENEL                                                         
         SR    RE,RE                                                            
         ICM   RE,1,3(R1)          LENGTH OF COMMENT                            
         BZ    OCOM4                                                            
         AR    R4,RE               ACCUMULATE TOTAL LENGTH                      
         BCTR  RE,0                                                             
         LR    RF,R9                                                            
         AH    RF,=Y(SBEFLAG2-SYSD)                                             
         TM    0(RF),SBESRC        SRC FILTER?                                  
         BZ    OCOM3                                                            
         CLC   =C'SRC',4(R1)       IS THIS AN SRC COMMENT?                      
         BNE   OCOM4                NO - SKIP IT                                
         LA    R1,4(R1)                                                         
         SHI   RE,4                                                             
*                                                                               
OCOM3    EX    RE,*+8              MOVE COMMENT TO BLOCK                        
         B     *+10                                                             
         MVC   0(0,R6),4(R1)                                                    
*                                                                               
OCOM4    CLI   GLARGS,X'FF'        TEST ALL COMMENTS                            
         BNE   OCOM6                                                            
         OC    2(2,R2),2(R2)       YES-TEST RANGE OF COMMENTS GIVEN             
         BZ    OCOM6                                                            
         LA    R5,1(R5)            YES-GET NEXT COMMENT                         
         CH    R5,2(R2)                                                         
         BH    OCOM6                                                            
         LA    R6,2(RE,R6)                                                      
         LA    R4,1(R4)            ADD ONE FOR SPACE                            
         B     OCOM2                                                            
*                                                                               
OCOM6    LTR   R4,R4               TEST ANY COMMENTS FOUND                      
         BNZ   *+14                                                             
         MVC   0(9,R3),=C'*UNKNOWN*'                                            
         B     EXIT                                                             
         ST    R4,DMCB+4           GET RID OF EXTRA SPACES                      
         L     R6,AIO3                                                          
         GOTO1 SQUASHER,DMCB,(R6)                                               
         L     RE,4(R1)                                                         
         ST    R6,DMCB             SET UP FOR CHOPPER                           
         ST    R3,DMCB+4           A(OUTPUT)                                    
         MVC   DMCB+4(1),MYOLEN    LENGTH OF OUTPUT                             
         LA    R1,20               MAX N'LINES                                  
         ST    R1,DMCB+8                                                        
***      MVI   DMCB+8,C'P'         SET P3 BYTE 1 TO C'P'                        
***      CLI   WIDTHOPT,C'W'       UNLESS ITS WIDE                              
***      BNE   *+8                                                              
         MVI   DMCB+8,198          WHEN PRINT LINES ARE 198 APART               
         MVC   DMCB+12,=C'LEN='                                                 
         ST    RE,DMCB+16                                                       
         GOTO1 CHOPPER,DMCB                                                     
         B     EXIT                                                             
         EJECT                                                                  
*                                                                               
* I/O ROUTINES FOR CLEARANCE RECORD ROWS                                        
*                                                                               
ICLCHK   ICM   RE,15,ACLRST03      HAVE X'03'/X'05' PAIR?                       
         BZ    ICLCHK10            NOPE                                         
         LLC   R0,1(RE)            YES - BUMP TO X'05' ELEMENT                  
         AR    RE,R0                                                            
         USING CLSTEL05,RE                                                      
         MVC   0(6,R2),CLS5CHK     CLEARANCE CHECK NUMBER                       
         MVI   6(R2),0                                                          
         TM    CLS5STAT,CLS5STAT_RECON                                          
         B     ICLCHK20                                                         
         DROP  RE                                                               
*                                                                               
ICLCHK10 MVC   0(6,R2),SCCHKNUM    CLEARANCE CHECK NUMBER                       
         MVI   6(R2),0                                                          
         TM    SCCHKIND,SCCHKREC   TEST CHECK IS RECONCILED                     
ICLCHK20 BZ    EXIT                                                             
         MVI   6(R2),C'*'                                                       
         B     EXIT                                                             
*                                                                               
ICLCDT   ICM   RE,15,ACLRST03      HAVE X'03'/X'05' PAIR?                       
         BZ    ICLDT10             NOPE                                         
         LLC   R0,1(RE)            YES - BUMP TO X'05' ELEMENT                  
         AR    RE,R0                                                            
         USING CLSTEL05,RE                                                      
         MVC   0(2,R2),CLS5CHDT    CLEARANCE CHECK DATE                         
         B     EXIT                                                             
         DROP  RE                                                               
*                                                                               
ICLDT10  MVC   0(2,R2),SCCHKDT     CLEARANCE CHECK DATE                         
         B     EXIT                                                             
*                                                                               
ICLCLRDT ICM   RE,15,ACLRST03      HAVE X'03'/X'05' PAIR?                       
         BZ    ICLCDT10            NOPE                                         
         LLC   R0,1(RE)            YES - BUMP TO X'05' ELEMENT                  
         AR    RE,R0                                                            
         USING CLSTEL05,RE                                                      
         MVC   0(2,R2),CLS5BKDT    BANK CLEARANCE DATE                          
         B     ICLCDT20                                                         
         DROP  RE                                                               
*                                                                               
ICLCDT10 MVC   0(2,R2),SCBNKDT     BANK CLEARANCE DATE                          
ICLCDT20 OC    0(2,R2),0(R2)      SKIP IF WE HAVE A BANK CLEARANCE DATE         
         BNZ   ICLCLRDX                                                         
*                                                                               
*        DEFAULT TO LAST DAY OF PREVIOUS MONTH                                  
*                                                                               
         GOTO1 DATCON,DMCB,(5,0),WORK    TODAY'S DATE TO YYMMDD                 
         LHI   RF,-1              SET TO DECREMENT 1 MONTH                      
         ST    RF,DMCB+8                                                        
         GOTO1 ADDAY,DMCB,(C'M',WORK),(X'80',WORK+6)  BACK 1 MON                
         GOTO1 DATCON,DMCB,WORK+6,(2,0(2))   DATE 2 BYTE COMPRESSED             
*                                                                               
         MVI   2(R2),C'*'         SET FLAG                                      
*                                                                               
ICLCLRDX B     EXIT                                                             
*                                                                               
ICLREP   ICM   R1,15,ACLRST01      POINT TO CORRECT X'01' ELEMENT               
         BZ    EXIT                                                             
         CLI   SBMODE,SBPROCSP     PROCESSING A BUY RECORD?                     
         BNE   EXIT                NO - EXIT!                                   
         USING CLSTEL01,R1                                                      
                                                                                
         MVC   0(1,R2),CLSTREPT    CLEARANCE REP                                
         MVC   1(3,R2),CLSTPYEE                                                 
         OC    CLSTPYEE,CLSTPYEE   PAYEE=X'00'?                                 
         BZ    *+14                YES - DIRECT                                 
         CLC   CLSTPYEE,=C'000'    PAYEE=000?                                   
         BNE   EXIT                NO - NOT DIRECT                              
         MVC   0(4,R2),=C'DIR '    YES-DIRECT PAYMENT                           
         B     EXIT                                                             
         DROP  R1                                                               
*                                                                               
ICLSEQ   ICM   R1,15,ACLRST01      POINT TO CORRECT X'01' ELEMENT               
         BZ    EXIT                                                             
         CLI   SBMODE,SBPROCSP     PROCESSING A BUY RECORD?                     
         BNE   EXIT                NO - EXIT!                                   
         USING CLSTEL01,R1                                                      
         MVC   0(1,R2),CLSTCLSQ    SEQUENCE NUMBER WITHIN DATE                  
         B     EXIT                                                             
         DROP  R1                                                               
*                                                                               
ICLDT    ICM   R1,15,ACLRST01      POINT TO CORRECT X'01' ELEMENT               
         BZ    EXIT                NO                                           
         CLI   SBMODE,SBPROCSP     PROCESSING A BUY RECORD?                     
         BNE   EXIT                NO - EXIT!                                   
         USING CLSTEL01,R1                                                      
         MVC   0(2,R2),CLSTCLRD    CLEARANCE DATE                               
         B     EXIT                                                             
         DROP  R1                                                               
*                                                                               
OCLREP   MVC   LABLAREA(13),=C'CLEARANCE REP'                                   
         MVC   CODEAREA(4),0(R2)                                                
         B     GENOUT                                                           
*                                                                               
OCLDT    MVC   LABLAREA(14),=C'CLEARANCE DATE'                                  
         B     OCLDATE                                                          
*                                                                               
OCLCDT   MVC   LABLAREA(10),=C'CHECK DATE'                                      
         B     OCLDATE                                                          
*                                                                               
OCLCLRDT MVC   LABLAREA(12),=C'CLEARED DATE'                                    
*                                                                               
         CLI   2(R2),C' '         ADD FLAG IF PRESENT                           
         BNH   *+10                                                             
         MVC   CODEAREA+8(1),2(R2)                                              
*                                                                               
OCLDATE  GOTO1 DATCON,DMCB,(2,(R2)),(8,CODEAREA)                                
         B     GENOUT                                                           
*                                                                               
OCLSEQ   LLC   RE,0(R2)            CLEARANCE DATE SEQUENCE NUMBER               
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  0(3,R3),DUB                                                      
         B     EXIT                                                             
*                                                                               
OCLCHK   MVC   LABLAREA(12),=C'CHECK NUMBER'                                    
         MVC   CODEAREA(7),0(R2)                                                
         B     GENOUT                                                           
         EJECT                                                                  
*                                                                               
* INPUT ROUTINES FOR COLUMNS                                                    
*                                                                               
         USING SCHUNKD,R4                                                       
ISPT     LA    R6,BIN4             SPOTS                                        
         MVC   0(4,R2),SCSPOTS                                                  
         MVI   SPTFLAG,C'Y'        INDICATE REPORTING SPOTS                     
         B     ISPTBUY                                                          
*                                                                               
ISPTPD   LA    R6,BIN4             PAID SPOTS                                   
         MVC   0(4,R2),SCPAYSP                                                  
         MVI   SPTFLAG,C'N'        INDICATE NOT REPORTING SPOTS                 
         B     ISPTBUY                                                          
*                                                                               
ISPTUNPD LA    R6,BIN4             UNPAID SPOTS                                 
         L     RE,SCSPOTS                                                       
         S     RE,SCPAYSP                                                       
         ST    RE,0(R2)                                                         
         MVI   SPTFLAG,C'N'        INDICATE NOT REPORTING SPOTS                 
*                                                                               
ISPTBUY  LA    RE,SBAGYREC                                                      
         USING AGYRECD,RE                                                       
         CLI   AGYPROF+7,C'C'      CANADIAN?                                    
         BNE   ISPT2                NO                                          
         DROP  RE                                                               
*                                                                               
         CLI   SBQMED,C'N'         TEST MEDIA = CANADIAN NETWORK                
         BE    *+12                             OR COMBINED MEDIA               
         CLI   SBQMED,C'C'                                                      
         BNE   ISPT2                                                            
*                                                                               
         CLI   SBQNETWK,C'N'       IF REPORTING NETWORK BUYS ONLY               
         BNE   ISPTBUY2                                                         
*                                                                               
         L     RE,SBAIO1           ** INPUT **                                  
         USING BUYRECD,RE                                                       
         OC    BUYMSTA(2),BUYMSTA  AND THIS IS MARKET ZERO BUY                  
         BZ    ISPT2                   REPORT THE SPOTS                         
         XC    0(4,R2),0(R2)       ELSE DO NOT REPORT THE SPOTS                 
         B     ISPT2                                                            
         DROP  RE                                                               
*                                                                               
ISPTBUY2 DS    0H                                                               
*                                                                               
         CLI   SBQNETWK,C'L'       AND NOT REPORTING LOCAL BUYS ONLY            
         BE    ISPT2                                                            
         CLI   SPTFLAG,C'Y'        REPORTING SPOTS?                             
         BNE   *+12                NO                                           
         TM    SBEFLAG8,SBE8CNWK   NETWORK=NWK OPTION?                          
         BNZ   *+10                YES - REPORT SPOTS                           
         XC    0(4,R2),0(R2)       YES-DO NOT REPORT SPOTS                      
         B     INX                                                              
*                                                                               
IORSPT   LA    R6,BIN4             ORDERED SPOTS (LOCK-IN)                      
         MVC   0(4,R2),SGLSPTS                                                  
         B     ISPT2                                                            
*                                                                               
ISLSPT   LA    R6,BIN4             STATION LOCKIN SPOTS                         
         L     R1,SBACURCH                                                      
         MVC   0(4,R2),SLSPOTS-SSLCHNKD(R1)                                     
*                                                                               
ISPT2    CLI   SBQMKTWT,C'N'                                                    
         BE    INX                                                              
         MVC   VAL,0(R2)                                                        
         BRAS  RE,WGT                                                           
         MVC   4(4,R2),VALWGT                                                   
         TM    GLARGS+(GLIIND-GLARGSD),GLIIWGT  TEST WEIGHTED SPOTS             
         BZ    INX                                                              
         MVC   0(4,R2),VALWGT      YES                                          
         B     INX                                                              
*                                                                               
IDR      LA    R6,BIN4             DIRECT RESPONSE COUNT                        
         MVC   0(4,R2),SCRSVPS                                                  
         B     INX                                                              
*                                                                               
IAUTH    LA    R6,PAK8             AUTHORIZATION DOLLARS                        
         L     R1,SBACHUNK                                                      
**NOP         L     R1,4(R1)                                                    
**NOP         CVD   R1,DUB                                                      
**NOP         ZAP   0(8,R2),DUB                                                 
         ZAP   0(8,R2),4(8,R1)                                                  
         B     INX                                                              
*                                                                               
IDOLNDX  CLI   SBMODE,SBPROCGL                                                  
         BNE   IDOLNDX2                                                         
         TM    SBQDATA,SBQDGOAL                                                 
         BO    IGLDOL                                                           
         TM    SBQDATA,SBQDORD                                                  
         BO    IORDOL                                                           
         B     INX                                                              
IDOLNDX2 CLI   SBMODE,SBPROCSP                                                  
         BNE   INX                                                              
         LA    R2,4(R2)                                                         
*                                                                               
IBYDOL   BRAS  RE,INBYDOL                                                       
*                                                                               
***      L     RE,SBAIO1           A(BUY RECORD)                                
***      USING BUYRECD,RE          BUY RECORD DSECT                             
***      TM    SBEFLAG8,SBE8CNWK   NETWORK=NWK?                                 
***      BZ    IBYDOL2             NO                                           
***      OC    BUYMSTA(2),BUYMSTA  MARKET 0?                                    
***      BZ    IBYDOL2             YES - DOLLARS FROM NETWORK BUYS              
***      MVC   BYTE,BUYKAM         A/M                                          
***      NI    BYTE,X'0F'          STRIP AGENCY                                 
***      CLI   BYTE,X'03'          PROCESSING MEDIA N?                          
***      BNE   IBYDOL2             NO                                           
***      XC    0(4,R2),0(R2)       CLEAR DOLLARS                                
***      B     INX                 EXCLUDE                                      
***      DROP  RE                  DROP BUY RECORD USING                        
*                                                                               
IBYDOL2  CLI   GLARGS+2,C'C'       COST KEYWORD?                                
         BE    INX                 YES                                          
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IASSDOL  DS    0H                                                               
         LA    R6,BIN4             ASSIGNED GROSS DOLLARS                       
         MVC   0(4,R2),SCGROSS2                                                 
*                                                                               
*         CLC   SCGROSS2,=X'80000000'  NO SECOND COST?                          
*         BNE   *+14                                                            
*         MVI   7(R2),X'80'         USE AS OUTPUT FLAG                          
*         XC    0(4,R2),0(R2)                                                   
*                                                                               
         L     R1,SCGSTI                                                        
         L     RF,SCPSTI                                                        
         BRAS  RE,GSTPSTI                                                       
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYDOLTX LA    R6,BIN4             GROSS TAX                                    
         MVC   0(4,R2),SCTAX                                                    
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYDOLM  LA    R6,BIN4             GROSS DOLLARS MINUS TAX                      
         L     RE,SCGROSS                                                       
         S     RE,SCTAX                                                         
         STCM  RE,15,0(R2)                                                      
         L     R1,SCGSTI                                                        
         L     RF,SCPSTI                                                        
         BRAS  RE,GSTPSTI                                                       
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYNET   DS    0H                                                               
         LA    R6,BIN4             NET DOLLARS                                  
*                                                                               
         MVC   0(4,R2),SCNET                                                    
         CLI   GLARGS+2,C'T'       REPORTING TRADE BILLING?                     
         BNE   *+10                NO                                           
         MVC   0(4,R2),SCNETPXG    YES - NET FOR PROGRAM EXCHANGE               
         L     R1,SCGSTI                                                        
         L     RF,SCPSTI                                                        
         BRAS  RE,GSTPSTI                                                       
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BRAS  RE,BILPCT                                                        
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYNETM  LA    R6,BIN4             GROSS DOLLARS MINUS TAX                      
         L     RE,SCNET                                                         
         S     RE,SCTAX                                                         
         STCM  RE,15,0(R2)                                                      
         L     R1,SCGSTI                                                        
         L     RF,SCPSTI                                                        
         BRAS  RE,GSTPSTI                                                       
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IASSNET  DS    0H                                                               
         LA    R6,BIN4             ASSIGNED NET DOLLARS                         
         MVC   0(4,R2),SCNET2                                                   
*                                                                               
*         CLC   SCNET2,=X'80000000'  NO SECOND COST?                            
*         BNE   *+14                                                            
*         MVI   7(R2),X'80'         USE AS OUTPUT FLAG                          
*         XC    0(4,R2),0(R2)                                                   
*                                                                               
         L     R1,SCGSTI                                                        
         L     RF,SCPSTI                                                        
         BRAS  RE,GSTPSTI                                                       
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYCOM   LA    R6,BIN4             COMMISSION DOLLARS                           
         MVC   0(4,R2),SCCOM                                                    
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYCST   LA    R6,BIN4             EFFECTIVE COST                               
         MVC   0(4,R2),SCEFFCST                                                 
         L     R1,SCGSTI                                                        
         L     RF,SCPSTI                                                        
         BRAS  RE,GSTPSTI                                                       
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYPAID  LA    R6,BIN4             PAID DOLLARS                                 
         MVC   0(4,R2),SCPAY                                                    
         L     R1,SCGSTP                                                        
         L     RF,SCPSTP                                                        
         BRAS  RE,GSTPSTI                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYPAIDT LA    R6,BIN4             PAID DOLLARS                                 
         MVC   0(4,R2),SCPAYT                                                   
*        L     R1,SCGSTP                                                        
*        BAS   RE,GSTPSTI                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYPDTX  LA    R6,BIN4             PAID TAX                                     
         MVC   0(4,R2),SCPAYTX                                                  
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYPDM   LA    R6,BIN4             PAID DOLLARS MINUS TAX                       
         L     RE,SCPAY                                                         
         S     RE,SCPAYTX                                                       
         STCM  RE,15,0(R2)                                                      
         L     R1,SCGSTP                                                        
         L     RF,SCPSTP                                                        
         BRAS  RE,GSTPSTI                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYUNPD  LA    R6,BIN4             UNPAID DOLLARS                               
         MVC   0(4,R2),SCUNP                                                    
         L     R1,SCGSTU                                                        
         L     RF,SCPSTU                                                        
         BRAS  RE,GSTPSTI                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYUPDTX LA    R6,BIN4             UNPAID TAX                                   
         MVC   0(4,R2),SCUNPTX                                                  
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYUNPDM LA    R6,BIN4             UNPAID DOLLARS MINUS TAX                     
         L     RE,SCUNP                                                         
         S     RE,SCUNPTX                                                       
         STCM  RE,15,0(R2)                                                      
         L     R1,SCGSTU                                                        
         L     RF,SCPSTU                                                        
         BRAS  RE,GSTPSTI                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYNETPD LA    R6,BIN4             NET PAID DOLLARS                             
         MVC   0(4,R2),SCPAYN                                                   
         L     R1,SCGSTP                                                        
         L     RF,SCPSTP                                                        
         BRAS  RE,GSTPSTI                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYNETUN LA    R6,BIN4             NET UNPAID DOLLARS                           
         MVC   0(4,R2),SCUNPN                                                   
         L     R1,SCGSTU                                                        
         L     RF,SCPSTU                                                        
         BRAS  RE,GSTPSTI                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
ICASH    LA    R6,PAK8             CHILD SPOT PAY EXPENDITURE                   
         L     R1,SCCSPAY                                                       
         CVD   R1,DUB                                                           
         MVC   0(8,R2),DUB                                                      
         B     INX                                                              
*                                                                               
ITRADE   LA    R6,PAK8             CHILD SPOT NTP EXPENDITURE                   
         L     R1,SCCSNTP                                                       
         CLI   GLARGS+2,C'G'                                                    
         BNE   *+8                                                              
         L     R1,SCGSTI           DONT ASK - THE CODE SUCKS                    
         CVD   R1,DUB                                                           
         MVC   0(8,R2),DUB                                                      
         B     INX                                                              
*                                                                               
IDDOL    LA    R6,PAK8             CHILD SPOT DELIVERED DOLLARS                 
         L     R1,SCCSTPT                                                       
         CVD   R1,DUB                                                           
         MVC   0(8,R2),DUB                                                      
         B     INX                                                              
*                                                                               
IGSTI    LA    R6,BIN4             INPUT GST ON GROSS DOLLARS                   
         MVC   0(4,R2),SCGSTI                                                   
         B     IGSTX               ROUND VALUE AND EXIT                         
*                                                                               
IGST     LA    R6,BIN4             OUTPUT GST ON GROSS DOLLARS                  
         MVC   0(4,R2),SCGSTO                                                   
         CLI   GLARGS+2,X'01'      WANT COST2 GST?                              
         BNE   *+10                NO                                           
         MVC   0(4,R2),SCGSTOC2    YES - USE COST2 GST                          
         B     IGSTX               ROUND VALUE AND EXIT                         
*                                                                               
IGSTP    LA    R6,BIN4             PAID GST                                     
         MVC   0(4,R2),SCGSTP                                                   
         B     IGSTX               ROUND VALUE AND EXIT                         
*                                                                               
IGSTU    LA    R6,BIN4             UNPAID GST                                   
         MVC   0(4,R2),SCGSTU                                                   
IGSTX    BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IGLDOL   LA    R6,BIN4             GOAL DOLLARS                                 
         MVC   0(4,R2),SGDOL                                                    
         CLI   GLARGS+1,C'X'       WANT LOCKIN DOLLARS?                         
         BNE   *+10                                                             
         MVC   0(4,R2),SGKDOL                                                   
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IGLNET   LA    R6,BIN4             NET GOAL DOLLARS                             
         SR    R0,R0                                                            
         L     R1,SGDOL                                                         
         M     R0,=F'85'           SGDOL * .85                                  
         SLDA  R0,1                TWICE RESULT IN R0R1                         
         D     R0,=F'100'                                                       
         LTR   R1,R1               SEE IF THE ANSWER IS NEGATIVE                
         BM    *+8                 IF IT IS, WE DON'T NEED TO ADD 1             
         AHI   R1,1                (NOT A LA INSTRUCTION)                       
         SRA   R1,1                DIVIDE BY 2                                  
         ST    R1,0(R2)            ROUNDED ANSWER                               
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IORDOL   LA    R6,BIN4             ORDERED DOLLARS (LOCK-IN)                    
         MVC   0(4,R2),SGLDOL                                                   
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
ISLDOL   LA    R6,BIN4             STATION LOCKIN DOLLARS                       
         L     R1,SBACURCH                                                      
         MVC   0(4,R2),SLDOL-SSLCHNKD(R1)                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
ISLDOL2  LA    R6,BIN4             STATION LOCKIN COST2 DOLLARS                 
         L     R1,SBACURCH                                                      
         MVC   0(4,R2),SLDOL2-SSLCHNKD(R1)                                      
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
ISLNET   LA    R6,BIN4             STATION LOCKIN NET DOLLARS                   
         L     R1,SBACURCH                                                      
         MVC   0(4,R2),SLNET-SSLCHNKD(R1)                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
ISLNET2  LA    R6,BIN4             STATION LOCKIN NET COST2 DOLLARS             
         L     R1,SBACURCH                                                      
         MVC   0(4,R2),SLNET2-SSLCHNKD(R1)                                      
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBYCNT   LA    R6,BIN4             BUYLINE COUNT                                
         LA    R1,1                                                             
         ST    R1,0(R2)                                                         
         B     INX                                                              
         EJECT                                                                  
* DEMO COLUMN INPUT ROUTINES                                                    
*                                                                               
         SPACE 1                                                                
*                                  ** DEMO INDEX **                             
IDEMNDX  CLI   SBMODE,SBPROCGL     TEST READING GOAL RECORDS                    
         BNE   IDEMNDX2                                                         
         TM    SBQDATA,SBQDGOAL+SBQDORD   YES-TEST INDEXING GOALS               
         BZ    INX                            NO                                
         OC    SBPDEMOS,SBPDEMOS              YES-TEST DEMO MENU                
         BNZ   *+12                               OR DEMO OTPION SET            
         CLI   GLARGS+1,1                 NO-TEST PRIMARY DEMO                  
         BH    INX                            NO-INDEX MAKES NO SENSE           
         TM    SBQDATA,SBQDGOAL                                                 
         BO    IGLDEM                                                           
         TM    SBQDATA,SBQDORD                                                  
         BO    IORDEM                                                           
         B     INX                                                              
IDEMNDX2 CLI   SBMODE,SBPROCSP                                                  
         BNE   INX                                                              
         SR    R5,R5                                                            
         TM    SBQDATA,SBQDGOAL+SBQDORD                                         
         BZ    *+12                                                             
         LA    R2,8(R2)                                                         
         B     IDEMNDX4                                                         
         CLI   SBEDEMTY,C'P'                                                    
         BE    IBYDEM6                                                          
         LA    R2,8(R2)                                                         
         B     IDEMNDX6                                                         
IDEMNDX4 MVI   GLARGS+2,C'P'                                                    
         TM    SBQDATA,SBQDPUR                                                  
         BO    IBYDEM                                                           
IDEMNDX6 MVI   GLARGS+2,C'R'                                                    
         TM    SBQDATA,SBQDRERT                                                 
         BO    IBYDEM                                                           
         MVI   GLARGS+2,C'A'                                                    
         TM    SBQDATA,SBQDAFFD                                                 
         BO    IBYDEM                                                           
         DC    H'0'                                                             
*                                                                               
*                                  ** BUY DEMO **                               
IBYDEM   L     RE,SBAIO1                                                        
         USING BUYRECD,RE                                                       
         TM    SBEFLAG8,SBE8CNWK   NETWORK=NWK?                                 
         BNZ   IBYDEM0B            YES                                          
***      BZ    IBYDEM0A            NO                                           
***      MVC   BYTE,BUYKAM         A/M                                          
***      NI    BYTE,X'0F'          STRIP AGENCY                                 
***      CLI   BYTE,X'03'          PROCESSING MEDIA N?                          
***      BNE   IBYDEM0A            NO                                           
***      OC    BUYMSTA(2),BUYMSTA  MARKET 0?                                    
***      BNZ   INX                 NO - EXCLUDE                                 
***      B     IBYDEM0B            YES - DEMOS FROM NETWORK BUYS                
*                                                                               
IBYDEM0A OC    BUYMSTA(2),BUYMSTA  MARKET 0?                                    
         BZ    INX                                                              
         DROP  RE                                                               
*                                                                               
IBYDEM0B TM    ININD,INIBON        TEST PROCESSING BONUS DEMOS                  
         BO    INX                 YES-SKIP                                     
         B     IBYDEM2                                                          
*                                  ** BUY BONUS DEMOS **                        
IBYDEMB  TM    ININD,INIBON        TEST PROCESSING BONUS DEMOS                  
         BZ    INX                 NO-SKIP                                      
         B     IBYDEM2                                                          
*                                                                               
IBYDEMN  CLI   GLARGS+1,1          ** NON-ADJUSTED PURCHASED DEMO **            
         BNE   IBYDEM2             ONLY FOR PRIMARY DEMO                        
         CLI   SBEDEMTY,C'P'       CHECK FOR PURCHASED                          
         BNE   INX                                                              
         SR    R5,R5                                                            
         ICM   R5,1,DEMFAC         R5=DEMO FACTOR (0=NO FACTOR)                 
         B     IBYDEM4                                                          
*                                                                               
IBYDEM2  SR    R5,R5               R5=0 - NO DEMO FACTORING                     
*                                                                               
IBYDEM4  CLI   GLARGS+2,0          TEST DEMO TYPE SENSITIVITY                   
         BE    IBYDEM6                                                          
         CLC   SBEDEMTY,GLARGS+2   YES-TEST CORRECT DEMO TYPE                   
         BNE   INX                                                              
*                                                                               
IBYDEM6  CLC   CURBOOK,GLARGS+3    TEST CORRECT BOOK NUMBER                     
         BNE   INX                                                              
         LA    R6,BIN4                                                          
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM                                                         
         MVC   0(4,R2),VAL                                                      
         MVC   4(4,R2),VALWGT                                                   
         TM    GLARGS+(GLIIND-GLARGSD),GLIIWGT  TEST WEIGHTED DEMO              
         BZ    INX                                                              
         MVC   0(4,R2),VALWGT      YES                                          
         B     INX                                                              
*                                                                               
*                                  ** BUY AVERAGE RATING **                     
IBYAR    CLC   SBEDEMTY,GLARGS+2                                                
         BNE   INX                                                              
         XC    0(16,R2),0(R2)                                                   
         LA    R6,BIN4                                                          
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM                                                         
         BNE   INX                                                              
         MVC   0(4,R2),VAL                                                      
         MVC   4(4,R2),VALWGT                                                   
         MVC   11(1,R2),BYSPOTS                                                 
         CLI   SBQMKTWT,C'N'                                                    
         BE    INX                                                              
         MVC   VAL,8(R2)                                                        
         BRAS  RE,WGT                                                           
         MVC   12(4,R2),VALWGT                                                  
         B     INX                                                              
*                                                                               
*                                  ** ORDERED DEMO (LOCK-IN) **                 
IORDEM   LA    R6,BIN4                                                          
         LA    R1,SGLDEM                                                        
         BAS   RE,IGDEM                                                         
         MVC   0(4,R2),VAL                                                      
         MVC   4(4,R2),VALWGT                                                   
         TM    GLARGS+(GLIIND-GLARGSD),GLIIWGT  TEST WEIGHTED DEMO              
         BZ    INX                                                              
         MVC   0(4,R2),VALWGT      YES                                          
         B     INX                                                              
*                                                                               
*                                  ** STATION LOCKIN DEMO **                    
ISLDEM   LA    R6,BIN4                                                          
         CLI   DEMOPT,0            TEST TARGET/SECONDARY DEMOS ONLY             
         BE    *+12                NO                                           
         BAS   RE,CHKDEM           YES - CHECK THIS DEMO FOR TGT/SEC            
         BNE   INX                       NO                                     
         L     RE,SBACURCH                                                      
         LA    RE,SLDEMOS-SSLCHNKD(RE)                                          
         LLC   R1,GLARGS+1         POINT TO CORRECT DEMO VALUE                  
         BCTR  R1,0                                                             
         SLL   R1,3                                                             
         LA    R1,0(R1,RE)                                                      
         MVC   VAL,0(R1)                                                        
         XC    VALWGT,VALWGT                                                    
         CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    ISLDEM2             NO                                           
         LLC   RE,GLARGS+1         YES - TEST THIS DEMO IS RATING               
         BCTR  RE,0                                                             
         MHI   RE,3                                                             
         L     RF,ADEMLST                                                       
         LA    RE,0(RE,RF)                                                      
*                                                                               
         CLI   2(RE),0             COMSCORE DEMO?                               
         BNE   ISLDEM1             NO                                           
         XR    RF,RF               CLEAR RF                                     
         ICM   RF,1,1(RE)          HAVE COMSCORE INDEX?                         
         BZ    ISLDEM2             NO                                           
         BCTR  RF,0                -1                                           
         MHI   RF,8                INDEX INTO COMDLIST                          
         LA    RE,COMDLIST         RE = COMDLIST                                
         AR    RE,RF               PLUS INDEX = DEMO NAME                       
         BCTR  RE,0                -1 SO WE CAN USE NEXT INSTRUCTION            
*                                                                               
ISLDEM1  CLI   1(RE),C'R'                                                       
         BNE   ISLDEM2                                                          
         BRAS  RE,WGT              YES - THEN WEIGHT                            
*                                                                               
ISLDEM2  MVC   0(4,R2),VAL                                                      
         MVC   4(4,R2),VALWGT                                                   
         TM    GLARGS+(GLIIND-GLARGSD),GLIIWGT  TEST WEIGHTED DEMO              
         BZ    INX                                                              
         MVC   0(4,R2),VALWGT      YES                                          
         B     INX                                                              
*                                                                               
*                                  ** GOAL DEMO **                              
IGLDEM   LA    R6,BIN4                                                          
         LA    R1,SGDEM                                                         
         CLI   GLARGS+2,C'X'       WANT LOCK-IN DEMO?                           
         BNE   *+8                 NO                                           
         LA    R1,SGKDEM                                                        
         BAS   RE,IGDEM                                                         
         MVC   0(4,R2),VAL                                                      
         MVC   4(4,R2),VALWGT                                                   
         TM    GLARGS+(GLIIND-GLARGSD),GLIIWGT  TEST WEIGHTED DEMO              
         BZ    INX                                                              
         MVC   0(4,R2),VALWGT      YES                                          
         B     INX                                                              
*                                                                               
*                                  ** BUY CPP **                                
IBYCPP   TM    ININD,INIBON        SKIP IF PROCESSING BONUS SPOTS NOW           
         BO    INX                                                              
         CLC   SBEDEMTY,GLARGS+2   TEST CORRECT DEMO TYPE                       
         BNE   INX                                                              
         CLC   CURBOOK,GLARGS+3                                                 
         BNE   INX                                                              
         L     RE,SBAIO1           A(BUY RECORD)                                
         USING BUYRECD,RE          BUY RECORD DSECT                             
         TM    SBEFLAG8,SBE8CNWK   NETWORK=NWK?                                 
         BZ    IBYCPPA             NO                                           
         MVC   BYTE,BUYKAM         A/M                                          
         NI    BYTE,X'0F'          STRIP AGENCY                                 
         CLI   BYTE,X'03'          PROCESSING MEDIA N?                          
         BNE   IBYCPPA             NO                                           
         OC    BUYMSTA(2),BUYMSTA  MARKET 0?                                    
         BNZ   INX                 NO - EXCLUDE LOCAL LEVEL                     
         B     IBYCPPB                                                          
*                                                                               
IBYCPPA  OC    BUYMSTA(2),BUYMSTA  MARKET 0?                                    
         BZ    INX                 YES - EXCLUDE NETWORK LEVEL                  
         DROP  RE                  DROP BUY RECORD USING                        
*                                                                               
IBYCPPB  LA    R6,BIN8                                                          
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM            GET DEMO VALUES                              
         BNE   INX                 (DEMO MIGHT BE REJECTED)                     
         BRAS  RE,BUYCPP           MOVED FOR ADDRESSABILITY                     
         TM    ININD,INIEQUIV      TEST EQUIVALENCING                           
         BZ    IBYCPP2                                                          
         CLI   SBSPPROF,C'D'       YES - TEST EQUIV DOLLARS OR PTS              
         BNE   *+14                                                             
         MVC   0(4,R2),BYEGROSS                                                 
         B     IBYCPP2                                                          
         MVI   EQUIV,C'Y'                                                       
         BAS   RE,IBDEM                                                         
         MVC   4(4,R2),VAL                                                      
         MVC   8(4,R2),VALWGT                                                   
IBYCPP2  BAS   RE,ROUND                                                         
         B     INX                                                              
*                                  ** NET BUY CPP **                            
INTBYCPP TM    ININD,INIBON        SKIP IF PROCESSING BONUS SPOTS NOW           
         BO    INX                                                              
         CLC   SBEDEMTY,GLARGS+2   TEST CORRECT DEMO TYPE                       
         BNE   INX                                                              
         CLC   CURBOOK,GLARGS+3                                                 
         BNE   INX                                                              
         LA    R6,BIN8                                                          
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM            GET DEMO VALUES                              
         BNE   INX                 (DEMO MIGHT BE REJECTED)                     
         MVC   0(4,R2),BYGROSS     COST                                         
         MVC   4(4,R2),VAL         POINTS                                       
         MVC   8(4,R2),VALWGT      WEIGHTED POINTS                              
         TM    ININD,INIEQUIV      TEST EQUIVALENCING                           
         BZ    INBCPP10                                                         
         CLI   SBSPPROF,C'D'       YES - TEST EQUIV DOLLARS OR PTS              
         BNE   *+14                                                             
         MVC   0(4,R2),BYEGROSS                                                 
         B     INBCPP10                                                         
         MVI   EQUIV,C'Y'                                                       
         BAS   RE,IBDEM                                                         
         MVC   4(4,R2),VAL                                                      
         MVC   8(4,R2),VALWGT                                                   
*                                                                               
INBCPP10 EQU   *                                                                
*                                                                               
         SR    R0,R0                                                            
         L     R1,0(R2)                                                         
         M     R0,=F'85'           BYGROSS (OR BYEGROSS) * .85                  
         SLDA  R0,1                TWICE RESULT IN R0R1                         
         D     R0,=F'100'                                                       
         LTR   R1,R1               SEE IF THE ANSWER IS NEGATIVE                
         BM    *+8                 IF IT IS, WE DON'T NEED TO ADD 1             
         AHI   R1,1                (NOT A LA INSTRUCTION)                       
         SRA   R1,1                DIVIDE BY 2                                  
         ST    R1,0(R2)            ROUNDED ANSWER                               
*                                                                               
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
*                                  ** SQAD CPP **                               
*                                                                               
         USING SCHUNKD,R4          ESTABLISH CHUNK                              
*                                                                               
IBYSCPP  TM    ININD,INIBON        SKIP IF PROCESSING BONUS SPOTS NOW           
         BO    INX                                                              
         CLC   SBEDEMTY,GLARGS+2   TEST CORRECT DEMO TYPE                       
         BNE   INX                                                              
         TM    ININD,INIDPTOT      SKIP IF DAYPART TOTAL                        
         BO    INX                                                              
*                                                                               
         L     R3,AIO1             ESTABLISH BUYRECORD                          
         USING BUYRECD,R3                                                       
*                                                                               
         TM    OPTIND6,OPT6SQAD    REPORT SQAD DATA FOR ALL SPOT LENS?          
         BNZ   IBYSC2              YES                                          
         CLI   SBMED,C'R'          RADIO?                                       
         BE    IBYSC1              YES, CHECK FOR 60 SECOND SPOT                
         CLI   BDSEC,30            SKIP IF NOT A 30 SECOND SPOT                 
         B     *+8                 GO TEST CC                                   
*                                                                               
IBYSC1   CLI   BDSEC,60            SKIP IF NOT A 60 SEC SPOT (RADIO)            
         BNE   INX                                                              
*                                                                               
IBYSC2   LA    RF,SBLOCK           GET ADDRESSABILITY TO SBLOCK                 
         USING SBLOCK,RF                                                        
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,SBSQDOPT       GET OPTION NUMBER                            
         BNZ   *+8                                                              
         LA    RE,1                DEFAULTS TO 1                                
*                                                                               
         CLM   RE,1,GLARGS+3       SKIP IF KYWD FOR WRONG SQD OPT               
         BNE   INX                                                              
*                                                                               
         DROP  RF                                                               
*                                                                               
         LA    R6,BIN8                                                          
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'          NO EQUIVALENCING                             
         BAS   RE,IBDEM            GET DEMO VALUES                              
         BNE   INX                 (DEMO MIGHT BE REJECTED)                     
*                                                                               
*        NEED TO CARRY CPP AS ITSELF AND A COUNTER                              
*                                                                               
         ICM   RF,15,VAL           MULT BY 100 BECAUSE CPP                      
         CLI   GLARGS+2,C'3'       NEW SQAD CPM KEYWORD (4-9)?                  
         BH    *+8                 YES - DO NOT MULTIPLY NUMBER                 
         MHI   RF,100               CARRIED AS WHOLE DOLLARS                    
         STCM  RF,15,0(R2)                                                      
*                                                                               
         LA    RF,10                                                            
         STCM  RF,15,4(R2)         INDICATE 1.0 POINTS                          
*                                                                               
         B     INX                                                              
*                                                                               
*        SQAD CPP WITH WEIGHTED TOTALS                                          
*                                                                               
         USING SCHUNKD,R4          ESTABLISH CHUNK                              
*                                                                               
IBYSCPT  DS    0H                                                               
*                                                                               
         TM    ININD,INIBON        SKIP IF PROCESSING BONUS SPOTS NOW           
         BO    SCPTSQDX                                                         
*                                                                               
*                                  GET PURCHASED RTG PTS FOR DEMO               
*                                                                               
         CLI   SBEDEMTY,C'P'       MUST BE DOING PURCHASED DEMOS                
         BNE   SCPTPCHN                                                         
*                                                                               
         XC    SCPTOUT(SCPTOUTL),SCPTOUT   INIT OUTPUT AREA                     
*                                                                               
         LA    R6,BIN4             BUCKETS ARE 4 BYTE BINARY                    
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'          NO-EQUIVALENCING                             
*                                                                               
         BAS   RE,IBDEM            FIND DEMO                                    
         BNE   SCPTPCHX                                                         
*                                                                               
         MVC   SCPTPCH,VAL         PURCHASED POINTS                             
         MVC   SCPTPCHW,VALWGT     MARKET WEIGHTED PURCHASED POINTS             
*                                                                               
SCPTPCHX DS    0H                                                               
         B     IBYSCPTX                                                         
*                                                                               
SCPTOUT  DS    0D                  OUTPUT AREA                                  
SCPTPCH  DS    XL4                 PURCHASED POINTS                             
SCPTPCHW DS    XL4                 MARKET WEIGHTED PURCHASED POINTS             
SCPTOUTL EQU   *-SCPTOUT           LENGTH OF OUTPUT AREA                        
*                                                                               
SCPTPCHN DS    0H                                                               
*                                                                               
*                                  FIND SQAD CPP                                
*                                                                               
         USING SCHUNKD,R4          ESTABLISH CHUNK                              
*                                                                               
         CLC   SBEDEMTY,GLARGS+2   TEST CORRECT DEMO TYPE                       
         BNE   SCPTSQDX                                                         
*                                                                               
         LA    RF,SBLOCK           GET ADDRESSABILITY TO SBLOCK                 
         USING SBLOCK,RF                                                        
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,SBSQDOPT       GET OPTION NUMBER                            
         BNZ   *+8                                                              
         LA    RE,1                DEFAULTS TO 1                                
*                                                                               
         CLM   RE,1,GLARGS+3       SKIP IF KYWD FOR WRONG SQD OPT               
         BNE   SCPTSQDX                                                         
*                                                                               
         DROP  RF                                                               
*                                                                               
         LA    R6,BIN8                                                          
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'          NO EQUIVALENCING                             
*                                                                               
         BAS   RE,IBDEM            GET SQAD VALUES                              
         BNE   SCPTSQDX            (DEMO MIGHT BE REJECTED)                     
*                                                                               
*        NEED TO CARRY CPP AS POINTS*CPP AND POINTS                             
*                                                                               
*        SINCE SQAD IS 30 SEC BASED CPP WE NEED A FUDGE FACTOR                  
*        IN CASE EQUIVALENCING IS BASED ON 60 OR OTHER SECONDS SECS             
*        FACTOR IS 1000 (THE BASE FACTOR) DIVIDED BY WHATEVER                   
*        30 SEC IS EQUIVALENCED TO.                                             
*                                                                               
         MVC   4(4,R2),SCPTPCH     PURCHASED POINTS                             
         MVC   8(4,R2),SCPTPCHW    MARKET WEIGHTED PURCHASED POINTS             
*                                                                               
         ICM   RF,15,SCPTPCH       GET POINTS                                   
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,3,SBEQTAB+3*4    30 SEC IS FOURTH IN TABLE                    
         CLI   SBMED,C'T'          MEDIA=T?                                     
         BE    *+8                 YES                                          
         ICM   R1,3,SBEQTAB+7*4    60 SEC (FOR RADIO)IS EIGHTH IN TABLE         
*                                                                               
         LHI   RF,1000             REPRESENTS EQUIVALENCE BASE                  
         LHI   RE,2000             SCALE UP FOR ROUNDING & 3 DECIMALS           
         MR    RE,RE                                                            
         DR    RE,R1               CONVERSION FACTOR FROM THIS BASE             
*                                    TO 30 SEC BASE OF SQAD CPP                 
         AHI   RF,1                                                             
         SRL   RF,1                ROUND DOWN (3 DECIMALS)                      
*                                                                               
         ICM   RE,15,SCPTPCH       GET POINTS                                   
*                                                                               
         MR    RE,RE               APPLY FUDGE FACTOR                           
         SLL   RF,1                DOUBLE FOR ROUNDING                          
         LHI   R1,1000             RESULT WAS TO 3 DECIMALS                     
         DR    RE,R1                                                            
         AHI   RF,1                ROUND                                        
         SRL   RF,1                                                             
*                                                                               
         ICM   RE,15,VAL           GET SQAD CPP                                 
*                                                                               
         MR    RE,RE               POINTS TIMES CPP                             
*                                                                               
         MHI   RF,10               CARRIED AS WHOLE DOLLARS                     
*                                                                               
         STCM  RF,15,0(R2)         PSEUDO SQAD DOLLARS                          
*                                                                               
         OC    0(4,R2),0(R2)       IF NO PSEUDO DOLLARS                         
         BNZ   *+16                                                             
         XC    4(4,R2),4(R2)          ZERO POINTS                               
         XC    8(4,R2),8(R2)          ZERO MARKET WEIGHTED POINTS               
*                                                                               
SCPTSQDX DS    0H                                                               
*                                                                               
IBYSCPTX DS    0H                                                               
         B     INX                                                              
*                                                                               
*                                  ** GOAL CPP **                               
IGLCPP   LA    R6,BIN8                                                          
         OC    SBPDEMOS,SBPDEMOS   TEST DEMO MENU OR DEMO OPTION SET            
         BZ    *+12                                                             
         BAS   RE,CHKGLDEM         YES-CHECK THE DEMO IS CORRECT                
         BNE   INX                                                              
         MVC   0(4,R2),SGDOL       COST                                         
         MVC   4(4,R2),SGDEM       RATING                                       
         CLI   GLARGS+3,C'X'       WANT LOCKIN CPP?                             
         BNE   IGLCPPA                                                          
         MVC   0(4,R2),SGKDOL      COST                                         
         MVC   4(4,R2),SGKDEM      RATING                                       
*                                                                               
IGLCPPA  TM    ININD,INIEQUIV      TEST EQUIVALENCING                           
         BZ    IGLCPP2                                                          
         CLI   SBSPPROF,C'D'       YES - TEST EQUIV DOLLARS OR PTS              
         BNE   IGLCPPB                                                          
         MVC   0(4,R2),SGEDOL                                                   
         CLI   GLARGS+3,C'X'       WANT LOCKIN DATA?                            
         BNE   *+10                NO                                           
         MVC   0(4,R2),SGKEDOL                                                  
         B     IGLCPP2                                                          
*                                                                               
IGLCPPB  MVC   4(4,R2),SGEDEM                                                   
         CLI   GLARGS+3,C'X'       WANT LOCKIN DATA?                            
         BNE   *+10                NO                                           
         MVC   4(4,R2),SGKEDEM                                                  
IGLCPP2  DS    0H                                                               
         TM    GLARGS+2,X'01'      NET CPP?                                     
         BZ    IGLCPP4              NO                                          
         SR    R0,R0                                                            
         L     R1,0(R2)                                                         
         M     R0,=F'85'           DOL * .85                                    
         LR    R0,R1                                                            
         SR    R1,R1                                                            
         SRDA  R0,31               TWICE RESULT IN R0R1                         
         D     R0,=F'10000'                                                     
         LTR   R1,R1               SEE IF THE ANSWER IS NEGATIVE                
         BM    *+8                 IF IT IS, WE DON'T NEED TO ADD 1             
         AHI   R1,1                (NOT A LA INSTRUCTION)                       
         SRA   R1,1                DIVIDE BY 2                                  
         SR    R0,R0                                                            
         M     R0,=F'100'                                                       
         ST    R1,0(R2)            ROUNDED ANSWER                               
*                                                                               
IGLCPP4  BAS   RE,ROUND                                                         
         B     MKTWGT              MARKET WEIGHT                                
*                                  ** ORDERED CPP (LOCK-IN) **                  
IORCPP   LA    R6,BIN8                                                          
         OC    SBPDEMOS,SBPDEMOS   TEST DEMO MENU OR DEMO OPTION SET            
         BZ    *+12                                                             
         BAS   RE,CHKGLDEM         YES-CHECK THE DEMO IS CORRECT                
         BNE   INX                                                              
         MVC   0(4,R2),SGLDOL      COST                                         
         MVC   4(4,R2),SGLDEM      RATING                                       
         TM    ININD,INIEQUIV      TEST EQUIVALENCING                           
         BZ    IORCPP2                                                          
         CLI   SBSPPROF,C'D'       YES - TEST EQUIV DOLLARS OR PTS              
         BNE   *+14                                                             
         MVC   0(4,R2),SGLEDOL                                                  
         B     IORCPP2                                                          
         MVC   4(4,R2),SGLEDEM                                                  
IORCPP2  BAS   RE,ROUND                                                         
*                                                                               
MKTWGT   CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    INX                                                              
*                                                                               
         CLI   SBESTDEM+2,0        COMSCORE DEMO?                               
         BNE   MKTWGT10            NO                                           
*                                                                               
         LLC   RE,SBESTDEM+1       RE = INDEX INTO TARGET ESTIMATE              
         BCTR  RE,0                -1 FOR INDEX                                 
         MHI   RE,8                COMSCORE DEMO IN ACOMLSTG                    
*                                                                               
         LA    RF,COMDLIST         RF = COMDLIST                                
         OC    SBPDEMOS,SBPDEMOS   DEMO MENU OR DEMO OPTION SET?                
         BZ    *+12                NO                                           
         ICM   RF,15,ACOMLSTG      YES - HAVE ACOMLSTG?                         
         BZ    INX                 NO - EXIT                                    
         LA    RF,0(RE,RF)         RF = COMSCORE DEMO NAME FROM EST             
         CLI   0(RF),C'R'          COMSCORE RATING?                             
         B     *+8                 GO TEST CC                                   
MKTWGT10 CLI   SBESTDEM+1,C'R'     YES-ONLY FOR RATINGS                         
         BNE   INX                                                              
         MVC   VAL,4(R2)                                                        
         BRAS  RE,WGT                                                           
         MVC   8(4,R2),VALWGT                                                   
         B     INX                                                              
*                                                                               
*                                  ** STATION LOCKIN CPP **                     
ISLCPP   LA    R6,BIN8                                                          
         CLI   DEMOPT,0            TEST TARGET/SECONDARY DEMOS ONLY             
         BE    *+12                                                             
         BAS   RE,CHKDEM           YES-CHECK THIS DEMO FOR TGT/SEC              
         BNE   INX                                                              
         L     R3,SBACURCH                                                      
         MVC   0(4,R2),SLDOL-SSLCHNKD(R3)   DOLLARS                             
         LLC   R1,GLARGS+1                                                      
         BCTR  R1,0                                                             
         SLL   R1,3                                                             
         LA    R1,SLDEMOS-SSLCHNKD(R1,R3)                                       
         MVC   VAL,0(R1)                                                        
         TM    ININD,INIEQUIV      TEST EQUIVALENCING                           
         BZ    ISLCPP2                                                          
         CLI   SBSPPROF,C'D'       YES - TEST EQUIV DOLLARS OR PTS              
         BNE   *+14                                                             
         MVC   0(4,R2),SLEDOL-SSLCHNKD(R3)                                      
         B     ISLCPP2                                                          
         MVC   VAL,4(R1)                                                        
*                                                                               
ISLCPP2  XC    VALWGT,VALWGT                                                    
         CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    ISLCPP4                                                          
         LLC   RE,GLARGS+1         YES - TEST THIS DEMO IS RATING               
         BCTR  RE,0                                                             
         MHI   RE,3                                                             
         L     RF,ADEMLST                                                       
         LA    RE,0(RE,RF)                                                      
*                                                                               
         CLI   2(RE),0             COMSCORE DEMO?                               
         BNE   ISLCPP3             NO                                           
         XR    RF,RF               CLEAR RF                                     
         ICM   RF,1,1(RE)          HAVE COMSCORE INDEX?                         
         BZ    ISLCPP4             NO                                           
         BCTR  RF,0                -1                                           
         MHI   RF,8                INDEX INTO COMDLIST                          
         LA    RE,COMDLIST         RE = COMDLIST                                
         AR    RE,RF               PLUS INDEX = DEMO NAME                       
         BCTR  RE,0                -1 SO WE CAN USE NEXT INSTRUCTION            
*                                                                               
ISLCPP3  CLI   1(RE),C'R'                                                       
         BNE   ISLCPP4                                                          
         BRAS  RE,WGT              YES - THEN WEIGHT                            
*                                                                               
ISLCPP4  MVC   4(4,R2),VAL         DEMO                                         
         MVC   8(4,R2),VALWGT      WEIGHTED DEMO                                
         BAS   RE,ROUND                                                         
         B     INX                                                              
         EJECT                                                                  
* STACKING INPUT ROUTINES                                                       
*                                                                               
         SPACE 1                                                                
ISTDATA  B     EXIT                                                             
         SPACE 1                                                                
         USING DSTACKD,R2                                                       
ISTDOL   XC    0(DSTACKL,R2),0(R2) *** ST$ INPUT ***                            
         TM    OPTIND,OPTIACST                                                  
         BO    ISTDOLX             IGNORE IF ACCOUNTING STACK                   
         CLI   SBMODE,SBPROCGL                                                  
         BNE   ISTDOL4                                                          
         ICM   R1,15,SGDOL                                                      
         BZ    ISTDOL2                                                          
         BAS   RE,DOLSPLIT                                                      
         ST    R0,DSGPEN                                                        
         ST    R1,DSGDOL                                                        
*                                                                               
ISTDOL2  ICM   R1,15,SGLDOL                                                     
         BZ    ISTDOLX                                                          
         BAS   RE,DOLSPLIT                                                      
         ST    R0,DSOPEN                                                        
         ST    R1,DSODOL                                                        
*                                                                               
ISTDOL4  CLI   SBMODE,SBPROCSP                                                  
         BNE   ISTDOL10                                                         
         ICM   R1,15,SCGROSS                                                    
         BZ    ISTDOLX                                                          
         BAS   RE,DOLSPLIT                                                      
         ST    R0,DSBPEN                                                        
         ST    R1,DSBDOL                                                        
*                                                                               
ISTDOL10 CLI   SBMODE,SBPROCSL                                                  
         BNE   ISTDOLX                                                          
         L     R1,SBACURCH                                                      
         ICM   R1,15,SLDOL-SSLCHNKD(R1)                                         
         BZ    ISTDOLX                                                          
         BAS   RE,DOLSPLIT                                                      
         ST    R0,DSSTPEN                                                       
         ST    R1,DSSTDOL                                                       
*                                                                               
ISTDOLX  CLI   INDATA,0                                                         
         BNE   EXIT                                                             
         OC    0(DSTACKL,R2),0(R2)                                              
         BZ    EXIT                                                             
         MVI   INDATA,1                                                         
         B     EXIT                                                             
         SPACE 1                                                                
         USING RSTACKD,R2                                                       
ISTDEM   XC    0(RSTACKL,R2),0(R2) *** STD INPUT ***                            
         TM    OPTIND,OPTIACST                                                  
         BO    ISTDEMX             IGNORE IF ACCOUNTING STACK                   
         CLI   SBMODE,SBPROCGL                                                  
         BNE   ISTDEM4                                                          
         L     R1,SGDOL                                                         
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSGPEN                                                        
         ST    R1,RSGDOL                                                        
*                                                                               
         SR    R0,R0                                                            
         L     R1,SGDOL                                                         
         M     R0,=F'85'           SGDOL * .85                                  
***                                                                             
***  NEXT INSTRUCTUCTION IS BAD FOR LARGE VALUE IN SGDOL!                       
***                                                                             
***         LR    R0,R1                                                         
***         SR    R1,R1                                                         
***         SRDA  R0,31               TWICE RESULT IN R0R1                      
***                                                                             
         SLDA  R0,1                TWICE RESULT IN R0R1                         
         BNO   *+6                                                              
         DCHO                                                                   
         D     R0,=F'10000'                                                     
         LTR   R1,R1               SEE IF THE ANSWER IS NEGATIVE                
         BM    *+8                 IF IT IS, WE DON'T NEED TO ADD 1             
         AHI   R1,1                (NOT A LA INSTRUCTION)                       
         SRA   R1,1                DIVIDE BY 2                                  
         SR    R0,R0                                                            
         M     R0,=F'100'                                                       
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSGNPEN                                                       
         ST    R1,RSGNDOL                                                       
*                                                                               
         LA    R1,SGDEM                                                         
         BAS   RE,IGDEM                                                         
         MVC   RSGDEM(4),VAL                                                    
         MVC   RSGDEM+4(4),VALWGT                                               
         LA    R1,SGLDEM                                                        
         BAS   RE,IGDEM                                                         
         MVC   RSODEM(4),VAL                                                    
         MVC   RSODEM+4(4),VALWGT                                               
         LA    R3,SGDOL                                                         
         MVC   RSGDEMCP,RSGDEM                                                  
         LA    R6,SGLDOL                                                        
         MVC   RSODEMCP,RSODEM                                                  
         TM    ININD,INIEQUIV                                                   
         BZ    ISTDEM2                                                          
         CLI   SBSPPROF,C'D'                                                    
         BNE   *+16                                                             
         LA    R3,SGEDOL                                                        
         LA    R6,SGLEDOL                                                       
         B     ISTDEM2                                                          
         LA    R1,SGEDEM                                                        
         BAS   RE,IGDEM                                                         
         MVC   RSGDEMCP(4),VAL                                                  
         MVC   RSGDEMCP+4(4),VALWGT                                             
         LA    R1,SGLEDEM                                                       
         BAS   RE,IGDEM                                                         
         MVC   RSODEMCP(4),VAL                                                  
         MVC   RSODEMCP+4(4),VALWGT                                             
*                                                                               
ISTDEM2  ICM   R1,15,0(R3)                                                      
         BZ    *+16                                                             
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSGPENCP                                                      
         ST    R1,RSGDOLCP                                                      
         ICM   R1,15,0(R6)                                                      
         BZ    *+16                                                             
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSOPEN                                                        
         ST    R1,RSODOL                                                        
         B     ISTDEMX                                                          
*                                                                               
ISTDEM4  CLI   SBMODE,SBPROCSP                                                  
         BNE   ISTDEM10                                                         
         SR    R5,R5                                                            
         MVI   EQUIV,C'N'                                                       
         BAS   RE,IBDEM                                                         
         CLI   SBEDEMTY,C'P'                                                    
         BNE   *+16                                                             
         MVC   RSPDEM,VAL                                                       
         MVC   RSPDEM+4(4),VALWGT                                               
         CLI   SBEDEMTY,C'R'                                                    
         BNE   *+16                                                             
         MVC   RSRDEM,VAL                                                       
         MVC   RSRDEM+4(4),VALWGT                                               
         CLI   SBEDEMTY,C'A'                                                    
         BNE   *+16                                                             
         MVC   RSADEM,VAL                                                       
         MVC   RSADEM+4(4),VALWGT                                               
         LA    R3,SCGROSS                                                       
         MVC   RSPDEMCP,RSPDEM                                                  
         MVC   RSRDEMCP,RSRDEM                                                  
         MVC   RSADEMCP,RSADEM                                                  
         TM    ININD,INIEQUIV                                                   
         BZ    ISTDEM6                                                          
         CLI   SBSPPROF,C'D'                                                    
         BNE   *+12                                                             
         LA    R3,SCEGROSS                                                      
         B     ISTDEM6                                                          
         SR    R5,R5                                                            
         MVI   EQUIV,C'Y'                                                       
         BAS   RE,IBDEM                                                         
         CLI   SBEDEMTY,C'P'                                                    
         BNE   *+16                                                             
         MVC   RSPDEMCP,VAL                                                     
         MVC   RSPDEMCP+4(4),VALWGT                                             
         CLI   SBEDEMTY,C'R'                                                    
         BNE   *+16                                                             
         MVC   RSRDEMCP,VAL                                                     
         MVC   RSRDEMCP+4(4),VALWGT                                             
         CLI   SBEDEMTY,C'A'                                                    
         BNE   *+16                                                             
         MVC   RSADEMCP,VAL                                                     
         MVC   RSADEMCP+4(4),VALWGT                                             
*                                                                               
ISTDEM6  DS    0H                                                               
         CLC   SCGROSS,0(R3)       EQUIVALENCING?                               
         BE    ISTDEM8              NO                                          
         SR    R0,R0                                                            
         ICM   R1,15,0(R3)         EGROSS                                       
         L     RF,SCNET            NET                                          
         MR    R0,RF               NET*EGROSS                                   
         SLDA  R0,1                2*(NET*EGROSS) (FOR ROUND)                   
         D     R0,SCGROSS          (2*(NET*EGROSS)/GROSS                        
         LTR   R1,R1               NEGATIVE?                                    
         BM    *+8                 IF IT IS, WE DON'T NEED TO ADD 1             
         AHI   R1,1                                                             
         SRA   R1,1                DIVIDE BY 2                                  
         B     *+8                                                              
ISTDEM8  L     R1,SCNET                                                         
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSNCPPEN                                                      
         ST    R1,RSNCPDOL                                                      
*                                                                               
         ICM   R1,15,0(R3)         DOLLARS FOR CPP                              
         BZ    *+16                                                             
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSBPEN                                                        
         ST    R1,RSBDOL                                                        
         L     R1,SCGROSS          GROSS DOLLARS                                
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSGRSPEN                                                      
         ST    R1,RSGRSDOL                                                      
         L     R1,SCNET            NET DOLLARS                                  
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSNETPEN                                                      
         ST    R1,RSNETDOL                                                      
         MVC   RSSPOTS,SCSPOTS     SPOTS                                        
         MVC   RSTAX,SCTAX                                                      
         MVC   RSPWGRS,SCPWGRS                                                  
         B     ISTDEMX                                                          
*                                                                               
ISTDEM10 CLI   SBMODE,SBPROCPW                                                  
         BNE   ISTDEM20                                                         
         CLI   0(R4),X'15'         WEEKLY $ ELEM?                               
         BNE   ISTDEMX                                                          
         MVC   RSPWGRS,4(R4)                                                    
         B     ISTDEMX                                                          
*                                                                               
ISTDEM20 CLI   SBMODE,SBPROCSL                                                  
         BNE   ISTDEMX                                                          
         L     R1,SBACURCH                                                      
         ICM   R1,15,SLDOL-SSLCHNKD(R1)                                         
         BZ    ISTDEMX                                                          
         BAS   RE,DOLSPLIT                                                      
         ST    R0,RSSTPEN                                                       
         ST    R1,RSSTDOL                                                       
*                                                                               
ISTDEMX  CLI   INDATA,0                                                         
         BNE   EXIT                                                             
         OC    0(RSTACKL,R2),0(R2)                                              
         BZ    EXIT                                                             
         MVI   INDATA,1                                                         
         B     EXIT                                                             
         SPACE 1                                                                
         USING BSTACKD,R2                                                       
ISTBDEM  CLC   SBEDEMTY,GLARGS+2   TEST CORRECT DEMO TYPE                       
         BNE   ISTBDEMX                                                         
         LLC   R3,GLARGS+1                                                      
         BCTR  R3,0                                                             
         MHI   R3,3                                                             
         LA    R1,SBPDEMOS                                                      
         LA    R3,0(R1,R3)         R3=A(DEMO CATEGORY)                          
         CLI   DEMOPT,0            TEST TARGET/SECONDARY DEMOS ONLY             
         BE    *+12                                                             
         BAS   RE,CHKDEM           YES-CHECK THIS DEMO FOR TARGET/SEC           
         BNE   ISTBDEMX            REJECTED                                     
         MVI   HALF,0                                                           
         XC    RTG,RTG                                                          
         XC    IMP,IMP                                                          
         LA    RE,SCDEMOS                                                       
         LLC   R1,GLARGS+1                                                      
         BCTR  R1,0                                                             
         SLL   R1,3                                                             
         LA    R1,0(R1,RE)         R1=A(DEMO VALUE)                             
         MVC   VAL,0(R1)                                                        
         CLI   1(R3),C'R'          TEST IT'S A RATING                           
         BE    *+12                                                             
         CLI   1(R3),C'E'                                                       
         BNE   ISTBD2                                                           
         MVC   RTG,0(R1)           YES                                          
         MVC   BSRTG(4),VAL                                                     
         TM    OPTIND2,OPTISTI     TEST NEED IMPS ALSO                          
         BZ    *+8                                                              
         MVI   HALF,C'I'           YES                                          
         CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    ISTBD4                                                           
         BRAS  RE,WGT              YES-THEN WEIGHT                              
         MVC   BSRTG+4(4),VALWGT                                                
         B     ISTBD4                                                           
*                                                                               
ISTBD2   CLI   1(R3),C'I'          TEST FOR IMPS                                
         BNE   ISTBDEMX                                                         
         MVC   IMP,0(R1)           YES                                          
         MVC   BSIMP,0(R1)                                                      
         TM    OPTIND,OPTISTR      TEST NEED RATING ALSO                        
         BZ    ISTBD4                                                           
         MVI   HALF,C'R'           YES                                          
*                                                                               
ISTBD4   CLI   HALF,0              TEST IF NEED ANOTHER DEMO                    
         BE    ISTBD10                                                          
         MVC   HALF+1(1),2(R3)                                                  
         LA    R1,SBPDEMOS         YES-LOOK FOR IT                              
         LA    R0,L'SBPDEMOS/3                                                  
         LA    RE,SCDEMOS                                                       
*                                                                               
ISTBD6   OC    0(3,R1),0(R1)                                                    
         BZ    ISTBD10                                                          
         CLC   HALF,1(R1)                                                       
         BE    ISTBD8                                                           
         LA    R1,3(R1)                                                         
         LA    RE,8(RE)                                                         
         BCT   R0,ISTBD6                                                        
         B     ISTBD10                                                          
*                                                                               
ISTBD8   MVC   VAL,0(RE)           FOUND-                                       
         CLI   HALF,C'I'                                                        
         BNE   *+20                                                             
         MVC   IMP,0(RE)                                                        
         MVC   BSIMP,VAL                                                        
         B     ISTBD10                                                          
         MVC   RTG,0(RE)                                                        
         MVC   BSRTG(4),VAL                                                     
         CLI   SBQMKTWT,C'N'                                                    
         BE    ISTBD10                                                          
         BRAS  RE,WGT                                                           
         MVC   BSRTG+4(4),VALWGT                                                
*                                                                               
ISTBD10  LA    R5,BYGROSS                                                       
         MVC   BSRTGCP,BSRTG       SET RATING AND IMPS FOR CPP                  
         MVC   BSIMPCP,BSIMP                                                    
         TM    ININD,INIEQUIV      TEST NEED TO EQUIVALENCE                     
         BZ    ISTBD12                                                          
         CLI   SBSPPROF,C'D'       YES-TEST EQUIVALENVE DOLLARS                 
         BNE   *+12                                                             
         LA    R5,BYEGROSS         YES                                          
         B     ISTBD12                                                          
         MVC   BSIMPCP,IMP+4       NO-THEN USE EQUIVALENCED DEMOS               
         MVC   BSRTGCP,RTG+4                                                    
         CLI   SBQMKTWT,C'N'                                                    
         BE    ISTBD12                                                          
         MVC   VAL,RTG+4                                                        
         BRAS  RE,WGT                                                           
         MVC   BSRTGCP+4(4),VALWGT                                              
*                                                                               
ISTBD12  DS    0H                                                               
         CLC   BYGROSS,0(R5)       EQUIVALENCING?                               
         BE    ISTBD14              NO                                          
         MVC   FULL,BYGROSS                                                     
         SR    R0,R0                                                            
         ICM   R1,15,0(R5)         EGROSS                                       
         L     RF,SCNET            NET                                          
         MR    R0,RF               NET*EGROSS                                   
         SLDA  R0,1                2*(NET*EGROSS) (FOR ROUND)                   
         D     R0,FULL             (2*(NET*EGROSS)/GROSS                        
         LTR   R1,R1               NEGATIVE?                                    
         BM    *+8                 IF IT IS, WE DON'T NEED TO ADD 1             
         AHI   R1,1                                                             
         SRA   R1,1                DIVIDE BY 2                                  
         B     *+8                                                              
ISTBD14  L     R1,SCNET                                                         
         BAS   RE,DOLSPLIT                                                      
         ST    R0,BSNCPPEN                                                      
         ST    R1,BSNCPDOL                                                      
*                                                                               
         ICM   R1,15,0(R5)         DOLLARS FOR CPP                              
         BZ    *+16                                                             
         BAS   RE,DOLSPLIT                                                      
         ST    R0,BSPEN                                                         
         ST    R1,BSDOL                                                         
         ICM   R1,15,BYGROSS       GROSS DOLLARS                                
         BAS   RE,DOLSPLIT                                                      
         ST    R0,BSGRSPEN                                                      
         ST    R1,BSGRSDOL                                                      
         L     R1,SCNET            NET DOLLARS                                  
         BAS   RE,DOLSPLIT                                                      
         ST    R0,BSNETPEN                                                      
         ST    R1,BSNETDOL                                                      
         MVC   BSSPOTS+3(1),BYSPOTS      SPOTS                                  
*                                                                               
ISTBDEMX OC    0(BSTACKL,R2),0(R2)                                              
         BZ    EXIT                                                             
         MVI   INDATA,1                                                         
         B     EXIT                                                             
         SPACE 1                                                                
         USING ASTACKD,R2                                                       
ISTACC   XC    0(ASTACKL,R2),0(R2) * STG/STN/STT/STG-/STN-/STC INPUT *          
         TM    OPTIND,OPTIACST                                                  
         BZ    ISTACCX             IGNORE IF NOT ACCOUNTING STACK               
         CLI   SBMODE,SBPROCSP                                                  
         BNE   ISTACC10                                                         
         CLI   GLARGS+1,C'G'       GROSS BUY DOLLARS                            
         BNE   ISTACC2                                                          
         L     R3,SCGROSS          ORDERED                                      
         L     R5,SCPAY            PAID                                         
         L     R6,SCUNP            UNPAID                                       
         B     ISTACC8                                                          
*                                                                               
ISTACC2  CLI   GLARGS+1,C'N'       NET BUY DOLLARS                              
         BNE   ISTACC4                                                          
         L     R3,SCNET            ORDERED                                      
         L     R5,SCPAYN           PAID                                         
         L     R6,SCUNPN           UNPAID                                       
         B     ISTACC8                                                          
*                                                                               
ISTACC4  CLI   GLARGS+1,C'T'       BUY TAX DOLLARS                              
         BNE   ISTACC5                                                          
         L     R3,SCTAX            ORDERED                                      
         L     R5,SCPAYTX          PAID                                         
         L     R6,SCUNPTX          UNPAID                                       
         B     ISTACC8                                                          
*                                                                               
ISTACC5  CLI   GLARGS+1,C'M'       GROSS BUY DOLLARS MINUS TAX                  
         BNE   ISTACC6                                                          
         L     R3,SCGROSS          ORDERED                                      
         S     R3,SCTAX                                                         
         L     R5,SCPAY            PAID                                         
         S     R5,SCPAYTX                                                       
         L     R6,SCUNP            UNPAID                                       
         S     R6,SCUNPTX                                                       
         B     ISTACC8                                                          
*                                                                               
ISTACC6  CLI   GLARGS+1,C'E'       NET BUY DOLLARS MINUS TAX                    
         BNE   ISTACC7                                                          
         L     R3,SCNET            NET                                          
         S     R3,SCTAX                                                         
         L     R5,SCPAYN           NET PAID                                     
         S     R5,SCPAYTX                                                       
         L     R6,SCUNPN           NET UNPAID                                   
         S     R6,SCUNPTX                                                       
         B     ISTACC8                                                          
*                                                                               
ISTACC7  CLI   GLARGS+1,C'C'       GROSS MINUS NET                              
         BNE   ISTACCX                                                          
         L     R3,SCCOM            ORDERED=COMMISSION                           
         L     R5,SCPAY                                                         
         S     R5,SCPAYN           PAID                                         
         L     R6,SCUNP                                                         
         S     R6,SCUNPN           UNPAID                                       
*                                                                               
ISTACC8  LR    R1,R3               ORDERED                                      
         BAS   RE,DOLSPLIT                                                      
         ST    R0,ASOPEN                                                        
         ST    R1,ASODOL                                                        
         LR    R1,R5               PAID                                         
         BAS   RE,DOLSPLIT                                                      
         ST    R0,ASPPEN                                                        
         ST    R1,ASPDOL                                                        
         LR    R1,R6               UNPAID                                       
         BAS   RE,DOLSPLIT                                                      
         ST    R0,ASUPEN                                                        
         ST    R1,ASUDOL                                                        
         B     ISTACCX                                                          
*                                                                               
ISTACC10 CLI   SBMODE,SBPROCBL                                                  
         BNE   ISTACCX                                                          
         LR    R6,R4                                                            
         USING STABELEM,R6                                                      
         L     R1,SBBILGRS         GROSS BILLED                                 
         CLI   GLARGS+1,C'G'                                                    
         BE    ISTACC14                                                         
         L     R1,SBBILNET         NET BILLED                                   
         CLI   GLARGS+1,C'N'                                                    
         BE    ISTACC14                                                         
         CLI   GLARGS+1,C'C'       GROSS MINUS NET BILLED                       
         BNE   ISTACC11                                                         
         L     RF,SBBILGRS                                                      
         SR    RF,R1                                                            
         LR    R1,RF                                                            
         B     ISTACC14                                                         
*                                                                               
ISTACC11 L     R1,SBBILTAX         BILLED TAX                                   
         CLI   GLARGS+1,C'T'                                                    
         BE    ISTACC14                                                         
         CLI   GLARGS+1,C'M'                                                    
         BNE   ISTACC12                                                         
         LR    RF,R1               BILLED MINUS TAX                             
         L     R1,SBBILGRS                                                      
         SR    R1,RF                                                            
         B     ISTACC14                                                         
*                                                                               
ISTACC12 CLI   GLARGS+1,C'E'                                                    
         BNE   ISTACCX                                                          
         LR    RF,R1               NET BILLED MINUS TAX                         
         L     R1,SBBILNET                                                      
         SR    R1,RF                                                            
*                                                                               
ISTACC14 BAS   RE,DOLSPLIT                                                      
         ST    R0,ASBPEN                                                        
         ST    R1,ASBDOL                                                        
         DROP  R6                                                               
*                                                                               
ISTACCX  CLI   INDATA,0                                                         
         BNE   EXIT                                                             
         OC    0(ASTACKL,R2),0(R2)                                              
         BZ    EXIT                                                             
         MVI   INDATA,1                                                         
         B     EXIT                                                             
         EJECT                                                                  
*                                                                               
* MISCELLANEOUS INPUT ROUTINES                                                  
*                                                                               
         SPACE 1                                                                
IGDEM    ST    RE,SVRE             ** GENERAL GOAL DEMO INPUT RTN **            
         XC    VAL,VAL                                                          
         XC    VALWGT,VALWGT                                                    
         OC    SBPDEMOS,SBPDEMOS   TEST DEMO MENU OR DEMO OPTION SET            
         BZ    *+12                                                             
         BAS   RE,CHKGLDEM         YES-CHECK THE DEMO IS CORRECT                
         BNE   IGDEMX                                                           
         MVC   VAL,0(R1)                                                        
         CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    IGDEMX                                                           
*                                                                               
         CLI   SBESTDEM+2,0        COMSCORE DEMO?                               
         BNE   IGDEM10             NO                                           
*                                                                               
         LLC   RE,SBESTDEM+1       RE = INDEX INTO TARGET ESTIMATE              
         BCTR  RE,0                -1 FOR INDEX                                 
         MHI   RE,8                COMSCORE DEMO IN ACOMLSTG                    
*                                                                               
         LA    RF,COMDLIST         RF = COMDLIST                                
         OC    SBPDEMOS,SBPDEMOS   DEMO MENU OR DEMO OPTION SET?                
         BZ    *+12                NO                                           
         ICM   RF,15,ACOMLSTG      YES - HAVE ACOMLSTG?                         
         BZ    IGDEMX              NO - EXIT                                    
         LA    RF,0(RE,RF)         RF = COMSCORE DEMO NAME FROM EST             
         CLI   0(RF),C'R'          COMSCORE RATING?                             
         B     *+8                 GO TEST CC                                   
IGDEM10  CLI   SBESTDEM+1,C'R'     YES-ONLY FOR RATINGS                         
         BNE   IGDEMX                                                           
         BRAS  RE,WGT                                                           
IGDEMX   L     RE,SVRE                                                          
         BR    RE                                                               
         SPACE 1                                                                
*                                  ** GENERAL BUY DEMO INPUT RTN **             
IBDEM    ST    RE,SVRE             INPUT  : R5=FACTOR FOR DEMO ADJUST           
         XC    VAL,VAL                      EQUIV=Y FOR EQUIVALENCING           
         XC    VALWGT,VALWGT                                                    
         CLI   DEMOPT,0            TEST TARGET/SECONDARY DEMOS ONLY             
         BE    *+12                NO                                           
         BAS   RE,CHKDEM           YES - CHECK THIS DEMO FOR TGT/SEC            
         BNE   IBDEMN                    NO                                     
         LA    RE,SCDEMOS          RE=A(DEMO VALUES)                            
         L     RF,ADEMLST          RF=A(DEMO LIST)                              
         CLI   GLARGS+4,0          TEST FOR NON-STANDARD DEMO MODIFIER          
         BE    IBDEM4                                                           
         LLC   R0,SBENDEM          YES-GET ADDRESS OF DEMO VALUES FOR           
         MVC   HALF,=C'SX'             THIS MODIFIER                            
         CLI   GLARGS+4,C'S'                                                    
         BE    IBDEM2                                                           
         MVC   HALF,=C'PQ'                                                      
         CLI   GLARGS+4,C'P'                                                    
         BE    IBDEM2                                                           
         DC    H'0'                                                             
*                                                                               
IBDEM2   CLC   1(1,RF),HALF                                                     
         BE    IBDEM4                                                           
         CLC   1(1,RF),HALF+1                                                   
         BE    IBDEM4                                                           
         LA    RE,8(RE)                                                         
         LA    RF,3(RF)                                                         
         BCT   R0,IBDEM2                                                        
         B     IBDEMN                                                           
*                                                                               
IBDEM4   LLC   R1,GLARGS+1         POINT TO CORRECT DEMO VALUE                  
         BCTR  R1,0                                                             
         SLL   R1,3                                                             
         LA    R1,0(R1,RE)                                                      
         MVC   VAL,0(R1)                                                        
         CLI   EQUIV,C'Y'                                                       
         BNE   *+10                                                             
         MVC   VAL,4(R1)                                                        
         LTR   R5,R5               TEST ADJUST PURCHASED DEMO                   
         BZ    IBDEM6                                                           
         L     RF,0(R1)            YES                                          
         M     RE,=F'200'                                                       
         DR    RE,R5                                                            
*         LA    RF,1(RF)                                                        
         AHI   RF,1                NOT AN LA!!!                                 
         SRA   RF,1                                                             
         ST    RF,VAL                                                           
         L     RF,ADEMLST                                                       
*                                                                               
IBDEM6   CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    IBDEMY                                                           
         LLC   RE,GLARGS+1         YES - TEST THIS DEMO IS RATING               
         BCTR  RE,0                                                             
         MHI   RE,3                                                             
         LA    RE,0(RE,RF)                                                      
*                                                                               
         CLI   2(RE),0             COMSCORE DEMO?                               
         BNE   IBDEM6A             NO                                           
         XR    RF,RF               CLEAR RF                                     
         ICM   RF,1,1(RE)          HAVE COMSCORE INDEX?                         
         BZ    IBDEMY              NO                                           
         BCTR  RF,0                -1                                           
         MHI   RF,8                INDEX INTO COMDLIST                          
         LA    RE,COMDLIST         RE = COMDLIST                                
         AR    RE,RF               PLUS INDEX = DEMO NAME                       
         BCTR  RE,0                -1 SO WE CAN USE NEXT INSTRUCTIONS           
*                                                                               
IBDEM6A  CLI   1(RE),C'E'                                                       
         BE    *+12                                                             
         CLI   1(RE),C'R'                                                       
         BNE   IBDEMY                                                           
         BRAS  RE,WGT              YES - THEN WEIGHT                            
         B     IBDEMY                                                           
*                                                                               
IBDEMN   LTR   RB,RB               CC NE - DEMO REJECTED                        
         B     IBDEMX                                                           
IBDEMY   CR    RB,RB               CC EQ - NORMAL RETURN                        
IBDEMX   L     RE,SVRE                                                          
         BR    RE                                                               
*                                  ** ROUNDING ROUTINE **                       
ROUND    TM    COLIND,COLIRND      TEST ROUNDING REQUIRED                       
         BZR   RE                                                               
         L     R0,0(R2)            YES                                          
         SRDA  R0,31                                                            
         D     R0,=F'100'                                                       
         LTR   R1,R1                                                            
         BM    *+8                                                              
         AHI   R1,1                                                             
         SRA   R1,1                                                             
         ST    R1,0(R2)                                                         
         BR    RE                                                               
         SPACE 1                                                                
*                                  ** SPLIT INTO DOLLARS & PENNIES **           
DOLSPLIT LR    R0,R1                                                            
         SRDA  R0,32                                                            
         D     R0,=F'100'                                                       
         BR    RE                                                               
*                                  ** CHECK DEMO IS TARGET/SECONDARY **         
CHKDEM   LR    R0,RE                                                            
         LLC   RE,GLARGS+1         FIND THIS COLUMN'S DEMO                      
         BCTR  RE,0                                                             
         MHI   RE,3                                                             
         L     R1,ADEMLST                                                       
         LA    RE,0(RE,R1)                                                      
         LA    R1,SBESTDEM         TARGET DEMO                                  
         CLI   DEMOPT,DEMOTGT      TEST TARGET DEMOS ONLY WANTED                
         BE    *+8                 YES                                          
         LA    R1,3(R1)            NO - THEN SECONDARY DEMOS ONLY               
         CLC   0(3,R1),0(RE)       COMPARE DEMOS                                
         BE    CHKDEMEQ                                                         
         B     CHKDEMNE                                                         
*                                                                               
CHKGLDEM LR    R0,RE               SAVE OFF RE                                  
*                                                                               
         BRAS  RE,CKGLDEM          ROUTINE MOVED FOR ADDRESSABILITY             
         BE    CHKDEMEQ            IF CC EQU EXECUTE CHKDEMEQ                   
*                                                                               
CHKDEMNE BAS   RE,CHKDEMLV                                                      
         MVI   0(RF),C'N'                                                       
         LTR   RE,R0                                                            
         BR    RE                                                               
*                                                                               
CHKDEMEQ BAS   RE,CHKDEMLV                                                      
         MVI   0(RF),C'Y'                                                       
         LR    RE,R0                                                            
         CR    RE,RE                                                            
         BR    RE                                                               
*                                                                               
CHKDEMLV LLC   RF,INLEVEL                                                       
         A     RF,ALVLSWS                                                       
         BCTR  RF,0                                                             
         BR    RE                                                               
         EJECT                                                                  
* INPUT ROUTINES FOR CLEARANCE STATUS COLUMNS                                   
*                                                                               
         DROP  R5                                                               
         USING CLSTEL01,R5                                                      
ICLAMT   LA    R6,BIN4             CLEARANCE AMOUNT                             
         MVC   0(4,R2),CLSTNET                                                  
         BAS   RE,ROUND                                                         
         B     INX                                                              
         EJECT                                                                  
* INPUT ROUTINES FOR BILLING COLUMNS                                            
*                                                                               
         DROP  R5                                                               
         USING STABELEM,R5                                                      
ISPTBILL LA    R6,BIN4             BILLED SPOTS                                 
         ICM   R1,12,STABSPTS                                                   
         SRA   R1,16                                                            
         ST    R1,0(R2)                                                         
         B     ISPT2                                                            
*                                                                               
ISPTBLBL LA    R6,BIN4             BILLABLE SPOTS                               
         XC    0(8,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   *+18                                                             
         MVC   0(4,R2),SCSPOTS                                                  
         BAS   RE,ROUND                                                         
         B     ISPT2                                                            
         CLI   SBMODE,SBPROCBL                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
***         XC    8(2,R2),8(R2)                                                 
***         MVC   10(2,R2),STABSPTS                                             
         LH    R1,STABSPTS                                                      
         ST    R1,8(R2)                                                         
         LA    R2,8(R2)                                                         
         B     ISPT2                                                            
*                                                                               
IBILL    LA    R6,BIN4             GROSS BILLED                                 
         CLI   GLARGS+2,X'01'      IF CLT$BILL, ONLY PICK UP CUR=X'01'          
         BNE   *+12                                                             
         CLI   SBMODE,SBPROCB1                                                  
         BNE   INX                                                              
*                                                                               
         CLI   GLARGS+2,X'02'      WANT BILL COST2?                             
         BNE   IBILL05             NO                                           
         TM    SBEFLAG7,SBE7COS2   YES - IS THIS COST2?                         
         BZ    INX                 NO - EXIT                                    
         B     IBILL10             YES - PROCESS THIS RECORD                    
*                                                                               
IBILL05  TM    SBEFLAG7,SBE7COS2   IS THIS COST2?                               
         BNZ   INX                 YES - EXIT                                   
*                                                                               
IBILL10  MVC   0(4,R2),SBBILGRS                                                 
         L     R1,BILLGST                                                       
         L     RF,BILLPST                                                       
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILLCST LA    R6,BIN4             BILLED COST                                  
         MVC   0(4,R2),BILLCOST                                                 
         CLI   GLARGS+2,C'T'       PROGRAM EXCHANGE?                            
         BNE   *+10                NO                                           
         MVC   0(4,R2),XBILLCST    YES - PROGRAM EXCHANGE BILLED COST           
         L     R1,BILLGST                                                       
         L     RF,BILLPST                                                       
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILLNET LA    R6,BIN4             NET BILLED                                   
         CLI   GLARGS,C'S'         STATION BUCKET?                              
         BNE   IBILLN05            NO                                           
         CLI   GLARGS+2,X'02'      WANT BILL COST2?                             
         BNE   IBILLN00            NO                                           
         TM    SBEFLAG7,SBE7COS2   YES - IS THIS COST2?                         
         BZ    INX                 NO - EXIT                                    
         B     IBILLN01            YES - PROCESS THIS RECORD                    
*                                                                               
IBILLN00 TM    SBEFLAG7,SBE7COS2   IS THIS COST2?                               
         BNZ   INX                 YES - EXIT                                   
*                                                                               
IBILLN01 CLI   GLARGS+2,C'T'       REPORTING TRADE BILLING?                     
         BNE   IBILLN05            NO                                           
         LR    R1,R9               R9 = SYSD                                    
         AHI   R1,4096             GET ADDRESSABILITY TO END OF SBLOCK          
         USING SYSD+4096,R1        USING FOR END OF SBLOCK                      
         MVC   0(4,R2),SBPXBILN    PROGRAM EXCHANGE NET VALUE                   
         B     IBILLN10            INPUT VALUE SET                              
         DROP  R1                                                               
*                                                                               
IBILLN05 MVC   0(4,R2),SBBILNET                                                 
*                                                                               
IBILLN10 L     R1,BILLGST                                                       
         L     RF,BILLPST                                                       
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
         DROP  R5                                                               
*                                                                               
IBILLTAX LA    R6,BIN4             BILLED TAX                                   
         MVC   0(4,R2),SBBILTAX                                                 
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILLM   LA    R6,BIN4             BILLED MINUS TAX                             
         L     R1,SBBILGRS                                                      
         S     R1,SBBILTAX                                                      
         ST    R1,0(R2)                                                         
         L     R1,BILLGST                                                       
         L     RF,BILLPST                                                       
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILLCOM BRAS  RE,IBILCOMM         BILLED COMMISSION                            
         BNE   *+8                 CC NEQ - DON'T ROUND JUST EXIT               
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IGSTB    LA    R6,BIN4             BILLED GST                                   
         L     RF,BILLGST                                                       
         ST    RF,0(R2)                                                         
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILNVDT DS    0H                  STATION BILLING INVOICE DATA                 
         BRAS  RE,ISTABINV         GET DATA                                     
         B     INX                                                              
*                                                                               
IBILBL   LA    R6,BIN4             GROSS BILLABLE                               
         XC    0(8,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   IBILBL2                                                          
         MVC   0(4,R2),SCGROSS                                                  
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
IBILBL2  CLI   SBMODE,SBPROCBL                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R2,4(R2)                                                         
         MVC   0(4,R2),SBBILGRS                                                 
         L     R1,BILLGST                                                       
         L     RF,BILLPST                                                       
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILBLTX LA    R6,BIN4             BILLABLE TAX                                 
         XC    0(8,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   *+18                                                             
         MVC   0(4,R2),SCTAX                                                    
         BAS   RE,ROUND                                                         
         B     INX                                                              
         CLI   SBMODE,SBPROCBL                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R2,4(R2)                                                         
         MVC   0(4,R2),SBBILTAX                                                 
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILBLM  LA    R6,BIN4             BILLABLE MINUS TAX                           
         XC    0(8,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   IBILBLM2                                                         
         L     RE,SCGROSS                                                       
         S     RE,SCTAX                                                         
         ST    RE,0(R2)                                                         
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         BAS   RE,ROUND                                                         
         B     INX                                                              
IBILBLM2 CLI   SBMODE,SBPROCBL                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R1,SBBILGRS                                                      
         S     R1,SBBILTAX                                                      
         ST    R1,4(R2)                                                         
         LA    R2,4(R2)                                                         
         L     R1,BILLGST                                                       
         L     RF,BILLPST                                                       
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILBLC  LA    R6,BIN4             BILLABLE COST                                
         XC    0(8,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   IBILBLC2                                                         
         MVC   0(4,R2),SCEFFCST                                                 
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
IBILBLC2 CLI   SBMODE,SBPROCBL                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   4(4,R2),BILLCOST                                                 
         LA    R2,4(R2)                                                         
         L     R1,BILLGST                                                       
         L     RF,BILLPST                                                       
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILBLNT LA    R6,BIN4             NET BILLABLE                                 
         XC    0(8,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   IBILBLN2                                                         
         MVC   0(4,R2),SCNET                                                    
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BRAS  RE,BILPCT                                                        
         BAS   RE,ROUND                                                         
         B     INX                                                              
IBILBLN2 CLI   SBMODE,SBPROCBL                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   4(4,R2),SBBILNET                                                 
         LA    R2,4(R2)                                                         
         L     R1,BILLGST                                                       
         L     RF,BILLPST                                                       
         BRAS  RE,GSTPSTO                                                       
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IBILBLCM LA    R6,BIN4             BILLABLE COMMISSION                          
         XC    0(8,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   *+18                                                             
         MVC   0(4,R2),SCCOM                                                    
         BAS   RE,ROUND                                                         
         B     INX                                                              
         CLI   SBMODE,SBPROCBL                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     RE,SBBILGRS         COMMISSION = GROSS - NET                     
         S     RE,SBBILNET                                                      
         ST    RE,4(R2)                                                         
         LA    R2,4(R2)                                                         
         BAS   RE,ROUND                                                         
         B     INX                                                              
*                                                                               
IGSTL    LA    R6,BIN4             BILLABLE GST                                 
         XC    0(8,R2),0(R2)                                                    
         CLI   SBMODE,SBPROCSP                                                  
         BNE   IGSTL2                                                           
         MVC   0(4,R2),SCGSTO                                                   
         BAS   RE,ROUND                                                         
         B     INX                                                              
IGSTL2   CLI   SBMODE,SBPROCBL                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         L     RF,BILLGST                                                       
         ST    RF,4(R2)                                                         
         LA    R2,4(R2)                                                         
         BAS   RE,ROUND                                                         
         B     INX                                                              
         EJECT                                                                  
*                                                                               
* INPUT ROUTINE EXIT FOR COLUMNS                                                
INX      LTR   R6,R6              TEST THIS IS A COLUMN                         
         BZ    EXIT                                                             
         CLI   INDATA,0           YES-IF THERE'S NO COLUMN DATA YET,            
         BNE   EXIT                                                             
         TM    DRINDS,GLPALDET    TEST PRINT ALL DETAILS                        
         BO    INX2                                                             
         LLC   RE,0(R6)           OR, TEST ANY DATA IN THIS COL                 
         EX    RE,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R2),1(R6)                                                    
         BE    *+8                                                              
INX2     MVI   INDATA,1           YES-MAKE SURE SORT RECORD'S PASSED            
         B     EXIT                   TO DRIVER'S SORT                          
         EJECT                                                                  
* COLUMN OUTPUT ROUTINES                                                        
*                                                                               
ODUMMY   MVI   0(R3),C' '          ** DUMMY **                                  
         B     EXIT                                                             
         SPACE 1                                                                
*                                  ** SPOTS **                                  
OSPT     TM    GLARGS+(GLOIND-GLARGSD),GLOIWGT  TEST COLUMN IS WEIGHTED         
         BZ    OSPT2                                                            
         CLI   GLHOOK,GLINCOMP     YES-TEST INTERNAL COMPUTE TIME               
         BNE   OSPT2               NO-JUST FORMAT                               
         BAS   RE,WGTCOL           GET WEIGHTED SPOTS                           
         B     EXIT                                                             
*                                  NOT WEIGHTED-                                
OSPT2    CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE TIME                   
         BE    EXIT                YES-NOT YET                                  
         L     R1,GLADTENT                                                      
         USING DROD,R1                                                          
         TM    DROFORM,X'01'       TEST SPOTS ARE CUMED                         
         BZ    *+12                                                             
         MVI   GLHOOK,GLEDIT       YES-LET DRIVER EDIT                          
         B     EXIT                                                             
         DROP  R1                                                               
         LR    R1,R2               FORMAT THE SPOTS                             
         BRAS  RE,OSPTFMT                                                       
******** CLI   SBQMKTWT,C'N'       TEST TO UNWEIGHT                             
******** BE    EXIT                                                             
******** TM    OUTIND,OUTICRMK     YES - TEST ACROSS MARKETS                    
******** BZ    EXIT                                                             
******** OC    4(4,R2),4(R2)       YES - TEST SPOTS ARE WEIGHTED                
******** BZ    EXIT                                                             
******** LR    R5,R2               YES - UNWEIGHT FOR POSSIBLE FUTURE           
******** BAS   RE,UNWEIGHT               POINTS PER SPOT CALCULATION            
         B     EXIT                                                             
*                                                                               
OSPTBLBL L     RE,0(R2)            ** BILLABLE SPOTS **                         
         L     RF,8(R2)                                                         
         SR    RE,RF               SPOTS - BILLED SPOTS                         
         BZ    *+8                                                              
         NI    COLIND2,255-COLIBLB0  NON-ZERO BILLABLE COLUMN                   
         ST    RE,0(R2)                                                         
         LR    R1,R2                                                            
         BRAS  RE,OSPTFMT                                                       
         CLI   SBQMKTWT,C'N'       TEST TO UNWEIGHT                             
         BE    EXIT                                                             
         TM    OUTIND,OUTICRMK     YES - TEST ACROSS MARKETS                    
         BZ    EXIT                                                             
         ICM   RE,15,4(R2)         YES - TEST SPOTS ARE WEIGHTED                
         BZ    EXIT                                                             
         ICM   RF,15,12(R2)                                                     
         BZ    EXIT                                                             
         SR    RE,RF               YES - CALCULATE WEIGHTED BILLABLE            
         ST    RE,4(R2)                                                         
         LR    R5,R2               UNWEIGHT FOR POSSIBLE FUTURE                 
         BRAS  RE,UNWEIGHT         POINTS PER SPOT CALCULATION                  
         B     EXIT                                                             
*                                                                               
OAUTH    TM    COLIND,COLIRND      ** AUTHORIZATION DOLLARS **                  
         BZ    OAUTH2                                                           
         ZAP   DUB,0(8,R2)         ROUND OUT THE PENNIES IF REQUIRED            
         BAS   RE,ROUNDPAK                                                      
         ZAP   0(8,R2),DUB                                                      
OAUTH2   MVI   GLHOOK,GLEDIT       LET DRIVER EDIT                              
         B     EXIT                                                             
*                                                                               
ODOLNDX  ICM   R1,15,4(R2)         ** DOLLAR INDEX **                           
         BZ    ODOLNDX2                                                         
         ICM   RF,15,0(R2)                                                      
         BZ    ODOLNDX2                                                         
         SR    R0,R0                                                            
         M     R0,=F'200'                                                       
         DR    R0,RF                                                            
         LTR   R1,R1                                                            
         BZ    ODOLNDX2                                                         
         AHI   R1,1                                                             
         SRA   R1,1                                                             
         EDIT  (R1),(7,(R3))                                                    
         B     EXIT                                                             
ODOLNDX2 MVI   6(R3),C'0'                                                       
         B     EXIT                                                             
*                                                                               
OBILBL   CLI   GLHOOK,GLINCOMP     ** BILLABLE DOLLARS **                       
         BE    *+12                                                             
         MVI   GLHOOK,GLEDIT                                                    
         B     EXIT                                                             
         L     RE,0(R2)                                                         
         L     RF,4(R2)                                                         
         SR    RE,RF               BUY DOLLARS - BILLED DOLLARS                 
         BZ    *+8                                                              
         NI    COLIND2,255-COLIBLB0   NON-ZERO BILLABLE COLUMN                  
         ST    RE,0(R2)                                                         
         B     EXIT                                                             
*                                                                               
OCASH    LA    R1,CUMCASH          ** CHILD SPOT PAY DOLLARS **                 
         B     OCUME                                                            
*                                                                               
OTRADE   LA    R1,CUMTRADE         ** CHILD SPOT NTP DOLLARS **                 
         B     OCUME                                                            
*                                                                               
ODDOL    LA    R1,CUMDDOL          ** CHILD SPOT DELIVERED DOLLARS **           
         B     OCUME                                                            
*                                                                               
OCUME    MVI   GLHOOK,GLEDIT       GENERAL CUMING ROUTINE                       
         LA    RF,GLARGS                                                        
         USING GLARGSD,RF                                                       
         TM    GLOIND,GLOICUME     TEST THIS IS A CUMED COL                     
         BZ    EXIT                                                             
         DROP  RF                                                               
         TM    GLINDS,GLTOTLIN     YES-TEST TOTAL LINE                          
         BZ    *+14                                                             
         ZAP   0(8,R1),=P'0'       YES-CLEAR THE CUME                           
         B     EXIT                                                             
         AP    0(8,R1),0(8,R2)     ELSE ADD CURRENT VALUE TO CUME               
         ZAP   0(8,R2),0(8,R1)                                                  
         B     EXIT                                                             
*                                                                               
*OASSDOL  DS    0H                  SECOND COST                                 
*         TM    GLINDS,GLTOTLIN     TEST TOTAL LINE                             
*         BNZ   OAD10                YES                                        
*         CLI   7(R2),X'80'         NO SECOND COST?                             
*         BNE   *+14                                                            
*         MVC   0(11,R3),BLANKS                                                 
*         B     EXIT                                                            
*                                                                               
*OAD10    L     R1,0(R2)                                                        
*         EDIT  (R1),(11,(R3)),2,FLOAT=-,ZERO=NOBLANK                           
*         B     EXIT                                                            
         EJECT                                                                  
* DEMO OUTPUT ROUTINES                                                          
*                                                                               
         SPACE 1                                                                
*                                  ** DEMO INDEX **                             
ODEMNDX  CLI   SBQMKTWT,C'N'       TEST MARKET WEIGHTING                        
         BE    ODEMNDX2                                                         
         TM    OUTIND,OUTICRMK     AND ACROSS MARKETS                           
         BZ    ODEMNDX2                                                         
         OC    TOTWGT,TOTWGT       AND THERE'S A TOTAL WEIGHT                   
         BZ    ODEMNDX2                                                         
         ICM   RF,15,4(R2)         YES-TEST DEMOS ARE WEIGHTED                  
         BZ    ODEMNDX2                                                         
         ICM   R1,15,12(R2)                                                     
         BNZ   ODEMNDX3            YES-CALCULATE INDEX ON WEIGHTED DEMS         
*                                                                               
ODEMNDX2 ICM   R1,15,8(R2)                                                      
         BZ    ODEMNDX4                                                         
         ICM   RF,15,0(R2)                                                      
         BZ    ODEMNDX4                                                         
*                                                                               
ODEMNDX3 CVD   R1,DUB                                                           
         ZAP   BIG,DUB                                                          
         MP    BIG,=PL2'200'                                                    
         CVD   RF,DUB                                                           
         DP    BIG,DUB                                                          
         ZAP   DUB,BIG(8)                                                       
         CP    DUB,=P'0'                                                        
         BE    ODEMNDX4                                                         
         AP    DUB,=P'1'                                                        
         ZAP   BIG,DUB                                                          
         DP    BIG,=PL8'2'                                                      
         CVB   R1,BIG                                                           
         EDIT  (R1),(7,(R3))                                                    
         B     EXIT                                                             
*                                                                               
ODEMNDX4 MVI   6(R3),C'0'                                                       
         B     EXIT                                                             
*                                                                               
*                                  ** DEMO **                                   
*                                                                               
ODEMO    DS    0H                                                               
         ICM   R1,15,0(R2)         TEST OVERFLOW                                
         CLM   R1,15,=X'80000000'                                               
         BE    EXIT                                                             
         ICM   R1,15,4(R2)                                                      
         CLM   R1,15,=X'80000000'                                               
         BE    EXIT                                                             
*                                                                               
         TM    GLARGS+(GLOIND-GLARGSD),GLOIWGT  TEST COLUMN IS WEIGHTED         
         BZ    ODEMO2                                                           
         CLI   GLHOOK,GLINCOMP     YES-TEST INTERNAL COMPUTE TIME               
         BNE   ODEMO10             NO-JUST FORMAT                               
         BAS   RE,WGTCOL           GET WEIGHTED DEMO                            
*                                                                               
ODEMO2   CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE TIME                   
         BNE   ODEMO8                                                           
         TM    COLIND,COLINDR      YES-TEST DEMO ROUNING                        
         BO    EXIT                                                             
         LA    RF,2                YES                                          
*                                                                               
ODEMO4   ICM   R1,15,0(R2)                                                      
         BZ    ODEMO6                                                           
         SR    R0,R0               DIVIDE BY 10 TO GET ROUNDED DEMO             
         SLDA  R0,1                                                             
         D     R0,=F'10'                                                        
         AHI   R1,1                                                             
         SRA   R1,1                                                             
         ST    R1,0(R2)                                                         
*                                                                               
ODEMO6   LA    R2,4(R2)                                                         
         BCT   RF,ODEMO4                                                        
         B     EXIT                                                             
*                                                                               
ODEMO8   MVC   DUB,0(R2)           MAYBE UNWEIGHT                               
         BAS   RE,ODEMWGT                                                       
         MVC   0(4,R2),DUB                                                      
*                                                                               
ODEMO10  L     R1,GLADTENT         EDIT                                         
         USING DROD,R1                                                          
         MVI   DRODEC,0                                                         
         TM    COLIND,COLINDR      TEST NO DEMO ROUNDING                        
         BZ    ODEMO12                                                          
         MVI   DRODEC,1            YES                                          
         BRAS  RE,RPT2DEC          REPORT 2 DECIMAL?                            
         BNE   *+8                 NO                                           
         MVI   DRODEC,2            YES - SET 2 DECIMAL                          
*                                                                               
ODEMO12  MVI   GLHOOK,GLEDIT                                                    
         B     EXIT                                                             
         DROP  R1                                                               
         SPACE 1                                                                
*                                  ** CPP **                                    
OCPP     DS    0H                                                               
*                                  ** CPP **                                    
         L     R1,GLADTENT                                                      
         USING DROD,R1                                                          
         TM    DROOPTS,X'40'       NO TOTALING?                                 
         BZ    OCPP1               NO, THERE IS TOTALING                        
         DROP  R1                                                               
         TM    GLINDS,GLTOTLIN     IS THIS A TOTAL LINE?                        
         BZ    OCPP1               NO, CONTINUE                                 
         XC    0(4,R2),0(R2)       R2 IS OUTPUT BUT NOT PRINTED...              
         B     OCPPX               WILL GET PICKED UP ON INDEXING               
*                                                                               
OCPP1    CLI   GLARGS+2,C'0'       SPECIAL IF SQAD CPP                          
******   BNL   OCPPSQD                                                          
         BL    OCPPSQDN                                                         
*                                  ** CPP **                                    
         CLI   GLARGS+3,C'T'       SKIP IF NOT TOTALLING                        
         BNE   *+12                                                             
         L     RE,GLADTENT                                                      
         MVI   DROTRAIL-DROD(RE),C'+'  SET TRAILING CHARACTER                   
*                                                                               
OCPPSQDN DS    0H                                                               
*                                                                               
         CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE HOOK                   
         BE    OCPP2               YES-ALWAYS CALCULATE CPP                     
         TM    COLIND,COLICPPT     TEST SUPPRESS TOTALS                         
         BZ    *+12                                                             
         TM    GLINDS,GLTOTLIN     YES-TEST TOTALING NOW                        
         BO    OCPPX               YES-EXIT                                     
         TM    OUTIND,OUTICRDP     TEST FOR CROSS DAYPARTS NOW                  
         BZ    *+12                                                             
         TM    SBQDPTLN,SBQDLCPP   YES - TEST FOR WHETHER TO PRINT              
         BZ    OCPPX                     NO - EXIT                              
         MVC   CPP,0(R2)                                                        
         OC    TOTWGT,TOTWGT       TEST THERE IS A TOTAL WEIGHT                 
         BZ    OCPP6                                                            
         MVC   DUB,4(R2)           YES-UNWEIGHT IF NECESSARY                    
         BAS   RE,ODEMWGT                                                       
         BNE   OCPP6               NO UNWEIGHTING                               
         MVC   CPPDEM,DUB          DEMO IS UNWEIGHTED-REDO CALCULATION          
         L     R1,4(R2)                                                         
         B     OCPP4                                                            
*                                  INTERNAL COMPUTE -                           
OCPP2    L     R1,0(R2)            COST                                         
         MVC   CPPDEM,4(R2)        POINTS                                       
         ST    R1,4(R2)            STORE COST IN CASE NEEDED IN FUTURE          
*                                                                               
OCPP4    CVD   R1,DOL                                                           
         XC    0(4,R2),0(R2)                                                    
         BAS   RE,OCPPCAL          CPP CALCULATION                              
         BZ    OCPPX                                                            
         CLI   GLARGS+2,C'3'       NEW SQAD CPM KEYWORD (4-9)?                  
         BNH   OCPP5               NO                                           
         CLI   GLARGS+3,C'T'       SQAD TOTAL KEYWORDS?                         
         BNE   OCPP5               NO                                           
         ICM   R1,15,CPP           CPP                                          
         BZ    OCPP5               IF ZERO SKIP DIVIDE                          
         XR    R0,R0               CLEAR R0                                     
         D     R0,=F'100'          DIVIDE CPP BY 100                            
         ST    R1,CPP              NEW CPP                                      
*                                                                               
OCPP5    MVC   0(4,R2),CPP                                                      
*                                                                               
OCPP6    MVC   DUB(4),CPP          FORMAT THE CPP                               
         MVI   BYTE,0                                                           
         BRAS  RE,OCPPFMT                                                       
         B     OCPPX                                                            
*&&DO                                                                           
OCPPSQD  DS    0H                  SQAD CPP                                     
*                                                                               
         CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE HOOK                   
         BE    OCPPSQD1            YES-ALWAYS CALCULATE CPP                     
*                                                                               
         TM    COLIND,COLICPPT     TEST SUPPRESS TOTALS                         
         BZ    *+12                                                             
         TM    GLINDS,GLTOTLIN     YES-TEST TOTALING NOW                        
         BO    OCPPSQDX            YES-EXIT                                     
*                                                                               
         TM    OUTIND,OUTICRDP     TEST FOR CROSS DAYPARTS NOW                  
         BZ    *+12                                                             
         TM    SBQDPTLN,SBQDLCPP   YES - TEST FOR WHETHER TO PRINT              
         BZ    OCPPX                     NO - EXIT                              
*                                                                               
OCPPSQD1 DS    0H                                                               
*                                                                               
         SR    RE,RE               DIVIDE BY OCCURRENCE FACTOR                  
         ICM   RF,15,0(R2)                                                      
         ICM   R1,15,4(R2)                                                      
         BZ    OCPPSQDX                                                         
         DR    RE,R1                                                            
         STCM  RF,15,0(R2)                                                      
         LA    R1,1                                                             
         STCM  R1,15,4(R2)         FORCE ONE REPETITION                         
*                                                                               
         CLI   GLARGS+3,C'T'       SKIP IF NOT TOTALLING                        
         BNE   *+12                                                             
         L     RE,GLADTENT                                                      
         MVI   DROTRAIL-DROD(RE),C'+'  SET TRAILING CHARACTER                   
*                                                                               
         MVI   GLHOOK,GLEDIT       HAVE DRIVER EDIT                             
*                                                                               
OCPPSQDX DS    0H                  SQAD CPP                                     
*&&                                                                             
OCPPX    B     EXIT                                                             
         SPACE 1                                                                
*                                  ** AVERAGE RATING **                         
OAR      CLI   GLHOOK,GLINCOMP     TEST INTERNAL COMPUTE TIME                   
         BE    OAR2                YES-CALCULATE POINTS PER SPOT                
         OC    TOTWGT,TOTWGT       NO-TEST THERE'S A TOTAL WEIGHT               
         BZ    OAR4                                                             
         MVC   DUB,0(R2)           YES-UNWEIGHT IF NECESSARY                    
         BAS   RE,ODEMWGT                                                       
         BNE   OAR4                                                             
         MVC   0(4,R2),DUB                                                      
         LA    R5,8(R2)            UNWEIGHT SPOTS ALSO                          
         BRAS  RE,UNWEIGHT                                                      
*                                                                               
OAR2     SR    RE,RE               CALCULATE POINTS PER SPOT                    
         L     RF,0(R2)                                                         
         SLDA  RE,1                                                             
         XC    0(4,R2),0(R2)                                                    
         ICM   R1,15,8(R2)                                                      
         BZ    OAR4                                                             
         TM    COLIND,COLINDR      TEST DEMOS ROUNDED                           
         BO    *+8                                                              
         MHI   R1,10               YES-DIVIDE BY 10                             
         DR    RE,R1                                                            
         AHI   RF,1                                                             
         SRA   RF,1                                                             
         ST    RF,0(R2)                                                         
*                                                                               
OAR4     L     R1,GLADTENT         EDIT                                         
         USING DROD,R1                                                          
         MVI   DRODEC,0                                                         
         TM    COLIND,COLINDR      TEST NO DEMO ROUNDING                        
         BZ    OAR5                                                             
         MVI   DRODEC,1            YES                                          
         BRAS  RE,RPT2DEC          REPORT 2 DECIMAL?                            
         BNE   *+8                 NO                                           
         MVI   DRODEC,2                                                         
*                                                                               
OAR5     MVI   GLHOOK,GLEDIT                                                    
         B     EXIT                                                             
         DROP  R1                                                               
         EJECT                                                                  
* STACKING OUTPUT ROUTINES                                                      
*                                                                               
         SPACE 1                                                                
OSTDATA  LA    R0,8            *** STDATA OUTPUT ***                            
         LA    R4,STACKDEF                                                      
*                                                                               
OSTDATA2 CLI   0(R4),0                                                          
         BE    EXIT                                                             
         BRAS  RE,STCHK                                                         
         BNE   OSTDATA6                                                         
         L     R1,=A(STACKTAB)                                                  
*                                                                               
OSTDATA4 CLI   0(R1),0                                                          
         BE    OSTDATA5                                                         
         CLC   0(1,R4),0(R1)                                                    
         BE    *+12                                                             
         LA    R1,5(R1)                                                         
         B     OSTDATA4                                                         
         MVC   0(4,R3),1(R1)                                                    
*                                                                               
OSTDATA5 LA    R3,198(R3)                                                       
*                                                                               
OSTDATA6 LA    R4,2(R4)                                                         
         BCT   R0,OSTDATA2                                                      
         B     EXIT                                                             
         EJECT                                                                  
         USING RSTACKD,R2                                                       
OSTDEM   XC    DEM,DEM             *** STD OUTPUT ***                           
         XC    SVDEM,SVDEM                                                      
         XC    CPP,CPP                                                          
         XC    SVCPP,SVCPP                                                      
         ZAP   DOL,=P'0'                                                        
         ZAP   SVDOL,=P'0'                                                      
         MVI   STACKTYP,C'R'                                                    
         LA    R4,STACKDEF                                                      
         LA    R6,L'STACKDEF                                                    
*                                                                               
OSTDEM2  CLI   0(R4),0             TEST END OF STACK                            
         BE    OSTDEMX                                                          
         BRAS  RE,STCHK            TEST STACK ENTRY SHOULD PRINT                
         BNE   OSTDEM40                                                         
         CLI   0(R4),STSPACE       SPACE                                        
         BE    OSTDEM38                                                         
         CLI   0(R4),STDIFF        DIFFERENCE                                   
         BNE   OSTDEM6                                                          
         CLI   LASTSTAK,C'D'       DOLLAR DIFFERENCE                            
         BE    OSTDOL1                                                          
         CLI   LASTSTAK,C'R'       DEMO DIFFERENCE                              
         BNE   OSTDEM4                                                          
         L     RE,DEM                                                           
         S     RE,SVDEM                                                         
         ST    RE,DUB                                                           
         B     OSTDEM14                                                         
*                                                                               
OSTDEM4  CLI   LASTSTAK,C'C'       CPP DIFFERENCE                               
         BNE   OSTDEM38                                                         
         L     RE,CPP                                                           
         S     RE,SVCPP                                                         
         ST    RE,DUB                                                           
         MVI   BYTE,C' '                                                        
         B     OSTDEM22                                                         
*                                                                               
OSTDEM6  CLI   0(R4),STNDX         INDEX                                        
         BNE   OSTDEM10                                                         
         CLI   LASTSTAK,C'D'       DOLLAR INDEX                                 
         BE    OSTDOL1                                                          
         L     RF,DEM                                                           
         L     R1,SVDEM                                                         
         CLI   LASTSTAK,C'R'       DEMO INDEX                                   
         BE    OSTDEM8                                                          
         L     RF,CPP                                                           
         L     R1,SVCPP                                                         
         CLI   LASTSTAK,C'C'       CPP INDEX                                    
         BNE   OSTDEM38                                                         
*                                                                               
OSTDEM8  LTR   R1,R1                                                            
         BZ    OSTDEM9                                                          
         M     RE,=F'2000'                                                      
         DR    RE,R1                                                            
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AHI   RF,1                NOT AN LA!!!                                 
         SRA   RF,1                                                             
         ST    RF,DUB                                                           
*                                                                               
OSTDEM9  XC    EBLOCK,EBLOCK                                                    
         MVI   EBDECS,1                                                         
         LLC   R1,MYOLEN                                                        
         BCTR  R1,0                                                             
         STC   R1,EBLOUT                                                        
         LA    R1,DUB                                                           
         ST    R1,EBAIN                                                         
         MVI   EBLIN,4                                                          
         MVI   EBTIN,C'B'                                                       
         ST    R3,EBAOUT                                                        
         TM    DOWNOPT,DOWNON      TEST DOWNLOADING                             
         BZ    *+8                                                              
         OI    EBOPT,EBOQZEN       YES-ZERO=NOBLANK                             
         OI    EBTRIM,EBTQROD      ROUND OFF DECIMALS IF TOO BIG                
         GOTO1 GLAEDITR,DMCB,EBLOCK                                             
         B     OSTDEM38                                                         
*                                                                               
OSTDEM10 LA    R1,RSGDEM           DEMOS                                        
         CLI   0(R4),STGOAL                                                     
         BE    OSTDEM12                                                         
         LA    R1,RSODEM                                                        
         CLI   0(R4),STORD                                                      
         BE    OSTDEM12                                                         
         LA    R1,RSPDEM                                                        
         CLI   0(R4),STPUR                                                      
         BE    OSTDEM12                                                         
         LA    R1,RSRDEM                                                        
         CLI   0(R4),STACH                                                      
         BE    OSTDEM12                                                         
         LA    R1,RSADEM                                                        
         CLI   0(R4),STAFF                                                      
         BNE   OSTDEM18                                                         
*                                                                               
OSTDEM12 MVC   SVDEM,DEM                                                        
         MVI   LASTSTAK,C'R'                                                    
         MVC   DUB,0(R1)                                                        
         BAS   RE,ODEMWGT                                                       
         MVC   DEM,DUB                                                          
*                                                                               
OSTDEM14 BAS   RE,ODEMFMT                                                       
         B     OSTDEM38                                                         
*                                                                               
OSTDEM18 LA    R1,RSGDEMCP         CPP                                          
         LA    R5,RSGDOLCP                                                      
         CLI   0(R4),STGCPP                                                     
         BE    OSTDEM20                                                         
         LA    R1,RSODEMCP                                                      
         LA    R5,RSODOL                                                        
         CLI   0(R4),STOCPP                                                     
         BE    OSTDEM20                                                         
         LA    R1,RSPDEMCP                                                      
         LA    R5,RSBDOL                                                        
         CLI   0(R4),STPCPP                                                     
         BE    OSTDEM20                                                         
         LA    R1,RSRDEMCP                                                      
         CLI   0(R4),STRCPP                                                     
         BE    OSTDEM20                                                         
         LA    R1,RSADEMCP                                                      
         CLI   0(R4),STACPP                                                     
         BE    OSTDEM20                                                         
*                                                                               
         LA    R1,RSPDEMCP                                                      
         LA    R5,RSNCPDOL                                                      
         CLI   0(R4),STPCPPN                                                    
         BE    OSTDEM20                                                         
         LA    R1,RSRDEMCP                                                      
         CLI   0(R4),STRCPPN                                                    
         BE    OSTDEM20                                                         
         LA    R1,RSADEMCP                                                      
         CLI   0(R4),STACPPN                                                    
         BNE   OSTDEM23                                                         
*                                                                               
OSTDEM20 MVC   DUB,0(R1)                                                        
         OC    TOTWGT,TOTWGT                                                    
         BZ    *+8                                                              
         BAS   RE,ODEMWGT          MAYBE UNWEIGHT THE DEMO VALUE                
         MVC   CPPDEM,DUB                                                       
         BAS   RE,CALCDOL          CALCULATE EXACT DOLLAR AMOUNT                
         MVC   SVCPP,CPP                                                        
         MVI   LASTSTAK,C'C'                                                    
         BAS   RE,OCPPCAL          CALCULATE CPP                                
         BZ    OSTDEM38                                                         
         MVC   DUB(4),CPP                                                       
         MVI   BYTE,0                                                           
*                                                                               
OSTDEM22 BRAS  RE,OCPPFMT          FORMAT CPP                                   
         B     OSTDEM38                                                         
*                                                                               
OSTDEM23 MVI   LASTSTAK,C'P'       PW PCT                                       
         CLI   0(R4),STPWPCT                                                    
         BNE   OSTDEM24                                                         
         XC    WORK,WORK                                                        
         LA    R5,WORK                                                          
         USING PWBLKD,R5                                                        
         ICM   R1,15,RSGRSDOL                                                   
         MHI   R1,100                                                           
         A     R1,RSGRSPEN                                                      
         MVI   PWACT,PWGETPW                                                    
         ST    R1,PWACTBUY                                                      
         MVC   PWADJBUY,RSPWGRS                                                 
         MVC   PWTAX,RSTAX                                                      
         GOTO1 PWCALC,DMCB,(R5)                                                 
         CLI   PWERR,0                                                          
         BE    *+6                                                              
         DC    H'0'                                                             
         EDIT  PWVAL,(7,(R3)),2,MINUS=YES                                       
         B     OSTDEM38                                                         
*                                                                               
OSTDEM24 MVI   LASTSTAK,C'D'       GROSS/NET DOLLARS                            
         LA    R5,RSGRSDOL                                                      
         CLI   0(R4),STGROSS                                                    
         BE    OSTDOL1                                                          
         LA    R5,RSNETDOL                                                      
         CLI   0(R4),STNET                                                      
         BE    OSTDOL1                                                          
         LA    R5,RSGDOL           GOAL DOLLARS                                 
         CLI   0(R4),STGDOL                                                     
         BE    OSTDOL1                                                          
         LA    R5,RSGNDOL          NET GOAL DOLLARS                             
         CLI   0(R4),STGNDOL                                                    
         BE    OSTDOL1                                                          
         LA    R5,RSSTDOL          STATION LOCKIN DOLLARS                       
         CLI   0(R4),STSLDOL                                                    
         BE    OSTDOL1                                                          
*                                                                               
         CLI   0(R4),STSPOTS       SPOTS                                        
         BNE   OSTDEM26                                                         
         MVI   LASTSTAK,C'S'                                                    
         LA    R1,RSSPOTS                                                       
         LLC   R5,MYOLEN                                                        
         LR    RE,R5                                                            
         BCTR  RE,0                                                             
         STC   RE,MYOLEN                                                        
         BRAS  RE,OSPTFMT                                                       
         STC   R5,MYOLEN                                                        
         B     OSTDEM38                                                         
*                                                                               
OSTDEM26 DS    0H                                                               
         MVI   LASTSTAK,C'R'                                                    
         ICM   R0,15,RSSPOTS                                                    
         BZ    OSTDEM38                                                         
         STCM  R0,15,FULL                                                       
         CLI   0(R4),STAVPCH                                                    
         BNE   *+12                                                             
         ICM   R0,15,RSPDEM                                                     
         B     OSTDEM28                                                         
         CLI   0(R4),STAVACH                                                    
         BNE   *+12                                                             
         ICM   R0,15,RSRDEM                                                     
         B     OSTDEM28                                                         
         CLI   0(R4),STAVAFF                                                    
         BNE   OSTDEM38                                                         
         ICM   R0,15,RSADEM                                                     
OSTDEM28 DS    0H                                                               
         SR    R1,R1                                                            
         SRDA  R0,31                                                            
         D     R0,FULL                                                          
         LTR   R1,R1                                                            
         BM    *+8                                                              
         AHI   R1,1                                                             
         SRA   R1,1                                                             
         ST    R1,DUB                                                           
         BAS   RE,ODEMFMT                                                       
*                                                                               
OSTDEM38 LA    R3,198(R3)          NEXT PRINT LINE                              
*                                                                               
OSTDEM40 LA    R4,2(R4)            NEXT IN STACK                                
         BCT   R6,OSTDEM2                                                       
*                                                                               
OSTDEMX  B     EXIT                                                             
         EJECT                                                                  
         USING BSTACKD,R2                                                       
OSTBDEM  MVI   STACKTYP,C'B'       *** STD(P/R/A) OUTPUT ***                    
         LA    R4,STACKDEF             (BUY DEMO STACK)                         
         LA    R6,L'STACKDEF                                                    
*                                                                               
OSTBD2   CLI   0(R4),0             TEST END OF STACK                            
         BE    OSTBDX                                                           
         BRAS  RE,STCHK            TEST STACK ENTRY SHOULD PRINT                
         BNE   OSTBD14                                                          
         CLI   0(R4),STSPACE       SPACE                                        
         BE    OSTBD12                                                          
         CLI   0(R4),STIMP         IMPS                                         
         BNE   *+14                                                             
         MVC   DUB(4),BSIMP                                                     
         B     OSTBD4                                                           
         CLI   0(R4),STRTG         RTG                                          
         BNE   OSTBD6                                                           
         MVC   DUB,BSRTG                                                        
         BAS   RE,ODEMWGT                                                       
*                                                                               
OSTBD4   BAS   RE,ODEMFMT          FORMAT DEMO VALUE                            
         B     OSTBD12                                                          
*                                                                               
OSTBD6   DS    0H                                                               
         CLI   0(R4),STCPMN        NET CPM?                                     
         BNE   *+18                                                             
         MVC   DUB(4),BSIMPCP                                                   
         LA    R5,BSNCPDOL                                                      
         B     OSTBD9                                                           
*                                                                               
         CLI   0(R4),STCPM         CPM                                          
         BNE   *+14                                                             
         MVC   DUB(4),BSIMPCP                                                   
         B     OSTBD8                                                           
*                                                                               
         CLI   0(R4),STCPPN        NET CPP?                                     
         BNE   OSTBD7                                                           
         MVC   DUB,BSRTGCP                                                      
         OC    TOTWGT,TOTWGT       MAYBE UNWEIGHT                               
         BZ    *+8                                                              
         BAS   RE,ODEMWGT                                                       
         LA    R5,BSNCPDOL                                                      
         B     OSTBD9                                                           
*                                                                               
OSTBD7   CLI   0(R4),STCPP         CPP                                          
         BNE   OSTBD10                                                          
         MVC   DUB,BSRTGCP                                                      
         OC    TOTWGT,TOTWGT       MAYBE UNWEIGHT                               
         BZ    OSTBD8                                                           
         BAS   RE,ODEMWGT                                                       
*                                                                               
OSTBD8   MVC   CPPDEM,DUB                                                       
         LA    R5,BSDOL                                                         
OSTBD9   BAS   RE,CALCDOL          CALCULATE EXACT DOLLAR AMOUNT                
         BAS   RE,OCPPCAL          CALCULATE CPP/CPM                            
         BZ    OSTBD12                                                          
         MVC   DUB(4),CPP          FORMAT CPP/CPM                               
         MVI   BYTE,0                                                           
         BRAS  RE,OCPPFMT                                                       
         B     OSTBD12                                                          
*                                                                               
OSTBD10  LA    R5,BSGRSDOL         GROSS DOLLARS                                
         CLI   0(R4),STGROSS                                                    
         BE    OSTDOL1                                                          
         LA    R5,BSNETDOL         NET DOLLARS                                  
         CLI   0(R4),STNET                                                      
         BE    OSTDOL1                                                          
         CLI   0(R4),STSPOTS       SPOTS                                        
         BNE   OSTBD12                                                          
         LA    R1,BSSPOTS                                                       
         LLC   R5,MYOLEN                                                        
         LR    RE,R5                                                            
         BCTR  RE,0                                                             
         STC   RE,MYOLEN                                                        
         BRAS  RE,OSPTFMT                                                       
         STC   R5,MYOLEN                                                        
*                                                                               
OSTBD12  LA    R3,198(R3)          NEXT PRINT LINE                              
*                                                                               
OSTBD14  LA    R4,2(R4)            NEXT IN STACK                                
         BCT   R6,OSTBD2                                                        
*                                                                               
OSTBDX   B     EXIT                                                             
         EJECT                                                                  
         USING DSTACKD,R2                                                       
OSTDOL   ZAP   DOL,=P'0'           *** ST$ OUTPUT ***                           
         ZAP   SVDOL,=P'0'                                                      
         LA    R4,STACKDEF         LOOP THROUGH STACK                           
         LA    R6,L'STACKDEF                                                    
         MVI   STACKTYP,C'D'                                                    
*                                                                               
OSTDOL1  XC    EBLOCK,EBLOCK                                                    
         LA    R1,DUB                                                           
         ST    R1,EBAIN            INIT EDITOR BLOCK                            
         MVI   EBLIN,L'DUB                                                      
         MVI   EBTIN,C'P'                                                       
         MVC   EBLOUT,MYOLEN                                                    
         MVI   EBOPT,EBOQMEY                                                    
         TM    DOWNOPT,DOWNON      TEST DOWNLOADING                             
         BZ    OSTDOL2                                                          
         OI    EBOPT,EBOQZEN       YES-ZERO=NOBLANK                             
*                                                                               
OSTDOL2  CLI   0(R4),0             TEST END OF STACK                            
         BE    OSTDOLX                                                          
         BRAS  RE,STCHK            TEST STACK ENTRY SHOULD PRINT                
         BNE   OSTDOL16                                                         
         CLI   0(R4),STSPACE       SPACE                                        
         BE    OSTDOL14                                                         
         CLI   0(R4),STDIFF        DIFFERENCE                                   
         BNE   OSTDOL4                                                          
         ZAP   DUB,DOL                                                          
         SP    DUB,SVDOL                                                        
         B     OSTDOL10                                                         
*                                                                               
OSTDOL4  CLI   0(R4),STNDX         INDEX                                        
         BNE   OSTDOL6                                                          
         CP    SVDOL,=P'0'                                                      
         BNE   OSTDOL5                                                          
         LLC   R1,MYOLEN                                                        
         LA    R1,0(R1,R3)                                                      
         SHI   R1,5                                                             
         MVC   0(4,R1),=C'HIGH'                                                 
         B     OSTDOL14                                                         
*                                                                               
OSTDOL5  ZAP   BIG,DOL                                                          
         MP    BIG,=P'2000'                                                     
         DP    BIG,SVDOL                                                        
         TM    BIG+7,X'01'                                                      
         BO    *+10                                                             
         AP    BIG(8),=P'1'                                                     
         ZAP   BIG2,BIG(8)                                                      
         DP    BIG2,=PL8'2'                                                     
         ZAP   DUB,BIG2(8)                                                      
         MVI   EBDECS,1                                                         
         B     OSTDOL12                                                         
*                                                                               
OSTDOL6  CLI   STACKTYP,C'D'       TEST ENTRY FROM ANOTHER STACK TYPE           
         BNE   OSTDOL8             YES-R5 ALREADY SET TO A(DOLLARS)             
         LA    R5,DSGDOL           GOAL DOLLARS                                 
         CLI   0(R4),STGOAL                                                     
         BE    OSTDOL8                                                          
         LA    R5,DSODOL           ORDERED DOLLARS                              
         CLI   0(R4),STORD                                                      
         BE    OSTDOL8                                                          
         LA    R5,DSSTDOL          STATION LOCKIN DOLLARS                       
         CLI   0(R4),STSLDOL                                                    
         BE    OSTDOL8                                                          
         LA    R5,DSBDOL           BUY (PURCHASED) DOLLARS                      
         CLI   0(R4),STPUR                                                      
         BNE   OSTDOL14                                                         
*                                                                               
OSTDOL8  BAS   RE,CALCDOL          CALCULATE EXACT AMOUNT                       
         ZAP   DUB,DOL                                                          
*                                                                               
OSTDOL10 MVI   EBDECS,0            NO DECIMAL POINT IF ROUNDING                 
         BAS   RE,ROUNDED                                                       
         BE    OSTDOL12                                                         
         MVI   EBDECS,2                                                         
*                                                                               
OSTDOL12 ST    R3,EBAOUT           FORMAT                                       
         OI    EBTRIM,EBTQROD      ROUND OFF DECIMALS IF TOO BIG                
         GOTO1 GLAEDITR,DMCB,EBLOCK                                             
*                                                                               
OSTDOL14 CLI   STACKTYP,C'R'       TEST ENTRY FROM DEMO STACK ROUTINE           
         BE    OSTDEM38            YES-RETURN THERE                             
         CLI   STACKTYP,C'B'       TEST ENTRY FROM BUY DEMO STACK RTN           
         BE    OSTBD12             YES-RETURN THERE                             
         LA    R3,198(R3)          NEXT PRINT LINE                              
*                                                                               
OSTDOL16 LA    R4,2(R4)            NEXT IN STACK                                
         BCT   R6,OSTDOL2                                                       
*                                                                               
OSTDOLX  B     EXIT                                                             
         EJECT                                                                  
         USING ASTACKD,R2                                                       
OSTACC   XC    EBLOCK,EBLOCK       ** STG/STN/STT/STG-/STN-/STC O/P **          
         LA    R1,DUB                                                           
         ST    R1,EBAIN            INIT EDITOR BLOCK                            
         MVI   EBLIN,L'DUB                                                      
         MVI   EBTIN,C'P'                                                       
         MVC   EBLOUT,MYOLEN                                                    
         MVI   EBOPT,EBOQMEY                                                    
         TM    DOWNOPT,DOWNON      TEST DOWNLOADING                             
         BZ    *+8                                                              
         OI    EBOPT,EBOQZEN       YES-ZERO=NOBLANK                             
         ZAP   DOL,=P'0'                                                        
         ZAP   SVDOL,=P'0'                                                      
         LA    R4,STACKDEF         LOOP THROUGH STACK                           
         LA    R6,L'STACKDEF                                                    
*                                                                               
OSTACC2  CLI   0(R4),0             TEST END OF STACK                            
         BE    OSTACCX                                                          
         BRAS  RE,STCHK            TEST STACK ENTRY SHOULD PRINT                
         BNE   OSTACC16                                                         
         CLI   0(R4),STSPACE       SPACE                                        
         BE    OSTACC14                                                         
         CLI   0(R4),STDIFF        DIFFERENCE                                   
         BNE   OSTACC4                                                          
         ZAP   DUB,DOL                                                          
         SP    DUB,SVDOL                                                        
         B     OSTACC10                                                         
*                                                                               
OSTACC4  CLI   0(R4),STNDX         INDEX                                        
         BNE   OSTACC6                                                          
         CP    SVDOL,=P'0'                                                      
         BNE   OSTACC5                                                          
         LLC   R1,MYOLEN                                                        
         LA    R1,0(R1,R3)                                                      
         SHI   R1,5                                                             
         MVC   0(4,R1),=C'HIGH'                                                 
         B     OSTACC14                                                         
*                                                                               
OSTACC5  ZAP   BIG,DOL                                                          
         MP    BIG,=P'2000'                                                     
         DP    BIG,SVDOL                                                        
         TM    BIG+7,X'01'                                                      
         BO    *+10                                                             
         AP    BIG(8),=P'1'                                                     
         ZAP   BIG2,BIG(8)                                                      
         DP    BIG2,=PL8'2'                                                     
         ZAP   DUB,BIG2(8)                                                      
         MVI   EBDECS,1                                                         
         B     OSTACC12                                                         
*                                                                               
OSTACC6  LA    R5,ASODOL           OREDERED DOLLARS                             
         CLI   0(R4),STBUY                                                      
         BE    OSTACC8                                                          
         LA    R5,ASPDOL           PAID DOLLARS                                 
         CLI   0(R4),STPAID                                                     
         BE    OSTACC8                                                          
         LA    R5,ASUDOL           UNPAID DOLLARS                               
         CLI   0(R4),STUNPD                                                     
         BE    OSTACC8                                                          
         LA    R5,ASBDOL           BILLED DOLLARS                               
         CLI   0(R4),STBIL                                                      
         BE    OSTACC8                                                          
         CLI   0(R4),STBILBL       BILLABLE DOLLARS                             
         BNE   OSTACC14                                                         
         LA    R5,ASBDOL                                                        
         BAS   RE,CALCDOL                                                       
         ZAP   DUB,DOL                                                          
         ZAP   DOL,SVDOL                                                        
         LA    R5,ASODOL                                                        
         BAS   RE,CALCDOL                                                       
         SP    DOL,DUB                                                          
         BZ    *+8                                                              
         NI    COLIND2,255-COLIBLB0                                             
         ZAP   DUB,DOL                                                          
         B     OSTACC10                                                         
*                                                                               
OSTACC8  BAS   RE,CALCDOL          CALCULATE EXACT AMOUNT                       
         ZAP   DUB,DOL                                                          
*                                                                               
OSTACC10 MVI   EBDECS,0            NO DECIMAL POINT IF ROUNDING                 
         BAS   RE,ROUNDED                                                       
         BE    OSTACC12                                                         
         MVI   EBDECS,2                                                         
*                                                                               
OSTACC12 ST    R3,EBAOUT           FORMAT                                       
         OI    EBTRIM,EBTQROD      ROUND OFF DECIMALS IF TOO BIG                
         GOTO1 GLAEDITR,DMCB,EBLOCK                                             
*                                                                               
OSTACC14 LA    R3,198(R3)          NEXT PRINT LINE                              
*                                                                               
OSTACC16 LA    R4,2(R4)            NEXT IN STACK                                
         BCT   R6,OSTACC2                                                       
*                                                                               
OSTACCX  B     EXIT                                                             
         EJECT                                                                  
* MISCELLANEOUS OUTPUT ROUTINES                                                 
*                                                                               
         SPACE 1                                                                
ODEMWGT  ST    RE,SVRE             ** GENERAL DEMO OUTPUT RTN **                
         CLI   SBQMKTWT,C'N'       TEST TO UNWEIGHT                             
         BE    ODEMWGT2                                                         
         TM    OUTIND,OUTICRMK     YES - TEST ACROSS MARKETS                    
         BZ    ODEMWGT2                                                         
         OC    DUB+4(4),DUB+4      YES - TEST DEMO IS WEIGHTED                  
         BZ    ODEMWGT2                                                         
         LA    R5,DUB              YES-UNWEIGHT                                 
         BRAS  RE,UNWEIGHT                                                      
         L     RE,SVRE             RETURN CC EQ                                 
         CR    RE,RE                                                            
         BR    RE                                                               
ODEMWGT2 ICM   RE,15,SVRE          NO WEIGHTING - RETURN CC NE                  
         BR    RE                                                               
         SPACE 1                                                                
ODEMFMT  ST    RE,SVRE             ** DEMO FORMAT ROUTINE **                    
         XC    EBLOCK,EBLOCK                                                    
         MVC   EBLOUT,MYOLEN                                                    
         MVI   EBOPT,EBOQMEY                                                    
         MVI   EBROUND,1                                                        
         MVI   EBDECS,0                                                         
         TM    COLIND,COLINDR                                                   
         BZ    ODEMF10                                                          
         MVI   EBROUND,0                                                        
         MVI   EBDECS,1                                                         
         BRAS  RE,RPT2DEC          REPORT 2 DECIMAL?                            
         BNE   *+8                 NO                                           
         MVI   EBDECS,2                                                         
*                                                                               
ODEMF10  LA    R1,DUB              DEMO VALUE IN DUB(4)                         
         ST    R1,EBAIN                                                         
         MVI   EBLIN,4                                                          
         MVI   EBTIN,C'B'                                                       
         ST    R3,EBAOUT                                                        
         OI    EBTRIM,EBTQROD      ROUND OFF DECIMALS IF TOO BIG                
         GOTO1 GLAEDITR,DMCB,EBLOCK                                             
         L     RE,SVRE                                                          
         BR    RE                                                               
         SPACE 1                                                                
*                                  ** CPP CALCULATION ROUTINE **                
OCPPCAL  ST    RE,SVRE                                                          
         XC    CPP,CPP                                                          
         ICM   RF,15,CPPDEM        TEST FOR ZERO DEMO                           
         BZ    OCPPCALX                                                         
         ZAP   BIG,DOL                                                          
         MP    BIG,=PL2'20'        X 10 FOR 2 DECIMAL POINT PRECISION           
         CLI   GLARGS+2,C'0'       SQAD CPP?                                    
         BNL   OCPPCAL1            YES - SKIP ROUNDING AND 2 DEC CODE!          
*                                                                               
         TM    COLIND,COLIRND      TEST ROUND OPTION                            
         BZ    *+10                                                             
         MP    BIG,=PL2'100'       YES - ADD BACK PENNIES                       
*                                                                               
         BRAS  RE,RPT2DEC          REPORT 2 DECIMAL?                            
         BNE   *+10                NO                                           
         MP    BIG,=PL2'10'        X 10 FOR 2 DECIMAL POINT PRECISION           
         ICM   RF,15,CPPDEM        RESTORE RF                                   
*                                                                               
OCPPCAL1 CVD   RF,DUB                                                           
         DP    BIG,DUB             DIVIDE TO GET CPP                            
         SR    R1,R1               PREPARE FOR CSO CPP                          
         OC    BIG(3),BIG          TEST FOR BFN (BIG NUMBER)                    
         BNZ   *+8                                                              
         CVB   R1,BIG                                                           
         LTR   R1,R1               TEST FOR ZERO CPP                            
         BZ    OCPPCALX                                                         
         BM    *+8                                                              
         AHI   R1,1                                                             
         SRA   R1,1                                                             
         ST    R1,CPP                                                           
OCPPCALX OC    CPP,CPP             RETURN CC EQ - CPP=ZERO                      
         L     RE,SVRE                       NE - CPP NE ZERO                   
         BR    RE                                                               
         SPACE 1                                                                
*                                  ** GET WEIGHTED VALUE **                     
WGTCOL   L     R1,0(R2)                                                         
         SR    R0,R0               DIVIDE BY 1000 TO GET WEIGHTED               
         SLDA  R0,1                VALUE (COVERAGE 10.0 = 100%)                 
         D     R0,=F'1000'                                                      
         AHI   R1,1                NOT A FUCKING LA                             
         SRA   R1,1                                                             
         ST    R1,0(R2)                                                         
         BR    RE                                                               
         EJECT                                                                  
* CALCULATE THE DOLLARS                                                         
* INPUT  : R5=A(DOLLARS(4)/PENNIES(4))                                          
* OUTPUT : DOL=PACKED MONEY AMOUNT IN PENNIES OR DOLLARS IF ROUNDING            
*                                                                               
CALCDOL  LR    R0,RE               CALCULATE THE DOLLARS                        
         MVC   SVDOL,DOL                                                        
         L     R1,0(R5)                                                         
         CVD   R1,DOL                                                           
         L     RF,4(R5)                                                         
         TM    COLIND,COLIRND      ROUND OPTION                                 
         BO    CD2                                                              
         MP    DOL,=PL2'100'                                                    
         CVD   RF,PEN                                                           
         AP    DOL,PEN                                                          
         B     CDX                                                              
*                                                                               
CD2      SR    RE,RE                                                            
         C     RF,=F'0'            PENNIES A NEGATIVE NUMBER?                   
         BNL   *+8                 NO                                           
         LHI   RE,-1               YES, MAKE SURE WE CARRY THE SIGN             
         SLDA  RE,1                                                             
         D     RE,=F'100'                                                       
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AHI   RF,1                NOT A FUCKING LA                             
         SRA   RF,1                                                             
         CVD   RF,MYDUB                                                         
         AP    DOL,MYDUB                                                        
*                                                                               
CDX      LR    RE,R0                                                            
         BR    RE                                                               
         SPACE 2                                                                
* CHECK WHETHER DOLLAR AMOUNT IF ROUNDED                                        
* IF NOT, CHECK IF PENNIES WILL FIT IN COLUMN WIDTH - IF NOT, THEN              
* ROUND OUT THE PENNIES                                                         
* INPUT  : DUB=DOLLARS OR PENNIES                                               
* OUTPUT : CC EQ - ROUNDED                                                      
*          CC NE - NOT ROUNDED                                                  
*                                                                               
ROUNDED  LR    R0,RE                                                            
         TM    COLIND,COLIRND      TEST ALREADY ROUNDED                         
         BO    ROUNDEDY            YES                                          
         TM    COLIND2,COLINOCT    TEST NO CENTS OPTION                         
         BO    ROUNDED2            YES-ROUND OUT THE PENNIES                    
         ZAP   BIG,=P'1'           CHECK THAT PENNIES WILL FIT IN               
         LLC   RE,MYOLEN           THE COLUMN WIDTH                             
         SHI   RE,2                                                             
         BNP   *+14                                                             
         MP    BIG,=PL2'10'                                                     
         BCT   RE,*-6                                                           
         CP    DUB,BIG             COMPARE AGAINST UPPER LIMIT                  
         BL    ROUNDEDN            LOW-NO NEED TO ROUND                         
ROUNDED2 BAS   RE,ROUNDPAK         ROUND OUT THE PENNIES                        
ROUNDEDY LR    RE,R0                                                            
         CR    RE,RE                                                            
         BR    RE                                                               
ROUNDEDN LTR   RE,R0                                                            
         BR    RE                                                               
*                                                                               
ROUNDPAK ZAP   BIG,DUB             ROUND OUT PACKED PENNIES                     
         MP    BIG,=P'2'                                                        
         DP    BIG,=PL8'100'                                                    
         TM    BIG+7,X'01'                                                      
         BO    *+10                                                             
         AP    BIG(8),=P'1'                                                     
         ZAP   BIG2,BIG(8)                                                      
         DP    BIG2,=PL8'2'                                                     
         ZAP   DUB,BIG2(8)                                                      
         BR    RE                                                               
         SPACE 2                                                                
* COMPUTE OUTPUT ROUTINE                                                        
*                                                                               
OCOMPUTE L     RE,GLADTENT         COMPUTE                                      
         USING DROD,RE                                                          
         L     R4,DROACOMP                                                      
         USING DRCMD,R4            ADDRESS COMP ELEMENT                         
         DROP  RE                                                               
         LLC   R0,DRCMNEXP         NUMBER OF EXPRESSIONS                        
*                                                                               
OCOMP2   CLI   DRCMOP,C'V'         TEST VERTICAL PERCENT                        
         BE    *+16                                                             
         LA    R4,L'DRCMEXP(R4)                                                 
         BCT   R0,OCOMP2                                                        
         B     OCOMP10             NO  - RETURN                                 
         CLC   GLLEVEL,DRCMSUB     YES - TEST CURRENT LEVEL TOO LOW             
         BL    OCOMPX                    YES - NO EDIT (PCT>100)                
         ICM   R5,15,DRCMAIN       ADDRESS THE INPUT ENTRY                      
         BZ    OCOMP10                                                          
         USING DRIND,R5                                                         
         CLI   DRCMSUB+1,C'C'      SPECIAL HIDDEN CPP INDICATOR                 
         BE    OCOMP3                                                           
         LA    R0,6                                                             
         LA    R1,DRINROUT                                                      
         CLC   0(3,R1),=C'CPP'     IS IT CPP ?                                  
         BE    *+16                                                             
         LA    R1,1(R1)                                                         
         BCT   R0,*-14                                                          
         B     OCOMP10                                                          
         MVI   DRCMSUB+1,C'C'      YES                                          
*                                                                               
OCOMP3   CLC   GLLEVEL,DRCMSUB     CPP - TEST VERT PCT OF CURRENT LEVEL         
         BNE   OCOMP4                                                           
         MVI   DRCMTYPE,0                YES - CHANGE TYPE BACK TO              
         MVC   DRCMAIN,ACOMPIN                 INPUT DISPLACEMENT               
         B     OCOMP10                                                          
*                                                                               
OCOMP4   CLI   DRCMTYPE,1                NO  - TEST TYPE IS ALREADY LIT         
         BE    OCOMP10                         YES - THEN VERT PCT OK           
         MVI   DRCMTYPE,1          CHANGE TYPE TO LITERAL                       
         MVC   ACOMPIN,DRCMAIN     SAVE A(INPUT ENTRY)                          
         L     R1,GLATHID          GET THE FIELD IN THE TOTAL RECORD            
         USING GLINTD,R1                                                        
         LLC   R6,DRCMSUB          (LEVEL NUMBER)                               
         SLL   R6,2                                                             
         LA    R6,GLARECL0(R6)                                                  
         DROP  R1                                                               
         L     R6,0(R6)            NOW HAVE A(RECORD AT THIS LEVEL)             
         LH    RE,DRINDISP                                                      
         AR    R6,RE               R6 = A(FIELD IN TOTAL RECORD)                
         ICM   R1,15,0(R6)         R1 = COST                                    
         XC    DRCMLIT,DRCMLIT     DEFAULT CPP = 0                              
         LTR   R1,R1                                                            
         BZ    OCOMP6                                                           
         ICM   RF,15,4(R6)         RF = DEMO                                    
         BZ    OCOMP6                                                           
         SR    R0,R0               CALCULTE CPP AT TOTAL LEVEL                  
         M     R0,=F'20'                                                        
         DR    R0,RF                                                            
         LTR   R1,R1                                                            
         BZ    OCOMP6                                                           
         BM    *+8                                                              
         AHI   R1,1                                                             
         SRA   R1,1                                                             
         STCM  R1,15,DRCMLIT       STORE CPP IN TOTAL RECORD                    
*                                                                               
OCOMP6   SR    RF,RF                                                            
         ICM   R1,15,DRCMLIT       GO BACK AND CALCULATE THIS VERT PCT          
         BZ    OCOMP8                                                           
         L     RE,GLADTENT                                                      
         L     R4,DROACOMP-DROD(RE)                                             
         CLI   DRCMTYPE,0          LOOK AT FIRST COMP EXPRESSION                
         BNE   OCOMP8                                                           
         CLI   DRCMOP,C'='                                                      
         BNE   OCOMP8                                                           
         ICM   R5,15,DRCMAIN                                                    
         BZ    OCOMP8                                                           
         L     RE,GLATHREC                                                      
         AH    RE,DRINDISP         RE = A(CPP FIELD IN CURRENT RECORD)          
         L     RF,0(RE)            RF = CPP                                     
         SR    RE,RE                                                            
         M     RE,=F'20000'                                                     
         DR    RE,R1                                                            
         LTR   RF,RF                                                            
         BM    *+8                                                              
*         LA    RF,1(RF)                                                        
         AHI   RF,1                NOT AN LA!!!                                 
         SRL   RF,1                                                             
*                                                                               
OCOMP8   CVD   RF,MYDUB            MOVE THIS VERT PCT TO DRIVER FIELD           
         MVC   0(8,R2),MYDUB                                                    
*                                                                               
OCOMP10  MVI   GLHOOK,GLEDIT       LET DRIVER EDIT                              
*                                                                               
OCOMPX   B     EXIT                                                             
         EJECT                                                                  
         DS    0D                                                               
MYDUB    DS    D                                                                
DOL      DS    PL8                 DOLLARS                                      
SVDOL    DS    PL8                 SAVED DOLLARS                                
PEN      DS    PL8                 PENNIES                                      
BIG      DS    PL16                                                             
BIG2     DS    PL16                                                             
DEM      DS    XL8                 DEMO VALUE (UNWEIGHTED/WEIGHTED)             
RTG      DS    D                   RATING (REGULAR/EQIVALENCED)                 
IMP      DS    D                   IMPRESSION (REGULAR/EQUIVALENCED)            
SVDEM    DS    F                   SAVED DEMO VALUE                             
CPP      DS    F                   CPP                                          
SVCPP    DS    F                   SAVE CPP                                     
CPPDEM   DS    F                   DEMO VALUE FOR CPP                           
*                                                                               
CUMCASH  DC    PL8'0'              ACCUMULATORS FOR CHILD SPOT                  
CUMTRADE DC    PL8'0'              DOLLAR COLUMNS                               
CUMDDOL  DC    PL8'0'                                                           
*                                                                               
VAL      DS    F                                                                
VALWGT   DS    F                                                                
SVRE     DS    F                                                                
ALVLSWS  DS    A                                                                
*                                                                               
COMSEQ1  DS    H                                                                
COMSEQ2  DS    H                                                                
COMSEQ3  DS    H                                                                
COMSEQ4  DS    H                                                                
COMSEQ5  DS    H                                                                
COMSEQX  DS    H                                                                
COMSW    DS    CL6                                                              
*                                                                               
INLEVEL  DS    XL1                                                              
EQUIV    DS    CL1                                                              
LASTSTAK DS    CL1                                                              
STACKTYP DS    CL1                                                              
SVCOMKEY DS    XL13                                                             
SVBUYKEY DC    XL13'00'                                                         
SVMCOMKY DS    XL13                                                             
SVCMKT   DS    XL2                                                              
SVCSTA   DS    XL3                                                              
*                                                                               
BIN4     DC    X'03',XL4'00000000'                                              
BIN8     DC    X'07',XL8'0000000000000000'                                      
PAK8     DC    X'07',PL8'0'                                                     
*                                                                               
WORK2    DS    CL100                                                            
SPTFLAG  DS    CL1                                                              
         SPACE 1                                                                
       ++INCLUDE DDEBLOCK                                                       
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
* ROUTINE TABLE                                                                 
*                                                                               
ROUTTAB  DC    S(OCOMPUTE)         001                                          
         DC    S(ODUMMY)                                                        
         DC    S(IMCOM)                                                         
         DC    S(OMCOM)                                                         
         DC    S(ICOM)             005                                          
         DC    S(OCOM)                                                          
         DC    S(IDR)                                                           
         DC    S(ICLREP)                                                        
         DC    S(OCLREP)                                                        
         DC    S(ICLDT)            010                                          
         DC    S(OCLDT)                                                         
         DC    S(ICLSEQ)                                                        
         DC    S(OCLSEQ)                                                        
         DC    S(ICLCHK)                                                        
         DC    S(OCLCHK)           015                                          
         DC    S(ICLCDT)                                                        
         DC    S(OCLCDT)                                                        
         DC    S(ISTDATA)                                                       
         DC    S(OSTDATA)                                                       
         DC    S(ISTDEM)           020                                          
         DC    S(OSTDEM)                                                        
         DC    S(ISTBDEM)                                                       
         DC    S(ISTBDEM)                                                       
         DC    S(ISTBDEM)                                                       
         DC    S(OSTBDEM)          025                                          
         DC    S(ISTDOL)                                                        
         DC    S(OSTDOL)                                                        
         DC    S(ISTACC)                                                        
         DC    S(OSTACC)                                                        
         DC    S(ISPT)             030                                          
         DC    S(ISPTPD)                                                        
         DC    S(ISPTUNPD)                                                      
         DC    S(ISPTBILL)                                                      
         DC    S(ISPTBLBL)                                                      
         DC    S(OSPT)             035                                          
         DC    S(OSPTBLBL)                                                      
         DC    S(IAUTH)                                                         
         DC    S(OAUTH)                                                         
         DC    S(IBYDOL)                                                        
         DC    S(IBYDOLTX)         040                                          
         DC    S(IBYDOLM)                                                       
         DC    S(IBYNET)                                                        
         DC    S(IBYCOM)                                                        
         DC    S(IBYCST)                                                        
         DC    S(IBYPAID)          045                                          
         DC    S(IBYPDTX)                                                       
         DC    S(IBYPDM)                                                        
         DC    S(IBYUNPD)                                                       
         DC    S(IBYUPDTX)                                                      
         DC    S(IBYUNPDM)         050                                          
         DC    S(IBYNETPD)                                                      
         DC    S(IBYNETUN)                                                      
         DC    S(IBYDEM)                                                        
         DC    S(IBYDEMB)                                                       
         DC    S(IBYDEMN)          055                                          
         DC    S(IBYDEM)                                                        
         DC    S(IBYDEM)                                                        
         DC    S(IBYDEM)                                                        
         DC    S(ODEMO)                                                         
         DC    S(IBYAR)            060                                          
         DC    S(IBYAR)                                                         
         DC    S(IBYAR)                                                         
         DC    S(OAR)                                                           
         DC    S(IBYCNT)                                                        
         DC    S(IGSTI)            065                                          
         DC    S(IGSTP)                                                         
         DC    S(IGSTU)                                                         
         DC    S(IGST)                                                          
         DC    S(IGSTB)                                                         
         DC    S(IGSTL)            070                                          
         DC    S(IGLDOL)                                                        
         DC    S(IGLNET)                                                        
         DC    S(IGLDEM)                                                        
         DC    S(ODEMO)                                                         
         DC    S(IORDOL)           075                                          
         DC    S(IORSPT)                                                        
         DC    S(IORDEM)                                                        
         DC    S(ODEMO)                                                         
         DC    S(ISLSPT)                                                        
         DC    S(ISLDOL)           080                                          
         DC    S(ISLDEM)                                                        
         DC    S(ODEMO)                                                         
         DC    S(IBYCPP)                                                        
         DC    S(IBYCPP)                                                        
         DC    S(IBYCPP)           085                                          
         DC    S(IGLCPP)                                                        
         DC    S(IORCPP)                                                        
         DC    S(ISLCPP)                                                        
         DC    S(OCPP)                                                          
         DC    S(IDEMNDX)          090                                          
         DC    S(ODEMNDX)                                                       
         DC    S(IDOLNDX)                                                       
         DC    S(ODOLNDX)                                                       
         DC    S(ICLAMT)                                                        
         DC    S(IBILL)            095                                          
         DC    S(IBILLCST)                                                      
         DC    S(IBILLNET)                                                      
         DC    S(IBILLCOM)                                                      
         DC    S(IBILLTAX)                                                      
         DC    S(IBILLM)           100                                          
         DC    S(IBILBL)                                                        
         DC    S(IBILBLC)                                                       
         DC    S(IBILBLNT)                                                      
         DC    S(IBILBLCM)                                                      
         DC    S(IBILBLTX)         105                                          
         DC    S(IBILBLM)                                                       
         DC    S(OBILBL)                                                        
         DC    S(IASSDOL)                                                       
         DC    S(IASSNET)                                                       
         SPACE 1                                                                
* CHILD SPOT ROUTINES                                                           
         DC    S(ICASH)            110                                          
         DC    S(OCASH)                                                         
         DC    S(ITRADE)                                                        
         DC    S(OTRADE)                                                        
         DC    S(IDDOL)                                                         
         DC    S(ODDOL)            115                                          
*                                                                               
         DC    S(0)                                                             
         DC    S(0)                                                             
         DC    S(0)                                                             
         DC    S(0)                                                             
*                                                                               
         DC    S(IBYNETM)          120                                          
         DC    S(IBYPAIDT)                                                      
         DC    S(INTBYCPP)                                                      
         DC    S(IBYSCPP)                                                       
         DC    S(IBILNVDT)                                                      
* NEW STATION LOCKIN KEYWORDS                                                   
         DC    S(ISLDOL2)          125                                          
         DC    S(ISLNET)                                                        
         DC    S(ISLNET2)                                                       
         DC    S(IBYSCPT)                                                       
* CHECK BANK CLEARED DATE                                                       
         DC    S(ICLCLRDT)         129                                          
         DC    S(OCLCLRDT)                                                      
         EJECT                                                                  
*                                                                               
STACKTAB DC    AL1(STSPACE),X'00',CL3' '                                        
         DC    AL1(STDIFF),C'DIFF'                                              
         DC    AL1(STNDX),C'INDX'                                               
         DC    AL1(STRTG),C'RTG '                                               
         DC    AL1(STIMP),C'IMP '                                               
         DC    AL1(STCPP),C'CPP '                                               
         DC    AL1(STCPM),C'CPM '                                               
         DC    AL1(STGOAL),C'GOAL'                                              
         DC    AL1(STGCPP),C'GCPP'                                              
         DC    AL1(STGDOL),C'GOL$'                                              
         DC    AL1(STGNDOL),C'GLN$'                                             
         DC    AL1(STORD),C'ORD '                                               
         DC    AL1(STOCPP),C'OCPP'                                              
         DC    AL1(STPUR),C'PUR '                                               
         DC    AL1(STAVPCH),C'APUR'                                             
         DC    AL1(STPCPP),C'PCPP'                                              
         DC    AL1(STACH),C'ACH '                                               
         DC    AL1(STAVACH),C'AACH'                                             
         DC    AL1(STRCPP),C'RCPP'                                              
         DC    AL1(STAFF),C'AFF '                                               
         DC    AL1(STAVAFF),C'AAFF'                                             
         DC    AL1(STACPP),C'ACPP'                                              
         DC    AL1(STGROSS),C'GRS '                                             
         DC    AL1(STNET),C'NET '                                               
         DC    AL1(STSPOTS),C'SPTS'                                             
         DC    AL1(STBUY),C'ORD '                                               
         DC    AL1(STPAID),C'PAID'                                              
         DC    AL1(STUNPD),C'UNPD'                                              
         DC    AL1(STBIL),C'BILL'                                               
         DC    AL1(STBILBL),C'BLBL'                                             
         DC    AL1(STPCPPN),C'NPCP'                                             
         DC    AL1(STRCPPN),C'NRCP'                                             
         DC    AL1(STACPPN),C'NACP'                                             
         DC    AL1(STCPPN),C'NCPP'                                              
         DC    AL1(STCPMN),C'NCPM'                                              
         DC    AL1(STPWPCT),C'PW %'                                             
         DC    AL1(STSLDOL),C'SL $'                                             
         DC    AL1(0)                                                           
         EJECT                                                                  
*                                  ** CPP FORMAT ROUTINE **                     
OCPPFMT  ST    RE,SVRE                                                          
         CLI   BYTE,0              TEST TRAILING CHARACTER SUPPLIED             
         JNE   OCPPFMT4            YES                                          
         MVI   BYTE,C' '                                                        
         CLI   SBSPPROF+4,C'Y'     TEST FOR EQUIV THE DETAIL LINES              
         JE    OCPPFMT2                                                         
         TM    DATAIND,DIDPTLEN    OR DOES DPT/LEN NOT FIGURE IN REPORT         
         JZ    OCPPFMT2            YES-THERE'S ALWAYS EQUIVALENCING             
         TM    GLINDS,GLTOTLIN     NO EQUIV ON DRIVER TOTAL LINE                
         JO    OCPPFMT4                                                         
         TM    OUTIND,OUTIDTOT     EQUIV IF THIS IS A DPTLEN TOTAL LINE         
         JZ    OCPPFMT4                                                         
OCPPFMT2 MVI   BYTE,C'+'           INDICATE A '+' FOR EQUIVALENCING             
OCPPFMT4 OC    DUB(4),DUB                                                       
         JZ    OCPPFMTX                                                         
         XC    EBLOCK,EBLOCK                                                    
         LA    R1,DUB                                                           
         ST    R1,EBAIN                                                         
         MVI   EBLIN,4                                                          
         MVI   EBTIN,C'B'                                                       
         ST    R3,EBAOUT                                                        
         LLC   R5,MYOLEN                                                        
         TM    DUB,X'80'           TEST NEGATIVE                                
         JZ    *+12                                                             
         MVI   EBOPT,EBOQMEY                                                    
         J     *+6                                                              
         BCTR  R5,0                                                             
         STC   R5,EBLOUT                                                        
         TM    COLIND2,COLINOCT                                                 
         JO    *+12                                                             
         MVI   EBDECS,2            2 DECIMAL PLACES                             
         J     *+8                                                              
         MVI   EBROUND,2           UNLESS ROUNDING OUT PENNIES                  
         OI    EBTRIM,EBTQROD      ROUND OFF DECIMALS IF TOO BIG                
         GOTO1 GLAEDITR,DMCB,EBLOCK                                             
         LA    R1,0(R3,R5)                                                      
         MVC   0(1,R1),BYTE        TRAILING CHARACTER                           
OCPPFMTX L     RE,SVRE                                                          
         BR    RE                                                               
         EJECT                                                                  
*                                  ** DEMO UNWEIGHT ROUTINE **                  
UNWEIGHT LR    R0,RE                                                            
         ICM   R1,15,TOTWGT        TOTAL WEIGHT                                 
         JZ    UNWTX                                                            
         ICM   RF,15,4(R5)         DEMO VALUE                                   
         JZ    UNWT2                                                            
         SR    RE,RE                                                            
         SLDA  RE,1                X2                                           
         DR    RE,R1               DIVIDE BY TOTAL WEIGHT                       
         AHI   RF,1                                                             
         SRA   RF,1                ROUND                                        
*                                                                               
UNWT2    ST    RF,0(R5)                                                         
*                                                                               
UNWTX    LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
*                                  ** MARKET WEIGHT ROUTINE **                  
*                                                                               
WGT      LR    R0,RE                                                            
         L     RF,VAL                                                           
         ICM   RE,15,SBMKTWGT                                                   
         MR    RE,RE                                                            
         ST    RF,VALWGT                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
*                                                                               
* CHECK WHETHER STACK ENTRY SHOULD PRINT OR NOT                                 
* INPUT  : R4=A(STACK DEFINITION ENTRY)                                         
* OUTPUT : CC EQ - PRINT THIS ENTRY                                             
*          CC NE - DROP THIS ENTRY                                              
*                                                                               
STCHK    LR    R0,RE                                                            
         TM    1(R4),X'80'         TEST DETAILS ONLY                            
         JZ    *+16                                                             
         TM    GLINDS,GLTOTLIN     YES-TEST TOTAL                               
         JO    STCHKNO             YES-IGNORE                                   
         J     STCHKYES                                                         
         TM    1(R4),X'40'         TEST TOTALS ONLY                             
         JZ    STCHKYES                                                         
         TM    GLINDS,GLTOTLIN     YES-TEST TOTAL                               
         JO    STCHKYES            YES-OK                                       
STCHKNO  LTR   RE,R0                                                            
         BR    RE                                                               
STCHKYES LR    RE,R0                                                            
         CR    RE,RE                                                            
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
         DROP                                                                   
***********************************************************************         
* ROUTINE TO TEST IF WE SHOULD REPORT A RATING OR IMPRESSION IN 2 DEC *         
* EXIT CC EQ IF WE SHOULD                                             *         
***********************************************************************         
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING SPSYSD2+X'2000',R8                                               
RPT2DEC  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RE,GLADTENT          A(THIS DRIVE TABLE ENTRY)                   
         L     RE,DROIADD-DROD(RE)  A(INPUT RECORD)                             
         USING DRIND,RE             INPUT RECORD DSECT                          
         XR    RF,RF                CLEAR RF                                    
         ICM   RF,1,DRINARGS+1      HAVE INPUT ARGS+1/DEMO CATEGORY?            
         BZ    R2DECNEQ             NO - RETURN CC NEQ                          
         DROP  RE                   DROP INPUT RECORD USING                     
*                                                                               
         BCTR  RF,0                 DEMO INDEX                                  
         MHI   RF,7                 INDEX TO DEMO NAME                          
*                                                                               
         TM    DATAIND5,DITARGET    TARGET DEMO IN HEADLINES?                   
         JZ    R2DEC10              NO                                          
*                                                                               
         LR    RE,RF                SAVE OFF RF (INDEX INTO DEMOS)              
*                                                                               
         CHI   RF,7                 TARGET OR TARGET2?                          
         JH    R2DEC05              NO                                          
         LA    RF,TGTDEM(RF)        EXTRACT DEMO NAME FROM TARGET               
         J     R2DEC06              GO TEST TARGET DEMO NAME                    
*                                                                               
R2DEC05  CHI   RF,21                TARGET3 OR TARGET 4?                        
         JH    R2DEC10              NO                                          
         SHI   RF,14                SUBTRACT FOR INDEXING TO TGTDEM3/4          
         LA    RF,TGTDEM3(RF)       EXTRACT DEMO NAME FROM TARGET               
*                                                                               
R2DEC06  OC    0(L'TGTDEM,RF),0(RF) TARGET DEMO NAMES SET?                      
         JNZ   R2DEC20              YES                                         
         LR    RF,RE                NO - NOT ALWAYS SET, USE DEMNAMES!          
*                                                                               
R2DEC10  LA    RF,DEMNAMES(RF)      POINT TO DEMO NAME                          
*                                                                               
R2DEC20  LR    RE,R9                A(SYSD)                                     
         CLI   0(RF),C'R'           RATING?                                     
         BE    *+12                 YES                                         
         CLI   0(RF),C'E'           EXTENDED RATING?                            
         BNE   R2DEC25              NO                                          
         AHI   RE,SBEFLAG4-SYSD     RF = SBEFLAG4                               
         TM    0(RE),SBE42DEC       2 DECIMAL RATINGS?                          
         B     *+12                 GO TEST CC                                  
R2DEC25  AHI   RE,SBEFLAG9-SYSD     RF = SBEFLAG9                               
         TM    0(RE),SBE92DEC       2 DECIMAL IMPRESSIONS?                      
         BNZ   R2DECEQU             YES - SET CC EQU                            
*                                                                               
R2DECNEQ LTR   RB,RB                SET CC NEQ                                  
         J     XIT                  EXIT                                        
*                                                                               
R2DECEQU CR    RB,RB               SET CC EQU                                   
         J     XIT                 EXIT                                         
*                                                                               
         LTORG                                                                  
         DROP                                                                   
***********************************************************************         
* IBYDOL ROUTINE MOVED FOR ADDRESSABILITY                             *         
***********************************************************************         
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING SPSYSD2+X'2000',R8                                               
         USING SCHUNKD,R4                                                       
*                                                                               
INBYDOL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LA    R6,BIN4             GROSS DOLLARS                                
         MVC   0(4,R2),SCGROSS                                                  
         L     R1,SCGSTI                                                        
         L     RF,SCPSTI                                                        
         BRAS  RE,GSTPSTI                                                       
         L     R1,SCGSTO                                                        
         L     RF,SCPSTO                                                        
         BRAS  RE,GSTPSTO                                                       
         BRAS  RE,BILPCT                                                        
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         DROP                                                                   
*                                                                               
***********************************************************************         
* BUYCPP ROUTINE MOVED FOR ADDRESSABILITY                             *         
***********************************************************************         
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING SPSYSD2+X'2000',R8                                               
         USING SCHUNKD,R4                                                       
*                                                                               
BUYCPP   NTR1  BASE=*,LABEL=*                                                   
         MVC   0(4,R2),BYGROSS     COST                                         
         CLI   GLARGS+5,X'02'      COST2?                                       
         BNE   *+10                NO                                           
         MVC   0(4,R2),BYCOST2     YES - COST2                                  
         CLI   GLARGS+5,X'03'      NET COST2?                                   
         BNE   *+10                NO                                           
         MVC   0(4,R2),BYNCOST2    YES - NET COST2                              
         MVC   4(4,R2),VAL         POINTS                                       
         MVC   8(4,R2),VALWGT      WEIGHTED POINTS                              
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         DROP                                                                   
*                                                                               
***********************************************************************         
* ROUTINE TO OUTPUT MCOM/SCOM RECORDS                                 *         
***********************************************************************         
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING SPSYSD2+X'2000',R8                                               
*                                                                               
OUTMCOM  NTR1  BASE=*,LABEL=*                                                   
         L     RE,GLATHID                                                       
         CLC   GLLEVEL,GLDETLEV-GLINTD(RE)   TEST TOTALING                      
         BL    OMCOMX              YES-NO PRINT                                 
         CLI   GLARGS,C'T'         DOING SCOM?                                  
         BNE   *+10                NO                                           
         MVC   FULL(3),1(R2)       YES - GET THE STATION                        
*                                                                               
         XC    KEY,KEY             COMMENT HEADER KEY                           
         LA    R2,KEY                                                           
         USING COMHDRD,R2                                                       
         MVC   COMKTYPE,=X'0D0C'                                                
         MVC   COMKAGY,SBBAGYMD                                                 
**NOP    MVI   COMCTYPE,C'M'                                                    
         MVC   COMCTYPE,GLARGS                                                  
         MVC   COMKCLT,SBBCLT                                                   
         LR    RF,R9                                                            
         AHI   RF,SBEFLAG3-SYSD                                                 
         TM    0(RF),SBE3BCOM      READ BCOM AT CLIENT LEVEL?                   
         BNZ   OMCOM1              YES, DO NOT FILL IN PRD/EST/MKT              
*                                                                               
         MVC   COMKPRD+2(1),SBBPRD                                              
         CLI   SBQBPRD,0           REQUESTED A SINGLE PRODUCT?                  
         BE    *+8                 NO                                           
         CLI   SBQBPRD,X'FF'       REQUESTED A SINGLE PRODUCT?                  
         BE    *+10                NO                                           
         MVC   COMKPRD+2(1),SBQBPRD FOR SINGLE PRD REQ SBBPRD CAN=X'FF'         
         MVC   COMKEST,SBBEST                                                   
         MVC   COMKMKT,SBBMKT                                                   
         CLI   GLARGS,C'T'         DOING SCOM?                                  
         BNE   *+10                NO                                           
         MVC   COMKSTA,FULL        YES - SCOM IS BY STATION                     
*                                                                               
OMCOM1   TM    DOWNOPT,DOWNON      DOWNLOADING?                                 
         BO    OMCOM1A             YES - ALWAYS PRINT!                          
         LA    R1,SVCOMKEY         MCOM SAVED KEY                               
         CLI   GLARGS,C'T'         DOING SCOM?                                  
         BNE   *+8                 NO                                           
         LA    R1,SVMCOMKY         SCOM SAVED KEY                               
         CLC   KEY(13),0(R1)       COMMENT HEADER KEY CHANGE?                   
         BNE   OMCOM1A             YES                                          
         CLC   SVCMKT,SBBMKT       MARKET CHANGED?                              
         BNE   OMCOM1A             YES                                          
         CLI   GLARGS,C'T'         DOING SCOM?                                  
         BNE   OMCOMX              NO, DONE                                     
         CLC   SVCSTA,FULL         STATION CHANGED?                             
         BE    OMCOMX              NO- DON'T PRINT                              
*                                                                               
OMCOM1A  GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     TEST COMMENT EXISTS                          
         BE    OMCOM1X             YES                                          
         MVC   KEY(13),KEYSAVE                                                  
         CLI   GLARGS,C'T'         DOING SCOM?                                  
         BNE   OCOM1B              NO                                           
         XC    DUB(3),DUB                                                       
         OC    COMKSTA,COMKSTA     YES - DID WE JUST LOOK FOR ALL MKT?          
         BZ    OMCOMX              YES - DONE                                   
         CLI   COMKSTA,X'00'       JUST LOOK FOR MKT SPECIFIC?                  
         BE    *+10                YES                                          
         MVC   DUB+1(2),SBBMKT     NO - LOOK FOR MARKET SPECIFIC SCOM           
         MVC   COMKSTA,DUB                                                      
         B     OMCOM1                                                           
*                                                                               
OCOM1B   OC    COMKMKT,COMKMKT     JUST LOOK FOR MARKET SPECIFIC                
         BZ    OMCOMX              NO, DONE                                     
         XC    COMKMKT,COMKMKT                                                  
         B     OMCOM1                                                           
*                                                                               
OMCOM1X  L     R2,AIO1             GET COMMENT HEADER                           
         ST    R2,AIO                                                           
         GOTO1 GETREC                                                           
         LA    R2,24(R2)                                                        
         L     R5,AIO2             BUILD FULL COMMENT STRING IN AIO2            
         XR    R0,R0                                                            
         XR    RF,RF                                                            
*                                                                               
OMCOM2   CLI   0(R2),0             FIND COMMENT ELEMENT                         
         BE    OMCOM6                                                           
         CLI   0(R2),5                                                          
         BE    OMCOM4                                                           
*                                                                               
OMCOM3   IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     OMCOM2                                                           
*                                                                               
OMCOM4   IC    RF,1(R2)                                                         
         AHI   RF,-3                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R5),2(R2)                                                    
         LA    R5,1(R5,RF)                                                      
         MVI   0(R5),C' '          LEAVE BLANK BETWEEN EACH CMT LINE            
         AHI   R5,1                                                             
         B     OMCOM3                                                           
*                                                                               
OMCOM6   L     RF,AIO2                                                          
         SR    R5,RF                                                            
         GOTO1 SQUASHER,DMCB,AIO2,(R5)                                          
         L     R5,4(R1)                                                         
         GOTO1 CHOPPER,DMCB,(0,AIO2),(MYOLEN,(R3)),(198,20),C'LEN=',   X        
               (R5)                                                             
*                                                                               
OMCOMX   LA    R1,SVCOMKEY         MCOM SAVED KEY                               
         MVC   SVCMKT,SBBMKT       SAVE CURRENT MARKET PROCESSED                
         CLI   GLARGS,C'T'         DOING SCOM?                                  
         BNE   *+14                NO                                           
         LA    R1,SVMCOMKY         SCOM SAVED KEY                               
         MVC   SVCSTA,FULL         SAVE CURRENT STATION PROCESSED               
         MVC   0(13,R1),KEY                                                     
         J     XIT                                                              
         DROP  R2                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* ROUTINE TO FORMAT SPOTS                                             *         
***********************************************************************         
         SPACE 2                                                                
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
         USING SPSYSD2+X'2000',R8                                               
*                                                                               
OSPTFMT  NTR1  BASE=*,LABEL=*      ** FORMAT SPOTS **                           
         XC    EBLOCK,EBLOCK                                                    
         ST    R1,EBAIN                                                         
         MVI   EBLIN,4                                                          
         MVI   EBTIN,C'B'                                                       
*                                                                               
         CLI   GLARGS,C'C'         CABLE AGG KEYWORD?                           
         BNE   OSPT10                                                           
         TM    GLINDS,GLTOTLIN     TEST TOTAL LINE                              
         BZ    OSPT4                NO                                          
         XC    DMCB(8),DMCB                                                     
         LA    R1,DMCB                                                          
         L     RE,GLADTENT                                                      
         MVC   0(1,R1),DROLEV-DROD(RE)                                          
         MVC   4(1,R1),GLLEVEL                                                  
         GOTO1 GETTOT,(R1)                                                      
         L     R1,EBAIN                                                         
         MVC   0(4,R1),DMCB                                                     
         B     OSPT10                                                           
*                                                                               
OSPT4    GOTO1 GETCBLCT            GET COUNT OF CABLE SYSTEMS                   
         BE    OSPT6                                                            
         SR    RF,RF                                                            
         B     OSPT8                                                            
*                                                                               
OSPT6    LLC   RE,BYTE                                                          
         ST    RE,FULL                                                          
         L     RE,0(R1)                                                         
         SR    RF,RF                                                            
         SRDA  RE,31                                                            
         D     RE,FULL                                                          
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AHI   RF,1                                                             
         SRA   RF,1                                                             
OSPT8    ST    RF,0(R1)                                                         
*                                                                               
         XC    DMCB(8),DMCB                                                     
         LA    R1,DMCB                                                          
         L     RE,GLADTENT                                                      
         MVC   0(1,R1),DROLEV-DROD(RE)                                          
         ST    RF,4(R1)                                                         
         GOTO1 PUTTOT,(R1)                                                      
         L     R1,EBAIN                                                         
*                                                                               
OSPT10   ST    R3,EBAOUT                                                        
         MVC   EBLOUT,MYOLEN                                                    
         TM    0(R1),X'80'         TEST NEGATIVE SPOTS                          
         BZ    *+8                                                              
         OI    EBOPT,EBOQMEY                                                    
         OI    EBTRIM,EBTQROD      ROUND OFF DECIMALS IF TOO BIG                
         GOTO1 GLAEDITR,DMCB,EBLOCK                                             
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        ROUTINE TO RETRIEVE BILL HEADER FOR STATION BILL ELEMENT     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
ISTABINV NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
*                                                                               
*        STATION BILLING RECORD ELEMENTS                                        
*                                                                               
         CLI   SBMODE,SBPROCBL     SKIP IF  NOT BILL                            
         BNE   ISTABINX                                                         
*                                                                               
         LA    R8,SBLOCK           ESTABLISH SPOT BLOCK                         
         USING SBLOCK,R8                                                        
*                                                                               
         L     R5,SBACURCH         ESTABLISH CURRENT STATION BILL ELM           
         USING STABELEM,R5                                                      
*                                                                               
         CLI   SBWRPROF+7,C'Y'     SKIP IF KEEPING REVERSED/REVERSALS           
         BNE   ISTBREVN                                                         
*                                                                               
         TM    STABINV,STABINV_REVERSAL+STABINV_REVERSED                        
         BNZ   ISTABINX                                                         
*                                                                               
ISTBREVN DS    0H                                                               
*                                                                               
*        FIND BILL HEADER RECORD                                                
*                                                                               
         MVC   ISTBKEY,KEY         SAVE CURRENT KEY                             
*                                                                               
         XC    KEY,KEY             BUILD BILL HEADER KEY                        
         LA    R3,KEY                                                           
         USING BILLRECD,R3                                                      
*                                                                               
         MVC   BKEYAM,SBBAGYMD     AGENCY/MEDIA                                 
*                                                                               
         MVC   BKEYCLT,SBBCLT                                                   
         MVC   BKEYPRD,SBPRD                                                    
         MVC   BKEYEST,SBBEST                                                   
         MVC   BKEYYSRV(2),STABPER                                              
*                                                                               
         GOTO1 DATCON,DMCB,(2,STABBDT),(1,FULL)                                 
*                                                                               
         GOTO1 DATCON,DMCB,(2,STABBDT),(3,DUB)                                  
*                                                                               
         SR    RF,RF                                                            
         IC    RF,DUB+1                                                         
         SLL   RF,28                                                            
         SRL   RF,28               RF=BILL MONTH                                
*                                                                               
         SR    RE,RE                                                            
         IC    RE,FULL                                                          
         SLL   RE,28                                                            
         SRL   RE,24               RE=BILL YEAR                                 
*                                                                               
         OR    RF,RE               COMBINE FOR YM                               
         STC   RF,BKEYMBIL                                                      
*                                                                               
         MVC   BKEYINV,STABINV                                                  
         NI    BKEYINV,X'FF'-(STABINV_REVERSAL+STABINV_REVERSED)                
*                                                                               
         SR    R0,R0               INIT SWITCH                                  
*                                                                               
*        RETRIEVE BILL HEADER FROM TSAROFF BUFFER                               
*                                                                               
ISTBBH20 DS    0H                                                               
*                                                                               
         ICM   R4,15,SBACSHRC      HAVE CASHIER CONTROL BLOCK?                  
         BZ    ISTABINX            NO, EXIT                                     
*        L     R4,SBACSHRC         POINT TO CASHIER CONTROL BLOCK               
         USING CSHIERD,R4          ESTABLISH AREA                               
*                                                                               
         MVI   CSHACT,CSHRDHQ      SET ACTION TO READ HIGH                      
         MVC   CSHAGYCH,SBAGY      SET AGENCY ALPHA                             
         MVC   CSHMED,SBMED        SET MEDIA                                    
*                                                                               
         ST    R3,CSHBLLA          SET A(BILLKEY)                               
*                                                                               
         GOTO1 SBACASHR,DMCB,CSHIERD    READ BILL RECORD                        
*                                                                               
         ICM   RF,15,CSHRECA       POINT TO FOUND RECORD                        
         BZ    *+14                NONE FOUND                                   
         CLC   BKEY,0(RF)          CHECK IF RECORD FOUND                        
         BE    ISTBBHFD                                                         
*                                                                               
*        ADD BILL HEADER TO BUFFER                                              
*                                                                               
*        FIRST RETRIEVE BILL HEADER                                             
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   BKEY,KEYSAVE                                                     
         BE    ISTBBH27                                                         
*                                                                               
         LTR   R0,R0               CONTINUE IF SWITCH NOT SET                   
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*        TO CORRECT FILE PROBLEM LOOK FOR BILL HEADER                           
*        WITH INVOICE NUMBER ONE LESS AND USE IT INSTEAD                        
*                                                                               
         LA    R0,1                SET SWITCH TO ALLOW ONLY 1 PASS              
*                                                                               
         MVC   BKEY,KEYSAVE        RESTORE ORIGINAL KEY                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,BKEYINV        DECREMENT INVOICE NUMBER                     
         BCTR  RF,0                DECREMENT NUMBER                             
         STCM  RF,3,BKEYINV                                                     
*                                                                               
         B     ISTBBH20            READ FOR PREVIOUS HEADER ON FILE             
*                                                                               
ISTBBH27 DS    0H                                                               
*                                                                               
         ICM   R0,15,AIO           SAVE CURRENT AIO                             
         L     R3,SBAIO2           READ BILL HEADER INTO IOA2                   
         ST    R3,AIO                                                           
         GOTO1 GETREC                                                           
         STCM  R0,15,AIO                                                        
*                                                                               
         MVI   CSHACT,CSHADDQ      SET ACTION TO ADD                            
*                                                                               
         ST    R3,CSHBLLA          SET A(BILL RECORD)                           
*                                                                               
         GOTO1 SBACASHR,DMCB,CSHIERD    ADD BILL RECORD TO BUFFER               
*                                                                               
         CLI   CSHERR,0            NO ERRORS TOLERATED                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   KEY,ISTBKEY         RESTORE INCOMING KEY                         
         GOTO1 HIGH                RESTORE FILE POINTERS                        
*                                                                               
ISTBBHFD DS    0H                                                               
*                                                                               
         L     R3,CSHRECA          POINT TO SAVED BILL HEADER RECORD            
         USING BILLRECD,R3                                                      
*                                                                               
         CLI   GLARGS+2,C'E'       IF EDI TRANSMIT DATE                         
         BNE   ISTBHEDN                                                         
*                                                                               
         MVC   0(2,R2),BEDIDTE        PUT OUT EDIOICE DATE                      
*                                                                               
         B     ISTBBHX                                                          
*                                                                               
ISTBHEDN DS    0H                                                               
         GOTO1 DATCON,DMCB,(0,BQDATE),(2,0(R2)) PUT OUT INVOICE DATE            
*                                                                               
ISTBBHX  DS    0H                                                               
*                                                                               
         MVC   2(2,R2),0(R2)       COPY DATE TO MAKE OPER HAPPY                 
         MVC   KEY,ISTBKEY         RESTORE INCOMING KEY                         
*                                                                               
ISTABINX DS    0H                                                               
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
*                                                                               
ISTBKEY  DS    XL(L'KEY)           KEY SAVEAREA                                 
*                                                                               
         DROP                                                                   
*                                                                               
***********************************************************************         
* ROUTINE TO APPLY CANADIAN INPUT GST/PST                             *         
* ENTRY R1 CONTAINS GST AMOUNT / RF CONTAINS PST AMOUNT               *         
*       R2=A(VALUE TO ADD GST/PST TO)                                 *         
***********************************************************************         
         SPACE 2                                                                
GSTPSTI  NTR1  BASE=*,LABEL=*                                                   
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
*                                                                               
         LA    RE,GLARGS                                                        
         TM    GLIIND-GLARGSD(RE),GLIIGSTI                                      
         BZ    GSTPSTIX                                                         
         TM    GLIIND-GLARGSD(RE),GLIIPST                                       
         BZ    GSTPSTI1                                                         
         L     RE,0(R2)            WANT THE PST ADDED                           
         AR    RE,RF                                                            
         ST    RE,0(R2)                                                         
GSTPSTI1 L     RE,0(R2)                                                         
         AR    RE,R1                                                            
         ST    RE,0(R2)                                                         
GSTPSTIX DS    0H                                                               
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         DROP                                                                   
***********************************************************************         
* ROUTINE TO APPLY CANADIAN OUTPUT GST/PST                            *         
* ENTRY R1 CONTAINS GST AMOUNT / RF CONTAINS PST AMOUNT               *         
*       R2=A(VALUE TO ADD GST OR PST TO)                              *         
***********************************************************************         
         SPACE 2                                                                
GSTPSTO  NTR1  BASE=*,LABEL=*                                                   
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
*                                                                               
         LA    RE,GLARGS                                                        
         TM    GLIIND-GLARGSD(RE),GLIIGSTO                                      
         BZ    GSTPSTOX                                                         
         TM    GLIIND-GLARGSD(RE),GLIIPST                                       
         BZ    GSTPSTO1                                                         
         L     RE,0(R2)            WANT THE PST ADDED                           
         AR    RE,RF                                                            
         ST    RE,0(R2)                                                         
GSTPSTO1 L     RE,0(R2)                                                         
         AR    RE,R1                                                            
         ST    RE,0(R2)                                                         
         LA    RE,GLARGS                                                        
GSTPSTOX DS    0H                                                               
         J     XIT                                                              
*                                                                               
         LTORG                                                                  
         DROP                                                                   
*                                                                               
BILPCT   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SYSD,R9                                                          
*                                                                               
         XR    R1,R1                                                            
         ICM   R1,3,BILLPCT        BILLED PERCENT                               
*                                                                               
         ZICM  RF,AXTCOLS,3        TEST EXTENDED COLUMN FILTERS                 
         BZ    BILXIT                                                           
         ZICM  RE,GLARGS+6,1       COLUMN NUMBER                                
         BZ    BILXIT              0 = NOT A COLUMN                             
         BCTR  RE,0                                                             
         MHI   RE,EXTCOLSL         INDEX TO TABLE                               
         AR    RF,RE                                                            
         USING EXTCOLSD,RF                                                      
         TM    EXTFLAG1,EXTLMG     LMG COLUMN QUALIFIER?                        
         BNZ   BIL05               YES                                          
         TM    EXTFLAG1,EXTREG     REGIONAL COLUMN QUALIFIER?                   
         BZ    BILXIT              NO                                           
*                                                                               
         SHI   R1,1000             GET LGM'S COMPLIMENT                         
         LCR   R1,R1               WANT POSITIVE PERCENTAGE                     
*                                                                               
BIL05    XR    R0,R0                                                            
         ICM   R3,15,0(R2)         GROSS VALUE                                  
         MR    R0,R3               TAKE LMG OR REG PERCENTAGE OF GROSS          
         D     R0,=F'1000'         DIVIDE BY 1000 FOR 2 DEC PRECISION           
         CHI   R0,500              HAVE REMAINDER >= 500?                       
         BL    *+8                 NO                                           
         AHI   R1,1                YES - ROUND UP BY 1 PENNY                    
         STCM  R1,15,0(R2)         STORE PERCENTAGE OF GROSS                    
*                                                                               
BILXIT   J     XIT                                                              
*                                                                               
         LTORG                                                                  
         DROP                                                                   
*                                                                               
CKGLDEM  NTR1  BASE=*,LABEL=*      ** CHECK GOAL DEMO **                        
*                                                                               
         USING GLOBALD,RA          GLOBALD DSECT                                
         USING GEND,RC             GEND DSECT                                   
         USING SYSD,R9             SYSD DSECT                                   
*                                                                               
         SR    RE,RE               CLEAR RE                                     
         ICM   RE,1,GLARGS+1       GLDEM-GLDEM8                                 
         BZ    *+6                 IF GLAGS=0, DON'T DECREMENT                  
         BCTR  RE,0                -1 FOR INDEX                                 
*                                                                               
         CLI   SBESTDEM+2,0        COMSCORE DEMO?                               
         BNE   CHKGD10             NO - PROCESS SBPDEMOS                        
*                                                                               
         MHI   RE,3                INDEX INTO SBPDEMOS                          
         LA    RF,SBPDEMOS         RF = SBPDEMOS                                
         LA    RF,0(RE,RF)         RE = DEMO IN SBPDEMOS LIST                   
         CLI   2(RF),0             IS THIS ALSO A COMSCORE DEMO?                
         BNE   CHKGDNEQ            NO - DEMOST DEFINITELY DON'T MATCH!          
*                                                                               
         LLC   RE,1(RF)            RE = INDEX OF COMSCORE IN SBPDEMOS           
         BCTR  RE,0                -1 FOR INDEX                                 
         MHI   RE,8                COMSCORE DEMO NAME IN COMDLIST               
         LR    R0,RE               SAVE INDEX                                   
*                                                                               
         LLC   RE,SBESTDEM+1       RE = INDEX INTO TARGET ESTIMATE              
         BCTR  RE,0                -1 FOR INDEX                                 
         MHI   RE,8                COMSCORE DEMO IN ACOMLSTG                    
*                                                                               
         ICM   RF,15,ACOMLSTG      HAVE ACOMLSTG?                               
         BZ    CHKGDNEQ            NO - SET CC NEQ                              
         LA    RF,0(RE,RF)         RF = COMSCORE DEMO NAME FROM EST             
*                                                                               
         LA    RE,COMDLIST         RE = COMDLIST                                
         AR    RE,R0               PLUS INDEX = DEMO NAME FROM MENU             
*                                                                               
         CLC   0(8,RE),0(RF)       MATCH ON COMSCORE DEMO NAMES?                
         B     CHKGD20             GO TEST CONDITION CODE                       
                                                                                
CHKGD10  MHI   RE,3                INDEX INTO SBPDEMOS                          
         LA    RF,SBPDEMOS         RF = SBPDEMOS                                
         LA    RE,0(RE,RF)         RE = DEMO IN SBPDEMOS LIST                   
         CLC   SBESTDEM(3),0(RE)   MATCH THE DEMOS                              
CHKGD20  BE    CHKGDEQU            IF EQUAL, SET LEVEL SWITCH & CC EQU          
*                                                                               
CHKGDNEQ LTR   RB,RB               SET CC NEQ                                   
         J     XIT                 EXIT                                         
*                                                                               
CHKGDEQU CR    RB,RB               SET CC EQU                                   
         J     XIT                 EXIT                                         
*                                                                               
         LTORG                                                                  
         DROP                                                                   
*                                                                               
IBILCOMM NTR1  BASE=*,LABEL=*      ** BILLED COMMISSION **                      
*                                                                               
         USING GLOBALD,RA          GLOBALD DSECT                                
         USING GEND,RC             GEND DSECT                                   
         USING SYSD,R9             SYSD DSECT                                   
         USING SPSYSD2+X'2000',R8  SECOND BASE REGISTER                         
*                                                                               
         LA    R6,BIN4             BILLED COMMISSION                            
         XC    0(4,R2),0(R2)       CLEAR INPUT FIELD                            
*                                                                               
         CLI   GLARGS+2,X'02'      WANT COST2 BILLED COMMISSION?                
         BNE   IBILLC05            NO                                           
         TM    SBEFLAG7,SBE7COS2   YES - IS THIS COST2?                         
         BZ    IBILCNEQ            NO - EXIT WITH CC NEQ                        
         B     IBILLC10            YES - PROCESS THIS RECORD                    
*                                                                               
IBILLC05 TM    SBEFLAG7,SBE7COS2   IS THIS COST2?                               
         BNZ   IBILCNEQ            YES - EXIT WITH CC NEQ                       
*                                                                               
IBILLC10 L     RE,SBBILGRS         COMMISSION = GROSS - NET                     
         L     RF,SBBILNET                                                      
         SR    RE,RF                                                            
         ST    RE,0(R2)                                                         
*                                                                               
IBILCEQU CR    RB,RB               SET CC EQU                                   
         J     XIT                 EXIT                                         
*                                                                               
IBILCNEQ LTR   RB,RB               SET CC NEQ                                   
         J     XIT                 EXIT                                         
*                                                                               
         LTORG                                                                  
         DROP                                                                   
*                                                                               
*        INCLUDE SPGENSTAB                                                      
*        INCLUDE SPGENREP                                                       
*        INCLUDE SPGENCOM                                                       
*        INCLUDE SPGENCLRST                                                     
*        INCLUDE SPMGAD                                                         
*        INCLUDE DRGLOBAL                                                       
*        INCLUDE DRIVETABLE                                                     
*        INCLUDE DRINTRECD                                                      
*        INCLUDE DDSPOOLD                                                       
*        INCLUDE DDSPLWORKD                                                     
*        INCLUDE SPWRIFFD                                                       
*        INCLUDE SPWRIF1D                                                       
*        INCLUDE MAAORLKD                                                       
*        INCLUDE SPPWBLOCK                                                      
*        INCLUDE DDCASHIERD                                                     
         PRINT OFF                                                              
       ++INCLUDE SPGENSTAB                                                      
REPRECD  DSECT                                                                  
       ++INCLUDE SPGENREP                                                       
COMHDRD  DSECT                                                                  
       ++INCLUDE SPGENCOM                                                       
       ++INCLUDE SPGENCLRST                                                     
       ++INCLUDE SPMGAD                                                         
       ++INCLUDE DRGLOBAL                                                       
       ++INCLUDE DRIVETABLE                                                     
       ++INCLUDE DRINTRECD2                                                     
       ++INCLUDE DDSPOOLD                                                       
       ++INCLUDE DDSPLWORKD                                                     
       ++INCLUDE SPWRIFFD                                                       
         ORG   CONTAGH                                                          
       ++INCLUDE SPWRIF1D                                                       
         PRINT ON                                                               
         EJECT                                                                  
       ++INCLUDE SPWRIWORKD                                                     
         EJECT                                                                  
* SPGENBUY                                                                      
         PRINT OFF                                                              
BUYRECD  DSECT                                                                  
       ++INCLUDE SPGENBUY                                                       
         PRINT ON                                                               
         SPACE 1                                                                
* SPGENGOAL                                                                     
         PRINT OFF                                                              
GOALRECD DSECT                                                                  
       ++INCLUDE SPGENGOAL                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* SPGENAGY                                                                      
         PRINT OFF                                                              
AGYRECD  DSECT                                                                  
       ++INCLUDE SPGENAGY                                                       
         PRINT ON                                                               
         SPACE 1                                                                
* SPGENINFO                                                                     
         PRINT OFF                                                              
       ++INCLUDE SPGENINFO                                                      
         PRINT ON                                                               
         SPACE 1                                                                
* SPGENBILL                                                                     
         PRINT OFF                                                              
BILLRECD DSECT                                                                  
       ++INCLUDE SPGENBILL                                                      
         PRINT ON                                                               
* MAAORLKD                                                                      
         PRINT OFF                                                              
       ++INCLUDE MAAORLKD                                                       
         PRINT ON                                                               
* SPPWBLOCK                                                                     
         PRINT OFF                                                              
       ++INCLUDE SPPWBLOCK                                                      
         PRINT ON                                                               
* DDCASHIERD                                                                    
         PRINT OFF                                                              
       ++INCLUDE DDCASHIERD                                                     
         PRINT ON                                                               
         SPACE 1                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'080SPSYSDRV2 11/08/19'                                      
         END                                                                    
