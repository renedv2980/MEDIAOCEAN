*          DATA SET PPREPB12D  AT LEVEL 067 AS OF 05/01/02                      
*CATALP PPB12D                                                                  
         TITLE 'ENDINV - END OF INVOICE'                                        
***********************************************************************         
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*                 *** THIS MODULE IS DEAD ***                                   
*                                                                               
*                                                                               
*              IT HAS BEEN REPLACED BY PPREPB102                                
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*                                                                               
***********************************************************************         
*        CHANGE LOG                                                             
*                                                                               
*  BPLA    10/00   FIX BUG IN PRETADJ                                           
*                  EDI CALL WITH VAT - USE SAVER4                               
*                  TO STORE AND RESTORE ADDRESS OF                              
*                  BILLING FORMULA FOR EDI CALL                                 
*                                                                               
*  BPLA   10/00    CHANGES TO PRINT UCOMM RECORD DATA                           
*                  UNDER UDEF DATA (END OF INV ONLY)                            
*                                                                               
*  BPLA   08/00    COPY OF PPREPB12D AT LEVEL 60 5/31/00                        
*                  COPY MADE 8/16/00                                            
*                  CHANGES TO CATALP AND PPREPB1WKN                             
*                  (WHICH INCLUDES PNNEWFILE IN PLACE OF                        
*                  PPNEWFILE)                                                   
*                  PNNEWFILE INCLUDES PNBILREC IN PLACE                         
*                  OF PBILLREC                                                  
*                                                                               
*  BPLA    05/00   USE AORWRK INSTEAD OF PCONREC                                
*                                                                               
*  BPLA   02/00    CHANGE AGENCY FEE OPTION                                     
*                  A- NOW MEANS PRINT "AGENCY FEE'                              
*                  P- NOW MEANS PRINT AGENCY FEE WITH PCT.                      
*                     (WHAT A USED TO DO)                                       
*                                                                               
*  BPLA   10/99    IN PRTUSER DON'T DO USER FIELDS THAT WILL                    
*                  APPEAR IN THE HEADLINES                                      
*                                                                               
*  BPLA   9/99     B2A PROF CHECK IN AORINV - LIST FORMAT                       
*                                                                               
*  BPLA   9/99     B2A PROFILE OPTION TO CONTROL                                
*                  BASIS OF COST 2 AOR BILLING                                  
*                  CONTRACT OR COST2                                            
*                                                                               
*  BPLA   6/99     CHANGES FOR COST2 FEATURE                                    
*                                                                               
*  BPLA   6/99     COPY OF PPB12D AT LEVEL 46 MADE 6/15/99                      
*                                                                               
*  BPLA   5/25/99  SPECIAL FOR JW - IN ADJSEP ALWAYS USE                        
*                  "SHOW ON BILL AS" BASIS (IF PRESENT)                         
*                  THEY DON'T CARE IF THE MATH DOESN'T WORK                     
*                  SEE **JW** FLAGS                                             
*                                                                               
*  BPLA   5/21/99  IN ADJINV ACTUALLY PRINT THE COMMISSION ADJ                  
*                  BASIS FROM ANY "SHOW NO BILL AS"                             
*                  FORMULA OVERRIDES (CHAB SCREEN)                              
*                  ONLY ALLOWED FOR COMISSION ADJUSTMENT OPTION                 
*                  THIS CHANGE MADE FOR JWT 5/21/99                             
****************                                                                
****************   WARNING                                                      
****************   IT MAY WELL ADVERSELY AFFECT OTHER USERS                     
****************   AS THE ADJUSTMENT AMONT DISPLAYED                            
****************   CERAINLY MAY NOT ALWAYS MATCH THE CALCULATION                
****************   DISPLAYED !!!!!!                                             
*                                                                               
*  BPLA   4/99    NEW VALUE FOR PROFB1A+1                                       
*                 'A' = ALWAYS PRINT 'AGENCY FEE' PLUS PERCENTAGE               
*                                                                               
*  BPLA   1/99    FIX BUG IN PRTUSER-WAS PRINTING 2ND PRODUCT                   
*                 USER FIELD AT FRONT OF INVOICE WHEN IT SHOULDN'T              
*                                                                               
*                                                                               
*  BPLA   10/98   PRTUSER MOVED TO IT'S OWN CSECT AND                           
*                 CODE FOR PRINTING SOME USER COMMENTS                          
*                 AT FRONT OF INVOICE                                           
*                 PLUS EDI CALLS IN PRTAAAU                                     
*                                                                               
*  BPLA   10/98   RENAMED FROM PPB12DE                                          
*                                                                               
*  BPLA   8/98    CHANGES FOR SFM BILLING FORMULA RECS                          
*                                                                               
*  BPLA   7/98    CHANGES FOR EDITING BFCOMP AND BFPCOMP                        
*                 TO ALLOW FOR VALUES OVER 99.9999                              
*                                                                               
*  BPLA   5/98    CD SEPARATE EDI CALLS                                         
*                                                                               
*  BPLA   3/98    MULTI-MEDIA - SUPPRESS JOB TOTALS                             
*                 IF ONLY ONE MEDIA HAD BILLING                                 
*                 EDI IMPROVEMENTS                                              
*                                                                               
*  BPLA   1/98    CHANGES FOR EDI BILLING                                       
*                                                                               
*  BPLA   12/97   ADD DUMMY CSECT AT END                                        
*                                                                               
*  BPLA  9/97     CHANGES TO AORINV TO HANDLE MULTI-MEDIA                       
*                                                                               
*  BPLA  5/97     WESTERN OPTION TO SUPPRESS $                                  
*                 UNLESS AT END OF INVOICE                                      
*                                                                               
*  BPLA  2/97     ADDITIONAL WORK ON AOR BILL COMMENTS                          
*                                                                               
*  BPLA 10/96     CODE TO DISPLAY STANDARD COMMENT ATTACHED                     
*                 TO AOR RECORD                                                 
*                                                                               
*  BPLA 9/96      PPB12DO SOURCE MADE LIVE - NOW INCLUDES PPREPB1WRK            
*                 NEEDS PPB1ACC                                                 
*                                                                               
*  BPLA 3/96      IN PRTADJ - IF DOING SPECIAL CD HANDLING                      
*                 AND CD IS A CREDIT, I MUST ADD TOTVAT                         
*                 TO R0 BEFORE SUBTRACTING THE CD                               
*                 SO "ACTUAL AMOUNT" WILL BE CORRECT                            
*                 ALSO - NO-OP CHECK FOR MANUAL PCT OF LESS                     
*                 THAN 20 AT BCA4                                               
*                                                                               
*  BPLA 8/95      NEW OPTION ON B1A PROFILE                                     
*                 'Y' MEANS ALWAYS DISPLAY "COMMISSION ADJUSTMENT"              
*                 INSTEAD OF "+ (OR -) NNN.NN PCT. OF..."                       
*                                                                               
*  BPLA 8/10/95   DISPLAY TOTAL OF BASIS AMOUNTS ON PRD/EST LIST                
*                 AOR BILL                                                      
*                                                                               
*  BPLA 4/26/95   CHANGE FOR NET BASIS ON AOR BILLING                           
*                                                                               
*  BPLA 3/2/95    FIX BUG IN BILCALC - PST BASIS WAS WRONG WHENEVER             
*                 THERE WAS ZERO BILLABLE FOR A MONTH                           
*                 FIX - SET A SWITCH (PVATSW) IF THERE IS VAT BILLABLE          
*                 AND CHECK IT AT BC4 BEFORE CHECK FOR BILLABLES                
*                                                                               
*  BPLA 1/12/95   FIX BUG IN PRTADJ - FOR RETAIL AT PA25-PA26                   
*                                                                               
*  BPLA 10/5/94   IN ENDINV - ONLY RESET FINANSW TO FININVSW                    
*                 IF MULTI-MEDIA BILL                                           
*                                                                               
*  BPLA 9/20/94   FIX RETAIL BUG                                                
*                 ALSO SET PEPTFIN IN BCADD (IF FINANCIAL)                      
*                                                                               
*  BPLA 9/94      ADDITIONAL FIX FOR CDSEP OPTIONS C AND R                      
*                                                                               
*  BPLA 8/94      FOR CDSEP OPTIONS C AND R                                     
*                 REMOVE CD FROM BILL FORMULA BASIS                             
*                 ONLY WHEN PRINTING BASIS                                      
*                                                                               
*  BPLA 8/94      FIX BUG IN PRTADJ  (NEAR PA27A18E)                            
*                 CLI  ADJDSP,C'Y' SHOULD HAVE BEEN                             
*                 CLI  ADJSEP,C'Y'                                              
*                                                                               
*  BPLA 8/94      CODE TO HANDLE SUPPRESSION OF COMMENTS                        
*                 BY BILLING TYPES                                              
*                                                                               
*  BPLA 6/94      FIX BUG IN PRTADJ AT PA3B5                                    
*                 CHANGE CLC BFBASA(2),FFS TO CLI BFBASA,=X'FF'                 
*                 ALSO - ADJUST R2 IF DOING ONE TYPE AND CAT                    
*                                                                               
*  BPLA 6/94      FIX BUG IN LSTINV AT LI34                                     
*                 CLI  DOLNUM,2 WAS BE TO L130C INSTEAD OF LI34C                
*                                                                               
* BPLA 6/94       SET VATPSW TO 'Y' AFTER PRINTING VATS IN PRTADJ               
*                                                                               
* BPLA 6/94       SPECIAL CODE AROUND SOME GOTO GETNUMS                         
*                                                                               
* BPLA 6/8/94     FIX BUG IN PRTADJ - SAVE R4 IN SAVER4 NOT FULL                
*                                                                               
* BPLA 2/94       CHANGES FOR PST                                               
*                                                                               
* BPLA 1/25/94    IN SPECIAL CD HANDLING LOGIC                                  
*                 REMOVE THE ADJUSTMENT (IF ITS ON A SEPARATE BILL)             
*                 FROM THE 'ACUTAL AMOUNT' DATA                                 
*                                                                               
* BPLA 1/20/94    ON ADJ SEP BILL FIX "AMOUNT BILLED ON INVOICE" MESS.          
*                 CHECK LENGTH OF LASTPINV                                      
*                                                                               
* BPLA 10/18/93   NEW VALUES FOR RETPROF+13                                     
*                 "Y" = (OLD) SUPPRESS DISTRB ADJ AMTS (AMT DUE ONLY)           
*                 "I" = SUPPRESS $ ON DISTRIBUTOR BILLS (TOTOUT)                
*                 "B" = SUPPRESS $ ON DISTB BILLS AND NO ADJ AMTS               
*                                                                               
* BPLA 10/5/93    CHANGES FOR NEW CDSEP OPTION - R -                            
*                 USES APPLY INSTEAD OF DEDUCT IN CD MESSAGE                    
*                 PP@ACASH FOR PP@DCASH AND MAKES POSITIVE CD'S                 
*                 CR'S.                                                         
*                                                                               
* BPLA 10/1/93    CHANGES TO PRTUSER - IF PRD NOT "S"                           
*                 THE FIND AND PRINT PRD "AAA" USER FIELDS                      
*                 ALSO, IF PRD NOT "S" AND EST IS "S"                           
*                 THEN FIND AND PRINT "AAA" EST USER FIELDS                     
*                                                                               
* BPLA 9/30/93    CHANGE TO PP#GSTAC - 9 CHARS INSTEAD OF 15                    
*                                                                               
* BPLA 9/29/93   IN PRTADJ ADJUST DISPLACEMENT (SAVED IN WORD)                  
*                IF NOT AT END OF INVOICE - SO GST MESSAGE WON'T                
*                WRAP AROUND INTO PRIOR PRINT LINE                              
*                                                                               
* BPLA 5/10/93   DISPLAY USER FIELDS WITH COMMENTS                              
*                                                                               
* BPLA 4/7/93    USE FORMULA EVEN FOR FINANCIAL REBATE BILLING                  
*                BUT SET TO GROSS IF I HAVE NONE                                
* BPLA 3/4/93    NO-OP CODE THAT SET BILLING FORMULA TO                         
*                GROSS FOR REBATE BILLS IN BILLCALC                             
*                                                                               
* BPLA 1/7/93    NEW PROFILE BTYE (PROFB2B+4) TO CONTROL                        
*                CD ON NET BILL                                                 
*                                                                               
* BPLA 12/21/92  CD SEP CONTROL FOR UFC BILLING                                 
*                                                                               
* BPLA 10/23/92  BUG FIXED IN PRTADJ (PA27A18C)  *+12 TO *+14                   
*                                                                               
* BPLA 8/4/92    NEW RETAIL DISTRIBUTOR BILL OPTIONS                            
*                1) SELECTIVELY SUPPRESS COMMENTS (RETPROF+10)                  
*                2) OPTIONALLY SUPPRESS BILL DETAILS (RETPROF+13)               
*                                                                               
* BPLA 7/9/92    CHANGES TO CHECK PBBILST (IN PBILELEM) FOR UFC                 
*                INSTEAD OF X'46' ELEMS                                         
*                                                                               
* BPLA 6/16/92   ADD CHK FOR SCBNCSW = C'N' IN AORINV                           
*                AT PA21 ADD CHK FOR SCBNCSW = C'C'                             
*                                                                               
* BPLA 4/30/92   CHANGES FOR COMMISSION BILLING                                 
*                                                                               
* BPLA 4/20/92   COPY OF PPB12DL                                                
*                                                                               
* BPLA 2/6/92    FIX BUG IN AORINV - MUST BUMP INVNO AT AOI80 IF                
*                AORLOPT IS "C"                                                 
* BPLA 1/28/92   REACTIVATE DISPLAY OF GST PCTS ON AOR PRD/EST                  
*                LIST BILL - CAN DO SINCE THEY WILL HAVE SAME CODE              
*                                                                               
* BPLA 1/20/92   IN PRTADJ PRINT "AMOUNT DUE FOR" IF PRDS                       
*                TOGETHER WITH GST CODE                                         
*                ALSO SUPPRESS PRINTING OF GST %                                
*                                                                               
* BPLA 10/25/91  CLEAR P2 AND P3 WHEN DOING INV TOTALS (EI4X)                   
*                                                                               
* BPLA 10/17/91  FIX RETAIL GST SHARE CALC                                      
*                                                                               
* BPLA 7/22/91   FIX "BILLED TO.... " INVOICE NUMBER DISPLAY ON OLD             
*                STYLE  AOR BILL                                                
* BPLA 7/8/91    FIX RETAIL TAX BUG                                             
* BPLA 7/8/91    IN SAVCORP DON'T MOVE AC INTO SORTDATA                         
*                NOW MOVE TAX                                                   
*                CHANGE TO BILCALC (BC7D) TO STORE CALCULATED TAX               
*                SHARE AND NOT TO CALUCLATE IF UPASS = S                        
*                                                                               
* BPLA 6/13/91   FIX TO PPSIF01 LOGIC + PP@DCASH NOW 26 CHARS                   
*                                                                               
* BPLA 5/17/91   AOR KILL DATE AND VAT CODE CHANGES                             
*                PLUS BILLING FORMULA DISPLAY OVERRIDE FIELDS                   
*                BILPADJ AND BILPBASB (USED JUST TO PRINT ON BILL               
*                NOT FOR CALCULATION)                                           
*                                                                               
* BPLA 5/2/91    CHANGES INVOLVING PPSIF01,PP@IF01,PP@LESS                      
*                                                                               
* BPLA 3/26/91   DRAFT REBATE BILLING  (RD)                                     
*                                                                               
* BPLA 3/12/91   NEW AOR FEATURES AORLOPT (C) AND AORTXOPT                      
*                                                                               
* BPLA 9/7/90    DON'T DISPLAY CD MESSAGES IF F BFBASIS AGYCOMM                 
*                                                                               
*                ALSO SHOW "**ACTUAL AMOUNT**' EVEN IF CD IS IN                 
*                BFBASA AND  CD IS CREDIT                                       
*                                                                               
*                                  ENDINV - END OF INVOICE                      
***      PRINT NOGEN                                                            
         SPACE 2                                                                
ENDINV   CSECT                                                                  
         NMOD1 0,ENDINV                                                         
         USING PPWORKD,RA                                                       
         L     R9,PPWORK2C                                                      
         USING PPWORK2D,R9                                                      
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
         USING BRKTABD,R3                                                       
         SPACE 2                                                                
*                                                                               
*              MUST STILL GO TO BILCALC                                         
*              ON SECOND PASS - IF DOING ADJSEP AND DETAIL RECAP                
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUM                               
         AH    R7,=Y(MAXMOS*ROWL)  POINT TO TOTAL ROW                           
**NEW 10/27/89  WAS (16) NOW (40)                                               
         OC    ADJDSP(8,R7),ADJDSP(R7)  TEST FORMULA CALCS DONE                 
         BNZ   EI4                 YES                                          
         OC    AORDSP(8,R7),AORDSP(R7)  TEST FORMULA CALCS DONE - AOR           
         BNZ   EI4                 YES                                          
         OC    RETADSP(72,R7),RETADSP(R7) TEST FORMULA CALCS DONE - RET         
         BNZ   EI4                 YES                                          
         OC    VATDSP(176,R7),VATDSP(R7) TEST FORMULA CALCS DONE - VATS         
         BNZ   EI4                 MAIN,ADJ,AOR,CD (44 BYTES EACH)              
         OC    VATBDSP(176,R7),VATBDSP(R7) TEST FORMULA CALCS - BASIS           
         BNZ   EI4                 MAIN,ADJ,AOR,CD (44 BYTES EACH)              
*                                  CKECKS AOR,RETAIL FIELDS,VAT FIELDS          
         GOTO1 ABILCALC            NO - DO THEM NOW                             
EI4      DS    0H                                                               
*                                                                               
         MVC   SVFINSW,FINANSW     SAVE FINANCIAL SWITCH                        
*                                                                               
         OC    AMED,AMED           SEE IF DOING MULTI-MEDIA BILL                
         BZ    *+10                                                             
         MVC   FINANSW,FININVSW    USE INVOICE FINANCIAL SWITCH                 
*                                                                               
*                                                                               
         CLI   PASSNO,1                                                         
         BNE   EI8                                                              
         CLI   DUESW,C'Y'          TEST AMT DUE PRINTED                         
         BE    EI6                                                              
         CLI   TOTSW,C'Y'          TEST HAVE PRINTED INV TOTS                   
         BE    EI5                                                              
         CLI   NDUES,1             BYPASS REPEAT OF TOTALS IF                   
         BE    EI5                 EXACTLY 1 DUE LEVEL PRINTED                  
         CLI   JOBCTL,C'S'                                                      
         BE    EI4C                                                             
         CLI   PUBCTL,C'S'                                                      
         BNE   EI4X                                                             
EI4C     CLC   P1(10),SPACES     IF JOB OR PUB SEPARATE                         
         BE    EI4X              MAY STILL NEED TO PRINT THEM                   
         GOTO1 APRNT                                                            
*                                                                               
EI4X     MVI   PRSW,C'H'           SET TO HOLD LINES                            
         MVC   P1,SPACES            P1,P2,P3  MIGHT STILL HAVE AN               
         MVC   P2,SPACES            UNUSED PRODUCT FOR RETAIL                   
         MVC   P3,SPACES                                                        
*                                                                               
*        SEE IF RETAIL                                                          
*        MUST CHECK IF I'M SUPPRESSING DISTRIBUTOR BILL DETAILS                 
*                                                                               
         CLI   RETPROF,0                                                        
         BE    EI4X9                                                            
         CLI   RETPROF+13,C'Y'   SEE IF SUPPRESSING DISTRIB DETAILS             
         BE    EI4X7                                                            
         CLI   RETPROF+13,C'B'   SEE IF SUPPRESSING DISTRIB DETAILS             
         BNE   EI4X9             AND $                                          
EI4X7    CLI   UPASS,1         SEE IF CORP                                      
         BE    EI4X9                                                            
         CLI   UPASS,C'S'      SEE IF CORP SUMMARY                              
         BE    EI4X9                                                            
         B     EI5             MUST BE DISTRIBUTOR                              
*                                                                               
EI4X9    DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   P1(12),=C'** TOTALS **'                                          
         MVC   P1(L'PP@TOTS),PP@TOTS                                            
         DROP  RE                                                               
         MVC   TOTSTAR,=C'**'                                                   
         GOTO1 ATOTOUT                                                          
         MVC   TOTSTAR,SPACES                                                   
EI5      DS    0H                                                               
*                                  TEST NEED TO SAVE CORP DATA NOW              
         CLI   SUMLEV,C'I'                                                      
         BE    EI5B                                                             
         CLI   SUMLEV,0                                                         
         BH    EI5D                ALREADY SAVED AT LOWER LEVEL                 
         MVI   SUMLEV,C'I'         CORP DATA SAVED AT INVOICE LEVEL             
EI5B     DS    0H                                                               
         GOTO1 ASAVCORP                                                         
EI5D     DS    0H                                                               
         GOTO1 APRTADJ             NO - DO IT NOW                               
EI6      DS    0H                                                               
         MVI   CNMTCD,C'R'         PRINT REGULAR COMMENTS                       
         GOTO1 APRTCMNT                                                         
         GOTO1 AWBILL              ADD OLD STYLE BILL RECS                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   EI7                                                              
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI FOR EACH INVOICE          
**EDI**                                                                         
*                                                                               
EI7      MVC   SINVNO(12),INVNO                                                 
         OC    ARECAP,ARECAP       FOR RECAP PASS                               
         BNZ   EI10                DONT BUMP INV NO                             
EI8      DS    0H                                                               
*                                                                               
         MVC   LASTPINV,PINVNO     SAVE INV NO FOR SEPARATE                     
***NEW 5/21/91                                                                  
***      ORDER OF BILLS CHANGED                                                 
***      WAS ADJ/CD/AOR                                                         
***      NOW AOR/ADJ/CD                                                         
***                                                                             
         CLI   AORSW,C'Y'                                                       
         BNE   EI9                                                              
         CLI   UPASS,1            IF RETAIL AND NOT "CORP" BILL                 
         BH    EI9                NO AOR BILL                                   
         MVI   AORLCTL,0                                                        
         GOTO1 AAORINV                                                          
*                                                                               
EI9      DS    0H                                                               
         CLI   ADJSEP,C'Y'         ADJ OR CD INV                                
         BNE   EI9B                                                             
         GOTO1 AADJINV                                                          
*                                                                               
EI9B     DS    0H                                                               
         CLI   CDSEP,C'Y'                                                       
         BNE   EI9D                                                             
         GOTO1 ACDINV                                                           
*                                                                               
EI9D     DS    0H                                                               
*                                                                               
         CLI   TEST,C'T'                                                        
         BE    EI10                                                             
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO                                        
EI10     DS    0H                                                               
*                                                                               
         MVC   FINANSW,SVFINSW     RESTORE FINANSW                              
*                                                                               
         CLI   PASSNO,1            SEE IF PASS 1                                
         BNE   EI15                                                             
         OC    ARECAP,ARECAP       AND DOING DETAIL BACK-UP                     
         BZ    EI15                                                             
         IF    ADJSEP,EQ,C'Y',OR,CDSEP,EQ,C'Y',OR,AORSW,EQ,C'Y',EI18            
*                                                                               
*              CAN'T CLEAR PEPTAB IF DOING ADJSEP OR CDSEP OR AORINV            
*              WITH DETAIL BACK-UP                                              
*                                                                               
EI15     DS    0H                                                               
**NEW 3/12/91                                                                   
         CLI   AORLOPT,C'C'                                                     
         BE    *+10                                                             
**NEW 3/12/91                                                                   
         XC    PEPTABN,PEPTABN     CLEAR PEPTAB                                 
EI18     MVI   DUESW,C'N'                                                       
         MVI   TOTSW,C'N'                                                       
         MVI   SUMLEV,0                                                         
         MVI   ACTSW,C'Y'          SET ACTIVITY FOR REQ                         
         MVC   PAGE,=H'1'                                                       
         MVI   NDUES,0                                                          
         MVI   FORCEHED,C'Y'                                                    
         MVC   MKTCTL,SVMKTCTL                                                  
         XC    CVATPSWS,CVATPSWS                                                
         MVC   LASTPRD,=X'FFFFFF'                                               
*                                                                               
EIX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SAVCORP'                                                        
SAVCORP  CSECT                                                                  
         NMOD1 0,SAVCORP                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   SUMOPT,C'Y'                                                      
         BNE   SAVCX                                                            
         CLI   UPASS,1             MUST BE RETAIL AND CORP                      
         BNE   SAVCX                                                            
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUM                               
         LA    R4,MAXMOS                                                        
SAVC2    DS    0H                                                               
**8/29/88                                                                       
         OC    RETADSP(20,R7),RETADSP(R7) CHK FOR ADJ,GROSS,NET,CD,AC           
         BZ    SAVC3                       SKIP IF ALL ZEROS                    
**8/29/88                                                                       
**8/29/88 NO-OPED                                                               
**       L     R0,RETADSP(R7)                                                   
**       LTR   R0,R0                                                            
**       BZ    SAVC3                                                            
**8/29/88 NO-OPED                                                               
*                                                                               
         BAS   RE,SAVCW                                                         
*                                                                               
SAVC3    DS    0H                                                               
         LA    R7,ROWL(R7)         NEXT MONTH                                   
         BCT   R4,SAVC2                                                         
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'HIGH',ABUFFC,THISREC,0                           
*                                                                               
*                                  SET PRD IN LIST FOR S PASS                   
         L     RE,APRD                                                          
         L     RF,APDLIST                                                       
*                                  FIND NEXT AVAILABLE ENTRY                    
SAVC4    CLI   0(RF),0                                                          
         BE    SAVC5                                                            
         CLC   0(3,RF),0(RE)       SEE IF PRODUCT ALREADY THERE                 
         BE    SAVCX                                                            
         LA    RF,3(RF)                                                         
         B     SAVC4                                                            
*                                                                               
SAVC5    MVC   0(3,RF),0(RE)       SAVE PRD IN ACTIVE PRD LIST                  
*                                  FOR RETAIL SUMMARY PASS                      
SAVCX    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
SAVCW    NTR1                                                                   
*                                                                               
*                                                                               
*                                  THEN SAVE CURRENT INVOICE NUMBER             
*                                  IN BUFFALO TABLE                             
         L     R6,ABUFFC                                                        
         USING BUFFALOD,R6                                                      
         MVC   SORTREC,OLDREC      USE LAST RECORD                              
         LR    RF,R4                                                            
         SH    RF,=Y(MAXMOS)                                                    
         LPR   RF,RF                                                            
         L     RE,APER                                                          
         STC   RF,0(RE)                                                         
         L     RF,APUB                                                          
         XC    0(6,RF),0(RF)                                                    
*                                                                               
*                                                                               
         L     RF,ASORTCOM                                                      
         MVC   0(2,RF),TODAYB      YR/MTH                                       
         MVC   2(2,RF),INVNO       INV. NO.                                     
         L     RF,ASORTDTA                                                      
         XC    0(ROWTL,RF),0(RF)                                                
         MVC   0(16,RF),RETADSP(R7)  ACT,GROSS,NET,CD                           
*** NOTE THAT RETAIL AGY COMM SHARE IS NOT PASSED                               
         MVC   16(4,RF),RETTDSP(R7)    STORE RETAIL TAX SHARE                   
*                                      BILCALC FIXED TO NOT                     
*                                      RECALCULATE                              
         MVI   BUFFDOPT,C'Y'       SET TO REPLACE COMMENT                       
*                                                                               
         GOTO1 ATOSORT                                                          
         MVI   BUFFDOPT,C'N'                                                    
SAVCWX   DS    0H                                                               
         B     SAVCX                                                            
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'TOTOUT - PRINT TOTALS FOR LEVEL'                                
*                                                                               
TOTOUT   CSECT                                                                  
         NMOD1 0,TOTOUT                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         CLI   WIOPT,C'Y'           WESTERN SUPPRESS $ OPTION                   
         BNE   TOUT1                                                            
         C     R3,AINVBRK           SEE IF AT END OF INVOICE                    
         BNE   TOUT2A              SAME AS PART OF RETAIL OPTION                
*                            SHOW INS DETAILS BUT NO OTHER TOTALS               
*                            AND NO COSTS                                       
TOUT1    DS    0H                                                               
         CLI   RETPROF,0            SEE IF RETAIL                               
         BE    TOUT2X                                                           
         CLI   RETPROF+13,C'I'      SEE IF SUPPRESSING $ ON DISTRB              
         BE    TOUT2                                                            
         CLI   RETPROF+13,C'B'     OR BOTH $ AND ADJ AMOUNTS                    
         BNE   TOUT2X                                                           
TOUT2    CLI   UPASS,1            SEE IF CORP BILL                              
         BE    TOUT2X                                                           
         CLI   UPASS,C'S'         SEE IF CORP SUMMARY BILL                      
         BE    TOUT2X                                                           
*                                                                               
TOUT2A   CLI   BRKCODE+3,DESCEQ    SEE IF BUY DETAIL                            
         BNE   TOUT2C                                                           
         MVI   SPACING,2                                                        
         GOTO1 APRNT              MUST PRINT THEM                               
         B     TOUTX              FLUSH PRINT LINES AND EXIT                    
*                                 MUST BE DISTRIBUTOR BILL                      
TOUT2C   MVC   P1,SPACES          CLEAR PRINT LINES AND EXIT                    
         MVC   P2,SPACES                                                        
         B     TOUTXX                                                           
*                                                                               
TOUT2X   DS    0H                                                               
***NEW                                                                          
         C     R3,AINVBRK          LEAVE ** FOR INVOICE TOTALS                  
         BE    TOUT3                                                            
         OC    ARECAP,ARECAP       SEE IF DOING BACK-UP                         
         BZ    TOUT3                                                            
         CLI   PASSNO,2                                                         
         BE    TOUT3                                                            
         MVC   TOTSTAR,SPACES      NO ** ON MAIN BILL IF DOING DETAIL           
*                                  BACK-UP                                      
***NEWEND                                                                       
*                                                                               
TOUT3    MVI   TOTSW,C'N'                                                       
         C     R3,AINVBRK                                                       
         BNE   *+8                                                              
         MVI   TOTSW,C'Y'          SET HAVE PRINTED INV TOTS                    
         MVI   PRSW,C'M'           SET TO 'MERGE UP' LINES                      
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)      POINT TO ACCUM                                 
         CLI   BRKCODE+3,DESCEQ                                                 
         BE    TOUT4               BUY DETAIL CAN ONLY BE ONE MTH               
*                                                                               
         CLI   PERCTL,C'T'                                                      
         BE    TOUT10                                                           
*                             SINGLE MONTH                                      
TOUT4    DS    0H                                                               
         AH    R7,=Y(MAXMOS*ROWL)         POINT TO TOTAL ROW                    
         L     RF,APER                                                          
         ZIC   R6,0(RF)                                                         
         MH    R6,=H'8'                                                         
*                                                                               
         ST    R6,PERLIND          SAVE DISPLACEMENT FOR EDI                    
*                                                                               
         LA    R6,INVLIST(R6)      POINT TO INV NO FOR THIS MONTH               
*                                                                               
         BAS   RE,TSET                                                          
         LA    R7,WK                                                            
         GOTO1 AFMTAMT,DMCB,(R7),(R6)                                           
         LA    RE,P1                                                            
         L     RF,AGRID                                                         
         LA    R1,14               FOR BCT PLINES                               
         LA    R7,14               FOR AGRID                                    
TOUT4A   LR    R6,RE               FIND LAST NON-BLANK IN P LINE                
         LR    R5,RE                                                            
         LA    R0,132                                                           
TOUT4C   CLI   0(R5),C' '                                                       
         BNH   TOUT4D                                                           
         LR    R6,R5               SAVE ADDR                                    
TOUT4D   LA    R5,1(R5)                                                         
         BCT   R0,TOUT4C                                                        
*                                                                               
         SR    R6,RE               WILL HAVE DISPLACEMENT INTO                  
         LA    R6,1(R6)            ADD FOR ONE SPACE BETWEEN                    
         OC    AMED,AMED           IF DOING MULTI-MEDIA REQ                     
         BZ    TOUT4D2                                                          
         L     R5,AMED                                                          
         CLI   0(R5),C'N'                                                       
         BE    TOUT4D5                                                          
         B     TOUT4D3                                                          
*                                                                               
TOUT4D2  CLI   QMEDIA,C'N'                                                      
         BE    TOUT4D5                                                          
TOUT4D3  LA    R5,P1                                                            
         CR    R5,RE               SEE IF DOING FIRST P LINE                    
         BNE   *+8                                                              
         LA    R6,1(R6)            SO THERE WILL BE AT LEAST                    
*                                  2 SPACES BETWEEN SPACE AND ORDERED           
*                                  LINE OF LAST NON-BLANK                       
TOUT4D5  EX    R6,TOUT4E                                                        
         B     *+10                                                             
TOUT4E   CLC   0(0,RF),SPACES      SEE IF GRID ENTRY IS ALL SPACES              
         BE    TOUT5               UP TO LAST CHAR OF P LINE                    
TOUT4F   LA    RE,132(RE)           CAN'T USE THIS LINE IF DATA IN GRID         
         BCT   R1,TOUT4A                                                        
         B     TOUT8                                                            
*                                                                               
*                                                                               
TOUT5    OC    0(132,RE),0(RF)                                                  
         LA    RE,132(RE)                                                       
         LA    RF,132(RF)                                                       
         BCTR  R7,0                                                             
         BCT   R1,TOUT4A                                                        
         B     TOUT8                                                            
*                                                                               
TOUT8    DS    0H                                                               
         LR    R0,RF               MUST SAVE RF                                 
         GOTO1 APRNT                                                            
         LTR   R7,R7               SEE IF ALL OF GRID USED                      
         BNP   TOUT8C                                                           
         LR    RF,R0               RESTORE RF                                   
         CLC   0(132,RF),SPACES                                                 
         BE    TOUT8C          STILL NEEDED TO SKIP A LINE                      
         LA    R1,P1             I MUST PRINT REST OF GRID                      
TOUT8B   CLC   0(132,RF),SPACES                                                 
         BE    TOUT8C                                                           
         MVC   0(132,R1),0(RF)                                                  
         LA    R1,132(R1)                                                       
         LA    RF,132(RF)                                                       
         BCT   R7,TOUT8B                                                        
*                                                                               
TOUT8C   MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
TOUT8X   B     TOUTX                                                            
TOUT9    DS    0H                                                               
TOUT9B   DS    0H                                                               
         CLI   BRKCODE+3,PUBEQ                                                  
         BNL   *+8                                                              
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
         CLI   BRKCODE+3,PUBEQ                                                  
         BNL   TOUTXX              DONT FLUSH PRINT LINES                       
         B     TOUTX                                                            
*                             MULTI-MONTH                                       
TOUT10   DS    0H                                                               
***NEW                                                                          
***                            FOR MULTI-MONTH BILLS ONLY SHOW **               
***                            FOR TOTAL                                        
         MVC   DOUBLE(2),TOTSTAR   SAVE TOTSTAR                                 
         MVC   TOTSTAR,SPACES                                                   
***NEWEND                                                                       
         SR    R5,R5               R5 = INDEX INTO PERLIST                      
TOUT10A  DS    0H                                                               
*                                                                               
         ST    R5,PERLIND          SAVE DISP FOR EDI BILLING                    
*                                                                               
         LA    R6,P1                                                            
         LA    R4,11(R6)                                                        
         LR    RF,R4                                                            
         SH    RF,=H'2'                                                         
         CLC   0(10,RF),SPACES     SEE IF CAN PRINT ON SAME LINE                
         BE    TOUT10B                                                          
***E***                                                                         
         CLI   NOPMBRK,C'Y'        NO MONTHLY BREAK-OUT                         
         BE    TOUT10B                                                          
***E***                                                                         
         GOTO1 APRNT                                                            
TOUT10B  DS    0H                                                               
         LA    R2,PERLIST(R5)      POINT TO MONTH                               
         CLI   0(R2),X'FF'                                                      
         BNE   TOUT12                                                           
***NEW                                                                          
         MVC   TOTSTAR,DOUBLE     RESTORE TOTSTAR FOR TOTAL LINE                
***NEWEND                                                                       
***E***                                                                         
         CLI   NOPMBRK,C'Y'                                                     
         BE    TOUT11                                                           
***E***                                                                         
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(6,R4),=C'TOTAL*'                                               
         MVC   0(L'PP6TOTAL,R4),PP6TOTAL                                        
         DROP  RE                                                               
TOUT11   L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)                                                     
         AH    R7,=Y(MAXMOS*ROWL)         POINT TO TOTAL ROW                    
         B     TOUT14                                                           
TOUT12   DS    0H                                                               
         OC    0(ROWTL*2,R7),0(R7)    NO DATA                                   
         BZ    TOUT15                                                           
*                                                                               
***E***                                                                         
         CLI   NOPMBRK,C'Y'        NO MONTHLY BREAKOUT - SKIP                   
         BE    TOUT15              TO TOTALS                                    
***E***                                                                         
         GOTO1 DATCON,DMCB,(3,0(R2)),(6,0(R4))    NORMAL = MMMYY                
         B     TOUT14                                                           
TOUT13   DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,2(R2)),(5,0(R4))    OTHER = MMMDD/YY              
TOUT14   DS    0H                                                               
*                                                                               
         BAS   RE,TSET                                                          
         LA    R0,INVLIST(R5)                                                   
         GOTO1 AFMTAMT,DMCB,WK,(R0)                                             
         LA    RE,P1                                                            
         L     RF,AGRID                                                         
         LA    R1,14               FOR BCT                                      
TOUT14A  OC    0(132,RE),0(RF)                                                  
         LA    RE,132(RE)                                                       
         LA    RF,132(RF)                                                       
         BCT   R1,TOUT14A                                                       
         B     TOUT14P                                                          
*                                                                               
TOUT14P  DS    0H                                                               
         MVI   SPACING,2                                                        
TOUT14R  DS    0H                                                               
         GOTO1 APRNT                                                            
         CLI   0(R2),X'FF'                                                      
         BE    TOUTX                                                            
*                                                                               
TOUT15   DS    0H                                                               
         LA    R5,8(R5)            NEXT DATE                                    
         LA    R7,ROWL(R7)         NEXT DATA                                    
         B     TOUT10A                                                          
TOUTX    DS    0H                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES                           
         GOTO1 APRNT                                                            
TOUTXX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
TOUT20   DS    0H                                                               
         GOTO1 AFMTAMT,DMCB,(R7)                                                
         LA    RE,P1                                                            
         L     RF,AGRID                                                         
         LA    R1,14               FOR BCT                                      
TOUT20A  OC    0(132,RE),0(RF)                                                  
         LA    RE,132(RE)                                                       
         LA    RF,132(RF)                                                       
         BCT   R1,TOUT20A                                                       
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
         B     TOUTX                                                            
         SPACE 3                                                                
*                                                                               
TSET     DS    0H                                                               
*                                  CONTRACT AND OPEN                            
         MVC   WK(ROWTL),0(R7)                                                  
         MVC   WK+ROWTL(ROWTL),ROWTL(R7)                                        
*                                                                               
         BR    RE                                                               
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'PRTADJ - PRINT ADJUSTMENTS'                                     
PRTADJ   CSECT                                                                  
         NMOD1 0,PRTADJ                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         ST    R3,SAVBRK                                                        
*                                                                               
         CLI   PASSNO,1            ONLY PASS 1                                  
         BNE   PAX                                                              
***E***                                                                         
         CLC   QPROG,=C'E1'        ON ESTIMATES - NO ADJUSTMENTS                
         BE    PAX                                                              
***E***                                                                         
         CLC   SAVBRK,AINVBRK      IF INV BRK                                   
         BE    PA2                                                              
         CLC   BORDSW(3),=C'YNN'   IF ORDERED ONLY FORMAT  PRINT                
         BNE   PA02                ADJ ONLY IF END OF INV                       
         CLI   RETDRAFT,C'Y'       UNLESS RETAIL DRAFT                          
         BNE   PAX                                                              
*                                                                               
PA02     DS    0H                                                               
         B     PA3                                                              
PA2      DS    0H                                                               
         MVI   DUESW,C'Y'          SET HAVE PRINTED AMOUNT DUE                  
         CLC   BORDSW(3),=C'YNN'      IF FORMAT (ORDERED ONLY)                  
         BNE   PA3                                                              
         GOTO1 ALSTINV             NEED PREVIOUS BILLING                        
*                                                                               
PA3      DS    0H                                                               
**GST                                                                           
         MVI   VATPSW,C'N'                                                      
         MVI   PRSW,C'H'           SET TO HOLD PRINT LINES                      
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)           POINT TO ACCUM                            
         LR    R4,R7                                                            
         AH    R4,=Y(TOTSIZE-BFORML)                                            
         AH    R7,=Y(MAXMOS*ROWL)                                               
         MVC   WKROW+000(256),000(R7)      PUT WHOLE ROW IN WKROW               
         MVC   WKROW+256(256),256(R7)                                           
         MVC   WKROW+512(L'WKROW-512),512(R7)                                   
*                                                                               
**GST                                                                           
         USING BFORMD,R4                                                        
         MVC   CVATSWS,BFVATSWS        VATABLE SWITCH                           
         DROP  R4                                                               
*                                  (O-NO,Y=YES,FF=MIXED)                        
         CLI   FINANSW,0           SEE IF FINANCIAL CLIENT                      
         BE    PA3A0                                                            
***R***                                                                         
         CLC   QPROG,=C'R1'       SEE IF FINANCIAL REBATE BILLING               
         BE    PA3A0              TREAT LIKE NON-FINANCIAL                      
         CLC   QPROG,=C'RD'  SEE IF FINANCIAL REBATE BILLING DRAFT              
         BE    PA3A0              TREAT LIKE NON-FINANCIAL                      
***R***                                                                         
         MVC   WKROW(ROWTL),ROWTL(R7) MOVE OPEN TO WKROW                        
         MVC   WKROW+ADJDSP(8),OADJDSP(R7) MOVE OPEN ADJ AND DUE                
*                                                                               
PA3A0    DS    0H                                                               
         LA    R7,WKROW                                                         
*                                                                               
***                           NOTE THAT R4 POINTS TO BILL FORMULA               
***                                                                             
         USING BFORMD,R4                                                        
         LA    R2,P1                                                            
         CLI   BDOLNUM,1                                                        
         BNE   PA3A2                                                            
         CLI   BTYPNUM,1                                                        
         BNE   PA3A2                                                            
PA3A     DS    0H                                                               
         SH    R2,=H'16'      SHIFT SINGLE COL. FORMATS LEFT 1 COL.             
PA3A2    DS    0H                                                               
         USING ALINED,R2                                                        
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   PA3B                                                             
***                                                                             
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQUEST                   
         BNE   PA3A4               REPEAT FORMULA + AMT DUE                     
         CLI   JOBCTL,C'S'         UNLESS JOBS SEPARATE                         
         BNE   PA3B                                                             
         CLC   MEDCNT,=F'1'        AND ONLY ONE MEDIA                           
         BNE   PA3B                                                             
*                                  STILL FALL THRU TO CHECK NDUES               
***                                                                             
PA3A4    CLI   NDUES,1             AND EXACTLY 1 DUE LEVEL PRINTED              
         BE    PA20                DO NOT REPEAT FORMULA                        
PA3B     DS    0H                                                               
*                                                                               
*                                  STATE BASIS IF NOT ON BILL                   
         CLI   UPASS,C'S'          NO FORMULAS ON SUMMARY BILL                  
         BE    PA20                                                             
*                                                                               
         CLI   RETPROF+13,C'Y'     SEE IF SUPPRESSING DISTRIB DETAILS           
         BE    PA3B2                                                            
         CLI   RETPROF+13,C'B'     SEE IF SUPPRESSING DISTRIB DETAILS           
         BNE   PA3B5               AND $                                        
PA3B2    CLI   UPASS,1             SEE IF CORP                                  
         BE    PA3B5                                                            
         B     PA20                DISTRIB - NO DETAILS                         
*                                                                               
PA3B5    CLI   BFBASA,X'FF'      CHECK FOR UNEQUAL BASES                        
         BNE   PA3B8                                                            
*                                                                               
         IF    BDOLNUM,EQ,1,AND,BTYPNUM,EQ,1,PA3B6                              
         B     PA20                SKIP TO AMOUNT DUE                           
*                                                                               
*                                                                               
PA3B6    LA    R2,16(R2)           RESET TO LAST COLUMN                         
         B     PA20                SKIP TO AMOUNT DUE                           
*                                                                               
PA3B8    DS    0H                                                               
         OC    BFBASA(5),BFBASA                                                 
         BNZ   PA3C                                                             
         MVC   BFBASA(2),=X'0505'  SET DEFAULT     G-CD                         
***R***                                                                         
         CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE                      
         BNE   *+10                                                             
         MVC   BFBASA(2),=X'0101'  DEFAULT TO GROSS                             
         CLC   QPROG,=C'RD'        SEE IF FINANCIAL REBATE DRAFT                
         BNE   *+10                                                             
         MVC   BFBASA(2),=X'0101'  DEFAULT TO GROSS                             
***R***                                                                         
*                                                                               
PA3C     CLI   CDSEP,C'Y'          SEE IF DOING CD SEP                          
         BNE   *+8                                                              
         NI    BFBASA,X'FB'        IF SO SET OFF CD IN BASE                     
*                                                                               
         CLI   PROFB2B+4,C'Y'      SEE IF CD IS ON NET BILL                     
         BNE   PA3C7                                                            
*                                                                               
         CLI   SCBNCSW,C'C'        SEE IF DOING COMMISSION BILL                 
         BNE   PA3C7                                                            
         NI    BFBASA,X'FB'        IF SO SET OFF CD IN BASE                     
*                                                                               
PA3C7    DS    0H                                                               
*                                                                               
         MVC   TBASA,BFBASA       TEMPORARY BASIS                               
*                                  SEE IF BASIS ON BILL                         
         CLI   CDSEP,C'R'         CD HANDLING WITH 'APPLY'                      
         BE    PA3C7C                                                           
         CLI   CDSEP,C'C'         CHK FOR SPECIAL CD HANDLING                   
         BNE   PA3D               IF NO ONLY SHOW BASE IF NOT ON BILL           
*                                                                               
PA3C7C   DS    0H                                                               
         NI    TBASA,X'FB'        IF SO SET OFF CD IN BASE                      
*                                                                               
         OC    BFCOMP,BFCOMP      FIRST CHECK FOR ADJUSTMENT                    
         BZ    PA20                                                             
         CLI   ADJSEP,C'Y'        OR ADJ IS ON SEPARATE INVOIVE                 
         BE    PA20                                                             
         B     PA4                SHOW BASE                                     
*                                                                               
PA3D     CLI   ORDSW+2,C'Y'        MUST BE SHOWING BILLABLE                     
         BNE   PA4                                                              
         LA    R5,BASISTAB                                                      
         MVC   BASISTAB(12),=X'01000200050006000800FFFF'                        
         MVC   1(1,R5),FORMAT      GROSS                                        
         MVC   3(1,R5),FORMAT+1    NET                                          
         MVC   5(1,R5),FORMAT+3    GROSS-CD                                     
         MVC   7(1,R5),FORMAT+4    NET-CD                                       
         MVC   9(1,R5),FORMAT+5    AGY COMM                                     
PA3F     CLI   0(R5),X'FF'         END OF TABLE                                 
         BE    PA4                                                              
         CLC   TBASA(1),0(R5)                                                   
         BE    PA3H                                                             
         LA    R5,2(R5)                                                         
         B     PA3F                                                             
*                                                                               
PA3H     CLI   1(R5),C'Y'                                                       
         BNE   PA4                                                              
*                                                                               
*   IF ONLY ONE TYP AND CAT - I CAN SKIP TO PRINT ADJ                           
*                                                                               
         IF    BDOLNUM,EQ,1,AND,BTYPNUM,EQ,1,PA3K                               
         OC    BFCOMP,BFCOMP       CHK FOR ADJ                                  
         BZ    PA20                SKIP TO AMOUNT DUE                           
         CLI   ADJSEP,C'Y'         OR ADJ ON SEPARATE INV                       
         BE    PA20                SKIP TO AMOUNT DUE                           
         B     PA4                 BASIS IS ON BILL BUT THERE IS AN ADJ         
*                                  THEN RESTATE BASIS                           
*                                                                               
*                                                                               
PA3K     LA    R2,16(R2)           RESET TO LAST COLUMN                         
         B     PA8                                                              
*                                                                               
*                                  BASIS NOT ON BILL                            
PA4      DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-11(10),=C'NET AMOUNT'                                     
         MVC   ALCOL4-12(L'PP@NAMT),PP@NAMT                                     
         LA    R5,NDSP(R7)                                                      
         TM    TBASA,X'02'                                                      
         BZ    PA5                                                              
         TM    TBASA,X'04'        SEE IF SUBTRACTING CD                         
         BZ    PA6                                                              
*--->    MVC   ALCOL4-19(18),=C'NET LESS CD AMOUNT'                             
         MVC   ALCOL4-21(L'PP@NLCA),PP@NLCA                                     
         B     PA6                                                              
PA5      DS    0H                                                               
*--->    MVC   ALCOL4-20(19),=C'AGENCY COMM. AMOUNT'                            
         MVC   ALCOL4-25(L'PP@AGYCA),PP@AGYCA                                   
         LA    R5,ADSP(R7)                                                      
         TM    TBASA,X'08'                                                      
         BZ    PA5C                                                             
         B     PA6                AGY COMM-CD NOT ALLOWED                       
*                                                                               
PA5C     DS    0H                                                               
         MVC   ALCOL4-25(5),SPACES                                              
*                                                                               
*--->    MVC   ALCOL4-20(19),=C'       GROSS AMOUNT'                            
         MVC   ALCOL4-20(L'PPRGRSAM),PPRGRSAM                                   
         LR    R5,R7                                                            
         TM    TBASA,X'01'                                                      
         BZ    PA6                                                              
         TM    TBASA,X'04'                                                      
         BZ    PA6                                                              
*--->    MVC   ALCOL4-21(20),=C'GROSS LESS CD AMOUNT'                           
         MVC   ALCOL4-22(L'PP@GRSCD),PP@GRSCD                                   
         DROP  RE                                                               
PA6      DS    0H                                                               
         L     R0,0(R5)                                                         
         TM    TBASA,X'04'    SEE IF SUBTRACTING CD                             
         BZ    PA7                                                              
         S     R0,CDSP(R7)                                                      
         A     R0,ROWHL+CDSP(R7)   PREV BILLED CD (G-CD)-(BG-BCD)               
PA7      S     R0,ROWHL(R5)        PREV BILLED                                  
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
*                             PRINT ADJUSTMENT LINE                             
*                             LESS (PLUS) XX.XXXX PERCENT OF GROSS(NET)         
*                                                                               
PA8      DS    0H                                                               
         OC    BFCOMP,BFCOMP       NO ADJUSTMENT                                
         BZ    PA20                                                             
         CLI   ADJSEP,C'Y'         ADJUSTMENT ON SEP INV                        
         BE    PA20                                                             
*                                                                               
         MVC   W,SPACES                                                         
         MVC   BYTE,BFCOMP         USE SIGN OF FORMULA                          
***                                                                             
***      NOTE - $FILE CHECKS TO BE SURE "SHOW AS" ADJ HAS SAME                  
***      SIGN AS REGULAR ADJ                                                    
***                                                                             
         CLC   BFCOMP,FFS          UNLESS UNEQUAL FORMULAS                      
         BNE   *+10                                                             
         MVC   BYTE,ADJDSP(R7)         THEN USE SIGN OF ADJ AMOUNT              
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   W(4),=C'LESS'                                                    
         MVC   W(L'PP@LESS),PP@LESS                                             
         TM    BYTE,X'80'                                                       
         BNZ   *+16                                                             
*--->    MVC   W(4),=C'PLUS'                                                    
         MVC   W(L'PP@LESS),SPACES                                              
         MVC   W(L'PP@PLUS),PP@PLUS                                             
*                                                                               
*        MUST FLOAT "ADJUSTMENT" AFTER LESS OR PLUS                             
         LA    RF,W+5                                                           
PA8B     CLI   0(RF),C' '                                                       
         BH    PA8C                                                             
         BCT   RF,PA8B                                                          
PA8C     ST    RF,WORD                                                          
*                                                                               
*                                                                               
         CLI   PROFB1A+1,C'Y'      SEE IF ALWAYS PRINTING COMM ADJ              
         BE    PA8C6                                                            
*                                                                               
         CLI   PROFB1A+1,C'P'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    PA8C7           (WITH PCT.)                                      
*                                                                               
         CLI   PROFB1A+1,C'A'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    PA8C7           (WITHOUT PCT.)                                   
*                                                                               
         CLC   BFCOMP,FFS                                                       
         BNE   PA8D                                                             
*                                                                               
PA8C5    DS    0H                                                               
*--->    MVC   W+5(10),=C'ADJUSTMENT'                                           
         MVC   2(L'PP@ADJUS,RF),PP@ADJUS                                        
         B     PA12                                                             
*                                                                               
PA8C6    DS    0H                                                               
*--->    MVC   W(21),=C'COMMISSION ADJUSTMENT'                                  
         MVC   W(L'PP@CMADJ),PP@CMADJ                                           
         B     PA12                                                             
*                                                                               
*        IF PROFB1A+1 = A EXPRESSION WILL READ                                  
*****   "PLUS (OR LESS) AGENCY FEE NN.NNNN PCT."  *FIRST TRY*                   
*       "AGENCY FEE NN.NNNN%"                                                   
*                                                                               
PA8C7    DS    0H                                                               
         MVC   W(5),SPACES          CLEAR PLUS OR MINUS                         
*******  MVC   W+5(10),=C'AGENCY FEE'                                           
         MVC   W(L'PP@AGYF),PP@AGYF                                             
*                                                                               
         CLI   PROFB1A+1,C'A'          SEE IF NOT SHOWING PCT.                  
         BE    PA12                                                             
*                                                                               
         CLC   BFCOMP,FFS              SEE IF MIXED PERCENTAGES                 
         BE    PA12                    DON'T DO PERCENTAGE                      
         MVI   CURTAB+3,4                                                       
******** CURED (B3,BFCOMP),(8,W+16),CURTAB                                      
         CURED (B3,BFCOMP),(8,W+19),CURTAB                                      
         MVI   CURTAB+3,2                                                       
         LA    RF,W+26                                                          
PA8C7B   DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,PA8C7B                                                        
*                                                                               
         CLI   0(RF),C'.'                                                       
         BNE   PA8C7C                                                           
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
         B     PA8C7X                                                           
*                                                                               
PA8C7C   CLI   0(RF),C','            FOR THOSE COUNTRIES THAT USE ,             
         BNE   PA8C7X                FOR DECIMAL POINT                          
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
*                                                                               
**8C7X   MVC   2(4,RF),=C'PCT.'      *FIRST TRY*                                
PA8C7X   MVI   2(RF),C'%'                                                       
         B     PA12                                                             
*                                                                               
         DROP  RE                                                               
*                                                                               
PA8D     MVI   CURTAB+3,4                                                       
*--->    EDIT  (B3,BFCOMP),(7,W+5),4                                            
***NEW 5/20/91                                                                  
         OC    BFPCOMP,BFPCOMP         CKECK IF PRINTING ANOTHER PCT            
         BNZ   PA8H                                                             
***NEW 5/20/91                                                                  
         CURED (B3,BFCOMP),(8,2(RF)),CURTAB                                     
         MVI   CURTAB+3,2                                                       
         L     RF,WORD                                                          
         LA    RF,9(RF)        WAS W+11                                         
         B     PA9                                                              
*                                                                               
***NEW 5/20/91                                                                  
PA8H     DS    0H                                                               
         CURED (B3,BFPCOMP),(8,2(RF)),CURTAB                                    
         MVI   CURTAB+3,2                                                       
         L     RF,WORD                                                          
         LA    RF,9(RF)        WAS W+11                                         
         B     PA9                                                              
***NEW 5/20/91                                                                  
*                                                                               
PA9      DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,PA9                                                           
*                                                                               
         CLI   0(RF),C'.'                                                       
         BNE   PA9D                                                             
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
         B     PA9F                                                             
*                                                                               
PA9D     CLI   0(RF),C','            FOR THOSE COUNTRIES THAT USE ,             
         BNE   PA9F                  FOR DECIMAL POINT                          
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
*                                                                               
PA9F     L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   2(10,RF),=C'PERCENT OF'                                          
         MVC   2(L'PP@PCTOF,RF),PP@PCTOF                                        
***NEW 5/20/91   SEE IF PRINTING ANOTHER BASB                                   
         MVC   BYTE,BFBASB                                                      
         CLI   BFPBASB,0                                                        
         BE    *+10                                                             
         MVC   BYTE,BFPBASB                                                     
***NEW 5/20/91              NOW CHECKS BYTE INSTEAD OF BFBASB                   
*                           ONLY CONTROLS WHAT PRINTS                           
*                           NOT THE CALCULATION                                 
*--->    MVC   13(3,RF),=C'NET'                                                 
         MVC   13(L'PP@NET,RF),PP@NET                                           
         SR    R0,R0                                                            
         CLI   BYTE,X'02'                                                       
         BE    PA10                                                             
*--->    MVC   13(5,RF),=C'GROSS'                                               
         MVC   13(L'PP@GROSS,RF),PP@GROSS                                       
         LA    R0,L'PP@GROSS-3                                                  
         CLI   BYTE,X'01'                                                       
         BE    PA10                                                             
*--->    MVC   13(10,RF),=C'AGY. COMM.'                                         
         MVC   13(L'PP@AGYCM,RF),PP@AGYCM                                       
         LA    R0,L'PP@AGYCM-3                                                  
         CLI   BYTE,X'08'                                                       
         BE    PA10                                                             
*--->    MVC   13(11,RF),=C'NET LESS CD'                                        
         MVC   13(L'PP@NETCD,RF),PP@NETCD                                       
         LA    R0,L'PP@NETCD-3                                                  
         CLI   BYTE,X'06'                                                       
         BE    PA10                                                             
*--->    MVC   13(13,RF),=C'GROSS LESS CD'                                      
         MVC   13(L'PP@GRSLC,RF),PP@GRSLC                                       
         LA    R0,L'PP@GRSLC-3                                                  
         DROP  RE                                                               
*                                                                               
PA10     DS    0H                                                               
*                      SEE IF NEED TAX IN ADJUSTMENT EXPRESSION                 
PA10X    CLI   TAXOPT,C'N'                                                      
         BE    PA12                                                             
         CLI   BFBASB,X'08'        SEE IF AGY COMM (REAL ADJ)                   
         BNE   PA10X8              NO                                           
         CLI   BFPBASB,0           SEE IF OVERRIDDING FORMULA                   
         BE    PA12                IF NOT - SKIP (LESS TAX) MESSAGE             
*                                                                               
*                                                                               
PA10X8   CLI   UPASS,C'S'          NO TAX ON SUMMARY                            
         BE    PA12                                                             
         L     RE,TDSP(R7)                                                      
         S     RE,ROWHL+TDSP(R7)                                                
         BZ    PA12                NO TAX                                       
         AR    RF,R0              ADD DISPLACEMENT                              
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   17(10,RF),=C'(LESS TAX)'                                         
         MVC   17(L'PP@LTAX,RF),PP@LTAX                                         
         DROP  RE                                                               
*                                                                               
PA12     DS    0H                                                               
         LA    RF,W+50                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
*                                                                               
         L     R0,ADJDSP(R7)                                                    
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
*                                  PRINT AMOUNT DUE                             
*                                                                               
PA20     DS    0H                                                               
*                                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA22                                                             
*                                                                               
         CLC   SAVBRK,APRDBRK      PRODUCT - MULTIPLE PRDS ON ONE BILL          
         BNE   PA21                                                             
         CLI   CVATCOD,0                                                        
         BNE   PA22                IF ALSO DOING GST                            
*                                  PRINT "AMOUNT DUE FOR"                       
PA21     DS    0H                                                               
         LA    R0,P1               IF NOT END OF INV                            
         CR    R2,R0               AND NO ADJ OR SPECIAL BASE                   
         BH    PA22                                                             
         CLI   SCBNCSW,C'C'        SEP COMMISION BILL                           
         BNE   PA27C                                                            
*                                                                               
PA22     DS    0H                                                               
*                                                                               
         CLI   RETPROF+13,C'Y'     SEE IF SUPPRESSING DISTRIB DETAILS           
         BE    PA22A                                                            
         CLI   RETPROF+13,C'B'     SEE IF SUPPRESSING DISTRIB DETAILS           
         BNE   PA22C               AND $                                        
*                                                                               
PA22A    CLI   UPASS,1             SEE IF CORP                                  
         BE    PA22C                                                            
         CLI   UPASS,C'S'          SEE IF CORP SUMMARY                          
         BE    PA22C                                                            
         B     PA27B               DISTRIB - NO DETAILS                         
*                                  SKIP TO SHARE DISPLAY                        
*                                                                               
PA22C    DS    0H                                                               
         L     R0,DUEDSP(R7)           DUE                                      
         CLI   ADJSEP,C'Y'         IF ADJ ON SEP INV                            
         BNE   PA24                                                             
         L     RF,ADJDSP(R7)           THEN PRINT DUE +/- ADJ HERE              
         SR    R0,RF                                                            
*                                                                               
PA24     DS    0H                                                               
*                                                                               
         IF    CDSEP,NE,C'C',AND,CDSEP,NE,C'R',PA24B                            
         OC    BFCOMP,BFCOMP     CHECK FOR ADJUSTMENT                           
         BZ    PA24B             NONE                                           
         TM    BFBASA,X'04'      SEE IF CD WAS SUBTRACTED ON "REAL"             
         BZ    PA24B             FORMULA                                        
         A     R0,CDSP(R7)         ADD CD BACK IN TO "AMOUNT DUE"               
         S     R0,ROWHL+CDSP(R7)   PREV BILLED CD (G-CD)-(BG-BCD)               
*                                                                               
PA24B    DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
         ST    R0,SVAMTDUE        SAVE AMT DUE TO PRINT AT END                  
*                                 OF INVOICE LIST                               
         MVC   W,SPACES                                                         
         LTR   R0,R0               TEST DUE POS OR NEG                          
         BM    PA26                                                             
         CLI   RETPROF,0           FOR RETAIL USE DIFFERENT WORDS               
         BE    PA24D                                                            
***                                                                             
         CLI   RETPROF+11,C'X'     NO SHOWING 'YOUR SHARE'                      
         BE    PA24D                                                            
***                                                                             
         CLI   UPASS,C'S'          UNLESS SUMMARY PASS                          
         BNE   PA25                                                             
PA24D    DS    0H                                                               
*--->    MVC   W(16),=C'** AMOUNT DUE **'                                       
         MVC   W(L'PP@AMDUE),PP@AMDUE                                           
**GST                                                                           
         CLI   CVATSW,0                 SEE IF VAT                              
         BE    PA24E                                                            
         CLI   SCBNCSW,C'C'            SCB COMMISSION BILL                      
         BNE   PA24E                                                            
         MVC   W(L'PP@TAMT),PP@TAMT     CALL IT TOTAL AMOUNT                    
*                                                                               
PA24E    DS    0H                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
         CLI   SCBNCSW,C'C'            SCB COMMISSION BILL                      
         BE    PA24F                                                            
*                                                                               
*--->    MVC   W(15),=C'AMOUNT DUE FOR '                                        
         MVC   W,SPACES                                                         
         MVC   W(L'PP@ADFOR),PP@ADFOR                                           
         MVC   W+L'PP@ADFOR+1(12),TOTNAME      LEVEL NAME                       
         B     PA27                                                             
*                                                                               
PA24F    DS    0H                                                               
         MVC   W,SPACES                                                         
         MVC   W(L'PP@TLFOR),PP@TLFOR                                           
         MVC   W+L'PP@TLFOR+1(12),TOTNAME                                       
         B     PA27                                                             
*                                                                               
*                                                                               
PA25     DS    0H                  RETAIL TOTAL WORDS                           
         MVC   W,SPACES                                                         
*--->    MVC   W(18),=C'** TOTAL AMOUNT **'                                     
         MVC   W(L'PP@TAMT),PP@TAMT                                             
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
*--->    MVC   W(10),=C'TOTAL FOR '                                             
         MVC   W,SPACES      RECLEAR W                                          
         MVC   W(L'PP@TLFOR),PP@TLFOR                                           
         MVC   W+L'PP@TLFOR+1(12),TOTNAME          LEVEL NAME                   
         B     PA27                                                             
PA26     DS    0H                                                               
*--->    MVC   W(19),=C'** CREDIT AMOUNT **'                                    
         MVC   W(L'PP@CDAMT),PP@CDAMT                                           
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
*--->    MVC   W(18),=C'CREDIT AMOUNT FOR '                                     
         MVC   W(L'PP@CAMFR),PP@CAMFR                                           
         MVC   W+L'PP@CAMFR+1(12),TOTNAME       LEVEL NAME                      
         DROP  RE                                                               
*                                                                               
PA26B    DS    0H                                                               
PA27     DS    0H                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27A2              IF NOT END OF INV                            
         ZIC   RF,NDUES            COUNT NO OF DUE LINES PRINTED                
         LA    RF,1(RF)       **** THIS CODE WAS AT PA02                        
         STC   RF,NDUES                                                         
*                                                                               
PA27A2   LA    RF,W+36                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R1,W                                                             
         SR    RF,R1               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
**GST                                                                           
*                                                                               
PA27A3   DS    0H                                                               
         CLI   0(RE),C' '       SCAN FOR FIST CHARACTER                         
         BH    PA27A3C                                                          
         LA    RE,1(RE)                                                         
         B     PA27A3                                                           
*                                                                               
PA27A3C  LR    RF,RE                                                            
         SR    RF,R2                                                            
         ST    RF,WORD          SAVE DISPALCEMENT IN CURRECNT LINE              
*                               USED FOR GST MESSAGE                            
*                                                                               
         CLC   SAVBRK,AINVBRK     SEE IF AT END OF INVOICE                      
         BE    PA27A4                                                           
         AH    RF,=H'7'    ADJUST FOR TOTNAME - TO INSURE                       
         ST    RF,WORD     GST MESSAGE WON'T WRAP TO PRIOR LINE                 
***TAX                                                                          
PA27A4   CLI   TAXOPT,C'N'                                                      
         BE    PA27A8                                                           
         CLI   UPASS,C'S'          NO TAX ON SUMMARY PASS                       
         BE    PA27A8                                                           
*                                                                               
         L     RF,TDSP(R7)         ORDERED TAX                                  
         S     RF,ROWHL+TDSP(R7)   LESS BILLED TAX                              
         BZ    PA27A8              NO TAX                                       
*                                                                               
         CLI   TAXOPT,C'S'         SEE IF SUPPRESSING TAX MESSAGE               
         BE    PA27A8                                                           
*                                                                               
         ST    R0,FULL             SAVE AMT DUE                                 
         LR    R5,RE                                                            
         SH    R5,=H'28'                                                        
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(9,R5),=C'SALES TAX'                                            
         MVC   0(L'PP@STAX,R5),PP@STAX                                          
         DROP  RE                                                               
         ST    RF,DUB                                                           
         LA    R5,L'PP@STAX(R5)                                                 
*--->    EDIT  (RF),(12,11(R5)),2,COMMAS=YES,CR=YES,FLOAT=$,ALIGN=LEFT          
         CURED (RF),(12,2(R5)),CURTAB,COMMAS=YES,CR=YES,FLOAT=$,       X        
               ALIGN=LEFT                                                       
         L     RF,DUB                                                           
         L     R0,FULL            RESTORE AMT DUE                               
*                                                                               
***TAX                                                                          
PA27A8   DS    0H                                                               
         CLI   CDSEP,C'R'         CD HANDLING WITH 'APPLY'                      
         BE    PA27A8C                                                          
         CLI   CDSEP,C'C'          CHK FOR SPECIAL CD HANDLING                  
         BNE   PA27AX                                                           
*                                                                               
PA27A8C  DS    0H                                                               
         CLC   SAVBRK,AINVBRK      SEE IF AT END OF INVOICE                     
         BNE   PA27A9                                                           
***                                                                             
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQUEST                   
         BNE   PA27A8D             MUST REPEAT FORUMLA AND AMT DUE              
         CLI   JOBCTL,C'S'         UNLESS JOBS SEPARATE                         
         BNE   PA27A9                                                           
         CLC   MEDCNT,=F'1'        AND ONLY ONE MEDIA                           
         BNE   PA27A9                                                           
*                                  STILL FALL THRU TO CHECK NDUES               
***                                                                             
PA27A8D  DS    0H                                                               
         CLI   NDUES,1             AND ONLY ONE DUE LEVEL PRINTED               
         BNE   PA27A9                                                           
         MVC   P1,SPACES                                                        
         LA    R2,P1                                                            
         B     PA27AXX             DON'T NEED TO PRINT ANYTHING                 
*                                                                               
*              CHK FOR ADJUSTMENT                                               
*              PRINT AMOUNT DUE IF ANY FORMULA                                  
PA27A9   MVI   BYTE,0                                                           
         OC    ADJDSP(4,R7),ADJDSP(R7)                                          
         BZ    PA27A10                                                          
         CLI   ADJSEP,C'Y'         OR ADJ ON SEPARATE INV                       
         BE    PA27A10                                                          
         ST    R0,SVAMTDUE        SAVE AMT DUE TO PRINT AT END                  
*                                 OF INVOICE LIST                               
         BAS   RE,PAEDIT                                                        
         MVI   BYTE,1              SET AMT DUE PRINTED                          
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
PA27A10  B     PA27A12             ALWAYS DO WHAT I USED TO DO                  
*                                  ONLY IF CD WAS ON BILL                       
*                                  FOLLOWING CODE NOW SKIPPED                   
*                                                                               
**27A10  CLI   BFORMAT+2,C'Y'      SEE IF CD ON BILL                            
         BNE   PA27A12                                                          
         LTR   R0,R0               AND BILL IS POSTIVE                          
         BP    PA27A12                                                          
         CLI   BYTE,1              SEE IF AMT DUE PRINTED                       
         BE    PA27AXX             YES - DONE                                   
         B     PA27AX              NO - DO IT NOW                               
*                                                                               
PA27A12  L     R6,CDSP(R7)         CD                                           
         S     R6,ROWHL+CDSP(R7)   LESS PREV BILLED CD                          
         LTR   R6,R6                                                            
         BNZ   PA27A13             SEE IF ANY BILLABLE CD                       
*                                  NO                                           
         CLI   BYTE,1              SEE IF AMT DUE PRINTED                       
         BE    PA27AXX             YES - DONE                                   
         B     PA27AX              NO - DO IT NOW                               
*                                                                               
PA27A13  B     PA27A14             NOW ALWAYS DO WHAT I USED TO DO              
*                                  ONLY IF CD WAS NOT ON BILL                   
*                                  FOLLOWING CODE NO-OPED                       
*                                                                               
**27A13  CLI   BFORMAT+2,C'Y'      SEE IF CD ON BILL                            
         BNE   PA27A14                                                          
         LTR   R6,R6               CD MUST ALSO BE POSTIVE                      
         BP    PA27A14                                                          
         CLI   BYTE,1              SEE IF AMT DUE PRINTED                       
         BE    PA27AXX             YES - DONE                                   
         B     PA27AX              NO - DO IT NOW                               
*                                                                               
PA27A14  DS    0H                                                               
         CLI   ADJSEP,C'Y'         IF ADJ ON SEPARATE INV                       
         BE    PA27A15             TREAT LIKE NO ADJ                            
         OC    ADJDSP(4,R7),ADJDSP(R7)                                          
         BNZ   PA27A18                                                          
*        IF THERE IS AN ADJ I WILL ALREADY HAVE PRINT AMT DUE                   
*        (UNLESS ADJ ON SEPARATE INV)                                           
*                                                                               
PA27A15  TM    BFBASA,X'04'        SEE IF CD IN FORMULA                         
         BNZ   PA27A16             NO                                           
         BAS   RE,PAEDIT           FINALLY PRINT AMT DUE                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
         B     PA27A18             NOW GO PRINT CD MSGS                         
*                                                                               
PA27A16  MVC   W,SPACES                                                         
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   W(18),=C'** GROSS AMOUNT **'                                     
         MVC   W(L'PP@B1GRS),PP@B1GRS                                           
         TM    BFBASA,X'01'                                                     
         BO    PA27A17                                                          
         MVC   W,SPACES                                                         
*--->    MVC   W(8),=C'  ** NET'                                                
         MVC   W(L'PP@B1NET),PP@B1NET                                           
         TM    BFBASA,X'02'                                                     
         BO    PA27A17                                                          
         MVC   W,SPACES                                                         
*--->    MVC   W(18),=C'** AGENCY COMM. **'                                     
         MVC   W(L'PP@B1AC),PP@B1AC                                             
         TM    BFBASA,X'08'                                                     
         BO    PA27A17                                                          
         DROP  RE                                                               
*                                                                               
         DC    H'0'                BAD FORMULA                                  
*                                                                               
PA27A17  AR    R0,R6               PUT CD BACK IN                               
         LA    RF,W+32                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R1,W                                                             
         SR    RF,R1               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
PA27A18  DS    0H                                                               
**GST                                                                           
**                           IF CDSEP=C OR R (SPECIAL CD HANDLING)              
**                           MUST DO VAT NOW                                    
**                                                                              
         CLI   CVATSW,0            IF VAT                                       
         BE    PA27A19                                                          
*                                                                               
         ST    R4,SAVER4           SAVE ADDR OF BILL FORMULA                    
*                                                                               
         GOTO1 APRNT               SKIP A LINE                                  
         LA    R3,ALCOL4-ALINED    COLUMN FOR VATS                              
         GOTO1 =V(VBPRNT),DMCB,(C'N',SAVBRK),(R3)       'NORMAL'                
*                                                                               
         MVI   VATPSW,C'Y'         SO I WON'T REPRINT                           
*                                                                               
         MVC   TOTVAT,20(R1)       SAVE PST TOTAL                               
         LA    R2,P1                                                            
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         L     R4,WORD                                                          
         AR    R4,R2                                                            
         MVC   0(L'PP@AMDUE,R4),PP@AMDUE                                        
*                                                                               
         CLI   RETPROF,0           IF RETAIL                                    
         BE    *+12                                                             
         L     R0,RETADSP(R7)                                                   
         B     PA27A18E                                                         
*                                                                               
         L     R0,DUEDSP(R7)       NON-RETAIL                                   
         CLI   ADJSEP,C'Y'         SEE IF DOING SEP COMM ADJ                    
         BNE   *+8                                                              
         S     R0,ADJDSP(R7)                                                    
         CLI   SCBNCSW,C'C'        SEE IF SCB COMMISSION BILL                   
         BNE   *+12                                                             
         S     R0,NDSP(R7)         THEN LESS NET                                
         A     R0,BNDSP(R7)        PLUS PREVIUOSLY BILLED NET                   
*                                                                               
PA27A18E DS    0H                                                               
         A     R0,TOTVAT           ADD TOTAL VAT                                
         LTR   R0,R0                                                            
         BNM   *+10                                                             
         MVC   0(L'PP@CDAMT,R4),PP@CDAMT                                        
*                                                                               
         DROP  RE                                                               
*                                                                               
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
PA27A18G DS    0H                                                               
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   PA27A18I                                                         
         ST    R0,SVAMTDUE         SAVE AMOUNT DUE (INCLUDING GST)              
*                                                                               
PA27A18I DS    0H                                                               
*                                                                               
         L     R4,SAVER4           RESTORE R4 TO BILL FORMULA                   
*                                                                               
PA27A19  DS    0H                                                               
*                                                                               
         TM    BFBASA,X'08'        SEE IF AGY COMM FORMULA                      
         BO    PA27AXX                                                          
*                                                                               
         LA    R5,ALCOL3-18                                                     
         CLI   BFORMAT+2,C'Y'      SEE IF CD ON BILL                            
         BNE   PA27A22                                                          
*                                                                               
         CLI   CDSEP,C'R'        SEE IF USING 'APPLY' CD MESSAGE                
         BE    PA27A22           DO SAME AS CD NOT ON BILL                      
*                                                                               
PA27A20  MVC   0(33,R5),SPACES                                                  
         LTR   R6,R6               IF NO CD THEN NO MESSAGE                     
         BZ    PA27AXX                                                          
         BM    PA27A24       SEE IF CD IS MINUS                                 
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   6(27,R5),=C'IF PAID BY DUE DATE, DEDUCT'                         
         BCTR  R5,0        MUST ALSO DECREMENT R5 SO I CAN                      
*                          FIT THE LONGER FRENCH PHRASE                         
*                                                                               
PA27A20B MVC   0(L'PP@IF01,R5),PP@IF01                                          
*              0 SINCE PP@IF01 IS NOW LONGER                                    
         DROP  RE                                                               
         DS    0H                                                               
         B     PA27A26                                                          
*                                                                               
*                                                                               
PA27A22  MVC   0(33,R5),SPACES                                                  
         LTR   R6,R6               IF NO CD THEN NO MESSAGE                     
         BZ    PA27AXX                                                          
         BM    PA27A24                                                          
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   13(20,R5),=C'IF PAID BY DUE DATE,'                               
*--->    MVC   132+13(20,R5),=C'DEDUCT CASH DISCOUNT'                           
         MVC   7(L'PPSIF01,R5),PPSIF01                                          
*                                                                               
*    BELOW CODE SHOULD SHOULD MOVE MESSAGE UNDER START OF PPSIF01               
*                                                                               
PA27A23  CLI   7(R5),C' '      SERACH FOR FIRST NON-SPACE                       
         BH    PA27A23B                                                         
         LA    R5,1(R5)                                                         
         B     PA27A23                                                          
*                                                                               
PA27A23B DS    0H                                                               
         CLI   CDSEP,C'R'    SEE IF USING 'APPLY' MESSAGE                       
         BNE   PA27A23C                                                         
         MVC   132+7(L'PP@ACASH,R5),PP@ACASH                                    
         B     PA27A23D                                                         
*                                                                               
PA27A23C MVC   132+7(L'PP@DCASH,R5),PP@DCASH                                    
         DROP  RE                                                               
PA27A23D DS    0H                                                               
         B     PA27A26                                                          
*                                                                               
PA27A24  DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   13(18,R5),=C'PLUS CASH DISCOUNT'                                 
*--->    MVC   132+13(19,R5),=C'PREVIOUSLY DEDUCTED'                            
         MVC   13(L'PP@PCASH,R5),PP@PCASH                                       
         MVC   132+13(L'PP@PRV03,R5),PP@PRV03                                   
         DROP  RE                                                               
         LR    R0,R6                                                            
         LCR   R0,R0                                                            
         B     PA27A28                                                          
*                                                                               
PA27A26  LR    R0,R6           POSITIVE CD'S GET HERE                           
*                                                                               
         CLI   CDSEP,C'R'      SEE IF USING 'APPLY' MESSAGE                     
         BNE   PA27A28                                                          
         LCR   R0,R0          MAKE CD NEGATIVE SO 'CR' WILL PRINT               
*                                                                               
PA27A28  BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
*                                  SPECIAL FOR BJ                               
         TM    BFBASA,X'04'        ONLY IF CD NOT IN FORMULA                    
         BNZ   PA27A32                                                          
*******  CLI   BFORMAT+2,C'Y'      SEE IF CD ON BILL-CHK NO-OPED                
*******  BE    PA27AXX             PER BJ REQUEST 9/87                          
         LTR   R6,R6               AND CD IS CREDIT                             
         BNM   PA27AXX                                                          
         L     R0,DUEDSP(R7)                                                    
         CLI   ADJSEP,C'Y'         SEE IF ADJ IS ON SEPARATE BILL               
         BNE   *+8                                                              
         S     R0,ADJDSP(R7)                                                    
*                                                                               
         CLI   CVATSW,0            MUST ADD TOTVAT BEFORE                       
         BE    *+8                 SUBTRACTING CD TO RESTATE                    
         A     R0,TOTVAT           CORRECT AMOUNT DUE                           
*                                                                               
         SR    R0,R6               SUBTRACT CD                                  
         LA    R5,ALCOL3-5                                                      
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(19,R5),=C'** ACTUAL AMOUNT **'                                 
         MVC   0(L'PP@AAMT,R5),PP@AAMT                                          
         DROP  RE                                                               
         ST    R0,SVAMTDUE                                                      
         B     PA27AX                                                           
*                                                                               
PA27A32  DS    0H                                                               
         LTR   R6,R6               SEE IF CD IS CREDIT                          
         BNM   PA27AXX                                                          
         L     R0,DUEDSP(R7)                                                    
         CLI   ADJSEP,C'Y'         SEE IF ADJ IS ON SEPARATE BILL               
         BNE   *+8                                                              
         S     R0,ADJDSP(R7)                                                    
*                                                                               
         CLI   CVATSW,0            MUST ADD TOTVAT BEFORE                       
         BE    *+8                 SUBTRACTING CD TO RESTATE                    
         A     R0,TOTVAT           CORRECT AMOUNT DUE                           
*                                                                               
         LA    R5,ALCOL3-5                                                      
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(19,R5),=C'** ACTUAL AMOUNT **'                                 
         MVC   0(L'PP@AAMT,R5),PP@AAMT                                          
         DROP  RE                                                               
         ST    R0,SVAMTDUE                                                      
         B     PA27AX                                                           
*                                                                               
PA27AX   BAS   RE,PAEDIT           R0 STILL HAS AMOUNT FROM PA22                
         LA    R2,132(R2)                                                       
*                                                                               
PA27AXX  DS    0H                                                               
*                                                                               
PA27B    DS    0H                                                               
         CLI   SCBNCSW,C'C'        SEE IF COMMISSION BILLING                    
         BNE   PA27C                                                            
*                                  SUBTRACT NET                                 
         L     R3,WORD             POSITION IN LINE                             
         AR    R3,R2                                                            
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   0(L'PP@LESS,R3),PP@LESS                                          
         LA    R3,L'PP@LESS+1(R3)                                               
         MVC   0(L'PP@NET,R3),PP@NET                                            
*                                                                               
         DROP  RE                                                               
*                                                                               
         LA    R3,L'PP@NET+1(R3)                                                
         L     R0,NDSP(R7)     ORDERED NET                                      
         S     R0,BNDSP(R7)    (LESS PREV BILLED NET)                           
         BAS   RE,PAEDIT                                                        
         LA    R2,132(R2)                                                       
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   W,SPACES                                                         
         CLI   CVATSW,0                 IF HAVE VAT                             
         BE    *+14                                                             
         MVC   W(L'PP@CMAMT),PP@CMAMT   SAY 'COMMISSION AMOUNT'                 
         B     PA27B4                                                           
         MVC   W(L'PP@AMDUE),PP@AMDUE   ELSE AMOUNT DUE                         
         CLC   SAVBRK,AINVBRK           IF AT INV BRK                           
         BE    PA27B4                                                           
         MVC   W,SPACES                                                         
*--->    MVC   W(15),=C'AMOUNT DUE FOR '                                        
         MVC   W(L'PP@ADFOR),PP@ADFOR                                           
         MVC   W+L'PP@ADFOR+1(12),TOTNAME   LEVEL NAME                          
         DROP  RE                                                               
*                                                                               
PA27B4   DS    0H                                                               
         L     R3,WORD                                                          
         AR    R3,R2                                                            
         MVC   0(L'W,R3),W                                                      
         L     R0,DUEDSP(R7)    AMOUNT DUE                                      
         S     R0,NDSP(R7)     LESS NET                                         
         A     R0,BNDSP(R7)    (PLUS PREV BILLED NET)                           
         BAS   RE,PAEDIT           = COMMISSION                                 
         LA    R2,132(R2)                                                       
*                                  RETAIL BILLING SHARES                        
*                                                                               
PA27C    DS    0H                                                               
         CLI   RETPROF,0                                                        
         BE    PA27M                                                            
         CLI   UPASS,C'S'                                                       
         BE    PA27M                                                            
*                                                                               
***                                                                             
         CLI   RETPROF+11,C'X'        NO 'YOUR SHARE' MESSAGE                   
         BE    PA27M                                                            
***                                                                             
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         LA    R5,W                                                             
         MVC   W,SPACES                                                         
*--->    MVC   0(19,R5),=C'YOUR SHARE OF TOTAL'                                 
         MVC   0(L'PP@YSOT,R5),PP@YSOT                                          
         CLC   SAVBRK,AINVBRK                                                   
         BE    *+10                                                             
         MVC   14(12,R5),TOTNAME                                                
         LA    R5,27(R5)                                                        
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         LA    R5,2(R5)                                                         
         CLI   BFRETSHR,X'FF'      TEST MIXTURE OF SHR PCTS                     
         BE    PA27D                                                            
         CLI   RETPROF+11,C'Y'     PRINT PCTS                                   
         BNE   PA27D                                                            
*--->    EDIT  (B3,BFRETSHR),(6,0(R5)),2                                        
         CURED (B3,BFRETSHR),(6,0(R5)),CURTAB                                   
*--->    MVC   7(3,R5),=C'PCT'                                                  
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         MVC   7(L'PP@PCT,R5),PP@PCT                                            
         LA    R5,10(R5)                                                        
*                                                                               
PA27D    DS    0H                                                               
         L     R0,RETADSP(R7)                                                   
         LTR   R0,R0               TEST POS AMOUNT                              
         BM    PA27E               NO                                           
         CLC   SAVBRK,AINVBRK      TEST INV BREAK                               
         BNE   PA27E               NO                                           
         CLI   RETDRAFT,C'Y'                                                    
         BE    PA27E               NO DUE FOR RETAIL DRAFT                      
*                                                                               
*--->    MVC   4(16,R5),=C'** AMOUNT DUE **'                                    
**GST                                                                           
         CLI   CVATSW,0              SEE IF VAT                                 
         BNE   PA27E                                                            
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         MVC   4(L'PP@AMDUE,R5),PP@AMDUE                                        
         DROP  RE                                                               
*                                                                               
PA27E    DS    0H                                                               
         LA    R0,P1                                                            
         CR    R2,R0               TEST PRINTED ANY TOTALS YET                  
         BNH   PA27E2              NO                                           
         MVI   16(R2),0                                                         
         LA    R2,132(R2)          2 LINES                                      
*                                                                               
PA27E2   DS    0H                                                               
         LA    RF,W+55                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
**GST                                                                           
         SR    RE,R2                                                            
         ST    RE,WORD        SAVE DISPLACEMENT INTO CURRENT LINE               
*                                                                               
         L     R0,RETADSP(R7)                                                   
         BAS   RE,PAEDIT                                                        
**GST                                                                           
         LA    R2,132(R2)                                                       
*                                  TEST IF RETAIL CALCS OK                      
         B     PA27P               ** NO-OP **                                  
         MVC   BYTE,DUEDSP(R7)                                                  
         XC    BYTE,RETADSP(R7)                                                 
         TM    BYTE,X'80'                                                       
         BZ    *+6                                                              
         DC    H'0'                SIGNS DIFFER                                 
         L     R0,DUEDSP(R7)                                                    
         L     R1,RETADSP(R7)                                                   
         LPR   R0,R0                                                            
         LPR   R1,R1                                                            
         CR    R1,R0                                                            
         BNH   *+6                                                              
         DC    H'0'                SHARE GREATER THAN TOTAL                     
*                                                                               
         B     PA27P                                                            
*                                                                               
PA27F    DS    0H                                                               
         DROP  R4                                                               
*                                                                               
PA27M    DS    0H                                                               
         LA    R0,P1                                                            
         CR    R2,R0               TEST ANYTHING TO PRINT                       
         BNH   PA28                NO                                           
*                                                                               
PA27P    DS    0H                                                               
         CLI   CVATSW,0            IF VAT                                       
         BE    PA27P6                                                           
         CLI   VATPSW,C'Y'          SEE IF VAT ALREADY PRINTED                  
         BE    PA27P6              YES - DON'T REDO                             
*                                                                               
         GOTO1 APRNT                                                            
         LA    R3,ALCOL4-ALINED     COLUMN FOR VAT                              
         GOTO1 =V(VBPRNT),DMCB,(C'N',SAVBRK),(R3)                               
         MVC   TOTVAT,20(R1)        SAVE TOTAL OF VATS                          
*                                                                               
         LA    R2,P1              RESET R2                                      
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
         ST    R4,SAVER4         SAVE ADDRESS OF BILLING FORMULA                
*                                                                               
         L     R4,WORD                                                          
         AR    R4,R2                                                            
         MVC   0(L'PP@AMDUE,R4),PP@AMDUE                                        
         CLI   RETPROF,0           IF RETAIL                                    
         BE    *+12                                                             
         L     R0,RETADSP(R7)                                                   
         B     PA27P3D                                                          
*                                                                               
         L     R0,DUEDSP(R7)                                                    
*                                                                               
         CLI   ADJSEP,C'Y'         IF SEP COMM ADJ                              
         BNE   *+8                                                              
         S     R0,ADJDSP(R7)       REMOVE ADJUSTMENT FROM MAIN BILL             
*                                                                               
         CLI   SCBNCSW,C'C'         COMMISSION BILL                             
         BNE   *+12                                                             
         S     R0,NDSP(R7)          THEN LESS NET                               
         A     R0,BNDSP(R7)         (PLUS PREV BILLED NET)                      
*                                                                               
PA27P3D  DS    0H                                                               
         A     R0,TOTVAT        ADD TOTAL OF VATS                               
         LTR   R0,R0                                                            
         BNM   *+10                                                             
         MVC   0(L'PP@CDAMT,R4),PP@CDAMT                                        
*                                                                               
         L     R4,SAVER4          MUST RESTORE R4                               
*                                (NEEDED FOR EDI CALL)                          
         DROP  RE                                                               
*                                                                               
         BAS   RE,PAEDIT                                                        
         LA    R2,132(R2)                                                       
*                                                                               
PA27P4   DS    0H                                                               
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   PA27P6                                                           
         ST    R0,SVAMTDUE         SAVE AMOUNT DUE (INCLUDING GST)              
*                                                                               
PA27P6   DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)   EDI CALL                    
**EDI**                                                                         
*                                  SEE IF LIST OF PREVIOUS                      
*                                  BILLS NEEDED  (FOR INFORMATION ONLY)         
         CLC   SAVBRK,AINVBRK                                                   
         BNE   PA28                                                             
         CLC   BORDSW(3),=C'YNN'   ORDERED ONLY FORMAT                          
         BE    PA28                                                             
         CLI   LSTOPT,C'Y'       LIST ONLY                                      
         BE    PA27R                                                            
         CLI   LSTOPT,C'I'       LIST + AT INSERTION                            
         BE    PA27R                                                            
         CLI   LSTOPT,C'R'       LIST + RESTATE AMT DUE                         
         BE    PA27R             (+ NOT AT INSERTION)                           
         CLI   LSTOPT,C'B'       LIST + RESTATE AMT DUE                         
         BE    PA27R             (+ AT INSERTION)                               
         B     PA28                                                             
*                                                                               
PA27R    GOTO1 ALSTINV                                                          
*                                                                               
PA28     DS    0H                                                               
         B     PAX                                                              
         SPACE 3                                                                
PAEDIT   DS    0H                                                               
         MVC   TOTSTAR,=C'* '                                                   
         CLC   SAVBRK,AINVBRK                                                   
         BNE   *+8                                                              
         MVI   TOTSTAR+1,C'*'                                                   
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         L     RE,DUB                                                           
         CLI   ALCOL4+13,C' '         SEE IF CR THERE                           
         BH    PAEDT5                                                           
         MVC   ALCOL4+13(2),TOTSTAR                                             
         B     PAEDITX                                                          
*                                                                               
PAEDT5   MVC   ALCOL4+15(2),TOTSTAR         CR**                                
PAEDITX  MVC   TOTSTAR,SPACES                                                   
         BR    RE                                                               
         SPACE 2                                                                
PAX      DS    0H                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES                           
         GOTO1 APRNT                                                            
         XIT1                                                                   
         SPACE 3                                                                
BASISTAB DS    CL12                                                             
*                                                                               
         LTORG                                                                  
*                                                                               
SAVER4   DS    F                                                                
TBASA    DS    CL1        TEMPORARY BASIS                                       
*                                                                               
         TITLE 'ADJINV - PRINT ADJUSTMENT INVOICE'                              
ADJINV   CSECT                                                                  
         NMOD1 0,ADJINV                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         CLI   SCBNCSW,C'C'            IF SCB COMMISSION BILL                   
         BE    AIX                     NO OLD STYLE SEP ADJ BILL                
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)             POINT TO ACCUM                          
         LR    RF,R7                                                            
         AH    RF,=Y(TOTSIZE-BFORML)                                            
*****    LA    RF,TOTSIZE-BFORML(R7)                                            
         MVC   MYX(BFORML),0(RF)        HOLD FORMULA IN MYX                     
**GST                                                                           
         MVC   CVATSWS,BFVATSWS-BFORMD(RF)                                      
         MVC   SVVATCDS,BFVATCDS-BFORMD(RF)                                     
         AH    R7,=Y(MAXMOS*ROWL)       POINT TO TOTAL ROW                      
*                                       MOVE TOTALS TO WKROW                    
         MVC   WKROW(250),0(R7)                                                 
         MVC   WKROW+250(250),250(R7)                                           
         MVC   WKROW+500(ROWL-500),500(R7)                                      
*                                                                               
         LA    R7,WKROW                                                         
         CLI   FINANSW,0                  CHK FOR FINANCIAL CLIENT              
         BE    AI1                                                              
***R***                                                                         
         CLC   QPROG,=C'R1'      SEE IF FINANCIAL REBATE BILLING                
         BE    AI1                                                              
         CLC   QPROG,=C'RD'  SEE IF FINANCIAL REBATE BILLING DRAFT              
         BE    AI1                                                              
***R***                                                                         
         MVC   WKROW(ROWTL),ROWTL(R7)      MOVE OPEN VALUES TO WKROW            
         MVC   WKROW+ADJDSP(8),OADJDSP(R7) MOVE OPEN ADJ + DUE                  
*                                                                               
AI1      OC    ADJDSP(4,R7),ADJDSP(R7)     NO ADJUSTMENT                        
         BZ    AIX                                                              
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         L     R0,DUEDSP(R7)           'DUE' FROM LAST INVB                     
         S     R0,ADJDSP(R7)           LESS ADJ = TRUE BILLED                   
         MVI   DUESW,C'A'                                                       
*                                                                               
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         LA    R1,P1+33                                                         
         CLI   LASTPINV+9,C' '       CHECK LENGTH OF LASTPINV                   
         BH    *+8                                                              
         LA    R1,P1+34                                                         
*                                                                               
*--->    MVC   P1+34(24),=C'AMOUNT BILLED ON INVOICE'                           
******** MVC   P1+34(L'PP@AMTBI),PP@AMTBI                                       
         MVC   0(L'PP@AMTBI,R1),PP@AMTBI                                        
         DROP  RE                                                               
*********MVC   P1+34+25(10),LASTPINV                                            
         MVC   25(10,R1),LASTPINV                                               
**NEW 10/18/89                                                                  
         CLI   TEST,C'T'                                                        
         BE    AI2                                                              
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO     GET NEXT BILL NO.                  
AI2      DS    0H                                                               
         BAS   RE,AIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
         LA    R4,MYX                                                           
         USING BFORMD,R4                                                        
*                                  TEST IF NEED COMMISSION BASIS                
         CLC   BFCOMP,FFS                                                       
         BE    AI4                                                              
         CLC   BFBASA(2),FFS                                                    
         BE    AI4                                                              
         CLI   CDSEP,C'Y'          SEE IF DOING SEPARATE CD INV                 
         BNE   *+8                                                              
         NI    BFBASA,X'FB'        YES - THEN NO CD IN BASE                     
*                                                                               
         CLC   BFBASA,BFBASB                                                    
         BE    AI4                 SAME AS DUE                                  
***NEW 5/20/91                                                                  
         MVC   BYTE,BFBASB                                                      
         CLI   BFPBASB,0          SEE IF PRINTING ANOTHER ADJ                   
         BE    *+10                                                             
         MVC   BYTE,BFPBASB                                                     
***NEW 5/20/91                                                                  
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-11(10),=C'NET AMOUNT'                                     
         MVC   ALCOL4-12(L'PP@NAMT),PP@NAMT                                     
         TM    BYTE,X'02'                                                       
         BZ    AI3                                                              
         TM    BYTE,X'04'          SEE IF SUBTRACTING CD                        
         BZ    AI3C                                                             
*--->    MVC   ALCOL4-19(18),=C'NET LESS CD AMOUNT'                             
         MVC   ALCOL4-21(L'PP@NLCA),PP@NLCA                                     
         B     AI3C                                                             
AI3      DS    0H                                                               
*--->    MVC   ALCOL4-20(19),=C'AGENCY COMM. AMOUNT'                            
         MVC   ALCOL4-20(L'PP@AGYCA),PP@AGYCA                                   
         TM    BYTE,X'08'                                                       
         BZ    AI3B                  AGY COMM - CD (NOT VALID)                  
         B     AI3C                                                             
*                                                                               
AI3B     DS    0H                                                               
*--->    MVC   ALCOL4-20(19),=C'       GROSS AMOUNT'                            
         MVC   ALCOL4-20(L'PPRGRSAM),PPRGRSAM                                   
         TM    BYTE,X'01'                                                       
         BZ    AI3C                                                             
         TM    BYTE,X'04'                                                       
         BZ    AI3C                                                             
*--->    MVC   ALCOL4-21(20),=C'GROSS LESS CD AMOUNT'                           
         MVC   ALCOL4-22(L'PP@GRSCD),PP@GRSCD                                   
         DROP  RE                                                               
*                                                                               
AI3C     DS    0H                                                               
**JW**                                                                          
         CLC   QAGENCY,=C'JW'       SPECIAL FOR JWT                             
         BE    AI3C3                ALWAYS LEAVE BYTE ALONE                     
**JW**                                                                          
         CLI   PROFB1A+1,C'Y'      SEE IF JUST PRINTING                         
         BE    *+10               COMMISSION ADJUSTMENT                         
         MVC   BYTE,BFBASB        NO - RERSET TO "REAL" BASIS                   
*                                                                               
AI3C3    DS    0H                                                               
*                          OTHERWISE I CAN LEAVE BYTE AS BFPBASB                
*                                                                               
         LA    R5,NDSP(R7)         POINT TO NET                                 
******   TM    BFBASB,X'02'       NET                                           
         TM    BYTE,X'02'  NET - NOW HONORS "SHOW ON BILL AS"                   
         BNZ   AI3C5                                                            
         LA    R5,ADSP(R7)                                                      
******** TM    BFBASB,X'08'       AGY COMM                                      
         TM    BYTE,X'08' AGY COMM - NOW HONORS "SHOW ON BILL AS"               
         BNZ   AI3C5                                                            
         LR    R5,R7              MUST BE GROSS                                 
*                                                                               
AI3C5    DS    0H                                                               
*                                  MUST STATE COMMISSION BASIS                  
         L     R0,0(R5)                                                         
***NOTE THIS MUST REMAIN BFBASB - I CAN'T USE BFPBASB HERE                      
******** TM    BFBASB,X'04'        SEE IF SUBTRACTING CD                        
         TM    BYTE,X'04' SEE IF SUBTRACTING CD (USE SHOW ON BILL AS)           
         BZ    AI3E                                                             
         S     R0,CDSP(R7)                                                      
         A     R0,ROWHL+CDSP(R7)   PREV BILLED CD (G-CD)-(BG-BCD)               
AI3E     S     R0,ROWHL(R5)        PREV BILLED                                  
         BAS   RE,AIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
AI4      DS    0H                                                               
         MVC   W,SPACES                                                         
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
*******  MVC   W+12(10),=C'AGENCY FEE'                                          
         MVC   W+05(L'PP@AGYF),PP@AGYF                                          
         CLI   PROFB1A+1,C'A'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    AI4C             (WITHOUT PCT.)                                  
*                                                                               
         CLI   PROFB1A+1,C'P'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    AI4C            (WITH PCT.)                                      
*                                                                               
         MVC   W+12(10),SPACES      CLEAR AGENCY FEE                            
*--->    MVC   W(21),=C'COMMISSION ADJUSTMENT'                                  
         MVC   W(L'PP@CMADJ),PP@CMADJ                                           
         DROP  RE                                                               
*                                                                               
AI4C     DS    0H                                                               
         CLI   PROFB1A+1,C'A'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    AI6              (WITHOUT PCT.)                                  
*                                                                               
         CLC   BFCOMP,FFS                                                       
         BE    AI6                                                              
*                                                                               
         CLI   PROFB1A+1,C'Y'  SEE IF ALWAYS PRINTING COMMISSION ADJ            
         BE    AI6                                                              
*                                                                               
*                                                                               
         LA    R6,W+23                                                          
***NEW 5/20/91                                                                  
         OC    BFPCOMP,BFPCOMP    SEE IF PRINTING A DIFFERENT PCT               
         BZ    AI4H                                                             
         TM    BFPCOMP,X'80'                                                    
         BZ    *+12                                                             
         MVI   0(R6),C'-'                                                       
         LA    R6,1(R6)                                                         
         MVI   CURTAB+3,4                                                       
*--->    EDIT  (B3,BFPCOMP),(7,0(R6)),4                                         
         CURED (B3,BFPCOMP),(8,0(R6)),CURTAB                                    
         MVI   CURTAB+3,2                                                       
         B     AI4X                                                             
***NEW 5/20/91                                                                  
AI4H     TM    BFCOMP,X'80'                                                     
         BZ    *+12                                                             
         MVI   0(R6),C'-'                                                       
         LA    R6,1(R6)                                                         
         MVI   CURTAB+3,4                                                       
*--->    EDIT  (B3,BFCOMP),(7,0(R6)),4                                          
         CURED (B3,BFCOMP),(8,0(R6)),CURTAB                                     
         MVI   CURTAB+3,2                                                       
*                                                                               
AI4X     DS    0H                                                               
         LA    RF,7(R6)                                                         
AI5      DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,AI5                                                           
         CLI   0(RF),C'.'                                                       
         BNE   AI5D                                                             
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
         B     AI5F                                                             
*                                                                               
AI5D     CLI   0(RF),C','        ALLOW FOR THOSE COUNTRIES THAT USE ,           
         BNE   AI5F              FOR DECIMAL POINT                              
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
*                                                                               
AI5F     LA    RE,W+22                                                          
         CLI   W+23,C' '                                                        
         BH    *+8                                                              
         LA    RE,W+23                                                          
         MVI   0(RE),C'('                                                       
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   2(17,RF),=C'PERCENT OF ABOVE)'                                   
         MVC   2(L'PP@PCTAB,RF),PP@PCTAB                                        
         DROP  RE                                                               
AI6      DS    0H                                                               
         LA    RF,W+50                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH OF STRING - 1                    
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
*                                                                               
         L     R0,ADJDSP(R7)           ADJUSTMENT AMOUNT                        
         BAS   RE,AIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
**GST                                                                           
*                                                                               
         XC    TOTVAT,TOTVAT                                                    
         CLI   CVATSW,0            IF HAVE VAT CODE                             
         BE    AI8                                                              
*                                                                               
         LA    R0,ALCOL4-ALINED     COLUMN FOR VAT CODE                         
         GOTO1 =V(VBPRNT),DMCB,(C'J',SAVBRK),(R0)                               
         MVC   TOTVAT,20(R1)      SAVE TOTAL VAT                                
*                                                                               
AI8      DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         L     R0,ADJDSP(R7)           ADJUSTMENT AMOUNT                        
*                                                                               
         A     R0,TOTVAT               ADD TOTAL VAT                            
*                                                                               
*--->    MVC   ALCOL4-17(16),=C'** AMOUNT DUE **'                               
         MVC   ALCOL4-17(L'PP@AMDUE),PP@AMDUE                                   
         LTR   R0,R0                                                            
         BNM   *+10                                                             
*--->    MVC   ALCOL4-20(19),=C'** CREDIT AMOUNT **'                            
         MVC   ALCOL4-20(L'PP@CDAMT),PP@CDAMT                                   
         DROP  RE                                                               
         BAS   RE,AIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
**EDI**                                                                         
         LA    R4,MYX        A(FORMULA)                                         
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)  DUE                          
*                                                                               
         LA    R4,RGRSD(R7)  GROSS                                              
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJX                                                          
         LA    R4,RNETD(R7)  NET                                                
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJX+4                                                        
         LA    R4,RCDD(R7)   CASH DISC.                                         
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJX+8                                                        
         GOTO1 ABILLEDI,DMCB,('EDMLST',LASTPINV),ADJX,ADJX+4,ADJX+8             
**EDI**                                                                         
         MVI   CNMTCD,C'A'         PRINT ADJ COMMENTS                           
         GOTO1 APRTCMNT                                                         
*                                                                               
         GOTO1 AWBILL                                                           
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   AI8B                                                             
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI FOR EACH INVOICE          
**EDI**                                                                         
*                                                                               
AI8B     DS    0H                                                               
         MVI   PRSW,C'F'           FLUSH PRINT LINES                            
         GOTO1 APRNT                                                            
         B     AIX                                                              
*                                                                               
         SPACE 3                                                                
AIEDIT   DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         L     RE,DUB                                                           
         BR    RE                                                               
         SPACE 2                                                                
AIX      DS    0H                                                               
         XIT1                                                                   
         DROP  R2                                                               
         DROP  R4                                                               
*                                                                               
MYX      DC    100X'00'      SHOULD BE ENOUGH                                   
*                                                                               
ADJX     DC    4F'0'        USED FOR EDMLST EDI CALL                            
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'CDINV - PRINT CASH DISC. INVOICE'                               
CDINV    CSECT                                                                  
         NMOD1 0,CDINV                                                          
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         CLI   SCBNCSW,C'C'            SEPARATE UFC COMMISSION BILL             
         BNE   CINV5                                                            
         CLI   PROFB2B+3,C'C'          CHK CD INV WITH COMM                     
         BE    CINV10                                                           
         B     CIX                                                              
*                                                                               
CINV5    CLI   SCBNCSW,C'N'            SEPARATE UFC NET BILL                    
         BNE   CINV10                  NO CD INV                                
         CLI   PROFB2B+3,C'N'          CHK CD INV WITH NET                      
         BE    CINV10                                                           
         B     CIX                                                              
*                                                                               
*                                                                               
CINV10   DS    0H                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)             POINT TO ACCUM                          
         LR    RF,R7                                                            
         AH    RF,=Y(TOTSIZE-BFORML)                                            
*****    LA    RF,TOTSIZE-BFORML(R7)                                            
         MVC   X(5),0(RF)               HOLD FORMULA IN X                       
         MVC   MYCX(BFORML),0(RF)       HOLD FORMULA IN MYCX                    
**GST                                                                           
         MVC   CVATSW,BFVATSW-BFORMD(RF)    SEE IF VATABLE                      
*                                                                               
         AH    R7,=Y(MAXMOS*ROWL)                                               
*                                                                               
         L     R0,CDSP(R7)              CHK FOR ZERO CD INV                     
         S     R0,ROWHL+CDSP(R7)                                                
         LCR   R0,R0                                                            
         LTR   R0,R0                                                            
         BZ    CIX                      NO ZERO CD INVOICES                     
*                                                                               
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'C'                                                       
*                                                                               
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   P1+18(49),=C'**  THIS INVOICE REPRESENTS CASH DISCOUNTS          
*--->          OF  **'                                                          
         MVC   P1+18(L'PP@THE01),PP@THE01                                       
*--->    MVC   P2+18(49),=C'**  ITEMS BILLED ON INVOICE                         
*--->              **'                                                          
         MVC   P2+18(L'PP@ITEM),PP@ITEM                                         
         DROP  RE                                                               
         MVC   P2+18+28(10),LASTPINV                                            
         CLI   TEST,C'T'                                                        
         BE    CI2                                                              
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO     GET NEXT BILL NO.                  
CI2      DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
**GST                                                                           
*                                                                               
         XC    TOTVAT,TOTVAT                                                    
         CLI   CVATSW,0            IF HAVE VAT CODE                             
         BE    CI8                                                              
*                                                                               
         L     R0,CDSP(R7)        CD AMOUNT -GROSS                              
         S     R0,ROWHL+CDSP(R7)   SUBTRACT PREV BILLED CD                      
         LCR   R0,R0               REVERSE SIGN                                 
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-17(16),=C'** AMOUNT DUE **'                               
         MVC   ALCOL4-17(L'PP@AMDUE),PP@AMDUE                                   
         LTR   R0,R0                                                            
         BNM   *+10                                                             
*--->    MVC   ALCOL4-20(19),=C'** CREDIT AMOUNT **'                            
         MVC   ALCOL4-20(L'PP@CDAMT),PP@CDAMT                                   
         DROP  RE                                                               
         BAS   RE,CIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
         LA    R0,ALCOL4-ALINED                                                 
         GOTO1 =V(VBPRNT),DMCB,(C'C',SAVBRK),(R0)                               
         MVC   TOTVAT,20(R1)            SAVE TOTAL VAT                          
**                                                                              
CI8      DS    0H                                                               
         L     R0,CDSP(R7)        CD AMOUNT -GROSS                              
         S     R0,ROWHL+CDSP(R7)   SUBTRACT PREV BILLED CD                      
         LCR   R0,R0               REVERSE SIGN                                 
*                                                                               
         L     RE,TOTVAT           ADD TOTAL VAT                                
*                                 DO NOT REVERSE SIGN OF TOTVAT                 
*                                 HAS IT HAS BEEN REVERSED IN VBPRNT            
         AR    R0,RE                                                            
*                                                                               
CI10     L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-17(16),=C'** AMOUNT DUE **'                               
         MVC   ALCOL4-17(L'PP@AMDUE),PP@AMDUE                                   
         LTR   R0,R0                                                            
         BNM   *+10                                                             
*--->    MVC   ALCOL4-20(19),=C'** CREDIT AMOUNT **'                            
         MVC   ALCOL4-20(L'PP@CDAMT),PP@CDAMT                                   
         DROP  RE                                                               
         BAS   RE,CIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
**EDI**                                                                         
         LA    R4,MYCX       A(FORMULA)                                         
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)  DUE                          
*                                                                               
         LA    R4,RGRSD(R7)  GROSS                                              
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJCX                                                         
         LA    R4,RNETD(R7)  NET                                                
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJCX+4                                                       
         LA    R4,RCDD(R7)   CASH DISC.                                         
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJCX+8                                                       
         GOTO1 ABILLEDI,DMCB,('EDMLST',LASTPINV),ADJCX,ADJCX+4,ADJCX+8          
**EDI**                                                                         
         MVI   CNMTCD,C'C'         PRINT CD COMMENTS                            
         GOTO1 APRTCMNT                                                         
*                                                                               
         GOTO1 AWBILL                                                           
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   CI8B                                                             
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI FOR EACH INVOICE          
**EDI**                                                                         
*                                                                               
CI8B     MVI   PRSW,C'F'           SET TO FLUSH LINES NOW                       
         GOTO1 APRNT                                                            
         B     CIX                                                              
*                                                                               
         SPACE 3                                                                
CIEDIT   DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         L     RE,DUB                                                           
         BR    RE                                                               
         SPACE 2                                                                
CIX      DS    0H                                                               
         XIT1                                                                   
         DROP  R2                                                               
         LTORG                                                                  
*                                                                               
MYCX     DC    100X'0'                                                          
*                                                                               
ADJCX    DC    4F'0'                                                            
*                                                                               
         TITLE 'AORINV - AOR INVOICE'                                           
AORINV   CSECT                                                                  
         NMOD1 0,AORINV                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         XC    AOIDISK,AOIDISK         CLEAR EACH TIME                          
*                                                                               
         CLI   AORSW,C'Y'              ANY AOR                                  
         BNE   AOIX                    NO                                       
*                                                                               
         CLI   SCBNCSW,C'N'            NO AOR FOR COMM NET BILL                 
         BE    AOIX                                                             
*                                                                               
         CLI   AORLOPT,C'N'              OPTION TO LIST PRD/EST/MOS             
         BNE   AOI20                                                            
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)               POINT TO ACCUM                        
         LR    RF,R7                                                            
         AH    RF,=Y(TOTSIZE-BFORML)                                            
         MVC   X(BFORML),0(RF)            SET FORMULA AND AOR PCT               
*                                                                               
         AH    R7,=Y(MAXMOS*ROWL)         POINT TO TOTAL ROW                    
*                                                                               
         ICM   R6,15,PEPTABN                                                    
         BZ    AOIX                                                             
*                                                                               
         L     RF,APEPTAB                                                       
         USING PEPTD,RF                                                         
*                                                                               
         MVI   BYTE,0                                                           
         XC    LASTAOVS,LASTAOVS                                                
*                                                                               
AOI3     DS    0H                                                               
         OC    PEPTAORA,PEPTAORA         TEST FOR ANY ACCOUNT                   
         BZ    AOI3P                                                            
*                                                                               
         MVC   AOIDISK,PEPTAORD    MUST SAVE AOR DISK ADDRESS                   
*                                                                               
         MVI   BYTE,1              YES, SET FOUND ONE                           
*                                  AND 'ROLL-UP' AOR VAT CODES                  
         LA    R4,LASTAOVS                                                      
         LA    R5,PEPTAOVS                                                      
         LA    R0,NPROVS+1                                                      
*                                                                               
AOI3D    DS    0H                                                               
         CLI   0(R4),0             IF NO CODE YET                               
         BNE   *+14                                                             
         MVC   0(1,R4),0(R5)       JUST SAVE THIS ONE                           
         B     AOI3F                                                            
         CLC   0(1,R4),0(R5)       IS THIS ONA SAME AS SAVED?                   
         BE    AOI3F               YES, OK                                      
         MVI   0(R4),X'FF'          NO SET MIXED                                
*                                                                               
AOI3F    DS    0H                                                               
         LA    R4,1(R4)            NEXT PROVINCE                                
         LA    R5,1(R5)                                                         
         BCT   R0,AOI3D                                                         
*                                                                               
AOI3P    LA    RF,PEPTABRL(RF)          NOT AMOUNT                              
         BCT   R6,AOI3                                                          
         CLI   BYTE,0                  TEST ANY ACCOUNTS FOUND                  
         BE    AOIX                                                             
         DROP  RF                                                               
*                                                                               
AOI4     DS    0H                                                               
***NEW 5/17/91                                                                  
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'R'                                                       
*                                                                               
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
*                                                                               
         L     R4,=V(DICSECT)                                                   
         AH    R4,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,R4                                                        
*--->    MVC   P1+24(44),=C'** BILLED TO CLIENT ON INVOICE NN-NN-NNNN *         
*--->          *'                                                               
         MVC   P1+24(L'PP@BLDTO),PP@BLDTO                                       
**NEW 10/18/89               WAS PINVNO                                         
         MVC   P1+24+31(10),LASTPINV                                            
**NEW 10/18/89                                                                  
*--->    MVC   P2+24(44),=C'**     SUBJECT TO AGENCY OF RECORD FEE    *         
*--->          *'                                                               
         MVC   P2+24(L'PP@SUBTO),PP@SUBTO                                       
         CLI   TEST,C'T'                                                        
         BE    AOI5                                                             
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO     GET NEXT BILL NO.                  
*                                                                               
AOI5     DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
*--->    MVC   P1+30(32),=C'BASIS AMOUNT FROM CLIENT INVOICE'                   
         MVC   P1+21(L'PP@BA01),PP@BA01                                         
         DROP  R4                                                               
*                                                                               
         LR    R5,R7                                                            
AOI5D    DS    0H                                                               
**2/22/89L     R0,0(R5)                                                         
**2/22/89S     R0,ROWHL(R5)                SUBTRACT PREV BILLING                
*                                                                               
         L     R0,AORBDSP(R7)                                                   
**2/22/89                                                                       
**NEW 10/18/89                                                                  
         LA    R1,ALCOL4                                                        
**NEW 10/18/89                                                                  
         BAS   RE,AOIEDIT                                                       
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
         CLC   X+BFAORPCT-BFORMD(3),FFS        IF MIXED PCTS, SKIP              
         BE    AOI7                                                             
         MVC   W,SPACES                                                         
         LA    R4,W                                                             
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+1(3),X+BFAORPCT-BFORMD                                      
         TM    FULL+1,X'F0'         SEE IF NEGATIVE                             
         BNO   *+8                                                              
         MVI   FULL,X'FF'                                                       
         L     RE,FULL                                                          
         MVI   CURTAB+3,4                                                       
*--->    EDIT  (RE),(7,0(R4)),4,ALIGN=LEFT,FLOAT=-                              
         CURED (RE),(7,0(R4)),CURTAB,ALIGN=LEFT,FLOAT=-                         
         MVI   CURTAB+3,2                                                       
         CLC   5(2,R4),=C'00'                                                   
         BNE   *+14                                                             
         MVC   5(2,R4),=C'  '                                                   
         SH    R0,=H'2'                                                         
         AR    R4,R0                                                            
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   1(12,R4),=C'PCT OF ABOVE'                                        
         MVC   1(L'PP@POFA,R4),PP@POFA                                          
         DROP  RE                                                               
         MVC   ALCOL4-25(24),W                                                  
*                                                                               
AOI7     DS    0H                                                               
         L     R0,AORDSP(R7)           AOR AMOUNT                               
**NEW 10/18/89                                                                  
         LA    R1,ALCOL4                                                        
**NEW 10/18/89                                                                  
         BAS   RE,AOIEDIT                                                       
*                                                                               
***NEW 5/17/91   CHANGED FROM CVATSW,0 TO CVATCOD,0                             
         CLI   CVATCOD,0           IF HAVE VAT CODE                             
         BE    AOI10                                                            
*                                                                               
****     NEW CODE FOR QST                                                       
         GOTO1 APRNT                                                            
         LA    R0,ALCOL4-ALINED                                                 
         GOTO1 =V(VBPRNT),DMCB,(C'A',SAVBRK),(R0),LASTAOVS,AORDSP(R7), X        
               VATADSP(R7),0                                                    
         MVC   TOTVAT,20(R1)        SAVE TOTAL OF VATS                          
*                                                                               
         L     R0,AORDSP(R7)                                                    
         A     R0,TOTVAT                                                        
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
AOI10    DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
****                                                                            
****     NOTE IN THIS FORMAT-AOR COMMENTS WILL ONLY PRINT                       
****     FROM THE LAST SAVE AOR DISK ADDRESS                                    
****                                                                            
*****    L     RF,PPFILEC      READ AOR RECORD INTO PCONREC                     
*****    USING PPFILED,RF      AND CHECK FOR STANTARD COMMENT ELEM              
******   LA    R1,PCONREC                                                       
*****    DROP  RF                                                               
*                                                                               
         LA    R1,AORWRK                                                        
         ST    R1,AREC                                                          
         OC    AOIDISK,AOIDISK                                                  
         BNZ   *+6                                                              
         DC    H'0'                SOMETHING VERY WRONG                         
*                                                                               
         MVC   KEY+27(4),AOIDISK   AOR DISK ADDRESS                             
         GOTO1 GETPRT                                                           
*                                                                               
         CLI   PRDCTL,C'T'     SEE IF PRODUCTS TOGETHER                         
         BNE   AOI10H          ONLY PRINT COMMENT FOR PRD=AAA                   
         L     RF,AREC                                                          
         CLC   AORKPRD-AORREC(3,RF),=C'AAA'                                     
         BNE   AOI10W                                                           
*                                                                               
AOI10H   DS    0H                                                               
         CLI   ESTCTL,C'S'         SEE IF EST ON SEPARATE INV                   
         BE    AOI10P              ALWAYS TRY TO PRINT THE COMMENT              
*                                                                               
*                                  IF EST IS NOT SEPARATE                       
*                                  ONLY TRY TO PRINT COMMENT                    
*                                  IF I HAVE AN "ALL" EST                       
*                                  AOR RECORD                                   
         L     RF,AREC                                                          
         CLC   AORKEST-AORREC(2,RF),=X'FFFF'                                    
         BNE   AOI10W                                                           
*                                                                               
AOI10P   DS    0H                                                               
         BAS   RE,AOICOMM    CHECK FOR AOR STANDARD COMMENT                     
*                                                                               
AOI10W   DS    0H                                                               
         GOTO1 AWBILL                                                           
*                                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES NOW                       
         GOTO1 APRNT                                                            
         B     AOIX                                                             
         SPACE 3                                                                
***********************************************************************         
*        PRD/EST/MOS LISTING ON AOR BILLS                                       
***********************************************************************         
         SPACE 1                                                                
AOI20    DS    0H                                                               
**NEW 3/12/91                                                                   
         MVI   AORFRST,C'Y'                                                     
         CLI   AORLOPT,C'C'                                                     
         BNE   AOI22                                                            
         CLI   AORLCTL,C'P'                                                     
         BNE   AOIX                                                             
*                                                                               
AOI22    DS    0H                                                               
**NEW 3/12/91                                                                   
         ICM   R6,15,PEPTABN       SORT PEPTAB ON AOR ACCT                      
         BZ    AOIX                                                             
         L     R7,APEPTAB                                                       
         USING PEPTD,R7                                                         
*                            NOTE USE OF XSORTL FOR LONG RECORDS                
         GOTO1 =V(XSORTL),DMCB,(R7),(R6),PEPTABRL,                     X        
               L'PEPTAORA+L'PEPTAOVS,PEPTAORA-PEPTD                             
*                                                                               
         XC    LASTAORA,LASTAORA                                                
         XC    LASTAOVS,LASTAOVS                                                
***NEW 5/17/91                                                                  
         MVI   LASTAORV,0                                                       
***NEW 5/17/91                                                                  
*                                                                               
AOI30    DS    0H                                                               
*                  WAS OC  PEPTAOR,PEPTAOR (SKIP IF NO AOR AMOUNT)              
         OC    PEPTAORA,PEPTAORA   SKIP IF NO AOR ACCOUNT                       
         BZ    AOI70                                                            
         CLC   PEPTAORA,LASTAORA   NEW AOR ACCT = NEW BILL                      
         BNE   AOI40                                                            
         OC    PEPTAOVS,SPACES                                                  
         CLC   PEPTAOVS,LASTAOVS   NEW GST/PST STATUS = NEW BILL                
         BE    AOI60                                                            
*                                  FINISH UP OLD BILL                           
*                                                                               
AOI40    DS    0H                                                               
         OC    LASTAORA,LASTAORA   NOT IF FIRST TIME                            
         BZ    AOI44                                                            
*            AT LAST ENTRY OR CHANGE OF ACCOUNT                                 
*            I MAY NEED TO PRINT A COMMENT                                      
         OC    LASTAORD,LASTAORD      BE SURE I HAVE AN ADDRESS                 
         BZ    AOI40F              GO PRINT TOTALS                              
*                                                                               
*****    L     RF,PPFILEC          USE CONTRACT AREA                            
****     USING PPFILED,RF                                                       
*****    LA    R1,PCONREC                                                       
******   DROP  RF                                                               
*                                                                               
         LA    R1,AORWRK                                                        
         ST    R1,AREC                                                          
         MVC   KEY+27(4),LASTAORD  DISK ADDRESS                                 
         GOTO1 GETPRT                                                           
*                                                                               
         BAS   RE,AOICOMM      GO CHECK FOR AOR STANDARD COMMENT                
*                              AND PRINT IT                                     
AOI40F   DS    0H                                                               
         XC    LASTAORD,LASTAORD     CLEAR LAST SAVE AOR DISK ADDR              
*                                                                               
         GOTO1 APRNT                                                            
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL1+8(7),=C'TOTALS*'                                          
         MVC   ALCOL1+8(L'PP@TOTAL),PP@TOTAL                                    
         DROP  RE                                                               
         L     R0,X                TOTAL GROSS                                  
         LA    R1,ALCOL2                                                        
         BAS   RE,AOIEDIT                                                       
         L     R0,X+8              TOTAL AOR                                    
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         L     R0,X+4              TOTAL OF BASIS                               
         LA    R1,ALSTRIP                                                       
         BAS   RE,AOIEDIT                                                       
*                                                                               
**GET                                                                           
***NEW 5/17/91         WAS CVATSW,0                                             
         CLI   CVATCOD,0           IF HAVE VAT                                  
         BE    AOI42                                                            
         CLI   LASTAORV,C' '       ALSO SKIP IF NO VAT FOR                      
         BNH   AOI42               "OTHER AGENCY"                               
*                                                                               
*                                                                               
         GOTO1 APRNT                                                            
         LA    R0,ALCOL4-ALINED                                                 
         GOTO1 =V(VBPRNT),DMCB,(C'A',SAVBRK),(R0),LASTAOVS,            X        
               X+8,X+16,0          (VAT BASIS AND PROV. VATS)                   
         MVC   TOTVAT,20(R1)                                                    
*                                                                               
         LA    R2,132(R2)                                                       
         L     R0,X+8              AOR                                          
         A     R0,TOTVAT           PLUS TOTAL VAT                               
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
AOI42    DS    0H                                                               
         GOTO1 APRNT                                                            
AOI44    DS    0H                                                               
         LTR   R6,R6               END OF TABLE                                 
         BNP   AOI80                                                            
*                                                                               
AOI50    DS    0H                  START NEW BILL                               
         MVC   LASTAORA,PEPTAORA      SAVE ACCOUNT                              
***NEW 5/17/91                                                                  
         MVC   LASTAOVS,PEPTAOVS      AND SAVE VAT CODES                        
         OC    LASTAOVS,SPACES                                                  
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'R'                                                       
         XC    X,X                 CLEAR TOTALS                                 
*                                                                               
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
*                                  SET AOR ADDRESS                              
*****    L     RF,PPFILEC          USE CONTRACT AREA                            
*****    USING PPFILED,RF                                                       
*****    LA    R1,PCONREC                                                       
*****    DROP  RF                                                               
*                                                                               
         LA    R1,AORWRK                                                        
         ST    R1,AREC                                                          
         MVC   KEY+27(4),PEPTAORD  DISK ADDRESS                                 
         GOTO1 GETPRT                                                           
         L     RF,AREC                                                          
         USING AORREC,RF                                                        
*                                                                               
         LA    R1,AORELS                                                        
*                                                                               
AOI52    DS    0H                                                               
         CLI   0(R1),X'02'         ADDRESS ELEM                                 
         BE    AOI53                                                            
         CLI   0(R1),0             EOR                                          
         BE    AOI55                                                            
*                                                                               
AOI52D   DS    0H                                                               
         ZIC   R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     AOI52                                                            
*                                                                               
AOI53    DS    0H                  AOR ADDRESS ELEM                             
         USING AORADREL,R1                                                      
         L     RE,AAORADDR                                                      
         MVC   000(30,RE),AORLIN1                                               
         MVC   036(30,RE),AORLIN2                                               
         MVC   072(30,RE),AORLIN3                                               
         MVC   108(30,RE),AORLIN4                                               
         CLC   PEPTAORA(14),AORLIN1       CHECK FOR "DUMMY" ACCOUNT             
         BE    *+10                       THAT I PUT THERE                      
         MVC   144+36-14(14,RE),PEPTAORA    ACCT CODE AT END OF ADDR            
         DROP  RF                                                               
         DROP  R1                                                               
*                                                                               
AOI55    DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   P1+2(62),=C'** AGENCY OF RECORD FEES - CLIENT INVOICE NU         
*--->          MBER NN-NN-NNNN **'                                              
         MVC   P1+2(L'PP@AGYOF),PP@AGYOF                                        
         DROP  RE                                                               
         MVC   P1+2+46(10),LASTPINV                                             
**NEW 3/12/91                                                                   
         CLI   AORLOPT,C'C'                                                     
         BNE   AOI55D                                                           
         CLI   P1+2,C'T'             SEE IF FRENCH (T OF TARIF)                 
         BNE   AOI55C                                                           
         MVC   P1+30(29),SPACES      CLEAR CLIENT INVOICE MESSAGE               
         B     AOI55D                                                           
*                                                                               
AOI55C   MVC   P1+26(32),SPACES      CLEAR CLIENT INVOICE MESSAGE               
***                                                                             
*** NOTE THAT MESSAGE MUST BE SAME FORMAT IN ALL LANGUAGES ***                  
***                                                                             
AOI55D   DS    0H                                                               
         CLI   TEST,C'T'                                                        
         BE    AOI56                                                            
**NEW 3/12/91                                                                   
         CLI   AORLOPT,C'C'    SEE IF CLIENT RECAP MODE                         
         BNE   AOI55E                                                           
         CLI   AORFRST,C'Y'    ADD FIRST TIME                                   
         BE    AOI56           NO - ALREADY HAVE NUMBER                         
AOI55E   DS    0H                                                               
**NEW 3/12/91                                                                   
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO     GET NEXT BILL NO.                  
*                                                                               
AOI56    DS    0H                                                               
**NEW 3/12/91                                                                   
         MVI   AORFRST,C'N'                                                     
**NEW 3/12/91                                                                   
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                                                               
AOI60    DS    0H                  CONTINUE BILL                                
         MVC   PEPTAORI,INVNO      SET INVOICE NUMBER IN PEPTAB                 
*                                                                               
         CLI   PEPTMED,0          WILL BE NON-ZERO FOR                          
         BE    AOI60D             MULTI-MEDIA REQUEST                           
         CLC   LASTAMPE(1),PEPTMED  CHECK FOR CHANGE OF MEDIA                   
         BE    AOI60D                                                           
         XC    KEY,KEY                                                          
         MVC   KEY(2),QAGENCY                                                   
         MVC   KEY+2(1),PEPTMED                                                 
         MVI   KEY+3,X'01'                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(4),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'          SOMETHING VERY WRONG                               
         GOTO1 GETAGY                                                           
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         MVC   P1(10),PAGYMED                                                   
*                                                                               
         DROP  RF                                                               
*                                                                               
         BAS   RE,AULINE                                                        
         GOTO1 APRNT                                                            
*                                                                               
AOI60D   DS    0H                                                               
         OC    LASTAMPE,LASTAMPE   SEE IF FIRST TIME                            
         BZ    AOI60L                                                           
         CLC   LASTAMPE,PEPTMED    SEE IF MED/FIN/PRD/EST CHGED                 
         BE    AOI60L                                                           
*                                                                               
*                                                                               
*                                  MUST READ AOR RECORD HERE                    
*                                  TO PRINT COMMENT                             
*                                  SINCE THE ACCOUNT MAY BE THE SAME            
*                                  BUT THE COMMENT MIGHT BE DIFFERENT           
         OC    LASTAORD,LASTAORD      BE SURE I HAVE AN ADDRESS                 
         BZ    AOI60L                                                           
******   L     RF,PPFILEC          USE CONTRACT AREA                            
******   USING PPFILED,RF                                                       
******   LA    R1,PCONREC          READ INTO CONTRACT AREA                      
******   DROP  RF                                                               
*                                                                               
         LA    R1,AORWRK                                                        
         ST    R1,AREC                                                          
         MVC   KEY+27(4),LASTAORD  DISK ADDRESS                                 
         GOTO1 GETPRT                                                           
*                                                                               
         L     R1,AREC                                                          
         CLC   AORKEST-AORREC(2,R1),=X'FFFF'                                    
         BNE   AOI60F     IF EST LEVEL MUST AOR COMMENT NOW                     
*                     MUST BE PRODUCT LEVEL                                     
*                     ONLY PRINT IF PRODUCT HAS CHANGED AS WELL                 
         CLC   LASTAMPE(5),PEPTMED   SEE IF MED/FIN/PRD SAME                    
         BE    AOI60L    PRD IS THE SAME - DON'T AOR COMMENT NOW                
*                        IT WILL PRINT WHEN PRD CHANGES                         
*                                                                               
AOI60F   DS    0H                                                               
         BAS   RE,AOICOMM      GO CHECK FOR AOR STANDARD COMMENT                
*                              AND PRINT IT                                     
*                                                                               
AOI60L   DS    0H                                                               
         L     RF,ADCLT                                                         
         XC    KEY,KEY                                                          
         MVC   KEY(07),0(RF)                                                    
*                                                                               
         CLI   PEPTMED,0          MULTI-MEDIA REQUEST                           
         BE    *+10                                                             
         MVC   KEY+2(1),PEPTMED                                                 
*                                                                               
         MVI   KEY+3,X'06'                                                      
         MVC   KEY+7(3),PEPTPRD    3 CHAR PRD CODE                              
         L     RF,ADPRD                                                         
         CLC   KEY(10),0(RF)       TEST ALREADY HAVE PRDHDR                     
         BE    AOI62                                                            
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE     MUST FIND PRD                                
         BE    *+6                                                              
         DC    H'0'                                                             
         L     RF,ADPRD                                                         
         ST    RF,AREC                                                          
         GOTO1 GETPRT                                                           
*                                                                               
AOI62    DS    0H                                                               
         L     RF,ADPRD                                                         
         MVC   P1(3),PPRDKPRD-PPRDREC(RF)                                       
*                                                                               
         MVC   W(20),PPRDNAME-PPRDREC(RF)                                       
         OC    W(20),SPACES                                                     
         GOTO1 ACHOPPER,DMCB,(20,W),(16,P1+4),(C'P',2)                          
*                                                                               
         EDIT  (B2,PEPTEST),(3,ALCOL1+1),FILL=0                                 
         GOTO1 DATCON,DMCB,(3,PEPTMOS),(6,ALCOL1+8)                             
*                                                                               
         MVC   WRKGRS,PEPTGRS                                                   
         MVC   WRKNET,PEPTNET                                                   
         MVC   WRKAC,PEPTAC                                                     
*                                                                               
         TM    FINANSW,X'80'       SEE IF COST 2 CLIENT                         
         BNO   AOI62C                                                           
         CLI   PROFAOR+5,C'Y'      SEE IF BASED ON COST 2 (OPEN)                
         BNE   AOI62C                                                           
*                                                                               
         MVC   WRKGRS,PEPTOGRS     SET TO COST2 (OPEN) AMOUNTS                  
         MVC   WRKNET,PEPTONET                                                  
         MVC   WRKAC,PEPTOAC                                                    
*                                                                               
AOI62C   DS    0H                                                               
         L     R0,WRKGRS           TOTAL GROSS                                  
**NEW 3/12/91                                                                   
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX                          
         BE    *+8                                                              
         S     R0,PEPTTAX          NO - REMOVE IT                               
**NEW 3/12/91                                                                   
         A     R0,X                                                             
         ST    R0,X                                                             
         L     R0,PEPTAOR          AND AOR AMOUNT                               
         A     R0,X+8                                                           
         ST    R0,X+8                                                           
*                                                                               
         L     R0,WRKAC            AC - NEVER SUBTRACT TAX                      
         TM    PEPTAORB,X'80'                                                   
         BO    AOI62ADD                                                         
*                                                                               
         L     R0,WRKNET           NET                                          
         TM    PEPTAORB,X'40'                                                   
         BO    AOI62TAX                                                         
         L     R0,WRKGRS           GROSS                                        
         CLI   PEPTAORB,0                                                       
         BE    AOI62TAX                                                         
         DC    H'0'                BAD AOR BASIS                                
*                                                                               
AOI62TAX DS    0H                                                               
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX                          
         BE    *+8                                                              
         S     R0,PEPTTAX          NO - REMOVE IT                               
*                                                                               
AOI62ADD A     R0,X+4                                                           
         ST    R0,X+4               TOTAL OF BASIS IN X+4                       
*                                                                               
**GST                                                                           
         LA    R1,NPROVS+1                                                      
         LA    RE,PEPTVATA                                                      
         LA    RF,X+16                                                          
AOI63    DS    0H                                                               
         L     R0,0(RE)                                                         
         A     R0,0(RF)                                                         
         ST    R0,0(RF)                                                         
         LA    RE,4(RE)                                                         
         LA    RF,4(RF)                                                         
         BCT   R1,AOI63                                                         
*                                                                               
         L     R0,WRKGRS           GROSS                                        
**NEW 3/12/91                                                                   
         CLI   AORTXOPT,C'Y'                                                    
         BE    *+8                                                              
         S     R0,PEPTTAX                                                       
**NEW 3/12/91                                                                   
         LA    R1,ALCOL2                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         ICM   R0,15,PEPTAOR       AOR AMOUNT                                   
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         ICM   RE,15,PEPTAORP         AOR PERCENT                               
         LA    R8,ALCOL3+1                                                      
         MVI   CURTAB+3,4                                                       
*--->    EDIT  (RE),(7,0(R8)),4,FLOAT=-                                         
         CURED (RE),(7,0(R8)),CURTAB,FLOAT=-                                    
         MVI   CURTAB+3,2                                                       
         CLC   5(2,R8),=C'00'                                                   
         BNE   *+10                                                             
         MVC   5(2,R8),SPACES                                                   
         LA    R8,8(R8)                                                         
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
         MVC   0(L'PP@NET,R8),PP@NET                                            
         L     R0,WRKNET                                                        
         TM    PEPTAORB,X'40'                                                   
         BO    AOI64                                                            
*                                                                               
*--->    MVC   0(5,R8),=C'GROSS'   BASIS                                        
         MVC   0(L'PP@GROSS,R8),PP@GROSS                                        
         L     R0,WRKGRS                                                        
         CLI   PEPTAORB,0                                                       
         BE    AOI64                                                            
*                                                                               
*--->    MVC   0(5,R8),=C'COMM.'                                                
         MVC   0(L'PP@COMM,R8),PP@COMM                                          
         DROP  RE                                                               
*                                                                               
         L     R0,WRKAC                                                         
         TM    PEPTAORB,X'80'         AGY COMMISSION                            
         BO    AOI65                 **NEW 3/12/91 WAS AOI64                    
         DC    H'0'                   INVALID AOR BASIS                         
*                                                                               
AOI64    DS    0H                                                               
**NEW 3/12/91                                                                   
         CLI   AORTXOPT,C'Y'                                                    
         BE    AOI65                                                            
         S     R0,PEPTTAX                                                       
**NEW 3/12/91                                                                   
*                                                                               
AOI65    DS    0H                                                               
         LA    R1,ALSTRIP          BASIS AMOUNT IN STRIP                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         GOTO1 APRNT                                                            
*                                                                               
AOI70    DS    0H                  NEXT PEPTAB ENTRY                            
         MVC   LASTAMPE,PEPTMED    SAVE LAST MED/FIN/PRD/EST                    
         MVC   LASTAORD,PEPTAORD   AND DISK ADDRESS                             
         LA    R7,PEPTABRL(R7)                                                  
         BCT   R6,AOI30                                                         
*                                                                               
AOI70X   XC    LASTAMPE,LASTAMPE   CLEAR MED/FIN/PRD/EST                        
         B     AOI40               GO PRINT TOTALS                              
*                                                                               
AOI80    DS    0H                  END                                          
         GOTO1 AWBILL                                                           
         MVI   PRSW,C'F'           SET TO FLUSH LINES NOW                       
         GOTO1 APRNT                                                            
*                                                                               
**NEW 3/12/91                                                                   
         MVI   DUESW,C'N'                                                       
*                                                                               
         CLI   AORLOPT,C'C'        SEE IF DOING 'CLIENT' SUMMARY                
         BNE   AOIX                                                             
         OC    LASTAORA,LASTAORA  AND ACTUALLY DID SOMETHING                    
         BZ    AOIX                                                             
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO                                        
*                                  MUST BUMP BILL NUMBER WHEN DONE              
         B     AOIX                                                             
         SPACE 3                                                                
AOIEDIT  DS    0H                                                               
         ST    RE,DUB                                                           
         LR    R5,R1                                                            
*--->    EDIT  (R0),(16,0(R5)),2,COMMAS=YES,CR=YES                              
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
         LR    R1,R5                                                            
         L     RE,DUB                                                           
         BR    RE                                                               
*                                                                               
         SPACE 2                                                                
AOIX     DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*    ROUTINE TO FIND AND PRINT STANDARD COMMENT FROM AOR RECORD                 
*    PCONREC SHOULD CONTAIN AOR RECORD                                          
*                                                                               
AOICOMM  NTR1                                                                   
*****    L     RF,PPFILEC      READ AOR RECORD INTO PCONREC                     
*****    USING PPFILED,RF      AND CHECK FOR STANTARD COMMENT ELEM              
*****    LA    R1,PCONREC                                                       
*****    DROP  RF                                                               
*****    LR    RF,R1               AOR RECORD IS NOW IN PCONREC                 
*                                                                               
         LA    RF,AORWRK       AOR RECORD NOW IN AORWRK                         
         USING AORREC,RF                                                        
*                                                                               
         LA    R1,AORELS                                                        
*                                                                               
AOIC2    DS    0H                                                               
         CLI   0(R1),X'66'         STANDARD COMMENT ELEM                        
         BE    AOIC3                                                            
         CLI   0(R1),0             EOR                                          
         BE    AOICX                                                            
*                                                                               
AOIC2D   DS    0H                                                               
         ZIC   R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     AOIC2                                                            
*                                                                               
AOIC3    DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(3),RCSVAGY                                                   
*                                                                               
         MVC   KEY+2(1),AORKMED    USE MEDIA FROM AORREC                        
*                                                                               
*****    OC    AMED,AMED    FOR MULTI-MEDIA REQ GET MEDIA FROM AMED             
*****    BZ    AOIC3D                                                           
*****    L     RF,AMED                                                          
*****    MVC   KEY+2(1),0(RF)                                                   
*                                                                               
AOIC3D   MVI   KEY+3,X'40'                                                      
         MVC   KEY+4(6),2(R1)      COMMENT CODE FROM ELEM                       
         L     RF,ACOMREC                                                       
         CLC   KEY(25),0(RF)                                                    
         BE    AOIC4               ALREADY HAVE                                 
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BNE   AOIC13                                                           
*                                                                               
         MVC   AREC,ACOMREC                                                     
         GOTO1 GETPRT                                                           
*                                                                               
AOIC4    DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                  COUNT LINES NEEDED                           
         SR    RF,RF                                                            
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
         SR    R0,R0                                                            
AOIC6    DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    AOIC9                                                            
         CLI   0(R2),X'40'                                                      
         BNE   AOIC8                                                            
         LA    R0,1                                                             
         CLI   2(R2),C'+'                                                       
         BNE   AOIC7                                                            
         CLI   3(R2),C'1'                                                       
         BL    AOIC7                                                            
         MVC   BYTE,3(R2)                                                       
         NI    BYTE,X'0F'                                                       
         IC    R0,BYTE                                                          
AOIC7    DS    0H                                                               
         AR    RF,R0                                                            
AOIC8    DS    0H                                                               
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     AOIC6                                                            
*                                                                               
AOIC9    DS    0H                                                               
         LA    RF,1(RF)                                                         
         STC   RF,ALLOWLIN         NUMBER OF LINES NEEDED                       
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
AOIC10   DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    AOIC13                                                           
         CLI   0(R2),X'40'                                                      
         BNE   AOIC12                                                           
         LA    R6,2                                                             
         CLI   2(R2),C'+'                                                       
         BNE   AOIC11                                                           
         CLI   3(R2),C'1'                                                       
         BL    AOIC11                                                           
         MVC   SPACING,3(R2)                                                    
         NI    SPACING,X'0F'                                                    
         GOTO1 APRNT                                                            
*                                                                               
         LA    R6,4                                                             
AOIC11   DS    0H                                                               
         IC    RF,1(R2)                                                         
         SR    RF,R6                                                            
         AR    R6,R2                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P1+8(0),0(R6)                                                    
*                                                                               
         GOTO1 APRNT                                                            
*                                                                               
AOIC12   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     AOIC10                                                           
*                                                                               
AOIC13   DS    0H                                                               
         B     AOICX         COMMENT NOT FOUND - DON'T DIE                      
*                            JUST EXIT                                          
*                                                                               
AOIC20   DS    0H                                                               
AOICX    XIT1                                                                   
*                                                                               
         DROP  RF                                                               
*                                                                               
*        ULINE IN FIRST BLANK LINE                                              
AULINE   NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P1                                                            
         SR    RE,RE                                                            
AUL2     DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    AUL4                                                             
         LA    R3,132(R3)                                                       
         LA    RE,1(RE)                                                         
         B     AUL2                                                             
*                                                                               
AUL4     DS    0H                                                               
         LTR   RE,RE                                                            
         BNP   AULX                                                             
*                                                                               
         LA    RF,P1+40                                                         
AUL5     DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
AUL6     DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    AUL8                FIRST NON-BLACK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,AUL6                                                          
*                                                                               
         BCT   RF,AUL5                                                          
*                                                                               
AUL8     DS    0H                                                               
         LA    R0,P1                                                            
         SR    RF,R0                                                            
         BM    AULX                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
AULX     DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
         DROP  R7                                                               
*                                                                               
AOIDISK  DC    F'0'              USED TO SAVE AOR DISK ADDR                     
*                                                                               
LASTAMPE DC    XL7'00'      LAST MED/FIN/PRD/EST                                
*                                                                               
LASTAORD DC    F'0'    AOR DISK ADDRESS FOR LAST MED/FIN/PRD/EST                
*                                                                               
*                                                                               
WRKGRS   DC    F'0'   WORKING VALUES - COULD BE CONTRACT OR COST2               
WRKNET   DC    F'0'                                         (OPEN)              
WRKAC    DC    F'0'                                                             
*                                                                               
*                                                                               
AORWRK   DS    XL500      FOR AOR RECORD                                        
*                                                                               
         TITLE 'BILCALC - CALCULATE AMOUNTS DUE'                                
BILCALC  CSECT                                                                  
         NMOD1 0,BILCALC                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   PASSNO,1                                                         
         BE    BC1                                                              
*                                                                               
*              ONLY REDO ADJUSTMENTS ON PASS 2                                  
*              IF DOING ADJSEP WITH DETAIL BACK-UP                              
*           OR IF DOING AORINV WITH DETAIL BACK-UP                              
*                                                                               
         CLI   PASSNO,2                                                         
         BNE   BCX                                                              
         OC    ARECAP,ARECAP                                                    
         BZ    BCX                                                              
         CLI   AORSW,C'Y'                                                       
         BE    BC1                                                              
         CLI   ADJSEP,C'Y'                                                      
         BNE   BCX                                                              
*                                                                               
BC1      DS    0H                                                               
*                                                                               
         MVI   PVATSW,0         CLEAR BILLABLE VAT SWITCH                       
*                                                                               
         XC    WKROW(256),WKROW                                                 
         XC    WKROW+256(256),WKROW+256                                         
         XC    WKROW+512(L'WKROW-512),WKROW+512                                 
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)      POINT TO ACCUM                                 
         LR    RF,R7                                                            
*                                                                               
         LR    RE,R7                                                            
         AH    RE,=Y(TOTSIZE-BFORML)     POINT TO FORMULA INFO                  
         OC    0(BFORML,RE),0(RE)      IF ROLLED UP FROM LOWER LEVEL            
         BNZ   BCX                     THEN DONE                                
*                                                                               
         LA    R6,MAXMOS                                                        
         LA    R5,PERLIST                                                       
         XC    DUB,DUB                                                          
BC2      DS    0H                                                               
         CLC   0(16,RF),ROWHL(RF)                                               
         BNE   BC2A                                                             
         CLC   ROWTL(16,RF),ROWTL+ROWHL(RF)                                     
         BE    BC2A4                                                            
***TAX   NOTE CHECKS ABOVE WILL NOT DETECT BILLABLE TAX                         
***TAX        SHOULD BE OK SINCE TAX PCT WILL NOT CHANGE FOR                    
***TAX        BILLED INSERTIONS                                                 
***TAX        ALSO THERE MAY DESCRIPANCIES DUE TO ROUNDING ERRORS               
BC2A     DS    0H                                                               
         MVC   DUB(2),0(R5)        SAVE DATE FOR BILL FORM EFF DATE             
*                                                                               
*                                                                               
BC2A4    DS    0H                                                               
*                                  NOTE-WHOLE BILL EITHER OK OR NOT             
         OC    OADJDSP(8,RF),OADJDSP(RF)                                        
         BNZ   BCX                                                              
         OC    ADJDSP(8,RF),ADJDSP(RF)     EXIT IF ADJ'S ALREADY THERE          
         BNZ   BCX                 (TOTAL'D UP FROM LOWER LEVEL)                
         OC    AORDSP(56,RF),AORDSP(RF)    EXIT IF ADJ'S ALREADY THERE          
         BNZ   BCX                 (TOTAL'D UP FROM LOWER LEVEL)                
         LA    RF,ROWL(RF)                                                      
         LA    R5,8(R5)            BUMP DATE                                    
         BCT   R6,BC2                                                           
*                                                                               
         OC    DUB,DUB             IF NO BILLABLES                              
         BNZ   BC2A6                                                            
BC2A5    SH    R5,=H'8'                                                         
         OC    0(2,R5),0(R5)                                                    
         BZ    BC2A5                                                            
         MVC   DUB(2),0(R5)        USE LAST DATE FOR EFF DATE CHECK             
*                                                                               
*                                                                               
*                                  SET BILLING FORMULA IN W                     
BC2A6    XC    W,W                                                              
         MVI   CRFORMSW,C'Y'       SPECIAL CORP RETAIL FORMULA                  
         CLI   RETPROF+15,C'Y'     TEST OPTION TO SKIP TO AAA                   
         BNE   BC2A6B                                                           
         CLI   UPASS,1                                                          
         BE    BC2B                                                             
         CLI   UPASS,C'S'                                                       
         BE    BC2B                                                             
*                                                                               
BC2A6B   DS    0H                                                               
         CLI   RETPROF+15,C'0'     TEST OUTLET CODE BASED ON AAA OPTION         
         BNH   BC2A6D              (LAST "N" DIGITS ARE 0)                      
         CLI   UPASS,C'S'           USE AAA FOR SUMMARY                         
         BE    BC2B                                                             
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         ZIC   R1,GDOUTLEN-GDSECT(R4)                                           
         L     R4,GDOUTAD-GDSECT(R4)      A(OUTLET)                             
         LA    R4,GDOCODE-GDOUTD(R4,R1)                                         
         ZIC   R1,RETPROF+15                                                    
         SH    R1,=H'240'                                                       
         SR    R4,R1                                                            
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R4),=C'000000'                                               
         BE    BC2B                                                             
*                                                                               
BC2A6D   MVI   CRFORMSW,C'N'       NO SPECIAL CORP RETIAL FORMULA               
*                                                                               
         CLI   BFROPT,C'N'         TEST USING BILL FORM RECORDS                 
         BE    BC2A6DX                                                          
         LA    R4,GETBFRW          (NULLS FIRST TIME)                           
         USING PPGBFRDD,R4                                                      
*                                                                               
         MVC   PPGBAGY,QAGENCY                                                  
         MVC   PPGBMED,QMEDIA                                                   
         OC    AMED,AMED                                                        
         BZ    BC2A6F                                                           
         L     RF,AMED           MUST CHECK AMED FOR MEDIA                      
         MVC   PPGBMED,0(RF)                                                    
*                                                                               
BC2A6F   DS    0H                                                               
         L     RF,ADCLT                                                         
         MVC   PPGBCLT,4(RF)                                                    
         L     RF,APRD                                                          
         MVC   PPGBPRD,0(RF)        3 CHAR PRD CODE                             
         L     RF,AEST                                                          
         MVC   PPGBEST,0(RF)                                                    
         MVC   PPGBMOS,DUB         MONTH OF SERVICE                             
         CLI   PERCTL,C'S'         IF MONTHS SEPARATE                           
         BE    *+10                ELSE USE REQUEST MONTH                       
         MVC   PPGBMOS,CURPER                                                   
         MVC   PPGBACOM,VCOMFACS                                                
*                                                                               
         MVC   PPGBLODR,LOADER                                                  
         GOTO1 =V(PPGETBFR),DMCB,PPGBFRDD                                       
*                                                                               
BC2AU    DS    0H                                                               
         MVC   W(5),PPGBFORM                                                    
         B     BC3A                                                             
         DROP  R4                                                               
*                                                                               
BC2A6DX  DS    0H                                                               
*                                                                               
         CLC   DUB(2),ESTFORM+5    EST EFFDATE                                  
         BL    BC2A8                                                            
         CLI   ESTFORM+BILNBSW-BILPROF,C'Y'  SEE IF NOT FOR BILLING             
         BE    BC2A8                                                            
         OC    W(5),ESTFORM                                                     
         BZ    BC2A8                                                            
         MVC   W+5(1),ESTFORM+BILCMSW-BILPROF                                   
***NEW 5/20/91                                                                  
         MVC   W+6(1),ESTFORM+BILPBASB-BILPROF   ONLY FOR PRINTING              
         MVC   W+7(3),ESTFORM+BILPADJ-BILPROF    ONLY FOR PRINTING              
***NEW 5/20/91                                                                  
         B     BC3                                                              
BC2A8    CLC   DUB(2),PRDFORM+5    PRD EFF DATE                                 
         BL    BC2B                                                             
         CLI   PRDFORM+BILNBSW-BILPROF,C'Y'  SEE IF NOT FOR BILLING             
         BE    BC2B                                                             
         OC    W(5),PRDFORM                                                     
         BZ    BC2B                                                             
         MVC   W+5(1),PRDFORM+BILCMSW-BILPROF                                   
***NEW 5/20/91                                                                  
         MVC   W+6(1),PRDFORM+BILPBASB-BILPROF   ONLY FOR PRINTING              
         MVC   W+7(3),PRDFORM+BILPADJ-BILPROF    ONLY FOR PRINTING              
***NEW 5/20/91                                                                  
         B     BC3                                                              
BC2B     DS    0H                                                               
         CLC   DUB(2),AAEFORM+5    AAA EST EFFDATE                              
         BL    BC2C                                                             
         CLI   AAEFORM+BILNBSW-BILPROF,C'Y'  SEE IF NOT FOR BILLING             
         BE    BC2C                                                             
         OC    W(5),AAEFORM    AAA EST FORMULA                                  
         BZ    BC2C                                                             
         MVC   W+5(1),AAEFORM+BILCMSW-BILPROF                                   
***NEW 5/20/91                                                                  
         MVC   W+6(1),AAEFORM+BILPBASB-BILPROF   ONLY FOR PRINTING              
         MVC   W+7(3),AAEFORM+BILPADJ-BILPROF    ONLY FOR PRINTING              
***NEW 5/20/91                                                                  
         B     BC3                                                              
BC2C     CLC   DUB(2),AAAFORM+5   AAA PRD FORMULA EFF DATE                      
         BL    BC3                                                              
         CLI   AAAFORM+BILNBSW-BILPROF,C'Y'  SEE IF NOT FOR BILLING             
         BE    BC3                                                              
         OC    W(5),AAAFORM    AAA PRD FORMULA                                  
         MVC   W+5(1),AAAFORM+BILCMSW-BILPROF                                   
***NEW 5/20/91                                                                  
         MVC   W+6(1),AAAFORM+BILPBASB-BILPROF   ONLY FOR PRINTING              
         MVC   W+7(3),AAAFORM+BILPADJ-BILPROF    ONLY FOR PRINTING              
***NEW 5/20/91                                                                  
BC3      DS    0H                                                               
BC3A     DS    0H      FROM SFM BF LOGIC - MAY SET NEW FORMULA                  
         LR    RF,R7                                                            
         AH    RF,=Y(TOTSIZE-BFORML)                                            
******** LA    RF,TOTSIZE-BFORML(R7)                                            
*                                                                               
         CLI   SCBNCSW,C'N'        NET BILLING IN SCB CASE                      
         BNE   BC3B                                                             
         MVC   FULL2(1),W          SAVE "REAL" FORMULA                          
         CLI   FULL2,0             SEE IF I HAVE ONE                            
         BNE   *+8                                                              
         MVI   FULL2,X'05'         DEFAULT TO G-CD                              
*                                                                               
         MVC   W(5),=X'0202000000'      SET TO NET + ZERO PCT OF NET            
*                                                                               
         TM    FULL2,X'04'      SEE IF "REAL" FORMULA SUBTRACTED CD             
         BZ    BC3B                                                             
         CLI   PROFB2B+4,C'Y'       SEE IF CD ON NET BILL                       
         BNE   *+10                                                             
         MVC   W(2),=X'0606'       CHANGE TO NET-CD                             
*                                                                               
BC3B     DS    0H                                                               
******                       SKIP CODE THAT SET FORMULA TO GROSS                
         OC    W(5),W        SEE IF I HAVE A FORMULA                            
         BNZ   BC3D          USE IT EVEN FOR FINANCIAL REBATE                   
*                                                                               
*                            IF NO FORMULA STILL SET TO GROSS                   
*                            FOR FINANCIAL REBATE BILLING                       
***R***                                                                         
         CLC   QPROG,=C'R1'        FOR FINANCIAL REBATE BILL                    
         BNE   *+16                                                             
         MVC   W(5),=X'0101000000'    SET FORMULA TO GROSS                      
         XC    W+6(4),W+6          CLEAR PRINTING OVERRIDES                     
         CLC   QPROG,=C'RD'        FOR FINANCIAL REBATE BILL DRAFT              
         BNE   *+16                                                             
         MVC   W(5),=X'0101000000'    SET FORMULA TO GROSS                      
         XC    W+6(4),W+6          CLEAR PRINTING OVERRIDES                     
***R***                                                                         
BC3D     MVC   0(6,RF),W           SET FORMULA IN ACCUM                         
***NEW 5/20/91                                                                  
         LA    RE,BFPBASB-BFORMD(RF)                                            
         MVC   0(1,RE),W+6                                                      
         LA    RE,BFPCOMP-BFORMD(RF)                                            
         MVC   0(3,RE),W+7                                                      
***NEW 5/20/91                                                                  
*                                                                               
         LA    RE,BFAORPCT-BFORMD(RF)                                           
         MVC   0(3,RE),SVAORPCT+1    SAVE AOR PCT                               
**GST                                                                           
***                                                                             
***      NOTE THAT CVATSW BY ITSELF (NOT THE PROVINCE SWITCHES)                 
***      ACTUALLY CONTROLS MOST THINGS                                          
***                                                                             
         XC    CVATSWS,CVATSWS   SET VATABLE OFF                                
*                                                                               
         MVI   PVATSW,0          GETS SET TO Y IF ANY PST BILLABLE              
*                                                                               
         CLI   CVATCOD,0         NOT VATABLE IF NO VAT CODE                     
         BE    BC3L                                                             
         CLC   DUB(2),CVATSTRT   CHK THIS MONTH VS. VAT START                   
         BL    BC3F              NOTE - EITHER ALL MTHS VATABLE                 
*                                OR ALL NOT VATABLE                             
         MVI   CVATSW,C'Y'                                                      
*                                                                               
BC3F     DS    0H                SET ON VAT SWS FOR PROV                        
*                                NOTE - NO EFFECTIVE DATE CHECK                 
         LA    RE,CVATCDS+1                                                     
         LA    R1,CVATSWS+1                                                     
         LA    R0,NPROVS                                                        
*                                                                               
BC3G     DS    0H                                                               
         CLI   0(RE),C' '                                                       
         BNH   *+12                                                             
         MVI   0(R1),C'Y'           SET PROV SWITCH ON                          
         MVI   PVATSW,C'Y'          CHECKED AT BC4 FOR BILLABLE VATS            
         LA    RE,1(RE)                                                         
         LA    R1,1(R1)                                                         
         BCT   R0,BC3G                                                          
*                                                                               
BC3L     DS    0H                                                               
         MVC   BFVATCDS-BFORMD(,RF),CVATCDS    VAT DATA INTO BFORMD             
         MVC   BFVATSWS-BFORMD(,RF),CVATSWS                                     
*                                                                               
******   LA    RE,BFVATCOD-BFORMD(RF)                                           
******   MVC   0(1,RE),CVATCOD                                                  
******   LA    RE,BFVATSW-BFORMD(RF)                                            
******   MVC   0(1,RE),CVATSW                                                   
*                                                                               
         OC    W(5),W              CHK FOR FORMULA                              
         BNZ   *+10                                                             
         MVC   W(5),=X'0505000000'    SET DEFAULT FORMULA                       
         MVC   W+20(5),W           SAVE FORMULA FOR PEPTAB                      
*                                  G-CD - 0 PCT G-CD                            
*                                                                               
*              W+5  'C'  MEANS COMMISSION ONLY                                  
*                                                                               
         LA    R6,MAXMOS                                                        
         LA    R5,PERLIST                                                       
BC4      DS    0H                                                               
         XC    BCGRS(16),BCGRS      CLEAR DERIVED GR AND NET,CD,AC              
*                                                                               
         CLI   PVATSW,C'Y'             CHECK FOR BILLABLE VATS                  
         BE    BC4B                    MUST GO TO BC4B                          
*                                      EVEN IF THERE ARE NO BILLABLES           
*                                                                               
         CLC   0(16,R7),ROWHL(R7)      TEST ANY BALANCE                         
         BNE   BC4B                                                             
         CLC   ROWTL(16,R7),ROWTL+ROWHL(R7)       OPEN BALANCE                  
         BE    BC6D                                                             
***TAX   NOTE CHECKS ABOVE WILL NOT DETECT BILLABLE TAX                         
***TAX        SHOULD BE OK SINCE TAX PCT WILL NOT CHANGE FOR                    
***TAX        BILLED INSERTIONS                                                 
***TAX        ALSO THERE MAY DESCRIPANCIES DUE TO ROUNDING ERRORS               
BC4B     DS    0H                                                               
*                                                                               
         CLI   W+5,0                                                            
         BNE   BC5                                                              
         MVI   W+5,X'FF'                                                        
*                                                                               
*                                  ON FIRST TIME THUR                           
*                                  ADD BILL BUCKET RECS                         
*                                  FOR DUMMY MKT/PUB IF NOT                     
*                                  DOING DETAIL MARKING                         
         CLC   ORIGTYPE,TYPE                                                    
         BNE   BC5                                                              
         GOTO1 AWNBILL                                                          
*                                                                               
*                                                                               
BC5      DS    0H                                                               
         GOTO1 =V(VBADJ),DMCB,W,(R5),BRKTABD   GET VAT BASIS ADJ                
*                                              AMTS IN VBTAB                    
*                                                                               
*                                  SET BCGRS,BCNET,BCCD, BCAC                   
         MVC   BCGRS(16),4(R7)      GROSS + NET + CD + AC                       
         L     RF,0(R7)                                                         
         CLI   UPASS,C'S'          FOR SUMMARY PASS                             
         BE    BC6                                                              
*                                                                               
         MVI   BCPASS,0                                                         
BC5A     LA    R2,0(R7)                                                         
         CLI   BCPASS,1                                                         
         BNE   *+8                                                              
         LA    R2,ROWTL(R7)        NOW DO OPEN ACCUMMS                          
         LA    RE,BCGRS                                                         
         LA    R0,4                FOR BCT                                      
BC5A1    DS    0H                                                               
*                                                                               
         L     RF,0(R2)                                                         
         S     RF,ROWHL(R2)        SUBTRACT PREV BILLED                         
         ST    RF,0(RE)            BASIS                                        
*                                                                               
         LA    R2,4(R2)            NET                                          
         LA    RE,4(RE)                                                         
         BCT   R0,BC5A1                                                         
*                                                                               
*                                  GET BASIS                                    
BC5A2    DS    0H                                                               
         CLI   CDSEP,C'Y'          SEE IF DOING SEPARATE CD INV                 
         BNE   BC5A2C              NO                                           
         NI    W,X'FB'             SET OFF CD IN BASE                           
         B     BC5A3                                                            
*                                                                               
BC5A2C   CLI   SCBNCSW,C'C'        SEE IF UFC COMM BILL                         
         BNE   BC5A3                                                            
         CLI   PROFB2B+4,C'Y'      SEE IF CD IS ON NET BILLING                  
         BNE   BC5A3                                                            
         NI    W,X'FB'             SET OFF CD IN BASE                           
*                                  NET BILLING SHOULD BE NET-CD                 
*                                  WHEN PRINTING BILL                           
BC5A3    MVC   WK(4),BCGRS         GROSS                                        
         OC    W(5),W              CHK FOR FORMULA                              
         BZ    BC5A4               NONE - USE GROSS                             
         TM    W,X'01'                                                          
         BO    BC5A3C                                                           
         MVC   WK(4),BCNET         NET                                          
         TM    W,X'02'                                                          
         BO    BC5A3C                                                           
         MVC   WK(4),BCAC          AC      X'08'                                
*                                                                               
BC5A3C   TM    W,X'04'             SEE IF SUBTRACTING CD                        
         BZ    BC5A4                                                            
         L     R0,WK                                                            
         S     R0,BCCD                                                          
         ST    R0,WK                                                            
BC5A4    L     RF,WK                                                            
*                                  CALCULATE ADJUSTMENT                         
         OC    W+2(3),W+2                                                       
         BZ    BC6                 NO ADJ                                       
         L     RF,BCGRS            GRS                                          
         TM    W+1,X'01'                                                        
         BO    BC5A4B                                                           
         L     RF,BCNET            NET                                          
         TM    W+1,X'02'                                                        
         BO    BC5A4B                                                           
         L     RF,BCAC             AC      X'08'                                
*                                                                               
BC5A4B   TM    W+1,X'04'           SEE IF SUBTRACTING CD                        
         BZ    BC5A6                                                            
         S     RF,BCCD                                                          
*                                                                               
BC5A6    CLI   TAXOPT,C'N'         TEST SHOWING TAX                             
         BE    BC5B                                                             
         TM    W+1,X'08'           SEE IF AC                                    
         BO    BC5B                ALSO DON'T SUBTRACT TAX                      
*                                                                               
         S     RF,TDSP(R7)         LESS TAX                                     
         A     RF,ROWHL+TDSP(R7)   PLUS BILLED TAX                              
BC5B     DS    0H                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+1(3),W+2                                                    
         TM    W+2,X'F0'                                                        
         BNO   *+8                                                              
         MVI   FULL,X'FF'                                                       
         M     RE,FULL             X ADJ PCT                                    
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BNP   *+8                                                              
         A     RF,=F'1'                                                         
         SRA   RF,1                                                             
*****                                                                           
*****    L     R0,=F'500000'       ROUNDING                                     
*****    LTR   RE,RE                                                            
*****    BNM   *+6                                                              
*****    LCR   R0,R0                                                            
*****    AR    RF,R0                                                            
*****    D     RE,=F'1000000'                                                   
*****                                                                           
         CLI   BCPASS,1                                                         
         BE    BC6B                                                             
         ST    RF,ADJDSP(R7)           ADJ                                      
         L     RE,WKROW+ADJDSP-EXTDSP                                           
         AR    RE,RF                                                            
         ST    RE,WKROW+ADJDSP-EXTDSP   TOTAL ADJUSTMENT                        
*                                                                               
         L     RF,TDSP(R7)                 ORDERED TAX                          
         S     RF,BTDSP(R7)                LESS PREV BILLED TAX                 
         ST    RF,TAXDSP(R7)                                                    
         A     RF,WKROW+TAXDSP-EXTDSP                                           
         ST    RF,WKROW+TAXDSP-EXTDSP      SAVE TOTAL TAX                       
*                                                                               
         L     RF,ADJDSP(R7)               RESET RF TO ADJDSP                   
         A     RF,WK               ADD BASIS                                    
*                                                                               
BC6      DS    0H                                                               
*                             COULD GET HERE VIA BC5A4 IF NO ADJ                
         CLI   BCPASS,1                                                         
         BE    BC6B5                                                            
*                                                                               
         ST    RF,DUEDSP(R7)           AMOUNT DUE                               
         A     RF,WKROW+DUEDSP-EXTDSP                                           
         ST    RF,WKROW+DUEDSP-EXTDSP     KEEP TOTAL DUE                        
*                                                                               
******   A     RF,WK+8                                                          
******   ST    RF,WK+8             KEEP DUE TOTAL                               
*                                                                               
*                                                                               
**GST                                                                           
         CLI   CVATSW,0            CHECK FOR CANADIAN VAT                       
         BE    BC6AX                                                            
*                                                                               
         GOTO1 =V(VBCALC),DMCB,(R5),(R7),BRKTABD     VAT CALC                   
         CLI   ADJSEP,C'Y'         SEP ADJ BILL                                 
         BNE   BC6C                                                             
*                                                                               
         GOTO1 =V(VBCALCJ),DMCB,(R5),(R7),BRKTABD    VAT FOR SEP ADJ            
         B     BC6C                                                             
*                                                                               
BC6C     DS    0H                                                               
         CLI   CDSEP,C'Y'         SEPARATE CD BILL?                             
         BNE   BC6CX                                                            
*                                                                               
         GOTO1 =V(VBCALCD),DMCB,(R5),(R7),BRKTABD    VAT FOR SEP CD             
*                                                                               
BC6CX    DS    0H                                                               
*                                                                               
BC6AX    DS    0H                                                               
         CLI   RETPROF,0           SEE IF DOING RETAIL                          
         BNE   BC6D                CAN'T DO FINANCIAL RETAIL                    
*                                                                               
         CLI   AORSW,C'Y'          SEE IF DOING AOR  - NO AOR FINANCIAL         
         BE    BC8                 NO AOR FOR RETAIL                            
*                                                                               
         MVI   BCPASS,1            DO OPEN DOLLARS                              
         B     BC5A                                                             
*                                                                               
BC6B     ST    RF,OADJDSP(R7)           ADJ                                     
*                                                                               
         L     RE,WKROW+OADJDSP-EXTDSP                                          
         AR    RE,RF                                                            
         ST    RE,WKROW+OADJDSP-EXTDSP    SAVE TOTAL OPEN ADJ                   
******   L     RE,WK+44                                                         
******   AR    RE,RF                                                            
******   ST    RE,WK+44            TOTAL ADJ                                    
         A     RF,WK               ADD BASIS                                    
BC6B5    DS    0H                                                               
*                                  COULD GET HERE VIA BC6                       
         ST    RF,ODUEDSP(R7)           AMOUNT DUE                              
         A     RF,WKROW+ODUEDSP-EXTDSP                                          
         ST    RF,WKROW+ODUEDSP-EXTDSP      SAVE TOTAL OPEN DUE                 
******   A     RF,WK+48                                                         
******   ST    RF,WK+48            KEEP DUE TOTAL                               
*                                                                               
BC6D     DS    0H                                                               
         CLI   RETPROF,0           TEST RETAIL                                  
         BE    BC8                 NO                                           
*                                                                               
         LR    RF,R6                                                            
         SH    RF,=Y(MAXMOS)                                                    
         LPR   RF,RF               RF = REL. NO. OF PERIOD                      
*                                                                               
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         STC   RF,GDPER            RELATIVE PERIOD                              
*                                                                               
         XC    GDSHRA(20),GDSHRA                                                
*                                                                               
         MVC   GDTOTA,DUEDSP(R7)   DUE AMT                                      
         MVC   GDTOTG,BCGRS                                                     
         MVC   GDTOTN,BCNET                                                     
         MVC   GDTOTCD,BCCD                                                     
         MVC   GDTOTAC,BCAC        AGY COMM                                     
         L     RF,ADEST                                                         
         USING PESTREC,RF                                                       
         MVC   GDSCHM,PESTRSCH     RETAIL SCHEME                                
         DROP  RF                                                               
         L     RF,APRD                                                          
         MVC   GDPRD,0(RF)                                                      
         L     RF,AEST                                                          
         MVC   GDEST,0(RF)                                                      
         MVC   GDOUTNO,UPASS       OUTLET NO.                                   
         CLI   UPASS,C'S'          IF SUMMARY PASS                              
         BNE   *+8                                                              
         MVI   GDOUTNO,1           USE CORP OUTLET                              
*                                                                               
         MVI   GDNOCUME,C'N'                                                    
         CLI   CRFORMSW,C'Y'                                                    
         BE    BC6P                                                             
         CLI   RETPROF+15,C'0'                                                  
         BH    BC6P                                                             
         MVI   GDNOCUME,C'Y'                                                    
*                                                                               
BC6P     DS    0H                                                               
         GOTO1 AFINDOUT,DMCB,GDSECT                                             
*                                                                               
*        NOTE - THIS CODE IS ABN INDIRECT WAY TO DEAL WITH                      
*               A PROBLEM THAT ARISES IF ALL THE TOTALLED AMTS ARE O            
*                                                                               
         OC    GDSHRP,GDSHRP    SEE IF SHARE IS 0 PCT.                          
         BNZ   *+10                                                             
         XC    GDSHRA(20),GDSHRA    CLEAR AMOUNTS                               
*                                                                               
         OC    GDSCHMAD,GDSCHMAD                                                
         BNZ   BC7                                                              
         CLI   UPASS,C'S'                                                       
         BE    *+6                                                              
         DC    H'0'             NO SCHEME - SHOULD NOT HAPPEN HERE              
         XC    GDSHRA(20),GDSHRA       CLEAR SHARE                              
         XC    GDSHRP,GDSHRP                                                    
BC7      DS    0H                                                               
         CLI   UPASS,C'S'          FOR SUMMARY PASS                             
         BNE   BC7D                                                             
         MVC   RETADSP(4,R7),DUEDSP(R7) RET DUE = DUE                           
         MVC   RETGDSP(4,R7),BCGRS                                              
         MVC   RETNDSP(4,R7),BCNET                                              
         MVC   RETCDSP(4,R7),BCCD  CD                                           
         MVC   RETACDSP(4,R7),BCAC     AGY COMM                                 
         B     *+10                                                             
BC7D     DS    0H                                                               
         MVC   RETADSP(20,R7),GDSHRA SET SHARE DUE (ACT,GRS,NET,CD,AC)          
         MVC   RETPDSP(4,R7),GDSHRP   SHARE PCT                                 
         L     RF,RETADSP(R7)                                                   
*                                                                               
         A     RF,WKROW+RETADSP-EXTDSP                                          
         ST    RF,WKROW+RETADSP-EXTDSP    TOTAL OF ACT SHARES                   
******   A     RF,WK+20                                                         
******   ST    RF,WK+20            TOTAL OF ACT SHARES                          
         L     RF,RETGDSP(R7)                                                   
         A     RF,WKROW+RETGDSP-EXTDSP                                          
         ST    RF,WKROW+RETGDSP-EXTDSP    TOTAL OF GROSS SHARES                 
******   A     RF,WK+24                                                         
******   ST    RF,WK+24            TOTAL OF GRS SHARES                          
         L     RF,RETNDSP(R7)                                                   
         A     RF,WKROW+RETNDSP-EXTDSP                                          
         ST    RF,WKROW+RETNDSP-EXTDSP    TOTAL OF NET SHARES                   
******   A     RF,WK+28                                                         
******   ST    RF,WK+28            TOTAL OF NET SHARES                          
         L     RF,RETCDSP(R7)                                                   
         A     RF,WKROW+RETCDSP-EXTDSP                                          
         ST    RF,WKROW+RETCDSP-EXTDSP    TOTAL OF CD SHARES                    
******   A     RF,WK+32                                                         
******   ST    RF,WK+32            TOTAL OF CD SHARES                           
         L     RF,RETACDSP(R7)                                                  
         A     RF,WKROW+RETACDSP-EXTDSP                                         
         ST    RF,WKROW+RETACDSP-EXTDSP    TOTAL OF AC SHARES                   
******   A     RF,WK+36                                                         
******   ST    RF,WK+36            TOTAL OF AC SHARES                           
         MVC   WKROW+RETPDSP-EXTDSP(4),GDSHRP     SAVE SHARE %                  
******   MVC   WK+40(4),GDSHRP     SAVE SHARE PCT                               
*                                                                               
**GST                                                                           
         L     RF,TDSP(R7)        YES, FIRST DO TAX CALC                        
         S     RF,ROWHL+TDSP(R7)                                                
******                                                                          
         CLI   UPASS,C'S'          RETAIL SUMMARY PASS                          
         BE    BC7E                TAX IS ALREADY SET TO THE SHARE              
***                                                                             
         L     R0,GDSHRP           TO GET TAX SHARE FOR THIS BILL               
         MR    RE,R0               NOTE- TAX CALCS DO NOT HAVE TO               
         SLDA  RE,1                ADD UP TO THE PENNY ACROSS DISTS             
         D     RE,=F'10000'        BECAUSE ARE ONLY USED FOR                    
         LTR   RF,RF               VAT CALC                                     
         BNP   *+8                                                              
         A     RF,=F'1'                                                         
         SRA   RF,1                                                             
*                                                                               
BC7E     ST    RF,RETTDSP(R7)       SAVE RETAIL SHARE OF TAX                    
         A     RF,WKROW+RETTDSP-EXTDSP                                          
         ST    RF,WKROW+RETTDSP-EXTDSP   TOTAL OF TAX SHARES                    
*******  A     RF,WK+72                                                         
*******  ST    RF,WK+72             TOTAL OF TAX SHARES                         
*                                                                               
         CLI   CVATSW,0            TEST VAT                                     
         BE    BC7G                                                             
*                                                                               
*        GST AND PST NOW CALCULATED IN VBCALCR                                  
*                                                                               
         GOTO1 =V(VBCALCR),DMCB,(R5),(R7),BRKTABD,GDSHRP                        
*                                                                               
*                                                                               
         DROP  R4                                                               
BC7G     DS    0H                                                               
         B     BC9                                                              
*                                                                               
BC8      DS    0H                  SET AOR AMOUNT                               
*                                  FOR FINANCIAL AOR                            
*                                  BASE AOR ON CONTRACT                         
         TM    FINANSW,X'80'       SEE IF COST 2                                
         BNO   BC8A                                                             
         CLI   PROFAOR+5,C'Y'     AOR ON COST2 (OPEN)                           
         BNE   BC8A                                                             
         CLI   BCPASS,1                                                         
         BE    BC8AX              BASE AOR ON OPEN (COST2) AMTS                 
         B     BC8X                                                             
*                                                                               
BC8A     DS    0H                                                               
**NEW 2/8/89                                                                    
         CLI   BCPASS,1                                                         
         BE    BC9                                                              
**NEW 2/8/89                                                                    
BC8AX    DS    0H                                                               
         ICM   R0,15,SVAORPCT      TEST ANY AOR PCT                             
         BZ    BC8X                                                             
**NEW 2/8/89        WAS  B   BC9                                                
         L     RF,BCGRS                                                         
         CLI   SVAORBAS,0          GROSS                                        
         BE    BC8B                **NEW 3/12/91 WAS BC8C                       
         L     RF,BCAC                                                          
         TM    SVAORBAS,X'80'      AGY COMM.                                    
         BO    BC8C                                                             
         L     RF,BCNET            NET                                          
         TM    SVAORBAS,X'40'                                                   
         BO    BC8B                **NEW 3/12/91 WAS BC8C                       
         DC    H'0'                INVALID AOR BASIS                            
*                                                                               
**NEW 3/12/91                                                                   
BC8B     CLI   AORTXOPT,C'Y'                                                    
         BE    BC8C                                                             
         TM    SVAORBAS,X'80'      AGY COMM BASIS                               
         BO    BC8C                SKIP TAX                                     
*                                                                               
         S     RF,TDSP(R7)         SUBTRACT ORDERED TAX                         
         A     RF,ROWHL+TDSP(R7)     RE-ADD PREVIOUSLY BILLED TAX               
**NEW 3/12/91                                                                   
*                                                                               
BC8C     LTR   RF,RF                                                            
         BZ    BC8X                NO DUE AMOUNT                                
**NEW 2/8/89        WAS  B   BC9                                                
         CLC   0(2,R5),SVAOREFF    TEST VS AOR EFF DATE                         
         BL    BC8G                                                             
***NEW 5/17/91                                                                  
         CLC   0(2,R5),SVAORKIL    TEST VS. KILL DATE                           
         BNL   BC8G                                                             
***NEW 5/17/91                                                                  
*                                                                               
**2/22/89                                                                       
         ST    RF,AORBDSP(R7)     SAVE AMOUNT SUBJECT TO AOR FEE                
*                                                                               
         A     RF,WKROW+AORBDSP-EXTDSP                                          
         ST    RF,WKROW+AORBDSP-EXTDSP    SAVE TOTAL AOR BASIS                  
*******  A     RF,WK+16            ADD TO TOTAL                                 
*******  ST    RF,WK+16            SAVE NEW RESULT                              
         L     RF,AORBDSP(R7)      RESTORE RF                                   
**2/22/89                                                                       
*                                  WILL BE SET INTO TOTAL ROW                   
         MR    RE,R0                                                            
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BNP   *+8                                                              
         A     RF,=F'1'                                                         
         SRA   RF,1                                                             
         LCR   RF,RF               COMPLEMENT                                   
         ST    RF,AORDSP(R7)       AOR AMOUNT                                   
*                                                                               
         A     RF,WKROW+AORDSP-EXTDSP                                           
         ST    RF,WKROW+AORDSP-EXTDSP   SAVE TOTAL AOR                          
******   A     RF,WK+12            ADD TO TOTAL                                 
******   ST    RF,WK+12            SAVE NEW RESULT                              
*                                  WILL BE SET INTO TOTAL ROW                   
**GST                                                                           
***NEW 5/17/91       WAS CLI  CVATSW,C'Y'                                       
         CLC   SVAORVCS,SPACES     SEE IF VAT FOR AOR AGENCY                    
         BNH   BC8F                                                             
         CLI   CVATCOD,0           PROVIDED VAT IS NOT                          
         BE    BC8F                IS NOT COMPLETELY EXCLUDED                   
         CLC   0(2,R5),CVATSTRT    OR BEFORE VAT START-UP                       
         BL    BC8F                                                             
*                                                                               
*        AOR GST AND PST NOW CALCULATED IN VBCALCA                              
*                                                                               
         GOTO1 =V(VBCALCA),DMCB,(R5),(R7),BRKTABD                               
         BAS   RE,BCPTCH1            *** TEST PATCH ***                         
*                                                                               
*                                                                               
BC8F     DS    0H                                                               
*                                                                               
         L     RF,BRKCODE          LOOK FOR AOR PCT IN ACCUM                    
         L     RF,ATOTS(RF)                                                     
         AH    RF,=Y(TOTSIZE-BFORML+BFAORPCT-BFORMD)                            
         CLC   0(3,RF),SVAORPCT+1  IF NOT THERE, DID MONTHS                     
         BE    *+10                BEFORE EFFECTIVE DATE                        
         MVC   0(3,RF),FFS         SET 'MIXED' AOR PCTS                         
         B     BC8X                                                             
**NEW 2/8/89        WAS  B   BC9                                                
*                                                                               
BC8G     DS    0H                  IF ACTIVE MONTH BEFORE                       
         L     RF,BRKCODE          EFFECTIVE DATE CLEAR OUT AORPCT              
         L     RF,ATOTS(RF)        FROM ACCUM                                   
         AH    RF,=Y(TOTSIZE-BFORML+BFAORPCT-BFORMD)                            
         XC    0(3,RF),0(RF)                                                    
*                                                                               
**NEW 2/8/89                                                                    
BC8X     DS    0H                                                               
         CLI   BCPASS,1            SEE IF I JUST DID OPEN PASS                  
         BE    BC9                 THEN DONE                                    
*                                                                               
         MVI   BCPASS,1                                                         
         B     BC5A                GO DO OPEN AMOUNTS                           
**NEW 2/8/89                                                                    
*                                                                               
BC9      DS    0H                                                               
         CLI   PASSNO,2            IF DOING PASS 2                              
         BNE   BC10                                                             
         OC    ARECAP,ARECAP       AND DETAIL BACK-UP                           
         BZ    BC10                                                             
*           OR IF DOING AORINV WITH DETAIL BACK-UP                              
         CLI   AORSW,C'Y'                                                       
         BE    BC20                SKIP BC ADD                                  
         CLI   ADJSEP,C'Y'         AND ADJ INVOICE                              
         BNE   BC10                                                             
         B     BC20                THEN SKIP BCADD                              
*                                                                               
BC10     BAS   RE,BCADD                                                         
*                                                                               
BC20     DS    0H                                                               
         LA    R7,ROWL(R7)                                                      
         LA    R5,8(R5)            BUMP DATE                                    
         BCT   R6,BC4                                                           
*                                                                               
*                                                                               
         MVC   OADJDSP+000(250,R7),WKROW+000                                    
         MVC   OADJDSP+250(ACMEXTL-250,R7),WKROW+250                            
*                                                                               
******   MVC   OADJDSP(8,R7),WK+44      OPEN ADJ AND DUE                        
******10/27/89 WAS (36) NOW (40) TO INCLUDE RETAIL PCT                          
*****    MVC   ADJDSP(8,R7),WK+4       TOTAL OF ADJ AND DUE AMOUNTS             
******   MVC   AORDSP(28,R7),WK+12                                              
******   AOR,AOR BASIS,RET ACT,RET GRS,RET NET,RET CD,RET AC                    
******   MVC   RETPDSP(4,R7),WK+40                                              
******                                  AND SHARE PCT                           
******                                  NOTE - TOTAL IS SUM OF PARTS            
******                                        (NOT RECALCULATED)                
******                                                                          
******   MVC   VATDSP(16,R7),WK+52     MAIN,COMM,AOR,CD  VATS                   
******   MVC   RETVDSP(4,R7),WK+68     RETAIL VAT                               
******   MVC   RETTDSP(4,R7),WK+72     RETAIL TAX                               
*                                                                               
         LA    R7,ROWL(R7)                                                      
         MVC   BFRETSHR-BFORMD(3,R7),WKROW+RETPDSP+1-EXTDSP                     
*                                              SAVE SHARE PCT.                  
*                                                                               
******   MVC   BFRETSHR-BFORMD(3,R7),WK+41     SET SHARE PCT                    
*                                                                               
*                                                                               
BCX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
*                                  ADD INTO PRD-EST-PER TAB                     
BCADD    NTR1                                                                   
         SPACE 2                                                                
         XC    PEPTW(250),PEPTW                                                 
         XC    PEPTW+250(250),PEPTW+250                                         
         XC    PEPTW+500(PEPTABRL-500),PEPTW+500                                
*                                                                               
         LA    RF,PEPTW                                                         
         USING PEPTD,RF                                                         
         OC    AMED,AMED                                                        
         BZ    BCA2                                                             
         L     RE,AMED                                                          
         MVC   PEPTMED,0(RE)                                                    
BCA2     L     RE,APRD                                                          
         MVC   PEPTPRD,0(RE)         PRD                                        
         L     RE,AEST                                                          
         MVC   PEPTEST,0(RE)       EST                                          
*                                                                               
         MVI   PEPTFIN,0                                                        
         CLI   FINANSW,0           SEE IF FINANCIAL CLT                         
         BE    *+10                                                             
         MVC   PEPTFIN,FINANSW                                                  
*                                                                               
         MVC   PEPTMOS,0(R5)       PERIOD                                       
         GOTO1 BINSRCH,PEPPARS,PEPTW                                            
         CLI   0(R1),1                                                          
         BE    BCX                 NOT IN PEPTAB                                
*                                                                               
         L     RF,0(R1)                                                         
         L     R0,PEPTADJ                                                       
         A     R0,ADJDSP(R7)           ADJ                                      
         ST    R0,PEPTADJ                                                       
         L     R0,PEPTDUE                                                       
         A     R0,DUEDSP(R7)           DUE                                      
         ST    R0,PEPTDUE                                                       
*                                      OPEN ADJ AND DUE                         
         L     R0,PEPTOADJ                                                      
         A     R0,OADJDSP(R7)                                                   
         ST    R0,PEPTOADJ                                                      
         L     R0,PEPTODUE                                                      
         A     R0,ODUEDSP(R7)                                                   
         ST    R0,PEPTODUE                                                      
         L     R0,PEPTRETA                                                      
         A     R0,RETADSP(R7)      RETAIL ACT                                   
         ST    R0,PEPTRETA                                                      
         L     R0,PEPTRETG                                                      
         A     R0,RETGDSP(R7)      RETAIL GROSS                                 
         ST    R0,PEPTRETG                                                      
         L     R0,PEPTRETN                                                      
         A     R0,RETNDSP(R7)      RETAIL NET                                   
         ST    R0,PEPTRETN                                                      
*                                                                               
         L     R0,PEPTRETC                                                      
         A     R0,RETCDSP(R7)      RETAIL CD                                    
         ST    R0,PEPTRETC                                                      
*                                                                               
         L     R0,PEPTRETM                                                      
         A     R0,RETACDSP(R7)     RETAIL AC                                    
         ST    R0,PEPTRETM                                                      
*                                                                               
         L     R0,PEPTRETT                                                      
         A     R0,RETTDSP(R7)     TAX                                           
         ST    R0,PEPTRETT                                                      
*                                                                               
**GST                                                                           
         CLI   CVATSW,0                 TEST BILL VATABLE                       
         BE    BCA2C                                                            
*                                                                               
*                                                                               
         LA    R6,PEPTVCDS         SET VAT CODES ONE AT A TIME                  
         LA    RE,CVATCDS                                                       
         LA    R0,NPROVS+1                                                      
*                                                                               
BCA05    DS    0H                                                               
         CLI   0(R6),C' '          ANYTHING ALREADY THERE?                      
         BNH   BCA05D              NO                                           
         CLI   0(RE),C' '          YES, ANYTHING NOW                            
         BNH   BCA05F              NO,OK                                        
         CLC   0(1,R6),0(RE)       IF EQUAL OK                                  
         BE    BCA05F                                                           
         MVI   0(R6),X'FF'         YES, SET MIXED (COULD THIS HAPPEN            
         B     BCA05F              AT THE PROV LEVEL IF DIFFERENT               
*                                  STATIONS HAVE DIFFERENT CODES?)              
BCA05D   DS    0H                  NOTHING ALREADY THERE                        
         MVC   0(1,R6),0(RE)       JUST SET CURRENT                             
*                                                                               
BCA05F   DS    0H                                                               
         LA    R6,1(R6)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,BCA05                                                         
*                                                                               
         OC    PEPTVSWS,CVATSWS    AND SWITCHES (NOTE THE 'OC')                 
*                                                                               
         LA    R4,NPROVS*4         USED AS INDEX REGISTER                       
*                                                                               
BCA06    DS    0H                                                               
         L     R0,PEPTVTS+0(R4)     VAT - MAIN BILL                             
         A     R0,VATDSP+0(R7,R4)                                               
         ST    R0,PEPTVTS+0(R4)                                                 
*                                                                               
         L     R0,PEPTVTB+0(R4)      VAT BASIS - MAIN BILL                      
         A     R0,VATBDSP+0(R7,R4)                                              
         ST    R0,PEPTVTB+0(R4)                                                 
*                                                                               
         L     R0,PEPTVTCS+0(R4)      VAT FOR SEP COMM ADJ                      
         A     R0,VATCDSP+0(R7,R4)                                              
         ST    R0,PEPTVTCS+0(R4)                                                
*                                                                               
         L     R0,PEPTCVTB+0(R4)      VAT BASIS FOR SEP COMM ADJ                
         A     R0,VATCBDSP+0(R7,R4)                                             
         ST    R0,PEPTCVTB+0(R4)                                                
*                                                                               
         L     R0,PEPTVTDS+0(R4)      VAT FOR SEP CD BILL                       
         A     R0,VATDDSP+0(R7,R4)                                              
         ST    R0,PEPTVTDS+0(R4)                                                
*                                                                               
         L     R0,PEPTDVTB+0(R4)      VAT BASIS FOR SEP CD BILL                 
         A     R0,VATDBDSP+0(R7,R4)                                             
         ST    R0,PEPTDVTB+0(R4)                                                
*                                                                               
         L     R0,PEPTRTVS+0(R4)      VAT FOR RETAIL                            
         A     R0,RETVDSP+0(R7,R4)                                              
         ST    R0,PEPTRTVS+0(R4)                                                
*                                                                               
         L     R0,PEPTRVTB+0(R4)      VAT BASIS FOR RETAIL                      
         A     R0,VATRBDSP+0(R7,R4)                                             
         ST    R0,PEPTRVTB+0(R4)                                                
*                                                                               
         SH    R4,=H'4'            DECREMENT INDEX REGISTER                     
         BNM   BCA06                                                            
*                                                                               
*                                                                               
BCA09    DS    0H                                                               
*                                                                               
BCA2C    CLI   SVAORACT,C' '        SEE IF AOR                                  
         BNH   BCA3                                                             
         CLC   0(2,R5),SVAOREFF     AND EFFECTIVE THIS MOS                      
         BL    BCA3                                                             
***NEW 5/17/91                                                                  
         CLC   0(2,R5),SVAORKIL     AND KILL DATE                               
         BNL   BCA3                                                             
***NEW 5/17/91                                                                  
         L     R0,PEPTAOR                                                       
         A     R0,AORDSP(R7)                                                    
         ST    R0,PEPTAOR                                                       
         L     R0,PEPTAORT                                                      
         A     R0,AORBDSP(R7)                                                   
         ST    R0,PEPTAORT                                                      
*                                                                               
         LA    R4,NPROVS*4               USE AS INDEX                           
*                                                                               
BCA09B   DS    0H                                                               
         L     R0,PEPTVTAS(R4)           VAT FOR AOR                            
         A     R0,VATADSP(R7,R4)                                                
         ST    R0,PEPTVTAS(R4)                                                  
*                                                                               
         SH    R4,=H'4'                                                         
         BNM   BCA09B                                                           
*                                                                               
         MVC   PEPTAORP,SVAORPCT         AOR PCT                                
         MVC   PEPTAORD,SVAORDA          DISK ADDR                              
         MVC   PEPTAORB,SVAORBAS         BASIS                                  
         MVC   PEPTAORA,SVAORACT         ACCOUNT                                
***NEW 5/17/91                                                                  
         MVC   PEPTAOVS,SVAORVCS         AOR VAT CODES                          
*                                                                               
BCA3     L     RE,ADPRD                                                         
         MVC   PEPTPACT,PPRDACCT-PPRDREC(RE) SET PRD ACCT CODE                  
*                                                                               
         CLI   W+5,C'C'            TEST COMM ONLY BILL                          
         BE    BCA4                YES                                          
         B     BCA4B                                                            
***      CHECK FOR MANUAL BILL PCT OF LESS THAN 20 NO-OPED                      
*                                                                               
*****    OC    MANPCT,MANPCT       OR IF PCT                                    
*****    BZ    BCA4B                                                            
*****    CLC   MANPCT,=F'2000'     LESS THAN 20 PCT                             
*****    BH    BCA4B                                                            
*                                                                               
BCA4     DS    0H                                                               
         OI    PEPTSTAT,X'80'      SET IN STATUS AREA                           
BCA4B    DS    0H                                                               
         MVC   PEPTBILF,W+20       STORE SAVED FORMULA                          
*                                                                               
         BAS   RE,BCPTCH2          TEST FOR PATCH                               
*                                                                               
         B     BCX                  EXIT                                        
*                                                                               
BCPASS   DC    X'00'                                                            
BCPTCH1  BR    RE                   FOR PATCHING                                
         DC    50X'00'                                                          
BCPTCH2  BR    RE                                                               
         DC    50X'00'                                                          
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
PVATSW   DS    XL1                                                              
*                                                                               
PEPTW    DS    XL(PEPTABRL)                                                     
*                                                                               
GETBFRW  DS    XL(PPGBFRDL)'00'                                                 
*                                                                               
         TITLE 'FMTAMT - FORMAT BILLING AMOUNTS'                                
*                                                                               
FMTAMT   CSECT                                                                  
         NMOD1 0,FMTAMT                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVC   HLDINO,SPACES                                                    
*                                                                               
         ST    R3,SAVBRK           SAVE BRK LEVEL                               
*                                  SET ZLSW TO CONTROL ZERO LINE TOTALS         
         MVI   ZLSW,C'N'           N = NO SPECIAL TREATMENT                     
**NO-OP**                                                                       
*****    CLC   SAVBRK,ALOWTOG         IF AT LOWEST LEVEL                        
*****    BE    FA2D                                                             
**NO-OP **                                                                      
         CLI   ZLOPT,C'A'             OR IF NOT FOR THIS TYPE                   
         BE    FA2B                                                             
         CLC   TYPE,ZLOPT                                                       
         BNE   FA2D                                                             
FA2B     DS    0H                                                               
*                                  MUST SEE IF I'M SHOWING 3 TYPES              
*                                  IF SO THIS OPTION WILL SUPPRESS              
*                                  PREVIOUS BILLING AND BILLABLE LINE           
*                                  IF THERE IS NO PREVIOUS BILLINGS             
         LA    R2,ORDSW                                                         
         LA    R4,3                                                             
FA2B5    CLI   0(R2),C'Y'                                                       
         BE    FA2B8                                                            
         CLI   0(R2),C'D'          SHOWING ONLY FOR INS DETAIL                  
         BNE   FA2D                MUST BE 'N' SO LEAVE ZLSW='N'                
         CLI   BRKCODE+3,DESCEQ                                                 
         BNE   FA2D                                                             
FA2B8    LA    R2,1(R2)                                                         
         BCT   R4,FA2B5                                                         
         MVI   ZLSW,C'Y'                                                        
*                                                                               
FA2D     DS    0H                                                               
*                                                                               
         LM    R2,R3,0(R1)         R2 = A(ORD AND BILLED)                       
*                                  R3 = A(PREV INV NO.)                         
         CLI   FINANSW,0           FOR FINANCIAL CLIENTS USE                    
         BE    FA2D2               OPEN ORDERED ,BILLED                         
***R***                                                                         
         CLC   QPROG,=C'R1'    FINANCIAL REBATE BILLING                         
         BE    FA2D2           TREAT HERE AS NON-FINANCIAL                      
         CLC   QPROG,=C'RD'    FINANCIAL REBATE BILLING DRAFT                   
         BE    FA2D2           TREAT HERE AS NON-FINANCIAL                      
***R***                                                                         
         LA    R2,ROWTL(R2)                                                     
*                                                                               
FA2D2    ST    R2,ADACCUM    SAVE ACCUMLATOR ADDRESS FOR EDI CALL               
*                                                                               
         L     R8,AGRID                                                         
         USING ALINED,R8                                                        
         LA    RE,14                                                            
FA2D5    MVC   0(132,R8),SPACES                                                 
         LA    R8,132(R8)                                                       
         BCT   RE,FA2D5                                                         
         L     R8,AGRID                                                         
         CLI   UPASS,C'S'          RETAIL SUMMARY PASS                          
         BE    FMT40                                                            
*                                                                               
FMT5     DS    0H                                                               
*              BUILD MATRIX FOR DOLLARS                                         
         XC    ORGROSS(72),ORGROSS                                              
         MVC   ORGROSS(12),0(R2)      ORD GR,N,CD                               
         L     R0,ORGROSS                                                       
         S     R0,ORCD                                                          
         ST    R0,ORGLCD                                                        
         L     R0,ORNET                                                         
         S     R0,ORCD                                                          
         ST    R0,ORNLCD                                                        
         MVC   ORACOMM,ADSP(R2)      AGY COM                                    
         MVC   PBGROS(12),ROWHL(R2)  PREV BILLED GR,N,CD                        
         L     R0,PBGROS                                                        
         S     R0,PBCD                                                          
         ST    R0,PBGLCD                                                        
         L     R0,PBNET                                                         
         S     R0,PBCD                                                          
         ST    R0,PBNLCD                                                        
         MVC   PBACOMM,ROWHL+ADSP(R2)                                           
         MVC   BLGROSS(24),ORGROSS   CALC BILLABLE                              
         LA    R4,BLGROSS                                                       
         LA    R5,PBGROS                                                        
         LA    R6,6                FOR BCT                                      
FMT5C    L     R0,0(R4)                                                         
         S     R0,0(R5)                                                         
         ST    R0,0(R4)                                                         
         LA    R4,4(R4)                                                         
         LA    R5,4(R5)                                                         
         BCT   R6,FMT5C                                                         
*                                                                               
         MVC   HFORMAT,FORMAT                                                   
         MVC   HTYPES,ORDSW                                                     
         CLI   DOLNUM,1                                                         
         BNE   FMT6                                                             
         CLI   TYPNUM,1                                                         
         BNE   FMT6                                                             
*              ONE CAT AND 1 TYPE                                               
         LA    R7,ALCOL4           PUT IN COL4                                  
         BAS   RE,GETCAT           SETS FULL TO ORGROSS,OR NET,ETC..            
         L     R1,FULL                                                          
         BAS   RE,GETTYP           SETS FULL TO 0,20 OR 40- DISP                
         CLI   FULL,X'FF'          SEE IF NOT DISPLAYING THESE $                
         BE    FMT5X                                                            
         A     R1,FULL                                                          
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
FMT5X    B     FMT9                GO DO STRIP-OFF                              
*                                                                               
FMT6     CLI   DOLNUM,1            ONE CAT SEVERAL TYPES                        
         BNE   FMT7                                                             
*                                                                               
*                                  IF DOING INS DETAILS WITH PREV               
*                                  INVOICES AT INSERTION LEVEL                  
*                                  THEN MUST USE GRID FORMAT EVEN FOR           
*                                  ONE CATEGROY                                 
         IF    FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'I',FMT7                            
         IF    FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'D',FMT7                            
         IF    FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'B',FMT7                            
         LA    R7,ALCOL2                                                        
         CLI   TYPNUM,3                                                         
         BE    *+8                                                              
         LA    R7,ALCOL3                                                        
         ZIC   R4,TYPNUM                                                        
         BAS   RE,GETCAT                                                        
         L     R5,FULL                                                          
FMT6C    BAS   RE,GETTYP           SETS FULL TO 0,20 OR 40- DISP                
         CLI   FULL,X'FF'          SEE IF NOT DISPLAYING THESE $                
         BE    FMT6X               SKIP THIS COLUMN                             
         LR    R1,R5                                                            
         A     R1,FULL                                                          
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
FMT6X    LA    R7,16(R7)                                                        
         BCT   R4,FMT6C                                                         
         B     FMT9                GO DO STRIP-OFF                              
*                                                                               
FMT7     CLI   TYPNUM,1                                                         
         BNE   FMT8                                                             
         CLI   DOLNUM,5                                                         
         BNL   FMT8                                                             
         LA    R7,ALCOL1                                                        
         CLI   DOLNUM,4                                                         
         BE    FMT7A                                                            
         LA    R7,ALCOL2                                                        
         CLI   DOLNUM,3                                                         
         BE    FMT7A                                                            
         LA    R7,ALCOL3                                                        
FMT7A    ZIC   R4,DOLNUM                                                        
         BAS   RE,GETTYP           SETS FULL TO 0,20,40 - DISP                  
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    FMT7X               SKIP ALL COLUMNS TO STRIP-OFF                
         L     R5,FULL                                                          
FMT7C    BAS   RE,GETCAT                                                        
         L     R1,FULL                                                          
         AR    R1,R5                                                            
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
         LA    R7,16(R7)                                                        
         BCT   R4,FMT7C                                                         
FMT7X    B     FMT9                GO DO STRIP-OFF                              
*                                                                               
FMT8     DS    0H                  MORE THAN 1 CATS AND TYPES                   
*                                  OR ALL 5 CATS                                
*                                  MUST BUILD 'BOX'                             
         CLI   DOLNUM,3            SEE IF MORE THAN 3 CATS                      
         BH    FMT8G               YES MUST PUT CATS AS ROWS                    
         MVI   NOPREVB,C'N'                                                     
         ZIC   R2,TYPNUM                                                        
FMT8B    LA    R7,ALCOL3            ELSE CATS AS COLUMNS                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R7,ALCOL2                                                        
         ZIC   R4,DOLNUM                                                        
         MVC   HFORMAT,FORMAT     MUST RESET FOR EACH TYPE                      
         BAS   RE,GETTYP           SETS FULL TO 0,20,40 - DISP                  
         L     R5,FULL                                                          
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    FMT8E               SKIP ROW  - DUE NEXT TYPE                    
         MVC   SAVTYPE,WORK        SAVE TYPE TO CHK IN FMT8D                    
         LA    RF,ALCOL2                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    RF,ALCOL1                                                        
         MVC   0(16,RF),WORK        HAS ANNOTATION - ORDERED,PREV,ETC           
*                                  MUST RESTORE R3 TO GET BRKCODE               
         L     R3,SAVBRK                                                        
         CLI   BRKCODE+3,DESCEQ    CHK AT INSERTN LEVEL                         
         BNE   FMT8D                                                            
*--->    CLC   WORK+4(5),=C'PREV.'   SEE IF DOING PREV BILLING                  
         CLC   WORK(16),TYPRVBD      SEE IF DOING PREV BILLING                  
         BNE   FMT8D                                                            
         L     RF,ADESC                                                         
         CLI   0(RF),X'F9'         SEE IF A 'REAL' BUY                          
         BH    FMT8D               NO                                           
*                                                                               
         CLI   LSTOPT,C'I'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    FMT8C                                                            
         CLI   LSTOPT,C'D'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    FMT8C                                                            
         CLI   LSTOPT,C'B'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    FMT8C                                                            
         B     FMT8D                                                            
*              BUY SHOULD BE IN ADWKREC                                         
*                                                                               
*              FOR EACH BILL ELEM PRINT PREV INV NO. AND AMTS                   
FMT8C    ST    R8,WK                                                            
         BAS   RE,GETINVS                                                       
***             GETINVS SETS WK TO NEXT LINE                                    
*                                                                               
         CLI   WK+4,X'01'          SEE IF PREV BILLING FOUND                    
         BNE   FMT8D                                                            
         L     R8,WK               SET LINE                                     
         BCT   R2,FMT8B                                                         
         B     FMT9                                                             
*                                                                               
FMT8D    MVI   NONZSW,1                                                         
         CLI   ZLSW,C'Y'   SEE IF SUPPRESSING ZERO PREV. BILL LINE              
         BNE   FMT8D3                                                           
*--->    CLC   SAVTYPE+4(5),=C'PREV.'  SEE IF DOING PREV BILLING                
         CLC   SAVTYPE(16),TYPRVBD     SEE IF DOING PREV BILLING                
         BNE   FMT8D3                                                           
         MVI   NONZSW,0                                                         
FMT8D3   BAS   RE,GETCAT                                                        
         LR    R1,R5                                                            
         A     R1,FULL                                                          
         L     R6,0(R1)                                                         
         LTR   R6,R6                                                            
         BZ    *+8                                                              
         OI    NONZSW,X'01'       SET NON-ZERO AMT FOUND                        
         BAS   RE,FMTEDT                                                        
         LA    R7,16(R7)                                                        
         BCT   R4,FMT8D3           GO CHK NEXT CAT                              
         CH    R2,=H'1'            SEE IF DOING BILLABLE LINE                   
         BE    FMT8D5                                                           
         TM    NONZSW,X'01'                                                     
         BNZ   FMT8D7                                                           
         B     FMT8D6              ALL PREV BILLED CATS ARE ZERO                
*                                  DON'T PRINT THIS LINE                        
*                                                                               
FMT8D5   CLI   NOPREVB,C'Y'        WILL ONLY BE 'Y' FOR BILLABLE LINE           
         BNE   FMT8D7              IF THERE WAS NO PREV BILLING                 
*                                  AND IT IS BEING SUPPRESSED                   
FMT8D6   MVC   0(132,R8),SPACES    MUST BLANK-OUT ANNO AND $'S                  
         MVI   NOPREVB,C'Y'        SET SO I WON'T PRINT BILLABLE LINE           
         B     FMT8E               AND NOT SKIP A LINE                          
*                                                                               
FMT8D7   LA    R8,132(R8)          DUE NEXT LINE                                
FMT8E    BCT   R2,FMT8B                                                         
         B     FMT9                NOW DO STRIP-OFF                             
*                                                                               
FMT8G    DS    0H                  CATS AS ROWS                                 
         ZIC   R2,DOLNUM                                                        
FMT8I    LA    R7,ALCOL3                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R7,ALCOL2                                                        
         ZIC   R4,TYPNUM                                                        
         BAS   RE,GETCAT           SETS FULL TO ORGROSS OR ORNET,ETC            
         MVC   HTYPES,ORDSW        MUST RESET EACH CAT                          
         L     R5,FULL                                                          
         LA    RF,ALCOL2                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    RF,ALCOL1                                                        
         MVC   0(16,RF),WORK      HAS ANNOTATION - ORDERED,PREV,ETC             
FMT8K    BAS   RE,GETTYP           SETS FULL TO 0,20,40                         
         L     R1,FULL                                                          
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    FMT8M                                                            
         AR    R1,R5                                                            
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
FMT8M    LA    R7,16(R7)                                                        
         BCT   R4,FMT8K                                                         
         LA    R8,132(R8)          DO NEXT LINE                                 
         BCT   R2,FMT8I                                                         
         B     FMT9                NOW DO STRIP-OFF                             
*                                                                               
FMT9     DS    0H                  STRIP-OFF                                    
         L     R2,ADACCUM         RESET R2 TO ACCUMULATOR                       
         GOTO1 ABILLEDI,DMCB,('EDMMTA',HLDINO)   EDI CALL                       
         LA    R2,5                FOR BCT                                      
         L     R8,AGRID            RESET TO FIRST LINE FOR STRIP                
         LA    R7,ALSTRIP                                                       
         LA    R1,BLGROSS                                                       
         LA    R5,STRIPT           STRIP TABLE                                  
FMT9B    CLC   STRIP,0(R5)                                                      
         BE    FMT9E                                                            
         LA    R1,4(R1)                                                         
         LA    R5,1(R5)                                                         
         BCT   R2,FMT9B                                                         
         B     FMT9X                IF STRIP NOT IN TABLE-SKIP                  
*                                                                               
FMT9E    L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
FMT9X    B     FMTAMTX                                                          
*                                                                               
STRIPT   DC    C'GNC12'      1=G-CD,2=N-CD                                      
NONZSW   DC    X'00'                                                            
NOPREVB  DC    C'N'          PRESET JUST IN CASE                                
SAVTYPE  DS    CL16                                                             
*                                                                               
         EJECT                                                                  
GETCAT   NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         XC    FULL,FULL                                                        
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   CATNAMES(L'PPRGROSS),PPRGROSS                                    
*COST2*                                                                         
         CLI   CAROPT,C'Y'    CHECK CARAT OPTION                                
         BNE   *+10                                                             
         MVC   CATNAMES(16),=C'  COST TO CLIENT'                                
*COST2*                                                                         
         MVC   CATNET(L'PPRNET),PPRNET                                          
         MVC   CATCDISC(L'PP@CDISC),PP@CDISC                                    
         MVC   CATGRSLC(L'PPRGRSLC),PPRGRSLC                                    
         MVC   CATNETCD(L'PPRNETCD),PPRNETCD                                    
         MVC   CATAGYCM(L'PPAAGYCM),PPAAGYCM                                    
         DROP  RE                                                               
*                                                                               
         LA    R4,6                FOR BCT                                      
         LA    R5,HFORMAT                                                       
         LA    R6,ORGROSS                                                       
         LA    R7,CATNAMES                                                      
GETC3    CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    GETC5                                                            
         LA    R5,1(R5)                                                         
         LA    R6,4(R6)                                                         
         LA    R7,16(R7)                                                        
         BCT   R4,GETC3                                                         
         B     GETCX                                                            
*                                                                               
GETC5    ST    R6,FULL             SAVE ADDRESS OF DOLLARS                      
         MVI   0(R5),C'N'          SO I WON'T REDO THIS CAT                     
         MVC   WORK(16),0(R7)                                                   
GETCX    XIT1                                                                   
*                                                                               
CATNAMES DC    CL16'           GROSS'                                           
CATNET   DC    CL16'             NET'                                           
CATCDISC DC    CL16'      CASH DISC.'                                           
CATGRSLC DC    CL16'   GROSS LESS CD'                                           
CATNETCD DC    CL16'     NET LESS CD'                                           
CATAGYCM DC    CL16'    AGENCY COMM.'                                           
**                                                                              
         EJECT                                                                  
GETTYP   NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   TYPNAMES,PP@ORD                                                  
         MVC   TYPRVBD,PP@PRV04                                                 
         MVC   TYPBILLA,PP@BILLA                                                
         DROP  RE                                                               
*                                                                               
         XC    FULL,FULL                                                        
         LA    R5,HTYPES                                                        
         LA    R6,0                                                             
         LA    R7,TYPNAMES                                                      
         LA    R4,3                FOR BCT                                      
GETT3    CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    GETT5                                                            
         CLI   0(R5),C'D'          SEE IF DOING THIS TYPE ONLY AT               
         BNE   GETT4               INSERTTION DETAIL LEVEL                      
         L     R3,SAVBRK           SEE IF AT INS DETAIL LEVEL                   
         CLI   BRKCODE+3,DESCEQ                                                 
         BE    GETT5                                                            
         MVI   FULL,X'FF'          SET NOT TO DISPLAY $                         
         B     GETT8                                                            
*                                                                               
GETT4    LA    R5,1(R5)                                                         
         LA    R6,24(R6)                                                        
         LA    R7,16(R7)                                                        
         BCT   R4,GETT3                                                         
         B     GETTX                                                            
*                                                                               
GETT5    ST    R6,FULL             SAVE DISP                                    
GETT8    MVI   0(R5),C'N'          SO I WON'T REDO THIS TYPE                    
         MVC   WORK(16),0(R7)                                                   
**NEW 10/17/89                                                                  
         CLI   PAYOPT,C'G'         SEE IF CHANGING ORDERED TO CLEARED           
         BE    GETT8C                                                           
         CLI   PAYOPT,C'C'         SEE IF CHANGING ORDERED TO CLEARED           
         BNE   GETTX                                                            
*                                                                               
GETT8C   L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    CLC   WORK+9(7),=C'ORDERED'                                            
         CLC   WORK(16),PP@ORD                                                  
         BNE   GETTX                                                            
*--->    MVC   WORK+9(7),=C'CLEARED'                                            
         MVC   WORK(16),SPACES                                                  
         MVC   WORK+16-L'PP@CLEAR(L'PP@CLEAR),PP@CLEAR                          
         DROP  RE                                                               
**NEW 10/17/89                                                                  
GETTX    XIT1                                                                   
*                                                                               
TYPNAMES DC    CL16'         ORDERED'                                           
TYPRVBD  DC    CL16'    PREV. BILLED'                                           
TYPBILLA DC    CL16'        BILLABLE'                                           
**                                                                              
*                                                                               
         EJECT                                                                  
GETINVS  NTR1                                                                   
         L     R8,WK               LINE                                         
         MVI   WK+4,0              WILL BE SET TO 1                             
*                                  IF PREV BILLING IS FOUND                     
         L     R2,ADWKREC                                                       
         LA    R2,33(R2)                                                        
         CLI   1(R2),0             JUST IN CASE - TO AVOID LOOPS                
         BE    GETINVSX                                                         
         MVI   ELCODE,X'26'                                                     
         CLI   FINANSW,0           FOR FINANCIAL CLIENTS LOOK FOR               
         BE    GETI5               X'28' BILL ELEMS                             
         MVI   ELCODE,X'28'                                                     
***R***                                                                         
         CLC   QPROG,=C'R1'       SEE IF FINANCIAL REBATE BILL                  
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'    SEE IF FINANCIAL REBATE BILL DRAFT               
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
***R***                                                                         
GETI5    BAS   RE,INXTEL                                                        
         BNE   GETINVSX                                                         
         USING PBILELEM,R2                                                      
         OC    PBLDATE,PBLDATE     CHK FOR BILLED DATE                          
         BZ    GETI5               NONE - SKIP                                  
         CLC   PBLDATE,TODAYB      SKIP ELEM I JUST ADDED                       
         BE    GETI5                                                            
         CLI   MANRVDTP,0          SEE IF DOING A REVERSAL                      
         BE    GETI7                                                            
         CLC   PBINVNO,MANRVNO     ONLY SHOW BILL I'M REVERSING                 
         BNE   GETI5                                                            
         B     GETI8                                                            
*                                                                               
GETI7    TM    PBBILST,X'C0'       SKIP REVERSED AND REVERSALS                  
         BNZ   GETI5                                                            
*                                                                               
         CLI   SCBNCSW,C'C'         UFC COMM BILLING                            
         BNE   GETI7C                                                           
         TM    PBBILST,X'01'       SEE IF RIGHT TYPE                            
         BZ    GETI5                                                            
         B     GETI8                                                            
*                                                                               
GETI7C   DS    0H                                                               
         CLI   SCBNCSW,C'N'         UFC NET BILLING                             
         BNE   GETI8                                                            
         TM    PBBILST,X'02'       SEE IF RIGHT TYPE                            
         BZ    GETI5                                                            
*                                                                               
GETI8    L     RF,APRD                                                          
         CLC   PBPRD,0(RF)         MUST BE RIGHT PRODUCT                        
         BNE   GETI5                                                            
*                                                                               
         CLI   MRDASS,C'Y'         CHECK FOR SPECIAL DRD SCHEME                 
         BNE   GETI8X                                                           
*                                                                               
*           READ BILL AND SEE IF REG/DST MATCH SAVMGRU                          
*                                                                               
         GOTO1 ARDBILL,DMCB,ADWKREC,(R2)                                        
         L     RF,ADBILL                                                        
         CLC   SAVMGRU(6),PNBMGR1-PBILLREC(RF)                                  
         BNE   GETI5           SKIP IF NO MATCH                                 
*                                                                               
GETI8X   DS    0H                                                               
*              FOR EACH BILL ELEM SET PBGROS, ETC                               
*                                                                               
         OI    WK+4,X'01'          SET PREV BILLING FOUND                       
         MVC   PBGROS,PBGROSS     GROSS                                         
         L     R0,PBGROSS                                                       
         S     R0,PBAGYCOM                                                      
         ST    R0,PBNET            NET                                          
         MVC   PBCD,PBCSHDSC       CD                                           
         S     R0,PBCSHDSC                                                      
         ST    R0,PBNLCD           N-CD                                         
         L     R0,PBGROSS                                                       
         S     R0,PBCSHDSC                                                      
         ST    R0,PBGLCD           GROSS-CD                                     
         MVC   PBACOMM,PBAGYCOM                                                 
         L     RF,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RF),C'C' SEE IF 'C' RATE BUY                    
         BNE   *+12                                                             
         LA    R4,PBACOMM                                                       
         BAS   RE,FIXAC                                                         
*                                                                               
         LA    R7,ALCOL3            CATS AS COLUMNS                             
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R7,ALCOL2                                                        
         ZIC   R4,DOLNUM                                                        
         MVC   HFORMAT,FORMAT     MUST RESET FOR EACH INVOICE                   
         MVC   WORK(16),SPACES                                                  
         MVC   W(2),PBLDATE        GETNUM NEEDS Y/M IN W                        
*                                                                               
         MVC   SVSVIMO,SVINVMO     SAVE 'REAL' INV MTH                          
*                                                                               
         GOTO1 AGETNUM,DMCB,(1,PBINVNO),WORK+6                                  
*                                                                               
         MVC   SVINVMO,SVSVIMO     RESTORE 'REAL' INV MO                        
         MVC   HLDINO,WORK+6                                                    
*                                                                               
         LA    RF,ALCOL2                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    RF,ALCOL1                                                        
         MVC   1(15,RF),WORK                                                    
         CLI   WORK+15,C' '        SEE IF INV NUMBER ONLY 9 LONG                
         BE    GETI10              YES                                          
         MVC   0(16,RF),WORK                                                    
GETI10   BAS   RE,GETCAT                                                        
         LR    R1,R5                                                            
         A     R1,FULL                                                          
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
         LA    R7,16(R7)                                                        
         BCT   R4,GETI10                                                        
         LA    R8,132(R8)          DUE NEXT LINE                                
         B     GETI5               GO DO NEXT ELEM                              
*                                                                               
GETINVSX ST   R8,WK                                                             
         XIT1                                                                   
         SPACE 2                                                                
INXTEL   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    INXTEL2                                                          
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     INXTEL                                                           
INXTEL2  DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
         DROP  R2                                                               
         EJECT                                                                  
FIXAC    NTR1                                                                   
*                                  R4 HAS ADDR OF 'BAD' AC                      
*                                  WILL BE SAME AS GROSS                        
*                                  FOR 'C' RATE BUYS                            
         L     RF,ADBUY                                                         
         ZAP   DUB,PBDACP-PBUYREC(3,RF)                                         
         BNZ   FIXAC5                                                           
         XC    0(4,R4),0(R4)       CLEAR AC                                     
         B     FIXACX                                                           
*                                                                               
FIXAC5   CVB   R0,DUB                                                           
         L     R1,0(R4)                                                         
         L     RF,=F'100000'                                                    
         SR    RF,R0                                                            
         MR    RE,R1                                                            
         SLDL  RE,1                                                             
         D     RE,=F'100000'                                                    
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
*                                                                               
         LR    R0,R1                                                            
         SR    R0,RF                                                            
         ST    R0,0(R4)            STORE 'FIXED' AGY COM                        
FIXACX   XIT1                                                                   
*                                                                               
ORGROSS  DS    F                ORDERED                                         
ORNET    DS    F                                                                
ORCD     DS    F                                                                
ORGLCD   DS    F                                                                
ORNLCD   DS    F                                                                
ORACOMM  DS    F                                                                
*                                                                               
PBGROS   DS    F                PREV BILLED                                     
PBNET    DS    F                                                                
PBCD     DS    F                                                                
PBGLCD   DS    F                                                                
PBNLCD   DS    F                                                                
PBACOMM  DS    F                                                                
*                                                                               
BLGROSS  DS    F                BILLABLE                                        
BLNET    DS    F                                                                
BLCD     DS    F                                                                
BLGLCD   DS    F                                                                
BLNLCD   DS    F                                                                
BLACOMM  DS    F                                                                
****                                                                            
*                                                                               
         SPACE 3                                                                
*              RETAIL SUMMARY PASS                                              
FMT40    DS    0H                                                               
         OC    0(4,R3),0(R3)                                                    
         BZ    FMT42               NO INV. NO.                                  
         CLC   SAVBRK,ALOWTOG                                                   
         BNE   FMT42               ONLY AT LOWEST LEVEL                         
         MVC   W(2),0(R3)                                                       
*                                                                               
         MVC   SVSVIMO,SVINVMO        SAVE 'REAL' INV MTH                       
*                                                                               
         GOTO1 AGETNUM,DMCB,(1,2(R3)),WORK                                      
*                                                                               
         MVC   SVINVMO,SVSVIMO       RESTORE 'REAL INV MTH                      
*                                                                               
         MVC   ALCOL3+4(10),WORK                                                
*                                                                               
FMT42    DS    0H                                                               
         L     R6,0(R2)                                                         
         LA    R7,ALCOL4                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         B     FMTAMTX                                                          
FMTAMTX  DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
FMTEDT   DS    0H                                                               
         LA    R1,ALCOL4        SEE IF DOING LAST COLUMN                        
         CR    R7,R1                                                            
         BNE   FMTEDT5          YES - MOVE EDITED AMT OVER 1 COL                
         ST    RE,DUB                                                           
*--->    EDIT  (R6),(15,0(R7)),2,COMMAS=YES,CR=YES                              
         CURED (R6),(15,0(R7)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,DUB                                                           
         CLI   13(R7),C' '                                                      
         BHR   RE                                                               
         MVC   13(2,R7),TOTSTAR                                                 
         BR    RE                                                               
FMTEDT5  DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R6),(15,1(R7)),2,COMMAS=YES,CR=YES                              
         CURED (R6),(15,1(R7)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,DUB                                                           
         CLI   14(R7),C' '                                                      
         BHR   RE                                                               
         MVC   14(2,R7),TOTSTAR                                                 
         BR    RE                                                               
         SPACE 2                                                                
FMTEDTSP DS    0H                                                               
         L     R0,12(R2)                                                        
         EDIT  (R0),(5,10(R7))                                                  
         BR    RE                                                               
         SPACE 3                                                                
         DROP  R8                                                               
*                                                                               
HLDINO   DS    CL10                                                             
ADACCUM  DS    F         SAVED ADDRESS OF ACCUMULATOR FOR EDI CALL              
*                                                                               
         LTORG                                                                  
         TITLE 'LSTINV  - ROUTINE FOR PREVIOUS BILLING'                         
LSTINV   CSECT                                                                  
         NMOD1 0,LSTINV                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         L     R3,SAVBRK                                                        
         L     RF,BRKCODE                                                       
         L     RF,ATOTS(RF)             POINT TO ACCUM                          
         LR    R7,RF                                                            
         AH    R7,=Y(MAXMOS*ROWL)       POINT TO TOTAL ROW                      
         CLI   FINANSW,0            FOR FINANCIAL USE OPEN BILLING              
         BE    LI20                                                             
***R***                                                                         
         CLC   QPROG,=C'R1'        EXCEPT FINANCIAL REBATE BILLING              
         BE    LI20                                                             
         CLC   QPROG,=C'RD'  EXCEPT FINANCIAL REBATE BILLING DRAFT              
         BE    LI20                                                             
***R***                                                                         
         LA    R7,ROWTL(R7)                                                     
LI20     OC    ROWHL(8,R7),ROWHL(R7)                                            
         BZ    LSTINVX             NO PREVIOUS BILLING                          
*                                                                               
         MVI   PRSW,C'H'           SET TO HOLD PRINT LINES                      
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
*                                                                               
         XC    LSTTOTS,LSTTOTS                                                  
*                                                                               
         CLC   BORDSW(3),=C'YNN'                                                
         BE    LI30                 (ORDERED ONLY)                              
         B     LI40                OHTERS                                       
*                                                                               
         EJECT                                                                  
*                             SUBTRACT OUT PREVIOUS BILLS                       
*                             ON SOME INVOICE                                   
LI30     DS    0H                                                               
         CLI   LSTOPT,C'Y'                                                      
         BE    LI34                                                             
         CLI   LSTOPT,C'I'                                                      
         BE    LI34                                                             
         CLI   LSTOPT,C'R'                                                      
         BE    LI34                                                             
         CLI   LSTOPT,C'B'                                                      
         BE    LI34                                                             
*                                  FOR LSTOPT 'N' OR 'D'                        
*                                  JUST SUBTRACTING TOTAL PREVIOUS              
         MVC   LSTGRS(16),ROWHL(R7)     GROSS,NET,CD,AC                         
         LA    R5,ALDESC                                                        
         CLI   DOLNUM,4                                                         
         BNL   LI30C               4 OR 5 OR 6                                  
         LA    R5,ALCOL1-8                                                      
         CLI   DOLNUM,3                                                         
         BE    LI30C                                                            
         LA    R5,ALCOL2-8                                                      
         CLI   DOLNUM,2                                                         
         BE    LI30C                                                            
         LA    R5,ALCOL3-8         MUST BE 1                                    
LI30C    DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(21,R5),=C'LESS PREVIOUS BILLING'                               
         MVC   0(L'PP@LPB,R5),PP@LPB                                            
         DROP  RE                                                               
         MVC   X(16),LSTGRS                                                     
         BAS   RE,LSTFMT                                                        
         GOTO1 APRNT                                                            
         LM    R0,R1,0(R7)                                                      
         S     R0,ROWHL(R7)                                                     
         S     R1,ROWHL+NDSP(R7)                                                
         STM   R0,R1,X             ORDERED LESS PREVIOUS                        
         L     R0,CDSP(R7)         CD                                           
         S     R0,ROWHL+CDSP(R7)                                                
         ST    R0,X+8                                                           
         L     R0,ADSP(R7)         AC                                           
         S     R0,ROWHL+ADSP(R7)                                                
         ST    R0,X+12                                                          
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
         B     LI90                                                             
*                                                                               
LI34     DS    0H                                                               
         LA    R5,ALDESC                                                        
         CLI   DOLNUM,4                                                         
         BNL   LI34C               4 OR 5                                       
         LA    R5,ALCOL1-8                                                      
         CLI   DOLNUM,3                                                         
         BE    LI34C                                                            
         LA    R5,ALCOL2-8                                                      
         CLI   DOLNUM,2                                                         
         BE    LI34C                                                            
         LA    R5,ALCOL3-8         MUST BE 1                                    
LI34C    DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(21,R5),=C'LESS PREVIOUS BILLING'                               
         MVC   0(L'PP@LPB,R5),PP@LPB                                            
         DROP  RE                                                               
         MVC   132(21,R5),DASHES                                                
         GOTO1 APRNT                                                            
         BAS   RE,LSTLST                                                        
         LM    R0,R1,0(R7)                                                      
         S     R0,ROWHL(R7)                                                     
         S     R1,ROWHL+4(R7)                                                   
         STM   R0,R1,X                                                          
         L     R0,CDSP(R7)         CD                                           
         S     R0,ROWHL+CDSP(R7)                                                
         ST    R0,X+8                                                           
         L     R0,ADSP(R7)         AC                                           
         S     R0,ROWHL+ADSP(R7)                                                
         ST    R0,X+12                                                          
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
         B     LI90                                                             
***                                                                             
***NOTE NO NEED TO RESTATE AMT DUE ON ORDERED ONLY BILL                         
***                                                                             
         EJECT                                                                  
*                             BILL IS COMPLETE                                  
*                             AND PREV LIST IS JUST FOR INFO                    
LI40     DS    0H                                                               
         MVI   P1,0                                                             
         MVI   P2,C'*'                                                          
         MVC   P2+1(83),P2                                                      
*                             PRINT A LINE OF STARS                             
         GOTO1 APRNT                                                            
         LA    R5,ALDESC+3                                                      
         CLI   DOLNUM,4                                                         
         BNL   LI40C                                                            
         LA    R5,ALCOL1                                                        
         CLI   DOLNUM,3                                                         
         BE    LI40C                                                            
         LA    R5,ALCOL2                                                        
LI40C    DS    0H                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(14,R5),=C'PREVIOUS BILLS'                                      
         MVC   0(L'PP@PRVBL,R5),PP@PRVBL                                        
         MVC   LCATNAM(L'PPRGROSS),PPRGROSS                                     
         MVC   LCATNET(L'PPRNET),PPRNET                                         
         MVC   LCATCD(L'PP@CDISC),PP@CDISC                                      
         MVC   LCATGLCD(L'PPRGRSLC),PPRGRSLC                                    
         MVC   LCATNLCD(L'PPRNETCD),PPRNETCD                                    
         MVC   LCATAC(L'PPAAGYCM),PPAAGYCM                                      
         DROP  RE                                                               
         MVC   132(14,R5),DASHES                                                
*                                                                               
*              SEE IF CATS AS COLUMNS                                           
*              IF SO DON'T REDISPLAY THEM                                       
         IF    TYPNUM,=,1,AND,DOLNUM,=,4,LI50                                   
         IF    TYPNUM,LT,4,AND,DOLNUM,LT,4,LI50                                 
         ZIC   R4,DOLNUM                                                        
         CH    R4,=H'4'                                                         
         BNH   *+8                                                              
         LA    R4,4                CAN ONLY DO 4 DOL TYPES                      
         LA    R5,16(R5)                                                        
*                                                                               
         MVC   HFORMAT,FORMAT                                                   
*                                                                               
LI40F    BAS   RE,LGETCAT                                                       
         MVC   0(16,R5),WORK                                                    
         LA    R5,16(R5)                                                        
         BCT   R4,LI40F                                                         
LI50     GOTO1 APRNT                                                            
*                                                                               
         BAS   RE,LSTLST                                                        
         B     LI80                                                             
LI80     DS    0H                                                               
         CLI   LSTOPT,C'R'         SEE IF RESTATING AMT DUE                     
         BE    LI85                                                             
         CLI   LSTOPT,C'B'         SEE IF RESTATING AMT DUE                     
         BNE   LI90                                                             
LI85     GOTO1 APRNT               SKIP A LINE                                  
*                                                                               
         L     RE,=V(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
         L     R0,SVAMTDUE                                                      
         LTR   R0,R0               TEST DUE POS OR NEG                          
         BM    LIA26                                                            
         CLI   RETPROF,0           FOR RETAIL USE DIFFERENT WORDS               
         BE    LIA24D                                                           
         CLI   UPASS,C'S'          UNLESS SUMMARY PASS                          
         BNE   LIA25                                                            
LIA24D   DS    0H                                                               
*--->    MVC   W(16),=C'** AMOUNT DUE **'                                       
         MVC   W(L'PP@AMDUE),PP@AMDUE                                           
         C     R3,AINVBRK                                                       
         BE    LIA27                                                            
*--->    MVC   W(15),=C'AMOUNT DUE FOR '                                        
         MVC   W(L'PP@ADFOR),PP@ADFOR                                           
         MVC   W+15(12),TOTNAME    LEVEL NAME                                   
         B     LIA27                                                            
*                                                                               
LIA25    DS    0H                  RETAIL TOTAL WORDS                           
         MVC   W,SPACES                                                         
*--->    MVC   W(18),=C'** TOTAL AMOUNT **'                                     
         MVC   W(L'PP@TAMT),PP@TAMT                                             
         C     R3,AINVBRK                                                       
         BE    LIA27                                                            
*--->    MVC   W(10),=C'TOTAL FOR '                                             
         MVC   W(L'PP@TLFOR),PP@TLFOR                                           
         MVC   W+L'PP@TLFOR+1(12),TOTNAME         LEVEL NAME                    
         B     LIA27                                                            
LIA26    DS    0H                                                               
*--->    MVC   W(19),=C'** CREDIT AMOUNT **'                                    
         MVC   W(L'PP@CDAMT),PP@CDAMT                                           
         CLC   SAVBRK,AINVBRK                                                   
         BE    LIA27                                                            
*--->    MVC   W(18),=C'CREDIT AMOUNT FOR '                                     
         MVC   W(L'PP@CAMFR),PP@CAMFR                                           
         MVC   W+L'PP@CAMFR+1(12),TOTNAME       LEVEL NAME                      
         DROP  RE                                                               
*                                                                               
LIA26B   DS    0H                                                               
LIA27    DS    0H                                                               
         LA    R2,P1                                                            
         CLI   BDOLNUM,1                                                        
         BNE   LIA3A2                                                           
         CLI   BTYPNUM,1                                                        
         BNE   LIA3A2                                                           
LIA3A    DS    0H                                                               
         SH    R2,=H'16'      SHIFT SINGLE COL. FORMATS LEFT 1 COL.             
LIA3A2   DS    0H                                                               
         LA    RF,W+32                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R1,W                                                             
         SR    RF,R1               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         L     RE,DUB                                                           
         CLI   ALCOL4+13,C' '                                                   
         BH    LI87                                                             
         MVC   ALCOL4+13(2),=C'**'                                              
         B     LI88                                                             
*                                                                               
LI87     MVC   ALCOL4+15(2),=C'**'                                              
LI88     GOTO1 APRNT                                                            
*                                                                               
LI90     MVI   PRSW,C'F'           FLUSH PRINT LINES                            
         GOTO1 APRNT                                                            
         SPACE 2                                                                
LSTINVX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
LSTLST   NTR1                                                                   
         SPACE 2                                                                
         L     R6,INVTABN          FOR BCT                                      
         LTR   R6,R6                                                            
         BNP   LSTINVX                                                          
         L     R4,AINVTAB          START OF TABLE                               
         XC    X,X                                                              
         USING INVLD,R4                                                         
*                                  SET TO HOLD PRINT LINES                      
         OC    AMED,AMED                                                        
         BZ    LST11                                                            
         CLC   AMEDBRK,AINVBRK                                                  
         BH    LST12                                                            
         L     RF,AMED                                                          
         CLC   INVLMED,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST11    DS    0H                                                               
         CLC   APRDBRK,AINVBRK     TEST PROD SEP                                
         BH    LST12               NO                                           
         L     RF,APRD             YES - MUST BE RIGHT PROD                     
         CLC   INVLPRD,0(RF)                                                    
         BNE   LST30                                                            
         B     LST14                                                            
*                                                                               
LST12    DS    0H                                                               
         OC    APGR1BRK,APGR1BRK                                                
         BZ    LST14                                                            
         CLC   APGR1BRK,AINVBRK    TEST PGR SEP                                 
         BH    LST14               NO                                           
         L     RF,APGR1                                                         
         CLC   INVLPGR,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
*                                                                               
LST14    DS    0H                                                               
         CLC   AESTBRK,AINVBRK     TEST EST SEP                                 
         BH    LST14C              NO                                           
*                                                                               
         L     RF,AEST             YES - MUST BE RIGHT EST                      
         CLC   INVLEST,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST14C   DS    0H                                                               
         OC    AJOBBRK,AJOBBRK                                                  
         BZ    LST15                                                            
         CLC   AJOBBRK,AINVBRK     TEST JOB SEP                                 
         BH    LST15               NO                                           
         L     RF,AJOB             YES - MUST BE RIGHT JOB                      
         CLC   INVLJOB,3(RF)       SINCE AJOB STARTS WITH PRD                   
         BNE   LST30                                                            
*                                                                               
LST15    DS    0H                                                               
         OC    APUBBRK,APUBBRK                                                  
         BZ    LST16                                                            
         CLC   APUBBRK,AINVBRK     TEST PUB SEP                                 
         BH    LST16               NO                                           
         L     RF,APUB             YES - MUST BE RIGHT PUB                      
         CLC   INVLPUB,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST16    DS    0H                                                               
         OC    AMKTBRK,AMKTBRK                                                  
         BZ    LST18                                                            
         CLC   AMKTBRK,AINVBRK     TEST MKT SEP                                 
         BH    LST18               NO                                           
         L     RF,AMKT             YES - MUST BE RIGHT MKT                      
         CLC   INVLMKT,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST18    DS    0H                                                               
*                                                                               
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    LST19                                                            
         CLC   AMGR1BRK,AINVBRK    TEST MGR SEP                                 
         BH    LST19               NO                                           
         L     RF,AMGR1                                                         
         CLC   INVLMGR(3),0(RF)    CHKS REG                                     
         BNE   LST30                                                            
*                                                                               
LST19    DS    0H                                                               
*                                                                               
         OC    AMGR2BRK,AMGR2BRK                                                
         BZ    LST20                                                            
         CLC   AMGR2BRK,AINVBRK    TEST MGR SEP                                 
         BH    LST20               NO                                           
         L     RF,AMGR2                                                         
         CLC   INVLMGR+3(3),0(RF)  CHKS DST                                     
         BNE   LST30                                                            
*                                                                               
LST20    DS    0H                                                               
         CLC   APERBRK,AINVBRK     TEST PERIOD SEP                              
         BH    LST22               NO                                           
         L     RE,APER                                                          
         ZIC   RF,0(RE)                                                         
         MH    RF,=H'8'                                                         
         LA    RF,PERLIST(RF)                                                   
         CLC   INVLPER,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST22    DS    0H                                                               
         OC    APERGBRK,APERGBRK                                                
         BZ    LST23                                                            
         CLC   APERGBRK,AINVBRK     TEST PERIOD GROUP SEPARATE                  
         BH    LST23               NO                                           
         L     RF,APERG                                                         
         CLC   INVLPERG,0(RF)                                                   
         BNE   LST30                                                            
*                                                                               
LST23    DS    0H                                                               
         OC    ACRDBBRK,ACRDBBRK                                                
         BZ    LST24                                                            
         CLC   ACRDBBRK,AINVBRK     TEST CREDIT/DEBITS SEPARATE                 
         BH    LST24               NO                                           
         L     RF,ACRDB                                                         
         CLC   INVLCRDB,0(RF)                                                   
         BNE   LST30                                                            
*                                                                               
*                                  BILL HAS PASSED ALL TESTS                    
LST24    DS    0H                                                               
         MVC   DUB,INVLGRS                                                      
         LM    RE,RF,DUB                                                        
         A     RE,X                                                             
         A     RF,X+4                                                           
         STM   RE,RF,X                                                          
         MVC   DUB,INVLCD       ALSO DO CD AND AC                               
         LM    RE,RF,DUB                                                        
         A     RE,X+8                                                           
         A     RF,X+12                                                          
         STM   RE,RF,X+8                                                        
*                                                                               
         CLC   INVLINV,INVLINV+INVTABRL                                         
         BNE   LST24C                                                           
         CLC   INVLCRDB,INVLCRDB+INVTABRL  CREDIT/DEBIT IND MUST MATCH          
         BE    LST30                                                            
*                                                                               
LST24C   MVC   W(2),INVLINV        SET YR AND MTH IN W FOR GETNUM               
         LA    R5,ALDESC+3                                                      
         CLI   DOLNUM,4                                                         
         BNL   LST25                                                            
         LA    R5,ALCOL1+3                                                      
         CLI   DOLNUM,3                                                         
         BE    LST25                                                            
         LA    R5,16(R5)                                                        
         CLI   DOLNUM,2                                                         
         BE    LST25                                                            
         LA    R5,16(R5)           MUST BE 1                                    
*                                                                               
LST25    DS    0H                                                               
         MVC   SVSVIMO,SVINVMO       SAVE 'REAL' INV MTH                        
*                                                                               
         GOTO1 AGETNUM,DMCB,(1,INVLINV+2),(R5)    FORMAT INV NO                 
*                                                                               
         MVC   SVINVMO,SVSVIMO       RESTORE 'REAL' INV MTH                     
**EDI**                                                                         
*        MUST GO BEFORE I PRINT LINE                                            
         GOTO1 ABILLEDI,DMCB,('EDMLST',0(R5)),X+RGRSD,X+RNETD,X+RCDD            
**EDI**                                                                         
*                                                                               
         BAS   RE,LSTFMT                                                        
         GOTO1 APRNT                                                            
*                                  TOTAL                                        
         L     RF,LSTGRS           GROSS                                        
         A     RF,X                                                             
         ST    RF,LSTGRS                                                        
         L     RF,LSTNET           NET                                          
         A     RF,X+4                                                           
         ST    RF,LSTNET                                                        
         L     RF,LSTCD            CD                                           
         A     RF,X+8                                                           
         ST    RF,LSTCD                                                         
         L     RF,LSTAC            CD                                           
         A     RF,X+12                                                          
         ST    RF,LSTAC                                                         
         L     RF,LSTNUM           COUNT                                        
         LA    RF,1(RF)                                                         
         ST    RF,LSTNUM                                                        
         XC    X,X                                                              
*                                                                               
LST30    DS    0H                                                               
         A     R4,INVPARS+12                                                    
         BCT   R6,LST11                                                         
*                                                                               
         OC    LSTNUM,LSTNUM                                                    
         BZ    LST32                                                            
         MVC   ALCOL4+3(10),DASHES     FOR LAST COLUMN                          
         CLI   DOLNUM,1                                                         
         BE    LST30C                                                           
         MVC   ALCOL3+4(10),DASHES                                              
         CLI   DOLNUM,2                                                         
         BE    LST30C                                                           
         MVC   ALCOL2+4(10),DASHES                                              
         CLI   DOLNUM,3                                                         
         BE    LST30C                                                           
         MVC   ALCOL1+4(10),DASHES    MUST BE 4 OR MORE                         
LST30C   GOTO1 APRNT                                                            
         CLC   BORDSW(3),=C'YNN'   BYPASS TOTAL OF BILLS                        
         BE    LST32               IF ORDERED ONLY FORMAT                       
         MVC   X(16),LSTGRS         TOTAL OF BILLS                              
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
LST32    DS    0H                                                               
         B     LSTINVX                                                          
         SPACE 3                                                                
LSTFMT   NTR1                                                                   
         SPACE 2                                                                
         MVC   HFORMAT,FORMAT                                                   
         MVC   PBLGROSS(12),X      GROSS,NET,CD                                 
         L     R0,X                                                             
         S     R0,X+8                                                           
         ST    R0,PBLGLCD          GROSS LESS CD                                
         L     R0,X+4                                                           
         S     R0,X+8                                                           
         ST    R0,PBLNLCD          NET LESS CD                                  
         MVC   PBLACOM,X+12        AC                                           
         LA    R6,ALCOL1                                                        
         CLI   DOLNUM,4                                                         
         BNL   LSTF5               4 OR 5                                       
         LA    R6,ALCOL2                                                        
         CLI   DOLNUM,3                                                         
         BE    LSTF5                                                            
         LA    R6,ALCOL3                                                        
         CLI   DOLNUM,2                                                         
         BE    LSTF5                                                            
         LA    R6,ALCOL4           MUST BE 1                                    
LSTF5    ZIC   R4,DOLNUM                                                        
         CH    R4,=H'4'                                                         
         BNH   LSTF8                                                            
         LA    R4,4                CAN ONLY DO FIRST 4 $ CATS                   
LSTF8    BAS   RE,LGETCAT                                                       
         L     R0,FULL                                                          
         BAS   RE,LSTEDT                                                        
         LA    R6,16(R6)           NEXT COL                                     
         BCT   R4,LSTF8                                                         
         B     LSTFMTX                                                          
*                                                                               
LSTFMTX  DS    0H                                                               
         B     LSTINVX                                                          
*                                                                               
*                                  PREVIOUSLY BILLED                            
PBLGROSS DS    F                   GROSS                                        
PBLNET   DS    F                   NET                                          
PBLCD    DS    F                   CD                                           
PBLGLCD  DS    F                   GROSS LESS CD                                
PBLNLCD  DS    F                   NET LESS CD                                  
PBLACOM  DS    F                   AGY COM                                      
*                                                                               
         SPACE 3                                                                
LSTEDT   DS    0H                                                               
         LA    R1,ALCOL4           SEE IF DOING LAST COLUMN                     
         CR    R6,R1                                                            
         BNE   LSTEDT5             CAN ONLY DO 15 CHARS.                        
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(15,0(R6)),2,COMMAS=YES,CR=YES                              
         CURED (R0),(15,0(R6)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,DUB                                                           
         CLI   13(R6),C' '                                                      
         BNER  RE                                                               
         MVC   13(2,R6),TOTSTAR                                                 
         BR    RE                                                               
LSTEDT5  DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,0(R6)),2,COMMAS=YES,CR=YES                              
         CURED (R0),(16,0(R6)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,DUB                                                           
         CLI   14(R6),C' '                                                      
         BNER  RE                                                               
         MVC   14(2,R6),TOTSTAR                                                 
         BR    RE                                                               
         SPACE 3                                                                
LGETCAT  NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         XC    FULL,FULL                                                        
         LA    R4,6                FOR BCT                                      
         LA    R5,HFORMAT                                                       
         LA    R6,PBLGROSS                                                      
         LA    R7,LCATNAM                                                       
LGETC3   CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    LGETC5                                                           
         LA    R5,1(R5)                                                         
         LA    R6,4(R6)                                                         
         LA    R7,16(R7)                                                        
         BCT   R4,LGETC3                                                        
         B     LGETCX                                                           
*                                                                               
LGETC5   MVC   FULL,0(R6)            SAVE  DOLLARS                              
         MVI   0(R5),C'N'          SO I WON'T REDO THIS CAT                     
         MVC   WORK(16),0(R7)                                                   
LGETCX   XIT1                                                                   
*                                                                               
LCATNAM  DC    CL16'           GROSS'                                           
LCATNET  DC    CL16'             NET'                                           
LCATCD   DC    CL16'      CASH DISC.'                                           
LCATGLCD DC    CL16'   GROSS LESS CD'                                           
LCATNLCD DC    CL16'     NET LESS CD'                                           
LCATAC   DC    CL16'    AGENCY COMM.'                                           
**                                                                              
         DS    0F                                                               
LSTTOTS  DS    0XL16                                                            
LSTGRS   DS    F                                                                
LSTNET   DS    F                                                                
LSTCD    DS    F                                                                
LSTAC    DS    F                                                                
LSTNUM   DS    F                                                                
**                                                                              
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
         TITLE 'FIND AND PRINT COMMENTS'                                        
PRTCMNT  CSECT                                                                  
         NMOD1 0,PRTCMNT                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         XC    SAVKEY,SAVKEY                                                    
*                                                                               
*                                                                               
         LA    R3,ESTFORM                                                       
         USING PBPROFD,R3                                                       
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0B                                                           
         LA    R3,PRDFORM       SHOW PRD COMMENTS IF NO EST COMMENTS            
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0B                                                           
         LA    R3,AAEFORM                                                       
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0B                                                           
         LA    R3,AAAFORM                                                       
PRTC0B   IF    ESTCTL,EQ,C'S',AND,PRDCTL,EQ,C'S',PRTC1                          
         LA    R3,AAEFORM                                                       
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0C                                                           
         LA    R3,AAAFORM  SHOW PRD AAA COMMENTS IF NO EST COMMENTS             
PRTC0C   IF    ESTCTL,EQ,C'S',AND,PRDCTL,NE,C'S',PRTC1                          
         LA    R3,PRDFORM                                                       
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0D                                                           
         LA    R3,AAAFORM                                                       
PRTC0D   IF    ESTCTL,NE,C'S',AND,PRDCTL,EQ,C'S',PRTC1                          
         LA    R3,AAAFORM                                                       
         IF    ESTCTL,NE,C'S',AND,PRDCTL,NE,C'S',PRTC1                          
*                                                                               
*                                                                               
PRTC1    LA    R4,BILCMNTS                                                      
         LA    R5,3                                                             
PRTC2    DS    0H                                                               
         LA    RF,X'80'                                                         
         CLI   CNMTCD,C'R'         REG                                          
         BE    PRTC3                                                            
         LA    RF,X'40'                                                         
         CLI   CNMTCD,C'C'         CD INV                                       
         BE    PRTC3                                                            
         LA    RF,X'20'            MUST BE ADJ INV                              
PRTC3    DS    0H                                                               
         EX    RF,PRTCTM                                                        
         BZ    PRTC13                                                           
*                                                                               
*        NOW CHECK VS. BILLING TYPE                                             
         LA    RF,X'01'                                                         
         CLI   TYPE,C'4'                                                        
         BE    PTC5                                                             
         LA    RF,X'02'                                                         
         CLI   TYPE,C'5'                                                        
         BE    PTC5                                                             
         LA    RF,X'04'                                                         
         CLI   TYPE,C'6'                                                        
         BE    PTC5                                                             
         LA    RF,X'08'                                                         
         CLI   TYPE,C'7'                                                        
         BE    PTC5                                                             
         DC    H'0'              INVALID BILLING TYPE                           
*                                                                               
PTC5     DS    0H                                                               
         EX    RF,PRTCTM                                                        
         BNZ   PRTC13           SUPPRESS FROM THIS BILLING TYPE                 
*                                                                               
*                                                                               
*                                                                               
*        CHECK RETAIL PROFILE                                                   
*                                                                               
         CLI   RETPROF,0                                                        
         BE    PRTC3C                                                           
         CLI   UPASS,1              SEE CORP BILL                               
         BE    PRTC3C                                                           
         CLI   UPASS,C'S'           CHK FOR CORP SUMMARY                        
         BE    PRTC3C                                                           
*                                   MUST BE DISTRIBUTOR BILL                    
*                                                                               
         CLI   RETPROF+10,C'X'      SEE IF SUPPRESSING ALL COMMENTS             
         BE    PRTC13                                                           
*                                                                               
         CH    R5,=H'3'             SEE IF DOING FRIST COMMENT                  
         BNE   PRTC3A                                                           
         CLI   RETPROF+10,C'1'      SEE IF SUPPRESSING 1ST COMMENT              
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'A'      SEE IF SUPPRESSING 1ST + 2ND                
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'B'      SEE IF SUPPRESSING 1ST + 3RD                
         BE    PRTC13                                                           
         B     PRTC3C                                                           
*                                                                               
PRTC3A   CH    R5,=H'2'             SEE IF DOING 2ND COMMENT                    
         BNE   PRTC3B                                                           
         CLI   RETPROF+10,C'2'      SEE IF SUPPRESSING 2ND COMMENT              
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'A'      SEE IF SUPPRESSING 1ST + 2ND                
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'C'      SEE IF SUPPRESSING 2ND + 3RD                
         BE    PRTC13                                                           
         B     PRTC3C                                                           
*                                                                               
PRTC3B   CH    R5,=H'1'             SEE IF DOING 3RD COMMENT                    
         BNE   PRTC3C                                                           
         CLI   RETPROF+10,C'3'      SEE IF SUPPRESSING 3RD COMMENT              
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'B'      SEE IF SUPPRESSING 1ST + 3RD                
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'C'      SEE IF SUPPRESSING 2ND + 3RD                
         BE    PRTC13                                                           
*                                                                               
PRTC3C   MVC   WORK,KEY                                                         
         XC    KEY,KEY                                                          
         MVC   KEY(3),RCSVAGY                                                   
         OC    AMED,AMED    FOR MULTI-MEDIA REQ GET MEDIA FROM AMED             
         BZ    PRTC3D                                                           
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
*                                                                               
PRTC3D   MVI   KEY+3,X'40'                                                      
         MVC   KEY+4(6),1(R4)                                                   
         L     RF,ACOMREC                                                       
         CLC   KEY(25),0(RF)                                                    
         BE    PRTC4               ALREADY HAVE                                 
         OC    SAVKEY,SAVKEY                                                    
         BNZ   *+10                                                             
         MVC   SAVKEY,WORK                                                      
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BNE   PRTC13                                                           
*                                                                               
         MVC   AREC,ACOMREC                                                     
         GOTO1 GETPRT                                                           
*                                                                               
PRTC4    DS    0H                                                               
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMCOM',0)      EDI CALL                         
*                                                                               
         MVI   SPACING,2                                                        
         GOTO1 APRNT                                                            
*                                  COUNT LINES NEEDED                           
         SR    RF,RF                                                            
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
         SR    R0,R0                                                            
PRTC6    DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    PRTC9                                                            
         CLI   0(R2),X'40'                                                      
         BNE   PRTC8                                                            
         LA    R0,1                                                             
         CLI   2(R2),C'+'                                                       
         BNE   PRTC7                                                            
         CLI   3(R2),C'1'                                                       
         BL    PRTC7                                                            
         MVC   BYTE,3(R2)                                                       
         NI    BYTE,X'0F'                                                       
         IC    R0,BYTE                                                          
PRTC7    DS    0H                                                               
         AR    RF,R0                                                            
PRTC8    DS    0H                                                               
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PRTC6                                                            
*                                                                               
PRTC9    DS    0H                                                               
         LA    RF,1(RF)                                                         
         STC   RF,ALLOWLIN         NUMBER OF LINES NEEDED                       
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
PRTC10   DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    PRTC13                                                           
         CLI   0(R2),X'40'                                                      
         BNE   PRTC12                                                           
         LA    R6,2                                                             
         CLI   2(R2),C'+'                                                       
         BNE   PRTC11                                                           
         CLI   3(R2),C'1'                                                       
         BL    PRTC11                                                           
         MVC   SPACING,3(R2)                                                    
         NI    SPACING,X'0F'                                                    
         GOTO1 APRNT                                                            
*                                                                               
         LA    R6,4                                                             
PRTC11   DS    0H                                                               
         IC    RF,1(R2)                                                         
         SR    RF,R6                                                            
         AR    R6,R2                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P1+8(0),0(R6)                                                    
*                                                                               
         GOTO1 APRNT                                                            
*                                                                               
PRTC12   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PRTC10                                                           
*                                                                               
PRTC13   DS    0H                                                               
         LA    R4,7(R4)                                                         
         BCT   5,PRTC2                                                          
*                                                                               
*                                                                               
         OC    SAVKEY,SAVKEY                                                    
         BZ    PRTC20                                                           
         MVC   KEY,SAVKEY                                                       
         GOTO1 HIGH                                                             
*                                                                               
PRTC20   DS    0H                                                               
PRTCX    DS    0H                                                               
         MVI   PUMODE,C'E'       CHECK FOR USER FIELDS TO BE PRINTED            
*                                AT END OF INVOICE                              
         GOTO1 APRTUSER                                                         
         XIT1                                                                   
*                                                                               
SAVKEY   DS    CL32                                                             
*                                                                               
PRTCTM   TM    0(R4),X'00'     EXECUTED                                         
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
PRTUSER  CSECT                                                                  
         NMOD1 0,PRTUSER                                                        
         LA    RC,SPACEND                                                       
         MVI   HAVUSER,C'N'      GETS SET TO 'Y' IF I PRINT ONE                 
*                                                                               
         MVI   BYTE,0                                                           
         CLI   PRDCTL,C'S'       SEE IF PRODUCTS SEPARATE                       
         BNE   PRTAAAU           NO THEN TRY FOR "AAA" USER FIELDS              
*                                                                               
         GOTO1 AGETUSER,DMCB,(C'P',ADCLT),(C'P',ADPRD),(C':',P1+8),0            
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTPU5                                                           
*                                                                               
         TM    DMCB+4,X'04'       SEE IF IN HEADLINES                           
         BO    PRTPU5                                                           
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   PU4D                                                             
         TM    DMCB+4,X'02'                                                     
         BZ    PRTPU5                                                           
         B     PU4F                                                             
*                                                                               
PU4D     DS    0H                  NOT DOING FRONT NOW                          
         TM    DMCB+4,X'02'                                                     
         BO    PRTPU5                                                           
*                                                                               
PU4F     DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1     SAVE P1                                            
         MVC   P1,SPACES                                                        
         GOTO1 APRNT          SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
         GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P1')   EDI CALL                       
**EDI**                                                                         
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PRTPU5   DS    0H                                                               
         MVC   P1,SPACES                                                        
         GOTO1 AGETUSER,DMCB,(C'P',ADCLT),(C'P',ADPRD),0,(C':',P1+8)            
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTE                                                             
*                                                                               
         TM    DMCB+6,X'04'       SEE IF IN HEADLINES                           
         BO    PRTE                                                             
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   PU5D                                                             
         TM    DMCB+6,X'02'                                                     
         BZ    PRTE                (BUG WHEN TO PRTPU8)                         
         B     PU5F                                                             
*                                                                               
PU5D     DS    0H                  NOT DOING FRONT NOW                          
         TM    DMCB+6,X'02'                                                     
         BO    PRTE                                                             
*                                                                               
PU5F     DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1      SAVE P1 IN W HERE FOR EDI CALL                    
         CLI   BYTE,1                                                           
         BE    PRTPU8                                                           
         MVC   P1,SPACES                                                        
         GOTO1 APRNT          SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
PRTPU8   GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P2')   EDI CALL                       
**EDI**                                                                         
*                                                                               
PRTE     DS    0H                                                               
         MVI   BYTE,0                                                           
         MVC   P1,SPACES                                                        
         CLI   ESTCTL,C'S'       SEE IF ESTIMATES SEPARATE                      
         BNE   PRTEU10                                                          
         GOTO1 AGETUSER,DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',P1+8),0            
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTEU5                                                           
*                                                                               
         TM    DMCB+4,X'04'       SEE IF IN HEADLINES                           
         BO    PRTEU5                                                           
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   PUE4D                                                            
         TM    DMCB+4,X'02'                                                     
         BZ    PRTEU5                                                           
         B     PUE4F                                                            
*                                                                               
PUE4D    DS    0H                  NOT DOING FRONT NOW                          
         TM    DMCB+4,X'02'                                                     
         BO    PRTEU5                                                           
*                                                                               
PUE4F    DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1      SAVE P1                                           
         MVC   P1,SPACES                                                        
         MVI   P1,0           BE SURE IT PRINTS                                 
         GOTO1 APRNT          SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
         GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E1')    EDI CALL                      
**EDI**                                                                         
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PRTEU5   DS    0H                                                               
         MVC   P1,SPACES                                                        
         GOTO1 AGETUSER,DMCB,(C'P',ADCLT),(C'E',ADEST),0,(C':',P1+8)            
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTEU10                                                          
*                                                                               
         TM    DMCB+6,X'04'       SEE IF IN HEADLINES                           
         BO    PRTEU10                                                          
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   PUE5D                                                            
         TM    DMCB+6,X'02'                                                     
         BZ    PRTEU10                                                          
         B     PUE5F                                                            
*                                                                               
PUE5D    DS    0H                  NOT DOING FRONT NOW                          
         TM    DMCB+6,X'02'                                                     
         BO    PRTEU10                                                          
*                                                                               
PUE5F    DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1      SAVE P1 IN W HERE (FOR EDI CALL)                  
         CLI   BYTE,1         SEE IF I PRINTED E1                               
         BE    PRTEU8         IF SO - NO NEED TO SKIP                           
         MVC   P1,SPACES                                                        
         MVI   P1,0           BE SURE IT PRINTS                                 
         GOTO1 APRNT          SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
PRTEU8   GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E2')   EDI CALL                       
**EDI**                                                                         
*                                                                               
PRTEU10  DS    0H                                                               
         MVC   P1,SPACES         IN CASE SOMETHING IS LEFT THERE                
         CLI   HAVUSER,C'Y'      SEE IF I PRINTED ONE                           
         BNE   PRTUX                                                            
         CLI   PUMODE,C'F'       ONLY NEEDED FOR FRONT PRINTING                 
         BNE   PRTUX                                                            
         MVI   P1,0              TO BE SURE IT PRINTS                           
         GOTO1 APRNT             SKIP A LINE AFTER LAST                         
         B     PRTUX                                                            
         EJECT                                                                  
*                    HERE IF PRODUCT NOT "S"                                    
*                    LOOK FOR "AAA" USER FIELDS                                 
*                                                                               
PRTAAAU  DS    0H                                                               
         MVC   USAVKEY,KEY                                                      
         XC    KEY,KEY                                                          
         L     RF,ADCLT                                                         
         MVC   KEY(7),0(RF)                                                     
         MVI   KEY+3,X'06'                                                      
         MVC   KEY+7(3),=C'AAA'                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BNE   PRTAUX          EXIT IF PRD AAA NOT THERE                        
         MVC   AREC,ACOMREC                                                     
         GOTO1 GETPRT                                                           
         GOTO1 AGETUSER,DMCB,(C'P',ADCLT),(C'P',AREC),(C':',P1+8),0             
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTAPU5                                                          
*                                                                               
         CLI   PUMODE,C'F'   FRONT OF BILL                                      
         BNE   PUA14D                                                           
         TM    DMCB+4,X'02'                                                     
         BZ    PUA15                                                            
         B     PUA14F                                                           
*                                                                               
PUA14D   DS    0H          NOT DOING FRONT NOW                                  
         TM    DMCB+4,X'02'                                                     
         BO    PUA15                                                            
*                                                                               
PUA14F   DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1     SAVE P1                                            
         MVC   P1,SPACES                                                        
         GOTO1 APRNT          SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
         GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P1')   EDI CALL                       
**EDI**                                                                         
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PUA15    DS    0H                                                               
PRTAPU5  DS    0H                                                               
         MVC   P1,SPACES                                                        
         GOTO1 AGETUSER,DMCB,(C'P',ADCLT),(C'P',AREC),0,(C':',P1+8)             
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTAE                                                            
*                                                                               
         CLI   PUMODE,C'F'   FRONT OF BILL                                      
         BNE   PUA16D                                                           
         TM    DMCB+4,X'02'                                                     
         BZ    PUA17                                                            
         B     PUA16F                                                           
*                                                                               
PUA16D   DS    0H          NOT DOING FRONT NOW                                  
         TM    DMCB+4,X'02'                                                     
         BO    PUA17                                                            
*                                                                               
PUA16F   DS    0H                                                               
         CLI   BYTE,1                                                           
         BE    PRTAPU8                                                          
         MVC   W(132),P1      SAVE P1                                           
         MVC   P1,SPACES                                                        
         GOTO1 APRNT          SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
*                                                                               
PRTAPU8  GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P2')   EDI CALL                       
**EDI**                                                                         
*                                                                               
PUA17    DS    0H                                                               
PRTAE    DS    0H                                                               
         MVI   BYTE,0                                                           
         MVC   P1,SPACES                                                        
         CLI   ESTCTL,C'S'      SEE IF EST SEPARATE                             
         BNE   PRTAUX                                                           
*                                                                               
         XC    KEY,KEY                                                          
         L     RF,ADEST         I SHOULD HAVE AN ESTIMATE                       
         MVC   KEY(12),0(RF)    AGY/MED/CLT/PRD/EST                             
         MVI   KEY+3,X'07'                                                      
         MVC   KEY+7(3),=C'AAA'                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(12),KEYSAVE                                                  
         BNE   PRTAUX          EXIT IF PRD AAA ESTIMATE NOT THERE               
         MVC   AREC,ACOMREC                                                     
         GOTO1 GETPRT                                                           
*                                                                               
         GOTO1 AGETUSER,DMCB,(C'P',ADCLT),(C'E',AREC),(C':',P1+8),0             
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTAEU5                                                          
*                                                                               
         CLI   PUMODE,C'F'   FRONT OF BILL                                      
         BNE   PUAE14D                                                          
         TM    DMCB+4,X'02'                                                     
         BZ    PUAE15                                                           
         B     PUAE14F                                                          
*                                                                               
PUAE14D  DS    0H          NOT DOING FRONT NOW                                  
         TM    DMCB+4,X'02'                                                     
         BO    PUAE15                                                           
*                                                                               
PUAE14F  DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1      SAVE P1                                           
         MVC   P1,SPACES                                                        
         GOTO1 APRNT          SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
         GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E1')    EDI CALL                      
**EDI**                                                                         
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PUAE15   DS    0H                                                               
PRTAEU5  DS    0H                                                               
         MVC   P1,SPACES                                                        
         GOTO1 AGETUSER,DMCB,(C'P',ADCLT),(C'E',AREC),0,(C':',P1+8)             
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTAEU10                                                         
*                                                                               
         CLI   PUMODE,C'F'   FRONT OF BILL                                      
         BNE   PUAE16D                                                          
         TM    DMCB+4,X'02'                                                     
         BZ    PUAE17                                                           
         B     PUAE16F                                                          
*                                                                               
PUAE16D  DS    0H          NOT DOING FRONT NOW                                  
         TM    DMCB+4,X'02'                                                     
         BO    PUAE17                                                           
*                                                                               
PUAE16F  DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         CLI   BYTE,1                                                           
         BE    PRTAEU8                                                          
         MVC   W(132),P1      SAVE P1                                           
         MVC   P1,SPACES                                                        
         GOTO1 APRNT          SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
PRTAEU8  GOTO1 APRNT                                                            
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E2')   EDI CALL                       
**EDI**                                                                         
*                                                                               
PUAE17   DS    0H                                                               
PRTAEU10 DS    0H                                                               
         MVC   P1,SPACES         IN CASE SOMETHING IS LEFT THERE                
         CLI   HAVUSER,C'Y'                                                     
         BNE   PRTUX                                                            
         CLI   PUMODE,C'F'    ONLY NEEDED FOR FRONT PRINTING                    
         BNE   PRTUX                                                            
         GOTO1 APRNT            SKIP AFTER LAST                                 
         B     PRTUX                                                            
         EJECT                                                                  
PRTAUX   MVC   KEY,USAVKEY                                                      
         GOTO1 HIGH                                                             
         B     PRTUX                                                            
*                                                                               
*                                                                               
PRTUX    DS    0H            NOW CHECK FOR UCOMM RECORDS                        
         CLI   PUMODE,C'E'   MUST BE END OF INVOICE                             
         BNE   PRTUXX        (FOR NOW)                                          
         MVC   USAVKEY,KEY   SAVE MY KEY                                        
         LA    R6,UCOMBLK     SET-UP UCOM CONTROL BLOCK                         
         XC    UCOMBLK(L'UCOMBLK),UCOMBLK                                       
         USING DDUCOMD,R6                                                       
*                                                                               
         MVC   UCACOMF,VCOMFACS     COMFACS                                     
         MVI   UCSYS,C'P'        SYSTEM TO PRINT                                
         MVC   UCAGY,QAGENCY                                                    
         MVC   UCMED,QMEDIA                                                     
         OC    AMED,AMED                                                        
         BZ    PRTUX5                                                           
         L     RF,AMED           MUST CHECK AMED FOR MEDIA                      
         MVC   UCMED,0(RF)                                                      
*                                                                               
PRTUX5   DS    0H                                                               
         L     RF,ADCLT                                                         
         MVC   UCCLT,4(RF)                                                      
         L     RF,APRD                                                          
         MVC   UCPRD,0(RF)          3 CHAR PRD CODE                             
*                                                                               
         CLI   PRDCTL,C'S'                                                      
         BE    *+10                                                             
         MVC   UCPRD,=C'AAA'     IF PRODUCTS NOT SEPARATE                       
*                                DO UCOMM FOR PRD AAA                           
         OI    UCOPT,UCOPRD      RETURN PRODUCT UCOMMS                          
         CLI   ESTCTL,C'S'       EST ON SEPARATE INVOICES                       
         BNE   *+18                                                             
         OI    UCOPT,UCOEST      RETURN ESTIMATE UCOMMS                         
         L     RF,AEST                                                          
         MVC   UCEST,0(RF)                                                      
*                                                                               
         ICM   RF,15,APGR1         POINTER TO DIVISION DATA                     
         BZ    PRTUX6              IF 0 --> NO DATA, DON'T LOOK FURTHER         
         ICM   R1,15,AMGR1         POINTER TO REGION DATA                       
         BZ    PRTUX6              IF 0 --> NO DATA, DON'T LOOK FURTHER         
         MVC   UCDIV,0(RF)                                                      
         CLI   MGR1CTL,C'S'        REGIONS ON SEP INVOICES                      
         BNE   *+14                                                             
         MVC   UCREG,0(R1)         RETURN REGION UCOMS                          
         OI    UCOPT,UCOREG                                                     
         ICM   R1,15,AMGR2         POINTER TO DISTRICT DATA                     
         BZ    PRTUX6              IF 0 --> NO DATA, DON'T LOOK FURTHER         
         MVC   UCDST,0(R1)         RETURN DISTRICT UCOMS                        
         OI    UCOPT,UCODST                                                     
*                                                                               
PRTUX6   DS    0H                                                               
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOPRD+UCDNOEST+UCDNOREG+UCDNODST                       
         BO    PRTUXX       NO PRD NOR EST NOR REGION NOR DISTRICT DATA         
*                                                                               
         MVC   P1,SPACES                                                        
         MVI   P1,0           TO INSURE PRINTING                                
         LA    R2,P2+8        START AT SECOND PRINT LINE                        
         TM    UCDATA,UCDNOPRD                                                  
         BO    PRTUX10                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCPTTLS     PRD TITLES                                        
         MVC   UCTTLS,0(R4)        SAVE INFO IN MY STORAGE                      
         LA    R4,UCTTLS           AS OPPOSED TO RD CHANE                       
         L     R7,UCPDATA     PRD DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCPLENS      DATA FIELD LENGTHS                               
*                                                                               
         LA    R5,4             FOR BCT                                         
         LHI   RF,1             FOR EDI,LINE COUNTER                            
PRTUX6B  DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX6X                                                          
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX6C  CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX6D                                                          
         BCT   RE,PRTUX6C                                                       
*                                                                               
PRTUX6D  MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   W(132),SPACES                                                    
         MVC   W+8(132-8),0(R2)    MOVE VALUE IN W FOR EDI CALL                 
         MVI   HALF,C'P'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,DUB              SAVE R1                                      
         ST    RF,DUB+4            SAVE RF                                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR PRODUCT            
**EDI**                                                                         
         L     R1,DUB              RESTORE R1                                   
         L     RF,DUB+4            RESTORE RF                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX6X  LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(R4)         NEXT TITLE                                     
         LA    R7,32(R7)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX6B                                                       
*                                                                               
*                                                                               
PRTUX10  DS    0H                NOW DO ESTIMATE FIELDS                         
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOEST+UCDNOREG+UCDNODST                                
         BO    PRTUXX       NO EST NOR REGION NOR DISTRICT DATA                 
         TM    UCDATA,UCDNOEST                                                  
         BO    PRTUX20                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCETTLS     EST TITLES                                        
         MVC   UCTTLS,0(R4)        SAVE INFO IN MY STORAGE                      
         LA    R4,UCTTLS           AS OPPOSED TO RD CHANE                       
         L     R7,UCEDATA     EST DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCELENS     DATA FIELD LENGTHS                                
******** L     R4,UCETTLS     EST TITLES                                        
******** L     R7,UCEDATA     EST DATA                                          
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LA    R5,4             FOR BCT                                         
         LHI   RF,1             FOR EDI, LINE COUNTER                           
PRTUX10B DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX10X                                                         
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX10C CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX10D                                                         
         BCT   RE,PRTUX10C                                                      
*                                                                               
PRTUX10D MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   W(132),SPACES                                                    
         MVC   W+8(132-8),0(R2)    MOVE VALUE IN W FOR EDI CALL                 
         MVI   HALF,C'E'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,DUB              SAVE R1                                      
         ST    RF,DUB+4            SAVE RF                                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR ESTIMATE           
**EDI**                                                                         
         L     R1,DUB              RESTORE R1                                   
         L     RF,DUB+4            RESTORE RF                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX10X LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(R4)         NEXT TITLE                                     
         LA    R7,32(R7)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX10B                                                      
*                                                                               
PRTUX20  DS    0H                NOW DO REGION FIELDS                           
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOREG+UCDNODST                                         
         BO    PRTUXX       NO REGION NOR DISTRICT DATA                         
         TM    UCDATA,UCDNOREG                                                  
         BO    PRTUX30                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCRTTLS     REG TITLES                                        
         MVC   UCTTLS,0(R4)        SAVE INFO IN MY STORAGE                      
         LA    R4,UCTTLS           AS OPPOSED TO RD CHANE                       
         L     R7,UCRDATA     REG DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCRLENS        DATA FIELD LENGTHS                             
******** L     R4,UCRTTLS        REGION TITLES                                  
******** L     R7,UCRDATA        REGION DATA                                    
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LA    R5,4             FOR BCT                                         
         AHI   RF,1             FOR EDI, LINE COUNTER                           
PRTUX20B DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX20X                                                         
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX20C CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX20D                                                         
         BCT   RE,PRTUX20C                                                      
*                                                                               
PRTUX20D MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   W(132),SPACES                                                    
         MVC   W+8(132-8),0(R2)    MOVE VALUE IN W FOR EDI CALL                 
         MVI   HALF,C'R'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,DUB              SAVE R1                                      
         ST    RF,DUB+4            SAVE RF                                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR REGION             
**EDI**                                                                         
         L     R1,DUB              RESTORE R1                                   
         L     RF,DUB+4            RESTORE RF                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX20X LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(RE)         NEXT TITLE                                     
         LA    R7,32(RF)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX20B                                                      
*                                                                               
PRTUX30  DS    0H                NOW DO DISTRICT FIELDS                         
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNODST                                                  
         BO    PRTUX40                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCDTTLS     DST TITLES                                        
         MVC   UCTTLS,0(R4)        SAVE INFO IN MY STORAGE                      
         LA    R4,UCTTLS           AS OPPOSED TO RD CHANE                       
         L     R7,UCDDATA     DST DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCDLENS        DATA FIELD LENGTHS                             
******** L     R4,UCDTTLS        DISTRICT TITLES                                
******** L     R7,UCDDATA        DISTRICT DATA                                  
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LA    R5,4             FOR BCT                                         
         LHI   RF,1                                                             
PRTUX30B DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX30X                                                         
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX30C CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX30D                                                         
         BCT   RE,PRTUX30C                                                      
*                                                                               
PRTUX30D MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   W(132),SPACES                                                    
         MVC   W+8(132-8),0(R2)    MOVE VALUE IN W FOR EDI CALL                 
         MVI   HALF,C'D'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,DUB              SAVE R1                                      
         ST    RF,DUB+4            SAVE RF                                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR DISTRICT           
**EDI**                                                                         
         L     R1,DUB              RESTORE R1                                   
         L     RF,DUB+4            RESTORE RF                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX30X LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(RE)         NEXT TITLE                                     
         LA    R7,32(RF)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX30B                                                      
*                                                                               
PRTUX40  DS    0H                                                               
         GOTO1 APRNT            FINALLY PRINT P LINES                           
         MVC   KEY,USAVKEY  SINCE SEQ READING MAY BE AFFECTED                   
         GOTO1 HIGH                                                             
*                                                                               
PRTUXX   XIT1                                                                   
**                                                                              
         DROP  R6                                                               
**                                                                              
*                                                                               
USAVKEY  DS    CL32                                                             
*                                                                               
HAVUSER  DS    CL1                                                              
*                                                                               
         LTORG                                                                  
*                                                                               
UCOMBLK  DS    CL(UCOMDLNQ)     DDUCOM CONTROL BLOCK                            
UCTTLS   DS    CL80             LEN=20*4                                        
UCOMDATA DS    CL128            LEN=32*4                                        
UCALL    EQU   *-UCTTLS                                                         
*                                                                               
UCOMD    DSECT                                                                  
       ++INCLUDE DDUCOMD                                                        
         EJECT                                                                  
*                                                                               
PPGBFRDD DSECT                                                                  
       ++INCLUDE PPGETBFRD                                                      
         EJECT                                                                  
*                                                                               
       ++INCLUDE PAORREC                                                        
         EJECT                                                                  
         PRINT OFF                                                              
*                                                                               
       ++INCLUDE PPBDICS                                                        
       ++INCLUDE DDBUFFALOD                                                     
       ++INCLUDE PPREPB1WRK                                                     
*                                                                               
         PRINT ON                                                               
PRTCMNT  CSECT                                                                  
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'067PPREPB12D 05/01/02'                                      
         END                                                                    
