*          DATA SET DDACCESSU  AT LEVEL 029 AS OF 08/11/03                      
*CATALP ACCESS                                                                  
DDACCESS TITLE ' - SECURITY ACCESS INTERFACE'                                   
ACCESS   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 WORKX-WORKD,**ACCS**,CLEAR=YES,RA,R9,RR=RE                       
         USING WORKD,RC            RC=A(W/S)                                    
         ST    RE,RELO                                                          
         LR    R8,R1                                                            
         USING ACCPARMD,R8         R8=A(PARAMETER LIST)                         
         ICM   R7,15,ACCPDATA                                                   
         USING ACCDATAD,R7         R7=A(ACCESS DATA AREA)                       
*                                                                               
         PROT  OFF                 DISABLE CALLER'S STORAGE PROTECTION          
*                                                                               
         BAS   RE,INITIAL          GENERAL INITIALISATION                       
*                                                                               
         MVC   ACTN,ACCPACTN       SET ACTION                                   
*                                                                               
* ??     TM    ACCDINDS,ACCDIINI   TEST INITIALIZED                             
*        BO    *+6                                                              
*        DC    H'0'                                                             
*                                                                               
         CLI   ACTN,0                                                           
         BH    *+6                                                              
         DC    H'0'                ACTION IS UNDEFINED                          
         CLI   ACTN,ACCPUNDF                                                    
         BL    *+6                                                              
         DC    H'0'                ACTION IS UNDEFINED                          
*                                                                               
         XR    RF,RF                                                            
         IC    RF,ACTN                                                          
         SLL   RF,2                                                             
         B     *(RF)                                                            
         B     IPCHACT             01 - ACCPIP                                  
         B     UAUTACT             01 - ACCPUSER                                
         B     PAUTACT             03 - ACCPAUTH                                
         B     PACCACT             03 - ACCPPACC                                
         SPACE 3                                                                
*                                                                               
ACCRETN  MVC   ACCPRC,RETCODE                                                   
         MVC   ACCPRS,REASCODE+1                                                
         B     ACCRETX                                                          
*                                                                               
ACCRETY  MVI   ACCPRC,ACRCOK       VALID                                        
*                                                                               
ACCRETX  EQU   *                                                                
         PROT  ON                  RESTORE CALLER'S STORAGE PROTECTION          
         CLI   ACCPRC,ACRCOK       SET CC FOR CALLER (EQUAL=OK)                 
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GENERAL INITIALISATION                                              *         
***********************************************************************         
         SPACE 1                                                                
INITIAL  NTR1                                                                   
*                                                                               
         MVI   DDSUSER,C'N'                                                     
         XC    RETCODE,RETCODE                                                  
         XC    REASCODE,REASCODE                                                
         LA    R0,WORKD                                                         
         AH    R0,=Y(IOAREA-WORKD)                                              
         ST    R0,AIOAREA                                                       
         LA    R0,WORKD                                                         
         AH    R0,=Y(UTLSAVE-WORKD)                                             
         ST    R0,AUTLSAVE                                                      
         LA    R0,WORKD                                                         
         AH    R0,=Y(TCBSAVE-WORKD)                                             
         ST    R0,ATCBSAVE                                                      
         AH    R0,=Y(SECBLOC-WORKD)                                             
         ST    R0,ASECBLOC                                                      
*                                                                               
         ICM   RF,15,ACCPSYS                                                    
         BZ    INIT010                                                          
         ST    RF,APARMS                                                        
         USING SRPARMD,RF                                                       
         MVC   ASYSFAC,SRQASYSF                                                 
         MVC   ATIA,SRQATIA                                                     
         MVC   AUTL,SRQAUTL                                                     
         MVC   ACOMFACS,SRQACOMF                                                
         MVC   ASELIST,SRQASEL                                                  
         MVC   ATWA,SRQATWA                                                     
         MVC   AMAP,SRQAMAP                                                     
         MVC   ATIOB,SRQATIOB                                                   
         L     RF,ASYSFAC                                                       
         L     RE,VDMOD000-SYSFACD(RF)                                          
         ST    RE,ADMOD000                                                      
         L     RE,VFINDSYS-SYSFACD(RF)                                          
         ST    RE,AFINDSYS                                                      
         L     RE,VSSB-SYSFACD(RF)                                              
         ST    RE,ASSB                                                          
         L     RE,SSBTKADR-SSBD(RE)                                             
         ST    RE,ATCBTASK                                                      
         DROP  RF                                                               
         MVC   ASAVE,ACCPSAVE                                                   
         MVC   SAVESCRN,ACCPSCRN                                                
         MVC   SAVELEN,ACCPSLEN                                                 
         L     RF,ASYSFAC                                                       
         L     RE,VSYSFAC0-SYSFACD(RF)                                          
         ST    RE,ACOMFACS                                                      
         USING COMFACSD,RE                                                      
         MVC   ADATAMGR,CDATAMGR                                                
         MVC   ADATCON,CDATCON                                                  
         MVC   ACALLOV,CCALLOV                                                  
         MVC   ASECRET,CSECRET                                                  
         MVC   AHEXOUT,CHEXOUT                                                  
         MVC   AHEXIN,CHEXIN                                                    
         DROP  RE                                                               
         B     INITX                                                            
         B     INIT030                                                          
*                                                                               
INIT010  EQU   *                                                                
         CLI   OFFLMODE,C' '      TEST OFFLINE PROCESSING INITIALISED           
         BNE   INIT020                                                          
         ICM   RF,15,=V(CALLOV)                                                 
         ST    RF,ACALLOV                                                       
         BAS   RE,INITMAST                                                      
         BAS   RE,INITSFAC                                                      
*                                                                               
INIT020  EQU   *                                                                
         L     RF,CSYSFAC                                                       
         ST    RF,ASYSFAC                                                       
*                                                                               
INIT030  EQU   *                                                                
         L     RF,ASYSFAC                                                       
         L     RE,VSYSFAC0-SYSFACD(RF)                                          
         ST    RE,ACOMFACS                                                      
         USING COMFACSD,RE                                                      
         MVC   ADATAMGR,CDATAMGR                                                
         MVC   ADATCON,CDATCON                                                  
         MVC   ACALLOV,CCALLOV                                                  
         MVC   ASECRET,CSECRET                                                  
         MVC   AHEXOUT,CHEXOUT                                                  
         MVC   AHEXIN,CHEXIN                                                    
         DROP  RE                                                               
         L     RE,VSSB-SYSFACD(RF)                                              
         ST    RE,ASSB                                                          
         L     RE,VTCB-SYSFACD(RF)                                              
         ST    RE,ATCB                                                          
         L     RE,VUTL-SYSFACD(RF)                                              
         ST    RE,AUTLTAB                                                       
         MVC   ALCM,VLCM-SYSFACD(RF)                                            
         L     RE,ASSB                                                          
         L     RE,SSBTKADR-SSBD(RE)                                             
         ST    RE,ATCBTASK                                                      
         L     RF,TCBUTL-TCBD(RE)                                               
         ST    RF,AUTL                                                          
         L     RF,TCBTWA-TCBD(RE)                                               
         ST    RF,ATWA                                                          
         L     RF,TCBTIA-TCBD(RE)                                               
         ST    RF,ATIA                                                          
*                                                                               
         GOTO1 ADATCON,PARM,(5,0),(0,WORK)                                      
         PACK  DUB(2),WORK+4(2)                                                 
         ICM   RE,3,DUB                                                         
         SRL   RE,4                                                             
         STC   RE,DAYTODAY                                                      
         GOTOR (RF),(R1),(0,WORK),(10,DATE)                                     
         LA    RF,SRPARMS                                                       
         ST    RF,APARMS                                                        
         USING SRPARMD,RF                                                       
         MVC   SRQASYSF,ASYSFAC                                                 
         MVC   SRQATIA,ATIA                                                     
         MVC   SRQAUTL,AUTL                                                     
         MVC   SRQACOMF,ACOMFACS                                                
         MVC   SRQASEL,ASELIST                                                  
         MVC   SRQATWA,ATWA                                                     
         MVC   SRQAMAP,AMAP                                                     
         MVC   SRQATIOB,ATIOB                                                   
         DROP  RF                                                               
*                                                                               
INITX    EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* INITIALISE DB2EXE MASTC REFERENCE - FAKE UP IF TSO BATCH            *         
***********************************************************************         
         SPACE 1                                                                
INITMAST NTR1                                                                   
         ICM   RF,15,=V(MASTC)                                                  
         BZ    IMAS010                                                          
         STCM  RF,15,AMASTC                                                     
         MVI   OFFLMODE,OMMASTQ                                                 
         B     IMASX                                                            
*                                                                               
IMAS010  EQU   *                                                                
         MVI   OFFLMODE,OMTSOBQ                                                 
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         STCM  R1,15,AMASTC                                                     
*                                                                               
         LR    RE,R1                                                            
         LR    R1,R0                                                            
         BCTR  R1,0                                                             
         LA    R0,*                                                             
         L     RF,=F'0'                                                         
         MVCL  RE,R0                                                            
*                                                                               
         ICM   R1,15,AMASTC                                                     
         USING MASTD,R1                                                         
         ICM   RF,15,=V(DATAMGR)                                                
         STCM  RF,15,MCVDMGR                                                    
         ICM   RF,15,=V(DATCON)                                                 
         STCM  RF,15,MCVDTCON                                                   
         ICM   RF,15,=V(DICTATE)                                                
         STCM  RF,15,MCVDICT                                                    
         ICM   RF,15,=V(GETTXT)                                                 
         STCM  RF,15,MCVGETXT                                                   
         ICM   RF,15,=V(HEXIN)                                                  
         STCM  RF,15,MCVHEXIN                                                   
         ICM   RF,15,=V(HEXOUT)                                                 
         STCM  RF,15,MCVHEXOU                                                   
         ICM   RF,15,=V(PRINT)                                                  
         STCM  RF,15,MCVPRINT                                                   
         ICM   RF,15,=V(LOADER)                                                 
         STCM  RF,15,MCVLOADR                                                   
         DROP  R1                                                               
*                                                                               
IMASX    EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* INITIALISE OFFLINE SYS FACS                                         *         
***********************************************************************         
         SPACE 1                                                                
INITSFAC NTR1                                                                   
*                                                                               
         ICM   R0,15,=AL4(TWAMAX)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATIA                                                          
*                                                                               
         ICM   R0,15,=AL4(TWAMAX)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATWA                                                          
*                                                                               
         ICM   R0,15,=AL4(TWAMAX)                                               
         STCM  R0,7,SAVELEN                                                     
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ASAVE                                                         
*                                                                               
         ICM   R0,15,=AL4(TUTLXALN)                                             
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,AUTL                                                          
*                                                                               
         ICM   R0,15,=AL4(200000)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATCBTASK                                                      
*                                                                               
         ICM   R0,15,=AL4(200000)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,AUTLTAB                                                       
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATCB                                                          
*                                                                               
         ICM   R0,15,=AL4(200000)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ASELIST                                                       
*                                                                               
         ICM   R0,15,=AL4(200000)                                               
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,AMAP                                                          
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ATIOB                                                         
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ASSB                                                          
         USING SSBD,R1                                                          
         MVI   SSBSTAT2,X'02'                                                   
         MVC   SSBTKADR,ATCBTASK                                                
         DROP  R1                                                               
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         ST    R1,ACOMFACS                                                      
         USING COMFACSD,R1                                                      
         MVC   CCALLOV,ACALLOV                                                  
         ICM   RE,15,AMASTC                                                     
         USING MASTD,RE                                                         
         MVC   CDATAMGR,MCVDMGR                                                 
         MVC   CDATCON,MCVDTCON                                                 
         MVC   CHEXOUT,MCVHEXOU                                                 
         MVC   CHEXIN,MCVHEXIN                                                  
         MVC   CDICTATE,MCVDICT                                                 
         MVC   CGETTXT,MCVGETXT                                                 
         DROP  R1,RE                                                            
*                                                                               
         LH    R0,=H'4096'                                                      
         GETMAIN RU,LV=(0),LOC=BELOW,BNDRY=PAGE                                 
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         STCM  R1,15,ASYSFAC                                                    
         USING SYSFACD,R1                                                       
         MVC   VUTL,AUTLTAB                                                     
         MVC   VTCB,ATCB                                                        
         MVC   VSSB,ASSB                                                        
         MVC   VSYSFAC0,ACOMFACS                                                
         DROP  R1                                                               
*                                                                               
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* IP CHECK ACTION                                                               
***********************************************************************         
         SPACE 1                                                                
IPCHACT  EQU   *                                                                
*                                                                               
         LA    RE,ADIPRD                                                        
         ICM   RF,15,=AL4(ADIPRDLQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
         NI    ACCDINDS,X'FF'-ACCDIIV                                           
         MVI   ADIPFLAG,C'N'                                                    
         BAS   RE,VALIP                                                         
         BNE   IPCHNO                                                           
*                                                                               
         BAS   RE,GETIPD                                                        
         BNE   IPCHNO                                                           
         MVI   ADIPFLAG,C'Y'                                                    
         OI    ACCDINDS,ACCDIIV                                                 
         B     IPCHOK                                                           
*                                                                               
IPCHNO   B     ACCRETN                                                          
IPCHOK   B     ACCRETY                                                          
         EJECT                                                                  
***********************************************************************         
* USER AUTHENTICATION ACTION                                                    
***********************************************************************         
         SPACE 1                                                                
UAUTACT  EQU   *                                                                
         LA    RE,ADUARD                                                        
         ICM   RF,15,=AL4(ADUARDLQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
         NI    ACCDINDS,X'FF'-ACCDIUV                                           
         MVC   ACCDSYS,=CL7'CON'                                                
         MVC   ACCDPGM,=CL7'MAD'                                                
         MVI   ADUAFLAG,C'N'                                                    
*                                                                               
         BAS   RE,VALDDS                                                        
         BNE   UAUTNO                                                           
*                                                                               
         BAS   RE,LOADCT                                                        
         BNE   UAUTNO                                                           
*                                                                               
         BAS   RE,GETUAV                                                        
         BNE   UAUTNO                                                           
         OC    ADPAPID,ADPAPID                                                  
         BZ    UAUT010                                                          
         CLC   ADPAPID,SPACES                                                   
         BE    UAUT010                                                          
*                                                                               
         GOTO1 LOADNUM,PARM,PIDNUM,ADUAPIN,L'ADUAPIN                            
         GOTO1 LOADNUM,PARM,UIDNUM,ADUAUIN,L'ADUAUIN                            
         GOTO1 LOADNUM,PARM,AGRNUM,ADUAAGNU,L'ADUAAGNU                          
*                                                                               
         BAS   RE,VALUIP                                                        
         BNE   UAUTNO                                                           
*                                                                               
         GOTO1 VALSYP,ADPAPID                                                   
         BNE   UAUTNO                                                           
*                                                                               
         BAS   RE,VALPAC                                                        
         BNE   UAUTNO                                                           
*                                                                               
UAUT010  EQU   *                                                                
*                                                                               
*        LA    RE,ADUAPAD                                                       
*        ICM   RF,15,=AL4(ADUAPALQ)                                             
*        LA    R0,*                                                             
*        L     R1,=F'0'                                                         
*        MVCL  RE,R0                                                            
*        MVC   ADUAPACL,=CL255'0A0B0A0E020100'                                  
*                                                                               
         MVI   ADUAFLAG,C'Y'                                                    
         OI    ACCDINDS,ACCDIUV                                                 
         B     UAUTOK                                                           
*                                                                               
UAUTNO   B     ACCRETN                                                          
UAUTOK   B     ACCRETY                                                          
         EJECT                                                                  
***********************************************************************         
* PROGRAM AUTHORISATION ACTION                                                  
***********************************************************************         
         SPACE 1                                                                
PAUTACT  EQU   *                                                                
         LA    RE,ADPARD                                                        
         ICM   RF,15,=AL4(ADPARDLQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
         NI    ACCDINDS,X'FF'-ACCDIPA                                           
         MVI   ADPAFLAG,C'N'                                                    
*                                                                               
         GOTO1 LOADNUM,PARM,PIDNUM,ADUAPIN,L'ADUAPIN                            
         GOTO1 LOADNUM,PARM,UIDNUM,ADUAUIN,L'ADUAUIN                            
         GOTO1 LOADNUM,PARM,AGRNUM,ADUAAGNU,L'ADUAAGNU                          
*                                                                               
         GOTO1 VALSYP,ADPAPID                                                   
         BNE   PAUTNO                                                           
*                                                                               
         BAS   RE,VALPAC                                                        
         BNE   PAUTNO                                                           
*                                                                               
*        BAS   RE,GETADV                                                        
*        BNE   PAUTNO                                                           
         MVC   ADPAADV,SPACES                                                   
*&&UK                                                                           
         MVI   ADPAADV,C'L'                                                     
         MVC   ADPAADV+1,ADVID                                                  
*&&                                                                             
*&&US                                                                           
         MVC   ADPAADV,ADVID                                                    
*&&                                                                             
         GOTO1 AHEXOUT,PARM,SESYSN,ADPASEN,1,=C'TOG'                            
*                                                                               
         OC    AGRNUM,AGRNUM                                                    
         BZ    *+12                                                             
         BAS   RE,LOADSEC                                                       
         BNE   PAUTNO                                                           
*                                                                               
         BAS   RE,FORMAUTH                                                      
         BNE   PAUTNO                                                           
         MVI   ADPAFLAG,C'Y'                                                    
         OI    ACCDINDS,ACCDIPA                                                 
         B     PAUTOK                                                           
*                                                                               
PAUT010  EQU   *                                                                
         B     PAUTOK                                                           
*                                                                               
PAUTNO   B     ACCRETN                                                          
PAUTOK   B     ACCRETY                                                          
         EJECT                                                                  
***********************************************************************         
* PROGRAM ACCESS ACTION                                                         
***********************************************************************         
         SPACE 1                                                                
PACCACT  EQU   *                                                                
         LA    RE,ADUAPAD                                                       
         ICM   RF,15,=AL4(ADUAPALQ)                                             
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
*                                                                               
         GOTO1 LOADNUM,PARM,PIDNUM,ADUAPIN,L'ADUAPIN                            
         GOTO1 LOADNUM,PARM,UIDNUM,ADUAUIN,L'ADUAUIN                            
*                                                                               
         BAS   RE,VALPAL                                                        
         BNE   PACCNO                                                           
*                                                                               
         MVC   ADUAPACL,ADPAPID                                                 
         B     PACCOK                                                           
*                                                                               
PACCNO   B     ACCRETN                                                          
PACCOK   B     ACCRETY                                                          
         EJECT                                                                  
***********************************************************************         
* OLD PROGRAM AUTHORISATION ACTION                                              
***********************************************************************         
         SPACE 1                                                                
PAUTOLD  EQU   *                                                                
         NI    ACCDINDS,X'FF'-ACCDIUV                                           
         BAS   RE,LOADCT                                                        
         BNE   POLDNO                                                           
*                                        TEST IF CONNECT SUCCESFUL              
         L     RE,AUTLSAVE                                                      
         OC    TSVCREQ-UTLD(L'TSVCREQ,RE),TSVCREQ-UTLD(RE)                      
         BNZ   POLD010                                                          
         OI    ACCDINDS,ACCDIUV                                                 
*                                                                               
         BAS   RE,LOADSEC                                                       
         BNE   POLDNO                                                           
*                                                                               
         BAS   RE,FORMAUTH                                                      
         BNE   POLDNO                                                           
         B     POLDOK                                                           
*                                                                               
POLD010  EQU   *                                                                
         B     POLDOK                                                           
*                                                                               
POLDNO   B     ACCRETN                                                          
POLDOK   B     ACCRETY                                                          
         EJECT                                                                  
***********************************************************************         
* FORMAT AUTHENTICATION/AUTHORISATION VALUES                                    
***********************************************************************         
         SPACE 1                                                                
FORMAUTH NTR1                                                                   
         ICM   R2,15,ACCPASEC                                                   
         BNZ   *+8                                                              
         L     R2,ASECBLOC                                                      
         USING SECD,R2                                                          
*        MVC   ACCDPFNM,SECFNAME                                                
*        MVC   ADPAACL,=CL255'0101010202010000'                                 
*        MVC   ADPAFCON,=CL33'RWRWNN'                                           
*        MVC   ADPAOCON,=CL33'YYYY'                                             
         B     FAUTOK                                                           
*                                                                               
FAUTOK   SR    RC,RC                                                            
FAUTNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* LOAD CONNECT SCREEN WITH INPUT DATA                                           
* CALLS OVERLAYS AND SETS SYSTEM DATA FOR =CT CONNECT CALL                      
* EXIT TO FACPAK MONITOR IF SUCCESFUL CONNECT,                                  
* ELSE SYSTEM DATA AND PC TWA RESTORED AND NORMAL ERROR EXIT                    
***********************************************************************         
*                                                                               
LOADCT   NTR1                                                                   
         BAS   RE,SAVETWA                                                       
         BAS   RE,SAVEUTL                                                       
*        BAS   RE,SAVETCB                                                       
*                                                                               
         L     R6,ATWA             LOAD CONNECT BASE SCREEN                     
         LA    R6,64(R6)                                                        
         GOTO1 ACALLOV,PARM,(R6),X'D90110FF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOCTERR2                                                         
*                                  MOVE DATA TO FIELDS AT RELATIVE              
*                                  LOGICAL POSITIONS IN TWA                     
*                                                                               
*                                  MOVE TEXT TO SERVICE REQUEST FIELD           
         GOTO1 LOADFLD,PARM,=C'=CT',3,1                                         
*                                                                               
         LA    R3,L'ADUAUID                                                     
         LA    R2,ADUAUID          MOVE DATA TO USER ID FIELD                   
         GOTO1 LOADFLD,PARM,(R2),(R3),2                                         
*                                                                               
         LA    R3,L'ACCDSYS                                                     
         LA    R2,ACCDSYS          MOVE DATA TO SYSTEM FIELD                    
         GOTO1 LOADFLD,PARM,(R2),(R3),3                                         
*                                                                               
         LA    R3,L'ACCDPGM                                                     
         LA    R2,ACCDPGM          MOVE DATA TO PROGRAM FIELD                   
         GOTO1 LOADFLD,PARM,(R2),(R3),4                                         
*                                                                               
         LA    R3,L'ADUAPWD                                                     
         LA    R2,ADUAPWD          MOVE DATA TO PASSWORD FIELD                  
         GOTO1 LOADFLD,PARM,(R2),(R3),5                                         
*                                                                               
         L     RF,AUTL             INHIBIT BROADCAST MSGS                       
         USING UTLD,RF                                                          
         NI    TFLAG,X'FF'-TFLAGIRB                                             
         DROP  RF                                                               
*                                                                               
         EJECT                                                                  
*                                  FIND ADDRESS OF CONNECT CODE                 
*                                  OVERLAY WHICH IS CORE RESIDENT               
LOCT100  EQU   *                                                                
         MVC   PARM+4(4),=X'D9011000'                                           
         MVC   PARM(4),ACCPLODA    IN CASE NOT CORE RESIDENT ??                 
         GOTO1 ACALLOV,PARM,,,0                                                 
         CLI   4(R1),X'FF'                                                      
         BE    LOCTERR3                                                         
         MVC   FULL,0(R1)                                                       
*                                  SET SYSTEM STATUS TABLE VALUES AS IF         
*                                  FOR ENTRY DIRECT FROM FACPAK MONITOR         
*                                  AND GOTO CONNECT ROUTINE                     
*                                                                               
         L     R2,AUTL             ADJUST UTL VALUES                            
         USING UTLD,R2                                                          
*                                                                               
         L     R3,ATCBTASK         ADJUST TCB VALUES                            
         USING TCBD,R3                                                          
         MVC   TSRSAVE(2),TSVCREQ  SAVE CURRENT UTL PROGRAM STATE               
         MVI   TSYS,1                                                           
         MVI   TSVCREQ,X'01'       INDICATE CT SERVICE REQUEST STATE            
         MVI   TSVCREQ+1,$CT                                                    
         MVI   TCBPRG,$CT          INDICATE CT SERVICE REQUEST STATE            
         MVC   SVTSTAT1,TSTAT1                                                  
         NI    TSTAT1,X'FF'-TSTATDDS                                            
         CLI   DDSUSER,C'Y'        SET DDS USER TERMINAL EQUIVALENT             
         BNE   *+8                                                              
         OI    TSTAT1,TSTATDDS                                                  
         MVC   SVTVIFLG,TVIFLAG                                                 
         OI    TVIFLAG,TVIVIRT                                                  
         L     RF,FULL             GET CODE ENTRY POINT                         
         L     R1,APARMS           POINT TO ENTRY PARAMETERS                    
         BASR  RE,RF               GOTO CONNECT ROUTINE                         
         OC    TSVCREQ,TSVCREQ     TEST IF CONNECT SUCCESFUL                    
         BNZ   LOCTERR1                                                         
*                                                                               
         L     R6,ATWA             RESTORE CALLERS TWA SCREEN                   
         LA    R6,64(R6)           LOAD OVERLAY                                 
         GOTO1 ACALLOV,PARM,(R6),X'D90121FF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOCTERR4                                                         
*                                                                               
         MVC   TCBPRG(1),TSVCREQ+1 RESTORE TCB PROGRAM STATE                    
*        BAS   RE,RESTTCB                                                       
*        MVC   TSVCREQ(2),TSRSAVE  AND RESTORE UTL PROGRAM STATE                
         MVC   TSTAT1,SVTSTAT1                                                  
         MVC   TVIFLAG,SVTVIFLG                                                 
         BAS   RE,SWAPUTL                                                       
         BAS   RE,RESTTWA                                                       
         B     LOCTOK                                                           
*                                                                               
$CT      EQU   X'10'               CONNECT PROGRAM #                            
*                                                                               
         SPACE 1                                                                
* INPUT ACTION ROUTINE RETURN POINTS                                            
*                                                                               
LOCTERR1 EQU   *                                                                
         BAS   RE,GETCTER          INTERPRET ERROR MSG IN TWA LINE 1            
         L     R6,ATWA             RESTORE CALLERS TWA SCREEN                   
         LA    R6,64(R6)           LOAD OVERLAY                                 
         GOTO1 ACALLOV,PARM,(R6),X'D90121FF'                                    
         CLI   4(R1),X'FF'                                                      
         BE    LOCTERR4                                                         
*                                                                               
         MVC   TCBPRG(1),TSVCREQ+1 RESTORE TCB PROGRAM STATE                    
*        BAS   RE,RESTTCB                                                       
*        MVC   TSVCREQ(2),TSRSAVE  AND RESTORE UTL PROGRAM STATE                
         MVC   TSTAT1,SVTSTAT1                                                  
         MVC   TVIFLAG,SVTVIFLG                                                 
         BAS   RE,SWAPUTL                                                       
         BAS   RE,RESTTWA                                                       
         B     LOCTNO                                                           
*                                                                               
LOCTERR2 EQU   *                                                                
         LA    RE,ACRSLCE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     LOCTNO                                                           
*                                                                               
LOCTERR3 EQU   *                                                                
         LA    RE,ACRSLCE3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     LOCTNO                                                           
*                                                                               
LOCTERR4 EQU   *                                                                
         LA    RE,ACRSLCE4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     LOCTNO                                                           
*                                                                               
LOCTOK   SR    RC,RC                                                            
LOCTNO   LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  R2,R3                                                            
         EJECT                                                                  
* SUBROUTINE TO INTERPRET ERROR MESSAGE IN TWA FIELD ONE                        
*                                                                               
GETCTER  NTR1                                                                   
         L     RE,ATWA                                                          
*                                                                               
         LA    R3,L'TWAUSER+8+TWAUSER-TWAD(RE)                                  
         CLC   0(2,R3),=C'ED'      TEST FOR ERROR CODE IN FIELD                 
         BNE   GCTEUND1            UNDEFINED ERROR CODE                         
*                                                                               
         LA    R2,4                READ 4 DIGIT CODE                            
         LA    R3,3(R3)                                                         
         GOTO1 TESTNUM,PARM,(R3),(R2)                                           
         BNE   GCTEUND1                                                         
*                                                                               
         BCTR  R2,0                CONVERT VALUE TO BINARY                      
         EX    R2,*+8                                                           
         B     *+10                                                             
         PACK  DUB,0(0,R3)                                                      
         CVB   R2,DUB                                                           
         B     GCTE100                                                          
*                                                                               
GCTEUND1 SR    R2,R2               SET DEFAULT VALUE                            
         B     GCTE100                                                          
*                                                                               
GCTE100  EQU   *                                                                
         ST    R2,REASCODE                                                      
         MVI   RETCODE,ACRCERR2                                                 
         B     GCTEX                                                            
*                                                                               
GCTEX    XIT1                                                                   
*                                                                               
         EJECT                                                                  
* TEST IF SOME NUMBER OF BYTES PAST A GIVEN ADDRESS ARE ALL NUMERIC             
*                                                                               
*     PARAMETER 1 - A(FIRST BYTE)                                               
*     PARAMETER 2 - NUMBER OF BYTES                                             
*                                                                               
*     ON RETURN, COND CODE IS EQ IF ALL BYTES ARE NUMERIC, NEQ                  
*     OTHERWISE.                                                                
*                                                                               
TESTNUM  NTR1                                                                   
         LM    R2,R3,0(R1)         R2 = A(FIRST BYTE) , R3 = # OF BYTES         
*                                                                               
TN10     CLI   0(R2),C'0'          TEST BYTE IS NOT NUMERIC                     
         BL    TN20                                                             
         CLI   0(R2),C'9'                                                       
         BH    TN20                                                             
*                                                                               
         LA    R2,1(R2)            BUMP TO NEXT BYTE AND TRY AGAIN              
         BCT   R3,TN10                                                          
*                                                                               
         CR    RF,RF               ALL BYTES NUMERIC - RETURN EQ                
         B     TNX                                                              
*                                                                               
TN20     LTR   RF,RF               SOME BYTE NOT NUMERIC - RETURN NEQ           
*                                                                               
TNX      XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* LOAD SECRET INFO                                                              
***********************************************************************         
*                                                                               
LOADSEC  NTR1                                                                   
         BAS   RE,SAVEUTL                                                       
         L     R2,AUTL             ADJUST UTL VALUES                            
         USING UTLD,R2                                                          
         L     R3,ATCBTASK         ADJUST TCB VALUES                            
         USING TCBD,R3                                                          
         MVC   SAVETSYS,TSYS                                                    
*        MVI   TSYS,1                                                           
         MVC   TOVSYS,SYSCODE                                                   
         MVC   TPRG,PGMCODE                                                     
         MVC   TAGYSEC,ADUASAID                                                 
         MVC   TPASSWD,PIDNUM                                                   
         MVC   TUSER,UIDNUM                                                     
         MVC   TSAGN,AGRNUM                                                     
         OI    TFLAG,TFLAGSEC                                                   
         XC    PARM(8*4),PARM                                                   
         ICM   R4,15,ACCPASEC                                                   
         BNZ   LSEC010              //?? CLEAR SEC BLOCK ??                     
*                                                                               
         L     RE,ASECBLOC                                                      
         ICM   RF,15,=AL4(L'SECBLOC)                                            
         LA    R0,*                                                             
         L     R1,=F'0'                                                         
         MVCL  RE,R0                                                            
         L     R4,ASECBLOC                                                      
         STCM  R4,15,ACCPASEC                                                   
*                                                                               
LSEC010  EQU   *                                                                
         LA    RE,IOAREA                                                        
         ICM   RF,15,=AL4(L'SECBLOC)                                            
         LA    R0,*                                                             
         L     R1,=F'0'                                                         
         MVCL  RE,R0                                                            
*        ICM   R4,15,ACCPASEC                                                   
         LA    R4,IOAREA                                                        
         GOTOR ASECRET,PARM,('SECPINIT',(R4)),L'SECBLOC                         
         BL    LOSEERR1                                                         
*                                                                               
LSEC020  EQU   *                                                                
         USING SECD,R4                                                          
         TM    SECINDS,SECIDDS+SECIOLD                                          
         BNZ   LSEC100                                                          
*        ICM   R4,15,ACCPASEC                                                   
         LA    R4,IOAREA                                                        
         GOTOR ASECRET,PARM,('SECPGRAL',(R4)),(L'ADPAACL,ADPAACL)               
         LA    RF,ADPAACL                                                       
         BL    LOSEERR1                                                         
LSEC030  EQU   *                                                                
         USING SECD,R4                                                          
         TM    SECINDS,SECIDDS+SECIOLD                                          
         BNZ   LSEC100                                                          
*        ICM   R4,15,ACCPASEC                                                   
         LA    R4,IOAREA                                                        
         GOTOR ASECRET,PARM,('SECPGOCL',(R4)),(L'ADPAOCON,ADPAOCON)             
         LA    RF,ADPAOCON                                                      
         BL    LOSEERR1                                                         
*                                                                               
LSEC040  EQU   *                                                                
         USING SECD,R4                                                          
         TM    SECINDS,SECIDDS+SECIOLD                                          
         BNZ   LSEC100                                                          
*        ICM   R4,15,ACCPASEC                                                   
         LA    R4,IOAREA                                                        
         GOTOR ASECRET,PARM,('SECPGFCL',(R4)),(L'ADPAFCON,ADPAFCON)             
         LA    RF,ADPAFCON                                                      
         BL    LOSEERR1                                                         
*                                                                               
LSEC100  EQU   *                                                                
         MVC   TSYS,SAVETSYS                                                    
         BAS   RE,SWAPUTL                                                       
         B     LOSEOK                                                           
*                                                                               
         SPACE 1                                                                
* INPUT ACTION ROUTINE RETURN POINTS                                            
*                                                                               
LOSEERR1 EQU   *                                                                
         LA    RE,ACRSLSE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR3                                                 
         MVC   TSYS,SAVETSYS                                                    
         BAS   RE,SWAPUTL                                                       
         B     LOSENO                                                           
         DROP  R2,R3,R4                                                         
*                                                                               
LOSEOK   SR    RC,RC                                                            
LOSENO   LTR   RC,RC                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* VALIDATE USER CHECK IP ADDRESS                                                
***********************************************************************         
*                                                                               
VALUIP   NTR1                                                                   
         CLI   ADUAWCTL,C'Y'                                                    
         BE    VUIP100                                                          
         OC    ACCNETID,ACCNETID                                                
         BZ    VUIPOK                                                           
         CLC   ACCNETID,SPACES                                                  
         BE    VUIPOK                                                           
         MVC   ADIPADR,SPACES                                                   
         MVC   ADIPADR(L'ACCNETID),ACCNETID                                     
         LA    RE,L'ADIPADR                                                     
         LA    RF,ADIPADR                                                       
         AR    RF,RE                                                            
         BCTR  RF,0                                                             
         LA    R1,0                                                             
VUIP010  EQU   *                                                                
         CLI   0(RF),C' '                                                       
         BNE   VUIP020                                                          
         BCTR  RF,0                                                             
         BCT   RE,VUIP010                                                       
         B     VUIPOK                                                           
VUIP020  EQU   *                                                                
         STC   RE,ADIPADRL                                                      
*                                                                               
VUIP100  EQU   *                                                                
         BAS   RE,VALIP                                                         
         BNE   VUIPNO                                                           
         MVC   USERID,ADUAUID                                                   
         LA    R2,IOAREA                                                        
         BAS   RE,VALID            ENSURE ID IS COMPATIBLE WITH IP              
         BNE   VUIPERR1                                                         
         B     VUIPOK                                                           
*                                                                               
VUIPERR1 EQU   *                                                                
         LA    RE,ACRSVUE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VUIPNO                                                           
*                                                                               
VUIPOK   SR    RC,RC                                                            
VUIPNO   LTR   RC,RC                                                            
VUIPX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* VALIDATE PROGRAM ACCESS                                                       
***********************************************************************         
*                                                                               
VALPAC   NTR1                                                                   
         LA    R2,IOKEY                                                         
         USING CTIREC,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ     RECORD TYPE C'I'                            
         MVC   CTIKNUM,UIDNUM                                                   
         BAS   RE,READSA                                                        
         BNE   VPACERR1                                                         
         L     R2,AIOAREA                                                       
         LA    R1,AUIDSYS            AND SAVE SYSTEM ELEMENT                    
         BAS   RE,GETSYS                                                        
         BE    VPACERR3                                                         
         XC    UIDSYSEL,UIDSYSEL                                                
         ICM   R1,15,AUIDSYS                                                    
         SR    RF,RF                                                            
         IC    RF,1(R1)                                                         
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   UIDSYSEL(0),0(R1)                                                
         LA    RF,UIDSYSEL                                                      
         STCM  RF,15,AUIDSYS                                                    
         LA    R2,IOKEY                                                         
         USING SA0REC,R2                                                        
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ                                                 
         MVC   SA0KAGY,ADUASAID                                                 
         MVC   SA0KNUM,PIDNUM                                                   
         BAS   RE,READSA                                                        
         BNE   VPACERR2                                                         
         L     R2,AIOAREA                                                       
         LA    R1,APIDSYS            AND SAVE SYSTEM ELEMENT                    
         BAS   RE,GETSYS                                                        
         BE    VPACERR4                                                         
         XC    PIDSYSEL,PIDSYSEL                                                
         ICM   R1,15,APIDSYS                                                    
         SR    RF,RF                                                            
         IC    RF,1(R1)                                                         
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PIDSYSEL(0),0(R1)                                                
         LA    RF,PIDSYSEL                                                      
         STCM  RF,15,APIDSYS                                                    
*                                                                               
         L     RF,=A(GETAUT)       GET PROGRAM AUTHORISATION                    
         A     RF,RELO                                                          
         BASR  RE,RF                                                            
         BNE   VPACNO                                                           
         GOTO1 AHEXOUT,PARM,PGMAUTH,ADPAAUTH,2,=C'TOG'                          
*                                                                               
         L     RF,=A(GETLAC)       GET PROGRAM LIMIT ACCESS                     
         A     RF,RELO                                                          
         BASR  RE,RF                                                            
         BNE   VPACNO                                                           
         MVC   ADPALACC,PGMLACC                                                 
         B     VPACOK                                                           
*                                                                               
VPACERR1 EQU   *                                                                
         LA    RE,ACRSPAE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR2 EQU   *                                                                
         LA    RE,ACRSPAE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR3 EQU   *                                                                
         LA    RE,ACRSPAE3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR4 EQU   *                                                                
         LA    RE,ACRSPAE4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR5 EQU   *                                                                
         LA    RE,ACRSPAE5                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACERR6 EQU   *                                                                
         LA    RE,ACRSPAE6                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VPACNO                                                           
*                                                                               
VPACOK   SR    RC,RC                                                            
VPACNO   LTR   RC,RC                                                            
VPACX    XIT1                                                                   
         SPACE 1                                                                
* GET A(SYSTEM ELEMENT) FOR AN ID/AUTHORIZATION RECORD                          
* ON ENTRY R4=A(RECORD), R1=A(ELEMENT ADDRESS), SYSCODE=SYSTEM NUMBER           
*                                                                               
GETSYS   LA    RF,CTIDATA-CTIREC(R2)                                            
         SR    R0,R0                                                            
GETSYS2  CLI   0(RF),0             TEST E-O-R                                   
         BNE   *+10                                                             
         SR    RF,RF                                                            
         B     GETSYSX                                                          
         CLI   0(RF),X'21'         TEST FOR CORRECT SYSTEM ELEMENT              
         BNE   *+14                                                             
         CLC   SYSCODE,CTSYSNUM-CTSYSD(RF)                                      
         BE    GETSYSX                                                          
         IC    R0,1(RF)                                                         
         AR    RF,R0                                                            
         B     GETSYS2                                                          
GETSYSX  LTR   RF,RF               EXIT IF SYSTEM ELEMENT FOUND                 
         BNZ   GETSYSX1                                                         
GETSYSX1 ST    RF,0(R1)            RETURN A(ELEMENT) OR ZERO                    
         LTR   RF,RF               SET CC=EQ IF NO ELEMENT FOUND                
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* VALIDATE PROGRAM ACCESS LIST                                                  
***********************************************************************         
*                                                                               
VALPAL   NTR1                                                                   
         LA    R4,ADPAPID                                                       
*                                                                               
         GOTO1 VALSYP,ADPAPID                                                   
         BNE   VPALNO                                                           
*                                                                               
         BAS   RE,VALPAC                                                        
         BNE   VPALNO                                                           
         B     VPALOK                                                           
*                                                                               
VPALOK   SR    RC,RC                                                            
VPALNO   LTR   RC,RC                                                            
VPALX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET FACPAK ADV VTAM ID FOR THIS USER SE NUMBER                                
***********************************************************************         
*                                                                               
GETADV   NTR1                                                                   
         L     R3,AUIDSYS                                                       
         USING CTSYSD,R3                                                        
         MVC   SESYSN,CTSYSSE                                                   
*                                                                               
         GOTO1 ADMOD000,PARM,AFINDSYS,(1,0)                                     
         L     R1,4(R1)            R1=A(SYSFILES LIST)                          
*&&UK*&& SH    R1,=H'4'                                                         
*&&US*&& SH    R1,=H'8'                                                         
         L     R1,0(R1)            EXTRACT SYSSTAB                              
*                                                                               
         SR    RF,RF               CHECK SESYSN AGAINST TABLE                   
         IC    RF,SESYSN                                                        
         AR    RF,R1                                                            
         CLI   0(RF),X'FF'                                                      
         BE    GADV100                                                          
         LA    R3,FACIDTAB                                                      
         USING FACITABD,R3                                                      
GADV010  EQU   *                                                                
         CLI   0(R3),X'FF'                                                      
         BE    GADVERR1                                                         
         CLC   0(1,RF),FACIID                                                   
         BE    GADV020                                                          
         LA    R3,L'FACITAB(R3)                                                 
         B     GADV010                                                          
GADV020  EQU   *                                                                
         MVC   ADVID,FACISN4                                                    
         B     GADVOK                                                           
GADV100  EQU   *                                                                
         MVC   ADVID,=CL4'ADV1'                                                 
         B     GADVOK                                                           
         DROP  R3                                                               
*                                                                               
GADVERR1 EQU   *                                                                
         LA    RE,ACRSADE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GADVNO                                                           
*                                                                               
GADVOK   SR    RC,RC                                                            
GADVNO   LTR   RC,RC                                                            
GADVX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* VALIDATE FACPAK SYSTEM PROGRAM CODES FROM INPUT                               
* R3=A(SYS/PGM HEX CODE IN INPUT)                                               
***********************************************************************         
*                                                                               
VALSYP   NTR1                                                                   
         LR    R3,R1                                                            
         GOTO1 AHEXIN,PARM,0(R3),SYSCODE,2                                      
         OC    12(4,R1),12(R1)                                                  
         BZ    VSYPERR1                                                         
         GOTO1 AHEXIN,PARM,2(R3),PGMCODE,2                                      
         OC    12(4,R1),12(R1)                                                  
         BZ    VSYPERR2                                                         
         B     VSYPOK                                                           
*                                                                               
VSYPERR1 EQU   *                                                                
         LA    RE,ACRSSPE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSYPNO                                                           
*                                                                               
VSYPERR2 EQU   *                                                                
         LA    RE,ACRSSPE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSYPNO                                                           
*                                                                               
VSYPOK   SR    RC,RC                                                            
VSYPNO   LTR   RC,RC                                                            
VSYPX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* VALIDATE DDS USER IP ADDRESS                                                  
***********************************************************************         
*                                                                               
VALDDS   NTR1                                                                   
*                                                                               
         MVI   DDSUSER,C'N'                                                     
         MVC   SNIDSTRV,ADIPADR                                                 
         MVC   SNIDSTRL,ADIPADRL                                                
         CLI   ADIPADRL,9                                                       
         BNE   VDDS010                                                          
         CLC   ADIPADR(9),=CL9'127.0.0.1'                                       
         BNE   VDDS010                                                          
         MVI   DDSUSER,C'Y'                                                     
         B     VDDSOK                                                           
*                                                                               
VDDS010  EQU   *                                                                
         CLI   ADIPADRL,5                                                       
         BL    VDDSOK                                                           
         CLC   ADIPADR(5),=CL5'10.2.'                                           
         BNE   VDDSOK                                                           
         MVI   DDSUSER,C'Y'                                                     
         B     VDDSOK                                                           
*                                                                               
VDDSOK   SR    RC,RC                                                            
VDDSNO   LTR   RC,RC                                                            
VDDSX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* VALIDATE IP ADDRESS                                                           
***********************************************************************         
*                                                                               
VALIP    NTR1                                                                   
*                                                                               
         MVI   DDSUSER,C'N'                                                     
         MVC   SNIDSTRV,ADIPADR                                                 
         MVC   SNIDSTRL,ADIPADRL                                                
         CLI   ADIPADRL,9                                                       
         BNE   VAIP002                                                          
         CLC   ADIPADR(9),=CL9'127.0.0.1'                                       
         BNE   VAIP002                                                          
         MVI   DDSUSER,C'Y'                                                     
         B     VAIP004                                                          
*                                                                               
VAIP002  EQU   *                                                                
         CLI   ADIPADRL,5                                                       
         BL    VAIP004                                                          
         CLC   ADIPADR(5),=CL5'10.2.'                                           
         BNE   VAIP004                                                          
         MVI   DDSUSER,C'Y'                                                     
*                                                                               
VAIP004  EQU   *                                                                
*                                   TESTING ??                                  
*        XC    SNIDSTRV,SNIDSTRV                                                
*        MVC   SNIDSTRV,=CL7'3.4.5.6'                                           
*        MVI   SNIDSTRL,7                                                       
*                                                                               
         BAS   RE,VALSNID                                                       
         BNE   VAIPX                                                            
         LA    R2,IOKEY                                                         
         USING CTIPREC,R2                                                       
         XC    CTIPKEY,CTIPKEY                                                  
         MVI   CTIPKTYP,CTIPKTEQ   RECORD TYPE C'3'                             
         MVI   CTIPKTY2,CTIPKT2E   SUB RECORD TYPE C'I'                         
         MVC   CTIPKSID,SNID       SUBNET ID (1S COMPLEMENT)                    
         BAS   RE,RDHISA                                                        
         BNE   VAIPERR1                                                         
         LA    R2,IOAREA                                                        
         CLI   CTIPKTYP,CTIPKTEQ                                                
         BNE   VAIPERR1                                                         
         CLI   CTIPKTY2,CTIPKT2E                                                
         BNE   VAIPERR1                                                         
         MVC   IPRKSNID,CTIPKSID                                                
         LA    R3,IOAREA+(CTIPDATA-CTIPREC)                                     
*                                                                               
VAIP010  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    VAIPERR2                                                         
         CLI   0(R3),CTIPMELQ                                                   
         BE    VAIP020                                                          
         SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     VAIP020                                                          
*                                                                               
         USING CTIPMEL,R3                                                       
VAIP020  EQU   *                                                                
         XC    SNIDMASK,SNIDMASK                                                
         SR    RF,RF                                                            
         IC    RF,CTIPMLEN                                                      
         SHI   RF,3                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   SNIDMASK(0),CTIPM                                                
         DROP  R2                                                               
         BAS   RE,VALIPM                                                        
         BNE   VAIPX                                                            
         B     VAIPOK                                                           
*                                                                               
VAIPERR1 EQU   *                                                                
         LA    RE,ACRSIPE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VAIPNO                                                           
*                                                                               
VAIPERR2 EQU   *                                                                
         LA    RE,ACRSIPE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VAIPNO                                                           
*                                                                               
VAIPOK   SR    RC,RC                                                            
VAIPNO   LTR   RC,RC                                                            
VAIPX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET IP CHECK DATA VALUES                                                      
* IP RECORD IN IOAREA                                                           
***********************************************************************         
*                                                                               
GETIPD   NTR1                                                                   
         LA    R3,IOAREA+(CTIPDATA-CTIPREC)                                     
*                                                                               
GIPD010  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPD020                                                          
         CLI   0(R3),CTIPPELQ                                                   
         BE    GIPD014                                                          
         CLI   0(R3),CTIPRELQ                                                   
         BE    GIPD016                                                          
GIPD012  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPD010                                                          
*                                                                               
         USING CTIPPEL,R3                                                       
GIPD014  EQU   *                                                                
         ZIC   R1,CTIPPLEN                                                      
         SH    R1,=Y(CTIPPLNQ+1)                                                
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ADIPPUID(0),CTIPPID                                              
         B     GIPD012                                                          
         DROP  R3                                                               
*                                                                               
         USING CTIPREL,R3                                                       
GIPD016  EQU   *                                                                
         ZIC   R1,CTIPRLEN                                                      
         SH    R1,=Y(CTIPRLNQ+1)                                                
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ADIPRNAM(0),CTIPRNAM                                             
         B     GIPD012                                                          
         DROP  R3                                                               
*                                                                               
GIPD020  EQU   *                                                                
         LA    R3,IOAREA+(CTIPDATA-CTIPREC)                                     
GIPD022  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPD024                                                          
         CLI   0(R3),CTPIDELQ                                                   
         BE    GIPD023                                                          
         SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPD022                                                          
*                                                                               
         USING CTPIDEL,R3                                                       
GIPD023  EQU   *                                                                
         MVC   ADIPUID,CTPID                                                    
         B     GIPD030                                                          
*                                                                               
GIPD024  EQU   *                                                                
         LA    R3,IOAREA+(CTIPDATA-CTIPREC)                                     
*                                                                               
GIPD026  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPD030                                                          
         CLI   0(R3),CTIDELQ                                                    
         BE    GIPD028                                                          
         SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPD026                                                          
*                                                                               
         USING CTIDEL,R3                                                        
GIPD028  EQU   *                                                                
         CLC   CTID(10),=CL10'ALL'                                              
         BNE   GIPD029                                                          
*&&UK*&& MVC   ADIPUID,=CL10'DDS1'                                              
*&&US*&& MVC   ADIPUID,=CL10'SJR'                                               
         B     GIPD030                                                          
GIPD029  EQU   *                                                                
         MVC   ADIPUID,CTID                                                     
*                                                                               
GIPD030  EQU   *                                                                
         OC    ADIPUID,ADIPUID                                                  
         BZ    GIPDERR1                                                         
         LA    R2,IOKEY                                                         
         USING CTIREC,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ  RECORD TYPE C'I'                               
         MVC   CTIKID,ADIPUID    SUBNET ID (1S COMPLEMENT)                      
         BAS   RE,READSA                                                        
         BNE   GIPDERR2                                                         
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
*                                                                               
GIPD100  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPD200                                                          
         CLI   0(R3),CTAGYELQ                                                   
         BE    GIPD110                                                          
         CLI   0(R3),CTDSTELQ                                                   
         BE    GIPD120                                                          
         CLI   0(R3),CTORGELQ                                                   
         BE    GIPD130                                                          
GIPD112  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPD100                                                          
*                                                                               
         USING CTAGYEL,R3                                                       
GIPD110  EQU   *                                                                
         MVC   ADIPAID,CTAGYID                                                  
         B     GIPD112                                                          
*                                                                               
         USING CTDSTEL,R3                                                       
GIPD120  EQU   *                                                                
         MVC   ADIPDNAM,CTDSTNAM                                                
         MVC   ADIPADL1,CTDSTADD                                                
         CLI   CTDSTLEN,(CTDSTAD3+L'CTDSTAD3-CTDSTEL)                           
         BNH   GIPD112                                                          
         MVC   ADIPADL2,CTDSTAD2                                                
         MVC   ADIPADL3,CTDSTAD3                                                
         B     GIPD112                                                          
*                                                                               
         USING CTORGEL,R3                                                       
GIPD130  EQU   *                                                                
         MVC   ADIPANAM,CTORGNAM                                                
         B     GIPD112                                                          
         DROP  R3                                                               
*                                                                               
GIPD200  EQU   *                                                                
         BAS   RE,GETIPA                                                        
         BNE   GIPDNO                                                           
         B     GIPDOK                                                           
*                                                                               
GIPDERR1 EQU   *                                                                
         LA    RE,ACRSGIE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GIPDNO                                                           
*                                                                               
GIPDERR2 EQU   *                                                                
         LA    RE,ACRSGIE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GIPDNO                                                           
*                                                                               
GIPDOK   SR    RC,RC                                                            
GIPDNO   LTR   RC,RC                                                            
GIPDX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET AGENCY ACCESS RECORD VALUES FOR IP CHECK                                  
***********************************************************************         
*                                                                               
GETIPA   NTR1                                                                   
         MVI   ADIPPFLG,C'N'                                                    
         LA    R2,IOKEY                                                         
         USING CT5REC,R2                                                        
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ                                                 
         MVC   CT5KALPH,ADIPAID                                                 
         BAS   RE,READSA                                                        
         BNE   GIPAERR1                                                         
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
*                                                                               
GIPA010  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GIPA100                                                          
         CLI   0(R3),CTAADELQ                                                   
         BE    GIPA020                                                          
GIPA012  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GIPA010                                                          
*                                                                               
         USING CTAADEL,R3                                                       
GIPA020  EQU   *                                                                
         CLI   CTAADLEN,CTAADLNQ                                                
         BNE   GIPA100                                                          
         TM    CTAADFLG,CTAADPRQ                                                
         BZ    GIPA100                                                          
         MVI   ADIPPFLG,C'Y'                                                    
         B     GIPA100                                                          
         DROP  R3                                                               
*                                                                               
GIPA100  EQU   *                                                                
         B     GIPAOK                                                           
*                                                                               
GIPAERR1 EQU   *                                                                
         LA    RE,ACRSIAE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GIPANO                                                           
*                                                                               
GIPAOK   SR    RC,RC                                                            
GIPANO   LTR   RC,RC                                                            
GIPAX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET USER AUTHENTICATION VALUES                                                
***********************************************************************         
*                                                                               
GETUAV   NTR1                                                                   
*                                                                               
         BAS   RE,GETUTL                                                        
         BNE   GUAVNO                                                           
         BAS   RE,GETUID                                                        
         BNE   GUAVNO                                                           
         BAS   RE,GETACC                                                        
         BNE   GUAVNO                                                           
*        OC    ADUAPID,ADUAPID                                                  
*        BZ    GUAV010                                                          
*        CLC   ADUAPID,SPACES                                                   
*        BNE   GUAV020                                                          
GUAV010  EQU   *                                                                
         BAS   RE,GETPWD                                                        
         BNE   GUAVNO                                                           
GUAV020  EQU   *                                                                
         BAS   RE,GETPER                                                        
         BNE   GUAVNO                                                           
         BAS   RE,GETOFF                                                        
         BNE   GUAVNO                                                           
         BAS   RE,GETDEP                                                        
         BNE   GUAVNO                                                           
         BAS   RE,GETAGR                                                        
         BNE   GUAVNO                                                           
         MVC   ADUAWCTL,WEBCNTLS                                                
         MVC   ADUAACOD,ACCESSCD                                                
         B     GUAVOK                                                           
*                                                                               
GUAVOK   SR    RC,RC                                                            
GUAVNO   LTR   RC,RC                                                            
GUAVX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET VALUES FROM UTL FOR USER AUTHENTICATION                                   
***********************************************************************         
*                                                                               
GETUTL   NTR1                                                                   
*                                                                               
         B     GUTLOK                                                           
*                                                                               
GUTLOK   SR    RC,RC                                                            
GUTLNO   LTR   RC,RC                                                            
GUTLX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET USER ID RECORD VALUES FOR USER AUTHENTICATION                             
***********************************************************************         
*                                                                               
GETUID   NTR1                                                                   
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
         LA    R2,IOKEY                                                         
         USING CTIREC,R2                                                        
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,CTIKTYPQ  RECORD TYPE C'I'                               
         MVC   CTIKID,ADUAUID                                                   
         BAS   RE,READSA                                                        
         BNE   GUIDERR1                                                         
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
*                                                                               
GUID100  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GUID200                                                          
         CLI   0(R3),CTAGYELQ                                                   
         BE    GUID110                                                          
         CLI   0(R3),CTDSTELQ                                                   
         BE    GUID120                                                          
         CLI   0(R3),CTORGELQ                                                   
         BE    GUID130                                                          
         CLI   0(R3),X'02'                                                      
         BE    GUID140                                                          
GUID112  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GUID100                                                          
*                                                                               
         USING CTAGYEL,R3                                                       
GUID110  EQU   *                                                                
         MVC   ADUAUAID,CTAGYID                                                 
         B     GUID112                                                          
*                                                                               
         USING CTDSTEL,R3                                                       
GUID120  EQU   *                                                                
         MVC   ADUADNAM,CTDSTNAM                                                
         MVC   ADUAADL1,CTDSTADD                                                
         CLI   CTDSTLEN,(CTDSTAD3+L'CTDSTAD3-CTDSTEL)                           
         BNH   GUID112                                                          
         MVC   ADUAADL2,CTDSTAD2                                                
         MVC   ADUAADL3,CTDSTAD3                                                
         B     GUID112                                                          
*                                                                               
         USING CTORGEL,R3                                                       
GUID130  EQU   *                                                                
         MVC   ADUAUANM,CTORGNAM                                                
         B     GUID112                                                          
*                                                                               
         USING CTAGYEL,R3                                                       
GUID140  EQU   *                                                                
         SR    RF,RF                                                            
         ICM   RF,3,2(R3)                                                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ADUAUIN,DUB+5(3)                                                 
         B     GUID112                                                          
         DROP  R3                                                               
*                                                                               
GUID200  EQU   *                                                                
         B     GUIDOK                                                           
*                                                                               
GUIDERR1 EQU   *                                                                
         LA    RE,ACRSGUE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GUIDNO                                                           
*                                                                               
GUIDOK   SR    RC,RC                                                            
GUIDNO   LTR   RC,RC                                                            
GUIDX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET AGENCY ACCESS RECORD VALUES FOR USER AUTHENTICATION                       
***********************************************************************         
*                                                                               
GETACC   NTR1                                                                   
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
         LA    R2,IOKEY                                                         
         USING CT5REC,R2                                                        
         XC    CT5KEY,CT5KEY                                                    
         MVI   CT5KTYP,CT5KTYPQ                                                 
         MVC   CT5KALPH,ADUAUAID                                                
         BAS   RE,READSA                                                        
         BNE   GACCERR1                                                         
*                                                                               
         LA    R3,IOAREA+(CTIDATA-CTIREC)                                       
*                                                                               
GACC100  EQU   *                                                                
         CLI   0(R3),0                                                          
         BE    GACC200                                                          
         CLI   0(R3),CTAGDELQ                                                   
         BE    GACC110                                                          
         CLI   0(R3),WEBELQ                                                     
         BE    GACC120                                                          
GACC112  SR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         AR    R3,RF                                                            
         B     GACC100                                                          
*                                                                               
         USING CTAGDEL,R3                                                       
GACC110  EQU   *                                                                
         CLI   CTAGDLEN,CTAGDL2Q                                                
         BNE   GACC112                                                          
         GOTO1 AHEXOUT,PARM,CTAGDCTY,ADUACTRY,2,=C'TOG'                         
         B     GACC112                                                          
         DROP  R3                                                               
*                                                                               
         USING WEBEL,R3                                                         
GACC120  EQU   *                                                                
         CLI   WEBLN,WEBLNQ                                                     
         BNE   GACC112                                                          
         MVC   ACCESSCD,WEBACOD                                                 
         MVC   ACCNETID,SPACES                                                  
         MVC   ACCNETID(L'ACCNETID),WEBNID                                      
         MVC   WEBCNTLS,=CL3'YYN'                                               
         TM    WEBFLAG,WEBFIP                                                   
         BZ    *+8                                                              
         MVI   WEBCNTLS,C'N'                                                    
         TM    WEBFLAG,WEBFSS                                                   
         BZ    *+8                                                              
         MVI   WEBCNTLS+1,C'N'                                                  
         TM    WEBFLAG,WEBFAC                                                   
         BZ    *+10                                                             
         MVC   WEBCNTLS+2(1),WEBACT                                             
         B     GACC112                                                          
         DROP  R3                                                               
*                                                                               
GACC200  EQU   *                                                                
         B     GACCOK                                                           
*                                                                               
GACCERR1 EQU   *                                                                
         LA    RE,ACRSGAE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GACCNO                                                           
*                                                                               
GACCOK   SR    RC,RC                                                            
GACCNO   LTR   RC,RC                                                            
GACCX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET PERSON ID RECORD VALUES FOR USER AUTHENTICATION                           
***********************************************************************         
*                                                                               
GETPER   NTR1                                                                   
*                                                                               
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
         USING SAPEREC,R2          READ PERSON RECORD                           
         LA    R2,IOKEY                                                         
         XC    SAPEKEY,SAPEKEY                                                  
         MVI   SAPETYP,SAPETYPQ                                                 
         MVI   SAPESUB,SAPESUBQ                                                 
         MVC   SAGY,TAGYSEC      SET AGENCY USED FOR SECURTIY                   
         OC    SAGY,SAGY                                                        
         BNZ   *+10                                                             
         MVC   SAGY,TAGY                                                        
         MVC   ADUASAID,SAGY                                                    
         MVC   SAPEAGY,SAGY                                                     
         OC    ADUAPID,ADUAPID                                                  
         BZ    GPER010                                                          
         CLC   ADUAPID,SPACES                                                   
         BE    GPER010                                                          
         OC    PWDPID,PWDPID                                                    
         BZ    GPER020                                                          
         CLC   PWDPID,SPACES                                                    
         BZ    GPER020                                                          
         CLC   ADUAPID,PWDPID                                                   
         BNE   GPERERR3                                                         
         B     GPER020                                                          
*                                                                               
GPER010  EQU   *                                                                
         OC    PWDPID,PWDPID                                                    
         BZ    GPERERR2                                                         
         CLC   PWDPID,SPACES                                                    
         BZ    GPERERR2                                                         
         MVC   ADUAPID,PWDPID                                                   
*                                                                               
GPER020  EQU   *                                                                
         MVC   SAPEPID,ADUAPID                                                  
         GOTO1 ADATCON,PARM,(5,(0)),(2,SAPEDEF)                                 
         XC    SAPEDEF,EFFS        COMPLEMENT DATE                              
         BAS   RE,RDHISA                                                        
         BNE   GPERERR1                                                         
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),IOAREA                                  
         BNE   GPERERR1                                                         
*                                  NO RECORD FOUND FOR THIS PERSON              
*                                                                               
         MVC   EFFDATE,SAPEDEF                                                  
         XC    EFFDATE,EFFS                                                     
         GOTO1 ADATCON,PARM,(2,EFFDATE),(20,ADUADEF)                            
         DROP  R2                                                               
*                                                                               
         LA    R3,IOAREA+(SAPEDATA-SAPEREC)                                     
GPER110  CLI   0(R3),0             TEST E-O-R                                   
         BE    GPER200                                                          
         CLI   0(R3),SANAMELQ      TEST NAME ELEMENT                            
         BE    GPER130                                                          
         CLI   0(R3),SAPERELQ      TEST PERSONNEL DETAILS                       
         BE    GPER140                                                          
         CLI   0(R3),SAAGCELQ                                                   
         BE    GPER150                                                          
         CLI   0(R3),SAPWDELQ                                                   
         BE    GPER160                                                          
GPER120  XR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         BXH   R3,RF,GPER110                                                    
*                                                                               
         USING SANAMD,R3           R3=A(NAME ELEMENT)                           
GPER130  XR    RE,RE                                                            
         LA    RF,SANAMES                                                       
         USING SANAMES,RF          RF=A(NAME SUB ELEMENT)                       
*                                                                               
         IC    RE,SANAMELN         COPY FIRST NAME                              
         BCTR  RE,0                                                             
         EX    RE,*+4                                                           
         MVC   ADUAFNA(0),SANAME                                                
         LA    RF,L'SANAMELN+1(RE,RF)  BUMP RF TO NEXT SUB-ELEMENT              
*                                                                               
         TM    SANAMIND,SANAMIMN   TEST MIDDLE NAME PRESENT                     
         BZ    GPER132                                                          
         IC    RE,SANAMELN         COPY MIDDLE NAME                             
         BCTR  RE,0                                                             
         EX    RE,*+4                                                           
         MVC   ADUAMNA(0),SANAME                                                
         LA    RF,L'SANAMELN+1(RE,RF)  BUMP RF TO NEXT SUB-ELEMENT              
*                                                                               
GPER132  IC    RE,SANAMELN         COPY LAST NAME                               
         LA    R1,L'SECLNAME       SHORTENED TO FIT SECCLAL                     
         CR    R1,RE                                                            
         BH    *+6                                                              
         LR    RE,R1                                                            
         BCTR  RE,0                                                             
         EX    RE,*+4                                                           
         MVC   ADUALNA(0),SANAME                                                
         B     GPER120                                                          
         DROP  RF                                                               
*                                                                               
         USING SAPERD,R3           EXTRACT PERSON DERTAILS                      
GPER140  MVC   ADUAOFF,SAPEROFF                                                 
         MVC   ADUADEP,SAPERDID                                                 
         GOTO1 ADATCON,PARM,(2,SAPERDHI),(20,ADUADHI)                           
         GOTO1 ADATCON,PARM,(2,SAPERDTE),(20,ADUADTE)                           
         B     GPER120                                                          
*                                                                               
         USING SAAGCD,R3           EXTRACT ACCESS GROUP CODE                    
GPER150  EQU   *                                                                
         SR    RF,RF                                                            
         ICM   RF,3,SAAGCNUM                                                    
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ADUAAGNU,DUB+5(3)                                                
         MVC   ADUAAGCD,SAAGCCOD                                                
         B     GPER120                                                          
*                                                                               
         USING SAPWDD,R3                                                        
GPER160  EQU   *                                                                
         SR    RF,RF                                                            
         ICM   RF,3,SAPWDNUM                                                    
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ADUAPIN,DUB+5(3)                                                 
         B     GPER120                                                          
*                                                                               
GPER200  EQU   *                                                                
         B     GPEROK                                                           
         DROP  R3                                                               
*                                                                               
GPERERR1 EQU   *                                                                
         LA    RE,ACRSGPE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPERNO                                                           
*                                                                               
GPERERR2 EQU   *                                                                
         LA    RE,ACRSGPE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPERNO                                                           
*                                                                               
GPERERR3 EQU   *                                                                
         LA    RE,ACRSGPE3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPERNO                                                           
*                                                                               
GPEROK   SR    RC,RC                                                            
GPERNO   LTR   RC,RC                                                            
GPERX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET PERSON PASSWORD RECORD VALUES USER AUTHENTICATION                         
***********************************************************************         
*                                                                               
GETPWD   NTR1                                                                   
*                                                                               
         XC    PWDPID,PWDPID                                                    
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
         LA    R2,IOKEY                                                         
         USING SA0REC,R2                                                        
         XC    SA0KEY,SA0KEY                                                    
         MVI   SA0KTYP,SA0KTYPQ                                                 
         MVC   SAGY,TAGYSEC      SET AGENCY USED FOR SECURITY                   
         OC    SAGY,SAGY                                                        
         BNZ   *+10                                                             
         MVC   SAGY,TAGY                                                        
         MVC   ADUASAID,SAGY                                                    
         MVC   SA0KAGY,SAGY                                                     
         MVC   SA0KNUM,TPASSWD                                                  
         BAS   RE,READSA                                                        
         BNE   GPWDERR2                                                         
         CLC   SA0KEY(SA0LEN-SA0KEY),IOAREA                                     
         BNE   GPWDERR1                                                         
         DROP  R2                                                               
         LA    R3,IOAREA+(SA0DATA-SA0REC)                                       
         MVI   BYTE,C'N'                                                        
GPWD110  CLI   0(R3),0             TEST E-O-R                                   
         BE    GPWDERR3                                                         
         CLI   0(R3),SAPALELQ      TEST PERSON ID ELEMENT                       
         BE    GPWD130                                                          
GPWD120  XR    RF,RF                                                            
         IC    RF,1(R3)                                                         
         BXH   R3,RF,GPWD110                                                    
*                                                                               
*                                                                               
         USING SAPALD,R3           EXTRACT PERSON ID ELEMENT                    
GPWD130  EQU   *                                                                
         MVC   PWDPID,SAPALPID                                                  
*                                                                               
GPWD200  EQU   *                                                                
         B     GPWDOK                                                           
         DROP  R3                                                               
*                                                                               
GPWDERR1 EQU   *                                                                
         LA    RE,ACRSPWE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPWDNO                                                           
*                                                                               
GPWDERR2 EQU   *                                                                
         LA    RE,ACRSPWE2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPWDNO                                                           
*                                                                               
GPWDERR3 EQU   *                                                                
         LA    RE,ACRSPWE3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GPWDNO                                                           
*                                                                               
GPWDOK   SR    RC,RC                                                            
GPWDNO   LTR   RC,RC                                                            
GPWDX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET OFFICE RECORD VALUES FOR USER AUTHENTICATION                              
***********************************************************************         
*                                                                               
GETOFF   NTR1                                                                   
*                                                                               
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
*                                                                               
         LA    R2,IOKEY            INITIALIZE OFFICE RECORD KEY                 
         USING SAOFREC,R2                                                       
         XC    SAOFKEY,SAOFKEY                                                  
         MVI   SAOFTYP,SAOFTYPQ                                                 
         MVI   SAOFSUB,SAOFSUBQ                                                 
         MVC   SAOFAGY,ADUASAID                                                 
         MVC   SAOFOID,ADUAOFF                                                  
*                                                                               
         BAS   RE,READSA           READ RECORD                                  
         BNE   GOFFERR1                                                         
*                                                                               
         LA    R3,IOAREA+(SAOFDATA-SAOFREC)                                     
         USING SAOFFD,R3           FIND OFFICE ELEMENT                          
         XR    RF,RF                                                            
         IC    RF,SAOFFLN                                                       
         CLI   SAOFFEL,SAOFFELQ                                                 
         BE    *+8                                                              
         BXH   R3,RF,*-12                                                       
         AR    RF,R3               APPEND SPACES TO NAME                        
         MVC   0(L'SPACES,RF),SPACES                                            
         LA    R1,SAOFFNAM                                                      
         DROP  R3                                                               
*                                                                               
GOFFN10  LA    RF,L'ADUAOFFN       RF=L(OUTPUT)                                 
         LA    RF,L'SAOFFNAM                                                    
*                                                                               
         XR    RE,RE               COPY NAME INTO OUTPUT                        
         LA    RE,ADUAOFFN                                                      
         BCTR  RF,0                                                             
         EX    RF,*+4                                                           
         MVC   0(0,RE),0(R1)                                                    
*                                                                               
GOFF200  EQU   *                                                                
         B     GOFFOK                                                           
*                                                                               
GOFFERR1 EQU   *                                                                
         LA    RE,ACRSGOE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GOFFNO                                                           
*                                                                               
GOFFOK   SR    RC,RC                                                            
GOFFNO   LTR   RC,RC                                                            
GOFFX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET DEPARTMENT RECORD VALUES FOR USER AUTHENTICATION                          
***********************************************************************         
*                                                                               
GETDEP   NTR1                                                                   
*                                                                               
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
*                                                                               
         LA    R2,IOKEY            INITIALIZE OFFICE RECORD KEY                 
         USING SADPREC,R2                                                       
         XC    SADPKEY,SADPKEY                                                  
         MVI   SADPTYP,SADPTYPQ                                                 
         MVI   SADPSUB,SADPSUBQ                                                 
         MVC   SADPAGY,ADUASAID                                                 
         MVC   SADPOID,ADUAOFF                                                  
         MVC   SADPDID,ADUADEP                                                  
*                                                                               
         BAS   RE,READSA           READ RECORD                                  
         BNE   GDEPERR1                                                         
*                                                                               
         LA    R3,IOAREA+(SADPDATA-SADPREC)                                     
         USING SADPTD,R3           FIND DEPICE ELEMENT                          
         XR    RF,RF                                                            
         IC    RF,SADPTLN                                                       
         CLI   SADPTEL,SADPTELQ                                                 
         BE    *+8                                                              
         BXH   R3,RF,*-12                                                       
         AR    RF,R3               APPEND SPACES TO NAME                        
         MVC   0(L'SPACES,RF),SPACES                                            
         LA    R1,SADPTNAM                                                      
         DROP  R3                                                               
*                                                                               
GDEPN10  LA    RF,L'ADUADEPN       RF=L(OUTPUT)                                 
         LA    RF,L'SADPTNAM                                                    
*                                                                               
         XR    RE,RE               COPY NAME INTO OUTPUT                        
         LA    RE,ADUADEPN                                                      
         BCTR  RF,0                                                             
         EX    RF,*+4                                                           
         MVC   0(0,RE),0(R1)                                                    
*                                                                               
GDEP200  EQU   *                                                                
         B     GDEPOK                                                           
*                                                                               
GDEPERR1 EQU   *                                                                
         LA    RE,ACRSGDE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GDEPNO                                                           
*                                                                               
GDEPOK   SR    RC,RC                                                            
GDEPNO   LTR   RC,RC                                                            
GDEPX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* GET ACCESS GROUP RECORD VALUES FOR USER AUTHENTICATION                        
***********************************************************************         
*                                                                               
GETAGR   NTR1                                                                   
*                                                                               
         L     R4,AUTLSAVE                                                      
         USING UTLD,R4                                                          
*                                                                               
         CLC   ADUAAGCD,SPACES                                                  
         BE    GAGCOK                                                           
         OC    ADUAAGCD,ADUAAGCD                                                
         BZ    GAGCOK                                                           
         LA    R2,IOKEY            INITIALIZE OFFICE RECORD KEY                 
         USING SAAGREC,R2                                                       
         XC    SAAGKEY,SAAGKEY                                                  
         MVI   SAAGTYP,SAAGTYPQ                                                 
         MVI   SAAGSUB,SAAGSUBQ                                                 
         MVC   SAAGAGY,ADUASAID                                                 
         MVC   SAAGAGR,ADUAAGCD                                                 
*                                                                               
         BAS   RE,READSA           READ RECORD                                  
         BNE   GAGCERR1                                                         
*                                                                               
         LA    R3,IOAREA+(SAOFDATA-SAOFREC)                                     
         USING SAAGND,R3           FIND OFFICE ELEMENT                          
         XR    RF,RF                                                            
         IC    RF,SAAGNLN                                                       
         CLI   SAAGNEL,SAAGNELQ                                                 
         BE    *+8                                                              
         BXH   R3,RF,*-12                                                       
         AR    RF,R3               APPEND SPACES TO NAME                        
         MVC   0(L'SPACES,RF),SPACES                                            
         LA    R1,SAAGNNAM                                                      
         DROP  R3                                                               
*                                                                               
GAGCN10  LA    RF,L'ADUAAGNA       RF=L(OUTPUT)                                 
         LA    RF,L'SAAGNNAM                                                    
*                                                                               
         XR    RE,RE               COPY NAME INTO OUTPUT                        
         LA    RE,ADUAAGNA                                                      
         BCTR  RF,0                                                             
         EX    RF,*+4                                                           
         MVC   0(0,RE),0(R1)                                                    
*                                                                               
GAGC200  EQU   *                                                                
         B     GAGCOK                                                           
*                                                                               
GAGCERR1 EQU   *                                                                
         LA    RE,ACRSGGE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GAGCNO                                                           
*                                                                               
GAGCOK   SR    RC,RC                                                            
GAGCNO   LTR   RC,RC                                                            
GAGCX    XIT1                                                                   
***********************************************************************         
* SAVE TWA                                                                      
***********************************************************************         
*                                                                               
SAVETWA  NTR1                                                                   
         L     RE,ATWA             SAVE SCREEN TWA IN WORKING STORE             
         L     R0,ASAVE                                                         
         XR    R1,R1                                                            
         ICM   R1,7,SAVELEN                                                     
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* RESTORE TWA                                                                   
***********************************************************************         
*                                                                               
RESTTWA  NTR1                                                                   
         L     R0,ATWA             MOVE SAVED TWA DATA FROM STORAGE             
         L     RE,ASAVE                                                         
         XR    R1,R1                                                            
         ICM   R1,7,SAVELEN                                                     
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* SAVE UTL                                                                      
***********************************************************************         
*                                                                               
SAVEUTL  NTR1                                                                   
         L     RE,AUTL             SAVE UTL IN WORKING STORE                    
         L     R0,AUTLSAVE                                                      
         ICM   R1,15,=AL4(L'UTLSAVE)                                            
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* SWAP SAVED LOGICAL CONNECT DUMMY UTL                                          
***********************************************************************         
*                                                                               
SWAPUTL  NTR1                                                                   
         L     RE,AIOAREA          MOVE CURRENT UTL TO TEMP AREA                
         L     R0,AUTL                                                          
         ICM   R1,15,=AL4(L'UTLSAVE)                                            
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
         L     RE,AUTLSAVE                                                      
         L     R0,AUTL                                                          
         ICM   R1,15,=AL4(L'UTLSAVE)                                            
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     RE,AUTLSAVE         SAVE UTL                                     
         L     R0,AIOAREA                                                       
         ICM   R1,15,=AL4(L'UTLSAVE)                                            
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* SAVE TCB                                                                      
***********************************************************************         
*                                                                               
SAVETCB  NTR1                                                                   
         L     RE,ATCBTASK         SAVE TCB IN WORKING STORE                    
         L     R0,ATCBSAVE                                                      
         ICM   R1,15,=AL4(L'TCBSAVE)                                            
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* RESTORE TCB                                                                   
***********************************************************************         
*                                                                               
RESTTCB  NTR1                                                                   
         L     RE,ATCBTASK         MOVE SAVED TCB FROM STORAGE                  
         L     R0,ATCBSAVE                                                      
         ICM   R1,15,=AL4(L'TCBSAVE)                                            
         LR    RF,R1                                                            
         MVCL  RE,R0                                                            
         XIT1                                                                   
         EJECT                                                                  
* LOAD STRING OF DATA INTO UNPROTECTED TWA FIELD AT GIVEN RELATIVE              
* POSITION SETTING VALUES IN FIELD HEADER                                       
*                                                                               
*     PARAMETER 1 - A(DATA)                                                     
*     PARAMETER 2 - LENGTH DATA                                                 
*     PARAMETER 3 - FIELD NUMBER                                                
*                                                                               
*     ON RETURN.                                                                
*                                                                               
LOADFLD  NTR1                                                                   
         LM    R2,R4,0(R1)         R2=A(DATA), R3=LENGTH, R4=FLD#               
*                                                                               
         SR    RF,RF               FIND UNPROTECTED FIELD                       
         L     RE,ATWA             IN TWA                                       
         LA    RE,64(RE)                                                        
         USING FLDHDRD,RE                                                       
*                                                                               
LF10     TM    FLDATB,FATBPROT                                                  
         BZ    LF30                                                             
*                                                                               
LF20     IC    RF,FLDLEN           BUMP TO NEXT FIELD                           
         AR    RE,RF                                                            
         B     LF10                                                             
*                                                                               
LF30     BCT   R4,LF20             BUMP TO NEXT FIELD                           
*                                  SET FIELD HEADER STATUS                      
         OI    FLDIIND,X'80'       INPUT THIS TIME                              
*                                  SET FIELD HEADER STATUS                      
LF32     LTR   R3,R3                                                            
         BZ    LF34                                                             
         BCTR  R3,0                                                             
         LA    RF,0(R3,R2)                                                      
         CLI   0(RF),0                                                          
         BE    LF32                                                             
         CLI   0(RF),C' '                                                       
         BE    LF32                                                             
         LA    R3,1(R3)                                                         
LF34     STC   R3,FLDILEN          INPUT LENGTH                                 
         LTR   R3,R3                                                            
         BZ    LFX                                                              
         BCTR  R3,0                                                             
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   FLDDATA(0),0(R2)    MOVE IN DATA                                 
*                                                                               
         SR    R2,R2          SET NUM/ALPHA/HEX BITS FOR INPUT FIELD            
         IC    R2,FLDILEN                                                       
         LTR   R2,R2                                                            
         BZ    LFX                                                              
         LA    R3,FLDDATA                                                       
         OI    FLDIIND,B'00001110' SET BITS ON                                  
*                                                                               
LF40     TM    FLDATB,FATBLC       LOWER CASE TESTS                             
         BZ    LF50                                                             
         CLI   0(R3),X'81'         TEST LITTLE A                                
         BL    LF50A                                                            
         CLI   0(R3),X'A9'         TEST LITTLE Z                                
         BH    LF50                                                             
         NI    FLDIIND,B'11110101' FLD NOT NUM/HEX                              
         B     LF60                                                             
*                                                                               
LF50     CLI   0(R3),C'A'                                                       
         BNL   *+12                                                             
LF50A    NI    FLDIIND,B'11110001' FLD NOT NUM/ALPHA/HEX                        
         B     LF70                                                             
LF50B    CLI   0(R3),C'Z'                                                       
         BNH   LF50C                                                            
         NI    FLDIIND,B'11111011' FLD NOT ALPHA                                
         B     LF60                                                             
LF50C    NI    FLDIIND,B'11110111' FLD NOT NUM                                  
         CLI   0(R3),C'F'                                                       
         BNH   *+8                                                              
         NI    FLDIIND,B'11111101' FLD NOT HEX                                  
*                                                                               
LF60     LA    R3,1(R3)                                                         
         BCT   R2,LF40                                                          
*                                                                               
LF70     TM    FLDATB,FATBNUM      REQUIRED NUM FIELD                           
         BZ    LFX                 NO                                           
         TM    FLDIIND,X'08'       IS IT NUM                                    
         BO    LFX                 YES                                          
         OI    FLDIIND,X'10'       NO SET FLD INV                               
         B     LFX                                                              
*                                                                               
LFX      XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* READ IP RECORDS                                                     *         
*                                                                     *         
* NTRY:                                                               *         
* EXIT: CC = EQUAL IF RECORD FOUND                                    *         
***********************************************************************         
         SPACE 1                                                                
READIP   NTR1  ,                                                                
*                                                                               
READIPY  CR    RB,RB                                                            
         XIT1                                                                   
READIPN  LTR   RB,RB                                                            
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* ROUTINE TO READ SECURITY ACCESS RECORD                              *         
***********************************************************************         
         SPACE 1                                                                
READSA   NTR1  ,                                                                
         MVC   IOAREA(L'IOKEY),IOKEY                                            
         GOTO1 ADATAMGR,PARM,DMREAD,CTFILE,IOAREA,IOAREA                        
         XIT1  ,                                                                
         SPACE 3                                                                
***********************************************************************         
* ROUTINE TO READ HIGH FOR A SECURITY ACCESS RECORD                   *         
***********************************************************************         
         SPACE 1                                                                
RDHISA   NTR1  ,                                                                
         MVC   IOAREA(L'IOKEY),IOKEY                                            
         GOTO1 ADATAMGR,PARM,DMRDHI,CTFILE,IOAREA,IOAREA                        
         XIT1  ,                                                                
         SPACE 2                                                                
***********************************************************************         
* ROUTINE TO READ SEQUENTIAL FOR A SECURITY ACCESS RECORD             *         
***********************************************************************         
         SPACE 1                                                                
RDSQSA   NTR1  ,                                                                
         MVC   IOAREA(L'IOKEY),IOKEY                                            
         GOTO1 ADATAMGR,PARM,DMRDSQ,CTFILE,IOAREA,IOAREA                        
         XIT1  ,                                                                
         EJECT                                                                  
***********************************************************************         
* VALIDATE IP SUBNET ID MASK AND KEY                                            
* ENTRY: SNIDMASK = SUBNET ID MASK                                              
*        SNID = 128-BIT SUBNET ID                                               
***********************************************************************         
VALIPM   NTR1                                                                   
         XC    WORK,WORK                                                        
         MVC   WORK(L'SNID),SNID                                                
         MVC   WORK+L'SNID(L'SNID),IPRKSNID                                     
         XC    WORK,=32X'FF'                                                    
         NC    WORK(L'SNID),SNIDMASK                                            
         NC    WORK+L'SNID(L'SNID),SNIDMASK                                     
         CLC   WORK+L'SNID(L'SNID),WORK                                         
         BNE   VIPMERR1                                                         
         B     VIPMOK                                                           
*                                                                               
VIPMERR1 EQU   *                                                                
         LA    RE,ACRSIME1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VIPMNO                                                           
*                                                                               
VIPMOK   SR    RC,RC                                                            
VIPMNO   LTR   RC,RC                                                            
VIPMX    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* VALIDATE SUBNET ID                                                            
* ENTRY: SNIDSTRL = SUBNET ID STRING LENGTH                                     
*        SNIDSTRV = SUBNET ID STRING VALUE                                      
* EXIT:  SNID = 128-BIT SUBNET ID                                               
***********************************************************************         
VALSNID  NTR1                                                                   
         LA    RE,5                CHECK FIRST 5 CHAR FOR '.' OR ':'            
         LA    RF,SNIDSTRV                                                      
VSNID10  CLI   0(RF),C'.'                                                       
         BE    VSNID20             V4 SUBNET ID                                 
         CLI   0(RF),C':'                                                       
         BE    VSNID40             V6 SUBNET ID                                 
         AHI   RF,1                                                             
         BCT   RE,VSNID10                                                       
         B     VSNIDER1            INVALID SUBNET ID                            
*                                                                               
VSNID20  EQU   *                                                                
         BRAS  RE,VSNV4                                                         
         BNE   VSNIDX                                                           
         B     VSNID60                                                          
*                                                                               
VSNID40  EQU   *                                                                
         BRAS  RE,VSNV6                                                         
         BNE   VSNIDX                                                           
*                                                                               
VSNID60  XC    SNID,=16X'FF'       1'S COMPLEMENT                               
         B     VSNIDOK                                                          
*                                                                               
VSNIDER1 EQU   *                                                                
         LA    RE,ACRSSNE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNIDNO                                                          
*                                                                               
VSNIDOK  SR    RC,RC                                                            
VSNIDNO  LTR   RC,RC                                                            
VSNIDX   XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* VALIDATE V4 SUBNET ID                                                         
* ENTRY: SNIDSTRL = SUBNET ID STRING LENGTH                                     
*        SNIDSTRV = SUBNET ID STRING VALUE                                      
* EXIT:  SNID = 128-BIT SUBNET ID                                               
***********************************************************************         
VSNV4    NTR1                                                                   
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         LA    RF,SNIDSTRV                                                      
         XC    IPWORK(8*4),IPWORK                                               
         XC    FULL,FULL                                                        
*                                                                               
VSNV405  CLI   0(RF),C'.'          VALID CHAR ARE 0..9 OR '.'                   
         BE    VSNV410                                                          
         CLI   0(RF),C'0'                                                       
         BL    VSNV4ER1                                                         
         CLI   0(RF),C'9'                                                       
         BH    VSNV4ER2                                                         
VSNV410  AHI   RF,1                                                             
         BCT   RE,VSNV405                                                       
*                                                                               
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         LA    RF,SNIDSTRV                                                      
         LA    R3,IPWORK                                                        
*                                                                               
         LA    R4,0(RF,RE)                                                      
         BCTR  R4,0                                                             
         CLI   0(R4),C'.'                                                       
         BE    VSNV4ER3            LAST CHAR CAN'T BE '.'                       
*                                                                               
VSNV420  LA    R1,0                                                             
         LR    R4,RF                                                            
VSNV422  CLI   0(RF),C'.'                                                       
         BE    VSNV430                                                          
         AHI   RF,1                                                             
         AHI   R1,1                                                             
         BCT   RE,VSNV422                                                       
VSNV430  LTR   R1,R1               1-3 DIGIT FOR EACH NUMBER                    
         BZ    VSNV4ER4                                                         
         CHI   R1,3                                                             
         BH    VSNV4ER5                                                         
*                                  RIGHT-ALIGNED INTO THE FIELD                 
         LA    R5,4(R3)                                                         
         SR    R5,R1                                                            
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R5),0(R4)                                                    
*                                                                               
         AHI   RF,1                                                             
         AHI   R3,L'IPWORK                                                      
         LTR   RE,RE                                                            
         BZ    *+8                                                              
         BCT   RE,VSNV420                                                       
*                                                                               
         LA    RF,IPWORK                                                        
         SR    R3,RF               MUST BE 4 FIELDS FOR V4 SUBNET ID            
         CHI   R3,4*L'IPWORK                                                    
         BNE   VSNV4ER6                                                         
*                                  NOW 4 NUMBERS ARE IN 4 FULLWORD              
         LA    R3,IPWORK                                                        
         LA    R5,FULL                                                          
         LA    RE,4                                                             
*                                                                               
VSNV450  PACK  DUB,0(4,R3)         PACK, CONVERT TO BINARY                      
         CVB   RF,DUB                                                           
         CHI   RF,X'FF'                                                         
         BH    VSNV4ER7            CAN'T > 255                                  
         STC   RF,0(R5)                                                         
         AHI   R3,4                                                             
         AHI   R5,1                                                             
         BCT   RE,VSNV450                                                       
*                                                                               
         MVC   SNID(12),V4PREFIX                                                
         MVC   SNID+12(4),FULL                                                  
         B     VSNV4OK                                                          
*                                                                               
VSNV4OK  SR    RC,RC                                                            
VSNV4NO  LTR   RC,RC                                                            
         XIT1                                                                   
*                                                                               
VSNV4ER1 EQU   *                                                                
         LA    RE,ACRSV4E1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER2 EQU   *                                                                
         LA    RE,ACRSV4E2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER3 EQU   *                                                                
         LA    RE,ACRSV4E3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER4 EQU   *                                                                
         LA    RE,ACRSV4E4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER5 EQU   *                                                                
         LA    RE,ACRSV4E5                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER6 EQU   *                                                                
         LA    RE,ACRSV4E6                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
VSNV4ER7 EQU   *                                                                
         LA    RE,ACRSV4E7                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV4NO                                                          
*                                                                               
***********************************************************************         
* VALIDATE V6 SUBNET ID                                                         
* ENTRY: SNIDSTRL = SUBNET ID STRING LENGTH                                     
*        SNIDSTRV = SUBNET ID STRING VALUE                                      
* EXIT:  SNID = 128-BIT SUBNET ID                                               
***********************************************************************         
VSNV6    NTR1                                                                   
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         LA    RF,SNIDSTRV                                                      
*                                                                               
VSNV605  CLI   0(RF),C':'          VALID CHAR ARE 0..9, A..F OR ':'             
         BE    VSNV610                                                          
         CLI   0(RF),C'A'                                                       
         BL    VSNV6ER1                                                         
         CLI   0(RF),C'F'                                                       
         BNH   VSNV610                                                          
         CLI   0(RF),C'0'                                                       
         BL    VSNV6ER1                                                         
         CLI   0(RF),C'9'                                                       
         BH    VSNV6ER1                                                         
VSNV610  AHI   RF,1                                                             
         BCT   RE,VSNV605                                                       
*                                                                               
         LA    RF,SNIDSTRV         SUBNET ID                                    
         CLI   0(RF),C':'                                                       
         BNE   *+12                                                             
         CLI   1(RF),C':'                                                       
         BNE   VSNV6ER2            CAN'T HAVE LEADING SINGLE ':'                
*                                                                               
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         BCTR  RE,0                                                             
         AR    RF,RE               LAST CHAR                                    
         CLI   0(RF),C':'                                                       
         BNE   *+14                                                             
         BCTR  RF,0                                                             
         CLI   0(RF),C':'          2ND CHAR                                     
         BNE   VSNV6ER2            CAN'T HAVE TRAILING SINGLE ':'               
*                                                                               
         ZIC   RE,SNIDSTRL         SUBNET ID LENGTH                             
         BCTR  RE,0                                                             
         LA    RF,SNIDSTRV                                                      
*                                                                               
         SR    R0,R0               # OF FIELDS                                  
         SR    R1,R1               # OF '::'                                    
         CLC   0(2,RF),=C'::'                                                   
         BE    *+8                                                              
         AHI   R0,1                                                             
*                                                                               
VSNV620  CLC   0(2,RF),=C'::'                                                   
         BNE   *+12                                                             
         AHI   R1,1                                                             
         B     VSNV625                                                          
*                                                                               
         CLI   0(RF),C':'                                                       
         BNE   VSNV625                                                          
         AHI   R0,1                : FOLLOWED BY A CHAR, 1 FIELD                
*                                                                               
VSNV625  AHI   RF,1                                                             
         BCT   RE,VSNV620                                                       
*                                                                               
         LTR   R1,R1                                                            
         BNZ   *+16                                                             
         CHI   R0,8                                                             
         BNE   VSNV6ER3            MUST BE 8 FIELD WHEN NO '::'                 
         B     VSNV630                                                          
*                                                                               
         CHI   R1,1                                                             
         BH    VSNV6ER3            CAN'T HAVE MORE THAN 1 '::'                  
*                                  '::' = AT LEAST 2 FIELDS OF 0'S              
         MHI   R1,2                                                             
         AR    R1,R0                                                            
         CHI   R1,8                                                             
         BH    VSNV6ER4            CAN'T HAVE MORE THAN 8 FIELDS                
*                                                                               
*                                  R0 = # FIELD EXCLUDE '::'                    
VSNV630  LR    R6,R0                                                            
         LA    R3,IPWORK                                                        
         ZIC   R4,SNIDSTRL         SUBNET ID LENGTH                             
         LA    R5,SNIDSTRV         SUBNET ID                                    
         MVC   0(32,R3),=32C'0'    PADDED W/ 0'S                                
*                                                                               
VSNV635  CLC   0(2,R5),=C'::'                                                   
         BE    VSNV650                                                          
         CLI   0(R5),C':'                                                       
         BNE   *+10                                                             
         AHI   R5,1                                                             
         BCTR  R4,0                                                             
*                                                                               
         LR    RE,R5                                                            
VSNV640  CLI   0(R5),C':'                                                       
         BE    VSNV643                                                          
         AHI   R5,1                                                             
         BCT   R4,VSNV640                                                       
*                                                                               
VSNV643  LR    RF,R5                                                            
         SR    RF,RE                                                            
         LTR   RF,RF               1-4 DIGIT FOR EACH NUMBER                    
         BZ    VSNV6ER5                                                         
         CHI   RF,4                                                             
         BH    VSNV6ER5                                                         
*                                  RIGHT-ALIGNED INTO THE FIELD                 
         LA    R1,4(R3)                                                         
         SR    R1,RF                                                            
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(RE)                                                    
*                                                                               
         AHI   R3,L'IPWORK                                                      
         BCTR  R6,0                                                             
         LTR   R4,R4                                                            
         BZ    VSNV6X                                                           
         B     VSNV635                                                          
*                                                                               
VSNV650  LTR   R6,R6                                                            
         BZ    VSNV6X              NO MORE INPUT FIELD LEFT                     
         AHI   R5,2                BUMP PASS '::'                               
         AHI   R4,-2                                                            
         LA    R3,IPWORK+32                                                     
         LR    RE,R6                                                            
         MHI   RE,L'IPWORK                                                      
         SR    R3,RE               NEXT NON-ZERO FIELDS                         
         B     VSNV635                                                          
*                                                                               
VSNV6X   GOTO1 AHEXIN,PARM,IPWORK,SNID,32                                       
         B     VSNV6OK                                                          
*                                                                               
VSNV6OK  SR    RC,RC                                                            
VSNV6NO  LTR   RC,RC                                                            
         XIT1                                                                   
*                                                                               
VSNV6ER1 EQU   *                                                                
         LA    RE,ACRSV6E1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
VSNV6ER2 EQU   *                                                                
         LA    RE,ACRSV6E2                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
VSNV6ER3 EQU   *                                                                
         LA    RE,ACRSV6E3                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
VSNV6ER4 EQU   *                                                                
         LA    RE,ACRSV6E4                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
*                                                                               
VSNV6ER5 EQU   *                                                                
         LA    RE,ACRSV6E5                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     VSNV6NO                                                          
         EJECT                                                                  
***********************************************************************         
* LOAD NUMBER FROM STRING                                             *         
***********************************************************************         
         SPACE 1                                                                
LOADNUM  NTR1  ,                                                                
         LM    R2,R4,0(R1)                                                      
         XC    0(2,R2),0(R2)                                                    
         LTR   R4,R4                                                            
         BZ    LNUMOK                                                           
*                                                                               
LNUM010  CLI   0(R3),C'0'                                                       
         BL    LNUMOK                                                           
         CLI   0(R3),C'9'                                                       
         BH    LNUMOK                                                           
         MVC   BYTE,0(R3)                                                       
         NI    BYTE,X'0F'                                                       
         SR    RF,RF                                                            
         IC    RF,BYTE                                                          
         ICM   RE,3,0(R2)                                                       
         MH    RE,=H'10'                                                        
         AR    RE,RF                                                            
         STCM  RE,3,0(R2)                                                       
         LA    R3,1(R3)                                                         
         BCT   R4,LNUM010                                                       
         B     LNUMOK                                                           
*                                                                               
         SPACE 1                                                                
* INPUT ACTION ROUTINE RETURN POINTS                                            
*                                                                               
LNUMERRX EQU   *                                                                
         B     LNUMNO                                                           
*                                                                               
LNUMOK   SR    RC,RC                                                            
LNUMNO   LTR   RC,RC                                                            
         XIT1  ,                                                                
         EJECT                                                                  
***********************************************************************         
* FIND IF INPUT USER-ID IS COMPATIBLE WITH A RECORD                             
* ON ENTRY R2=A(RECORD) (IP RECORD)                                             
***********************************************************************         
         SPACE 1                                                                
VALID    NTR1                                                                   
         XC    PARM(32),PARM                                                    
*&&UK*&& MVC   PARM+4(4),=X'D9000AF9'                                           
*&&US*&& MVC   PARM+4(4),=X'D9000AFA'                                           
         GOTO1 ACALLOV,PARM,,,0                                                 
         CLI   4(R1),X'FF'                                                      
         BE    VALIDN                                                           
         MVC   AGETIDS,0(R1)                                                    
         MVC   DUB(2),0(R2)        SAVE RECORD TYPE                             
VALID0   MVI   GETOVER,0           CLEAR GETID OVERFLOW FLAG                    
         L     RF,ATIA                                                          
         GOTO1 AGETIDS,PARM,(C'C',(R2)),(RF),(C'S',ADATAMGR),          X        
               USERID,IDOSID                                                    
         TM    4(R1),X'08'         TEST GETID OUTPUT BLOCK OVERFLOW             
         BZ    *+8                                                              
         MVI   GETOVER,X'FF'       FLAG OVERFLOW ERROR IN GETIDS                
         TM    4(R1),X'01'         TEST GETIDS PARAMETER ERROR                  
         BNZ   VALID1                                                           
         CLI   12(R1),X'04'        TEST SPECIAL WILDCARD MATCH                  
         BE    VALIDY              YES CAN TREAT AS VALID                       
         CLI   8(R1),0             TEST COMPATIBLE ID COUNT BYTE 2              
         BNE   VALID4                                                           
         CLI   0(R1),0             TEST COMPATIBLE ID COUNT BYTE 1              
         BNE   VALID4                                                           
VALID1   CLI   0(R2),CT0KTEQU      IF AN AUTH RECORD                            
         BE    VALIDY              ID NEED NOT BE COMPATIBLE                    
         CLI   0(R2),C'3'          IS THIS AN IP RECORD                         
         BNE   VALID1A                                                          
         CLI   1(R2),C'I'                                                       
         BNE   VALID1A                                                          
         B     VALID1B                                                          
VALID1A  CLI   0(R2),C'T'          IS THIS A TERMINAL RECORD                    
         BNE   VALIDN              NO - EXIT                                    
VALID1B  LA    R1,CTTDATA-CTTREC(R2)                                            
         SR    R0,R0               FIND PRINCIPAL ID ELEMENT                    
*                                                                               
VALID2   CLI   0(R1),0             TEST E-O-R                                   
         BE    VALIDN                                                           
         CLI   0(R1),X'1F'         PRINCIPAL ID                                 
         BE    *+14                                                             
         IC    R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     VALID2                                                           
VALID2A  CLC   USERID,CTPID-CTPIDD(R1)                                          
         BE    VALIDY                                                           
         USING CTIREC,R2                                                        
         LA    R2,IOKEY                                                         
         XC    CTIKEY,CTIKEY                                                    
         MVI   CTIKTYP,C'I'                                                     
         MVC   CTIKID,CTPID-CTPIDD(R1)                                          
         BAS   RE,READSA                                                        
         BNE   VALIDN              CAN'T READ - IS INVALID                      
         L     R2,AIOAREA                                                       
         B     VALID0              OK GO GET COMPATIBLE ID'S                    
VALID4   L     R1,4(R1)            R1=A(COMPATIBLE ID LIST)                     
         LA    R1,0(R1)                                                         
         CLI   DUB,C'T'                                                         
         BE    VALID5                                                           
         CLI   DUB,C'3'                                                         
         BNE   VALID6                                                           
         CLI   DUB+1,C'I'                                                       
         BNE   VALID6                                                           
VALID5   MVI   ALLVALID,C'N'                                                    
VALID6   CLI   0(R1),X'FF'         TEST E-O-L                                   
         BE    VALIDN                                                           
         CLC   0(10,R1),=CL10'ALL'                                              
         BNE   VALID8                                                           
         CLI   DDSUSER,C'Y'        ALL ONLY VALID FOR DDS TERMINALS             
         BNE   VALID10                                                          
*        TM    TSTAT,TSTATDDS      ALL ONLY VALID FOR DDS TERMINALS             
*        BZ    VALID10                                                          
         MVI   ALLVALID,C'Y'                                                    
         B     VALIDY                                                           
VALID8   CLC   0(10,R1),USERID     MATCH ID WITH TABLE                          
         BE    VALIDY                                                           
VALID10  LA    R1,12(R1)                                                        
         B     VALID6                                                           
VALIDY   CR    RB,RB               SET CC=EQUAL IF ID OK                        
         XIT1                                                                   
VALIDN   LTR   RB,RB               SET CC=NOT EQUAL IF ID NOT OK                
         XIT1                                                                   
         DROP  R2                                                               
         LTORG                                                                  
*                                                                               
         DS    0D                                                               
AMASTC   DC    A(0)                                                             
CSYSFAC  DC    A(0)                                                             
*                                                                               
OFFLMODE DC    C' '                                                             
OMMASTQ  EQU   C'M'                                                             
OMTSOBQ  EQU   C'B'                                                             
ONEK     EQU   1024                                                             
*                                                                               
         DS    0D                                                               
         SPACE 2                                                                
*                                                                               
SPACES   DC    CL132' '                                                         
EFFS     DC    X'FFFFFFFFFFFFFFFF'                                              
MASKS    DC    X'8040201008040201'                                              
KEYV4PF  DC    X'FFFFFFFFFFFFFFFFFFFF0000'    V4 IP PREFIX (1S COMPL)           
V4PREFIX DC    X'00000000000000000000FFFF'    IP V4 ADDRESS PREFIX              
*                                                                               
DMREAD   DC    C'DMREAD '          FOR DATA MANAGER CALLS                       
DMRDHI   DC    C'DMRDHI '                                                       
DMRDSQ   DC    C'DMRSEQ '                                                       
CTFILE   DC    C'CTFILE '                                                       
         DS    0D                                                               
       ++INCLUDE FACIDTAB                                                       
         DROP  RB,RA,R9                                                         
         EJECT                                                                  
***********************************************************************         
* GET PROGRAM AUTHORISATION FROM SYSTEM ELEMENTS                                
**********************************************************************          
         SPACE 1                                                                
GETAUT   NTR1  BASE=*                                                           
         XC    UIDPAUTH,UIDPAUTH                                                
         XC    PIDPAUTH,PIDPAUTH                                                
         XC    PGMAUTH,PGMAUTH                                                  
         L     R0,AUIDSYS                                                       
         BAS   RE,SETEXPEL         GET EXTENDED ELEMENT                         
         LA    RE,EXPIDEL          NEW ELEMENT                                  
         USING CTSYSD,RE                                                        
         MVC   UIDPAUTH,CTSYSALL   SET PROGRAM AUTH FROM ID REC                 
         ZIC   R1,PGMCODE                                                       
         SLL   R1,1                                                             
         CLI   CTSYSLEN,16                                                      
         BNH   *+14                                                             
         LA    RE,CTSYSPGM-2(R1)                                                
         MVC   UIDPAUTH,0(RE)                                                   
         L     R0,APIDSYS                                                       
         BAS   RE,SETEXPEL         GET EXTENDED ELEMENT                         
         LA    RE,EXPIDEL          NEW ELEMENT                                  
         USING CTSYSD,RE                                                        
         MVC   PIDPAUTH,CTSYSALL   SET PROGRAM AUTH FROM PASSWORD               
         ZIC   R1,PGMCODE                                                       
         SLL   R1,1                                                             
         CLI   CTSYSLEN,16                                                      
         BNH   *+14                                                             
         LA    RE,CTSYSPGM-2(R1)                                                
         MVC   PIDPAUTH,0(RE)                                                   
*                                                                               
         MVC   PGMAUTH,PIDPAUTH                                                 
         NC    PGMAUTH,UIDPAUTH                                                 
         OC    PGMAUTH,PGMAUTH                                                  
         BZ    GAUTERR1                                                         
         B     GAUTOK                                                           
*                                                                               
GAUTERR1 EQU   *                                                                
         LA    RE,ACRSAUE1                                                      
         ST    RE,REASCODE                                                      
         MVI   RETCODE,ACRCERR1                                                 
         B     GAUTNO                                                           
*                                                                               
GAUTOK   SR    RC,RC                                                            
GAUTNO   LTR   RC,RC                                                            
         XIT1  ,                                                                
         DROP  RE                                                               
         EJECT                                                                  
SETEXPEL NTR1                                                                   
         LR    R1,R0               R0=A(SYSTEM AUTHORIZATION ELEMENT)           
         MVC   EXPIDEL(80),0(R1)   COPY TO MAX OF ELEMENT                       
         USING CTSYSD,R1                                                        
         TM    5(R1),X'80'         NEW FORMAT?                                  
         BZ    SETEXPLX            NO, EXIT                                     
*                                                                               
         LA    RE,256              INITIALISE ALL SLOTS TO DEF PGM AUTH         
         LA    RF,EXPIDEL+16                                                    
         MVC   0(2,RF),CTSYSALL                                                 
         LA    RF,2(RF)                                                         
         BCT   RE,*-10                                                          
*                                                                               
         SR    RE,RE                                                            
         ZIC   RF,CTSYSLEN                                                      
         SH    RF,=H'16'                                                        
         BNP   SETEXPLM            NO PROGRAM, EXIT                             
         D     RE,=F'3'            GET # OF PROGRAMS, NOT 0                     
         LTR   RE,RE               ANY REMAINDER?                               
         BNZ   SETEXPLX            SHOULDN'T BE ANY                             
*                                                                               
         LA    R3,CTSYSPGM         POINT TO FIRST ENTRY                         
         LA    R4,EXPIDEL+16                                                    
SETEXPLP ZIC   RE,0(R3)            GET THE PROGRAM #                            
         BCTR  RE,0                -1 FOR OFFSET                                
         SLL   RE,1                                                             
         AR    RE,R4               ADDRESS INTO EXPIDEL                         
         MVC   0(2,RE),1(R3)       COPY AUTHORIZATION CODE FOR PROG             
         LA    R3,3(R3)            NEXT ENTRY                                   
         BCT   RF,SETEXPLP         LOOP UNTIL ALL ARE COPIED                    
SETEXPLM CLI   CTSYSNUM,X'0A'      TEST FOR CONTROL SYSTEM ELEMENT              
         BNE   SETEXPLX                                                         
         CLI   PGMCODE,X'0C'       TEST PROG=MAD                                
         BNE   SETEXPLX                                                         
*                                  IF SO SET MAD=MAX AUTH OVERIDE               
         MVC   EXPIDEL+CTSYSALL-CTSYSD(2),=XL2'FFFF'                            
         LA    R4,EXPIDEL+16                                                    
         LA    RE,X'0C'                                                         
         BCTR  RE,0                                                             
         SLL   RE,1                                                             
         AR    RE,R4                                                            
         MVC   0(2,RE),=XL2'FFFF'                                               
SETEXPLX XIT1                                                                   
         DROP  R1                                                               
         LTORG                                                                  
***********************************************************************         
* GET PROGRAM LIMIT ACCESS FROM SYSTEM ELEMENTS                                 
***********************************************************************         
         SPACE 1                                                                
GETLAC   NTR1  BASE=*                                                           
         LA    RE,PGMLACC                                                       
         ICM   RF,15,=AL4(L'PGMLACC)                                            
         LA    R0,*                                                             
         ICM   R1,15,=XL4'40000000'                                             
         MVCL  RE,R0                                                            
*                                                                               
         XC    UIDLACC,UIDLACC                                                  
         XC    PIDLACC,PIDLACC                                                  
         OC    AUIDSYS,AUIDSYS                                                  
         BZ    GLAC010                                                          
         L     R3,AUIDSYS                                                       
         USING CTSYSD,R3                                                        
         MVC   UIDLACC,CTSYSLMT                                                 
GLAC010  EQU   *                                                                
         OC    APIDSYS,APIDSYS                                                  
         BZ    GLAC020                                                          
         L     R3,APIDSYS                                                       
         USING CTSYSD,R3                                                        
         MVC   PIDLACC,CTSYSLMT                                                 
GLAC020  EQU   *                                                                
         MVC   PGMLACC(4),PIDLACC                                               
         OC    PGMLACC(4),PGMLACC                                               
         BNZ   GLACOK                                                           
         MVC   PGMLACC(4),UIDLACC                                               
         OC    PGMLACC(4),PGMLACC                                               
         BNZ   GLACOK                                                           
         MVC   PGMLACC(4),=CL4'    '                                            
         B     GLACOK                                                           
*                                                                               
GLACOK   SR    RC,RC                                                            
GLACNO   LTR   RC,RC                                                            
         XIT1  ,                                                                
         DROP  R3                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* LITERALS AND CONSTANTS                                              *         
***********************************************************************         
         SPACE 1                                                                
         LTORG                                                                  
         EJECT                                                                  
         PRINT OFF                                                              
* SRPCIFF                                                                       
       ++INCLUDE SRPCIFFD                                                       
* SEACSFILE                                                                     
       ++INCLUDE SEACSFILE                                                      
* CTGENFILE                                                                     
       ++INCLUDE CTGENFILE                                                      
* CTGENWEB                                                                      
       ++INCLUDE CTGENWEB                                                       
* FASECRETD                                                                     
       ++INCLUDE FASECRETD                                                      
* FADSECTS                                                                      
       ++INCLUDE FADSECTS                                                       
* DDFLDHDR                                                                      
       ++INCLUDE DDFLDHDR                                                       
* DDSPOOK                                                                       
       ++INCLUDE DDSPOOK                                                        
* DDMASTD                                                                       
       ++INCLUDE DDMASTD                                                        
* DDCOMFACS                                                                     
       ++INCLUDE DDCOMFACS                                                      
* FATABSDEQU                                                                    
       ++INCLUDE FATABSDEQU                                                     
* FATABSDAR                                                                     
       ++INCLUDE FATABSDAR                                                      
* DMSPACED                                                                      
       ++INCLUDE DMSPACED                                                       
* FACIDTABD                                                                     
       ++INCLUDE FACIDTABD                                                      
         EJECT                                                                  
         PRINT ON                                                               
* DDACCESSD                                                                     
       ++INCLUDE DDACCESSD                                                      
         EJECT                                                                  
***********************************************************************         
* LOCAL WORKING STORAGE                                               *         
***********************************************************************         
         SPACE 1                                                                
WORKD    DSECT                                                                  
DUB      DS    D                                                                
PARM     DS    8A                                                               
RELO     DS    F                                                                
*                                                                               
APARMS   DS    A                                                                
SRPARMS  DS    8A                                                               
*                                                                               
ASYSFAC  DS    A                                                                
AMSGQIN  DS    A                                                                
ASSB     DS    A                                                                
ATCB     DS    A                                                                
ATCBTASK DS    A                                                                
AUTLTAB  DS    A                                                                
AUTL     DS    A                                                                
ALCM     DS    A                                                                
ATWA     DS    A                                                                
ATIA     DS    A                                                                
ACOMFACS DS    A                                                                
ASELIST  DS    A                                                                
AMAP     DS    A                                                                
ATIOB    DS    A                                                                
ASAVE    DS    A                                                                
SAVELEN  DS    XL4                                                              
SAVESCRN DS    XL1                                                              
ALOAD    DS    A                                                                
AUIDSYS  DS    A                                                                
APIDSYS  DS    A                                                                
*                                                                               
ADATAMGR DS    A                                                                
ADMOD000 DS    A                                                                
AFINDSYS DS    A                                                                
ADATCON  DS    A                                                                
ACALLOV  DS    A                                                                
ASECRET  DS    A                                                                
AHEXOUT  DS    A                                                                
AHEXIN   DS    A                                                                
AGETIDS  DS    A                                                                
*                                                                               
FULL     DS    F                                                                
HALF     DS    H                                                                
BYTE     DS    X                                                                
PGMCODE  DS    X                                                                
SYSCODE  DS    X                                                                
*                                                                               
USERID   DS    CL10                                                             
*                                                                               
UIDNUM   DS    XL2                                                              
PIDNUM   DS    XL2                                                              
AGRNUM   DS    XL2                                                              
UIDLACC  DS    CL4                                                              
PIDLACC  DS    CL4                                                              
*                                                                               
DATE     DS    CL12                                                             
DAYTODAY DS    PL1                 PWOS DAY TODAY                               
TIME     DS    PL4                 TIME NOW                                     
TODAYB   DS    XL2                 TODAYS DATE BINARY COMPRESSED                
*                                                                               
*                                                                               
WORK     DS    CL255                                                            
*                                                                               
RETCODE  DS    XL1                                                              
REASCODE DS    F                                                                
CONTROL  DS    CL8                 GO, SHUTDOWN, OR RESTART                     
*                                                                               
RCOUT    DS    XL8                                                              
ERROR    DS    XL1                                                              
*                                                                               
WTOMSG   DS    CL255                                                            
*                                                                               
TSRSAVE  DS    XL2                 UTL TSVCREQ VALUE SAVE                       
*                                                                               
ACTN     DS    XL1                 ACCPACTN                                     
*                                                                               
SAVETSYS DS    XL1                                                              
*                                                                               
INDICS   DS    XL1                 * INDICATORS *                               
INDIOSP  EQU   X'80'               OVERRIDE SYSTEM/PROGRAM                      
INDIAGY  EQU   X'40'               MAIN AGENCY ACCESS RECORD                    
*                                                                               
IOKEY    DS    XL(L'SAASKEY)       IO KEY                                       
*                                                                               
AIOAREA  DS    A                                                                
AUTLSAVE DS    A                                                                
ATCBSAVE DS    A                                                                
ASECBLOC DS    A                                                                
*                                                                               
IPWORK   DS    8F                                                               
SNIDSTRV DS    XL40                SUBNET ID STRING VALUE                       
SNIDSTRL DS    XL1                 SUBNET ID STRING LENGTH                      
SNID     DS    XL16                SUBNET ID                                    
SNIDMASK DS    XL16                SUBNET ID                                    
IPRKSNID DS    XL16                IP SUBNET RECORD KEY                         
SAGY     DS    CL2                                                              
EFFDATE  DS    XL2                                                              
ALLVALID DS    C                   C'Y' IF 'ALL' IDS COMPAT WITH TERM           
SESYSN   DS    X                   SYSTEM NUMBER                                
IDOSID   DS    CL10                ALPHA USER-ID                                
USERNO   DS    XL2                 NUMERIC USER-ID                              
UIDPAUTH DS    XL2                 USER ID PROGRAM AUTH                         
PIDPAUTH DS    XL2                 PASSWORD PROGRAM AUTH                        
PGMAUTH  DS    XL2                 RESOLVED PROGRAM AUTH                        
PGMLACC  DS    CL36                RESOLVED PROGRAM LIMIT ACCESS                
ADVID    DS    CL4                 FACPAK ADV ID                                
*                                                                               
PASSREQD DS    XL1                 PASSWORD REQUIRED FOR SYSTEM X'80'           
DDSUSER  DS    CL1                 DDSUSER=Y                                    
SVTSTAT1 DS    CL1                 DDSUSER=Y                                    
SVTVIFLG DS    CL1                 DDSUSER=Y                                    
*                                                                               
GETOVER  DS    XL1                 GETIDS OUTPUT BLOCK OVERFLOW ERROR           
*                                                                               
PERSONID DS    CL(L'SAPEPID)       PERSONAL ID CODE                             
AGROUPNO DS    CL(L'SAAGCNUM)      PERSON ACCESS GROUP CODE NUMBER              
LGROUPCD DS    CL(L'SALACCOD)      PERSON LIMIT ACCESS GROUP CODE               
LAGVALUE DS    CL(L'SALASALL)      PERSON LIMIT ACCESS GROUP CODE               
*                                                                               
*                                                                               
SYSNAME  DS    CL7                 SYSTEM NAME SAVED FROM SCREEN FLD            
SYSNLEN  DS    XL1                 SYSTEM NAME LENGTH                           
*                                                                               
*                                                                               
IDTYPE   DS    C                   USER ID TYPE FROM ID RECORD                  
PIDREQD  DS    X                   PERSONAL ID REQUIRED FLAG                    
PEXPIRY  DS    X                   COUNT OF DAYS FOR EXPIRY                     
PEXPWARN DS    X                   COUNT OF DAYS FOR EXPIRY WARNING             
PREUSE   DS    X                   COUNT OF NUMBER OF REPEATS                   
PMINLEN  DS    X                   MINIMUM LENGTH OF PASSWORD                   
PEXPIRED DS    X                   C'Y' IF PASSWORD EXPIRED                     
*                                                                               
WEBCNTLS DS    CL3                 WEB CONTROLS                                 
ACCNETID DS    CL40                NET ID                                       
ACCESSCD DS    CL16                ACCESS CODE                                  
PWDPID   DS    CL8                 PID FROM PWD                                 
*                                                                               
EXPIDEL  DS    XL528               NEW SYSTEM AUTHORIZATION ELEMENT             
UIDSYSEL DS    XL255               UID SYSTEM AUTHORIZATION ELEMENT             
PIDSYSEL DS    XL255               PID SYSTEM AUTHORIZATION ELEMENT             
*                                                                               
IOAREA   DS    XL1024                                                           
UTLSAVE  DS    XL(TUTLXALN)                                                     
TCBSAVE  DS    XL1024                                                           
SECBLOC  DS    XL1024                                                           
*                                                                               
WORKX    DS    0X                                                               
         SPACE 2                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'029DDACCESSU 08/11/03'                                      
         END                                                                    
