*          DATA SET SP133      AT LEVEL 012 AS OF 09/19/19                      
*PROCESS USING(WARN(15))                                                        
*CATALP SP133                                                                   
         TITLE 'SP133 - SPTFILE DAILY ACTIVITY REPORT'                          
SP133    CSECT                                                                  
         ENTRY SP133WRK                                                         
         ENTRY UTL                                                              
         ENTRY SSB                                                              
         ENTRY SP133BLD                                                         
         PRINT NOGEN                                                            
*                                                                               
         NBASE 0,**SP133,VREGSAVE,RA,R7                                         
*                                                                               
         ST    RD,SP133RD                                                       
*                                                                               
         L     RC,=A(SP133WRK)                                                  
         USING SP133WRK,RC                                                      
*                                                                               
         L     R9,=V(CPRINT)                                                    
         USING DPRINT,R9                                                        
         ZAP   MAXLINE,=P'58'      SET MAXLINES                                 
*                                                                               
         XC    WORK,WORK                                                        
         ST    RB,WORK                                                          
         L     RE,=V(DUMMY)        DUMMY FOLLOWS REGSAVE                        
         ST    RE,WORK+4                                                        
         OI    WORK+4,X'80'                                                     
         GOTO1 =V(STXITER),DMCB,WORK                                            
*                                                                               
         LHI   RE,SVREC-REC        ESTABLISH ADDRESSABILITY TO SVREC            
         LA    RE,REC(RE)                                                       
         ST    RE,ASVREC                                                        
         XC    DATLEN,DATLEN                                                    
         MVC   DATLEN(2),=H'10'                                                 
*                                                                               
         XC    DMCB(12),DMCB                                                    
         L     RE,=A(SORTCARD)                                                  
         ST    RE,DMCB+0                                                        
         L     RE,=A(RECCARD)                                                   
         ST    RE,DMCB+4                                                        
         GOTO1 =V(SORTER),DMCB                                                  
         B     INIT2                                                            
*                                                                               
VREGSAVE DC    V(REGSAVE)                                                       
         EJECT                                                                  
INIT2    GOTO1 =V(CARDS),DMCB,CARD,=C'RE00'                                     
         MVC   P(80),CARD                                                       
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CLC   =C'DDSIO=',CARD                                                  
         BNE   INIT3                                                            
         L     RE,=V(DDSIO)                                                     
         MVC   0(8,RE),CARD+6                                                   
         B     INIT2                                                            
*                                                                               
INIT3    CLC   =C'DSPACE=',CARD                                                 
         BNE   INIT4                                                            
         L     RE,=A(SSB)                                                       
         MVC   SSODSPAC-SSOOFF(1,RE),CARD+7                                     
         B     INIT2                                                            
*                                                                               
INIT4    XC    DATLEN,DATLEN                                                    
         MVC   DATLEN(2),=H'10'                                                 
         CLC   =C'SPOT',CARD       SPOTX....                                    
         BNE   IERR                                                             
                                                                                
***********************************************************************         
* LOCATE SPOT SYSTEM AND GET SENUM. OPTIONAL AGENCY ALPHA ALSO        *         
* CONVERT TO USE TWO CHR SYSTEM NAME SPOTXYAA WHERE XY=SYS AND AA=AGY *         
***********************************************************************         
                                                                                
GETSE    CLI   CARD+7,C' '         SPOTXAA > SPOTX AA                           
         BNE   GETSE1                                                           
         CLI   CARD+6,C' '                                                      
         BE    GETSE1                                                           
         ICM   R0,3,CARD+5         MOVE AGY CODE ONE BYTE TO RIGHT              
         MVI   CARD+5,C' '                                                      
         STCM  R0,3,CARD+6                                                      
*                                                                               
GETSE1   MVC   SESNAM+7(2),CARD+4  EXTRACT ONE/TWO CHR SYSTEM ID                
*                                                                               
GETSEX   GOTO1 =V(DMDDNAME),DMCB,(X'24',=C'DDNAME'),SESNAM,0                    
         CLI   8(R1),0                                                          
         BNE   GETSEXER                                                         
         L     RF,8(R1)            GET A(FILE INFO LIST)                        
         MVC   SESNUM,1(RF)        EXTRACT SENUM                                
         L     RE,=A(UTL)          MOVE TO UTL                                  
         MVC   TSYS-UTLD(,RE),SESNUM                                            
         B     GETSEXOK                                                         
*                                                                               
GETSEXER B     IERR                ERROR                                        
GETSEXOK B     INIT8               VALID                                        
*                                                                               
SESNAM   DC    C'SYS=SPT##'                                                     
SESNUM   DC    X'00'                                                            
         EJECT                                                                  
IERR     MVC   P(30),=C'** ERROR * SYSTEM NOT VALID **'                         
         GOTO1 =V(LOGIO),DMCB,1,(30,P)                                          
         GOTO1 =V(PRINTER)                                                      
CANCEL   DC    0H'0'                                                            
         ABEND 999                                                              
*                                                                               
INIT8    MVC   SVSYS,CARD          SPOTXYAA - MODIFIED INPUT CARD               
*                                                                               
INIT10   ZAP   LINE,=P'99'                                                      
*                                                                               
INIT12   GOTO1 =V(CARDS),DMCB,CARD,=C'RE00'                                     
         CLI   CARD,C'*'           IGNORE COMMENTS                              
         BE    INIT12                                                           
         MVC   P(80),CARD                                                       
         GOTO1 =V(PRINTER)                                                      
         CLC   =C'/*',CARD                                                      
         BE    INIT14                                                           
*                                                                               
         CLC   =C'ESTHDR=DUMP',CARD                                             
         BNE   *+12                                                             
         MVI   ESTSW,C'D'                                                       
         B     INIT12                                                           
*                                                                               
         CLC   =C'ESTHDR=REST',CARD                                             
         BNE   *+12                                                             
         MVI   ESTSW,C'R'                                                       
         B     INIT12                                                           
*                                                                               
         CLC   =C'ESTHDR=IGN',CARD                                              
         BNE   *+12                                                             
         MVI   ESTSW,C'I'                                                       
         B     INIT12                                                           
*                                                                               
         CLC   =C'WRITE=NO',CARD                                                
         BNE   *+16                                                             
         MVI   FLIST,C' '          SUPPRESS EOF SEARCH ON SPTFILE               
         MVI   WRITESW,C'N'                                                     
         B     INIT12                                                           
*                                                                               
         CLC   =C'PRINT=D',CARD                                                 
         BNE   *+12                                                             
         MVI   DTLSW,C'Y'                                                       
         B     INIT12                                                           
*                                                                               
         CLC   =C'CLRSUM=Y',CARD                                                
         BNE   *+12                                                             
         MVI   CLRSUMSW,C'Y'                                                    
         B     INIT12                                                           
*                                                                               
         CLC   =C'PAYPROG=N',CARD   EXCLUDE PAY PROGRAM TRANSACTIONS            
         BNE   *+12                                                             
         MVI   PAYPRGSW,C'N'                                                    
         B     INIT12                                                           
*                                                                               
         LAY   RE,TOWHO                                                         
         CLC   =C'EID=',CARD       RECIPIENT LIST VIA PARAMETER CARD            
         BNE   *+14                                                             
         MVC   0(L'TOWHO,RE),CARD+4                                             
         B     INIT12                                                           
*                                                                               
         L     RE,=A(EMAILSW)                                                   
         CLC   =C'EMAIL=NO',CARD                                                
         BNE   *+12                                                             
         MVI   0(RE),C'N'                                                       
         B     INIT12                                                           
*                                                                               
         CLC   =C'TEST=ROLL',CARD                                               
         BNE   *+12                                                             
         MVI   TESTSW,C'R'                                                      
         B     INIT12                                                           
*                                                                               
         CLC   =C'TEST=CLEAR',CARD                                              
         BNE   *+12                                                             
         MVI   TESTSW,C'C'                                                      
         B     INIT12                                                           
*                                                                               
         MVI   GSTSW,C'Y'          ALWAYS PRINT GST!                            
         CLC   =C'GST',CARD                                                     
         BNE   *+12                                                             
         MVI   GSTSW,C'Y'                                                       
         B     INIT12                                                           
*                                                                               
         CLC   =C'TRACE',CARD                                                   
         BNE   *+12                                                             
         MVI   TRACESW,C'Y'                                                     
         B     INIT12                                                           
*                                                                               
         CLC   =C'PFM=Y',CARD      *** ALSO FOR NFL!!! ***                      
         BNE   *+12                                                             
         MVI   PFMSW,C'Y'                                                       
         B     INIT12                                                           
*                                                                               
         CLC   =C'DATE',CARD                                                    
         BNE   INIT12A                                                          
         GOTO1 =V(DATVAL),DMCB,(0,CARD+5),TODAYQ                                
         MVC   SPECDATE(5),=C'DATE='   OVERRIDE DATE FOR PRINTING               
         MVC   SPECDATE+5(6),TODAYQ                                             
         OC    0(4,R1),0(R1)           NOW TEST IT WAS VALID                    
         BNZ   INIT12                                                           
         MVC   P(27),=C'*ERROR* INVALID DATE FORMAT'                            
         B     INIT13A                                                          
                                                                                
*======================================================*                        
* THIS FEATURE ONLY WORKS WHEN YOU LINK WITH DATAMGR   *                        
* IT DOES NOT WORK WITH LOADABLE DATAMGR               *                        
*======================================================*                        
                                                                                
INIT12A  CLC   =C'UPDID=',CARD     THIS ALLOWS CONC FILE UPDATE                 
         BNE   INIT12B                                                          
         GOTO1 =V(DATAMGR),DMCB,=C'UPDID'                                       
         L     RF,12(R1)                                                        
         MVC   0(2,RF),CARD+6                                                   
         B     INIT12                                                           
                                                                                
INIT12B  CLC   =C'GETRATE=',CARD   THIS ALLOWS TEST VERSION                     
         BNE   INIT12C                                                          
         MVC   GETRTOVR,CARD+8                                                  
         MVC   P(1),GETRTOVR                                                    
         MVC   P+2(27),=C'VERSION OF GETRATE WILL RUN'                          
         GOTO1 =V(PRINTER)                                                      
         B     INIT12                                                           
*                                                                               
INIT12C  CLC   =C'ERRSUM=',CARD   ERROR SUMMARY ONLY?                           
         BNE   INIT12D                                                          
         MVC   ERRSUM,CARD+7                                                    
         B     INIT12                                                           
*                                                                               
INIT12D  CLC   =C'STAPACK=',CARD  STAPACK OVERRIDE CARD                         
         BNE   INIT12E                                                          
         MVC   STAPOVR,CARD+8                                                   
         MVC   P(1),STAPOVR                                                     
         MVC   P+2(27),=C'VERSION OF STAPACK WILL RUN'                          
         GOTO1 =V(PRINTER)                                                      
         B     INIT12                                                           
*                                                                               
INIT12E  CLC   =C'DSPACE=',CARD                                                 
         BNE   INIT13                                                           
         L     RE,=A(SSB)                                                       
         MVC   SSODSPAC-SSOOFF(1,RE),CARD+7                                     
         B     INIT12                                                           
         EJECT                                                                  
INIT13   MVC   P(30),=C'*ERROR* UNKNOWN PARAMETER CARD'                         
INIT13A  DS    0H                                                               
         GOTO1 =V(LOGIO),DMCB,1,(30,P)                                          
         GOTO1 =V(PRINTER)                                                      
         B     CANCEL                                                           
*                                                                               
INIT14   DC    0H'0'                                                            
         OC    TODAYQ,TODAYQ                                                    
         BNZ   INIT14A                                                          
         GOTO1 =V(DATCON),DMCB,(5,0),(0,TODAYQ)                                 
*                                                                               
INIT14A  GOTO1 =V(DATCON),DMCB,(0,TODAYQ),(3,TODAYB)                            
         GOTO1 (RF),(R1),,(2,TODAYP2)                                           
         GOTO1 (RF),(R1),,(1,TODAYP3)                                           
*                                                                               
         LA    R4,ADCONS                                                        
         LA    R5,(ADCONX-ADCONS)/4                                             
*                                                                               
INIT14B  MVC   DUB,SPACES                                                       
         MVC   DUB(4),=C'T00A'                                                  
         MVC   WORK(1),0(R4)          FIRST CHAR IS MODULE EQUATE               
         GOTO1 VHEXOUT,DMCB,WORK,DUB+4,1,0                                      
*                                                                               
         CLI   WORK,QGETRATE                                                    
         BNE   *+10                                                             
         MVC   DUB+6(1),GETRTOVR   APPEND VERSION OVERRIDE                      
*                                                                               
         CLI   WORK,QSTAPACK                                                    
         BNE   *+10                                                             
         MVC   DUB+6(1),STAPOVR                                                 
*                                                                               
         GOTO1 VLOADER,DMCB,DUB,0                                               
         ICM   RE,15,4(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    RE,0(R4)            OVERWRITE EQUATE WITH ADDRESS                
*                                                                               
         LA    R4,4(R4)                                                         
         BCT   R5,INIT14B                                                       
*                                                                               
         L     R1,=A(STAWORK)      PASS A(T00A9E) TO STAPACK                    
         XC    0(32,R1),0(R1)                                                   
         USING STAPACKD,R1                                                      
*                                                                               
         MVI   STAPACT,QSTP_T00A9E                                              
         MVC   STAPACOM,CABLETAB                                                
         GOTO1 STAPACK,(R1)                                                     
*                                                                               
* OPEN FILES                                                                    
*                                                                               
         GOTO1 =V(DATAMGR),DMCB,=C'DMOPEN',=C'SPOT',FLIST,REC                   
         MVC   TITLE(31),=CL31'SPOTXY DAILY ACTIVITY REPORT'                    
         MVC   TITLE(6),SVSYS                                                   
*                                                                               
         CLI   ESTSW,C'D'                                                       
         BNE   INIT16                                                           
         GOTO1 =V(SP133DMP)                                                     
         B     INITX                                                            
INIT16   CLI   ESTSW,C'R'                                                       
         BNE   INIT18                                                           
         GOTO1 =V(SP133RST)                                                     
         B     INITX                                                            
INIT18   CLI   ESTSW,C'I'                                                       
         BE    INITX                                                            
         DC    H'0'                                                             
*                                                                               
FLIST    DS    0H                                                               
         DC    CL8'USPTFILE'                                                    
         DC    CL8' SPTDIR '                                                    
         DC    CL8' STAFIL '                                                    
         DC    CL8'X       '                                                    
*                                                                               
INITX    OPEN  (RCVTAPE,(INPUT))                                                
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
         EJECT                                                                  
*=====================================================*                         
* READ THE AGENCY HEADERS AND BUILD A TABLE           *                         
* THAT IDENTIFIES AGENCY AS US OR CANADIAN            *                         
*=====================================================*                         
                                                                                
         XC    AGYTAB,AGYTAB                                                    
         XC    KEY,KEY                                                          
         MVI   KEY,6                                                            
         BAS   RE,HIGH                                                          
         B     BLDAG4                                                           
*                                                                               
BLDAG2   BAS   RE,SEQ                                                           
*                                                                               
BLDAG4   CLI   KEY,6                                                            
         BNE   BLDAGX                                                           
         L     R6,=A(AGYHDR)                                                    
         ST    R6,AIOAREA                                                       
         BAS   RE,GETREC                                                        
*                                                                               
         LA    R6,24(R6)                                                        
         SR    R0,R0                                                            
*                                                                               
BLDAG6   IC    R0,1(R6)                                                         
         AR    R6,R0                                                            
         CLI   0(R6),0                                                          
         BE    BLDAG2                                                           
         CLI   0(R6),2             FIND A MEDIA ELEMENT                         
         BNE   BLDAG6                                                           
         ZIC   RE,3(R6)            GET AG/MD BYTE                               
         SRL   RE,4                DROP MEDIA                                   
         SLL   RE,2                X4                                           
         LA    RE,AGYTAB(RE)                                                    
         CLI   0(RE),0             TEST SOMETHING THERE ALREADY                 
         BNE   BLDAG2              YES - SKIP                                   
         L     RF,=A(AGYHDR)                                                    
         MVC   0(2,RE),1(RF)       MOVE AGYALPHA TO TABLE                       
         LA    RF,AGYPROF+7-AGYHDR(RF)                                          
         MVC   2(1,RE),0(RF)       MOVE COUNTRY CODE TO TABLE                   
         B     BLDAG2                                                           
*                                                                               
BLDAGX   DS    0H                                                               
         EJECT                                                                  
GET      L     R1,=A(RCVTAPE)                                                   
         LA    R0,REC-4                                                         
         GET   (1),(0)                                                          
*                                                                               
         CLI   DM$RSIN,DM$RBACKOUT IGNORE DELETED RECORD                        
         BE    GET                                                              
         TM    DM$RRECTY,X'80'     IGNORE POINTER COPIES/CHANGES                
         BO    GET                                                              
*                                                                               
         AP    TOTCTR,=P'1'                                                     
*                                                                               
         CLI   DM$RFILTY,QREQFIL   TEST REQUEST FILE                            
         BNE   *+14                                                             
         CLC   =C'30',QTYPE        TEST CHECK REQUEST                           
         BE    GET40                                                            
         CLI   DM$RFILTY,QSPTFIL   TEST SPTFILE                                 
         BNE   GET                                                              
*                                                                               
         CLC   REC-4(2),=H'52'     MIN SPTFILE RECLEN                           
         BNH   GET                 MUST BE A BAD RECORD                         
* FIX FOR NEW RECOVERY WHICH LEAVES JUNK IN RECORD                              
         LA    RE,REC+24           POINT TO KEY                                 
         SR    R0,R0                                                            
         ICM   R0,3,13(RE)         GET LOGICAL REC LEN                          
         AR    RE,R0                                                            
         XC    0(2,RE),0(RE)       MAKE SURE 00 AT END OF ELS                   
*                                                                               
         CLI   PFMSW,C'Y'          TEST TO INCLUDE PFM/NFL RECORDS              
         BE    GETA                                                             
         CLI   DM$RPRG,X'01'       TEST PFM                                     
         BE    GET                                                              
         CLI   DM$RPRG,X'27'       OR NFL (THANKS ANNIE!)                       
         BE    GET                                                              
*                                                                               
GETA     CLI   PAYPRGSW,C'N'       TEST EXCLUDE PAY PROGRAM                     
         BNE   *+12                                                             
         CLI   DM$RPRG,X'13'       TEST SPOT PAY                                
         BE    GET                                                              
*                                                                               
         LA    R2,BUYREC                                                        
         CLI   BUYKEY,X'10'        TEST BUYREC                                  
         BL    GET                                                              
         TM    BUYREC,X'08'        TEST 'ORIGINAL' BUY                          
         BO    GET                 IGNORE                                       
         CLC   BDELEM(2),BDELID                                                 
         BNE   GET                                                              
         B     GET01                                                            
*                                                                               
BDELID   DC    X'01',AL1(BDELEMX-BDELEM)  ELCODE/LENGTH                         
*                                                                               
* IF WRITE=NO, CAN LIMIT RUN TO 1 AGENCY                                        
*                                                                               
GET01    CLI   WRITESW,C'N'                                                     
         BNE   GET1                                                             
         CLC   SVSYS+6(2),SPACES                                                
         BE    GET1                                                             
         CLC   SVSYS+6(2),BUYALPHA  MATCH ALPHA AGY CODE                        
         BNE   GET                                                              
*                                                                               
* SET ZERO ELEMENT CODE AT E-O-R                                                
*                                                                               
GET1     LH    R1,REC-4                                                         
         LA    R1,REC-4(R1)                                                     
         XC    0(2,R1),0(R1)                                                    
*                                                                               
         LA    RE,CPYCTR                                                        
         CLI   DM$RRECTY,DM$RRECTCPY   COPY                                     
         BE    GET2                                                             
         LA    RE,CHGCTR                                                        
         CLI   DM$RRECTY,DM$RRECTCHG   CHANGE                                   
         BE    GET2                                                             
         LA    RE,ADDCTR                                                        
         CLI   DM$RRECTY,DM$RRECTADD   ADD                                      
         BE    GET2                                                             
         AP    UNKCTR,=P'1'                                                     
         MVC   P(24),=C'*ERROR* UNKNOWN REC TYPE'                               
         GOTO1 =V(PRINTER)                                                      
         LH    R0,REC-4                                                         
         SHI   R0,4                                                             
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRNTBL),DMCB,0,REC,C'DUMP',(R0),=C'1D'                        
         GOTO1 =V(PRINTER)                                                      
         B     GET                                                              
*                                                                               
GET2     AP    0(4,RE),=P'1'                                                    
         L     RE,SEQNO                                                         
         AHI   RE,1                                                             
         ST    RE,SEQNO                                                         
*                                                                               
         CLI   DM$RRECTY,DM$RRECTADD TEST ADD                                   
         BE    GET4                                                             
                                                                                
*********************************                                               
* IGNORE CHANGES WITHOUT COPIES *                                               
*********************************                                               
         CLI   DM$RSIN,DM$ROCHGOLY    OFF-LINE CHANGE WITH NO COPY?             
         BE    GET                    YES, IGNORE CHANGE WITHOUT COPY           
         OC    DM$RSIN,DM$RSIN        OFF-LINE CHANGE WITH NO COPY?             
         BZ    GET                    YES, IGNORE CHANGE WITH NO COPY           
*                                                                               
GET4     L     RE,ASVREC                                                        
         LA    RE,DM$RRECTY-DM$RECVHDR(RE)                                      
         CLI   0(RE),DM$RRECTCPY   TEST PREVIOUS REC A COPY                     
         BNE   GET10               NO                                           
                                                                                
***********************************************                                 
* PREVIOUS REC A COPY - THIS SHOULD BE CHANGE                                   
***********************************************                                 
         CLI   DM$RRECTY,DM$RRECTCHG                                            
         BNE   GETERR                                                           
         L     RE,ASVREC                                                        
         LA    RE,DM$RSIN-DM$RECVHDR(RE)                                        
         CLC   DM$RSIN+1(3),1(RE)  TEST SAME SIN                                
         BNE   GETERR                                                           
         L     RE,ASVREC                                                        
         CLC   BUYKEY(13),24(RE)                                                
         BE    GET5                                                             
*                                                                               
         CLI   BUYKEY,X'10'        ARE WE LOOKING AT A BUY KEY?                 
         BNH   GETERR              NO, THEN WE HAVE MORE PROBLEMS               
                                                                                
* FOLLOWING INSTRUCTIONS SUPPORT COMPARE THROUGH LINE NUMBER ONLY               
                                                                                
         LA    RF,11               SET FOR 12 BYTE KEY COMPARE                  
         TM    BUYRCNTL,BUYRLN2    TEST 2-BYTE LINE NUMBERS                     
         BO    *+8                                                              
         LA    RF,10               SET FOR 11 BYTE KEY COMPARE                  
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   BUYKEY(0),24(RE)    YES, DON'T WORRY ABOUT LAST BYTE             
         BNE   GETERR               OR 2 OF BUYKBUY                             
*                                                                               
GET5     L     RE,ASVREC                                                        
         LA    RE,DM$RRECTY-DM$RECVHDR(RE)                                      
         MVI   0(RE),X'FF'         UNFLAG COPY REC                              
         B     GET20                                                            
                                                                                
**************************************                                          
* DISPLAY COPY WITHOUT CHANGE ERROR                                             
**************************************                                          
GETERR   MVC   P(29),=C'*ERROR* MISSING CHANGE RECORD'                          
         GOTO1 =V(LOGIO),DMCB,1,(29,P)                                          
         GOTO1 =V(PRINTER)                                                      
         GOTO1 (RF),(R1)                                                        
         L     R4,ASVREC                                                        
         LR    R5,R4                                                            
         SH    R5,=H'4'                                                         
         LH    R5,0(R5)                                                         
         SH    R5,=H'4'                                                         
         GOTO1 =V(PRNTBL),DMCB,0,(R4),C'DUMP',(R5),=C'1D'                       
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         ZAP   LINE,=P'99'                                                      
         AP    CPYCHCTR,=P'1'                                                   
         B     GET20                                                            
*                                                                               
* PREVIOUS REC NOT A COPY - THIS SHOULD NOT BE CHANGE                           
*                                                                               
GET10    CLI   DM$RRECTY,DM$RRECTCHG                                            
         BNE   GET20                                                            
                                                                                
*************************************                                           
* DISPLAY CHANGE WITHOUT COPY ERROR                                             
*************************************                                           
GET12    MVC   P(27),=C'*ERROR* MISSING COPY RECORD'                            
         GOTO1 =V(LOGIO),DMCB,1,(27,P)                                          
         GOTO1 =V(PRINTER)                                                      
         GOTO1 (RF),(R1)                                                        
         LH    R0,REC-4                                                         
         SH    R0,=H'4'                                                         
         GOTO1 =V(PRNTBL),DMCB,0,REC,C'DUMP',(R0),=C'1D'                        
         GOTO1 =V(PRINTER)                                                      
         ZAP   LINE,=P'99'                                                      
         AP    CPYCHCTR,=P'1'                                                   
         B     GET                 NO FURTHER PROECESSING POSSIBLE              
*                                                                               
GET20    DS    0H                                                               
         CLC   INVREC(2),=X'0E19'   WW REC                                      
         BNE   GET25                                                            
         GOTO1 =V(SP133WW)                                                      
         B     GET27                                                            
*                                                                               
GET25    CLI   BUYREC,X'10'        TEST A BUY RECORD                            
         BL    GET27               NO - SKIP BUILD ROUTINE                      
         GOTO1 =V(SP133BLD)        BUILD DOLLAR TABLE                           
*                                                                               
GET27    CLI   DM$RRECTY,DM$RRECTCPY                                            
         BNE   GET30                                                            
* SAVE COPY RECORD                                                              
         LA    R2,REC-4                                                         
         SR    R3,R3                                                            
         ICM   R3,3,0(R2)                                                       
         L     R4,ASVREC                                                        
         AHI   R4,-4                                                            
         LA    R5,2(R3)            SET RECLEN+2                                 
         MVCL  R4,R2                                                            
         B     GET                                                              
                                                                                
***********************                                                         
* PUT RECORDS TO SORT                                                           
***********************                                                         
         USING SRTRECD,R8                                                       
GET30    CLC   =X'0E19',BUYREC     TEST WUNDERMAN INVOICE                       
         BE    *+12                                                             
         CLI   BUYREC,X'10'        TEST FOR A BUY RECORD YET AGAIN              
         BL    GET                 NO - IGNORE                                  
         L     R8,=A(SRTBUFF)                                                   
*NOP     CLI   TRACESW,C'Y'                                                     
*NOP     BNE   GET32                                                            
*NOP     LH    R0,REC-4                                                         
*NOP     GOTO1 =V(PRNTBL),DMCB,=C'RCVREC',REC,C'DUMP',(R0),=C'1D'               
*                                                                               
GET32    MVI   DUB,0                                                            
         LA    R4,SRTEL                                                         
         CLI   0(R4),0             TEST NO BUCKETS                              
         BE    GET36                                                            
*                                                                               
GET34    CLC   2(L'SRTBCKTS-2,R4),=6PL6'0' TEST DOLLARS PRESENT                 
         BE    *+8                                                              
         MVI   DUB,C'$'            SET ACTIVITY FLAG                            
         LA    R4,L'SRTBCKTS(R4)                                                
         CLI   0(R4),0                                                          
         BNE   GET34                                                            
*                                                                               
GET35    CLI   DUB,0               TEST ACTIVITY                                
         BE    GET36               NO                                           
* CALCULATE REC LEN                                                             
         LA    R0,SRTLEN                                                        
         SR    R4,R0                                                            
         LA    R4,1(R4)            ADD X'00' TO REC FOR E-O-R FLAG              
         STH   R4,SRTLEN                                                        
*                                                                               
         CLI   ERRSUM,C'Y'                                                      
         BE    GET36                                                            
         GOTO1 =V(SORTER),DMCB,=C'PUT',(R8)                                     
*                                                                               
         CLI   TRACESW,C'Y'                                                     
         BNE   GET36                                                            
**NOP    CLI   SRTTYPE,C'P'                                                     
**NOP    BNE   GET36                                                            
         LH    R0,SRTLEN                                                        
         GOTO1 =V(PRNTBL),DMCB,=C'PUT',(R8),C'DUMP',(R0),=C'1D'                 
*                                                                               
GET36    LA    R8,SRTRECLN(R8)                                                  
         CLI   SRTKEY,0            TEST MORE RECS                               
         BNE   GET32                                                            
*                                                                               
         B     GET                                                              
         EJECT                                                                  
* PUT INVOICE RECORD TO SORT                                                    
*                                                                               
GET40    L     R8,=A(SRTBUFF)                                                   
         XC    SRTREC(256),SRTREC                                               
         XC    SRTREC+256(256),SRTREC+256                                       
*                                                                               
* VALIDATE CHECK AMOUNT IS PRESENT                                              
         MVC   DUB(1),QAMT+4       AMOUNT FIELD IS NOW PACKED                   
         NI    DUB,X'0C'                                                        
         CLI   DUB,X'0C'           SHOULD NOW END IN X'0C'                      
         BNE   GET                                                              
* VALIDATE START DATE VALID                                                     
         GOTO1 =V(GETDAY),DMCB,QSTART,WORK                                      
         CLC   WORK(3),SPACES                                                   
         BE    GET                                                              
* TEST SINGLE AGENCY OPTION (TESTING ONLY)                                      
         CLI   WRITESW,C'N'                                                     
         BNE   GET43                                                            
         CLC   SVSYS+6(2),SPACES                                                
         BE    GET43                                                            
         CLC   SVSYS+6(2),QAGY                                                  
         BNE   GET                                                              
GET43    DC    0H'0'                                                            
*                                                                               
         MVI   SRTTYPE,C'P'                                                     
         MVC   SRTAGY(2),QAGY                                                   
         IC    R0,DM$RAG                                                        
         STC   R0,SRTAGMD                                                       
         LA    RE,1                                                             
         CLI   QMED,C'T'                                                        
         BE    GET45                                                            
         LA    RE,2                                                             
         CLI   QMED,C'R'                                                        
         BE    GET45                                                            
         LA    RE,3                                                             
         CLI   QMED,C'N'                                                        
         BE    GET45                                                            
         LA    RE,4                                                             
         CLI   QMED,C'X'                                                        
         BE    GET45                                                            
         B     GET                 UNKNOWN MEDIA-IGNORE                         
*                                                                               
GET45    EX    RE,*+8                                                           
         B     *+8                                                              
         OI    SRTAGMD,0  *EXECUTED*                                            
*                                                                               
         GOTO1 CLPACK,DMCB,QCLT,SRPCLT                                          
         MVC   SRPSIN,DM$RSIN+1                                                 
         CLI   QSTA+4,C' '                                                      
         BNE   *+8                                                              
         MVI   QSTA+4,C'T'                                                      
                                                                                
*========================================================*                      
* BRILLIANTLY DROPPING THE MARKET FROM CLEARANCE REQUESTS*                      
* MEANS WE HAVE TO GET IT FROM THE STATION FILE NOW      *                      
*========================================================*                      
                                                                                
GET47    DS    0H                                                               
         XC    KEY,KEY                                                          
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY                                                    
         MVI   KEY,C'S'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(5),QSTA                                                    
         MVC   KEY+7(2),QAGY                                                    
         MVC   KEY+9(3),QCLT                                                    
*                                                                               
         L     R6,=A(STAREC)                                                    
         ST    R6,AIOAREA                                                       
         USING STAREC,R6                                                        
*                                                                               
         GOTO1 =V(DATAMGR),DMCB,=C'DMREAD',=C'STATION',KEY,AIOAREA              
         CLC   KEY(9),0(R6)                                                     
         BE    GET49                                                            
         MVC   SMKT,=4C'0'                                                      
*                                                                               
GET49    DS    0H                                                               
         L     R1,=A(STAWORK)                                                   
         XC    0(32,R1),0(R1)                                                   
         USING STAPACKD,R1                                                      
*                                                                               
         MVI   STAPACT,C'P'                                                     
         MVC   STAPAGY,QAGY                                                     
         MVC   STAPMED,QMED                                                     
         MVC   STAPACOM,=A(COMFACS)                                             
         MVC   STAPQMKT,SMKT                                                    
         MVC   STAPQSTA(5),QSTA                                                 
*                                                                               
         LA    RE,AGYTAB                                                        
         LA    RF,16                                                            
GET50    CLC   0(2,RE),QAGY                                                     
         BE    GET52                                                            
         LA    RE,4(RE)                                                         
         BCT   RF,GET50                                                         
         DC    H'0'                                                             
GET52    MVC   STAPCTRY,2(RE)      MOVE COUNTRY CODE                            
*                                                                               
         GOTO1 STAPACK,(R1)                                                     
         CLI   STAPERR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   SRPSTA,STAPSTA                                                   
         MVC   SRPSTAPR,STAPSTA    MOVE PRINTABLE STATION                       
         CLI   STAPCTRY,C'C'       TEST CANADA                                  
         BE    GET54                                                            
         CLI   SRPSTA,X'E8'        TEST CABLE                                   
         BL    *+8                                                              
         NI    SRPSTA+2,X'80'      DROP NETWORK BITS FOR SORT                   
         DROP  R1                                                               
*                                                                               
GET54    MVC   SRTBCKTS(160),QAREA  MOVE CHECK REQ                              
         LA    R0,185                                                           
         STH   R0,SRTLEN                                                        
         GOTO1 =V(SORTER),DMCB,=C'PUT',(R8)                                     
         B     GET                                                              
         DROP  R6                                                               
         EJECT                                                                  
INPUTEOF DC    0H'0'                                                            
         CLOSE (RCVTAPE)                                                        
*                                                                               
         L     RE,=A(HEAD)                                                      
         MVC   MID1(110),0(RE)                                                  
         ZAP   LINE,=P'200'                                                     
*                                                                               
OUT2     DC    0H'0'                                                            
         GOTO1 =V(SORTER),DMCB,=C'GET'                                          
         L     R2,4(R1)                                                         
         LTR   R2,R2                                                            
         BNZ   OUT3                                                             
* E-O-F -- SET SVREC TO X'FF'                                                   
         L     R2,ASVREC                                                        
         MVI   0(R2),X'FF'                                                      
         MVC   1(200,R2),0(R2)                                                  
         B     OUT4                                                             
* MOVE SORT REC TO SVREC SO CAN SEE IT IN DUMPS                                 
*                                                                               
OUT3     LH    R3,0(R2)            GET 'FROM' REC LEN                           
         L     RE,ASVREC           SET 'TO' REC ADDR                            
         LA    RF,2(R3)            SET 'TO' LEN = 'FROM' LEN + 2                
         MVCL  RE,R2                                                            
*                                                                               
OUT4     L     R8,ASVREC                                                        
         USING SRTRECD,R8                                                       
*                                                                               
         CLI   FIRSTSW,0           TEST FIRST TIME                              
         BE    OUT6                NO                                           
         CLI   SRTREC,X'FF'        TEST E-O-F                                   
         BNE   OUT6                                                             
         MVC   P(16),=C'NO INPUT RECORDS'                                       
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         B     XBASEXIT                                                         
*                                                                               
OUT6     CLI   SRTTYPE,C'P'        TEST PAYMENT REC                             
         BE    OUTPAY                                                           
*                                                                               
         CLC   SVSRT(11),SRTKEY    T/A/M/C/P/E/STA                              
         BE    OUT20                                                            
         CLI   SVSRT,C'A'          TEST PREVIOUS ANALYSIS REC                   
         BNE   OUT10               NO - NO TOTALS REQ'D                         
         BAS   RE,ENDSTA                                                        
         B     OUT10                                                            
         EJECT                                                                  
OUT10    DC    0H'0'                                                            
*                                                                               
OUT12    L     RE,=A(AGYHDR)                                                    
         CLC   SRTAGY(2),1(RE)     TEST SAME AGY                                
         BE    OUT14                                                            
         XC    KEY,KEY                                                          
         MVI   KEY,6                                                            
         MVC   KEY+1(2),SRTAGY                                                  
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BNE   AGYRDERR                                                         
         L     RE,=A(AGYHDR)                                                    
         ST    RE,AIOAREA                                                       
         BAS   RE,GETREC                                                        
         BNE   AGYRDERR                                                         
         MVC   AGYDA,KEY+14                                                     
         L     RE,=A(CLTHDR)                                                    
         XC    0(13,RE),0(RE)                                                   
*                                                                               
* CHECK NEW CLTHDR REQ'D                                                        
*                                                                               
OUT14    L     RE,=A(CLTHDR)                                                    
         CLC   SRTAGMD(3),1(RE)                                                 
         BE    OUT16                                                            
         XC    KEY,KEY                                                          
         MVC   KEY+1(3),SRTAGMD                                                 
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BNE   CLTERR                                                           
         L     RE,=A(CLTHDR)                                                    
         ST    RE,AIOAREA                                                       
         BAS   RE,GETREC                                                        
         BNE   CLTERR                                                           
         MVC   CLTDA,KEY+14                                                     
         XC    ESTDA,ESTDA                                                      
         XC    EKEY,EKEY                                                        
         EJECT                                                                  
* SEE IF WE HAVE ESTHDR YET                                                     
*                                                                               
OUT16    CLC   SRTKEY(8),SVSRT      A/M/C/T/P/E                                 
         BE    OUT20                                                            
         CLC   SRTKEY(7),SVSRT      A/M/C/T/P                                   
         BE    OUT18                                                            
         OC    CLTDA,CLTDA         TEST CLTHDR FOUND                            
         BZ    OUT20                                                            
* LOOK UP NEW PRD CODE                                                          
         LA    R1,=C'POL'                                                       
         CLI   SRTPRD,X'FF'                                                     
         BE    OUT16X                                                           
*                                                                               
         L     R1,=A(CLTHDR)                                                    
         LA    R1,CLIST-CLTHDR(R1)                                              
OUT16A   CLC   SRTPRD,3(R1)                                                     
         BE    OUT16X                                                           
         LA    R1,4(R1)                                                         
         CLI   0(R1),C'A'                                                       
         BNL   OUT16A                                                           
         B     PRDERR                                                           
*                                                                               
OUT16X   XC    KEY,KEY                                                          
         MVC   KEY+1(3),SRTAGMD                                                 
         MVC   KEY+4(3),0(R1)                                                   
         B     *+10                                                             
*                                                                               
OUT18    MVC   KEY,EKEY                                                         
         MVC   KEY+7(1),SRTEST                                                  
         CLI   SRTEST,0                                                         
         BE    ESTERR                                                           
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BNE   ESTERR                                                           
         LA    RE,ESTHDR                                                        
         ST    RE,AIOAREA                                                       
         BAS   RE,GETREC                                                        
         BNE   ESTERR                                                           
         MVC   ESTDA,KEY+14        SAVE DISK ADDRESS                            
*                                                                               
         ZAP   ECURPDN,=P'0'       CLEAR CURRENT COUNTERS                       
*                                                                               
         MVC   ESTMON13,=X'FFFF'                                                
*                                                                               
OUT20    BAS   RE,FMTLIN           FORMAT PRINT LINE                            
         MVI   FIRSTSW,0           RESET SWITCH                                 
*                                                                               
         OC    ESTDA,ESTDA         TEST ESTHDR FOUND                            
         BZ    OUT24               NO - DON'T POST TO BUCKETS                   
*                                                                               
* POST TO EST BUCKETS                                                           
*                                                                               
         LA    R4,SRTBCKTS                                                      
SEL      USING SRTEL,R4                                                         
*                                                                               
OUT22    CLC   SEL.SRTEL,ESTMON13  TEST PAST 12TH MONTH (CHECK Y/M)             
         BL    *+10                NO                                           
         MVC   SEL.SRTEL,ESTMON12  FORCE TO MONTH 12                            
*                                                                               
         SR    R5,R5                                                            
         IC    R5,SEL.SRTEL+1      GET MONTH                                    
         BCTR  R5,0                                                             
         MHI   R5,6                GIVES DSPL                                   
*                                                                               
         LA    RE,EORD(R5)         POINT TO ORDERED TODAY                       
         AP    0(6,RE),SEL.SRTELOG ADD TO GROSS                                 
*                                                                               
         LA    RE,EORDNET(R5)                                                   
         AP    0(6,RE),SEL.SRTELON AND NET                                      
*                                                                               
         LA    RE,EPAID(R5)        POINT TO PAID TODAY                          
         AP    0(6,RE),SEL.SRTELPG ADD TO GROSS                                 
*                                                                               
         LA    RE,EPDNET(R5)                                                    
         AP    0(6,RE),SEL.SRTELPN AND NET                                      
*                                                                               
         AP    ECURPDN,SEL.SRTELPN PAID NET - TODAY                             
         AP    ECURPDN,SEL.SRTELGST ADD GST AMOUNT                              
         AP    ECURPDN,SEL.SRTELPST ADD PST AMOUNT                              
*                                                                               
         LA    R4,L'SRTBCKTS(R4)   NEXT BUCKET SET                              
         CLI   0(R4),0                                                          
         BNZ   OUT22                                                            
*                                                                               
OUT24    MVC   SVSRT,SRTKEY        SAVE SORT KEY                                
         B     OUT2                                                             
*                                                                               
         DROP  SEL                                                              
         EJECT                                                                  
* PROCESS PAYMENT RECORDS                                                       
*                                                                               
OUTPAY   DC    0H'0'                                                            
*                                                                               
         CLI   SVSRT,C'P'          TEST PREVIOUS A PAYMENT REC                  
         BE    OUTP5                                                            
         BAS   RE,ENDSTA           NO - PRINT ANALYSIS TOTALS                   
*                                                                               
         MVC   TITLE,SPACES                                                     
         MVC   TITLE(6),SVSYS                                                   
         MVC   TITLE+7(23),=C'** CLEARANCE SUMMARY **'                          
         MVC   MID1+48(30),=CL30'INVOICE NUMBER  INVOICE AMOUNT'                
         ZAP   LINE,=P'99'         FORCE NEW TITLE                              
         ZAP   PAGE,=P'1'                                                       
         MVC   SPACING,=C'BL01'    RESTORE SPACING OPTION                       
         L     RE,=A(CLTHDR)                                                    
         XC    0(13,RE),0(RE)      CLEAR CLTHDR KEY                             
         GOTO1 =V(PRINTER)         PRINT TITLES NOW                             
         B     OUTP10                                                           
*                                                                               
OUTP5    CLC   SVSRT(12),SRTKEY    T/A/M/STA/C/SIN                              
         BE    OUTP20                                                           
         BAS   RE,ENDPCLR          NO - PRINT CLEARANCE TOTALS                  
*                                                                               
         CLC   SVSRT(7),SRTKEY     T/A/M/STA                                    
         BE    OUTP10                                                           
         BAS   RE,ENDPSTA                                                       
*                                                                               
         CLC   SVSRT(4),SRTKEY     T/A/M                                        
         BE    OUTP10                                                           
         BAS   RE,ENDPMED                                                       
         L     RE,=A(CLTHDR)                                                    
         XC    0(13,RE),0(RE)      CLEAR CLTHDR KEY                             
*                                                                               
         CLC   SVSRT(3),SRTKEY     T/A                                          
         BE    OUTP10                                                           
         BAS   RE,ENDPAGY                                                       
*                                                                               
OUTP10   L     RE,=A(CLTHDR)                                                    
         CLC   SRPCLT,2(RE)        TEST NEW CLTHDR REQ'D                        
         BE    OUTP20              NO                                           
         XC    CLTDA,CLTDA                                                      
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),SRTAGMD                                                 
         MVC   KEY+2(2),SRPCLT                                                  
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BNE   CLTERR                                                           
         L     RE,=A(CLTHDR)                                                    
         ST    RE,AIOAREA                                                       
         BAS   RE,GETREC                                                        
         BNE   CLTERR                                                           
*                                                                               
         CLC   SRTAGY,THISAGY      SAME AGENCY ?                                
         BE    OUTP20                                                           
         LA    R1,AGYTAB                                                        
         LA    R0,16                                                            
OUTP12   CLC   SRTAGY,0(R1)                                                     
         BE    OUTP14                                                           
         LA    R1,4(R1)                                                         
         BCT   R0,OUTP12                                                        
         DC    H'0'                                                             
OUTP14   MVC   THISAGY,0(R1)       SET AGYALPHA/COUNTRY CODE                    
*                                                                               
OUTP20   OC    SRPPRD(3),SRPPRD    TEST INVOICE REC                             
         BNZ   OUTP21                                                           
***      CLI   CLRSUMSW,C'Y'                                                    
***      BNE   *+8                                                              
         BAS   RE,FMTINV                                                        
         B     OUTP21X                                                          
*                                                                               
OUTP21   BAS   RE,FMTLIN                                                        
*                                                                               
OUTP21X  MVC   SVSRT,SRTKEY                                                     
*                                                                               
         GOTO1 =V(SORTER),DMCB,=C'GET'                                          
         L     R2,4(R1)                                                         
         LTR   R2,R2                                                            
         BNZ   OUTP22                                                           
         L     R8,ASVREC                                                        
         MVI   0(R8),X'FF'                                                      
         MVC   1(14,R8),0(R8)                                                   
         B     OUTP25                                                           
*                                                                               
* MOVE SORT REC TO SVREC                                                        
*                                                                               
OUTP22   LH    R3,0(R2)                                                         
         L     RE,ASVREC                                                        
         LA    RF,2(R3)                                                         
         MVCL  RE,R2                                                            
*                                                                               
         L     R8,ASVREC                                                        
         CLI   SRTTYPE,C'P'                                                     
         BE    OUTP5                                                            
*                                                                               
OUTP25   BAS   RE,ENDPCLR                                                       
         BAS   RE,ENDPSTA                                                       
         BAS   RE,ENDPMED                                                       
         BAS   RE,ENDPAGY                                                       
         BAS   RE,ENDPFIL                                                       
         BRAS  RE,ERRCHECK         SEND EMAIL IF ERRORS                         
*                                                                               
         B     XBASEXIT                                                         
*                                                                               
* PRINT CLEARANCE TOTALS                                                        
*                                                                               
ENDPCLR  NTR1                                                                   
         ZAP   DUB,TOTSTA+24(8)    GET NET PAID                                 
         AP    DUB,TOTSTA+32(8)    ADD GST/PST PAID                             
         CP    DUB,INVTOT          COMPARE NETS INCLUDING GST/PST               
         BE    ENDPCLR4                                                         
*                                                                               
ENDPCLR2 MVC   PLIN(17),=C'** DISCREPANCY **'                                   
         AP    INVERRS,=P'1'                                                    
*                                                                               
ENDPCLR4 LA    R4,TOTSTA                                                        
         BAS   RE,FMTTOT1                                                       
*                                                                               
         CLI   CLRSUMSW,C'Y'       DON'T PRINT UNLESS CLRSUM REQD               
         BNE   ENDPCLRX                                                         
*                                                                               
         MVC   PORDG(15),=C'CLEARANCE TOTAL'                                    
         ZAP   DUB,MAXLINE                                                      
         ZAP   MAXLINE,=P'100'     SUPPRESS PAGING                              
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDPCLRX ZAP   MAXLINE,DUB                                                      
         ZAP   INVTOT,=P'0'                                                     
         MVC   P,SPACES                                                         
         B     EXIT                                                             
         EJECT                                                                  
* PRINT STATION TOTALS (IN TOTCLT)                                              
*                                                                               
ENDPSTA  NTR1                                                                   
         LA    R4,TOTEST                                                        
         LA    R0,NTOTS                                                         
         ZAP   0(8,R4),=P'0'       CLEAR EST TOTALS                             
         LA    R4,8(R4)                                                         
         BCT   R0,*-10                                                          
*                                                                               
         LA    R4,TOTPRD                                                        
         LA    R0,NTOTS                                                         
         ZAP   0(8,R4),=P'0'       CLEAR PRD TOTALS                             
         LA    R4,8(R4)                                                         
         BCT   R0,*-10                                                          
*                                                                               
         CLI   CLRSUMSW,C'Y'                                                    
         BNE   ENDPSTA2                                                         
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDPSTA2 LA    R4,TOTCLT                                                        
         BAS   RE,FMTTOT1                                                       
         MVC   PORDG+6(17),=C'* STATION TOTAL *'                                
         CLI   CLRSUMSW,C'Y'                                                    
         BNE   ENDPSTAX                                                         
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDPSTAX MVC   P,SPACES                                                         
         B     EXIT                                                             
*                                                                               
ENDPMED  NTR1                                                                   
         CLI   CLRSUMSW,C'Y'                                                    
         BNE   ENDPMED2                                                         
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDPMED2 LA    R4,TOTMED                                                        
         BAS   RE,FMTTOT                                                        
         CLI   CLRSUMSW,C'Y'                                                    
         BNE   ENDPMED4                                                         
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDPMED4 CLC   SVSRT(3),SRTKEY     T/A                                          
         BNE   *+10                                                             
         ZAP   LINE,=P'99'                                                      
         MVC   P,SPACES                                                         
         B     EXIT                                                             
         EJECT                                                                  
ENDPAGY  NTR1                                                                   
         XC    KEY,KEY                                                          
         MVI   KEY,6                                                            
         MVC   KEY+1(2),SRTAGY-SRTKEY+SVSRT                                     
         BAS   RE,HIGH                                                          
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,=A(AGYHDR)                                                    
         USING AGYHDRC,R6                                                       
*                                                                               
         ST    R6,AIOAREA                                                       
         BAS   RE,GETREC                                                        
*                                                                               
         MVC   AGYCLDT,TODAYP3                                                  
         ZAP   AGYCLAMT,TOTAGY+24(8)   AGENCY PAID NET                          
         AP    AGYCLAMT,TOTAGY+32(8)   AGENCY PAID GST                          
         ZAP   SVCLGST,=P'0'                                                    
         CP    TOTAGY+32(8),=P'0'      TEST ANY PAID GST                        
         BE    *+10                    NO                                       
         ZAP   SVCLGST,AGYCLAMT        ELSE SAVE PAID INCL GST                  
         DROP  R6                                                               
*                                                                               
         CLI   WRITESW,C'Y'                                                     
         BNE   ENDPAGY2                                                         
         BAS   RE,PUTREC           WRITE BACK AGENCY HEADER                     
         BNE   AGYWTERR                                                         
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDPAGY2 CLI   CLRSUMSW,C'Y'                                                    
         BE    ENDPAGY4                                                         
         MVC   PAGY,SRTAGY-SRTKEY+SVSRT  MOVE AGENCY ALPHA TO PRINT             
         ZAP   LINE,=P'0'                                                       
         ZAP   MAXLINE,=P'99'                                                   
*                                                                               
ENDPAGY4 LA    R4,TOTAGY                                                        
         BAS   RE,FMTTOT                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CP    SVCLGST,=P'0'       TEST ANY GST                                 
         BE    ENDPAGYX                                                         
         MVC   P+25(10),=C'(INCL GST)'                                          
         LA    R5,PPAYN                                                         
         EDIT  (P8,SVCLGST),(15,(R5)),2,COMMAS=YES,MINUS=YES                    
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDPAGYX CLC   SVSRT(1),SRTKEY                                                  
         BNE   *+10                                                             
         ZAP   LINE,=P'99'                                                      
         B     EXIT                                                             
*                                                                               
ENDPFIL  NTR1                                                                   
         CP    TOTGPD,TOTFIL+16(8) TOTAL PAID MATCHES?                          
         BE    EPFIL10             YES                                          
         ZAP   TOTGPD2,TOTFIL+16(8)                                             
         AP    PAYDSCR,=P'1'       FLAG PAY DISCREPANCY                         
*                                                                               
EPFIL10  GOTO1 =V(PRINTER)                                                      
         LA    R4,TOTFIL                                                        
         BAS   RE,FMTTOT                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CP    PAYDSCR,=P'0'       PAY DISCREPANCY?                             
         BE    EPFIL20             NO                                           
         GOTO1 =V(PRINTER)         SKIP A LINE                                  
         MVC   P+19(23),=C'*ERROR* PAY DISCREPANCY'                             
         MVC   P+46(17),=C'BUY GROSS PAID = '                                   
         EDIT  (P8,TOTGPD),(15,P+63),2,COMMAS=YES,MINUS=YES                     
         MVC   P+80(17),=C'ACC GROSS PAID = '                                   
         EDIT  (P8,TOTGPD2),(15,P+97),2,COMMAS=YES,MINUS=YES                    
         GOTO1 =V(PRINTER)                                                      
*                                                                               
EPFIL20  CLI   CLRSUMSW,C'Y'                                                    
         BNE   ENDPFILX                                                         
*                                                                               
         GOTO1 =V(PRINTER)         SKIP A LINE                                  
         MVC   P(20),INVERRS+4                                                  
         EDIT  (P4,INVERRS),(10,P+21),COMMAS=YES,ALIGN=LEFT                     
         GOTO1 =V(PRINTER)                                                      
*                                                                               
ENDPFILX B     EXIT                                                             
         EJECT                                                                  
ENDSTA   NTR1                                                                   
*                                                                               
         LA    R4,TOTSTA                                                        
         BAS   RE,FMTTOT1                                                       
* SUPPRESS PAGING                                                               
         ZAP   DUB,MAXLINE                                                      
         CLI   DTLSW,C'Y'                                                       
         BNE   *+10                                                             
         ZAP   MAXLINE,=P'100'                                                  
         GOTO1 =V(PRINTER)                                                      
         ZAP   MAXLINE,DUB                                                      
*                                                                               
         CLC   SVSRT(8),SRTKEY     T/A/M/C/P/E                                  
         BE    EXIT                                                             
*                                                                               
ENDEST   LA    R4,TOTEST                                                        
         BAS   RE,FMTTOT                                                        
*                                                                               
         GOTO1 =V(PRINTER)                                                      
* WRITE ESTIMATE HEADER                                                         
         MVC   KEY(13),EKEY                                                     
         MVI   KEY+13,0                                                         
         MVC   KEY+14(4),ESTDA                                                  
         OC    ESTDA,ESTDA         TEST ESTHDR NOT FOUND                        
         BZ    ESTX                                                             
         CLI   WRITESW,C'Y'                                                     
         BNE   ESTX                                                             
         BAS   RE,WRITE                                                         
         BNE   ESWTERR                                                          
*                                                                               
ESTX     DC    0H'0'                                                            
         CLI   TESTSW,C'N'                                                      
         BE    *+8                                                              
         BAS   RE,TESTPRT          PRINT BUCKETS FOR TESTING                    
         XC    ESTDA,ESTDA                                                      
         CLC   SVSRT(7),SRTKEY     T/A/M/C/P                                    
         BE    EXIT                                                             
*                                                                               
ENDPRD   DS    0H                                                               
         GOTO1 =V(PRINTER)         SKIP A LINE                                  
*                                                                               
         LA    R4,TOTPRD                                                        
         BAS   RE,FMTTOT                                                        
         GOTO1 =V(PRINTER)                                                      
         GOTO1 =V(PRINTER)         SKIP A LINE                                  
*                                                                               
         CLC   SVSRT(6),SRTKEY     T/A/M/C                                      
         BE    EXIT                                                             
ENDCLT   DS    0H                                                               
*                                                                               
         LA    R4,TOTCLT                                                        
         BAS   RE,FMTTOT                                                        
         GOTO1 =V(PRINTER)                                                      
         CLC   SVSRT(4),SRTKEY     T/A/M                                        
         BNE   ENDMED              IF NO, NEXT TOTALS SAME PAGE                 
         GOTO1 =V(PRINTER)         SKIP A LINE                                  
         B     EXIT                AND NOP NEW PAGE LOGIC                       
         ZAP   LINE,=P'99'         ELSE FORCE NEW PAGE FOR NEW MEDIA            
         B     EXIT                                                             
*                                                                               
ENDMED   DS    0H                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,TOTMED                                                        
         BAS   RE,FMTTOT                                                        
         GOTO1 =V(PRINTER)                                                      
         CLC   SVSRT(3),SRTKEY     T/A                                          
         BNE   ENDAGY                                                           
         ZAP   LINE,=P'99'                                                      
         B     EXIT                                                             
*                                                                               
ENDAGY   DS    0H                                                               
AGY2     DC    0H'0'                                                            
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,TOTAGY                                                        
         BAS   RE,FMTTOT                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CP    SVCLGST,=P'0'       TEST ANY GST                                 
         BE    AGY4                NO                                           
         MVC   P+25(10),=C'(INCL GST)'                                          
         LA    R5,PPAYN                                                         
         EDIT  (P8,SVCLGST),(15,(R5)),2,COMMAS=YES,MINUS=YES                    
         GOTO1 =V(PRINTER)                                                      
*                                                                               
AGY4     CLI   SRTTYPE,C'A'                                                     
         BNE   ENDRPT                                                           
         ZAP   LINE,=P'99'                                                      
         B     EXIT                                                             
SVCLGST  DC    PL8'0'                                                           
         EJECT                                                                  
ENDRPT   DS    0H                                                               
         ZAP   DUB,TOTFIL+24(8)        PAID NET                                 
         AP    DUB,TOTFIL+32(8)        PAID GST                                 
         ZAP   SVCLGST,=P'0'                                                    
         CP    TOTFIL+32(8),=P'0'  TEST ANY PAID GST                            
         BE    *+10                NO                                           
         ZAP   SVCLGST,DUB         ELSE SAVE PAID INCL GST                      
*                                                                               
         ZAP   TOTGPD,TOTFIL+16(8) TOTAL PAID DOLLARS                           
         LA    R4,TOTFIL                                                        
         BAS   RE,FMTTOT                                                        
         ZAP   LINE,=P'99'                                                      
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         CP    SVCLGST,=P'0'       TEST ANY GST                                 
         BE    RPT1                                                             
         MVC   P+25(10),=C'(INCL GST)'                                          
         LA    R5,PPAYN                                                         
         EDIT  (P8,SVCLGST),(15,(R5)),2,COMMAS=YES,MINUS=YES                    
         GOTO1 =V(PRINTER)                                                      
*                                                                               
RPT1     DS    0H                                                               
         GOTO1 =V(PRINTER)         SKIP A LINE                                  
*                                                                               
***      BRAS  RE,ERRCHECK         SEND EMAIL IF ERRORS                         
*                                                                               
         MVC   SPACING,=C'BL02'                                                 
         LA    R5,TOTCTR                                                        
         LHI   R6,TOTCTRN                                                       
*                                                                               
RPT2     EDIT  (P4,0(R5)),(10,P+21),COMMAS=YES,ALIGN=LEFT                       
*                                                                               
         MVC   P(20),4(R5)         ROW NAME                                     
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R5,24(R5)                                                        
         BCT   R6,RPT2                                                          
*                                                                               
         CLI   SRTTYPE,X'FF'                                                    
         BNE   EXIT                                                             
*                                                                               
         L     RD,SP133RD          SET TO EOJ EXIT                              
*                                                                               
RPTX     B     XBASEXIT                                                         
         EJECT                                                                  
* R4 POINTS TO ACCUMULATORS                                                     
*                                                                               
FMTTOT   MVC   P+19(24),40(R4)     ROW NAME                                     
*                                                                               
FMTTOT1  LA    R0,5                                                             
         LA    R5,PORDG                                                         
         CLI   SVSRT,C'P'        TEST PRINTING PAYMENT TOTAL                    
         BNE   FMTTOT2                                                          
         LA    R0,3                                                             
         LA    R4,16(R4)                                                        
         LA    R5,PPAYG                                                         
*                                                                               
FMTTOT2  CLI   GSTSW,C'Y'          TEST PRINTING GST                            
         BE    *+6                                                              
         BCTR  R0,0                                                             
*                                                                               
FMTTOT4  EDIT  (P8,0(R4)),(15,(R5)),2,COMMAS=YES,MINUS=YES                      
*                                                                               
         CP    0(8,R4),=P'0'                                                    
         BL    *+8                                                              
         MVI   14(R5),C'*'                                                      
*                                                                               
         ZAP   0(8,R4),=P'0'       CLEAR ACCUM                                  
*                                                                               
         LA    R4,8(R4)                                                         
         LA    R5,15(R5)                                                        
         BCT   R0,FMTTOT4                                                       
*                                                                               
         CLI   GSTSW,C'Y'          TEST PRINTING GST                            
         BE    *+10                YES                                          
         ZAP   0(8,R4),=P'0'       ELSE CLEAR NET+GST ACCUM                     
*                                                                               
         BR    RE                                                               
         EJECT                                                                  
FMTLIN   NTR1                                                                   
         MVC   PAGY,SRTAGY                                                      
*                                                                               
         SR    RE,RE                                                            
         IC    RE,SRTAGMD                                                       
         N     RE,=X'0000000F'                                                  
         IC    RE,MDTAB-1(RE)                                                   
         STC   RE,PMED                                                          
         B     LIN2                                                             
MDTAB    DC    C'TRNX'                                                          
*                                                                               
LIN2     DC    0H'0'                                                            
         LA    R4,SRTCLT                                                        
         CLI   SRTTYPE,C'P'                                                     
         BNE   *+8                                                              
         LA    R4,SRPCLT                                                        
         L     R5,=A(CLTHDR)                                                    
         LA    R5,CPROF+6-CLTHDR(R5)                                            
         GOTO1 CLUNPK,DMCB,(0(R5),(R4)),PCLT                                    
*                                                                               
         MVC   PPRD,EKEY+4                                                      
         CLI   SRTTYPE,C'P'        TEST PAYMENT REC                             
         BE    LIN20               GO LOOK UP PRD CODE IN CLTHDR                
         OC    ESTDA,ESTDA         ELSE TEST ESTHDR FOUND                       
         BNZ   LIN28               YES - OK                                     
*                                                                               
LIN20    L     R1,=A(CLTHDR)                                                    
         LA    R1,CLIST-CLTHDR(R1)                                              
*                                                                               
LIN22    CLC   SRPPRD,3(R1)                                                     
         BE    LIN26                                                            
         LA    R1,4(R1)                                                         
         CLI   0(R1),C'A'                                                       
         BNL   LIN22                                                            
LIN24    LA    R1,=C'***'                                                       
*                                                                               
LIN26    MVC   PPRD,0(R1)                                                       
*                                                                               
*                                                                               
LIN28    SR    R0,R0                                                            
         IC    R0,SRTEST                                                        
         CLI   SRTTYPE,C'P'                                                     
         BNE   *+8                                                              
         IC    R0,SRPEST                                                        
         BAS   RE,CVD                                                           
         MVC   PEST,WORK+7                                                      
*                                                                               
LIN30    L     R1,=A(STAWORK)                                                   
         XC    0(32,R1),0(R1)                                                   
         USING STAPACKD,R1                                                      
*                                                                               
         MVI   STAPACT,C'U'                                                     
         MVC   STAPAGY,SRTAGY                                                   
         MVC   STAPMED,PMED                                                     
         MVC   STAPACOM,=A(COMFACS)                                             
         MVC   STAPCTRY,SRTCTRY                                                 
         MVC   STAPSTA,SRTSTA                                                   
         CLI   SRTTYPE,C'P'                                                     
         BNE   *+10                                                             
         MVC   STAPSTA,SRPSTAPR                                                 
         L     RF,STAPACK                                                       
         GOTO1 (RF),(R1)                                                        
*                                                                               
         MVC   PSTA,STAPQSTA       MOVE STATION TO PRINT                        
*                                                                               
         CLI   STAPCTRY,C'C'                                                    
         BNE   LIN31                                                            
                                                                                
* CANADA                                                                        
                                                                                
         CLI   STAPSTA+2,X'B0'     TEST CANAD CABLE                             
         BL    LIN32               NO                                           
         BNL   LIN34                                                            
                                                                                
* NOT CANADA                                                                    
                                                                                
LIN31    CLI   STAPSTA,X'E8'       TEST US CABLE                                
         BL    LIN32               NO                                           
         MVI   PSTA+4,C'/'                                                      
         B     LIN34                                                            
                                                                                
* NOT ANY SORT OF CABLE                                                         
                                                                                
LIN32    CLI   STAPQSTA+4,C' '                                                  
         BE    *+14                                                             
         MVI   PSTA+4,C'-'                                                      
         MVC   PSTA+5(1),STAPQSTA+4                                             
*                                                                               
LIN34    OC    SRTCNNET,SRTCNNET                                                
         BZ    LIN36                                                            
         MVC   PCNET,SRTCNNET                                                   
         DROP  R1                                                               
*                                                                               
LIN36    CLI   SRTTYPE,C'P'                                                     
         BE    *+12                                                             
         CLI   DTLSW,C'Y'                                                       
         BNE   LIN38                                                            
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,SRTLIN                                                      
         CLI   SRTTYPE,C'P'                                                     
         BNE   *+8                                                              
         ICM   R0,3,SRPLIN                                                      
         BAS   RE,CVD                                                           
         MVC   PLIN,WORK+7                                                      
*                                                                               
         CLI   SRTTYPE,C'P'                                                     
         BE    LIN50                                                            
*                                                                               
LIN38    LA    R1,SPACES                                                        
         CLC   SRTPRD,SRTPTRPR     TEST ACTIVE PRD                              
         BE    LIN40                                                            
*                                                                               
         LA    R1,=C'POL'                                                       
         CLI   SRTPTRPR,X'FF'                                                   
         BE    LIN40                                                            
*                                                                               
         L     R1,=A(CLTHDR)                                                    
         LA    R1,CLIST-CLTHDR(R1)                                              
         CLC   SRTPTRPR,3(R1)                                                   
         BE    *+12                                                             
         LA    R1,4(R1)                                                         
         B     *-14                                                             
LIN40    MVC   PPTR,0(R1)                                                       
*                                                                               
         CLC   SRTEST,SRTPTRES                                                  
         BE    LIN50                                                            
         MVI   PPTR+3,C'-'                                                      
         SR    R0,R0                                                            
         IC    R0,SRTPTRES                                                      
         BAS   RE,CVD                                                           
         MVC   PPTREST,WORK+7                                                   
*                                                                               
LIN50    SR    R0,R0                                                            
         ICM   R0,7,SRTSIN                                                      
         CLI   SRTTYPE,C'P'                                                     
         BNE   *+8                                                              
         ICM   R0,7,SRPSIN                                                      
         EDIT  (R0),(6,PSIN)                                                    
         EJECT                                                                  
* SUM BUCKETS                                                                   
*                                                                               
LIN60    LA    R4,SRTEL                                                         
SEL      USING SRTEL,R4                                                         
*                                                                               
         LA    R5,MYTOTS                                                        
         LHI   R6,NTOTS                                                         
         ZAP   0(6,R5),=P'0'                                                    
         LA    R5,6(R5)                                                         
         BCT   R6,*-10                                                          
*                                                                               
LIN62    AP    MYTOTOG,SEL.SRTELOG                                              
         AP    MYTOTON,SEL.SRTELON                                              
         AP    MYTOTPG,SEL.SRTELPG                                              
         AP    MYTOTPN,SEL.SRTELPN                                              
         AP    MYTOTGST,SEL.SRTELGST                                            
         AP    MYTOTGST,SEL.SRTELPST ADD PST TO GST                             
*                                                                               
LIN64    LA    R4,L'SRTBCKTS(R4)   NEXT BUCKET SET                              
         CLI   0(R4),0             TEST Y/M                                     
         BNZ   LIN62               MORE                                         
         DROP  SEL                                                              
*                                                                               
LIN70    LA    R3,PORDG            PRINT LINE POSITION                          
         LA    R5,MYTOTOG                                                       
         LHI   R6,4                                                             
*                                                                               
LIN72    EDIT  (P6,0(R5)),(15,(R3)),2,COMMAS=YES,MINUS=YES                      
*                                                                               
         LA    R3,15(R3)                                                        
         LA    R5,6(R5)                                                         
         BCT   R6,LIN72                                                         
*                                                                               
         CLI   DTLSW,C'Y'                                                       
         BE    LIN74                                                            
         CLI   SRTTYPE,C'P'                                                     
         BNE   LIN80               PRINT PAYMENT DETAILS ONLY                   
*                                                                               
LIN74    CLI   CLRSUMSW,C'Y'                                                    
         BNE   LIN80                                                            
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         EJECT                                                                  
* ADD TO STA/EST/PRD/CLT/MED/AGY/FIL TOTALS                                     
*                                                                               
LIN80    LA    R5,TOTSTA           FIRST ROW OF TOTALS                          
         LHI   R6,7                NUMBER OF ROWS                               
*                                                                               
LIN82    AP    0(8,R5),MYTOTOG                                                  
         AP    8(8,R5),MYTOTON                                                  
         AP    16(8,R5),MYTOTPG                                                 
         AP    24(8,R5),MYTOTPN                                                 
         AP    32(8,R5),MYTOTGST                                                
*                                                                               
         LA    R5,L'TOTS(R5)       NEXT ROW                                     
         BCT   R6,LIN82                                                         
         B     EXIT                                                             
*                                                                               
CVD      CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(10),DUB                                                     
         BR    RE                                                               
         EJECT                                                                  
FMTINV   NTR1                                                                   
         MVC   PAGY,SRTAGY                                                      
         LA    R4,SRTEL                                                         
SEL      USING SRTEL,R4                                                         
         MVC   PMED,SEL.ZMED                                                    
         MVC   PCLT(3),SEL.ZCLT                                                 
         MVC   PPRD,SEL.ZPRD                                                    
         MVC   PSTA(4),SEL.ZSTA                                                 
         CLI   SEL.ZSTA+4,C'T'                                                  
         BE    *+14                                                             
         MVI   PSTA+4,C'-'                                                      
         MVC   PSTA+5(1),SEL.ZSTA+4                                             
         SR    R0,R0                                                            
         ICM   R0,7,SRPSIN                                                      
         EDIT  (R0),(6,PSIN)                                                    
*                                                                               
         LA    R5,PLIN-1                                                        
         MVC   0(5,R5),=C'*CHK*'                                                
         LA    R5,6(R5)                                                         
         MVC   0(12,R5),SEL.ZINV                                                
         LA    R5,13(R5)                                                        
*                                                                               
         ICM   RE,15,SEL.ZGST      ZGST IN BINARY FROM 21JUN99                  
         CVD   RE,DUB                                                           
         AP    DUB,SEL.ZAMT                                                     
* ADD IN PST (IF CANADIAN,GENIUS)                                               
         CLI   THISAGY+2,C'C'                                                   
         BNE   FMTINV4                                                          
*                                                                               
         LA    RE,SEL.ZPST                                                      
         LA    RF,6                                                             
FMTINV2  CLI   ZPSTCD-ZPST(RE),C' '                                             
         BNH   FMTINV3                                                          
***                                                                             
* STARTING OCT08/14 THE PST AMOUNT IS IN BINARY FOR SOME AGENCIES               
* PLEASE SEE Z2FLAG,Z2PSTHEX IN SPPAY00                                         
***                                                                             
         TM    Z2AREA+64,X'20'     IS PST AMOUNT IS IN BINARY?                  
         BZ    FMTINV2A            NO - PRE OCT08/14 IS PACKED                  
         ICM   R0,15,ZPSTAMT-ZPST(RE) BINARY PST IN R0                          
         CVD   R0,DUB2             CONVERT TO PACKED                            
         AP    DUB,DUB2            ADD PACKED PST                               
         B     FMTINV3             BUMP TO NEXT PST VALUE                       
*                                                                               
FMTINV2A AP    DUB,ZPSTAMT-ZPST(L'ZPSTAMT,RE)                                   
*                                                                               
FMTINV3  LA    RE,7(RE)                                                         
         BCT   RF,FMTINV2                                                       
*                                                                               
FMTINV4  CLI   SEL.ZAMTTYPE,C'3'   CK'S ARE POSITIVE, SO CHANGE SIGN            
         BNE   *+10                                                             
         MP    DUB,=P'-1'                                                       
         AP    INVTOT,DUB                                                       
*                                                                               
         EDIT  (P8,DUB),(15,(R5)),2,COMMAS=YES                                  
*                                                                               
         MVC   15(2,R5),=C'CR'                                                  
         CLI   SEL.ZAMTTYPE,C'2'                                                
         BE    FMTINV10                                                         
         MVC   15(2,R5),=C'CK'                                                  
         CLI   SEL.ZAMTTYPE,C'3'                                                
         BE    FMTINV10                                                         
         MVC   15(2,R5),SPACES                                                  
*                                                                               
FMTINV10 LA    R5,18(R5)                                                        
*                                                                               
         CLI   THISAGY+2,C'C'                                                   
         BNE   FMTINV18                                                         
*                                                                               
         MVI   0(R5),C'('                                                       
         LA    R5,1(R5)                                                         
         ZAP   DUB,SEL.ZAMT                                                     
         EDIT  (P8,DUB),(12,(R5)),2,ALIGN=LEFT,ZERO=NOBLANK                     
         AR    R5,R0                                                            
         MVC   1(4,R5),=C'GST='                                                 
         LA    R5,5(R5)                                                         
         ICM   RE,15,SEL.ZGST                                                   
         CVD   RE,DUB                                                           
         EDIT  (P8,DUB),(10,(R5)),2,ALIGN=LEFT,ZERO=NOBLANK                     
         AR    R5,R0                                                            
         CLI   SEL.ZPSTCD,C' '        TEST ANY PST                              
         BNH   FMTINV16            NO                                           
         MVI   0(R5),C','                                                       
         LA    R5,1(R5)                                                         
*                                                                               
         LA    RE,SEL.ZPST                                                      
         LA    RF,6                                                             
*                                                                               
FMTINV12 CLI   ZPSTCD-ZPST(RE),C' '                                             
         BNH   FMTINV13                                                         
         MVC   0(2,R5),ZPSTPROV-ZPST(RE)  MOVE PROVINCE CODE                    
         MVI   2(R5),C'='                                                       
         LA    R5,3(R5)                                                         
         ICM   R0,15,ZPSTAMT-ZPST(RE)                                           
         CVD   R0,DUB                                                           
         TM    Z2AREA+64,X'20'     IS PST AMOUNT IS IN BINARY?                  
         BNZ   *+10                NO - PRE OCT08/14 IS PACKED                  
         ZAP   DUB,ZPSTAMT-ZPST(L'ZPSTAMT,RE)                                   
         EDIT  (P8,DUB),(10,(R5)),2,ALIGN=LEFT                                  
         AR    R5,R0                                                            
         MVI   0(R5),C','                                                       
         LA    R5,1(R5)                                                         
FMTINV13 LA    RE,7(RE)                                                         
         BCT   RF,FMTINV12                                                      
*                                                                               
FMTINV14 BCTR  R5,0                                                             
*                                                                               
FMTINV16 MVI   0(R5),C')'                                                       
*                                                                               
FMTINV18 CLI   CLRSUMSW,C'Y'                                                    
         BE    FMTINV19                                                         
         MVC   P,SPACES                                                         
         B     EXIT                                                             
*                                                                               
FMTINV19 GOTO1 =V(PRINTER)                                                      
         B     EXIT                                                             
*                                                                               
         DROP  SEL                                                              
         EJECT                                                                  
HIGH     NTR1                                                                   
         MVC   KEYSAVE,KEY                                                      
         GOTO1 =V(DATAMGR),DMCB,=C'DMRDHI',=C'SPTDIR',KEYSAVE,KEY               
         B     PUTRECX                                                          
*                                                                               
SEQ      NTR1                                                                   
         GOTO1 =V(DATAMGR),DMCB,=C'DMRSEQ',=C'SPTDIR',KEYSAVE,KEY               
         B     PUTRECX                                                          
*                                                                               
GETREC   NTR1                                                                   
         LA    RF,=C'GETREC'                                                    
         B     PUTREC2                                                          
*                                                                               
PUTREC   NTR1                                                                   
         LA    RF,=C'PUTREC'                                                    
         B     PUTREC2                                                          
*                                                                               
WRITE    NTR1                                                                   
         LA    RF,=C'DMWRT'                                                     
*                                                                               
PUTREC2  ST    RF,DMCB                                                          
         GOTO1 =V(DATAMGR),DMCB,,=C'SPTFILE',KEY+14,AIOAREA,DMWORK              
*                                                                               
PUTRECX  CLI   8(R1),0             SET CC ON EXIT                               
*                                                                               
EXIT     XIT1                                                                   
*                                                                               
XBASEXIT GOTO1 =V(DATAMGR),DMCB,=C'DMCLSE',=C'SPOT'                             
         L     RD,SP133RD          SET TO EOJ EXIT                              
         XBASE                                                                  
*                                                                               
CLTERR   MVC   P(24),=C'*ERROR* CLIENT NOT FOUND'                               
         L     RE,=A(CLTHDR)                                                    
         MVC   0(13,RE),KEYSAVE    FORCE KEY EQUAL                              
         XC    CLTDA,CLTDA                                                      
         XC    ESTDA,ESTDA                                                      
         LA    R0,OUT20                                                         
         CLI   SRTTYPE,C'P'                                                     
         BNE   *+8                                                              
         LA    R0,OUTP20                                                        
         B     ERRX                                                             
*                                                                               
PRDERR   MVC   P(25),=C'*ERROR* PRODUCT NOT FOUND'                              
         AP    PRDERRS,=P'1'                                                    
         LA    R0,OUT20                                                         
         XC    ESTDA,ESTDA                                                      
         B     ERRX                                                             
*                                                                               
ESTERR   MVC   P(26),=C'*ERROR* ESTIMATE NOT FOUND'                             
         AP    ESTERRS,=P'1'                                                    
* SHOW THE KEY OF THE ESTIMATE                                                  
         GOTO1 VHEXOUT,DMCB,KEYSAVE,P+30,13,=C'TOG'                             
         LA    R0,OUT20                                                         
         MVC   ESTHDR(13),KEYSAVE                                               
         XC    ESTDA,ESTDA                                                      
         B     ERRX                                                             
*                                                                               
ESWTERR  MVC   P(28),=C'*ERROR* CAN''T WRITE ESTHDR'                            
         LA    R0,ESTX                                                          
         XC    ESTDA,ESTDA                                                      
         B     ERRX                                                             
*                                                                               
AGYRDERR MVC   P(26),=C'*ERROR* AGENCY NOT FOUND'                               
         XC    AGYDA,AGYDA         SET NOT FOUND IND                            
         L     RE,=A(AGYKEY)                                                    
         MVC   0(13,RE),KEYSAVE    FORCE KEY EQUAL                              
         LA    R0,OUT14            RETURN                                       
         B     ERRX                                                             
*                                                                               
AGYWTERR MVC   P(28),=C'*ERROR* CAN''T WRITE AGYHDR'                            
         LA    R0,ENDPAGY2                                                      
         B     ERRX                                                             
*                                                                               
ERRX     ST    R0,FULL                                                          
         GOTO1 =V(LOGIO),DMCB,1,(30,P)                                          
         ZAP   LINE,=P'99'                                                      
         GOTO1 =V(PRINTER)                                                      
         GOTO1 (RF),(R1)                                                        
         GOTO1 VHEXOUT,DMCB,(R8),P+25,L'SRTKEY+4,=C'TOG'                        
         GOTO1 =V(LOGIO),DMCB,1,(40,P+20)                                       
         GOTO1 =V(PRINTER)                                                      
         L     RE,FULL                                                          
         BR    RE                                                               
         EJECT                                                                  
TESTPRT  NTR1                                                                   
         ZAP   DUB,MAXLINE                                                      
         SP    DUB,LINE                                                         
         CP    DUB,=P'5'                                                        
         BH    *+10                                                             
         ZAP   LINE,=P'99'                                                      
*                                                                               
         L     RE,=A(MIDMONS)                                                   
         MVC   P(110),0(RE)                                                     
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         LA    R4,EORD                                                          
         MVC   P(7),=C'ORD YTD'                                                 
         BAS   RE,TESTFMT                                                       
*                                                                               
         LA    R4,EPAID                                                         
         MVC   P(8),=C'PAID YTD'                                                
         BAS   RE,TESTFMT                                                       
         B     EXIT                                                             
*                                                                               
TESTFMT  NTR1                                                                   
         LHI   R0,12                                                            
         LR    R1,R4                                                            
TESTFM2  CP    0(6,R1),=P'0'                                                    
         BNE   TESTFM4                                                          
         LA    R1,6(R1)                                                         
         BCT   R0,TESTFM2                                                       
         MVC   P,SPACES                                                         
         B     EXIT                                                             
*                                                                               
TESTFM4  LA    R5,P+10                                                          
         LHI   R6,12                                                            
*                                                                               
TESTFM6  ZAP   DUB,0(6,R4)                                                      
         SRP   DUB,64-2,5                                                       
         EDIT  (P8,DUB),(7,(R5))                                                
         LA    R4,6(R4)                                                         
         LA    R5,8(R5)                                                         
         BCT   R6,TESTFM6                                                       
         GOTO1 =V(PRINTER)                                                      
         B     EXIT                                                             
*                                                                               
         EJECT                                                                  
SP133RD  DS    F                                                                
DATLEN   DS    F                                                                
TODAYQ   DC    XL6'00'            YYMMDD DATE                                   
SPOT     DS    C                                                                
CCRECS   DC    PL4'0',CL20'COKE RECS COPIED'                                    
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
                                                                                
RCVTAPE  DCB   DDNAME=RECVIN,                                          X        
               DSORG=PS,                                               X        
               RECFM=VB,                                               X        
               LRECL=8200,                                             X        
               MACRF=GM,                                               X        
               EODAD=INPUTEOF                                                   
*                                                                               
SORTCARD DC    CL80'SORT FIELDS=(5,15,A),FORMAT=BI'                             
RECCARD  DC    CL80'RECORD TYPE=V,LENGTH=600'                                   
HEAD     DC    CL110'AG M CLT PRD EST STATION  LIN PTR-EST    SIN     GX        
               ROSS ORDERED    NET ORDERED    GROSS PAID       NET PAIDX        
               '                                                                
MIDMONS  DC    CL110'             JAN     FEB     MAR     APR     MAY  X        
                 JUN     JUL     AUG    SEP     OCT     NOV     DEC'            
         LTORG                                                                  
                                                                                
         DROP  RB,RA,R7                                                         
         TITLE 'SP133BLD - BUILD SORT RECORDS FROM BUYREC'                      
SP133BLD NMOD1 0,**BLD**                                                        
*                                                                               
         L     RC,=A(SP133WRK)                                                  
         USING SP133WRK,RC                                                      
*                                                                               
         L     R8,=A(SRTBUFF)                                                   
         USING SRTRECD,R8                                                       
         XC    LASTDATE,LASTDATE                                                
*                                                                               
         CLI   BDSEC,0             TEST FOR A BAD SLN                           
         BNE   BLD2                                                             
         BAS   RE,SLNERR                                                        
         LA    R0,SRTREC           WIPE OUT THE SORT BUFFER                     
         LA    R1,2*SRTRECLN                                                    
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         B     BLDX                                                             
*                                                                               
BLD2     DS    0H                                                               
         CLI   DM$RRECTY,DM$RRECTCHG TEST CHANGE                                
         BE    BLD3                NO                                           
*                                                                               
BLD2A    LA    R3,BUYKEY+3         POINT TO PRD                                 
         BAS   RE,BLDKEY                                                        
         CLI   BDTIME,0            TEST PIGGYBACK                               
         BE    BLD3                 NO                                          
         CLI   BUYKPRD,X'FF'                                                    
         BNE   BLDPIG                                                           
         BAS   RE,TIMEERR          ERR FOR BDTIME <> 0 FOR POL BUY              
*                                                                               
BLD3     CLI   BUYKEY+3,X'FF'      TEST POL                                     
         BE    BLDPOL                                                           
         B     BLDPROC                                                          
         EJECT                                                                  
BLDPOL   CLI   DM$RRECTY,DM$RRECTCPY IF COPY, RESET ERROR SW                    
         BNE   *+8                                                              
         MVI   COPYERR,C'N'                                                     
         GOTO1 =V(DATCON),DMCB,(3,BDSTART),(2,BUYDATES)                         
         GOTO1 (RF),(R1),(3,BDEND),(2,BUYDATES+2)                               
*                                                                               
         LA    R2,BDELEM                                                        
         SR    R0,R0                                                            
         MVI   PAIDFLAG,0                                                       
*                                                                               
BLDPOL10 IC    R0,1(R2)                                                         
         LTR   R0,R0                                                            
         BZ    BADREC                                                           
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    BLDPROC                                                          
         CLI   0(R2),11                                                         
         BL    BLDPOL10                                                         
         CLI   0(R2),13                                                         
         BH    BLDPOL10                                                         
*                                                                               
         TM    BDSTAT,X'80'        TEST POL NPW DATA IN REC                     
         BO    BLDPOL30            YES - SKIP THIS LOGIC                        
*                                                                               
         CLI   0(R2),X'0C'         TEST OTO                                     
         BNE   BLDPOL20                                                         
         TM    6(R2),X'80'         TEST MINUS                                   
         BZ    BLDPOL30                                                         
         SR    RE,RE                                                            
         IC    RE,1(R2)                                                         
         AR    RE,R2                                                            
         CLI   0(RE),X'0C'         TEST OTO FOLLOWS                             
         BNE   BLDPOL30                                                         
         TM    6(RE),X'80'         TEST MINUS                                   
         BZ    BLDPOL30                                                         
         BAS   RE,OTOERR                                                        
         B     BLDPOL30                                                         
*                                                                               
BLDPOL20 DS    0H                                                               
*&&DO                                                                           
BLDPOL20 CLC   2(2,R2),BUYDATES    TEST SPOT DATE BEFORE BDSTART                
         BL    *+14                 YES                                         
         CLC   2(2,R2),BUYDATES+2  TEST SPOT DATE AFTER BDEND                   
         BNH   BLDPOL30             NO                                          
         CLI   DM$RRECTY,DM$RRECTCPY                                            
         BNE   BLDPOL22                                                         
         MVI   COPYERR,C'Y'                                                     
         B     BLDPOL30                                                         
*                                                                               
BLDPOL22 CLI   COPYERR,C'Y'                                                     
         BE    BLDPOL30            COPY HAD AN ERROR - DON'T REPORT             
         BAS   RE,DATEERR                                                       
*&&                                                                             
BLDPOL30 OC    4(2,R2),4(R2)       TEST PAID                                    
         BZ    BLDPOL40                                                         
         OI    PAIDFLAG,X'80'      INDICATE PAID                                
         OC    BDCOST,BDCOST       HAS DOLLARS?                                 
         BZ    *+8                 NO                                           
         OI    PAIDFLAG,X'40'      YES - INDICATE DOLLARS                       
         TM    BUYREC+15,X'80'     TEST DELETED                                 
         BZ    BLDPOL40                                                         
         CLI   DM$RPRG,SSORM       TEST BY MKTFIX                               
         BE    BLDPOL40                                                         
         CLI   DM$RPRG,SSORS       OR STATION CALL LETTER CHG                   
         BE    BLDPOL40                                                         
         BAS   RE,PAYERR           YES - BIG TROUBLE !                          
         B     BLDX                                                             
*                                                                               
BLDPOL40 CLC   LASTDATE,2(R2)      TEST ELEM DATES ASCENDING                    
         BNH   BLDPOL50                                                         
         CLI   DM$RRECTY,DM$RRECTCPY DON'T CARE IF COPY IS BAD                  
         BE    *+8                                                              
         BAS   RE,SEQERR                                                        
*                                                                               
BLDPOL50 MVC   LASTDATE,2(R2)      SAVE ELEMENT DATE                            
         LA    R3,10(R2)           POINT TO ALLOCATIONS                         
         IC    R0,1(R2)                                                         
         AHI   R0,-10                                                           
         BZ    BLDPOL10                                                         
         BM    BADREC              BAD RECORD <<<                               
         SRL   R0,2                SET FOR BCT                                  
         CHI   R0,2                MAX 2 PRDS                                   
         BH    BADREC              BAD RECORD <<<                               
                                                                                
* MAKE SURE ALLOCATED SLNS = TOTAL SLN UNLESS SPOD                              
* BUT SKIP FOR COPIES SO DON'T GET ERRORS WHEN FIXED                            
                                                                                
         CLI   DM$RRECTY,DM$RRECTCPY                                            
         BE    BLDPOL70                                                         
                                                                                
         CLI   1(R2),14            TEST ONE PRODUCT ALLOCATE                    
         BNE   *+12                                                             
         TM    BDSTAT3,BDST3_SPODS                                              
         BO    BLDPOL70                                                         
*                                                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
BLDPOL60 IC    RE,1(R3)                                                         
         AR    RF,RE                                                            
         LA    R3,4(R3)                                                         
         BCT   R0,BLDPOL60                                                      
         CLM   RF,1,BDSEC                                                       
         BE    BLDPOL70                                                         
         BAS   RE,ALLOCERR                                                      
*                                                                               
BLDPOL70 LA    R3,10(R2)           POINT TO ALLOCATIONS                         
         IC    R0,1(R2)                                                         
         AHI   R0,-10                                                           
         SRL   R0,2                SET FOR BCT                                  
                                                                                
* TEST PRD IN BUFFER                                                            
                                                                                
BLDPOL80 L     R8,=A(SRTBUFF)                                                   
*                                                                               
BLDPOL90 CLC   SRTPRD,0(R3)                                                     
         BE    BLDPOL99                                                         
         LA    R8,SRTRECLN(R8)                                                  
         CLI   SRTPRD,0            CHECK FOR BUFFER END                         
         BNE   BLDPOL90                                                         
         BAS   RE,BLDKEY           ADD NEW PRD TO BUFFER                        
BLDPOL99 LA    R3,4(R3)            NEXT PRD                                     
         BCT   R0,BLDPOL80                                                      
*                                                                               
         B     BLDPOL10            NEXT ELEM                                    
LASTDATE DS    H                                                                
BUYDATES DS    F                   BDSTART/BDEND COMPRESSED                     
         EJECT                                                                  
BADREC   BAS   RE,BUYERR                                                        
         B     BLDX                                                             
*                                                                               
ALLOCERR NTR1                                                                   
         CLC   ALLOCKEY,REC+24        TEST SAME KEY AS PREVIOUS                 
         BE    ALLOCERX                                                         
         AP    BADRECS,=P'1'                                                    
         MVC   P(33),=C'*ERROR* BAD POL ALLOC LENS UNPAID'                      
* NEED TO SEE IF ANY PAID SPOTS                                                 
         SR    R0,R0                                                            
         LA    R6,REC+24+24        POINT TO FIRST ELEMENT                       
ALLCK2   IC    R0,1(R6)                                                         
         AR    R6,R0                                                            
         CLI   0(R6),0                                                          
         BE    ALLCK4                                                           
         CLI   0(R6),X'0B'                                                      
         BL    ALLCK2                                                           
         CLI   0(R6),X'0C'                                                      
         BH    ALLCK2                                                           
         OC    4(2,R6),4(R6)                                                    
         BZ    ALLCK2                                                           
         MVC   P+27(2),SPACES      PRINT 'PAID' MESSAGE                         
*                                                                               
ALLCK4   MVC   ALLOCKEY,REC+24                                                  
         GOTO1 VHEXOUT,DMCB,REC+24,P+36,13,=C'TOG'                              
         GOTO1 =V(PRINTER)                                                      
ALLOCERX XIT1                                                                   
*                                                                               
ALLOCKEY DC    XL13'00'                                                         
*                                                                               
SEQERR   NTR1                                                                   
*                                                                               
         CLC   ALLOCKEY,REC+24        TEST SAME KEY AS PREVIOUS                 
         BE    SEQERRX                                                          
         MVC   ALLOCKEY,REC+24                                                  
*                                                                               
         AP    BADRECS,=P'1'                                                    
         BRAS  RE,PRTBUY           DOESN'T REALLY PRINT BUY                     
         TM    PAIDFLAG,X'80'                                                   
         BZ    *+10                                                             
         MVC   P+30(4),=C'PAID'                                                 
*                                                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P(26),=C'*ERROR* BAD 0B ELEMENT SEQ'                             
         GOTO1 VHEXOUT,DMCB,REC+12,P+30,4,=C'TOG'     DISK ADDR                 
         LA    R0,REC+24                                                        
         SR    R0,R2                                                            
         LPR   R0,R0                                                            
         ST    R0,DUB                                                           
         MVC   P+50(7),=C'EL DISP'                                              
         GOTO1 (RF),(R1),DUB,P+58                                               
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         GOTO1 VPRTREC,DMCB,(C'E',REC+24),(24,13),                     X        
               VPRINT,VHEXOUT                                                   
SEQERRX  XIT1                                                                   
*                                                                               
PAYERR   NTR1                                                                   
         AP    BADRECS,=P'1'                                                    
         BRAS  RE,PRTBUY           FORMAT BUY FOR PRINTING                      
         TM    PAIDFLAG,X'80'                                                   
         BZ    PAYERR10                                                         
         MVC   P+35(34),=C'*ERROR* DELETED BUY HAS PAID SPOTS'                  
         TM    PAIDFLAG,X'40'      HAS DOLLARS?                                 
         BZ    PAYERR10            NO                                           
         MVC   P+70(15),=C'**AND DOLLARS**'                                     
*                                                                               
PAYERR10 GOTO1 =V(PRINTER)                                                      
PAYERRX  XIT1                                                                   
*                                                                               
OTOERR   NTR1                                                                   
         CLC   ALLOCKEY,REC+24        TEST SAME KEY AS PREVIOUS                 
         BE    OTOERRX                                                          
         MVC   ALLOCKEY,REC+24                                                  
         AP    BADRECS,=P'1'                                                    
*                                                                               
         BRAS  RE,PRTBUY                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
         MVC   P(22),=C'*ERROR* TOO MANY -OTOS'                                 
         GOTO1 VHEXOUT,DMCB,REC+12,P+30,4,=C'TOG'     DISK ADDR                 
         LA    R0,REC+24                                                        
         SR    R0,R2                                                            
         LPR   R0,R0                                                            
         ST    R0,DUB                                                           
         MVC   P+50(7),=C'EL DISP'                                              
         GOTO1 (RF),(R1),DUB,P+58                                               
         GOTO1 =V(PRINTER)                                                      
         B     OTOERRX                                                          
**NOP**                                                                         
         GOTO1 VPRTREC,DMCB,(C'E',REC+24),(24,13),                     X        
               VPRINT,VHEXOUT                                                   
OTOERRX  XIT1                                                                   
*                                                                               
TIMEERR  NTR1                                                                   
         CLC   ALLOCKEY,REC+24        TEST SAME KEY AS PREVIOUS                 
         BE    TIMEERR2                                                         
         MVC   ALLOCKEY,REC+24                                                  
         AP    BADRECS,=P'1'                                                    
*                                                                               
         BRAS  RE,PRTBUY                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
TIMEERR2 MVC   P(30),=C'*ERROR* BDTIME <> 0 ON POL BUY'                         
         GOTO1 VHEXOUT,DMCB,REC+12,P+32,4,=C'TOG'     DISK ADDR                 
         MVC   P+50(4),=C'RSIN'                                                 
         EDIT  DM$RSIN,(6,P+56)                                                 
         GOTO1 =V(PRINTER)                                                      
         J     EXIT                                                             
*                                                                               
DATEERR  NTR1                                                                   
         CLC   ALLOCKEY,REC+24        TEST SAME KEY AS PREVIOUS                 
         BE    DATEERR2                                                         
         MVC   ALLOCKEY,REC+24                                                  
         AP    BADRECS,=P'1'                                                    
*                                                                               
         BRAS  RE,PRTBUY                                                        
         GOTO1 =V(PRINTER)                                                      
*                                                                               
DATEERR2 MVC   P(32),=C'*ERROR* SPOTS OUTSIDE BUY PERIOD'                       
         GOTO1 VHEXOUT,DMCB,REC+12,P+34,4,=C'TOG'     DISK ADDR                 
         LA    R0,REC+24                                                        
         SR    R0,R2                                                            
         LPR   R0,R0                                                            
         ST    R0,DUB                                                           
         MVC   P+50(7),=C'EL DISP'                                              
         GOTO1 (RF),(R1),DUB,P+58                                               
         MVC   P+70(4),=C'RSIN'                                                 
         EDIT  DM$RSIN,(6,P+76)                                                 
         GOTO1 =V(PRINTER)                                                      
*                                                                               
DATEERRX J     EXIT                                                             
*                                                                               
SLNERR   NTR1                                                                   
         CLI   DM$RRECTY,DM$RRECTCPY IF COPY OR DELETED, DON'T PRINT            
         BE    SLNERRX                                                          
         TM    BUYREC+15,X'80'                                                  
         BNZ   SLNERRX                                                          
         AP    BADRECS,=P'1'                                                    
         MVC   P(21),=C'*ERROR* BAD BDSEC SLN'                                  
         GOTO1 =V(PRINTER)                                                      
         GOTO1 (RF),(R1)                                                        
*                                                                               
         GOTO1 VPRTREC,DMCB,(C'E',REC+24),(24,13),                     X        
               VPRINT,VHEXOUT                                                   
SLNERRX  XIT1                                                                   
*                                                                               
BUYERR   NTR1                                                                   
         AP    BADRECS,=P'1'                                                    
         MVC   P(22),=C'*ERROR* BAD BUY RECORD'                                 
         GOTO1 =V(PRINTER)                                                      
         GOTO1 (RF),(R1)                                                        
*                                                                               
         GOTO1 VPRTREC,DMCB,(C'E',REC+24),(24,13),                     X        
               VPRINT,VHEXOUT                                                   
         XIT1                                                                   
         EJECT                                                                  
BLDPIG   LA    R2,BDELEM                                                        
         SR    R0,R0                                                            
BLDPIG2  IC    R0,1(R2)                                                         
         LTR   R0,R0                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R2),4                                                          
         BNE   BLDPIG2                                                          
         IC    R0,1(R2)                                                         
         SRDA  R0,32                                                            
         D     R0,=F'7'                                                         
         LR    R0,R1                                                            
         LA    R3,2(R2)                                                         
BLDPIG4  BAS   RE,BLDKEY                                                        
                                                                                
* BACK UP TO PREVIOUS TO FIX EST                                                
                                                                                
         LR    RE,R8                                                            
         LA    RF,SRTRECLN                                                      
         SR    RE,RF                                                            
         LA    RE,SRTEST-SRTREC(RE)                                             
         MVC   0(1,RE),1(R3)                                                    
*                                                                               
         LA    R3,7(R3)                                                         
         BCT   R0,BLDPIG4                                                       
         B     BLDPROC                                                          
         EJECT                                                                  
BLDKEY   NTR1                                                                   
         LAY   R1,SRTBEND              END OF BUFFER                            
         CR    R8,R1                   ABOUT TO BLOW PAST BUFFER?               
         BNL   BLDKEYD0                YES                                      
*                                                                               
         XC    SRTREC(256),SRTREC                                               
         XC    SRTREC+256(256),SRTREC+256                                       
         MVC   SRTAGY,BUYREC+20                                                 
         MVC   SRTAGMD,BUYREC                                                   
         MVC   SRTCLT,BUYREC+1                                                  
         MVI   SRTTYPE,C'A'                                                     
         MVC   SRTPRD,0(R3)                                                     
         MVC   SRTEST,BUYREC+9                                                  
         MVC   SRTSTA,BUYREC+6                                                  
         LLC   R0,BUYREC+10        ASSUME 1-BYTE LINE NUMBER                    
         TM    BUYREC+15,BUYRLN2       TEST 2-BYTE LINE NUMBER                  
         BZ    *+8                                                              
         ICM   R0,3,BUYREC+10                                                   
         STCM  R0,3,SRTLIN                                                      
         MVC   SRTSEQ,SEQNO+1                                                   
         CLI   DM$RRECTY,DM$RRECTADD                                            
         BNE   *+8                                                              
         MVI   SRTIND,C'A'                                                      
         MVC   SRTSIN(3),DM$RSIN+1                                              
         MVC   SRTPTRPR,BUYREC+3                                                
         MVC   SRTPTRES,BUYREC+9                                                
         TM    BUYREC+(BDCANAD-BUYREC),X'80'  TEST CANADIAN                     
         BZ    BLDKEY10                                                         
         MVI   SRTCTRY,C'C'                                                     
* LOOK FOR CANAD NETWORK ELEM IN EXPLODED BUYS                                  
         LA    RF,BDELEM                                                        
         SR    RE,RE                                                            
*                                                                               
BLDKEY2  ICM   RE,1,1(RF)                                                       
         BZ    BLDKEY10                                                         
         AR    RF,RE                                                            
         CLI   0(RF),0                                                          
         BE    BLDKEY10                                                         
         CLI   0(RF),X'68'                                                      
         BNE   BLDKEY2                                                          
         CLI   1(RF),6                                                          
         BNE   BLDKEY10                                                         
         MVC   SRTCNNET,2(RF)                                                   
*                                                                               
BLDKEY10 LA    R8,SRTRECLN(R8)                                                  
         XC    SRTLEN,SRTLEN                                                    
         XC    SRTKEY,SRTKEY                                                    
         XIT1  REGS=(R8)                                                        
*                                                                               
BLDKEYD0 DC    H'0'                    DEATH, BUFFER OVERFLOW                   
         EJECT                                                                  
BLDPROC  L     R8,=A(SRTBUFF)                                                   
         USING SRTRECD,R8                                                       
         TM    BUYREC+15,X'80'     TEST RECORD IS DELETED                       
         BO    BLDX                YES - EXIT                                   
         B     BLDP2B                                                           
*                                                                               
BLDP2A   LA    R8,SRTRECLN(R8)                                                  
*                                                                               
         CLI   SRTTYPE,C'A'        TEST ANALYSIS REC                            
         BNE   BLDPAY              NO - TEST TO BUILD PAY REC                   
*                                                                               
BLDP2B   LA    R2,BDELEM                                                        
*                                                                               
BLDP4    SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         LTR   R0,R0                                                            
         BZ    BLDP2A                                                           
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    BLDP2A              NEXT PRD                                     
         CLI   0(R2),6                                                          
         BL    BLDP4                                                            
         CLI   0(R2),10                                                         
         BL    BLDP8                                                            
         CLI   0(R2),11                                                         
         BL    BLDP4                                                            
         CLI   0(R2),14                                                         
         BL    BLDP6                                                            
         B     BLDP4                                                            
*                                                                               
* ELEMENT PROCESSING FOR POL                                                    
*                                                                               
BLDP6    TM    6(R2),X'04'         TEST HIATUS                                  
         BO    BLDP4               YES-NEXT ELEM                                
         LA    R3,10(R2)                                                        
         IC    R0,1(R2)                                                         
         AHI   R0,-10                                                           
         BNZ   BLDP7                                                            
         CLI   SRTPRD,X'FF'        SKIP UNALL UNLESS PROCSNG POL                
         BE    BLDP8                                                            
         B     BLDP4                                                            
BLDP7    SRL   R0,2                SET FOR BCT                                  
*                                                                               
BLDP7A   CLC   SRTPRD,0(R3)                                                     
         BE    BLDP8                                                            
BLDP7B   LA    R3,4(R3)                                                         
         BCT   R0,BLDP7A                                                        
         B     BLDP4                                                            
*                                                                               
BLDP8    DS    0H                                                               
         LA    RE,SPOTS                                                         
         ST    RE,P1                                                            
         MVC   P1(1),SRTPRD                                                     
*                                                                               
         LA    RE,BUYREC                                                        
         ST    RE,P2                                                            
         ST    R2,P3                                                            
         TM    BDCIND2,X'20'       TEST CANADIAN AGENCY                         
         BZ    BLDP8A                                                           
         MVI   P3,C'Z'             INDICATE EXCHANGE AREA PRESENT               
         LA    RE,XGROSS                                                        
         ST    RE,P4                                                            
         MVI   P4,C'C'             REQUEST CANADIAN CURRENCY                    
*                                                                               
BLDP8A   XC    XGSTAMT,XGSTAMT     CLEAR IN CASE NOT CANADIAN                   
         XC    XPSTTAB(XPSTTABX-XPSTTAB),XPSTTAB                                
         GOTO1 GETRATE,P1                                                       
*                                                                               
         LM    R6,R7,GROSS                                                      
         CLI   BDXFRAGY,0          TEST CAME FROM ANOTHER SPTFILE               
         BE    *+8                 NO - USE IT                                  
         SR    R6,R6               ELSE CLEAR DOLLARS                           
         SR    R7,R7                                                            
*                                                                               
         CLI   DM$RRECTY,DM$RRECTCPY TEST COPY                                  
         BNE   *+8                 NO                                           
*                                                                               
         LCR   R6,R6               COMPLEMENT DOLLARS                           
         LCR   R7,R7                                                            
* NOW GET MONTH AND YEAR                                                        
         MVC   DUB(2),2(R2)                                                     
         TM    BDSTAT,X'01'        TEST NETPAK                                  
         BO    BLDP8X                                                           
         OC    2(2,R2),2(R2)       TEST ZERO DATE                               
         BZ    BLDP4                                                            
         CLI   2(R2),X'FF'         TEST BAD DATE                                
         BE    BLDP4                                                            
         GOTO1 =V(BRDMON),P1,(X'FF',2(R2)),DUB                                  
*                                                                               
BLDP8X   LH    R4,DUB                                                           
         SLL   R4,16                                                            
         SRDL  R4,25                                                            
         STC   R4,DUB                                                           
         SRL   R5,28                                                            
         STC   R5,DUB+1                                                         
* TEST IF HAVE ELEMENT FOR THIS Y/M                                             
         LA    R4,SRTBCKTS                                                      
BLDP9    CLI   0(R4),0                                                          
         BE    BLDP10                                                           
         CLC   0(2,R4),DUB                                                      
         BE    BLDP11                                                           
         LA    R4,L'SRTBCKTS(R4)   NEXT BUCKET                                  
         B     BLDP9                                                            
SEL      USING SRTEL,R4                                                         
*                                                                               
BLDP10   MVC   SEL.SRTEL,DUB       Y/M                                          
         ZAP   SEL.SRTELOG,=P'0'                                                
         ZAP   SEL.SRTELON,=P'0'                                                
         ZAP   SEL.SRTELPG,=P'0'                                                
         ZAP   SEL.SRTELPN,=P'0'                                                
         ZAP   SEL.SRTELGST,=P'0'                                               
         ZAP   SEL.SRTELPST,=P'0'                                               
*                                                                               
BLDP11   CVD   R6,DUB              GROSS ORD                                    
         AP    SEL.SRTELOG,DUB                                                  
         CVD   R7,DUB2             NET ORD                                      
         AP    SEL.SRTELON,DUB2                                                 
*                                                                               
         OC    4(2,R2),4(R2)       TEST PAID                                    
         BZ    BLDP20                                                           
*                                                                               
BLDP12   AP    SEL.SRTELPG,DUB     GROSS PAID                                   
         AP    SEL.SRTELPN,DUB2    NET PAID                                     
*                                                                               
         L     RE,XGSTAMT          GST PAID                                     
         CLI   DM$RRECTY,DM$RRECTCPY TEST COPY                                  
         BNE   *+6                 NO                                           
         LCR   RE,RE                                                            
         CVD   RE,DUB                                                           
         AP    SEL.SRTELGST,DUB                                                 
*                                                                               
         LA    RE,XPSTTAB          PST PAID                                     
         LA    RF,10                                                            
*                                                                               
BLDP14   CLI   XPSTCODE-XPSTTAB(RE),C' '   TEST PST CODE PRESENT                
         BNH   BLDP16                      NO - DONE                            
         L     R5,XPSTAMT-XPSTTAB(RE)                                           
         CLI   DM$RRECTY,DM$RRECTCPY TEST COPY                                  
         BNE   *+6                 NO                                           
         LCR   R5,R5                                                            
         CVD   R5,DUB                                                           
         AP    SEL.SRTELPST,DUB                                                 
*                                                                               
BLDP16   LA    RE,XPSTLEN(RE)                                                   
         BCT   RF,BLDP14                                                        
*                                                                               
BLDP20   DS    0H                                                               
         CLI   BUYKEY+3,X'FF'      TEST POOL                                    
         BNE   BLDP4                                                            
         CLI   1(R2),10            TEST UNALL                                   
         BE    BLDP4                                                            
         B     BLDP7B              TEST FOR MORE ALLOCATIONS                    
*                                                                               
         DROP  SEL                                                              
         EJECT                                                                  
BLDPAY   CLI   DM$RPRG,X'13'       TEST PAY PROGRAM                             
         BNE   BLDX                                                             
*                                                                               
* FIND OR BUILD PAYMENT REC                                                     
*                                                                               
PAY2     CLI   SRTTYPE,C'P'                                                     
         BE    PAY6                                                             
*                                                                               
PAY4     LR    R7,R8               SAVE R8                                      
         BAS   RE,BLDKEY                                                        
         LR    R8,R7               RESTORE R8                                   
*                                                                               
         MVI   SRTTYPE,C'P'                                                     
         MVC   SRPCLT,BUYKEY+1         CLT                                      
         MVC   SRPSIN,DM$RSIN+1                                                 
         MVC   SRPPRD,BUYKEY+3         PRD                                      
         MVC   SRPEST,BUYKEY+9         EST                                      
         MVC   SRPSTA,BUYKEY+6         STA (IF NOT CANADIAN NETWORK)            
         MVC   SRPSTAPR,BUYKEY+6       STA (TO PRINT)                           
         LLC   R0,BUYREC+10        ASSUME 1-BYTE LINE NUMBER                    
         TM    BUYREC+15,BUYRLN2       TEST 2-BYTE LINE NUMBER                  
         BZ    *+8                                                              
         ICM   R0,3,BUYREC+10                                                   
         STCM  R0,3,SRPLIN                                                      
         TM    BDCIND2,X'20'       CANADIAN?                                    
         BNZ   PAY4A               YES                                          
         CLI   SRPSTA,X'E8'        TEST CABLE                                   
         BL    *+8                                                              
         NI    SRPSTA+2,X'80'      DROP NETWORK BITS FOR SORT                   
*                                                                               
PAY4A    LA    R4,SRTEL                                                         
SEL      USING SRTEL,R4                                                         
* ALWAYS BUILDS ONE CLEARANCE ELEMENT                                           
         MVC   SEL.SRTEL,=X'FFFF'      Y/M                                      
         ZAP   SEL.SRTELOG,=P'0'                                                
         ZAP   SEL.SRTELON,=P'0'                                                
         ZAP   SEL.SRTELPG,=P'0'                                                
         ZAP   SEL.SRTELPN,=P'0'                                                
         ZAP   SEL.SRTELGST,=P'0'                                               
         ZAP   SEL.SRTELPST,=P'0'                                               
         DROP  SEL                                                              
*                                                                               
         LA    R2,BDELEM                                                        
         SR    R0,R0                                                            
PAY5     ICM   R0,1,1(R2)                                                       
         BZ    PAY6                DO NOT DIE !                                 
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    PAY6                                                             
         CLI   0(R2),X'68'         TEST FOR CANAD NTWK ELEMENT                  
         BNE   PAY5                                                             
         CLI   1(R2),6             MAKE SURE IT IS A NETWORK POINTER            
         BNE   PAY6                                                             
*                                                                               
         L     R1,=A(STAWORK)                                                   
         XC    0(32,R1),0(R1)                                                   
         USING STAPACKD,R1                                                      
*                                                                               
         MVI   STAPACT,C'P'                                                     
         MVC   STAPAGY,BUYALPHA                                                 
         MVI   STAPMED,C'N'                                                     
         MVC   STAPACOM,=A(COMFACS)                                             
         MVI   STAPCTRY,C'C'       FORCE COUNTRY TO CANADA                      
         MVC   STAPQMKT,=4C'0'                                                  
         MVC   STAPQSTA(4),2(R2)                                                
         MVI   STAPQSTA+4,C'N'                                                  
         L     RF,STAPACK                                                       
         GOTO1 (RF),(R1)                                                        
         MVC   SRPSTA,STAPSTA      MOVE SORT STATION                            
         DROP  R1                                                               
*                                                                               
PAY6     LA    R4,SRTEL                                                         
SEL      USING SRTEL,R4                                                         
*                                                                               
         LA    R2,BDELEM                                                        
*                                                                               
PAY8     SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         LTR   R0,R0                                                            
         BZ    BLDX                                                             
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    BLDX                                                             
         CLI   0(R2),6                                                          
         BL    PAY8                                                             
         CLI   0(R2),13                                                         
         BH    PAY8                                                             
*                                                                               
         OC    4(2,R2),4(R2)       TEST PAID                                    
         BZ    PAY8                NO                                           
*                                                                               
         MVI   BDTIME,0            FORCE NO P/B SPLIT                           
         LA    RE,SPOTS                                                         
         ST    RE,P1                                                            
         MVC   P1(1),BUYKEY+3                                                   
         LA    RE,BUYREC                                                        
         ST    RE,P2                                                            
         ST    R2,P3                                                            
         TM    BDCIND2,X'20'       TEST CANADIAN AGENCY                         
         BZ    PAY8A                                                            
         MVI   P3,C'Z'             EXCHANGE AREA NEEDED FOR GST/PST             
         LA    RE,XGROSS                                                        
         ST    RE,P4                                                            
         MVI   P4,C'C'             REQUEST CANADIAN CURRENCY                    
*                                                                               
PAY8A    XC    XGSTAMT,XGSTAMT     CLEAR IN CASE NOT CANADIAN                   
         XC    XPSTTAB(XPSTTABX-XPSTTAB),XPSTTAB                                
         GOTO1 GETRATE,P1                                                       
*                                                                               
         LM    R6,R7,GROSS                                                      
         CLI   BDXFRAGY,0          TEST CAME FROM ANOTHER SPTFILE               
         BE    *+8                 NO - USE IT                                  
         SR    R6,R6               ELSE CLEAR DOLLARS                           
         SR    R7,R7                                                            
         CLI   DM$RRECTY,DM$RRECTCPY TEST COPY                                  
         BNE   *+8                                                              
         LCR   R6,R6                                                            
         LCR   R7,R7                                                            
*                                                                               
         CVD   R6,DUB                                                           
         CVD   R7,DUB2                                                          
         AP    SEL.SRTELPG,DUB                                                  
         AP    SEL.SRTELPN,DUB2                                                 
*                                                                               
         L     R6,XGSTAMT                                                       
         CLI   DM$RRECTY,DM$RRECTCPY                                            
         BNE   *+6                                                              
         LCR   R6,R6                                                            
         CVD   R6,DUB                                                           
         AP    SEL.SRTELGST,DUB                                                 
*                                                                               
         TM    BDCIND2,X'20'       TEST CANADIAN                                
         BZ    PAY20                                                            
*                                                                               
         LA    RE,XPSTTAB                                                       
         LA    RF,10                                                            
*                                                                               
PAY15    CLI   XPSTCODE-XPSTTAB(RE),C' '  TEST PST CODE PRESENT                 
         BNH   PAY17                      NO - DONE                             
         L     R0,XPSTAMT-XPSTTAB(RE)                                           
         CLI   DM$RRECTY,DM$RRECTCPY                                            
         BNE   *+6                                                              
         LCR   R0,R0                                                            
         CVD   R0,DUB                                                           
         AP    SEL.SRTELPST,DUB                                                 
*                                                                               
PAY17    LA    RE,XPSTLEN(RE)                                                   
         BCT   RF,PAY15                                                         
*                                                                               
PAY20    DS    0H                                                               
         B     PAY8                                                             
*                                                                               
BLDX     XIT1                                                                   
*                                                                               
         DROP  SEL                                                              
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
PRTBUY   NTR1  BASE=*,LABEL=*                                                   
         MVC   P(2),BUYREC+20                                                   
*                                                                               
         SR    RE,RE                                                            
         IC    RE,BUYREC                                                        
         N     RE,=X'0000000F'                                                  
         BCTR  RE,0                                                             
         L     RF,=A(MDTAB)                                                     
         AR    RE,RF                                                            
         MVC   P+3(1),0(RE)                                                     
*                                                                               
         L     RE,=A(CLTHDR)                                                    
         CLC   BUYREC(3),1(RE)                                                  
         BE    PRTB1                                                            
         XC    KEY,KEY                                                          
         MVC   KEY+1(3),BUYREC                                                  
         MVC   KEYSAVE,KEY                                                      
         GOTO1 =V(DATAMGR),DMCB,=C'DMRDHI',=C'SPTDIR',KEYSAVE,KEY               
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DCHO                                                                   
*                                                                               
         L     RE,=A(CLTHDR)                                                    
         ST    RE,AIOAREA                                                       
         LA    RF,=C'GETREC'                                                    
         ST    RF,DMCB                                                          
         GOTO1 =V(DATAMGR),DMCB,,=C'SPTFILE',KEY+14,AIOAREA,DMWORK              
         BE    *+6                                                              
         DCHO                                                                   
*                                                                               
PRTB1    L     R5,=A(CLTHDR)                                                    
         LA    R5,CPROF+6-CLTHDR(R5)                                            
         GOTO1 CLUNPK,DMCB,(0(R5),BUYREC+1),P+6                                 
*                                                                               
         LA    RE,=C'POL'                                                       
         CLI   BUYREC+3,X'FF'                                                   
         BE    PRTB4                                                            
         L     RE,=A(CLTHDR)                                                    
         LA    RE,CLIST-CLTHDR(RE)                                              
*                                                                               
PRTB2    CLC   BUYREC+3(1),3(RE)                                                
         BE    PRTB4                                                            
         LA    RE,4(RE)                                                         
         CLI   0(RE),C'A'                                                       
         BNL   PRTB2                                                            
         DC    H'0'                                                             
PRTB4    MVC   P+10(3),0(RE)                                                    
*                                                                               
         L     R1,=A(STAWORK)                                                   
         XC    0(32,R1),0(R1)                                                   
         USING STAPACKD,R1                                                      
*                                                                               
         MVI   STAPACT,C'U'                                                     
         MVC   STAPAGY,BUYREC+20                                                
         MVC   STAPMED,P+3                                                      
         MVC   STAPACOM,=A(COMFACS)                                             
         MVC   STAPMKST,BUYREC+4                                                
*                                                                               
         LA    RE,AGYTAB                                                        
         LA    RF,16                                                            
PRTB6    CLC   0(2,RE),STAPAGY                                                  
         BE    PRTB8                                                            
         LA    RE,4(RE)                                                         
         BCT   RF,PRTB6                                                         
         DC    H'0'                                                             
PRTB8    MVC   STAPCTRY,2(RE)      MOVE COUNTRY CODE                            
*                                                                               
         L     RF,STAPACK                                                       
         GOTO1 (RF),(R1)                                                        
         CLI   STAPERR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   P+15(8),STAPQSTA   MOVE PRINTABLE STATION                        
*                                                                               
         SR    R0,R0                                                            
         IC    R0,BUYREC+9                                                      
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+24(3),DUB                                                      
         MVI   P+27,C'-'                                                        
*                                                                               
         IC    R0,BUYREC+10                                                     
         TM    BUYREC+15,BUYRLN2   TEST 2-BYTE LINE NUMBER                      
         BZ    *+8                                                              
         ICM   R0,3,BUYREC+10                                                   
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+28(3),DUB                                                      
*                                                                               
PRTBUYX  XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*=================================================================              
* SEND AN EMAIL TO THE SPOT FOLKS IF ANY ERROR COUNTERS NON-ZERO                
*=================================================================              
                                                                                
ERRCHECK NTR1  BASE=*,LABEL=*                                                   
         CP    PRDERRS,=P'0'                                                    
         BNE   ERRCH2                                                           
         CP    ESTERRS,=P'0'                                                    
         BNE   ERRCH2                                                           
         CP    INVERRS,=P'0'                                                    
         BNE   ERRCH2                                                           
         CP    BADRECS,=P'0'                                                    
         BNE   ERRCH2                                                           
         CP    UNKCTR,=P'0'                                                     
         BNE   ERRCH2                                                           
         CP    CPYCHCTR,=P'0'                                                   
         BNE   ERRCH2                                                           
         CP    PAYDSCR,=P'0'       PAY DISCREPANCY?                             
         BNE   ERRCH2              YES                                          
         B     ERRCHX                                                           
*                                                                               
ERRCH2   CLI   EMAILSW,C'Y'        TEST OPTION TO SUPPRESS                      
         BNE   ERRCHX                                                           
         GOTOR VSMTP,DMCB,('SMTPAINI',0)                                        
                                                                                
         MVC   SUBJECT+5(4),SVSYS+4   PRINT WHATEVER FOLLOWS SPOT               
*                                                                               
         LA    R2,FULL                                                          
         EXTRACT (R2),'S',FIELDS=(ASID)                                         
         LA    R1,FULL                                                          
         L     R2,0(R1)                                                         
         LOCASCB ASID=(R2)         GET ASCB ADDRESS INTO R1                     
         L     R2,ASCBASSB-ASCB(R1) R2 = A(ASSB)                                
         SAM31                     SWITCH TO 31-BIT MODE                        
         L     R1,ASSBJSAB-ASSB(R2) R1 = A(JSAB)                                
         MVC   SUBJOBNO,JSABJBID-JSAB(R1)  JOB#####                             
         SAM24                     SWITCH BACK TO 24-BIT MODE                   
         LA    R2,FULL                                                          
         EXTRACT (R2),FIELDS=TIOT                                               
         L     R2,FULL                                                          
         MVC   SUBJOBNM,0(R2)      JOBNAME                                      
*                                                                               
         GOTOR VSMTP,DMCB,('SMTPAPRS',TOWHO),('SUBJECTL',SUBJECT)               
         GOTOR VSMTP,DMCB,('SMTPAPTL',LINE1)                                    
*                                                                               
         LA    R2,UNKCTR           ERRORS                                       
         LA    R3,7                7 ERROR COUNTERS                             
*                                                                               
ERRCH3   CP    0(4,R2),=P'0'       ANY ERRORS?                                  
         BE    ERRCH4              NO                                           
         MVC   P,SPACES            CLEAR P                                      
         MVC   P(20),4(R2)         STRING                                       
         EDIT  (P4,0(R2)),(10,P+21),COMMAS=YES,ALIGN=LEFT                       
         LA    R4,P+31             END OF STRING                                
         CLI   0(R4),C'0'          LAST DIGIT?                                  
         BNL   *+8                 YES                                          
         BCT   R4,*-8              NO - CHECK PREVIOUS                          
         MVC   2(8,R4),=C'ERROR(S)'                                             
         MVC   11(27,R4),=C'SEARCH FOR STRING "*ERROR*"'                        
         LA    R5,INVERRS          POINT TO INVOICE ERRORS                      
         CR    R2,R5               ARE WE PROCESSING INVOICE ERRORS?            
         BNE   *+10                NO                                           
         MVC   30(18,R4),=C'** DISCREPANCY **"'                                 
         GOTOR VSMTP,DMCB,('SMTPAPTL',P)                                        
*                                                                               
ERRCH4   LA    R2,24(R2)                                                        
         BCT   R3,ERRCH3                                                        
*                                                                               
         GOTOR VSMTP,DMCB,('SMTPASND',0)                                        
         GOTOR VSMTP,DMCB,('SMTPAEND',0) DETACH SMTP                            
ERRCHX   XIT1                                                                   
*                                                                               
VSMTP    DC    V(SMTP)                                                          
*                                                                               
* FIELD 'TOWHO' IS INITIALIZED TO A DEFAULT E-MAIL RECIPIENT LIST. IT           
* MAY BE OVERRIDDEN VIA AN EID= PARAMETER CARD.                                 
*                                                                               
TOWHO    DC    CL72'MHER,ERAT,EJOR,WHOA,AFRE,PHEA,AKAT,HWON,DEIS:'              
*                                                                               
SUBJECT  DC    C'SP133XYAA PROCESSING ERRORS HAVE OCCURRED ('                   
SUBJOBNM DS    CL8                                                              
         DC    C' '                                                             
SUBJOBNO DS    CL8                                                              
         DC    C')'                                                             
SUBJECTL EQU  *-SUBJECT                                                         
LINE1    DC    CL80'PLEASE CHECK OUTPUT'                                        
EMAILSW  DC    C'Y'                                                             
         LTORG                                                                  
         EJECT                                                                  
         DS    0D                                                               
STAWORK  DS    XL32                                                             
         DS    0D                                                               
         DC    CL8'*STAREC*'                                                    
         DS    512C                                                             
         ORG   *-512                                                            
       ++INCLUDE SPGENSTA                                                       
         ORG                                                                    
                                                                                
* BUFFER BELOW IS USED TO BUILD SORT RECORDS, NOT BY SORT *                     
                                                                                
         DS    0D                                                               
         DC    CL8'*SRTBUF*'                                                    
SRTBUFF  DS    106496C              208 X 512 BYTES/REC                         
SRTBEND  EQU   *                                                                
*                                                                               
         DS    0D                                                               
         DC    CL8'**UTL **'                                                    
UTL      DC    F'0',X'00',XL3'00',XL56'00'                                      
*                                                                               
         DS    0D                                                               
         DC    CL8'**SSB **'                                                    
* ++INCLUDE FASSBOFF                                                            
         PRINT OFF                                                              
       ++INCLUDE FASSBOFF                                                       
         PRINT ON                                                               
         ORG   SSOOFF                                                           
SSB      DC    XL(SSOOFFX-SSOOFF)'00'                                           
         ORG   SSOXTND                                                          
         DC    X'FF'               SET EXTENDED OFFLINE SSB                     
         ORG   SSOSTAT2            SYSTEM DATAMGR FLAGS                         
         DC    AL1(SSOSNRCV)       NO RECOVERY                                  
         ORG   SSODATE             DATE AS DEFINED BY SSOFLAG1                  
         DC    CL8' '                                                           
         ORG                                                                    
*                                                                               
         DS    0D                                                               
         DC    CL8'*COMFACS'                                                    
COMFACS  DS    0D                                                               
         DC    V(DATAMGR)                                                       
         DC    V(CALLOV)                                                        
         DC    69A(0)                                                           
         EJECT                                                                  
QSPTFIL  EQU   X'21'                                                            
QREQFIL  EQU   X'25'                                                            
*                                                                               
COPY     EQU   1                                                                
CHG      EQU   2                                                                
ADD      EQU   3                                                                
*                                                                               
         PRINT OFF                                                              
         EJECT                                                                  
       ++INCLUDE CTGENFILE                                                      
         PRINT ON                                                               
* DDSYSELD                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDSYSELD                                                       
         PRINT ON                                                               
         EJECT                                                                  
       ++INCLUDE SPSTAPACKD                                                     
                                                                                
SP133WRK CSECT                                                                  
       ++INCLUDE SP133WRK                                                       
         EJECT                                                                  
* DDSMTPD                                                                       
* FAUTL                                                                         
         PRINT OFF                                                              
       ++INCLUDE DDSMTPD                                                        
         EJECT                                                                  
       ++INCLUDE FAUTL                                                          
         EJECT                                                                  
         IHAASCB                                                                
         IHAASSB                                                                
         IAZJSAB                                                                
         PRINT ON                                                               
         SPACE 3                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'012SP133     09/19/19'                                      
         END                                                                    
