*          DATA SET ACJAX      AT LEVEL 049 AS OF 10/13/16                      
*CATALP ACJAX                                                                   
         TITLE 'ACJAX - JOB ACCOUNTING EXTRACT'                                 
ACJAX    CSECT                                                                  
         PRINT NOGEN                                                            
BGN      NMOD1 LWSLNQ,**AJAX**,RA,RR=RE,CLEAR=YES                               
         USING LWSD,RC                                                          
         ST    RE,RELO                                                          
         LR    R9,R1                                                            
         USING JXD,R9                                                           
         LA    R1,BILLTAB                                                       
         ST    R1,ABILLTAB                                                      
         ICM   R8,15,JXAGOBK                                                    
         USING GOBLOCKD,R8                                                      
         EJECT                                                                  
***********************************************************************         
* INITIALIZE                                                          *         
***********************************************************************         
         MVC   COMFACS,JXACOMF                                                  
         MVC   GETOPT,JXAGETOP                                                  
         MVC   JOBBER,JXAJOBR                                                   
         MVC   JOBCOL,JXAJOBC                                                   
         ZAP   PZERO,PZRO                                                       
         MVC   JXBILLQ,=C'99'                                                   
         MVC   JXORDRQ,=C'**'                                                   
*                                                                               
         L     RF,COMFACS                                                       
         MVC   DATAMGR,CDATAMGR-COMFACSD(RF)                                    
         MVC   DATCON,CDATCON-COMFACSD(RF)                                      
         MVC   ADDAY,CADDAY-COMFACSD(RF)                                        
         MVC   GETTXT,CGETTXT-COMFACSD(RF)                                      
*                                                                               
         LA    RF,LWSD                                                          
         AHI   RF,IO1-LWSD                                                      
         ST    RF,AIO1                                                          
         LA    RF,LWSD                                                          
         AHI   RF,IO2-LWSD                                                      
         ST    RF,AIO2                                                          
         LA    RF,LWSD                                                          
         AHI   RF,IO3-LWSD                                                      
         ST    RF,AIO3                                                          
*                                                                               
         LA    RF,LWSD                                                          
         AHI   RF,COLIST-LWSD                                                   
         ST    RF,ACOLIST                                                       
         LA    RF,LWSD                                                          
         AHI   RF,COLTAB-LWSD                                                   
         ST    RF,ACOLTAB                                                       
         LA    RF,LWSD                                                          
         AHI   RF,OPVTAB-LWSD                                                   
         ST    RF,AOPVTAB                                                       
*                                                                               
         LARL  RF,XCPTAB                                                        
         ST    RF,ADXCP                                                         
*                                                                               
         MVC   COMMANDS,DMCMDS                                                  
         LHI   R1,ACCORFST                                                      
         STCM  R1,3,DATADISP                                                    
         LHI   R1,ACCRFST-ACCRECD                                               
         STCM  R1,3,NEWDISP                                                     
         TM    JXOPTS,JXOPMST                                                   
         BNO   *+10                                                             
         MVC   DATADISP,NEWDISP                                                 
*                                                                               
         MVI   SPACES,C' '                                                      
         MVC   SPACES+1(L'SPACES-1),SPACES                                      
*                                                                               
         OC    JXTODAY0,JXTODAY0                                                
         BNZ   SETUP2                                                           
         GOTO1 DATCON,DMCB,(5,0),(0,JXTODAY0)    GET SOME DATES                 
*                                                                               
SETUP2   GOTO1 DATCON,DMCB,(0,JXTODAY0),(1,JXTODAY1)                            
         GOTO1 DATCON,DMCB,(0,JXTODAY0),(2,JXTODAY2)                            
         GOTO1 ADDAY,DMCB,(C'M',JXTODAY0),WORK,F'-6'                            
         GOTO1 DATCON,DMCB,(0,WORK),(1,JXLESS6M)   TODAY LESS 6 MONTHS          
*                                                                               
*                                  SET JOBBER INTERFACE BLOCK                   
SETUP3   MVC   JBAJOB,JXAJOB       A(JOB)                                       
         MVC   JBACOM,COMFACS      A(COMFACS)                                   
         MVC   JBAGOBLK,JXAGOBK    A(GOBLOCK)                                   
         MVC   JBAIO,AIO1          A(IO1)                                       
         XC    JBASCH,JBASCH       A(SCHEME BLOCK)                              
         MVC   JBGETOPT,GETOPT     A(GETOPT)                                    
         MVC   JBSELSCH,GOSCHEME   SCHEME                                       
         MVI   JBSELFUN,JBGETDE    GET BO DETAILS                               
         LA    R1,ESTLH                                                         
         ST    R1,JBORICLI                                                      
*                                                                               
         MVC   JBACOLS,JXACOLS     A(COLUMN LIST)                               
         OC    JBACOLS,JBACOLS                                                  
         BNZ   *+10                                                             
         MVC   JBACOLS,ACOLIST     IF NONE, USE DEFAULTS                        
*                                                                               
         MVC   JBACOLTB,JXACOLTB   A(OUTPUT COLUMN TABLE)                       
         MVC   JBLCOLTB,JXLCOLTB   OUTPUT COLUMN LENGTH                         
         OC    JBACOLTB,JBACOLTB                                                
         BNZ   *+16                                                             
         MVC   JBACOLTB,ACOLTAB    IF NONE, USE DEFAULTS                        
         MVC   JBLCOLTB,COLTABLQ                                                
*                                                                               
         MVC   JBAOPVTB,JXAOPVTB   A(OPERAND VALUE TABLE)                       
         MVC   JBLOPVTB,JXLOPVTB   OPERAND VALUE TABLE LENGTH                   
         OC    JBAOPVTB,JBAOPVTB                                                
         BNZ   *+16                                                             
         MVC   JBAOPVTB,AOPVTAB    IF NONE, USE DEFAULTS                        
         MVC   JBLOPVTB,OPVTABLQ                                                
*                                                                               
         OC    JXBIGBAL,JXBIGBAL                                                
         BNZ   *+10                                                             
         ZAP   JXBIGBAL,PZERO                                                   
*                                                                               
         OC    JXWCFLT,JXWCFLT                                                  
         BNZ   *+10                                                             
         MVC   JXWCFLT,SPACES                                                   
*                                                                               
         L     RF,JXAJOB                                                        
         MVC   CPY,0(RF)           SAVE COMPANY CODE                            
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,1,JXACTN                                                      
         SLL   RF,2                                                             
         B     *(RF)                                                            
         B     ACF                 ACCOUNT FIRST                                
         B     PTN                 PROCESS TRANSACTION                          
         B     ACL                 ACCOUNT LAST                                 
         EJECT                                                                  
***********************************************************************         
* FIRST FOR ACCOUNT                                                   *         
***********************************************************************         
ACF      DS    0H                                                               
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         LA    R0,JXRTN            CLEAR JOBLOT RETURN DATA                     
         LA    R1,JXRLNQ                                                        
         MVCL  R0,RE                                                            
*                                                                               
         LA    R0,JXBN             INITIALISE ALL PACKED FIELDS                 
         LA    R1,JXBUCK                                                        
         ZAP   0(L'JXBK,R1),PZERO                                               
         LA    R1,L'JXBK(R1)                                                    
         BCT   R0,*-10                                                          
*                                                                               
         LA    R0,LBKN             INITIALISE LOCAL ACCUMULATORS                
         LA    R1,LBK                                                           
         ZAP   0(L'LBK,R1),PZERO                                                
         LA    R1,L'LBK(R1)                                                     
         BCT   R0,*-10                                                          
*                                                                               
         ZAP   JXDEBITS,PZERO                                                   
         L     RF,JXAJOB                                                        
         MVC   JXJOBK,0(RF)                                                     
*                                                                               
*              CALL JOBCOL TO GET ESTIMATE VALUES                               
         GOTO1 JOBCOL,DMCB,ESTLH,JBACOLS,COMFACS                                
         CLI   4(R1),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
*              CALL JOBBER                                                      
         LA    R0,LKEY          SAVE LAST KEY                                   
         ST    R0,ALKEY                                                         
         GOTO1 DATAMGR,DMCB,DMKEY,ACCDIR,(R0)                                   
*                                                                               
         MVC   JBAKEY,ALKEY        A(LAST KEY)                                  
         GOTO1 JOBBER,DMCB,JBLOCK                                               
         CLI   JBERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                DIE ON JOBBER ERROR                          
*                                                                               
         L     R7,GOAEXT                                                        
         USING GOXBLKD,R7                                                       
*                                                                               
         ICM   R4,15,JXACQ         TEST REQUEST PASSED                          
         JNZ   *+6                 NO,                                          
         DC    H'0'                NEED REQUEST CARD                            
         USING ACQD,R4                                                          
         LA    R1,PGMTAB                                                        
         CLC   ACQPROG,0(R1)                                                    
         BE    ACF03                                                            
         LA    R1,L'PGMTAB(R1)                                                  
         CLI   0(R1),X'FF'                                                      
         BNE   *-18                                                             
         DC    H'0'                INVALID REQUEST CARD                         
*                                                                               
ACF03    MVC   JXPGM,2(R1)         SAVE PROGRAM FLAGS                           
         MVC   JXMOA,ACQAPPL+6                                                  
         CLC   ACQACTST(L'ACQACTST+L'ACQACTND),SPACES                           
         BNH   *+8                                                              
         OI    JXSTATA,JXSANACT    SET NO ACTIVITY                              
         TM    JXPGM,JXREVQ        TEST UNBILLING                               
         BNO   ACF05                                                            
         TM    JXRROPT,JXRRORRB    TEST RERUN                                   
         BO    ACF07               YES, MUST BE OFFLINE                         
         BAS   RE,CHKUNB           CHECK BILL IS ELIGIBLE FOR UNBILLING         
         BE    ACF07               YES,                                         
         B     ACF45               GO TO END IT                                 
*                                                                               
ACF05    TM    JXPGM,JXA21Q        TEST 21 BILLING                              
         BNO   ACF07                                                            
         CLI   ACQOPT3,C'Y'                                                     
         BNE   *+8                                                              
         OI    JXOPTS2,JXODTBL     SET DEMAND TOTAL BILL                        
         CLI   ACQOPT3,C'R'                                                     
         BNE   *+8                                                              
         OI    JXOPTS2,JXORJOB     DEMAND TOTAL -RETAIL                         
         DROP  R4                                                               
*                                                                               
ACF07    CLI   JXRROPT,0           RERUN OR UBILL OPTION                        
         BE    ACF09                                                            
         CLI   GOBILTYP,C'U'       UNBILLABLE IS UNREVERSIBLE                   
         BE    ACF09                                                            
         GOTOR RERN,DMCB,(RC)                                                   
*                                                                               
ACF09    MVI   ELCODE,RSTELQ       GET STATUS ELEMENT                           
         LA    R0,3                FOR  CLI/PROD/JOB                            
         LA    R2,JXACLI                                                        
*                                                                               
ACF11    ICM   R3,15,0(R2)                                                      
         BRAS  RE,GETEL                                                         
         BNE   ACF13                                                            
         USING RSTELD,R3                                                        
         MVC   JXLPSTDT,RSTTDATE   LAST TRANSACTION POST DATE                   
         MVC   JXLBILDT,RSTPBILL   LAST BILLED DATE                             
         CLI   RSTLN,RSTLN2Q                                                    
         BL    ACF13                                                            
         TM    RSTSTAT2,RSTSBILN   TEST BILL SELECT = N                         
         BNO   *+8                                                              
         OI    JXSTAT2,JXS2BLSN    SET BILLSELECT=N                             
         TM    RSTSTAT2,RSTSBILY   TEST BILL SELECT = Y                         
         BNO   *+8                                                              
         NI    JXSTAT2,ALL-JXS2BLSN TURNOFF BILLSELECT=N                        
*                                                                               
ACF13    LA    R2,4(R2)                                                         
         BCT   R0,ACF11                                                         
*                                                                               
         TM    RSTSTAT1,RSTSACIC   TEST ACCOUNT CLOSED                          
         BNO   *+8                                                              
         OI    JXSTAT4,JXS4CLSD    SET CLOSED                                   
*                                                                               
         TM    RSTSTAT1,RSTSACIL   TEST ACCOUNT LOCKED                          
         BNO   *+8                                                              
         OI    JXSTAT4,JXS4LOCK    SET LOCKED                                   
*                                                                               
         MVC   BYTE,GOBILTYP       SAVE BILL TYPE                               
         CLI   BYTE,C'A'           AUTO CYCLE                                   
         BNE   *+8                                                              
         BAS   RE,GETCYC           GET CYCLE RECORD (SET BILLTYPE)              
         CLI   JXRROPT,0           TEST RERUN OR UNBILL                         
         BE    ACF15                                                            
         CLI   JXRRTYP,0           TEST TYPE FROM ORIGINAL BILL                 
         BE    ACF15               ASSUME POSTINGS NOT ON FILE                  
         MVC   BYTE,JXRRTYP        YES, USE ORIGINAL TYPE                       
*                                                                               
ACF15    L     R1,ABILLTAB          GET BILL TYPE DATA                          
         CLC   0(1,R1),BYTE                                                     
         BE    *+16                                                             
         LA    R1,L'BILLTAB(R1)                                                 
         CLI   0(R1),JXBLUNBL      NOT IN TABLE(MAKE IT UNBILLABLE)             
         BNE   *-18                                                             
         MVC   JXBLCODE(L'BILLTAB),0(R1)                                        
         TM    JXSTAT4,JXS4CLSD    TEST JOB CLOSED                              
         BO    ACF45               YES, OK TO SET ERROR                         
*                                                                               
         TM    JXOPTS2,JXORJOB+JXODTBL OPTION 3 SET?                            
         BZ    ACF16                                                            
         CLI   JXBLCODE,JXBLTOTL   BILLTYPE MUST BE TOTAL THEN                  
         BE    ACF16                                                            
         OI    JXSTAT7,JXSBILTY    INDICATE BILLTYPE WRONG                      
*                                                                               
ACF16    CLI   JXBLCODE,JXBLCLNT   TEST CLIENT TYPE                             
         BNE   ACF17               NO,                                          
         TM    JXPGM,JXA27Q        TEST A27 BILLING                             
         BO    ACF17               YES,                                         
         OI    JXSTAT1,JXS1CLB     SET ERROR                                    
         B     ACL11               GO TO END IT                                 
*                                                                               
ACF17    CLI   GOSTUDIO,YES        STUDIO OFFICE ?                              
         BNE   *+8                                                              
         OI    JXSTAT2,JXS2STUD                                                 
*                                                                               
         TM    JXRROPT,JXRROUNB+JXRRORRB TEST RERUN OR UNBILL                   
         BZ    ACF19                     NO,                                    
         TM    JXRROPT,JXRRORTL          TEST ORIGINAL WAS RETAIL               
         BNO   ACF21                     NO,                                    
*                                                                               
ACF19    CLC   GODIST,SPACES       DISTRIBUTOR CODE ?                           
         BNH   *+8                                                              
         OI    JXSTAT1,JXS1DIST                                                 
*                                                                               
ACF21    CLI   GOPAYNET,YES        PAY=NET ?                                    
         BNE   *+8                                                              
         OI    JXSTAT3,JXS3PNET                                                 
*                                                                               
         CLI   GOSUPAGY,YES        PAY=NET AND SUPPRESS                         
         BNE   *+8                                                              
         OI    JXSTAT3,JXS3PNET+JXS3SUPC                                        
*                                                                               
         CLI   JBNEWEST,YES        JOB USES NEW ESTIMATES ?                     
         BNE   *+8                                                              
         OI    JXSTAT3,JXS3NEWS                                                 
*                                                                               
         CLI   JBNEWEST,JBMCSQ     JOB USES MSC ESTIMATES ?                     
         BNE   *+8                                                              
         OI    JXSTAT3,JXS3NEWS+JXS3MCS                                         
*                                                                               
         CLI   GONEEDES,YES        ESTIMATE REQUIRED ?                          
*&&DO*&& BNE   *+8                                                              
         BNE   ACF23                                                            
         OI    JXSTAT3,JXS3ESRQ                                                 
*                                                                               
         TM    JXSTAT3,JXS3NEWS     JOB USES NEW ESTIMATES ?                    
         BNO   ACF23                                                            
         TM    JXSTAT3,JXS3ESRQ     ESTIMATE REQUIRED ?                         
         BNO   ACF23                                                            
*                                                                               
         CLI   GONEEDAE,YES        NEED NEW ESTIMATE TO BILL ?                  
         BNE   ACF23                                                            
         OI    JXSTAT3,JXS3NTOB                                                 
*                                                                               
         CLI   JBHIAPP,0           ANY APPROVED ESTIMATES ?                     
         BNE   *+12                                                             
         OI    JXSTAT3,JXS3UNEW    UNAPPROVED 'NEW' ESTIMATE                    
         B     ACF23                                                            
         OI    JXSTAT1,JXS1APPV                                                 
*                                                                               
         CLC   JBHIAPP,JBHIREV     ANY UNAPPROVED REVISIONS ?                   
         BE    ACF23                                                            
         OI    JXSTAT1,JXS1UNAR                                                 
*                                                                               
ACF23    MVI   ELCODE,ABLELQ       GET BALANCE ELEMENT                          
         L     R3,JXAJOB                                                        
         BRAS  RE,GETEL                                                         
         USING ABLELD,R3                                                        
         STCM  R3,15,JXAABLEL      SAVE ADDRESS OF BALANCE ELEMENT              
         ZAP   JXDBTS,ABLDR        DEBITS                                       
         ZAP   JXCRTS,ABLCR        CREDITS                                      
         ZAP   JXBALN,JXDBTS                                                    
         SP    JXBALN,JXCRTS       BALANCE                                      
*                                                                               
         MVI   ELCODE,JOBELQ                                                    
         L     R3,JXAJOB                                                        
         BRAS  RE,GETEL                                                         
         BNE   ACF25                                                            
         STCM  R3,15,JXAJOBEL      SAVE ADDRESS OF JOB                          
*                                                                               
         USING JOBELD,R3                                                        
         MVC   JXSTA1,JOBSTA1      SAVE JOB STATUS BYTES                        
         MVC   JXSTA2,JOBSTA2                                                   
         MVC   JXOPNDT,JOBADATE    JOB OPEN DATE                                
         MVC   JXCLSDT,JOBCDATE    JOB CLOSE DATE                               
*                                                                               
         TM    JOBSTA1,JOBSXJOB    IS IT AN X JOB ?                             
         BNO   *+8                                                              
         OI    JXSTAT4,JXS4XJOB                                                 
*                                                                               
         TM    JXSTAT3,JXS3NEWS    JOB USES NEW ESTIMATES ?                     
         BO    *+16                                                             
         TM    JOBSTA1,JOBSUEST    UNAPPROVED ESTIMATE (OLD)                    
         BNO   *+8                                                              
         OI    JXSTAT3,JXS3UOLD                                                 
*                                                                               
         CLI   GOBILFUN,YES        BILL ONLY FUNDED JOBS ?                      
         BNE   ACF25               NO                                           
         TM    JOBSTA2,JOBSFUN     IS JOB FUNDED ?                              
         BO    *+8                 YES                                          
         OI    JXSTAT5,JXS5NFND    SET ERROR - NOT FUNDED                       
*                                                                               
ACF25    MVI   ELCODE,LNKELQ       LINK DATA ELEMENT                            
         L     R3,JXAJOB                                                        
         BRAS  RE,GETEL                                                         
         BNE   ACF27                                                            
         USING LNKELD,R3                                                        
         OC    LNKAGJB,LNKAGJB     AGENCY JOB LINK ?                            
         BNZ   *+12                                                             
         OI    JXSTAT2,JXS2MISL    MISSING LINK                                 
         B     ACF27                                                            
         OI    JXSTAT2,JXS2LKAG                                                 
*                                                                               
ACF27    BAS   RE,BLDEST           BUILD ESTIMATE TABLE                         
         BAS   RE,BLDUSR           BUILD TABLE OF USER FIELDS                   
*                                                                               
         CLI   JXBLCODE,JXBLPEST   % OF ESTIMATE BILL ?                         
         BNE   ACF29                                                            
         BRAS  RE,PEST                                                          
         BAS   RE,ESTBIL           GET AMOUNTS FOR %EST BILL                    
*                                                                               
ACF29    MVC   JXLOREV,JBLOWREV    REVISION NUMBERS                             
         MVC   JXHIREV,JBHIREV                                                  
         MVC   JXHIAPP,JBHIAPP                                                  
*                                                                               
         ICM   R3,15,JBACOLTB                                                   
         USING JBCOLD,R3                                                        
         LA    R5,JBCOLVAL                                                      
         TM    JXSTAT3,JXS3MCS                                                  
         BNO   *+8                                                              
         USING MJETABD,R3                                                       
         LA    R5,MJETVAL                                                       
*                                                                               
         USING JBCD,R5                                                          
         ZAP   JXCUNEST,JBCCE         CURRENT NET   ESTIMATE                    
         ZAP   JXCUGEST,JBCCEG           "    GROSS   "                         
         ZAP   JXHINEST,JBCHR          HIGH   NET     "                         
         ZAP   JXHIGEST,JBCHRG           "    GROSS   "                         
         DROP  R3,R5                                                            
*                                                                               
ACF31    ZAP   PL13,JXCUNEST       CURRENT NET ESTIMATE                         
         MP    PL13,GOOVRPER        * OVER PCT.                                 
         SRP   PL13,64-4,5                                                      
         ZAP   JXCUNOVR,PL13       NET * OVER PERCENT                           
         ZAP   PL13,JXCUGEST       CURRENT GROSS ESTIMATE                       
         MP    PL13,GOOVRPER        * OVER PCT.                                 
         SRP   PL13,64-4,5                                                      
         ZAP   JXCUGOVR,PL13       GROSS * OVER ESTIMATE                        
*                                                                               
         ZAP   JXOVRMAX,JXCUNEST   CURRENT                                      
         AP    JXOVRMAX,GOOVRAMT   + OVER AMOUNT - MAX OVER                     
*                                                                               
         ZAP   PL13,JXCUNEST       CURRENT NET ESTIMATE                         
         MP    PL13,JXPEST         * % OF ESTIMATE TO BILL                      
         SRP   PL13,64-4,5                                                      
         ZAP   JXPCTAMT,PL13       AMOUNT OF %EST TO BILL                       
         CLI   JXBLCODE,JXBLPEST   % OF ESTIMATE BILL ?                         
         BNE   ACF33                                                            
         CP    JXCUNEST,PZERO                                                   
         BE    ACF33                                                            
         CP    JXPCTAMT,GOMINBIL                                                
         BNL   *+8                                                              
         OI    JXSTAT6,JXS6PLTM    %ESTIMATE < MINIMUM                          
*                                                                               
ACF33    ZAP   JXHINOVR,JXHINEST     HIGH NET ESTIMATE                          
         ZAP   PL13,JXHINOVR                                                    
         MP    PL13,GOOVRPER        * OVER PCT.                                 
         SRP   PL13,64-4,5                                                      
         CP    PL13,PZERO                                                       
         BE    *+10                                                             
         ZAP   JXHINOVR,PL13                                                    
*                                                                               
         ZAP   JXHIGOVR,JXHIGEST     HIGH GROSS ESTIMATE                        
         ZAP   PL13,JXHIGOVR                                                    
         MP    PL13,GOOVRPER        * OVER PCT.                                 
         SRP   PL13,64-4,5                                                      
         CP    PL13,PZERO                                                       
         BE    *+10                                                             
         ZAP   JXHIGOVR,PL13                                                    
*                                                                               
         OC    JXARETLB,JXARETLB   TEST RETAIL DISTRIBUTION BUFFER              
         BZ    ACF35                                                            
         TM    JXSTAT1,JXS1DIST    TEST DISTRIBUTION SCHEME                     
         BNO   ACF35                                                            
         GOTOR RTL,DMCB,('RTLINIQ',(RC))                                        
*                                                                               
ACF35    CLI   JXBLCODE,JXBLSPCL   SPECIAL AMOUNT                               
         BNE   *+8                                                              
         BAS   RE,SPCLB                                                         
*                                                                               
         CP    JXBALN,PZERO                                                     
         BNE    *+8                                                             
         OI    JXSTAT4,JXS4BZRO    BALANCE IS ZERO                              
*                                                                               
         CLC   JXLPSTDT,JXLESS6M                                                
         BNL   *+8                                                              
         OI    JXSTAT6,JXS6NACT    INACTIVE FOR SIX MONTHS                      
*                                                                               
         CLI   JXBLTYP,NOTB                                                     
         BNE   *+8                                                              
         OI    JXSTAT6,JXS6UNBT    UNBILLABLE TYPE                              
*                                                                               
         CP    JXCUNEST,PZERO                                                   
         BNE   *+12                                                             
         OI    JXSTAT7,JXS7EEQZ    CURRENT ESTIMATE = ZERO                      
         NI    JXSTAT3,ALL-(JXS3UNEW) CAN'T HAVE UNAPPROVED                     
*                                                                               
         CLC   JXCLSDT,JXTODAY1                                                 
         BNL   *+8                                                              
         OI    JXSTAT7,JXS7CLSD    CLOSE DATE < TODAY                           
*                                                                               
         CLI   JXLOREV,0                                                        
         BE    *+8                                                              
         OI    JXSTAT7,JXS7LRNZ    LOW REVISION NOT ZERO                        
*                                                                               
         CP    JXBIGBAL,PZERO      TEST BIG BALANCE NOT EQUAL ZERO              
         BE    *+18                                                             
         CP    JXBALN,JXBIGBAL                                                  
         BNH   *+8                                                              
         OI    JXSTAT7,JXS7BGTB    BALANCE > BIG BALANCE                        
*                                                                               
         CP    JXPEST,PZERO                                                     
         BNE   *+8                                                              
         OI    JXSTAT8,JXS8PCTZ    % EST = ZERO                                 
*                                                                               
         TM    JXRROPT,JXRRORRB    TEST RERUN                                   
         BO    ACF37               YES,                                         
*                                                                               
         CP    JXCRTS,PZERO                                                     
         BE    *+18                                                             
         CP    JXPCTAMT,JXCRTS                                                  
         BNE   *+8                                                              
         OI    JXSTAT8,JXS8ESFB    %ESTIMATE - CREDITS                          
*                                                                               
         CLI   JXMODE,JXMOVRN      TEST OVERNIGHT                               
         BNE   ACF37               NO,                                          
         CLC   JXLBILDT,JXTODAY2   TEST BILLED TODAY                            
         BNE   *+8                 NO,                                          
         OI    JXSTAT8,JXS8BLDD    SET BILLED TODAY                             
*                                                                               
ACF37    CP    JXRTLUNT,PZERO                                                   
         BNE   *+8                                                              
         OI    JXSTAT2,JXS2NRTL    NO RETAIL UNITS                              
*                                                                               
         TM    JXRTLSTA,JXRTLSUN   TEST RETAIL UNITS                            
         BO    ACF39                                                            
         CP    JXRTLUNT,PONEHDRD                                                
         BE    *+8                                                              
         OI    JXSTAT2,JXS2RNEQ    RETAIL UNITS NOT EQUAL 100.0000              
*                                                                               
ACF39    ZAP   JXPBPCT,PZERO       PERCENT OF BILL %                            
         XC    JXPBACC,JXPBACC     POB ACCOUNT                                  
         XC    JXPBWRK,JXPBWRK     POB WORKCODE                                 
         TM    JXBLTYP,TOTL+ONEL+PROG                                           
         BZ    ACF41                                                            
*                                                                               
         OC    GOPBPCT,GOPBPCT     TEST POB                                     
         BZ    ACF41                                                            
         ZAP   JXPBPCT,GOPBPCT     SAVE PERCENT                                 
         CP    JXPBPCT,PZERO                                                    
         BE    ACF41                                                            
         OI    JXPBSTA,JXPBSPCT    SET STATUS                                   
         OC    JXPBACC,GOPBACC     SAVE ACCOUNT                                 
         BNZ   *+8                                                              
         OI    JXPBSTA,JXPBSMAC    MISSING ACCOUNT                              
         OC    JXPBWRK,GOPBWRK     SAVE WORKCODE                                
         BNZ   *+8                                                              
         OI    JXPBSTA,JXPBSMWC    MISSING WORKCODE                             
*                                                                               
ACF41    ZAP   JXASPPCT,PZERO      ASP                                          
         OC    GOASPCT,GOASPCT                                                  
         BZ    ACF43                                                            
         ZAP   JXASPPCT,GOASPCT                                                 
         CP    JXASPPCT,PZERO                                                   
         BE    ACF43                                                            
         OI    JXASPIND,JXASPRTE   SET JOB HAS ASP RATE                         
         MVC   JXASPACC,GOASACC    ACCOUNT                                      
         CLI   JXASPACC,X'00'                                                   
         BH    *+8                                                              
         OI    JXASPIND,JXASPNAC   SET MISSING ACCOUNT                          
         MVC   JXASPWRK,GOASWRK    WORKCODE                                     
         CLI   JXASPWRK,X'00'                                                   
         BH    *+8                                                              
         OI    JXASPIND,JXASPNWC   SET MISSING WORKCODE                         
         TM    JXASPIND,JXASPNAC+JXASPNWC                                       
         BNZ   ACF43               MISSING DATA                                 
         CLI   GOASBIL,YES                                                      
         BNE   ACF43                                                            
         OI    JXASPIND,JXASPBIL   SET BILL ASP ON THIS INVOICE                 
*                                                                               
ACF43    CLC   JXWCFLT,SPACES                                                   
         BE    *+8                                                              
         OI    JXSTAT8,JXS8TWCF                                                 
*                                                                               
ACF45    MVI   MODE,ACCFRST                                                     
         BRAS  RE,XRUL             APPLY EXCEPTION RULES                        
         BAS   RE,SETMSG                                                        
*                                                                               
         TM    JXOPTS,JXOPTRN      OPTION TO LOOK AHEAD                         
         BZ    ACF47                                                            
         OC    JXERRS,JXERRS       ANY ERRORS SO FAR                            
         JNZ   ACF47               YES, EXIT ON ERROR                           
         BAS   RE,RDTRN            READ TRANSACTIONS                            
         BAS   RE,ACL1             NOW ACCLAST                                  
*                                                                               
ACF47    OC    JXERRS,JXERRS                                                    
         JZ    XITY                                                             
         J     XITN                                                             
         DROP  R7                                                               
         EJECT                                                                  
***********************************************************************         
* READ AND PROCESS TRANSACTIONS                                       *         
***********************************************************************         
RDTRN    NTR1  ,                                                                
         MVC   DATADISP,=Y(ACCRFST-ACCRECD)                                     
         MVC   DKEY,SPACES                                                      
         LA    R2,DKEY                                                          
         USING ACTRECD,R2                                                       
         L     RF,JXAJOB                                                        
         MVC   ACTKCULA,0(RF)      READ ACCOUNT DIRECTORY                       
         BRAS  RE,READ                                                          
*                                                                               
RDTRN3   BRAS  RE,RSEQ                                                          
         LA    R3,DIR                                                           
         USING TRNRECD,R3                                                       
         CLC   ACTKCULA,TRNKCULA   SAME JOB ?                                   
         BNE   RDTRN9                                                           
         CLC   TRNKREF,SPACES      SKIP BUCKETS                                 
         BNH   RDTRN3                                                           
         TM    JXOPTS,JXOPDRFT     INCLUDE DRAFTS ?                             
         BO    *+12                                                             
         TM    TRNKSTAT,TRNSDRFT                                                
         BO    RDTRN3              SKIP DRAFTS                                  
         TM    TRNKSTAT,TRNSREVS                                                
         BO    RDTRN3              AND REVERSALS                                
         LA    RF,TRNKWORK                                                      
         BAS   RE,WCFLT            WORK CODE FILTER                             
         BNE   RDTRN3                                                           
*                                                                               
         MVC   AIO,AIO2                                                         
         BRAS  RE,GETR                                                          
         ICM   R4,15,JXACQ         TEST REQUEST PASSED                          
         USING ACQD,R4                                                          
         CLC   ACQACTST(L'ACQACTST+L'ACQACTND),SPACES                           
         BE    RDTRN7                                                           
         XC    WORK(2),WORK                                                     
         MVI   WORK+2,X'FF'                                                     
         CLC   ACQACTST,SPACES                                                  
         BE    RDTRN5                                                           
         GOTO1 DATCON,DMCB,(0,ACQACTST),(2,WORK)                                
*                                                                               
RDTRN5   CLC   ACQACTND,SPACES                                                  
         BE    RDTRN6                                                           
         GOTO1 DATCON,DMCB,(0,ACQACTND),(2,WORK+2)                              
*                                                                               
RDTRN6   L     R3,AIO2                                                          
         MVI   ELCODE,TRSELQ       TRANSACTION STATUS ELEMENT                   
         BRAS  RE,GETELN                                                        
         BNE   RDTRN7                                                           
         USING TRSELD,R3                                                        
         CLC   TRSDATE,WORK                                                     
         BL    RDTRN3              BEFORE ACTIVITY START                        
         CLC   TRSDATE,WORK+2                                                   
         BH    RDTRN3              AFTER ACTIVITY END                           
         NI    JXSTATA,ALL-(JXSANACT)  TURNOFF 'NO-ACTIVITY'                    
*                                                                               
RDTRN7   L     R3,AIO2                                                          
         MVC   SVDIR,DIR           SAVE THIS KEY TRANSACTION KEY                
         BAS   RE,PTN1                                                          
         MVC   DKEY,SVDIR                                                       
         BRAS  RE,READ                                                          
         B     RDTRN3                                                           
*                                                                               
RDTRN9   TM    JXOPTS,JXOPMST                                                   
         BO    *+10                                                             
         MVC   DATADISP,=Y(ACCORFST)                                            
         J     XIT                                                              
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* PROCESS A TRANSACTION                                               *         
***********************************************************************         
PTN      L     R3,JXATRN           TRANSACTION FROM CALLER                      
         USING TRNRECD,R3                                                       
         BAS   RE,PTN1                                                          
         J     XIT                                                              
*                                                                               
PTN1     NTR1  ,                                                                
         ST    R3,ADTRNR                                                        
         MVI   JXTSTAT1,0                                                       
         MVI   JXTSTAT2,0                                                       
         CLI   JXRROPT,0           RERUN OR UNBILL OPTION                       
         BE    PTN3                                                             
         GOTOR RERN,DMCB,(RC)                                                   
         BE    PTN3                                                             
         OI    JXTSTAT2,JXTS2NRR   SET 'NOT IN RERUN'                           
         J     XITN                                                             
*                                                                               
PTN3     LA    RF,TRNKWORK                                                      
         BAS   RE,WCFLT            WORK CODE FILTER                             
         JNE   XIT                                                              
         LA    R0,JXTBN            INITIALISE ALL TRANSACTION FIELDS            
         LA    R1,JXTB                                                          
         ZAP   0(L'JXBK,R1),PZERO                                               
         LA    R1,L'JXBK(R1)                                                    
         BCT   R0,*-10                                                          
*                                                                               
         LA    R0,LBKN             INITIALISE LOCAL ACCUMULATORS                
         LA    R1,LBK                                                           
         ZAP   0(L'LBK,R1),PZERO                                                
         LA    R1,L'LBK(R1)                                                     
         BCT   R0,*-10                                                          
*                                                                               
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         LA    R0,JXRTNT           CLEAR JOBLOT RETURN DATA                     
         LA    R1,JXRTNTLQ                                                      
         MVCL  R0,RE                                                            
*                                                                               
         ZAP   COMR,GOAGYCOM       GET CURRENT COMMISSION RATE                  
*                                                                               
         CLC   TRNKWORK,JXORDRQ    IS IT AN ORDER ?                             
         BNE   PTN7                                                             
         MVI   ELCODE,OAMELQ                                                    
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
*                                                                               
         USING OAMELD,R3                                                        
PTN5     BRAS  RE,NEXTEL                                                        
         JNE   XIT                                                              
         CLC   OAMWORK,SPACES                                                   
         BNH   PTN5                BYPASS IF NO WORKCODE (EXPENSE ITEM)         
         ZAP   NET,OAMAMNT         ORIGINAL ORDER AMOUNT                        
         AP    JXAONET,NET                                                      
         ZAP   CSD,PZERO                                                        
         MVC   WCODE,OAMWORK                                                    
         BAS   RE,GETWC            GET WORKCODE ENTRY                           
         TM    JXBLTYP,ALLO        TEST CLIENT BILL                             
         BZ    *+12                NO,                                          
         BAS   RE,TRNFLT           TRANSACTION FILTER                           
         JNE   XITN                SKIP IT                                      
*                                                                               
         BAS   RE,GETGRS           GET GROSS AMOUNT                             
         AP    JXAOGRS,GRS                                                      
         B     PTN5                                                             
*                                                                               
         USING TRNELD,R2                                                        
PTN7     MVI   ELCODE,TRNELQ       GET TRANSACTION ELEMENT                      
         BRAS  RE,GETEL                                                         
         JNE   XIT                                                              
         LR    R2,R3                                                            
         STCM  R2,15,JXATRNEL      SAVE A(TRNEL)                                
         MVC   JXTSTAT1,TRNSTAT    SAVE STATUS                                  
         MVC   WCODE,TRNANAL                                                    
*                                                                               
         CLC   WCODE,JXBILLQ                                                    
         BE    PRVB                PREVIOUS BILLING                             
*                                                                               
         TM    JXBLTYP,ESTM+SPCL   ESTIMATE OR SPECIAL BILL ?                   
         JNZ   XIT                 SKIP REGULAR TRANSACTIONS                    
*                                                                               
         BAS   RE,GETWC            GET WORKCODE ENTRY                           
         TM    JXBLTYP,ALLO        TEST CLIENT BILL                             
         BZ    *+12                NO,                                          
         BAS   RE,TRNFLT           TRANSACTION FILTER                           
         JNE   XITN                                                             
*                                                                               
         LA    R7,JXTTOT                                                        
         USING JXBKD,R7                                                         
*                                                                               
         TM    JXTNS,JXTNSUNH      TREAT AS UNHELD                              
         BO    PTN9                                                             
         TM    JXTSTAT1,TRNSHOLD   IS IT HELD ?                                 
         BNO   PTN9                                                             
         OI    JXSTAT1,JXS1HELD    SET JOB HAS HELD INVOICES                    
         J     XIT                                                              
*                                                                               
PTN9     AP    JXDEBITS,TRNAMNT                                                 
         AP    JXBNET,TRNAMNT      TOTAL NET                                    
         LA    R4,WCEL             R2=A(WORKCODE ELEMENT)                       
         USING WCOELD,R4                                                        
         TM    WCOSTAT,WCOSMEDT    MEDIA TRANSFER                               
         BNO   *+10                                                             
         AP    JXBMED,TRNAMNT      TOTAL MEDIA                                  
         TM    WCOSTAT2,WCOSINC    TEST INCOME WORKCODE                         
         BNO   *+8                 NO,                                          
         OI    JXSTATA,JXSAINWC    YES, SET STATUS BIT                          
         DROP  R4                                                               
*                                                                               
         L     R3,ADTRNR                                                        
         USING TRNRECD,R3                                                       
         TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BZ    PTN11               NO,                                          
         TM    JXBLTYP,ALLO        TEST ALLOCATED BILLING                       
         BZ    PTN11               NO,                                          
         CLI   TRNTYPE,TRNTIINV    TEST TYPE 8                                  
         BNE   PTN11               NO,                                          
         CLC   TRNREF,JXRRNUM      TEST REFERENCE IS SAME                       
         BNE   PTN11               NO,                                          
         OI    JXTSTAT3,JXTS3ASR   SET ASP REVERSAL                             
*                                                                               
         USING PRTELD,R3                                                        
PTN11    LR    R3,R2                                                            
         MVI   ELCODE,PRTELQ       GET PERSONNEL RATE                           
         BRAS  RE,NEXTEL                                                        
         BNE   PTN12                                                            
         STCM  R3,15,JXAPRTEL                                                   
         AP    JXBHRS,PRTHOUR      HOURS                                        
*                                                                               
         USING TRNRECD,R3                                                       
PTN12    L     R3,ADTRNR                                                        
         CLC   TRNKCUNT(2),=C'SK'  SK CONTRA                                    
         BNE   PTN13                                                            
         LA    R1,TRNKCUNT                                                      
         BAS   RE,SKADD                                                         
         B     PTN15                                                            
*                                                                               
         USING SPDELD,R3                                                        
PTN13    LR    R3,R2                                                            
         MVI   ELCODE,SPDELQ                                                    
         BRAS  RE,NEXTEL                                                        
         BNE   PTN17                                                            
         CLC   SPDACCS(2),=C'SK'   SK IN ELEMENT (CONTRA 1R)                    
         BNE   PTN17                                                            
         ICM   R1,15,JXAPRTEL                                                   
         BZ    *+12                                                             
         USING PRTELD,R1                                                        
         TM    PRTSTAT,PRTSNOTQ+PRTSRTEQ    IS IT 'N' OR 'R' TIME ?             
         BNZ   PTN17                                                            
         LA    R1,SPDEL                                                         
         BAS   RE,SKADD                                                         
*                                                                               
PTN15    ZAP   SKINC,TRNAMNT       SAVE AMOUNT FOR THIS TRANSACTION             
*                                                                               
         USING TRXELD,R3                                                        
PTN17    LR    R3,R2                                                            
         MVI   ELCODE,TRXELQ       GET EXTRA STATUS ELEMENT                     
         BRAS  RE,NEXTEL                                                        
         BNE   PTN19                                                            
         STCM  R3,15,JXATRXEL                                                   
         TM    TRXSTA2,TRXSXFRP+TRXSWOFP+TRXSBILP                               
         BZ    PTN19               TRANX, WO OR BILL ACT. PENDING               
         OI    JXTSTAT2,JXTS2PND                                                
         J     XIT                                                              
*                                                                               
         USING TRSELD,R3                                                        
PTN19    LR    R3,R2                                                            
         MVI   ELCODE,TRSELQ       TRANSACTION STATUS ELEMENT                   
         BRAS  RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         STCM  R3,15,JXATRSEL                                                   
         MVC   MOS,TRSPMOS         SAVE MOS                                     
*                                                                               
         TM    TRSSTAT3,TRSSNBIL   IS IT BILLABLE ?                             
         BNO   *+8                                                              
         OI    JXTSTAT2,JXTS2NTB                                                
*                                                                               
         OC    TRSUDAT,TRSUDAT     FULLY BILLED ?                               
         BZ    PTN23                                                            
         OI    JXTSTAT2,JXTS2FBL                                                
*                                                                               
         LR    R3,R2                                                            
         USING PTAELD,R3                                                        
         MVI   ELCODE,PTAELQ       GET LAST BILLED PTAEL                        
PTN21    BRAS  RE,NEXTEL                                                        
         BNE   PTN23                                                            
         CLI   PTATYPE,PTATRAL     TEST BILLING                                 
         BNE   PTN21               NO,                                          
         TM    PTASTAT1,PTASREVU   TEST REVERSED                                
         BO    PTN21               YES, SKIP                                    
         ST    R3,JXAPTAEL         SAVE A(THIS PTAEL)                           
*                                                                               
PTN23    CP    SKINC,PZERO         TEST INTERNAL INCOME                         
         BE    PTN29               NO,                                          
         CLI   JXRROPT,0           RERUN OR UNBILL OPTION                       
         BE    PTN25               NO,                                          
         USING TRSELD,R3                                                        
         ICM   R3,15,JXATRSEL                                                   
         CLC   JXRRADT,TRSUDAT     TEST THIS IS BILLED DATE                     
         BNE   PTN29               NO, SKIP INTERNAL INCOME                     
         B     PTN27               YES, RECORD INTERNAL INCOME                  
*                                                                               
PTN25    TM    JXTSTAT2,JXTS2FBL   TEST FULLY BILLED                            
         BO    PTN29               YES,                                         
PTN27    ZAP   JXBSKI,SKINC        NO, RECORD INTERNAL INCOME                   
*                                                                               
         USING SCIELD,R3                                                        
PTN29    LR    R3,R2                                                            
         MVI   ELCODE,SCIELQ       GET CASH DISCOUNT                            
         BRAS  RE,NEXTEL                                                        
         BNE   PTN31                                                            
         CLI   SCITYPE,SCITCDSC                                                 
         BNE   *-12                                                             
         AP    JXBCSD,SCIAMNT      TOTAL CASH DISCOUNT                          
*                                                                               
         USING PTAELD,R3                                                        
PTN31    XC    APTARRL,APTARRL     CLEAR ADDRESS OF RERUN PTAEL                 
         CLC   JXRRBILL,SPACES     IS THERE A RERUN/UNBILL NUMBER ?             
         BNH   PTN35                                                            
         LR    R3,R2                                                            
         MVI   ELCODE,PTAELQ       PROD. TRANSACTION ACTIVITY                   
PTN33    BRAS  RE,NEXTEL                                                        
         BNE   PTN35                                                            
         CLI   PTATYPE,0                                                        
         BE    PTN33                                                            
         CLC   JXRRBILL,PTARBLNO   THIS IS ELEMENT FOR RERUN/UNBILL ?           
         BNE   PTN33                                                            
         ST    R3,APTARRL          SAVE A(PTAEL FOR RERUN)                      
         NI    JXTSTAT2,ALL-(JXTS2FBL) TURNOFF 'FULLY-BILLED'                   
*                                                                               
         USING UNPELD,R3                                                        
PTN35    LR    R3,R2                                                            
         MVI   ELCODE,UNPELQ       GET UNIT PRICING                             
         BRAS  RE,NEXTEL                                                        
         BNE   PTN39                                                            
         TM    UNPSTAT,UNPSQTRH    TEST HOURS                                   
         BNO   *+10                                                             
         AP    JXBHRS,UNPUNIT      ADD TO HOURS                                 
*                                                                               
PTN39    TM    JXPGM,JXA21Q        TEST 21                                      
         BNO   PTN41                                                            
         TM    JXBLTYP,PROG        TEST PROGRESSIVE                             
         BNO   PTN41               NO,                                          
         CLI   JXRROPT,0           RERUN OR UNBILL OPTION                       
         BNE   PTN41               YES,                                         
         TM    JXTSTAT2,JXTS2FBL   IS TRANSACTION FULLY BILLED ?                
         JO    XIT                 YES, ALREADY HAVE IT                         
*                                                                               
PTN41    ZAP   NET,JXBNET          NET                                          
         ZAP   CSD,JXBCSD          CD                                           
*                                                                               
         OI    JXSTAT9,JXS9RCOM   COMM. APPLIES TO RETAIL                       
         BAS   RE,GETGRS           GET COMMISSION & GROSS                       
         NI    JXSTAT9,ALL-JXS9RCOM                                             
         ZAP   JXBGRS,GRS                                                       
         ZAP   JXBCOM,COM                                                       
         DROP  R7                                                               
*                                                                               
         BAS   RE,TXWO             GET TRANSFERS AND WRITEOFFS                  
         CLI   JXBLCODE,JXBLCLNT   TEST CLIENT BILL                             
         BNE   PTN43                                                            
         BAS   RE,CBLA             GET CLIENT BILL ALLOCATION                   
         TM    JXTSTAT2,JXTS2ALC   IS TRANSACTION ALLOCATED ?                   
         JNO   XIT                 NO, DON'T ADD TO TOTALS                      
*                                                                               
PTN43    TM    JXTSTAT2,JXTS2FBL   IS TRANSACTION FULLY BILLED ?                
         BO    PTN47                                                            
*                                                                               
PTN45    OI    JXTSTAT2,JXTS2NEW   SET THIS IS NEW TRANSACTION                  
         OI    JXSTAT4,JXS4NEW     SET NEW ITEM FOR ACCOUNT                     
*                                                                               
PTN47    LA    R0,JXTBN            ADD TRANSACTION TO ACCOUNT BUCKETS           
         LA    RE,JXTTOT                                                        
         LA    RF,JXATOT                                                        
         AP    0(L'JXBK,RF),0(L'JXBK,RE)                                        
         LA    RE,L'JXBK(RE)                                                    
         LA    RF,L'JXBK(RF)                                                    
         BCT   R0,*-14                                                          
         J     XIT                                                              
         DROP  R2,R3                                                            
         EJECT                                                                  
**********************************************************************          
* PREVIOUS BILLS                                                     *          
**********************************************************************          
PRVB     DS    0H                                                               
         L     R3,ADTRNR                                                        
         USING TRNRECD,R3                                                       
         L     R2,JXATRNEL                                                      
         USING TRNELD,R2                                                        
         BAS   RE,TSTSK                                                         
         TM    JXRROPT,JXRROUNB    TEST UNBILL                                  
         BO    PRVB2               YES, SKIP TEST                               
         SR    R0,R0                                                            
*                                                                               
PRVB1    IC    R0,1(R2)            LOOK FOR B7'S                                
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    PRVB2                                                            
         CLI   0(R2),INCELQ        TEST B7 ELEMENTS                             
         BNE   PRVB1                                                            
         OI    JXSTATA,JXSAINWC                                                 
         TM    JXBLTYP,PROG        TEST PROGRESSIVE                             
         BNO   *+8                                                              
         OI    JXSTATA,JXSAB7EL                                                 
         B     PRVB1                                                            
*                                                                               
PRVB2    L     R2,JXATRNEL                                                      
         MVI   BYTE,0                                                           
         OI    JXSTAT4,JXS4BILL    SET - JOB HAS BILLING                        
         CLI   TRNKCUNT,C'3'       ANY RETAIL BILLING ?                         
         BNE   *+8                                                              
         OI    JXSTAT1,JXS1RET                                                  
         MVI   BYTE,JXS1NCLB       SET NON-CLIENT BILLS                         
         CLC   TRNNARR(9),=C'CLIENT WP'   ANY $BILL ?                           
         BNE   *+8                                                              
         MVI   BYTE,JXS1CLB        SET CLIENT (ALLOCATED BILLING)               
         CLI   TRNNARR,C'A'        ANY ALLOCATED BILLING ?                      
         BNE   *+8                                                              
         MVI   BYTE,JXS1CLB                                                     
         OC    JXSTAT1,BYTE                                                     
*                                                                               
         TM    JXSTAT1,JXS1RET     TEST RETAIL BILLS                            
         BNO   PRVB3                                                            
         TM    JXSTAT1,JXS1DIST    TEST DISTRIBUTION SCHEME                     
         BO    PRVB3               YES,                                         
         OI    JXSTATA,JXSARTLC    SET RETAIL CONFLICT                          
*                                                                               
PRVB3    LA    R7,JXTTOT           GET BILLED AMOUNTS                           
         USING JXBKD,R7                                                         
         ZAP   JXBNET,TRNAMNT      TOTAL NET                                    
         ZAP   JXBCSD,TRNBLCD                                                   
         CLI   TRNLN,TRNLN2Q                                                    
         BL    *+10                                                             
         ZAP   JXBCOM,TRNBLCOM     COMMISSION                                   
*                                                                               
         ZAP   JXBGRS,JXBNET       NET + COMMISSION = GROSS                     
         AP    JXBGRS,JXBCOM                                                    
*                                                                               
         OC    TRNBINTI,TRNBINTI   ANY INTERNAL INCOME ?                        
         BZ    *+10                                                             
         AP    JXBSKI,TRNBINTI     SAVE IT                                      
         SR    R0,R0                                                            
*                                                                               
         TM    JXRROPT,JXRROUNB    TEST UNBILL                                  
         BZ    PRVB4               NO,                                          
         TM    JXBLTYP,PROG        TEST PROGRESSIVE                             
         BNZ   PRVBX               YES,  SKIP IT                                
*                                                                               
PRVB4    TM    JXBLTYP,PROG        TEST PROGRESSIVE                             
         BO    PRVB9               YES, SKIP PREVIOUS GST/PST                   
         USING VBIELD,R2                                                        
PRVB5    IC    R0,VBILN            GET NEXT TAX ELEMENT                         
         AR    R2,R0                                                            
         CLI   VBIEL,0                                                          
         BE    PRVB9                                                            
         CLI   VBIEL,VBIELQ        TEST GST POSTING ELEMENT                     
         BNE   PRVB7                                                            
         TM    JXOPTS2,JXOPGST     TEST NEED GST                                
         BNO   *+10                                                             
         AP    JXBGST,VBIVAT       GST                                          
         B     PRVB5                                                            
*                                                                               
         USING PBIELD,R2                                                        
PRVB7    CLI   PBIEL,PBIELQ        TEST PST POSTING ELEMENT                     
         BNE   PRVB5                                                            
         TM    JXOPTS2,JXOPPST     TEST NEED PST                                
         BNO   *+10                                                             
         AP    JXBPST,PBIPST       PST                                          
         B     PRVB5                                                            
*                                                                               
PRVB9    LA    R3,JXTTOT                                                        
         LA    R4,JXABILL                                                       
         BRAS  RE,ADDSET           ADD THIS TRANSATION TO TOTAL BILLED          
*                                                                               
PRVB11   OC    JXARETLB,JXARETLB   TEST RETAIL DISTRIBUTION                     
         BZ    PRVBX                                                            
         TM    JXSTAT1,JXS1DIST    TEST DISTRIBUTION SCHEME                     
         BNO   PRVBX                                                            
*                                                                               
         GOTOR RTL,DMCB,('RTLPRBQ',(RC))                                        
PRVBX    J     XIT                                                              
*                                                                               
         DROP  R2,R3,R7                                                         
         EJECT                                                                  
***********************************************************************         
* TEST ANY SK INCOME - NOT REVERSED                                   *         
***********************************************************************         
         USING TRNELD,R2                                                        
TSTSK    TM    JXBLTYP,TOTL+ESTM+ONEL                                           
         BNZR  RE                  DOES NOT APPLY TO TOTAL OR %EST              
         CP    TRNAM2SK,PZERO      TEST ANY SK INCOME                           
         BER   RE                  NONE,                                        
         OC    TRNSK2SI,TRNSK2SI   TEST DATE REVERSED                           
         BNZR  RE                  YES,                                         
         OI    JXSTATA,JXSASKIN    SET INCOME STILL IN SK                       
         BR    RE                                                               
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* ADD SK ACCOUNT TO LIST                                              *         
***********************************************************************         
SKADD    NTR1  ,                                                                
         MVC   WORK,SPACES                                                      
         MVC   WORK(1),CPY                                                      
         CLC   0(2,R1),=C'SK'      TEST SK IN CONTRA                            
         BNE   SKADD3              NO,                                          
         MVC   WORK+1(14),0(R1)    YES, SAVE CONTRA                             
         B     SKADD5                                                           
*                                                                               
SKADD3   CLI   0(R1),SPDELQ        TEST IN ELEMENT                              
         BE    *+6                                                              
         DC    H'0'                                                             
         USING SPDELD,R1                                                        
         LLC   RE,SPDLN                                                         
         SHI   RE,3                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   WORK+1(0),SPDACCS                                                
         DROP  R1                                                               
*                                                                               
SKADD5   LA    RF,JXPASK1                                                       
         CLI   0(RF),0             FIND A SLOT                                  
         BE    SKADD7                                                           
         CLC   0(15,RF),WORK       TEST ALREADY HAVE ACCOUNT                    
         JE    XIT                                                              
         LA    RF,JXPASK2                                                       
         CLI   0(RF),0                                                          
         JNE   XIT                                                              
*                                                                               
SKADD7   MVC   0(15,RF),WORK       MOVE ACCOUNT TO SLOT                         
         J     XIT                                                              
         EJECT                                                                  
***********************************************************************         
* LAST FOR ACCOUNT                                                    *         
***********************************************************************         
ACL      BAS   RE,ACL1                                                          
         J     XIT                                                              
*                                                                               
ACL1     NTR1  ,                                                                
         TM    JXBLTYP,ALLO        TEST CLIENT BILL TYPE                        
         BO    ACL7                YES, DON'T ADJUST ALLOCATED                  
         TM    JXBLTYP,ESTM+SPCL   TEST ESTIMATE OR SPECIAL BILL                
         JNZ   ACL7                                                             
         MVC   JXAALLO,JXATOT       TOTAL                                       
         TM    JXBLTYP,PROG         TEST PROGRESSIVE                            
         BNO   ACL3                 NO,                                         
         TM    JXSTAT4,JXS4NEW      TEST ANY NEW ITEMS                          
         BO    ACL5                 YES,                                        
         OI    JXSTAT4,JXS4FULB     SET FULLY BILLED                            
         B     ACL5                                                             
*                                                                               
ACL3     LA    R4,JXAALLO                                                       
         LA    R3,JXABILL            LESS: BILLED                               
         BRAS  RE,SUBSET                                                        
*                                                                               
ACL5     LA    R4,JXAALLO                                                       
         LA    R3,JXATRNX                  TRANSFERRED                          
         BRAS  RE,SUBSET                                                        
*                                                                               
         LA    R4,JXAALLO                                                       
         LA    R3,JXAWOFF         WRITTEN OFF                                   
         BRAS  RE,SUBSET                                                        
*                                                                               
         LA    R7,JXAALLO          TEST FOR ZERO                                
         USING JXBKD,R7                                                         
         CP    JXBNET,PZERO                                                     
         BNE   ACL7                                                             
         CP    JXBCOM,PZERO                                                     
         BNE   ACL7                                                             
         CP    JXBGRS,PZERO                                                     
         BNE   ACL7                                                             
         CP    JXBGST,PZERO                                                     
         BNE   ACL7                                                             
         CP    JXBPST,PZERO                                                     
         BNE   ACL7                                                             
*                                                                               
         CP    JXBNET,JXCRTS                                                    
         BNE   *+8                                                              
         OI    JXSTAT4,JXS4FULB    SET FULLY BILLED                             
*                                                                               
         LA    R7,JXATOT                                                        
         CP    JXDEBITS,JXCRTS       TOTAL DEBITS = CREDITS                     
         BNE   *+8                                                              
         OI    JXSTAT7,JXS7EABZ    EST. + ACTUAL + BILLING = ZERO               
*                                                                               
ACL7     ZAP   ESACBL,JXCUNEST     ESTIMATE                                     
         AP    ESACBL,JXDBTS        + DEBITS                                    
         AP    ESACBL,JXCRTS        + CREDITS                                   
*                                                                               
         OC    JXARETLB,JXARETLB   TEST RETAIL DISTRIBUTION                     
         BZ    ACL9                                                             
         TM    JXSTAT1,JXS1DIST    TEST DISTRIBUTION SCHEME                     
         BNO   ACL9                                                             
         GOTOR RTL,DMCB,('RTLALLQ',(RC))                                        
*                                                                               
ACL9     LA    R7,JXAALLO                                                       
         ZAP   DUB,JXBNET                                                       
         OI    DUB+7,X'0F'                                                      
         CP    DUB,GOMINBIL                                                     
         BNL   *+8                                                              
         OI    JXSTAT6,JXS6ULTM    UNBILLED < MINIMUM                           
*                                                                               
         CP    JXBNET,P1DLR                                                     
         BNH   *+8                                                              
         OI    JXSTAT6,JXS6UGT1    UNBILLED > $1.00                             
*                                                                               
         LA    R7,JXATOT                                                        
         CP    JXDEBITS,JXCUNOVR                                                
         BNH   *+8                                                              
         OI    JXSTAT6,JXS6NGTE    NET > ESTIMATE                               
*                                                                               
         CP    JXCUNEST,PZERO                                                   
         BE    *+8                                                              
         OI    JXSTAT6,JXS6NZRO    CURRENT ESTIMATE IS NOT ZERO                 
*                                                                               
         CP    JXBNET,JXPCTAMT                                                  
         BNH   *+8                                                              
         OI    JXSTAT6,JXS6GTPE     OVER % OF ESTIMATE AMOUNT                   
*                                                                               
         CP    JXBNET,PZERO                                                     
         BE    *+8                                                              
         OI    JXSTAT7,JXS7NGTZ     NET > ZERO                                  
*                                                                               
         CP    JXAONET,JXCUNOVR                                                 
         BNH   *+8                                                              
         OI    JXSTAT7,JXS7OGTE    ORDERED + NET > MAX EST                      
*                                                                               
         CP    GOOVRAMT,PZERO      OVER AMOUNT NOT ZERO                         
         BE    *+18                                                             
         CP    JXBNET,JXOVRMAX                                                  
         BNH   *+8                                                              
         OI    JXSTAT8,JXS8OVMX     ACTUAL > MAX                                
*                                                                               
         CP    JXCUGOVR,PZERO       GROSS ESTIMATE  ZERO                        
         BE    *+18                                                             
         CP    JXBGRS,JXCUGOVR                                                  
         BNH   *+8                  GROSS > ESTIMATE GROSS                      
         OI    JXSTAT8,JXS8GRPO     ACTUAL > MAX                                
*                                                                               
         CP    JXBNET,JXHINOVR                                                  
         BH    *+8                                                              
         OI    JXSTAT8,JXS8NLTH     ACT. NET < = HIGH NET EST * OVR             
         DROP  R7                                                               
*                                                                               
         L     R7,GOAEXT                                                        
         USING GOXBLKD,R7                                                       
         TM    JXSTATA,JXSAINWC     TEST ACCOUNT HAS INCOME WC'S                
         BNO   ACL11                                                            
         CLI   GOINCDR,C' '        TEST DEBIT INCOME ACCOUNT                    
         BH    *+8                                                              
         OI    JXSTATA,JXSANINC    SET 'NO INCOME ACCOUNT'                      
         CLI   GOINCCR,C' '        TEST CREDIT INCOME ACCOUNT                   
         BH    *+8                                                              
         OI    JXSTATA,JXSANINC    SET 'NO INCOME ACCOUNT'                      
*                                                                               
ACL11    CLI   JXMODE,JXMREQS      TEST CALLED FROM =REQ                        
         BNE   ACL15               NO,                                          
         GOTOR ACCK,DMCB,(RC)      CHECK POSTING ACCOUNTS                       
         JNE   XIT                 EXIT ON ERROR                                
*                                                                               
ACL15    MVI   MODE,ACCLAST                                                     
         BRAS  RE,XRUL             APPLY EXCEPTION RULES                        
         BAS   RE,SETMSG                                                        
         J     XIT                                                              
*                                                                               
         DROP  R7                                                               
         EJECT                                                                  
***********************************************************************         
* CHECK BILL IS ELIGIBLE FOR UNBILLING -                              *         
*  CAN'T UNBILL IF THERE ARE BILLS 'NOT REVERSED' AFTER THE BILL      *         
*  THEY WANT TO REVERSE.   MUST REVERSE IN INVERSE SEQUENCE.          *         
***********************************************************************         
CHKUNB   NTR1  ,                                                                
         USING ACQD,R4                                                          
         GOTO1 DATCON,DMCB,(0,ACQEND),(1,ORGBDTE)                               
         LA    R2,DKEY                                                          
         USING TRNRECD,R2                                                       
         MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCULA,JXJOBK     C/U/L/JOB                                    
         MVC   TRNKWORK,JXBILLQ                                                 
         MVC   AIO,AIO3                                                         
         BRAS  RE,HIGH                                                          
         B     CHKUNB5                                                          
*                                                                               
CHKUNB3  BRAS  RE,RSEQ                                                          
CHKUNB5  LA    R2,DIR                                                           
         CLC   TRNKEY(TRNKCULC-TRNRECD),DKEY  TEST BILLING TRANSACTION          
         BNE   CHKUNB15            NO, END OF JOB                               
*                                                                               
         BRAS  RE,GETR             GET THE RECORD                               
         L     R2,AIO                                                           
         CLI   TRNRFST,TRNELQ      TRANSACTION ELEMENT                          
         BNE   CHKUNB3                                                          
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,PTAELQ       GET PTAEL                                    
         BRAS  RE,GETELN                                                        
         BNE   CHKUNB3                                                          
*                                                                               
         USING PTAELD,R3                                                        
         TM    PTASTAT2,PTASRETB   TEST SECONDARY RETAILER POSTING              
         BO    CHKUNB3             CAN'T UNBILL                                 
*                                                                               
         CLC   TRNKDATE,ORGBDTE    MATCH DATE                                   
         BNE   CHKUNB11                                                         
         CLC   TRNKREF,ACQSEL      AND INVOICE                                  
         BNE   CHKUNB11                                                         
         TM    PTASTAT1,PTASREVS   TEST UNBILLING                               
         BO    CHKUNBX3            ERROR - BILL IS A REVERSAL                   
*                                                                               
         LA    R2,TRNRFST                                                       
         USING TRNELD,R2                                                        
         OC    TRNUNBIL,TRNUNBIL   TEST UNBILLED DATE                           
         BNZ   CHKUNBX4            ERROR - BILL IS ALREADY REVERSED             
         MVC   ORGBTYP,TRNBTYPE    SAVE THE BILLTYPE                            
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,TRSELQ       TRANSACTION STATUS ELEMENT                   
         USING TRSELD,R3                                                        
         BRAS  RE,GETELN                                                        
         BNE   CHKUNB3                                                          
         MVC   BILLADTE,TRSDATE    SAVE BILL ACTIVITY DATE                      
         OC    JXRRBDA,JXRRBDA                                                  
         BNZ   *+10                                                             
         MVC   JXRRBDA,DA                                                       
         B     CHKUNB3                                                          
*                                                                               
* FIND OTHER BILLS NOT YET REVERSED                                             
*  SAVE HIGHEST ACTIVITY DATE OF UNREVERSED INVOICE                             
*                                                                               
         USING PTAELD,R3                                                        
CHKUNB11 TM    PTASTAT1,PTASREVS   TEST REVERSE                                 
         BO    CHKUNB3             YES, SKIP IT                                 
         USING TRNRECD,R2                                                       
         LA    R2,TRNRFST                                                       
         USING TRNELD,R2                                                        
         OC    TRNUNBIL,TRNUNBIL   TEST UNBILLED DATE                           
         BNZ   CHKUNB3             YES, SKIP IT                                 
         MVC   SVBTYP,TRNBTYPE     SAVE BILLTYPE                                
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,TRSELQ       TRANSACTION STATUS ELEMENT                   
         USING TRSELD,R3                                                        
         BRAS  RE,GETELN                                                        
         BNE   CHKUNB3                                                          
         OC    LASTADTE,LASTADTE   TEST FIRST ITEM                              
         BZ    CHKUNB12            YES,  SAVE IT                                
         CLC   TRSDATE,LASTADTE    TEST LOWER ACTIVITY DATE                     
         BL    CHKUNB3             YES, OK TO SKIP                              
*                                                                               
CHKUNB12 L     R2,AIO                                                           
         USING TRNRECD,R2                                                       
         CLI   ORGBTYP,TRNBTPRO                                                 
         BNE   *+14                                                             
         CLC   SVBTYP,ORGBTYP      IS THE BILLTYPE THE SAME                     
         BE    CHKUNB3             YES, IGNORE IT                               
*                                                                               
         CLI   ORGBTYP,TRNBTSPE                                                 
         BNE   CHKUNB13                                                         
         CLC   SVBTYP,ORGBTYP                                                   
         BE    CHKUNB3                                                          
*                                                                               
CHKUNB13 MVC   LASTBILN,TRNKREF    YES, SAVE LAST BILL NUMBER                   
         MVC   LASTADTE,TRSDATE    SAVE LAST BILL ACTIVITY DATE                 
         B     CHKUNB3                                                          
*                                                                               
CHKUNB15 OC    BILLADTE,BILLADTE   TEST FOUND BILL                              
         BZ    CHKUNBX1            NO, CAN'T UNBILL                             
         CLC   LASTADTE,BILLADTE   TEST SUBSEQUENT UNREVERSED BILLING           
         BH    CHKUNBX2            YES, CAN'T UNBILL                            
         BL    CHKUNBX             NO, OK TO UNBILL                             
         CLC   LASTBILN,ACQSEL     TEST HIGHER NUMBER - ON THIS DATE            
         BH    CHKUNBX2            YES, CAN'T UNBILL                            
CHKUNBX  J     XITY                OK, TO UNBILL                                
*                                                                               
CHKUNBX1 OI    JXSTATB,JXSBNUNB    DATE/NUMBER PROBLEM                          
         J     XITN                                                             
CHKUNBX2 OI    JXSTATB,JXSBMRSQ    MUST UNBILL IN SEQUENCE                      
         J     XITN                                                             
CHKUNBX3 OI    JXSTATB,JXSBBISR    BILL IS A REVERSAL                           
         J     XITN                                                             
CHKUNBX4 OI    JXSTATB,JXSBBALR    BILL IS ALREADY REVERSED                     
         J     XITN                                                             
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* BUILD TABLE OF USER FIELDS                                          *         
***********************************************************************         
BLDUSR   NTR1  ,                                                                
         ICM   R2,15,JXAUSRF       TEST USER FIELDS REQUESTED                   
         JZ    XIT                 NOT NEEDED                                   
         MVI   0(R2),EOT           MARK END OF TABLE                            
*                                                                               
         MVI   ELCODE,JFNELQ       CHECK FOR FUND ELEMENT                       
         L     R3,JXAJOB                                                        
         BRAS  RE,GETEL                                                         
         BNE   BLDUSR3                                                          
         USING JFNELD,R3                                                        
         XC    DKEY,DKEY                                                        
         LA    R2,DKEY                                                          
         USING AUTRECD,R2                                                       
         MVI   AUTKTYP,AUTKTYPQ    GET AUTHORIZATION RECORD                     
         MVI   AUTKSUB,AUTKSUBQ                                                 
         MVC   AUTKOGR(L'JFNKEY),JFNKEY                                         
         L     RF,JXAJOB                                                        
         MVC   AUTKCUL,0(RF)                                                    
         BRAS  RE,HIGH                                                          
         BE    *+12                                                             
         OI    JXSTAT5,JXS5MAUR    SET 'MISSING AUTHORIZATION'                  
         B     BLDUSR3                                                          
*                                                                               
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         MVI   BYTE,C'A'           SET ' AUTHORIZATION RECORD'                  
         MVI   ELCODE,UFSELQ       CHECK USER FIELDS(AUTH RECORD)               
         L     R3,AIO3                                                          
         BRAS  RE,GETELN                                                        
         BNE   *+8                                                              
         BAS   RE,BLDUSX           BUILD USER FIELD TABLE                       
*                                                                               
BLDUSR3  MVI   BYTE,C' '           SET 'NOT AUTHORIZATION RECORD'               
         MVI   ELCODE,UFSELQ       CHECK USER FIELDS                            
         L     R3,JXAJOB                                                        
         BRAS  RE,GETEL                                                         
         BNE   *+8                                                              
         BAS   RE,BLDUSX           BUILD USER FIELD TABLE                       
         J     XIT                                                              
         DROP  R2,R3                                                            
*                                                                               
R        USING UFSELD,R3           R.RECORD                                     
BLDUSX   ST    RE,SVRE                                                          
         ICM   R2,15,JXAUSRF       R2=A(USER TABLE)                             
         USING USRFD,R2                                                         
BLDUSX3  TM    R.UFSSTAT,USRFSALL  SHOW ON/NEED FOR BILLS, RCV                  
         BZ    BLDUSX13                                                         
         LA    R0,1                SET NEW ITEM FLAG                            
         CLI   BYTE,C'A'           TEST AUTHORIZATION RECORD                    
         BE    BLDUSX7             OK TO ADD TO TABLE                           
         ICM   R2,15,JXAUSRF       ELSE START FROM TOP                          
*                                                                               
BLDUSX5  LA    R0,1                NEW ITEM FLAG                                
         CLI   0(R2),EOT           TEST EOT                                     
         BE    BLDUSX7                                                          
         LA    R4,USRFLM                                                        
T        USING UFSELD,R4           T.TABLE                                      
         CLC   T.UFSDESC,R.UFSDESC SAME DESCRIPTION                             
         BNE   BLDUSX6                                                          
         XR    R0,R0               SET OVERRIDE FLAG                            
         TM    USRFIND,USRFIAUT    OVERRRIDE AUTHORIZATION ELEMENT              
         BO    BLDUSX7             YES, OK TO OVERRIDE                          
BLDUSX6  LA    R2,USRFLNQ(R2)                                                   
         B     BLDUSX5                                                          
*                                                                               
BLDUSX7  XC    USRFD(USRFLNQ),USRFD                                             
         CLI   BYTE,C'A'                                                        
         BNE   *+8                                                              
         OI    USRFIND,USRFIAUT    SET FROM AUTHORIZATION RECORD                
         LLC   RF,R.UFSLN                                                       
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   USRFLM(0),R.UFSELD  SAVE ELEMENT                                 
         SHI   RF,UFSLN1Q-1                                                     
         BZ    BLDUSX9             BRANCH IF NO DATA                            
         STC   RF,USRFDLEN         SAVE LENGTH OF DATA                          
         B     BLDUSX11                                                         
*                                                                               
BLDUSX9  TM    R.UFSSTAT,UFSSNEBI  NEEDED FOR BILLING ?                         
         BNO   BLDUSX11                                                         
         OI    JXSTAT1,JXS1MUSR    SET MISSING USER FIELD                       
         OI    USRFIND,USRFIMIS                                                 
*                                                                               
BLDUSX11 LTR   R0,R0               IS THIS AN OVERRIDE ?                        
         BZ    BLDUSX13            YES, DON'T SET NEW EOT                       
         LA    R2,USRFLNQ(R2)                                                   
         MVI   0(R2),X'FF'                                                      
         LR    R0,R2                                                            
         A     R0,JXLUSRF          R0 = A(END OF TABLE)                         
         CR    R2,R0               TEST EOT                                     
         BL    *+6                                                              
         DC    H'0'                USER FIELD TABLE IS FULL                     
*                                                                               
BLDUSX13 BRAS  RE,NEXTEL                                                        
         BE    BLDUSX3                                                          
         L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  R2,R,T                                                           
         EJECT                                                                  
***********************************************************************         
* BUILD TABLE OF WORKCODE ESTIMATES                                   *         
***********************************************************************         
BLDEST   NTR1  ,                                                                
         ICM   R2,15,JXAEWC        R2=A(OUTPUT TABLE)                           
         JZ    XIT                                                              
         CLI   JXBLCODE,JXBLPEST   % OF ESTIMATE BILL ?                         
         BNE   BLDEST1                                                          
         CLI   0(R2),0             TEST RERUN OR UNBILL                         
         JNE   XIT                 YES, TABLE ALREADY SET                       
         USING JXEWD,R2                                                         
*                                                                               
BLDEST1  MVI   0(R2),EOT                                                        
         ICM   RE,15,JXLEWC        RE=LENGTH OF TABLE AREA                      
         JZ    XIT                                                              
         LR    R0,R2                                                            
         AR    R0,RE               R0=EOT                                       
         ICM   R3,15,JBACOLTB                                                   
*                                                                               
         TM    JXSTAT3,JXS3MCS     TEST MCS ESTIMATE                            
         BO    BLDMCS                                                           
*                                                                               
         USING JBCOLD,R3                                                        
         XR    R1,R1                                                            
         ICM   R1,3,JBNROWS                                                     
         JZ    XIT                                                              
*                                                                               
BLDEST3  CLI   JBCOLTYP,JBCOLTWC   TEST WORKCODE ENTRY                          
         BNE   BLDEST5                                                          
         LA    RF,JBCOLWC                                                       
         BAS   RE,WCFLT            WORKCODE FILTER                              
         BNE   BLDEST5                                                          
         LA    RF,JBCOLVAL                                                      
         BAS   RE,GETVAL           GET VALUES                                   
         BE    BLDEST5             SKIP IF NET=ZERO                             
         MVC   JXEWWC,JBCOLWC      WORKCODE TO TABLE                            
*                                                                               
         MVC   WCODE,JXEWWC                                                     
         BAS   RE,GETWCS           GET WORKCODE STATUS                          
*                                                                               
         LA    R2,JXEWLNQ(R2)                                                   
         MVI   0(R2),EOT                                                        
         CR    R2,R0                                                            
         BNH   *+6                                                              
         DC    H'0'                TABLE IS FULL                                
*                                                                               
BLDEST5  AH    R3,JBLCOL                                                        
         BCT   R1,BLDEST3                                                       
         J     XIT                                                              
*                                                                               
         USING MJETABD,R3                                                       
BLDMCS   DS    0H                                                               
BLDMCS1  CLI   MJETTYP,MJETTEQ     TEST EOT                                     
         JE    XIT                 YES,                                         
         CLI   MJETTYP,MJETTWQ     TEST WORKCODE LEVEL                          
         BNE   BLDMCS5             NO,                                          
         OC    MJET1RA,MJET1RA     BUT NOT 1R-LEVEL DETAILS                     
         BNZ   BLDMCS5                                                          
         LA    RF,MJETWCD                                                       
         BAS   RE,WCFLT            WORKCODE FILTER                              
         BNE   BLDMCS5                                                          
         LA    RF,MJETVAL                                                       
         BAS   RE,GETVAL           GET VALUES                                   
         BE    BLDMCS5             SKIP IF NET=ZERO                             
*                                                                               
         MVC   WCODE,MJETWCD                                                    
         BAS   RE,GETWCS           GET WORKCODE STATUS                          
         MVC   JXEWWC,MJETWCD      WORKCODE TO TABLE                            
*                                                                               
         LA    R2,JXEWLNQ(R2)                                                   
         MVI   0(R2),EOT                                                        
         CR    R2,R0                                                            
         BNH   *+6                                                              
         DC    H'0'                TABLE IS FULL                                
*                                                                               
BLDMCS5  XR    RF,RF                                                            
         IC    RF,MJETLEN          GET NEXT TABLE ENTR                          
         AR    R3,RF                                                            
         B     BLDMCS1                                                          
*                                                                               
GETWCS   ST    RE,SVRE             GET WORKCODE STATUS                          
         BAS   RE,GETWC            GET WORKCODE ENTRY                           
         LA    R4,WCEL             R2=A(WORKCODE ELEMENT)                       
         USING WCOELD,R4                                                        
         TM    WCOSTAT2,WCOSINC    TEST INCOME WORKCODE                         
         BNO   *+8                 NO,                                          
         OI    JXSTATA,JXSAINWC    YES, SET STATUS BIT                          
         TM    WCOSTAT,WCOSMEDT    TEST MEDIA TRANSFER                          
         BZ    *+8                                                              
         OI    JXSTATA,JXSAMTWC                                                 
         L     RE,SVRE                                                          
         BR    RE                                                               
         DROP  R4                                                               
*                                                                               
         USING JBCD,RF                                                          
GETVAL   ZAP   JXEWTNET,JBCCE           CURRENT ESTIMATE - NET                  
         ZAP   JXEWTGRS,JBCCEG                           - GROSS                
         ZAP   JXEWCOMR,JBCCOMR                                                 
         ZAP   JXEWCNET,PZERO                                                   
         ZAP   JXEWCGRS,PZERO                                                   
         CP    JBCCE,PZERO                                                      
         BR    RE                                                               
*                                                                               
         DROP  R2,R3,RF                                                         
         EJECT                                                                  
***********************************************************************         
* FOR %ESTIMATE BILLS GET CURRENT BILLABLE AMOUNT                     *         
***********************************************************************         
ESTBIL   NTR1  ,                                                                
         L     R2,JXAEWC                                                        
         USING JXEWD,R2                                                         
         LA    R5,JXAALLO          GET CURRENT % TO BILL                        
CUR      USING JXBKD,R5            CURRENT % EST                                
         LA    R6,JXATOT           GET TOTAL %EST                               
TOT      USING JXBKD,R6                                                         
*                                                                               
ESTBIL1  CLI   0(R2),EOT           TEST EOT                                     
         JE    XIT                                                              
         CLI   JXRROPT,0           TEST RERUN/UNBILL                            
         BNE   ESTBIL3             YES, TABLE ALREADY BUILT                     
         ZAP   PL13,JXEWTNET       NET                                          
         MP    PL13,JXPEST               * % OF EST                             
         SRP   PL13,64-4,5                                                      
         ZAP   JXEWCNET,PL13                                                    
         ZAP   JXEWCGRS,PL13                                                    
         CP    JXEWCOMR,PZERO                                                   
         BE    ESTBIL3                                                          
         CLI   GOESTCOM,YES                                                     
         BNE   ESTBIL3                                                          
         MP    PL13,JXEWCOMR            * COMMISSION                            
         SRP   PL13,64-6,5                                                      
         AP    JXEWCGRS,PL13                                                    
*                                                                               
ESTBIL3  AP    CUR.JXBNET,JXEWCNET      NET                                     
         AP    CUR.JXBGRS,JXEWCGRS      GROSS                                   
         AP    CUR.JXBCOM,JXEWCGRS      GROSS MINUS NET = COMMISSION            
         SP    CUR.JXBCOM,JXEWCNET                                              
*                                                                               
         AP    TOT.JXBNET,JXEWTNET      NET                                     
         AP    TOT.JXBGRS,JXEWTGRS      GROSS                                   
         AP    TOT.JXBCOM,JXEWTGRS      GROSS MINUS NET = COMMISSION            
         SP    TOT.JXBCOM,JXEWTNET                                              
*                                                                               
         LA    R2,JXEWLNQ(R2)                                                   
         B     ESTBIL1                                                          
*                                                                               
         DROP  R2,TOT,CUR                                                       
         EJECT                                                                  
***********************************************************************         
* READ CYCLE RECORD TO DETERMINE BILLTYPE                             *         
***********************************************************************         
GETCYC   NTR1  ,                                                                
         MVI   BYTE,JXBLTOTL       ASSUME TOTAL                                 
         OI    JXSTAT5,JXS5AUTO    SET 'AUTO' BILL TYPE                         
         XC    JXCYCDA,JXCYCDA                                                  
         XC    JXCYCLE,JXCYCLE                                                  
         LA    R0,TKEY             SAVE ACCOUNT KEY                             
         ST    R0,ATKEY                                                         
         GOTO1 DATAMGR,DMCB,DMKEY,ACCDIR,(R0)                                   
*                                                                               
         XC    DKEY,DKEY                                                        
         LA    R2,DKEY                                                          
         USING JCBRECD,R2                                                       
         MVI   JCBKTYP,JCBKTYPQ    GET CYCLE BILLING RECORD                     
         MVI   JCBKSUB,JCBKSUBQ                                                 
         MVC   JCBKCUL,GOSELCUL                                                 
         MVC   JCBKCLI,GOSELCLI                                                 
         MVC   JCBKPRO,GOSELPRO                                                 
         MVC   JCBKJOB,GOSELJOB                                                 
         BRAS  RE,HIGH                                                          
         BNE   GETCYCN             RECORD NOT FOUND -  ERROR                    
*                                                                               
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         L     R3,AIO3                                                          
         MVI   ELCODE,BCYELQ                                                    
         BRAS  RE,GETELN                                                        
         B     *+8                                                              
GETCYC3  BRAS  RE,NEXTEL                                                        
         BNE   GETCYCN                                                          
*                                                                               
         USING BCYELD,R3                                                        
GETCYC7  TM    JXRROPT,JXRROUNB    TEST UNBILL                                  
         BO    GETCYC11                                                         
         OC    BCYBILD,BCYBILD     WAS THIS ONE BILLED ?                        
         BNZ   GETCYC3             YES, LOOK AT NEXT ONE                        
         CLC   JXMOA,BCYMON        GET CORRECT MONTH                            
         BE    GETCYC9                                                          
         TM    BCYSTAT,BCYSMON     CHECK IF DATE HIGHER ALSO ?                  
         BNO   GETCYCS             SEQUENCE ERROR                               
         CLC   JXMOA,BCYMON                                                     
         BH    GETCYCS             SEQUENCE ERROR                               
*                                                                               
GETCYC9  CLI   BCYPER,X'FF'        ANY PERCENTAGE ?                             
         BE    GETCYCX             NO, ALL DONE                                 
         MVI   BYTE,JXBLPEST       YES, CHANGE TYPE                             
         XR    RF,RF                                                            
         ICM   RF,3,BCYPER         GET PERCENTAGRE                              
         STCM  RF,15,CYCPER        SAVE CYCLE PERCENT                           
         B     GETCYCY                                                          
*                                                                               
*                                  * UNBILLING *                                
GETCYC11 CLC   BCYREF,JXRRNUM      CORRECT BILL ?                               
         BNE   GETCYC3                                                          
         CLC   BCYBILD,JXRRADT     RUN DATE ?                                   
         BNE   GETCYC3                                                          
         BRAS  RE,NEXTEL           MUST BE LAST CYCLE                           
         BNE   GETCYCY                                                          
         CLI   BCYREF,C' '         TEST A LATER BILL                            
         BH    GETCYCN                                                          
*                                                                               
GETCYCY  MVC   JXCYCDA,DA          SAVE DA OF CYCLE RECORD                      
         MVC   JXCYCLE,BCYCLE      AND CYCLE NUMBER                             
         B     GETCYCX                                                          
*                                                                               
GETCYCN  TM    JXRROPT,JXRROUNB    TEST UNBILL                                  
         BNO   *+12                                                             
         OI    JXSTAT5,JXS5NUNB    CAN'T UNBILL                                 
         B     GETCYCX                                                          
         OI    JXSTAT5,JXS5NCYC    NO CYCLE RECORD                              
         B     GETCYCX                                                          
GETCYCS  OI    JXSTAT5,JXS5CYCS    SEQUENCE ERROR                               
GETCYCX  MVC   DKEY,TKEY           RESTORE SEQUENCE                             
         BRAS  RE,READ                                                          
         J     XIT                                                              
         DROP  R2,R3                                                            
         EJECT                                                                  
**********************************************************************          
* SPECIAL AMOUNT BILL                                                *          
**********************************************************************          
SPCLB    NTR1  ,                                                                
         TM    JXSTAT1,JXS1DIST    TEST DISTRIBUTION SCHEME                     
         BNO   SPCLB3              NO,                                          
         TM    JXRROPT,JXRROUNB    TEST UNBILL                                  
         BNO   SPCLB5              NO, OK TO ADD                                
         B     SPCLBX              ALREADY ADDED                                
*                                                                               
SPCLB3   TM    JXRROPT,JXRROUNB    TEST UNBILL                                  
         BO    SPCLB7              YES,                                         
*                                                                               
SPCLB5   ICM   R1,15,GOBILAM1                                                   
         CVD   R1,DUB                                                           
         ZAP   JXSPCL,DUB                                                       
         ZAP   NET,JXSPCL                                                       
         ZAP   COMR,GOAGYCOM       GET CURRENT COMMISSION RATE                  
         OI    JXSTAT9,JXS9RCOM    COMM. APPLIES TO RETAIL                      
         BAS   RE,GETGRS                                                        
         NI    JXSTAT9,ALL-JXS9RCOM                                             
*                                                                               
SPCLB7   LA    RF,JXAALLO                                                       
         BRAS  RE,POSTIT           POST 'SPECIAL AMOUMTS'                       
SPCLBX   J     XIT                                                              
         EJECT                                                                  
**********************************************************************          
* SPECIAL FOR CLIENT BILL ALLOCATION                                 *          
**********************************************************************          
CBLA     NTR1  ,                                                                
         L     R2,ADTRNR                                                        
         AH    R2,DATADISP                                                      
         USING TRNELD,R2                                                        
         CLI   0(R2),TRNELQ                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         ZAP   DUB2,PZERO          KEEP TOTAL BILLED IN DUB2                    
*                                                                               
         LR    R3,R2               ** OLD BNDEL ELEMENTS **                     
         MVI   ELCODE,BNDELQ       GET BILL NUMBER/DATE ELEMENT                 
*                                                                               
         USING BNDELD,R3                                                        
CBLA3    BRAS  RE,NEXTEL                                                        
         BNE   CBLA5                                                            
         OC    BNDBNO,BNDBNO       IS IT A SPARE ELEMENT ?                      
         BZ    CBLA3               YES, SPARE                                   
         ICM   RF,15,BNDAMNT       NET                                          
         CVD   RF,DUB                                                           
         AP    DUB2,NET            ADD TO BILLED SO FAR                         
         CLC   BNDBNO,SPACES       IS IT AN ALLOCATION ELEMENT ?                
         BH    CBLA3               NO, ALREADY BILLED                           
*                                                                               
         OI    JXTSTAT2,JXTS2ALC   SET ALLOCATED CHARGE                         
         ZAP   NET,DUB                                                          
*                                                                               
         ICM   RF,15,BNDCSD        CASH DISCOUNT                                
         CVD   RF,DUB                                                           
         ZAP   CSD,DUB                                                          
*                                                                               
         ICM   RF,15,BNDCMP        COMMISSION RATE                              
         CVD   RF,DUB                                                           
         TM    BNDCMP,BNDCPACK     COMMISSION RATE IS PACKED                    
         BNO   *+10                                                             
         ZAP   DUB,BNDCMP                                                       
         ZAP   COMR,DUB                                                         
         B     CBLA9                                                            
*                                                                               
CBLA5    LR    R3,R2               ** PTAEL ELEMENTS **                         
         MVI   ELCODE,PTAELQ       PROD. TRANSACTION ACTIVITY                   
*                                                                               
         USING PTAELD,R3                                                        
CBLA7    BRAS  RE,NEXTEL                                                        
         BNE   CBLAX                                                            
         CLI   PTATYPE,PTATRAL     TEST REGULAR ALLOCATION                      
         BNE   CBLA7               NO, SKIP IT                                  
         AP    DUB2,PTANET         ADD TO BILLED SO FAR                         
         TM    PTASTAT1,PTASPEND   TEST PENDING                                 
         BO    CBLA8               YES, TAKE IT                                 
         ICM   RF,15,APTARRL       TEST, THIS IS RERUN PTAEL                    
         BZ    CBLA7               NO RERUN PTAEL                               
         CR    R3,RF                                                            
         BNE   CBLA7               NO, SKIP IT                                  
*                                                                               
CBLA8    OI    JXTSTAT2,JXTS2ALC   SET ALLOCATED CHARGE                         
         ZAP   NET,PTANET          NET                                          
         ZAP   CSD,PTACDSC         CASH DISCOUNT                                
         ZAP   COM,PTARCOM         COMMISSION                                   
         LH    R1,PTAHOURS         HOURS                                        
         CVD   R1,DUB                                                           
         ZAP   HRS,DUB                                                          
*                                                                               
CBLA9    OI    JXSTAT9,JXS9RCOM   COMM. APPLIES TO RETAIL                       
         BAS   RE,GETGRS           GET COMMISSION & GROSS                       
         NI    JXSTAT9,ALL-JXS9RCOM                                             
         LA    RF,JXTALLO          ADD TO ALLOCATED                             
         BRAS  RE,POSTIT           POST TO TRANSACTION LEVEL                    
         CP    TRNAMNT,DUB2        TEST IT IS NOW FULLY BILLED                  
         BNE   *+8                                                              
         OI    JXTSTAT3,JXTS3MKU   MARK AS USED                                 
*                                                                               
CBLAX    J     XIT                                                              
         DROP  R2,R3                                                            
         EJECT                                                                  
**********************************************************************          
* GET TRANSFER & WRITEOFF AMOUNTS                                    *          
**********************************************************************          
TXWO     NTR1  ,                                                                
         L     R3,ADTRNR                                                        
         AH    R3,DATADISP                                                      
         CLI   0(R3),TRNELQ                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LR    R3,R2               ** PTAEL ELEMENTS **                         
         MVI   ELCODE,PTAELQ       PROD. TRANSACTION ACTIVITY                   
*                                                                               
         USING PTAELD,R3                                                        
TXWO3    BRAS  RE,NEXTEL                                                        
         BNE   TXWOX                                                            
         LA    RF,JXTWOFF          SET FOR WRITEOFF/RECOVERY                    
         CLI   PTATYPE,PTATWOF     TEST WRITEOFF                                
         BNE   *+12                                                             
         OI    JXTSTAT2,JXTS2WO                                                 
         B     TXWO5                                                            
*                                                                               
         CLI   PTATYPE,PTATWOFR    W/O RECOVERY ?                               
         BNE   *+12                                                             
         OI    JXTSTAT2,JXTS2WOR                                                
         B     TXWO5                                                            
*                                                                               
         LA    RF,JXTTRNX          SET FOR TRANSFER                             
         CLI   PTATYPE,PTATTRFF    TEST TRANSFER                                
         BNE   TXWO3               NO, GET NEXT                                 
*                                                                               
TXWO5    ZAP   NET,PTANET          NET                                          
         ZAP   GRS,PTANET          GROSS                                        
         ZAP   COM,PZERO           COMMISSION                                   
         ZAP   CSD,PTACDSC         CASH DISCOUNT                                
         LH    R1,PTAHOURS         HOURS                                        
         CVD   R1,DUB                                                           
         ZAP   HRS,DUB                                                          
*                                                                               
         BRAS  RE,POSTIT           ADD TO ACCUMS                                
         B     TXWO3                                                            
*                                                                               
TXWOX    J     XIT                                                              
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* GET WORKCODE ENTRY                                                 *          
***********************************************************************         
GETWC    NTR1  ,                                                                
         LA    R2,WCEL             R2=A(WORKCODE ELEMENT)                       
         USING WCOELD,R2                                                        
         CLC   WCODE,WCOCODE       MATCH WORKCODE                               
         JE    XIT                                                              
         MVI   JXWCSTA,0                                                        
         ICM   R2,15,JXAWCODE      A(WORKCODE ELEMENTS)                         
         BZ    GETWC9              NOT PASSED -  MUST READ FILE                 
*                                                                               
GETWC3   XR    R1,R1                                                            
         CLI   WCODE+1,C' '        TEST ONE BYTE CODE                           
         BNH   *+8                                                              
         LA    R1,1                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   WCODE(0),WCOCODE    FIND CORRECT WC ELEMENT                      
         BNE   GETWC6                                                           
         MVC   WCEL,WCOEL          SAVE WORKCODE DATA                           
*                                                                               
         LA    RF,WCTYTAB          FIND TYPE                                    
GETWC4   CLC   WCOTYPE,0(RF)                                                    
         BE    GETWC5                                                           
         LA    RF,L'WCTYTAB(RF)                                                 
         CLI   0(RF),EOT                                                        
         BNE   GETWC4                                                           
*                                                                               
GETWC5   MVC   JXWCSTA,1(RF)       SET WC TYPE                                  
         J     XIT                                                              
*                                                                               
GETWC6   LLC   R0,WCOLN                                                         
         AR    R2,R0                                                            
GETWC7   CLI   0(R2),WCOELQ                                                     
         BE    GETWC3                                                           
         CLI   0(R2),0                                                          
         BNE   GETWC6                                                           
         DC    H'0'                WORKCODE NOT FOUND                           
*                                                                               
                                                                                
GETWC9   LA    R0,TKEY             SAVE TRANSACTION KEY                         
         ST    R0,ATKEY                                                         
         GOTO1 DATAMGR,DMCB,DMKEY,ACCDIR,(R0)                                   
*                                                                               
         MVC   DKEY,SPACES                                                      
         LA    R2,DKEY                                                          
         USING WCORECD,R2                                                       
         MVI   WCOKTYP,WCOKTYPQ                                                 
         L     RF,JXAJOB                                                        
         MVC   WCOKCPY(3),0(RF)    CUL                                          
         MVC   WCOKWRK,WCODE       CODE                                         
         BRAS  RE,READ                                                          
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         L     R2,AIO3                                                          
         LA    R2,WCORFST                                                       
         MVC   DKEY,TKEY           RESTORE SEQUENCE                             
         BRAS  RE,READ                                                          
         B     GETWC7                                                           
         DROP  R2                                                               
*                                                                               
WCTYTAB  DS    0XL2                WORKCODE TYPE TABLE                          
         DC    C'T',AL1(JXWCTIM)                                                
         DC    C'M',AL1(JXWCMED)                                                
         DC    C'P',AL1(JXWCPBL)                                                
         DC    C'R',AL1(JXWCRET)                                                
         DC    AL1(EOT),AL1(JXWCOOP)                                            
         EJECT                                                                  
***********************************************************************         
* GET COMMISSION AND GROSS                                           *          
***********************************************************************         
GETGRS   NTR1  ,                                                                
         ZAP   JXTCOMR,PZERO       START WITH COMMISSION RATE = ZERO            
         ICM   R2,15,JXATRNEL                                                   
         BZ    *+12                                                             
         USING TRNELD,R2                                                        
         TM    TRNSTAT,TRNSNOCM    TEST TRANSACTION NON-COMMISSIONABLE          
         BO    GETGRS3                                                          
         ICM   R3,15,JXAPRTEL                                                   
         BZ    *+12                                                             
         USING PRTELD,R3                                                        
         TM    PRTSTAT,PRTSNOTQ+PRTSRTEQ    IS IT 'N' OR 'R' TIME ?             
         BNZ   GETGRS3                                                          
         TM    JXBLTYP,ESTM+SPCL   ESTIMATE OR SPECIAL BILL ?                   
         BZ    *+12                                                             
         CLI   GOESTCOM,YES                                                     
         BNE   GETGRS3                                                          
         TM    JXBLTYP,SPCL        SPECIAL BILL                                 
         BO    GETGRS2                                                          
         LA    R4,WCEL             R2=A(WORKCODE ELEMENT)                       
         USING WCOELD,R4                                                        
         TM    WCOSTAT,WCOSNONC    NON-COMMISSIONABLE                           
         BO    GETGRS3                                                          
         TM    WCOSTAT,WCOSMEDT    MEDIA TRANSFER                               
         BO    GETGRS3                                                          
         DROP  R4                                                               
*                                                                               
GETGRS2  ZAP   JXTCOMR,COMR        OK TO SET COMMISSION RATE                    
         ICM   RF,15,APTARRL       IS THIS A RERUN OR UNBILL ?                  
         BZ    GETGRS3                                                          
         USING PTAELD,RF                                                        
         ZAP   JXTCOMR,PTARCORT    USE ORIGINAL COMMISSION RATE.                
         ZAP   COM,PTARCOM                                                      
         B     GETGRS4                                                          
         DROP  RF                                                               
*                                                                               
GETGRS3  ZAP   WORK(13),NET              NET                                    
         AP    WORK(13),CSD        PLUS: CD                                     
         MP    WORK(13),JXTCOMR        * RATE                                   
         SRP   WORK(13),64-6,5     ROUNDED TO 2DP                               
         ZAP   COM,WORK(13)        COMMISSION                                   
GETGRS4  ZAP   GRS,NET                                                          
         AP    GRS,COM             GROSS                                        
*                                                                               
         LTR   R2,R2                                                            
         BZ    *+12                                                             
         TM    TRNSTAT,TRNSNOCM    TEST TRANSACTION NON-COMMISSIONABLE          
         JO    XIT                                                              
         TM    JXSTAT9,JXS9RCOM    APPLY TO  RETAIL ?                           
         JNO   XIT                                                              
         OC    JXARETLB,JXARETLB   TEST RETAIL DISTRIBUTION BUFFER              
         JZ    XIT                                                              
         TM    JXSTAT1,JXS1DIST    TEST DISTRIBUTION SCHEME                     
         JNO   XIT                                                              
         TM    JXSTAT9,JXS9RSCM    TEST SPECIAL COMM. RATES IN USE              
         BNO   *+10                                                             
         ZAP   COM,PZERO                                                        
*                                                                               
         USING RTLD,R5                                                          
         L     R5,JXARETLB         TEST ANY RETAIL DISTRIBUTORS                 
         CLI   0(R5),EOT                                                        
         BNE   GETGRS5             YES,                                         
         OI    JXSTATA,JXSARTLC    NO, SETERROR                                 
         J     XIT                                                              
*                                                                               
GETGRS5  ZAP   PL16,NET                                                         
         AP    PL16,CSD                                                         
         MP    PL16,RTLPCT         * PCT.                                       
         TM    RTLSTAT,RTLCOMM     TEST SPECIAL RATE FOR THIS DISTRIB.          
         BNO   GETGRS7             NO,                                          
         MP    PL16,RTLCRATE       * SPECIAL RATE                               
         B     GETGRS9                                                          
*                                                                               
GETGRS7  MP    PL16,JXTCOMR        * RATE                                       
*                                                                               
GETGRS9  SRP   PL16,64-12,5                                                     
         AP    RTLCMTOT,PL16       ADD TO TOTAL COMMISSION FOR DIST.            
         AP    JXRTLCOM,PL16       AND TO OVERALL TOTAL                         
         TM    JXSTAT9,JXS9RSCM    TEST SPECIAL COMM. RATES IN USE              
         BNO   *+10                                                             
         AP    COM,PL16                                                         
         LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),EOT                                                        
         BNE   GETGRS5                                                          
         J     XIT                                                              
         DROP  R2,R3,R5                                                         
         EJECT                                                                  
***********************************************************************         
* WORKCODE FILTER                                                     *         
***********************************************************************         
WCFLT    CLC   JXWCFLT,SPACES      ANY WORKCODE FILTER?                         
         BE    WCFLTY                                                           
         CLC   0(L'TRNKWORK,RF),JXWCFLT                                         
         BE    WCFLTY                                                           
         TM    JXWCFLT,X'40'       IS IT POSITIVE FILTER                        
         BO    WCFLTN              YES, SKIP THIS RECORD                        
         MVC   WORK(2),JXWCFLT                                                  
         OI    WORK,X'40'                                                       
         CLC   0(L'TRNKWORK,RF),WORK DOES IT MATCH THE EXCLUDE ?                
         BE    WCFLTN               YES, SKIP IT                                
WCFLTY   CR    RB,RB                                                            
         BR    RE                                                               
WCFLTN   LTR   RB,RB                                                            
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
* TRANSACTION FILTER - FOR CLIENT BILLS                              *          
***********************************************************************         
TRNFLT   NTR1  ,                                                                
         L     R3,ADTRNR                                                        
         USING TRNRECD,R3                                                       
         LA    R3,TRNRFST                                                       
         USING TRNELD,R3                                                        
*                                                                               
         CLI   WCFTYP,0            TEST ALREADY HAVE FILTER TYPE                
         BNE   TRNFLT7             YES                                          
         ICM   R4,15,JXACQ         TEST REQUEST PASSED                          
         USING ACQD,R4                                                          
         LA    RF,TRNFTAB          FORMAT/TYPE TABLE                            
TRNFLT3  CLC   JXFORMC,0(RF)        MATCH FORMAT CODE                           
         BE    TRNFLT5                                                          
         LA    RF,L'TRNFTAB(RF)                                                 
         CLI   0(RF),EOT                                                        
         BNE   TRNFLT3                                                          
         DC    H'0'                BAD FORMAT CODE                              
*                                                                               
TRNFLT5  MVC   WCFTYP,1(RF)        SAVE WC FILTER TYPES                         
*                                                                               
TRNFLT7  LLC   R1,WCFTYP                                                        
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    JXWCSTA,0           TEST WC TYPE WANTED                          
         JZ    XITN                NO,                                          
*                                                                               
         CLI   ACQAPPL+4,C'0'      TEST FORMAT 0                                
         JE    XITY                YES, OK                                      
         CLI   ACQAPPL+4,C'1'      TEST FORMAT 1                                
         JE    XITY                YES, OK                                      
         CLI   ACQAPPL+4,C'8'      TEST FORMAT 8                                
         JE    XITY                YES, OK                                      
         TM    JXWCSTA,JXWCPBL     TEST TYPE PREBILL                            
         JZ    XITY                                                             
         CLI   TRNTYPE,TRNTEPRV    ONLY WANT TYPE 48                            
         JNE   XITN                                                             
         J     XITY                                                             
         DROP  R3,R4                                                            
         EJECT                                                                  
***********************************************************************         
* SET ERRORS MESSAGE                                                  *         
***********************************************************************         
SETMSG   OC    JXERRS,JXERRS       TEST ANY ERROR                               
         BZR   RE                  NONE                                         
         OC    JXAERMSG,JXAERMSG   TEST MESSAGE TEXT AREA                       
         BZR   RE                  NONE                                         
         CLI   JXLERMSG,0          TEST LENGTH OF AREA                          
         BER   RE                  NONE                                         
SETMSG1  NTR1  ,                                                                
         LA    R1,DMCB             SET TEXT BLOCK                               
         USING GETTXTD,R1                                                       
         XC    GTBLOCK,GTBLOCK                                                  
         MVC   GTMSGNO,JXERRS                                                   
         MVI   GTMSYS,X'06'                                                     
         MVC   GTMAXL,JXLERMSG                                                  
         ICM   RF,15,JXAERMSG                                                   
         STCM  RF,7,GTAOUT                                                      
         MVI   GTMTYP,GTMERR                                                    
         MVI   GT1INDS,GT1OWRK                                                  
         GOTO1 GETTXT,GETTXTD                                                   
         J     XIT                                                              
         DROP  R1                                                               
         EJECT                                                                  
***********************************************************************         
* DATA CONSTANTS AND EQUATES                                         *          
***********************************************************************         
YES      EQU   C'Y'                                                             
NO       EQU   C'N'                                                             
EOT      EQU   X'FF'                                                            
ALL      EQU   X'FF'                                                            
*                                                                               
FFS      DC    (L'JXERRS)X'FF'                                                  
*                                                                               
PGMTAB   DS    0XL3                                                             
         DC    C'21',AL1(JXA21Q+JXLIVQ)                                         
         DC    C'22',AL1(JXA21Q)                                                
         DC    C'23',AL1(JXA21Q+JXLIVQ+JXREVQ)                                  
         DC    C'24',AL1(JXA21Q+JXREVQ)                                         
*                                                                               
         DC    C'27',AL1(JXA27Q+JXLIVQ)                                         
         DC    C'28',AL1(JXA27Q)                                                
         DC    C'29',AL1(JXA27Q+JXLIVQ+JXREVQ)                                  
         DC    C'30',AL1(JXA27Q+JXREVQ)                                         
         DC    X'FF'                                                            
*                                                                               
BILLTAB  DS   0CL20                                                             
         DC   C'P',AL1(TRNBTPRO),CL15'PROGRESSIVE'                              
         DC   AL1(PROG),AL1(JXBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'T',AL1(TRNBTTOT),CL15'TOTAL BILL'                               
         DC   AL1(TOTL),AL1(JXBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'1',AL1(TRNBTONE),CL15'ONE-LINE BILL'                            
         DC   AL1(ONEL),AL1(JXBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'E',AL1(TRNBTPER),CL15'   PC ESTIMATE'                           
         DC   AL1(ESTM),AL1(JXBLSTRN+JXBLSEST),AL1(0)                           
*                                                                               
         DC   C'S',AL1(TRNBTSPE),CL15'SPECIAL AMOUNT'                           
         DC   AL1(SPCL),AL1(JXBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'C',AL1(TRNBTALL),CL15'ALLOCATED BILL'                           
         DC   AL1(ALLO),AL1(JXBLSTRN),AL1(0)                                    
*                                                                               
         DC   C'U',AL1(0),CL15'UNBILLABLE'                                      
         DC   AL1(NOTB),AL1(0),AL1(0)                                           
*                                                                               
*                                                                               
PZRO     DC    P'0'                                                             
P1DLR    DC    PL6'100'            $1.00                                        
P100P    DC    PL6'10000'          100.00%                                      
PONEHDRD DC    PL6'1000000'                                                     
*                                                                               
*              CURRENT ESTIMATE/HIGHEST REVISION (NET & GROSS)                  
ESTLH    DC    AL1(8+L'ESTL),4X'00',AL1(L'ESTL),AL2(0)                          
ESTL     DC    C'CE,CEG,HR,HRG,RATE'                                            
*                                                                               
DMCMDS   DS    0CL8                                                             
         DC    CL8'DMKEY   '                                                    
         DC    CL8'ACCDIR  '                                                    
         DC    CL8'ACCMST  '                                                    
         DC    CL8'DMREAD  '                                                    
         DC    CL8'DMRDHI  '                                                    
         DC    CL8'DMRSEQ  '                                                    
         DC    CL8'GETREC  '                                                    
DMCMDLNQ EQU   *-DMCMDS                                                         
*                                                                               
*                                   TRANSACTION FILTER TABLE                    
*                                   FORMAT, WORKCODE TYPE                       
TRNFTAB  DS    0XL2                                                             
         DC    C'0',AL1(JXWCALL)                                                
         DC    C'1',AL1(JXWCPBL)                                                
         DC    C'2',AL1(JXWCOOP+JXWCPBL+JXWCTIM)                                
         DC    C'3',AL1(JXWCOOP+JXWCPBL+JXWCTIM)                                
         DC    C'4',AL1(JXWCOOP+JXWCPBL+JXWCTIM)                                
         DC    C'5',AL1(JXWCOOP+JXWCPBL+JXWCTIM)                                
         DC    C'6',AL1(JXWCOOP+JXWCPBL+JXWCTIM+JXWCRET)                        
         DC    C'7',AL1(JXWCOOP+JXWCPBL+JXWCTIM)                                
         DC    C'8',AL1(JXWCALL)                                                
         DC    AL1(EOT)                                                         
*                                                                               
COLTABLQ DC    A(COLTABL)                                                       
OPVTABLQ DC    A(OPVTABL)                                                       
         EJECT                                                                  
***********************************************************************         
* LITERAL POOL                                                        *         
***********************************************************************         
         LTORG                                                                  
*                                                                               
         DROP  RB,RA                                                            
         EJECT                                                                  
**********************************************************************          
* % ESTIMATE JOBS                                                    *          
**********************************************************************          
         USING JOBELD,R3                                                        
PEST     NTR1  BASE=*,LABEL=*                                                   
         ICM   R3,15,JXAJOBEL                                                   
         CLI   JXRROPT,0           TEST RERUN/UNBILL                            
         BNE   PEST5                                                            
         CLI   JOBLN,JOBLN3Q                                                    
         BL    PESTX                                                            
         TM    JOBBIST,JOBB3BIL    3RD BILLING DONE ?                           
         BNO   PEST3                                                            
         CP    JXBALN,PZERO        TEST OVERBILLED                              
         BL    PEST2               YES, ALLOW CREDIR                            
         TM    JXOPTS2,JXORJOB     TEST RETAIL ADJUSTMENT                       
         BNO   PESTX               NO,                                          
PEST2    NI    JOBBIST,X'FF'-(JOBB3BIL) YES, BACKUP ONE CYCLE                   
*                                                                               
PEST3    LA    RF,PESTAB                                                        
         CLC   JOBBIST,0(RF)       MATCH CURRENT STATUS                         
         BE    *+20                                                             
         LA    RF,L'PESTAB(RF)                                                  
         CLI   0(RF),EOT                                                        
         BNE   *-18                                                             
         B     PESTX                                                            
*                                                                               
         MVC   JXPESTST,2(RF)      SAVE % OF ESTIMATE NEW STATUS                
         XR    R0,R0                                                            
         ICM   R0,1,1(RF)          # OF BUCKETS                                 
         STC   R0,JXCYCLE                                                       
         XR    R2,R2               CUMULATIVE %'S                               
         LA    RE,GOBILAM1                                                      
         ICM   R1,15,0(RE)                                                      
         AR    R2,R1                                                            
         LA    RE,4(RE)                                                         
         BCT   R0,*-10                                                          
*                                                                               
         OC    CYCPER,CYCPER       PERCENT FROM CYCLE RECORD                    
         BZ    *+8                                                              
         ICM   R2,15,CYCPER                                                     
         CVD   R2,DUB                                                           
         ZAP   JXPEST,DUB          SAVE % OF ESTIMATE TO BILL                   
*                                                                               
PEST5    MVC   DMCB(15),SPACES                                                  
         EDIT  JXPEST,(6,DMCB),2,ALIGN=LEFT                                     
         LA    R1,DMCB+3                                                        
         LA    R0,3                                                             
         CLC   0(3,R1),=C'.00'     100.00PC ESTIMATE                            
         BE    *+14                                                             
         BCTR  R1,0                                                             
         BCT   R0,*-12             BECOMES 100PC ESTIMATE                       
         B     *+10                                                             
         MVC   0(3,R1),SPACES      99.99PC ESTIMATE = 99.99PC ESTIMAT           
         LA    R1,DMCB+6                                                        
         CLI   0(R1),C' '                                                       
         BNE   *+8                                                              
         BCT   R1,*-8                                                           
         MVC   1(11,R1),=C'PC ESTIMATE'                                         
         MVC   JXBLNME,DMCB                                                     
PESTX    J     XIT                                                              
         DROP  R3                                                               
*                                                                               
PESTAB   DS    0XL3      CURRENT STATUS/# OF GOBILAM'S/NEXT STATUS              
         DC    AL1(0),AL1(1),AL1(JOBB1BIL)                                      
         DC    AL1(JOBB1BIL),AL1(2),AL1(JOBB2BIL)                               
         DC    AL1(JOBB1BIL+JOBB2BIL),AL1(3),AL1(JOBB3BIL)                      
         DC    AL1(EOT)                                                         
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* APPLY EXCEPTION RULES                                               *         
*  ALL CONDITIONS MUST BE MET BEFORE EXCEPTION IS APPLIED             *         
***********************************************************************         
XRUL     NTR1  BASE=*,LABEL=*                                                   
         L     R3,ADXCP                                                         
         USING XCPD,R3                                                          
XRUL3    CLI   MODE,ACCLAST        AT ACCLAST ALL APPLY                         
         BE    *+12                                                             
         CLI   XCPTLEV,ACCFRST     ONLY LOOK AT ACCFRST RULES                   
         BNE   XRUL99                                                           
*                                                                               
         XR    R1,R1                                                            
         ICM   R1,1,XCPTSTA        TEST WARNING OR EXCEPTION                    
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    JXXRSTA,0                                                        
         BZ    XRUL99              DOES NOT APPLY                               
*                                                                               
         ICM   R1,1,XCPTBIN        BILL TYPES TO INCLUDE                        
         BZ    XRUL5                                                            
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    JXBLTYP,0                                                        
         BZ    XRUL99              NOT ONE TO BE INCLUDED                       
*                                                                               
XRUL5    ICM   R1,1,XCPTBEX        BILL TYPES TO EXCLUDE                        
         BZ    XRUL6                                                            
         EX    R1,*+8                                                           
         B     *+8                                                              
         TM    JXBLTYP,0                                                        
         BNZ   XRUL99              ONE TO BE EXCLUDED                           
*                                                                               
XRUL6    TM    XCPINDS,XCPINREV    TEST SKIP RULE FOR REVERSE BILL              
         BNO   XRUL7               NO,                                          
         TM    JXPGM,JXREVQ        TEST REVERSE RUN                             
         BO    XRUL99              YES, SKIP TEST                               
                                                                                
XRUL7    LA    R4,XCCNDL                                                        
XRUL9    XR    RF,RF                                                            
         ICM   RF,3,1(R4)          DISP. TO STATUS BYTE OR ROUTINE              
         CLI   0(R4),0             IS THERE A BIT TEST ?                        
         BE    XRUL13                                                           
         LA    RF,JXD(RF)                                                       
         LLC   RE,0(R4)                                                         
         EX    RE,*+8                                                           
         B     *+8                                                              
         TM    0(RF),0             TEST STATUS BIT                              
         BNO   XRUL16              ALL CONDITIONS MUST BE MET                   
         B     XRUL15              BEFORE EXCEPTION IS APPLIED                  
*                                                                               
XRUL13   AR    RF,RB               GO TO SPECIAL ROUTINE                        
         BASR  RE,RF               TEST CONDITION                               
         BNE   XRUL16              NOT A PROBLEM                                
*                                                                               
XRUL15   LA    R4,L'XCCNDL(R4)                                                  
         CLC   0(L'XCCNDL,R4),XCEND  TEST END OF LIST                           
         BE    XRUL17                YES, ALL CONDITIONS APPLIED                
         CLC   0(L'XCCNDL,R4),XCOR   TEST OR                                    
         BE    XRUL17                YES,                                       
         B     XRUL9                 NO, TRY NEXT CONDITION                     
*                                                                               
XRUL16   LA    R4,L'XCCNDL(R4)       LOOK FOR 'OR'                              
         CLC   0(L'XCCNDL,R4),XCEND  TEST END OF LIST                           
         BE    XRUL99                YES, ALL DONE                              
         CLC   0(L'XCCNDL,R4),XCOR   TEST OR                                    
         BNE   XRUL16                                                           
         LA    R4,L'XCCNDL(R4)       GET PASSED OR                              
         B     XRUL9                 AND PROCESS NEXT                           
*                                                                               
XRUL17   LA    R5,JXERRS           SET ERROR MESSAGES                           
         TM    XCPTSTA,XCPTSEX     TEST EXCEPTION                               
         BO    *+8                 YES,                                         
         LA    R5,JXWARN           SET WARNING                                  
         LA    R0,5                MAX OF 5                                     
*                                                                               
XRUL19   OC    0(2,R5),0(R5)       FIND A UNUSED SPOT                           
         BZ    XRUL21              YES,                                         
         LA    R5,2(R5)            NO, LOOK AT NEXT                             
         BCT   R0,XRUL19                                                        
         B     XRUL99              MAX ERRORS - SKIP IT                         
*                                                                               
XRUL21   MVC   0(2,R5),XCPERRN     SET ERROR NUMBER                             
         TM    XCPINDS,XCPISET1    ERROR 1                                      
         BNO   *+8                                                              
         OI    ERRORS,ERR1                                                      
         TM    XCPINDS,XCPISETF    ERROR F                                      
         BNO   *+8                                                              
         OI    ERRORS,ERRF                                                      
         TM    XCPINDS,XCPISETH    ERROR H                                      
         BNO   *+8                                                              
         OI    ERRORS,ERRH                                                      
*                                                                               
XRUL99   XR    R1,R1               BUMP TO NEXT RULE                            
         ICM   R1,3,XCPLEN                                                      
         AR    R3,R1                                                            
         CLI   0(R3),EOT           TEST EOT                                     
         BNE   XRUL3                                                            
         J     XIT                                                              
         DROP  R3                                                               
                                                                                
XCEND    DC    XL3'000000'     END OF ENTRY                                     
XCOR     DC    XL3'000001'     START OF 'OR' ENTRY                              
         EJECT                                                                  
***********************************************************************         
* SPECIAL CONDITIONAL - RETURNS AN EQUAL CC IF IT'S A PROBLEM                   
***********************************************************************         
SPR02    DS    0H                  RULE #2 AND                                  
SPR25    DS    0H                  RULE #25 AND                                 
SPR28    DS    0H                  RULE #28 AND                                 
SPR35    DS    0H                  RULE #35 HAVE SAME EXCEPTIONS                
         TM    JXSTAT1,JXS1DIST    TEST RETAILER                                
         BNO   SPR02A              NO,                                          
         TM    JXOPTS2,JXORJOB     TEST RETAIL ADJUSTMENT(OPT3=R)               
         BO    IFNO                YES, RULE DOES NOT APPLY                     
         B     IFYES               APPLY RULE                                   
*                                                                               
SPR02A   TM    JXOPTS2,JXODTBL     TEST DEMAND TOTAL BILL(OPT3=Y)               
         BNO   IFYES               NOT SET, APPLY RULE                          
         TM    JXBLTYP,PROG        SET BUT NOT VALID FOR PROG                   
         BO    IFYES               YES, RULE DOES NOT APPLY                     
         TM    JXBLTYP,ESTM        SET BUT NOT VALID FOR ESTM                   
         BO    IFYES               YES, RULE DOES NOT APPLY                     
         B     IFNO                APPLY RULE                                   
*                                                                               
*                                                                               
IFRSN01  TM    ERRORS,ERR1          ERROR REASON 1 NOT ON                       
         BNO   IFYES                                                            
         B     IFNO                                                             
*                                                                               
IFERF1H  TM    ERRORS,ERRF1H        ERROF F + (ERROR 1 OR H)                    
         BO    IFYES                                                            
         B     IFNO                                                             
*                                                                               
IFYES    CR    RB,RB                                                            
         BR    RE                                                               
IFNO     LTR   RB,RB                                                            
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* BUILD TABLE OF RETAIL DISTRIBUTORS                                 *          
***********************************************************************         
RTL      NMOD1 0,**RTL,RA                                                       
         XR    RC,RC                                                            
         ICM   RC,7,1(R1)                                                       
         USING LWSD,RC                                                          
*                                                                               
         XR    RF,RF                                                            
         ICM   RF,1,0(R1)                                                       
         SLL   RF,2                                                             
         B     *(RF)                                                            
*                                                                               
         B     RTLINI              INITIALIZE TABLE                             
         B     RTLPRB              POST PREVIOUS PARTICIPANTS                   
         B     RTLALL              ALLOCATE CURRENT CHARGES                     
*                                                                               
RTLINI   BAS   RE,SETLDG           SET LEDGER STATUS & LENGTHS                  
         L     R5,JXARETLB         DISTRIBUTOR TABLE                            
         USING RTLD,R5                                                          
         LR    R0,R5               CLEAR THE RETAIL BLOCK                       
         L     R1,JXLRETLB         LENGTH OF BLOCK                              
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVI   0(R5),X'FF'         END OF TABLE                                 
         ZAP   JXRTLUNT,PZERO                                                   
         TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BNO   *+8                 NO,                                          
         BAS   RE,RTLUNB           INITIALIZE UNBILL ENTRIES                    
*                                                                               
         ICM   R8,15,JXAGOBK                                                    
         USING GOBLOCKD,R8                                                      
         MVC   DKEY,SPACES                                                      
         LA    R3,DKEY                                                          
         USING TRNRECD,R3                                                       
         MVC   TRNKCPY,CPY         BUILD KEY FOR RETAIL LEDGER                  
         MVI   TRNKUNT,C'3'                                                     
         MVC   TRNKLDG,GODIST                                                   
         BRAS  RE,READ                                                          
         DROP  R8                                                               
*                                                                               
RTLINI5  BRAS  RE,RSEQ             GET THE FIRST                                
         CLC   DIR(TRNKACT-TRNKEY),DKEY SAME LEDGER                             
         BE    *+6                                                              
         DC    H'0'                NO RECORDS                                   
         LA    R3,DIR                                                           
         USING TRNRECD,R3                                                       
         CLI   TRNKACT,C'*'        TEST PASSED THE STAR ACCOUNTS                
         BNE   RTLINI7             YES, DOWN TO REGULAR ACCOUNTS                
         L     R6,JXAJOB                                                        
         CLC   TRNKCULC,0(R6)      TEST UNITS BY JOB                            
         BNE   RTLINI5                                                          
         BRAS  RE,GETR                                                          
         BAS   RE,GETSCHM          GET SCHEME ELEMENT                           
         BNE   RTLINI5                                                          
         OI    JXSTAT9,JXS9RJFL    SET JOB FILTERING                            
         B     RTLINI5                                                          
*                                                                               
RTLINI7  BRAS  RE,GETR                                                          
*                                                                               
RTLINI9  L     R3,AIO                                                           
         LA    R1,L'TRNKACT        GET LENGTH OF ACCOUNT                        
         LA    RF,TRNKACT+L'TRNKACT-1                                           
         CLI   0(RF),C' '                                                       
         BH    *+10                                                             
         BCTR  RF,0                                                             
         BCT   R1,*-10                                                          
*                                                                               
         LA    RF,LEDGLVL          GET LEVEL FOR THIS ACCOUNT                   
         SR    R2,R2               R2=LEVEL MINUS 1                             
         CLM   R1,1,0(RF)          ACCOUNT LENGTH VS. LEVEL LENGTH              
         BNH   *+16                                                             
         LA    RF,1(RF)                                                         
         LA    R2,1(R2)                                                         
         B     *-16                                                             
*                                                                               
         NI    JXSTAT9,ALL-(JXS9RALO)                                           
         CLI   0(RF),12            TEST ACCOUNT LEVEL                           
         BNE   *+8                                                              
         OI    JXSTAT9,JXS9RALO    SET LOW LEVEL ACCOUNT FLAG                   
*                                                                               
         CLI   TRNKCULC,C' '       ACCOUNT (ANY LEVEL)                          
         BE    RTLINI11                                                         
         TM    JXSTAT9,JXS9RALO                                                 
         BNO   RTLINI25            CONTRA (HIGH LEVEL)                          
         B     RTLINI13                                                         
*                                                                               
                                                                                
RTLINI11 LR    R1,R2               R1 = LEVEL NUMBER LESS ONE                   
         MHI   R1,LVACCLNQ                                                      
         LA    R1,LVACC(R1)        R1 TO FIRST ACCOUNT                          
         LR    R6,R1                                                            
         LA    R0,4                R0 = NUMBER OF LEVELS TO CLEAR               
         SR    R0,R2                                                            
         MVC   0(LVACCLNQ,R1),SPACES                                            
         LA    R1,LVACCLNQ(R1)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         BAS   RE,GETRCV           GET REC'V AND COST ACCOUNT                   
         TM    JXSTAT9,JXS9RALO    IS THIS ACCOUNT LEVEL ?                      
         BNO   RTLINI25            IF NOT DON'T NEED SCHEME                     
         BAS   RE,NAMADR           GET NAME AND ADDRESS                         
*                                                                               
RTLINI13 L     R3,AIO                                                           
         MVI   ELCODE,FFTELQ       GET COMMISSION RATE                          
         BRAS  RE,GETELN                                                        
RTLINI14 BNE   RTLINI16                                                         
         USING FFTELD,R3                                                        
         CLI   FFTTYPE,FFTTCOMR                                                 
         BE    RTLINI15                                                         
         BRAS  RE,NEXTEL                                                        
         B     RTLINI14                                                         
*                                                                               
RTLINI15 ZAP   RETLCMR,FFTDATA(4)  COMMISSION RATE                              
         L     R3,AIO                                                           
         USING TRNRECD,R3                                                       
         MVC   RETLACT,TRNKCULA     ACCOUNT                                     
*                                                                               
RTLINI16 L     R3,AIO                                                           
         LA    RF,SPACES                                                        
         TM    JXSTAT9,JXS9RJFL    TEST FILTER BY JOB                           
         BNO   *+8                                                              
         L     RF,JXAJOB                                                        
         CLC   TRNKCULC,0(RF)                                                   
         BNE   RTLINI25                                                         
*                                                                               
         TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BNO   RTLINI19            NO,                                          
         L     R5,JXARETLB         YES, FIND ENTRY                              
RTLINI17 CLI   0(R5),EOT           TEST EOT                                     
         BE    RTLINI25            YES, NOT INCLUDED IN UNBILLING               
         CLC   RTLDIS,TRNKCULA     TEST MATCHING RETAILER                       
         BE    RTLINI18                                                         
         LA    R5,RTLLNQ(R5)                                                    
         B     RTLINI17                                                         
*                                                                               
RTLINI18 ZAP   RTLUNT,PZERO        USE OLD UNITS                                
         BAS   RE,GETSCHM          GET SCHEME ELEMENT                           
         BNE   RTLINI20            NOT IN SCHEME                                
         LR    R4,R3                                                            
         USING DSCELD,R4                                                        
         ZAP   RTLUNT,DSCVAL                                                    
         AP    JXRTLUNT,DSCVAL     ADD TO TOTAL UNITS                           
         B     RTLINI20                                                         
*                                                                               
RTLINI19 MVI   RTLSTAT,0                                                        
         ZAP   RTLPCT,PZERO                                                     
         ZAP   RTLUNT,PZERO                                                     
         BAS   RE,GETSCHM          GET SCHEME ELEMENT                           
         BNE   RTLINI25            NOT IN SCHEME                                
         LR    R4,R3                                                            
         USING DSCELD,R4                                                        
         ZAP   RTLPCT,DSCVAL                                                    
         ZAP   RTLUNT,DSCVAL                                                    
         AP    JXRTLUNT,DSCVAL     ADD TO TOTAL UNITS                           
         CP    DSCVAL,PZERO        SKIP ZERO ALLOCATION                         
         BE    *+8                                                              
         OI    RTLSTAT,RTLCURR                                                  
         DROP  R4                                                               
*                                                                               
RTLINI20 L     R3,AIO                                                           
         MVC   RTLDIS,TRNKCULA     SAVE DISTRIBUTOR CODE                        
         MVC   RTLRECV,SPACES      RECEIVABLE                                   
         MVC   RTLCOST,SPACES      COSTING                                      
         MVC   RTLNME,SRTLNME      RETAILER NAME                                
         MVC   RTLADDR,SRTLADDR    RETAILER ADDRESS                             
         ZAP   RTLCMTOT,PZERO      COMMISSION TOTAL AMOUNT FOR RETAIL           
         ZAP   JXRTLCOM,PZERO      COMMISSION TOTAL AMOUNT OVERALL              
         LA    R1,RTLBK                                                         
         LA    R0,RTLBKN                                                        
         ZAP   0(L'RTLBK,R1),PZERO                                              
         LA    R1,L'RTLBK(R1)                                                   
         BCT   R0,*-10                                                          
*                                                                               
         LA    R0,4                                                             
         LA    R6,LVACC            GET RECEIVABLE & COSTING ACCOUNTS            
         USING LVACC,R6                                                         
RTLINI21 CLI   LVARCV,C' '                                                      
         BE    *+10                                                             
         MVC   RTLRECV,LVARCV                                                   
         CLI   LVACST,C' '                                                      
         BE    *+10                                                             
         MVC   RTLCOST,LVACST                                                   
         LA    R6,LVACCLNQ(R6)                                                  
         BCT   R0,RTLINI21                                                      
         DROP  R6                                                               
*                                                                               
         CLC   TRNKCULA,RETLACT    COMMISSION ACCOUNT ?                         
         BNE   RTLINI23            NO,  SKIP                                    
         ZAP   RTLCRATE,RETLCMR    COMMISSION RATE                              
         OI    RTLSTAT,RTLCOMM                                                  
         OI    JXSTAT9,JXS9RSCM    TEST SPECIAL COMM. RATES IN USE              
*                                                                               
RTLINI23 TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BO    RTLINI25                                                         
         LLC   R1,JXRTLNUM         COUNT NUMBER IN TABLE                        
         LA    R1,1(R1)                                                         
         STC   R1,JXRTLNUM                                                      
         LA    R5,RTLLNQ(R5)                                                    
         MVI   0(R5),EOT                                                        
*                                                                               
RTLINI25 BRAS  RE,RSEQ             GET NEXT                                     
         CLC   DIR(TRNKACT-TRNKEY),DKEY SAME LEDGER                             
         BNE   RTLINI27                                                         
         BRAS  RE,GETR                                                          
         B     RTLINI9                                                          
*                                                                               
RTLINI27 CP    JXRTLUNT,PZERO      TEST ANY UNITS                               
         BNP   RTLXIT                                                           
         TM    LEDGSTA,LDGRUPCT    TEST RETAIL UNITS ARE PERCENTS               
         BNO   *+12                                                             
         OI    JXRTLSTA,JXRTLSPC   SCHEME IS PERCENTS                           
         B     RTLINI35                                                         
*                                                                               
         OI    JXRTLSTA,JXRTLSUN   SCHEME IS UNITS                              
         L     R5,JXARETLB         DISTRIBUTOR TABLE                            
         ZAP   DUB,PZERO                                                        
         XR    RE,RE                                                            
*                                                                               
RTLINI29 TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BO    RTLXIT              YES,                                         
         TM    RTLSTAT,RTLCURR     TEST CURRENT ALLOCACTION                     
         BNO   RTLINI31            NO,                                          
         ZAP   PL16,RTLUNT         GET PERCENT FOR EACH DISTRIBUTOR             
         SRP   PL16,7,0            X 10000000                                   
         DP    PL16,JXRTLUNT       DIVIDE BY TOTAL                              
         SRP   PL16(L'PL16-L'JXRTLUNT),64-1,5   % ROUNDED TO 4DP                
         ZAP   RTLPCT,PL16(L'PL16-L'JXRTLUNT)   SAVE %                          
         AP    DUB,RTLPCT                                                       
         LTR   RE,RE                                                            
         BNZ   *+10                                                             
         LR    RE,R5                                                            
         B     RTLINI31                                                         
         CP    RTLUNT,RTLUNT-RTLD(L'RTLUNT,RE)                                  
         BNH   RTLINI31                                                         
         LR    RE,R5               RE=A(RETAILER WITH MOST UNITS)               
*                                                                               
RTLINI31 LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),EOT                                                        
         BNE   RTLINI29                                                         
         SP    DUB,=P'1000000'                                                  
         MP    DUB,=P'-1'                                                       
         LR    R5,RE                                                            
         AP    RTLPCT,DUB          ADD ROUNDING DIFFERENCE TO BIGGEST           
*                                                                               
RTLINI35 TM    JXBLTYP,ESTM        %ESTIMATE                                    
         BNO   RTLINIX                                                          
         TM    JXSTAT9,JXS9RSCM    TEST SPECIAL COMM. RATES IN USE              
         BNO   RTLINIX                                                          
         BAS   RE,RTLRAT           RECALCUTE COMMISSION                         
*                                                                               
RTLINIX  B     RTLXIT                                                           
*                                                                               
         DROP  R3,R5                                                            
         EJECT                                                                  
***********************************************************************         
* SET UNBILL ENTRIES IN RETAIL TABLE                                 *          
***********************************************************************         
RTLUNB   NTR1  ,                                                                
         TM    JXBLTYP,SPCL        TEST SPECIAL BILL                            
         BNO   RTLUNB2             NO,                                          
         LA    RF,JXAALLO          YES, CLEAR TOTAL ACCUMS                      
         LA    R0,JXBKRN                                                        
         ZAP   0(L'JXBK,RF),PZERO                                               
         LA    RF,L'JXBK(RF)                                                    
         BCT   R0,*-10                                                          
*                                                                               
RTLUNB2  XC    DKEY,DKEY                                                        
         LA    R3,DKEY                                                          
         USING TRNRECD,R3                                                       
         L     RF,JXAJOB                                                        
         MVC   TRNKCULA,0(RF)      READ 99 TRANSACTIONS FOR JOB                 
         MVC   TRNKWORK,=C'99'                                                  
         BRAS  RE,HIGH                                                          
         CLC   DIR(TRNKCULC-TRNKEY),DKEY                                        
         BNE   RTLXIT              NONE                                         
*                                                                               
RTLUNB3  LA    R3,DIR                                                           
         CLC   TRNKDATE,ORGBDTE    TEST INVOICE DATE                            
         BNE   RTLUNB15            NO,                                          
         TM    JXSTAT9,JXS9RUNB    TEST FOUND FIRST UNBILL NUMBER               
         BO    RTLUNB5             YES                                          
         CLC   TRNKREF,JXRRNUM     TEST INVOICE NUMBER                          
         BNE   RTLUNB15            NO, SKIP THIS BILL                           
         OI    JXSTAT9,JXS9RUNB    TEST FOUND FIRST UNBILL NUMBER               
         B     RTLUNB7                                                          
*                                                                               
RTLUNB5  CLC   TRNKREF,JXRRNUM     TEST INVOICE NUMBER                          
         BL    RTLUNB15                                                         
*                                                                               
RTLUNB7  L     R5,JXARETLB                                                      
         USING RTLD,R5                                                          
RTLUNB9  CLI   0(R5),EOT           TEST EOT                                     
         BE    RTLUNB11            YES, READ NEXT BILL                          
         CLC   TRNKCULC,RTLDIS     TEST ALREADY IN TABLE                        
         BE    RTLUNB15            THAT'S BAD -  SKIP IT                        
         LA    R5,RTLLNQ(R5)       NEXT TABLE ENTRY                             
         B     RTLUNB9                                                          
*                                                                               
RTLUNB11 BRAS  RE,GETR             GET THE 99 RECORD                            
         L     R3,AIO                                                           
         LA    R4,TRNRFST                                                       
         USING TRNELD,R4                                                        
         CP    TRNRTPCT,PZERO      TEST OLD % ZERO                              
         BE    RTLUNB15            YES, SKIP IT                                 
         MVC   RTLDIS,TRNKCULC     ADD DISTRIBUTOR                              
         MVC   RTLBIL,TRNKREF      SAVE ORIGINAL BILL NUMBER                    
         ZAP   RTLPCT,TRNRTPCT     USE ORIGINAL PERCENT                         
         MVI   RTLSTAT,0                                                        
         OI    RTLSTAT,RTLCURR     SET CURRENT ACTIVITY                         
         ZAP   RTLUNT,PZERO                                                     
*                                                                               
         LA    R1,RTLBK                                                         
         LA    R0,RTLBKN                                                        
         ZAP   0(L'RTLBK,R1),PZERO                                              
         LA    R1,L'RTLBK(R1)                                                   
         BCT   R0,*-10                                                          
*                                                                               
         LLC   R1,JXRTLNUM         COUNT NUMBER IN TABLE                        
         LA    R1,1(R1)                                                         
         STC   R1,JXRTLNUM                                                      
         LA    R5,RTLLNQ(R5)                                                    
         MVI   0(R5),EOT                                                        
*                                                                               
RTLUNB15 BRAS  RE,RSEQ                                                          
         CLC   DIR(TRNKCULC-TRNKEY),DKEY                                        
         BE    RTLUNB3                                                          
*                                   ADD NAME AND ADDRESS                        
         L     R5,JXARETLB                                                      
RTLUNB17 CLI   0(R5),EOT           TEST EOT                                     
         BE    RTLXIT                                                           
         MVC   AIO,AIO3                                                         
         LA    R2,LEDGLVL          READ UNIT 3 ACCOUNTS                         
         MVC   DKEY,SPACES                                                      
*                                                                               
RTLUNB19 LLC   R1,0(R2)                                                         
         LA    R1,2(R1)                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   DKEY(0),RTLDIS                                                   
         BRAS  RE,HIGH                                                          
         BNE   RTLUNB21                                                         
         BRAS  RE,GETR                                                          
         LA    R6,RTLRECV                                                       
         BAS   RE,GETRCV           GET RECEIVABLE & COSTING ACCOUNT             
         BAS   RE,NAMADR           GET NAME AND ADDRESS                         
         MVC   RTLNME,SRTLNME      RETAILER NAME                                
         MVC   RTLADDR,SRTLADDR    RETAILER ADDRESS                             
*                                                                               
RTLUNB21 CLI   0(R2),12                                                         
         BE    RTLUNB23                                                         
         LA    R2,1(R2)            NEXT LEVEL IN HEIRARCHY                      
         B     RTLUNB19                                                         
*                                                                               
RTLUNB23 LA    R5,RTLLNQ(R5)                                                    
         B     RTLUNB17                                                         
         DROP  R3,R4,R5                                                         
*                                                                               
         EJECT                                                                  
***********************************************************************         
* POST PREVIOUS BILLS                                                 *         
***********************************************************************         
RTLPRB   BAS   RE,SETLDG           SET LEDGER STATUS & LENGTHS                  
         TM    JXBLTYP,SPCL        TEST SPECIAL                                 
         BNO   RTLPRB2             NO,                                          
         TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BNO   RTLXIT              NO, SKIP PREVIOUS BILLS                      
*                                                                               
RTLPRB2  L     R3,ADTRNR                                                        
         USING TRNRECD,R3                                                       
         L     R5,JXARETLB                                                      
         USING RTLD,R5                                                          
RTLPRB3  CLI   0(R5),EOT                                                        
         BNE   RTLPRB4             NOT IN TABLE - SKIP IT                       
         TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BO    RTLXIT              YES, DON'T ADD TO TABLE                      
         BAS   RE,RTLADD           ADD OLD RETAILER                             
         B     RTLPRB2                                                          
*                                                                               
RTLPRB4  CLC   TRNKCULC,RTLDIS     MATCH CONTRA TO DISTRIBUTOR TABLE            
         BE    RTLPRB5                                                          
         LA    R5,RTLLNQ(R5)                                                    
         B     RTLPRB3                                                          
*                                                                               
RTLPRB5  TM    JXBLTYP,SPCL        FOR SPECIAL                                  
         BNO   RTLPRB6             ONLY ADD BILLS IN THE RUN                    
         CLC   RTLBIL,TRNKREF                                                   
         BNE   RTLXIT                                                           
*                                                                               
RTLPRB6  L     R2,ADTRNR                                                        
         AH    R2,DATADISP         R2=A(TRNEL)                                  
         LA    R6,RTLPRV           RE=A(BUCKETS)                                
*                                                                               
RTLPRB13 LA    R3,JXTTOT           ADD THIS BILL TO RETAILER BUCKETS            
         LA    R4,RTLPRV                                                        
         BRAS  RE,ADDSET                                                        
*                                                                               
         TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BO    RTLPRB17            YES,                                         
         TM    RTLSTAT,RTLOLD      TEST OLD RETAILER                            
         BNO   RTLXIT              NO                                           
         MVC   RTLCHG,RTLPRV       PREV = CURRENT                               
         MVC   RTLNET,RTLPRV                                                    
         B     RTLXIT                                                           
*                                                                               
RTLPRB17 MVC   RTLCHG,RTLPRV       PREV = CURRENT                               
         MVC   RTLNET,RTLPRV                                                    
         TM    JXBLTYP,SPCL        TEST SPECIAL                                 
         BNO   RTLXIT                                                           
*                                                                               
         LA    R3,JXTTOT           ADD BILL TO OVERALL TOTAL                    
         LA    R4,JXAALLO                                                       
         BRAS  RE,ADDSET                                                        
         B     RTLXIT                                                           
         DROP  R3,R5                                                            
         EJECT                                                                  
***********************************************************************         
* ADD AN OLD RETAILER TO TABLE                                        *         
***********************************************************************         
         USING RTLD,R5                                                          
         USING TRNRECD,R3                                                       
RTLADD   NTR1  ,                                                                
         MVI   RTLLNQ(R5),EOT      MARK NEW EOT                                 
         MVC   RTLDIS,TRNKCULC     SAVE DISTRIBUTOR CODE                        
         MVC   RTLRECV,SPACES      RECEIVABLE                                   
         MVC   RTLCOST,SPACES      COSTING                                      
         ZAP   RTLCMTOT,PZERO      COMMISSION TOTAL AMOUNT                      
         ZAP   RTLPCT,PZERO                                                     
         ZAP   RTLUNT,PZERO                                                     
         MVI   RTLSTAT,0                                                        
         OI    RTLSTAT,RTLCURR+RTLOLD                                           
         LA    R1,RTLBK                                                         
         LA    R0,RTLBKN                                                        
         ZAP   0(L'RTLBK,R1),PZERO                                              
         LA    R1,L'RTLBK(R1)                                                   
         BCT   R0,*-10                                                          
*                                                                               
         LLC   R1,JXRTLNUM         COUNT NUMBER IN TABLE                        
         LA    R1,1(R1)                                                         
         STC   R1,JXRTLNUM                                                      
*                                                                               
         MVC   AIO,AIO3                                                         
         LA    R2,LEDGLVL          READ UNIT 3 ACCOUNTS                         
         MVC   DKEY,SPACES                                                      
*                                                                               
RTLADD3  LLC   R1,0(R2)                                                         
         LA    R1,2(R1)                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   DKEY(0),TRNKCULC                                                 
         BRAS  RE,HIGH                                                          
         BNE   RTLADD5                                                          
         BRAS  RE,GETR                                                          
         LA    R6,RTLRECV                                                       
         BAS   RE,GETRCV           GET RECEIVABLE & COSTING ACCOUNT             
         BAS   RE,NAMADR           GET NAME AND ADDRESS                         
         MVC   RTLNME,SRTLNME      RETAILER NAME                                
         MVC   RTLADDR,SRTLADDR    RETAILER ADDRESS                             
         L     R3,ADTRNR           RESTORE R3                                   
*                                                                               
RTLADD5  CLI   0(R2),12                                                         
         BE    RTLXIT                                                           
         LA    R2,1(R2)            NEXT LEVEL IN HEIRARCHY                      
         B     RTLADD3                                                          
         EJECT                                                                  
***********************************************************************         
* ALLOCATE CHARGES TO PARTICIPANTS                                    *         
***********************************************************************         
RTLALL   TM    JXBLTYP,SPCL        SPECIAL                                      
         BNO   RTLALL11                                                         
         TM    JXRROPT,JXRROUNB    UNBILLING                                    
         BO    RTLXIT              OK TO EXIT                                   
*                                                                               
RTLALL11 TM    JXSTAT9,JXS9RSCM    TEST SPECIAL RATES                           
         BZ    RTLALL15            NO,                                          
         USING JXBKD,R5                                                         
         LA    R5,JXAALLO                                                       
         ZAP   JXBGRS,JXBNET                                                    
         ZAP   JXBCOM,JXRTLCOM     REPLACE TOTAL COMMISSION                     
         AP    JXBGRS,JXBCOM                                                    
*                                                                               
         LA    R5,JXATOT                                                        
         ZAP   JXBGRS,JXBNET                                                    
         ZAP   JXBCOM,JXRTLCOM                                                  
         AP    JXBGRS,JXBCOM                                                    
*                                                                               
RTLALL15 LA    R5,JXAALLO                                                       
         ZAP   CURGST,JXBGST       SAVE CURRENT GST.PST                         
         ZAP   CURPST,JXBPST                                                    
*                                                                               
         TM    JXBLTYP,ESTM        TEST  %ESTIMATE                              
         BZ    RTLALL17                                                         
         LA    R5,JXABILL          REMOVE PREVIOUS GST/PST                      
         SP    CURGST,JXBGST                                                    
         SP    CURPST,JXBPST                                                    
*                                                                               
*                                                                               
RTLALL17 MVC   TOTCHRG,JXAALLO     CURRENT(NET) BILLING                         
         TM    JXBLTYP,TOTL+ONEL   TEST  TOTAL OR 1 LINE                        
         BZ    *+10                                                             
         MVC   TOTCHRG,JXATOT      USE OVERALL TOTAL                            
         MVC   TOTREMN,TOTCHRG     TOTAL REMAINING TO BE DISTRIBUTED            
*                                                                               
         USING RTLD,R5                                                          
         L     R5,JXARETLB                                                      
         CLI   0(R5),EOT                                                        
         BNE   RTLALL23                                                         
         OI    JXSTATA,JXSARTLC    SET ERROR                                    
         J     XIT                                                              
RTLALL23 LA    R3,TOTCHRG          R3=CHARGE TO ALLOCATE                        
         LA    R4,RTLNET           R4=RETAILER BUCKETS                          
         BAS   RE,GETSHR           GET RETAILER SHARE                           
*                                                                               
         USING JXBKD,R4                                                         
         ZAP   DUB,JXBNET                                                       
         LA    R4,RTLPRV                                                        
         SP    DUB,JXBNET                                                       
         LLC   R0,JXRTLBLN                                                      
         CP    DUB,PZERO                                                        
         BE    *+8                                                              
         AHI   R0,1                                                             
         STC   R0,JXRTLBLN         SAVE NUMBER OF BILLS NEEDED                  
*                                                                               
         LA    R4,RTLNET           R4=RETAILER BUCKETS                          
         TM    JXSTAT9,JXS9RSCM    TEST SPECIAL COMM. RATES IN USE              
         BNO   *+10                                                             
         ZAP   JXBCOM,RTLCMTOT     SET TOTAL COMMISSION                         
*                                                                               
         ZAP   JXBGRS,JXBNET       RECALCULATE GROSS                            
         AP    JXBGRS,JXBCOM       GROSS = NET + COM                            
*                                                                               
         MVC   RTLCHG,RTLNET       NET(CURRENT) TO TOTAL                        
*                                                                               
         TM    JXBLTYP,TOTL+ONEL   TEST TOTAL OR 1 LINE                         
         BZ    RTLALL25            NO,                                          
         LA    R4,RTLNET                                                        
         LA    R3,RTLPRV                                                        
         BRAS  RE,SUBSET           SUBTRACT PREVIOUS                            
*                                                                               
RTLALL25 LA    R4,TOTREMN          TOTAL REMAINING                              
         LA    R3,RTLNET           LESS: CHARGES ALLOCATED                      
         TM    JXBLTYP,TOTL+ONEL   TOTAL                                        
         BZ    *+8                 NO,                                          
         LA    R3,RTLCHG           LESS: CHARGES ALLOCATED                      
         BRAS  RE,SUBSET                                                        
*                                                                               
RTLALL26 LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),EOT                                                        
         BNE   RTLALL23                                                         
*                                                                               
         TM    JXSTAT9,JXS9RSCM    TEST SPECIAL RATES IN EFFECT                 
         BO    RTLXIT              YES, CAN'T HAVE REMAINDER                    
         TM    JXRROPT,JXRROUNB    TEST UNBILLING                               
         BO    RTLXIT              YES, USE OLD NUMBERS                         
*                                                                               
*                                  ADD ROUNDING DIFFERENCE TO FIRST             
         L     R5,JXARETLB         DISTRIBUTOR TABLE                            
RTLALL27 CLI   0(R5),EOT                                                        
         BE    RTLXIT                                                           
         TM    RTLSTAT,RTLCURR     TEST CURRENT                                 
         BO    *+12                                                             
         LA    R5,RTLLNQ(R5)                                                    
         B     RTLALL27                                                         
*                                                                               
         LA    R1,ADJLST           ADD OVER/UNDER TO FIRST                      
         LA    R4,RTLNET           R4=RETAILER BUCKETS                          
         LA    R6,TOTREMN                                                       
         SR    RF,RF                                                            
*                                                                               
RTLALL29 ICM   RF,3,0(R1)          RF=DISPLACEMENT TO BUCKET                    
         LA    R2,0(RF,R4)                                                      
         LA    R3,0(RF,R6)                                                      
         AP    0(L'JXBK,R2),0(L'JXBK,R3)                                        
         LA    R1,L'SHRLST(R1)                                                  
         CLI   0(R1),EOT                                                        
         BNE   RTLALL29                                                         
*                                                                               
         LA    R4,RTLNET           R4=RETAILER BUCKETS                          
         USING JXBKD,R4                                                         
         ZAP   JXBGRS,JXBNET       RECALCULATE GROSS (AGAIN)                    
         AP    JXBGRS,JXBCOM       GROSS = NET + COM                            
         MVC   RTLCHG,RTLNET       CHARGES TO NET POSTING                       
         LA    R4,RTLCHG           SHARE OF CHARGES                             
         LA    R3,RTLPRV           ADD: PREVIOUS                                
         TM    JXBLTYP,ESTM        %ESTIMATE                                    
         BO    *+8                 YES, DON'T ADD PREVIOUS                      
         BRAS  RE,ADDSET                                                        
*                                                                               
RTLXIT   XIT1                                                                   
         DROP  R3,R4,R5                                                         
         EJECT                                                                  
***********************************************************************         
* RECALCULATE COMMISSION BY RETAILER FOR % ESTIMATE                  *          
***********************************************************************         
RTLRAT   NTR1  ,                                                                
         ZAP   JXRTLCOM,PZERO      COMMISSION TOTAL AMOUNT OVERALL              
*                                                                               
         L     R2,JXAEWC                                                        
         USING JXEWD,R2                                                         
RTLRAT1  ZAP   JXEWCGRS,JXEWCNET   SET GROSS=NET                                
*                                                                               
         L     R5,JXARETLB         TEST ANY RETAIL DISTRIBUTORS                 
         USING RTLD,R5                                                          
RTLRAT3  ZAP   DUB,JXEWCOMR        DEFAULT RATE                                 
         TM    RTLSTAT,RTLCOMM     TEST SPECIAL RATE FOR THIS DISTRIB.          
         BNO   *+10                                                             
         ZAP   DUB,RTLCRATE        USE SPECIAL RATE                             
*                                                                               
         ZAP   PL16,JXEWCNET                                                    
         MP    PL16,RTLPCT         NET * PCT. (SHARE)                           
         MP    PL16,DUB                                                         
         SRP   PL16,64-12,5                                                     
         AP    JXEWCGRS,PL16       ADD COMMISSION TO GROSS                      
*                                                                               
         AP    RTLCMTOT,PL16       ADD TO TOTAL COMMISSION FOR DIST.            
         AP    JXRTLCOM,PL16       AND TO OVERALL TOTAL                         
*                                                                               
         LA    R5,RTLLNQ(R5)                                                    
         CLI   0(R5),EOT                                                        
         BNE   RTLRAT3                                                          
*                                                                               
         LA    R2,JXEWLNQ(R2)                                                   
         CLI   0(R2),EOT           TEST END IF ESTIMATES                        
         BNE   RTLRAT1                                                          
         J     XIT                                                              
*                                                                               
         DROP  R2,R5                                                            
         EJECT                                                                  
***********************************************************************         
*  GET LEDGER STATUS & LENGTHS                                                  
***********************************************************************         
SETLDG   NTR1  ,                                                                
         ICM   R8,15,JXAGOBK                                                    
         USING GOBLOCKD,R8                                                      
         MVC   DKEY,SPACES                                                      
         LA    R3,DKEY                                                          
         USING TRNRECD,R3                                                       
         MVC   TRNKCPY,CPY         BUILD KEY FOR RETAIL LEDGER                  
         MVI   TRNKUNT,C'3'                                                     
         MVC   TRNKLDG,GODIST                                                   
         BRAS  RE,READ                                                          
         L     R3,AIO3                                                          
         ST    R3,AIO                                                           
         BRAS  RE,GETR             GET LEDGER RECORD                            
         MVI   ELCODE,LDGELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                NO LEDGER ELEMENT                            
         USING LDGELD,R3                                                        
         MVC   LEDGSTA,LDGSTAT     SAVE LEDGER STATUS                           
         L     R3,AIO                                                           
         MVI   ELCODE,ACLELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                 GET HEIRARCHY ELEMENT                        
         DC    H'0'                                                             
         USING ACLELD,R3                                                        
         LA    R1,LEDGLVL          SAVE LEDGER LEVEL LENGTHS                    
         LA    RF,ACLVALS                                                       
         USING ACLVALS,RF                                                       
*                                                                               
SETLDG3  MVC   0(1,R1),ACLVLEN                                                  
         CLI   ACLVLEN,12                                                       
         BE    XIT                                                              
         LA    R1,1(R1)                                                         
         LA    RF,L'ACLVALS(RF)                                                 
         B     SETLDG3                                                          
         DROP  R8,RF,R3                                                         
         EJECT                                                                  
***********************************************************************         
*  GET SHARE OF TOTAL AMOUNT                                                    
***********************************************************************         
         USING RTLD,R5                                                          
GETSHR   NTR1  ,                                                                
         LA    R1,SHRLST           R1=LIST OF BUCKETS                           
GETSHR1  SR    RF,RF                                                            
         ICM   RF,3,0(R1)          RF=DISPLACEMENT TO BUCKET                    
         AR    RF,R3                                                            
         ZAP   PL16,0(L'JXBK,RF)   TOTAL AMOUNT                                 
         MP    PL16,RTLPCT         * PERCENT                                    
         SRP   PL16,64-6,5         ROUNDED                                      
         SR    RF,RF                                                            
         ICM   RF,3,0(R1)          DISPLACEMENT TO                              
         AR    RF,R4                                                            
         ZAP   0(L'JXBK,RF),PL16   SAVE HIS SHARE                               
         LA    R1,L'SHRLST(R1)                                                  
         CLI   0(R1),EOT                                                        
         BNE   GETSHR1                                                          
         J     XIT                                                              
         DROP  R5                                                               
         EJECT                                                                  
***********************************************************************         
* GET DISTRIBUTION FOR SCHEME                                        *          
***********************************************************************         
GETSCHM  LR    R0,RE                                                            
         ICM   R8,15,JXAGOBK                                                    
         USING GOBLOCKD,R8                                                      
         L     R3,AIO                                                           
         MVI   ELCODE,DSCELQ                                                    
         BRAS  RE,GETELN                                                        
GETSCHM3 BE    GETSCHM5                                                         
         LR    RE,R0                                                            
         LTR   RB,RB                                                            
         BR    RE                                                               
*                                                                               
         USING DSCELD,R3                                                        
GETSCHM5 CLC   DSCCODE,GODIST+1    MATCH SCHEME                                 
         BNE   GETSCHM7                                                         
         LR    RE,R0                                                            
         CR    RB,RB                                                            
         BR    RE                                                               
*                                                                               
GETSCHM7 BRAS  RE,NEXTEL                                                        
         B     GETSCHM3                                                         
         DROP  R3,R8                                                            
         EJECT                                                                  
***********************************************************************         
* GET RECEIVABLE AND COSTING CODES                                   *          
***********************************************************************         
         USING LVACC,R6                                                         
GETRCV   LR    R0,RE                                                            
         L     R3,AIO                                                           
         MVI   ELCODE,RBRELQ       GET RETAIL ELEMENT                           
         BRAS  RE,GETELN                                                        
         BNE   GETRCVX                                                          
*                                                                               
         USING RBRELD,R3                                                        
GETRCV3  CLI   RBRRECB,X'40'                                                    
         BNH   GETRCV5                                                          
         MVC   LVARCV(L'ACTKCPY),CPY   SET RECEIVABLE ACCOUNT                   
         MVC   LVARCV+(ACTKULA-ACTKEY)(L'ACTKULA),RBRRECB                       
*                                                                               
GETRCV5  CLI   RBRCOST,X'40'                                                    
         BNH   GETRCVX                                                          
         MVC   LVACST(L'ACTKCPY),CPY   SET COSTING ACCOUNT                      
         MVC   LVACST+(ACTKULA-ACTKEY)(L'ACTKULA),RBRCOST                       
*                                                                               
GETRCVX  LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
         DROP  R3,R6                                                            
         EJECT                                                                  
***********************************************************************         
* ADD NAME AND ADDRESS TO RETAIL ENTRY                               *          
***********************************************************************         
NAMADR   LR    R0,RE                                                            
         MVC   SRTLNME,SPACES                                                   
         MVC   SRTLADDR,SPACES                                                  
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,NAMELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING NAMELD,R3                                                        
         LLC   R1,NAMLN                                                         
         SHI   R1,NAMLN1Q+1                                                     
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SRTLNME(0),NAMEREC                                               
*                                                                               
         L     R3,AIO                                                           
         MVI   ELCODE,ADRELQ                                                    
         BRAS  RE,GETELN                                                        
         BNE   NAMADRX                                                          
*                                                                               
         USING ADRELD,R3                                                        
         LLC   R1,ADRNUM                                                        
         LA    RF,ADRADD1                                                       
         LA    RE,SRTLADDR                                                      
*                                                                               
         MVC   0(L'ADRADD1,RE),0(RF)                                            
         LA    RE,L'ADRADD1(RE)                                                 
         LA    RF,L'ADRADD1(RF)                                                 
         BCT   R1,*-14                                                          
*                                                                               
NAMADRX  LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* CONSTANTS - LITERAL POOL                                           *          
***********************************************************************         
SHRLST   DS    0H                                                               
         DC    AL2(JXBNET-JXBKD)                                                
         DC    AL2(JXBCOM-JXBKD)                                                
         DC    AL2(JXBCSD-JXBKD)                                                
         DC    AL2(JXBSKI-JXBKD)                                                
         DC    AL2(JXBGST-JXBKD)                                                
         DC    AL2(JXBPST-JXBKD)                                                
         DC    AL1(EOT)                                                         
*                                                                               
ADJLST   DS    0H                                                               
         DC    AL2(JXBNET-JXBKD)                                                
         DC    AL2(JXBCSD-JXBKD)                                                
         DC    AL2(JXBSKI-JXBKD)                                                
         DC    AL1(EOT)                                                         
*                                                                               
         LTORG                                                                  
         DROP  RB,RA                                                            
*                                                                               
         EJECT                                                                  
***********************************************************************         
* RERUN / UNBILL -   ACCOUNT FIRST                                    *         
***********************************************************************         
RERN     NMOD1 0,**RRN                                                          
         L     RC,0(R1)                                                         
         USING LWSD,RC                                                          
*                                                                               
         CLI   JXACTN,JXAPACF      ACCOUNT FIRST ?                              
         BNE   RERNT                                                            
         OC    JXRRBDA,JXRRBDA     TEST 99 POSTING ON FILE                      
         BZ    XITY                NO, PROCESS WHAT'S MARKED                    
         MVC   AIO,AIO2                                                         
         MVC   DA,JXRRBDA          RETRIEVE BILL POSTING TO BE RERUN            
         BRAS  RE,GETR                                                          
         L     R3,AIO2                                                          
         MVI   ELCODE,TRNELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TRNELD,R3                                                        
         OC    TRNRTPCT,TRNRTPCT   TEST RETAIL %                                
         BZ    RERNA0                                                           
         CP    TRNRTPCT,PZERO                                                   
         BE    RERNA0                                                           
         OI    JXRROPT,JXRRORTL    SET RETAIL UNBILL                            
*                                                                               
RERNA0   L     RF,ABILLTAB         MATCH NUMBER TO TABLE                        
         CLC   TRNBTYPE,JXBLNUM-JXBLCODE(RF)                                    
         BE    RERNA1                                                           
         LA    RF,L'BILLTAB(RF)                                                 
         CLI   0(RF),0                                                          
         BNE   *-18                                                             
         B     RERNXN                                                           
*                                                                               
RERNA1   MVC   JXRRTYP,0(RF)       SET BILL TYPE                                
         MVC   JXWCFLT,TRNQTFLT    SET WC FILTER                                
         OC    JXWCFLT,SPACES                                                   
*                                                                               
         CLI   JXRRTYP,C'S'        TEST SPECIAL                                 
         JE    RERNA15                                                          
         CLI   JXRRTYP,C'E'        TEST % OF EST.                               
         JNE   XITY                                                             
         LA    R0,8                                                             
         LA    R1,TRNNARR                                                       
         LA    R2,WORK                                                          
         SR    RE,RE               RE=COUNT OF NUMERICS                         
         SR    RF,RF               RF=START OF DP                               
*                                                                               
RERNA3   CLC   0(4,R1),=C'PC E'    PC ESTIMATE CONSTANT                         
         BE    RERNA9                                                           
         CLI   0(R1),C'.'                                                       
         BNE   RERNA5                                                           
         LTR   RF,RF               TEST ALREADY HAVE DP                         
         BZ    *+6                                                              
         DC    H'0'                                                             
         LA    RF,1(R1)                                                         
         B     RERNA7                                                           
*                                                                               
RERNA5   CLI   0(R1),C'0'                                                       
         BNL   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R1),C'9'                                                       
         BNH   *+6                                                              
         DC    H'0'                                                             
         MVC   0(1,R2),0(R1)       GET NUMERICS                                 
         LA    RE,1(RE)                                                         
         LA    R2,1(R2)                                                         
*                                                                               
RERNA7   LA    R1,1(R1)            R1 TO NEXT TRNNARR BYTE                      
         BCT   R0,RERNA3                                                        
         DC    H'0'                                                             
*                                                                               
RERNA9   CR    RF,R1               TEST END AFTER DP(IE 99.PC)                  
         BNE   *+6                                                              
         SR    RF,RF               YES, MAKE IT NO DP'S                         
         LTR   RF,RF               TEST ANY DP'S                                
         BZ    *+8                 BRANCH IF NO DP                              
         SR    R1,RF               R1=NUMBER OF DECIMAL PLACES                  
         LR    RF,R1               RF=NUMBER OF DECIMAL PLACES                  
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         PACK  DUB,WORK(0)         PACK THE NUMBER                              
         CHI   RF,2                ALREADY HAVE 2 DP?                           
         BE    *+18                                                             
         MP    DUB,=P'10'                                                       
         LA    RF,1(RF)                                                         
         B     *-18                                                             
*                                                                               
         ZAP   JXPEST,DUB                                                       
*                                                                               
         L     R3,AIO2                                                          
         MVI   ELCODE,BESELQ       GET ESTIAMTES BY WC                          
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R2,JXAEWC                                                        
*                                                                               
         USING BESELD,R3                                                        
         USING JXEWD,R2                                                         
RERNA11  MVC   JXEWWC,BESWORK      WORKCODE                                     
         ZAP   JXEWCNET,BESPEBC     NET                                         
         ZAP   JXEWCGRS,BESPEBCG    GROSS                                       
         ZAP   JXEWCOMR,PZERO                                                   
         ZAP   JXEWTNET,BESPEBC     NET                                         
         ZAP   JXEWTGRS,BESPEBCG    GROSS                                       
         LA    R2,JXEWLNQ(R2)                                                   
         MVI   0(R2),EOT           TEST ANY ESTIMATES                           
         BRAS  RE,NEXTEL                                                        
         BE    RERNA11                                                          
         J     XITY                                                             
*                                   ** SPECIAL BILL **                          
         USING TRNELD,R3                                                        
RERNA15  ZAP   NET,TRNAMNT                                                      
         ZAP   COM,TRNBLCOM                                                     
         ZAP   GRS,NET                                                          
         AP    GRS,COM                                                          
         J     XITY                                                             
*                                                                               
RERNXN   OI    JXSTAT5,JXS5NUNB   CAN'T UNBILL OR RERUN                         
         J     XITN                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* RERUN A BILLING, RERUN AN UNBILLING OR JUST UNBILL                  *         
***********************************************************************         
RERNT    CLI   JXACTN,JXAPTRN      TRANSACTION                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R3,ADTRNR                                                        
         LR    R2,R3               SAVE A(TRANSACTION)                          
         MVI   ELCODE,TRSELQ                                                    
         BRAS  RE,GETEL            GET STATUS ELEMENT                           
         JNE   XITN                                                             
         USING TRSELD,R3                                                        
         CLC   TRSDATE,JXRRADT     TEST DATE ADDED TO FILE                      
         BH    XITN                SKIP ITEMS ADDED AFTER RERUN DATE            
*                                                                               
         L     R3,ADTRNR                                                        
         USING TRNRECD,R3                                                       
         CLC   TRNKWORK,JXBILLQ    IS THIS PREVIOUS BILLING?                    
         BE    RRUNT60             YES                                          
         DROP  R3                                                               
*                                                                               
         USING PTAELD,R3                                                        
RRUNT00  MVI   ELCODE,PTAELQ                                                    
         BRAS  RE,GETEL            GET PTAEL                                    
         BNE   XITN                                                             
         CLI   PTATYPE,PTATRAL     IS THIS BILLING?                             
         BNE   RRUNT00             NO, GET NEXT                                 
*                                                                               
         TM    JXRROPT,JXRRORRB+JXRROUNB  RERUN AN UNBILLING?                   
         BO    RRUNT42                    YES                                   
         TM    JXRROPT,JXRRORRB           NO, RERUN A BILLING?                  
         BO    RRUNT20                    YES                                   
*                                                                               
***********************************************************************         
* JUST UNBILL                                                         *         
***********************************************************************         
*                                                                               
         TM    JXBLTYP,TOTL+ONEL   NO, BILLTYPE TOTAL OR 1-LINE                 
         BZ    RRUNT12             NO                                           
*                                                                               
         USING TRNRECD,R2                                                       
         CLC   TRNRECD+ACCOUSED(ACCOULEN),JXRRADT                               
         BNE   RRUNT06                                                          
         B     *+12                                                             
*                                                                               
RRUNT02  BRAS  RE,NEXTEL                                                        
         BNE   XITN                TRANSACTION NOT IN RERUN                     
         CLI   PTATYPE,PTATRAL     IS THIS BILLING?                             
         BNE   RRUNT02             NO, SKIP                                     
         TM    PTASTAT1,PTASPEND   YES, IS IT STILL PENDING?                    
         BO    RRUNT02             YES, SKIP                                    
         TM    PTASTAT1,PTASREVS   NO, IS THIS A REVERSAL?                      
         BO    RRUNT02             YES, SKIP                                    
         TM    PTASTAT1,PTASREVU   NO, HAS THIS ALREADY BEEN REVERSED?          
         BO    RRUNT02             YES,SKIP                                     
         CLC   PTADATE,JXRRADT     NO, DOES BILL DATE MATCH?                    
         BH    RRUNT02             NO, SKIP                                     
         BL    XITY                                                             
         CLC   PTARBLNO,JXRRBILL   NO, DOES BILL NUMBER MATCH?                  
         BH    RRUNT02             NO, SKIP                                     
         B     XITY                                                             
*                                                                               
RRUNT04  MVI   ELCODE,PTAELQ                                                    
         BRAS  RE,NEXTEL           GET PTAEL                                    
         BNE   XITN                                                             
*                                                                               
RRUNT06  CLI   PTATYPE,PTATRAL     IS THIS BILLING?                             
         BNE   RRUNT04             NO, SKIP                                     
         TM    PTASTAT1,PTASPEND   YES, IS IT STILL PENDING?                    
         BO    RRUNT04             YES, SKIP                                    
*                                                                               
         USING TRNRECD,R2                                                       
         OC    TRNRECD+ACCOUSED(ACCOULEN),TRNRECD+ACCOUSED                      
         BZ    *+14                                                             
         CLC   TRNRECD+ACCOUSED(ACCOULEN),JXRRADT                               
         BL    RRUNT08                                                          
         TM    PTASTAT1,PTASREVU   NO, HAS THIS ALREADY BEEN REVERSED?          
         BZ    RRUNT04             NO                                           
         CLC   PTARDATE,JXRRADT                                                 
         BNL   RRUNT04             NO, SKIP                                     
         CLC   PTARUNBD,JXRRADT    SAME DAY - CHECK NUMBER                      
         BNH   RRUNT04             BILLED LATER                                 
         B     XITY                MUST ALSO BE ON RERUN                        
*                                                                               
RRUNT08  TM    PTASTAT1,PTASREVU                                                
         BO    RRUNT04                                                          
         TM    PTASTAT1,PTASREVS                                                
         BO    RRUNT04                                                          
         CLC   PTARDATE,TRNRECD+ACCOUSED                                        
         BNE   RRUNT04                                                          
         B     XITY                                                             
*                                                                               
RRUNT10  BRAS  RE,NEXTEL                                                        
         BNE   XITN                TRANSACTION NOT IN RERUN                     
         USING PTAELD,R3                                                        
         CLI   PTATYPE,PTATRAL     TEST BILLING ELEMENT                         
         BNE   RRUNT10                                                          
*                                                                               
RRUNT12  TM    JXBLTYP,PROG+ALLO   TEST PROGRESSIVE OR ALLOCATED                
         BZ    XITN                                                             
         CLC   JXRRBILL,PTARBLNO   TEST BILL NUMBER & DATE                      
         BNE   RRUNT10                                                          
         TM    PTASTAT1,PTASPEND   YES, IS THIS 77 PENDING?                     
         BO    RRUNT10             YES, SKIP IT                                 
         TM    PTASTAT1,PTASREVS   NO, IS IT A REVERSAL?                        
         BNO   XITY                                                             
         TM    PTASTAT1,PTASREVU   IS THIS A REVERSAL UPDATED?                  
         BO    RRUNT10             YES, GET NEXT                                
         CLI   JXBLCODE,JXBLTOTL   IS BILLTYPE TOTAL?                           
         BNE   RRUNT10             NO, GET NEXT                                 
         CLC   PTARDATE,JXRRDT2    BILLED PRIOR TO THIS BILL?                   
         BH    RRUNT10             NO, GET NEXT                                 
         B     XITY                YES, INCLUDE IN RERUN                        
*                                                                               
***********************************************************************         
* RERUN A BILLING                                                     *         
***********************************************************************         
*                                                                               
RRUNT20  TM    JXBLTYP,TOTL+ONEL   NO, BILLTYPE TOTAL OR 1-LINE                 
         BZ    RRUNT22             NO                                           
*                                                                               
         CLC   PTADATE,JXRRADT     TEST ACTIVITY VS DATE OF BILLING             
         BH    RRUNT24             ADDED LATER                                  
         BL    XITY                ADDED BEFORE - INCLUDE                       
         CLC   PTARBLNO,JXRRBILL   SAME DAY - CHECK NUMBER                      
         BH    RRUNT24             BILLED LATER                                 
         B     XITY                INCLUDE                                      
*                                                                               
RRUNT22  TM    JXBLTYP,PROG+ALLO   TEST PROGRESSIVE OR ALLOCATED                
         BZ    XITN                                                             
         CLC   JXRRBILL,PTARBLNO   TEST BILL NUMBER & DATE                      
         BE    XITY                INCLUDE                                      
*                                                                               
RRUNT24  BRAS  RE,NEXTEL                                                        
         BNE   XITN                TRANSACTION NOT IN RERUN                     
         USING PTAELD,R3                                                        
         CLI   PTATYPE,PTATRAL     TEST BILLING ELEMENT                         
         BNE   RRUNT24                                                          
         B     RRUNT20                                                          
*                                                                               
***********************************************************************         
* RERUN AN UNBILLING                                                  *         
***********************************************************************         
*                                                                               
RRUNT40  BRAS  RE,NEXTEL                                                        
         BNE   XITN                                                             
         CLI   PTATYPE,PTATRAL     IS THIS A BILLING ELEMENT?                   
         BNE   RRUNT40                                                          
*                                                                               
RRUNT42  TM    PTASTAT1,PTASPEND   PENDING?                                     
         BO    RRUNT40             YES, GET NEXT                                
         TM    PTASTAT1,PTASREVS   THIS A REVERSAL?                             
         BZ    RRUNT44             NO                                           
         CLC   PTARORGD,JXRRDT2    YES, ORIGINAL BILL DATE MATCH?               
         BNE   RRUNT40             NO, GET NEXT                                 
         CLC   PTARORGB,JXRRNUM    YES, ORIGINAL BILL NUMBER MATCH?             
         BNE   RRUNT40             NO, GET NEXT                                 
         CLC   PTARDATE,JXRRDT2    DOES BILLING ACTIVITY DATE MATCH?            
         BNE   RRUNT40             NO                                           
         B     XITY                YES, INCLUDE IN RERUN                        
*                                                                               
RRUNT44  TM    PTASTAT1,PTASREVU   IS THIS A REVERSAL UPDATED?                  
         BO    RRUNT40             YES, GET NEXT                                
         CLI   JXBLCODE,JXBLTOTL   IS BILLTYPE TOTAL?                           
         BNE   RRUNT40             NO, GET NEXT                                 
         CLC   PTARDATE,JXRRDT2    BILLED PRIOR TO THIS BILL?                   
         BH    RRUNT40             NO, GET NEXT                                 
         B     XITY                YES, INCLUDE IN RERUN                        
*                                                                               
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* RERUN / UNBILL -   PREVIOUS BILL - WC=99                            *         
***********************************************************************         
         USING TRNRECD,R3                                                       
RRUNT60  MVI   ELCODE,TRNELQ                                                    
         BRAS  RE,GETEL            GET TRNEL                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         USING TRNELD,R3                                                        
         CLC   TRN2DAY,JXRRADT     TEST  RERUN DATE                             
         BE    RRUNT62                                                          
         BH    XITN                YES, SKIP IT                                 
         B     XITY                                                             
*                                                                               
RRUNT62  CLC   TRNREF,JXRRNUM      TEST BILL NUMBER                             
         BE    XITY                YES,                                         
         TM    JXSTAT1,JXS1DIST    TEST RETAIL BILL                             
         BO    XITY                YES, INCLUDE ALL RETAIL                      
         CLC   TRNREF,JXRRNUM                                                   
         BH    XITN                                                             
         B     XITY                                                             
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* OTHER  ROUTINES                                                    *          
***********************************************************************         
         USING JXBKD,RF                                                         
POSTIT   AP    JXBNET,NET          POST AMOUNTS TO LOW ACCUM ENTRY              
         AP    JXBCOM,COM                                                       
         AP    JXBGRS,GRS                                                       
         AP    JXBCSD,CSD                                                       
         AP    JXBHRS,HRS                                                       
         BR    RE                                                               
         DROP  RF                                                               
*                                                                               
SUBSET   STM   RE,R7,SVREG         SUBTRACT SET A (R3) FROM B (R4)              
         LA    R0,JXBKRN                                                        
         SP    0(L'JXBK,R4),0(L'JXBK,R3)                                        
         LA    R3,L'JXBK(R3)                                                    
         LA    R4,L'JXBK(R4)                                                    
         JCT   R0,*-14                                                          
         J     LMX                                                              
*                                                                               
ADDSET   STM   RE,R7,SVREG         ADD SET A (R3) TO B (R4)                     
         LA    R0,JXBKRN                                                        
         AP    0(L'JXBK,R4),0(L'JXBK,R3)                                        
         LA    R3,L'JXBK(R3)                                                    
         LA    R4,L'JXBK(R4)                                                    
         JCT   R0,*-14                                                          
         J     LMX                                                              
*                                                                               
LMX      LM    RE,R7,SVREG                                                      
         BR    RE                                                               
*                                                                               
         EJECT                                                                  
***********************************************************************         
* GET AND CHECK ALL POSTING ACCOUNTS                                 *          
***********************************************************************         
ACCK     NMOD1 0,*ACCK                                                          
         L     RC,0(R1)                                                         
         USING LWSD,RC                                                          
         ICM   R8,15,JXAGOBK                                                    
         USING GOBLOCKD,R8                                                      
         L     R7,GOAEXT                                                        
         USING GOXBLKD,R7                                                       
*                                                                               
         MVC   DKEY,SPACES                                                      
         LA    R2,DKEY             GET MEDIA RECORD                             
         USING PMDRECD,R2                                                       
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CPY                                                      
         MVC   PMDKMED,JXMED                                                    
         BRAS  RE,READ                                                          
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         L     R3,AIO                                                           
         MVI   ELCODE,PMDELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         USING PMDELD,R3                                                        
         XC    SVPMDEL,SVPMDEL                                                  
         LLC   R1,PMDLN                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   SVPMDEL(0),PMDEL    SAVE MEDIA ELEMENT                           
*                                                                               
         MVC   JXPASI,PMDCOM1      SET SI ACCOUNT                               
         CLI   GOTBC,C' '                                                       
         BNH   *+10                                                             
         MVC   JXPASI,GOTBC                                                     
         GOTO1 BALCK,JXPASI                                                     
         BNE   ACCKX                                                            
         BRAS  RE,GETR             GET SI ACCOUNT                               
         L     R3,AIO                                                           
         MVC   WORK,SPACES                                                      
         USING SPAELD,R3                                                        
         MVI   ELCODE,SPAELQ       GET SPECIAL POSTING ELEMENT                  
         BRAS  RE,GETELN                                                        
         B     *+8                                                              
         BRAS  RE,NEXTEL                                                        
         BNE   ACCK2                                                            
         CLI   SPATYPE,SPATANAL    LOOK FOR ANALYSIS POINTER                    
         BNE   *-12                                                             
         MVC   WORK(L'SPAAULA-2),SPAAULA                                        
*                                                                               
ACCK2    LA    R3,SVPMDEL                                                       
         USING PMDELD,R3                                                        
         MVC   DKEY,SPACES                                                      
         LA    R2,DKEY             GET REVENUE (12) ACCOUNT                     
         USING ACTRECD,R2                                                       
         MVC   ACTKCPY,CPY                                                      
         MVC   ACTKUNT(3),=C'123'  SET DEFAULT                                  
         CLI   PMDANAL,C' '        ANY OVERRIDE ?                               
         BNH   *+10                                                             
         MVC   ACTKACT(L'PMDANAL),PMDANAL                                       
         CLI   PMDLN,PMDLN2Q       IS THIS A NEW ELEMENT ?                      
         BL    *+18                NO                                           
         CLI   PMDCOST,C' '        ANY COST ANALYSIS ACCOUNT ?                  
         BNH   *+10                                                             
         MVC   ACTKACT,PMDCOST                                                  
         CLI   WORK,C' '           TEST OVERRIDE FROM SI                        
         BNH   *+10                                                             
         MVC   ACTKACT,WORK                                                     
         MVC   JXPA12,DKEY                                                      
         GOTO1 BALCK,JXPA12                                                     
         BNE   ACCKX                                                            
         MVC   JXPA11,JXPA12                                                    
         MVI   JXPA11+2,C'1'                                                    
         GOTO1 BALCK,JXPA11                                                     
         BNE   ACCKX                                                            
*                                                                               
         MVC   DKEY,SPACES                                                      
         LA    R2,DKEY             GET CLIENT RECORD                            
         USING ACTRECD,R2                                                       
         MVC   ACTKEY(JXCLILQ),JXJOBK                                           
         BRAS  RE,READ                                                          
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         L     R3,AIO                                                           
         MVI   ELCODE,PPRELQ                                                    
         BRAS  RE,GETELN                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         USING PPRELD,R3                                                        
         MVC   JXPASR,PPRRECV      SET SR ACCOUNT                               
         GOTO1 BALCK,JXPASR                                                     
         BNE   ACCKX                                                            
         MVC   JXPA1C,PPRCOST      SET 1C ACCOUNT                               
         GOTO1 BALCK,JXPASR                                                     
         BNE   ACCKX                                                            
*                                                                               
         MVC   DKEY,SPACES                                                      
         LA    R2,DKEY             GET PRODUCT RECORD                           
         USING ACTRECD,R2                                                       
         MVC   ACTKEY(JXPROLQ),JXJOBK                                           
         BRAS  RE,READ                                                          
         MVC   AIO,AIO3                                                         
         BRAS  RE,GETR                                                          
         L     R3,AIO                                                           
         MVI   ELCODE,PPRELQ                                                    
         BRAS  RE,GETELN                                                        
         BNE   ACCK5                                                            
         USING PPRELD,R3                                                        
         CLI   PPRRECV,0                                                        
         BE    ACCK3                                                            
         MVC   JXPASR,PPRRECV      SET SR ACCOUNT                               
         GOTO1 BALCK,JXPASR                                                     
         BNE   ACCKX                                                            
ACCK3    CLI   PPRCOST,0                                                        
         BE    ACCK5                                                            
         MVC   JXPA1C,PPRCOST      SET 1C ACCOUNT                               
         GOTO1 BALCK,JXPASR                                                     
         BNE   ACCKX                                                            
*                                                                               
ACCK5    CLI   JXPASK1,0                                                        
         BNH   ACCK7                                                            
         LA    R1,JXPASK1                                                       
         BAS   RE,ACCSK            CHECK SK                                     
         BNE   ACCKX                                                            
*                                                                               
ACCK7    CLI   JXPASK2,0                                                        
         BNH   ACCK9                                                            
         LA    R1,JXPASK2                                                       
         BAS   RE,ACCSK            CHECK SK                                     
         BNE   ACCKX                                                            
*                                                                               
ACCK9    DS    0H                                                               
         CLI   GOINCCR,C' '        TEST CREDIT INCOME ACCOUNT                   
         BNH   ACCK15                                                           
         MVC   JXPASII,GOINCCR                                                  
         GOTO1 BALCK,JXPASII                                                    
         BNE   ACCKX                                                            
         BRAS  RE,GETR             GET SI ACCOUNT                               
         L     R3,AIO                                                           
         MVC   WORK,SPACES                                                      
         USING SPAELD,R3                                                        
         MVI   ELCODE,SPAELQ       GET SPECIAL POSTING ELEMENT                  
         BRAS  RE,GETELN                                                        
         B     *+8                                                              
         BRAS  RE,NEXTEL                                                        
         BNE   ACCK10                                                           
         CLI   SPATYPE,SPATANAL    LOOK FOR ANALYSIS POINTER                    
         BNE   *-12                                                             
         MVC   WORK(L'SPAAULA-2),SPAAULA                                        
*                                                                               
ACCK10   MVC   DKEY,SPACES                                                      
         LA    R2,DKEY             GET REVENUE (12) ACCOUNT                     
         USING ACTRECD,R2                                                       
         MVC   ACTKCPY,CPY                                                      
         MVC   ACTKUNT(3),=C'123'  SET DEFAULT                                  
         CLI   WORK,C' '                                                        
         BNH   *+10                                                             
         MVC   ACTKACT,WORK                                                     
         MVC   JXPA12I,DKEY                                                     
         GOTO1 BALCK,JXPA12I                                                    
         BNE   ACCKX                                                            
*                                                                               
ACCK15   DS    0H                                                               
ACCKX    CLI   BALCKERR,0                                                       
         JE    XIT                                                              
         MVC   JXPAERR,DKEY        SET ACCOUNT ERROR                            
         LHI   R0,AE$ACTNF         'ACCOUNT NOT FOUND'                          
         CLI   BALCKERR,1                                                       
         BE    *+8                                                              
         LHI   R0,AE$INACP         'INVALID ACCOUNT FOR POSTING'                
         STCM  R0,3,JXERRS                                                      
         CLI   BALCKERR,0                                                       
         J     XIT                                                              
***********************************************************************         
* CHECK SK ACCOUNT                                                   *          
***********************************************************************         
ACCSK    NTR1  ,                                                                
         MVC   WORK(L'JXPASK1),0(R1)                                            
         MVI   WORK+2,C'I'        SWITCH TO SI ACCOUNT                          
         GOTOR BALCK,WORK                                                       
         BNE   ACCKX                                                            
         BRAS  RE,GETR                                                          
         MVC   DKEY,SPACES         SET UP TO READ 11                            
         LA    R2,DKEY                                                          
         USING ACTRECD,R2                                                       
         MVC   ACTKCPY,CPY                                                      
         MVC   ACTKUNT(2),=C'11'                                                
         L     R3,AIO                                                           
         MVI   ELCODE,RSTELQ                                                    
         BRAS  RE,GETELN                                                        
         BNE   *+10                                                             
         USING RSTELD,R3                                                        
         MVC   ACTKACT(L'RSTCOSTG),RSTCOSTG  ANALYSIS CODE                      
         L     R3,AIO                                                           
         MVI   ELCODE,SPAELQ                                                    
         BRAS  RE,GETELN                                                        
         B     *+8                                                              
         BRAS  RE,NEXTEL                                                        
         BNE   ACCSK3                                                           
         USING SPAELD,R3                                                        
         CLI   SPATYPE,SPATANAL                                                 
         BNE   *-12                                                             
         MVC   ACTKACT,SPAAANAL                                                 
*                                                                               
ACCSK3   MVC   WORK(L'ACTKCULA),ACTKEY                                          
         CLC   ACTKACT,SPACES                                                   
         BH    *+10                                                             
         MVC   WORK(L'JXPA11),JXPA11                                            
         GOTOR BALCK,WORK                                                       
         BNE   ACCKX                                                            
         MVC   ACTKUNT(2),=C'12'                                                
         MVC   WORK(L'ACTKCULA),ACTKEY                                          
         CLC   ACTKACT,SPACES                                                   
         BH    *+10                                                             
         MVC   WORK(L'JXPA12),JXPA12                                            
         GOTOR BALCK,WORK                                                       
         B     ACCKX                                                            
***********************************************************************         
* READ ACCOUNT -  TEST FOR BALANCE ELEMENT - SET RETURN CODE         *          
***********************************************************************         
BALCK    NTR1  ,                                                                
         MVC   DKEY,SPACES                                                      
         MVC   DKEY(L'ACTKCULA),0(R1)                                           
         BRAS  RE,HIGH                                                          
         LA    R2,DIR                                                           
         USING ACTRECD,R2                                                       
         CLC   ACTKEY,DKEY                                                      
         BNE   BALCKX1                                                          
         TM    ACTKSTAT,ACTSABLP                                                
         BNO   BALCKX2                                                          
         MVI   BALCKERR,0                                                       
         B     BALCKXX                                                          
*                                                                               
BALCKX1  MVI   BALCKERR,1          ACCOUNT NOT FOUND                            
         B     BALCKXX                                                          
BALCKX2  MVI   BALCKERR,2          NOT VALID FOR POSTING                        
         B     BALCKXX                                                          
*                                                                               
BALCKXX  CLI   BALCKERR,0                                                       
         XIT1                                                                   
         LTORG                                                                  
         DROP  RB,R7,R8                                                         
         EJECT                                                                  
***********************************************************************         
* DATAMGR ROUTINES                                                   *          
***********************************************************************         
READ     LR    R0,RE                                                            
         GOTO1 DATAMGR,DMCB,DMREAD,ACCDIR,DKEY,DIR                              
         CLI   8(R1),0                                                          
         JE    *+6                                                              
         DC    H'0'                CAN'T READ ACCOUNT                           
         MVC   DA,DIR+(ACCKDA-ACCRECD)                                          
         TM    JXOPTS,JXOPTIO       TRACE IO'S ?                                
         JNO   *+8                                                              
         BRAS  RE,DMTRCE                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
HIGH     LR    R0,RE                                                            
         GOTO1 DATAMGR,DMCB,DMRDHI,ACCDIR,DKEY,DIR                              
         MVC   DA,DIR+(ACCKDA-ACCRECD)                                          
         TM    JXOPTS,JXOPTIO       TRACE IO'S ?                                
         JNO   *+8                                                              
         BRAS  RE,DMTRCE                                                        
         LR    RE,R0                                                            
         CLC   DKEY,DIR                                                         
         BR    RE                                                               
*                                                                               
RSEQ     LR    R0,RE                                                            
         GOTO1 DATAMGR,DMCB,DMRSEQ,ACCDIR,DKEY,DIR                              
         CLI   8(R1),0                                                          
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   DA,DIR+(ACCKDA-ACCRECD)                                          
         TM    JXOPTS,JXOPTIO       TRACE IO'S ?                                
         JNO   *+8                                                              
         BRAS  RE,DMTRCE                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
GETR     LR    R0,RE                                                            
         GOTO1 DATAMGR,DMCB,GETREC,ACCMST,DA,AIO,DMWORK                         
         CLI   8(R1),0                                                          
         JE    *+6                                                              
         DC    H'0'                                                             
         TM    JXOPTS,JXOPTIO       TRACE IO'S ?                                
         JNO   *+8                                                              
         BRAS  RE,DMTRCE                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
DMTRCE   NTR1  BASE=*                                                           
         MVC   DMBLK,SPACES                                                     
         L     R2,0(R1)                                                         
         MVC   DMBPGM,DMJOBW                                                    
         MVC   DMBCOM,0(R2)        COMMAND                                      
         L     R2,4(R1)                                                         
         MVC   DMBFIL,0(R2)        FILE                                         
         MVC   DMBDMCW,DMCOUNTW    DMCOUNT=00                                   
         L     RF,JXAACMST         A(MONACC)                                    
         L     RF,ACMDMCNT-ACMD(RF)                                             
         ICM   R0,15,0(RF)                                                      
         EDIT  (R0),DMBDMC,ALIGN=LEFT                                           
         L     R2,12(R1)           R2=A(IO)                                     
         MVC   DMBIOW,DMSTIOW      START IO=                                    
         L     RF,JXADDMST         A(ADMASTC)                                   
         ICM   R0,15,MCACTIOS-MASTD(RF)                                         
         EDIT  (R0),DMBIO,ALIGN=LEFT                                            
         MVC   DMCB+20(4),MCVPRINT-MASTD(RF)                                    
         MVI   DMCB+20,C'P'                                                     
         GOTO1 JXAPRNTB,DMCB,(L'DMBLK,DMBLK),(R2),C'DUMP',42,=C'2D'             
         J     XIT                                                              
*                                                                               
DMJOBW   DC    C'JOBLOT'                                                        
DMCOUNTW DC    C'DMCOUNT='                                                      
DMSTIOW  DC    C'START IO='                                                     
*                                                                               
         LTORG                                                                  
         DROP  RB                                                               
*                                                                               
         EJECT                                                                  
         GETEL R3,DATADISP,ELCODE                                               
GETELN   AH    R3,NEWDISP                                                       
         J     FIRSTEL                                                          
*                                                                               
XITY     CR    RB,RB                                                            
         J     *+6                                                              
XITN     LTR   RB,RB                                                            
XIT      XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* EXCEPTION RULES TABLE - USE XCPD                                    *         
***********************************************************************         
*                                                                               
XCPTAB   DS    0X                                                               
*                                                                               
XCPT1    DS    0X              CAN'T BILL DUE TO OVERSPENDING ESTIMATE          
         DC    AL2(XCPT1X-*+3)                                                  
         DC    AL2(AE$OVRES)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(0)                                                           
         DC    AL1(SPCL+ESTM)                                                   
         DC    AL1(XCPISET1+XCPINREV)                                           
         DC    AL1(JXS3ESRQ),AL2(JXSTAT3-JXD)                                   
         DC    AL1(JXS6NZRO),AL2(JXSTAT6-JXD)                                   
         DC    AL1(JXS6NGTE),AL2(JXSTAT6-JXD)                                   
XCPT1X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT2    DS    0X             CAN'T BILL DUE TO BALANCE BELOW MINIMUM           
         DC    AL2(XCPT2X-*+3)                                                  
         DC    AL2(AE$BELOW)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(PROG)                                                        
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(0),AL2(SPR02-XRUL)                                           
         DC    AL1(JXS6ULTM),AL2(JXSTAT6-JXD)                                   
XCPT2X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT2A   DS    0X             CAN'T BILL DUE TO BALANCE BELOW MINIMUM           
         DC    AL2(XCPT2AX-*+3)                                                 
         DC    AL2(AE$BELOW)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ESTM)                                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0),AL2(SPR02-XRUL)                                           
         DC    AL1(JXS6PLTM),AL2(JXSTAT6-JXD)                                   
XCPT2AX  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT3    DS    0X               WARNING - JOB INACTIVE FOR 6 MONTHS             
         DC    AL2(XCPT3X-*+3)                                                  
         DC    AL2(AI$JNACT)                                                    
         DC    AL1(XCPTSWA),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS6NACT),AL2(JXSTAT6-JXD)                                   
XCPT3X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT4    DS    0X              WARNING - ACTUALS EXCEED PCT OF ESTIMATE         
         DC    AL2(XCPT4X-*+3)                                                  
         DC    AL2(AI$AXEST)                                                    
         DC    AL1(XCPTSWA),AL1(XCPTACL)                                        
         DC    AL1(ESTM)                                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS6GTPE),AL2(JXSTAT6-JXD)                                   
XCPT4X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT5    DS    0X              JOB HAS UNBILLABLE BILL TYPE                     
         DC    AL2(XCPT5X-*+3)                                                  
         DC    AL2(AE$UNBTY)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS6UNBT),AL2(JXSTAT6-JXD)                                   
         DC    AL1(JXS7NGTZ),AL2(JXSTAT7-JXD)                                   
XCPT5X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT5A   DS    0X              JOB HAS UNBILLABLE BILL TYPE                     
         DC    AL2(XCPT5AX-*+3)                                                 
         DC    AL2(AE$UNBTY)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(NOTB)                                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS6UNBT),AL2(JXSTAT6-JXD)                                   
XCPT5AX  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT6    DS    0X              JOB DOES NOT HAVE AN ESTIMATE                    
         DC    AL2(XCPT6X-*+3)                                                  
         DC    AL2(AE$NOEST)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL-(SPCL+ESTM))                                             
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(JXS3ESRQ),AL2(JXSTAT3-JXD)                                   
         DC    AL1(JXS7EEQZ),AL2(JXSTAT7-JXD)                                   
XCPT6X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT6A   DS    0X              JOB DOES NOT HAVE AN ESTIMATE                    
         DC    AL2(XCPT6AX-*+3)                                                 
         DC    AL2(AE$NOEST)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ESTM)                                                        
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(JXS7EEQZ),AL2(JXSTAT7-JXD)                                   
XCPT6AX  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT7    DS    0X            CAN'T BILL - NO EST.,CHARGES OR BILLING            
         DC    AL2(XCPT7X-*+3)                                                  
         DC    AL2(AE$NOECB)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(0),AL2(SPR35-XRUL)                                           
         DC    AL1(JXS7EABZ),AL2(JXSTAT7-JXD)                                   
XCPT7X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT8    DS    0X             WARNING - JOB IS PAST CLOSING DATE                
         DC    AL2(XCPT8X-*+3)                                                  
         DC    AL2(AI$PCLSD)                                                    
         DC    AL1(XCPTSWA),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1((XCPT8X-*)/L'XCCNDL)                                         
         DC    AL1(JXS7CLSD),AL2(JXSTAT7-JXD)                                   
XCPT8X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT9    DS    0X             CLIENT OR RETAIL CONFLICT                         
         DC    AL2(XCPT9X-*+3)                                                  
         DC    AL2(AE$CORCT)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(00)                                                          
         DC    AL1(XCPINREV)                                                    
         DC    AL1(JXSARTLC),AL2(JXSTATA-JXD)                                   
         DC    AL3(XCORQ)                                                       
         DC    AL1(JXS1CLB),AL2(JXSTAT1-JXD)                                    
XCPT9X   DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT10   DS    0X            CAN'T BILL - JOB HAS UNAPPROVED ESTIMATE           
         DC    AL2(XCPT10X-*+3)                                                 
         DC    AL2(AE$UNAPE)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS3UNEW+JXS3NTOB),AL2(JXSTAT3-JXD)                          
         DC    AL3(XCORQ)                                                       
         DC    AL1(JXS3ESRQ+JXS3UOLD),AL2(JXSTAT3-JXD)                          
XCPT10X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT11   DS    0X              JOB BALANCE GREATER THAN ''NNN''                 
         DC    AL2(XCPT11X-*+3)                                                 
         DC    AL2(AI$BALGT)                                                    
         DC    AL1(XCPTSWA),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS7BGTB),AL2(JXSTAT7-JXD)                                   
XCPT11X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT12   DS    0X             WARNING-CHARGES+ORDERS EXCEED ESTIMATE            
         DC    AL2(XCPT12X-*+3)                                                 
         DC    AL2(AI$CAOXE)                                                    
         DC    AL1(XCPTSWA),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS7OGTE),AL2(JXSTAT7-JXD)                                   
         DC    AL1(JXS6NZRO),AL2(JXSTAT6-JXD)                                   
         DC    AL1(0),AL2(IFRSN01-XRUL)                                         
XCPT12X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT13   DS    0X                WARNING - JOB HAS HELD INVOICES                
         DC    AL2(XCPT13X-*+3)                                                 
         DC    AL2(AI$JHHI)                                                     
         DC    AL1(XCPTSWA),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS1HELD),AL2(JXSTAT1-JXD)                                   
XCPT13X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT14   DS    0X             CAN'T BILL - MISSING USER FIELD                   
         DC    AL2(XCPT14X-*+3)                                                 
         DC    AL2(AE$NOUSR)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS1MUSR),AL2(JXSTAT1-JXD)                                   
XCPT14X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT15   DS    0X            WARNING-ADDITIONAL R'S AWAITING APPROVAL           
         DC    AL2(XCPT15X-*+3)                                                 
         DC    AL2(AI$ARAA)                                                     
         DC    AL1(XCPTSWA),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(XCPISETF)                                                    
         DC    AL1(JXS1UNAR),AL2(JXSTAT1-JXD)                                   
         DC    AL1(JXS3NTOB),AL2(JXSTAT3-JXD)                                   
XCPT15X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT16   DS    0X             CAN'T BILL - BILLING SELECT SET TO NO             
         DC    AL2(XCPT16X-*+3)                                                 
         DC    AL2(AE$SELCN)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)            ALL BILL TYPES                               
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS2BLSN),AL2(JXSTAT2-JXD)                                   
XCPT16X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT17   DS    0X            CAN'T BILL - OVER ESTIMATE MAX AMOUNT              
         DC    AL2(XCPT17X-*+3)                                                 
         DC    AL2(AE$OVRMX)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(XCPISETH)                                                    
         DC    AL1(JXS3ESRQ),AL2(JXSTAT3-JXD)                                   
         DC    AL1(JXS8OVMX),AL2(JXSTAT8-JXD)                                   
         DC    AL1(JXS7NGTZ),AL2(JXSTAT7-JXD)                                   
XCPT17X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT18   DS    0X             WARNING - OVER ESTIMATE MAX PCT-GROSS             
         DC    AL2(XCPT18X-*+3)                                                 
         DC    AL2(AI$OEMPG)                                                    
         DC    AL1(XCPTSWA),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS8GRPO),AL2(JXSTAT8-JXD)                                   
XCPT18X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT19   DS    0X            CAN'T BILL-LINKED STUDIO JOB, INVALID BT           
         DC    AL2(XCPT19X-*+3)                                                 
         DC    AL2(AE$LSJBT)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ESTM+SPCL)                                                   
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS2LKAG),AL2(JXSTAT2-JXD)                                   
         DC    AL1(JXS2STUD),AL2(JXSTAT2-JXD)                                   
XCPT19X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT20   DS    0X             CAN'T BILL - STUDIO JOB IS MISSING LINK           
         DC    AL2(XCPT20X-*+3)                                                 
         DC    AL2(AE$SJMLK)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(0)                                                           
         DC    AL1(ALLO)                                                        
         DC    AL1(0)                                                           
         DC    AL1(JXS2MISL),AL2(JXSTAT2-JXD)                                   
XCPT20X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT21   DS    0X            CAN'T BILL RETAIL FOR STUDIO JOB WITH LINK         
         DC    AL2(XCPT21X-*+3)                                                 
         DC    AL2(AE$RSJWL)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS2LKAG),AL2(JXSTAT2-JXD)                                   
         DC    AL1(JXS2STUD),AL2(JXSTAT2-JXD)                                   
         DC    AL1(JXS1DIST),AL2(JXSTAT1-JXD)                                   
XCPT21X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT22   DS    0X             MISSING ACCOUNTS FOR ADMIN. SURCHARGE             
         DC    AL2(XCPT22X-*+3)                                                 
         DC    AL2(AE$NASPA)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALLO)                                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXASPNAC),AL2(JXASPIND-JXD)                                  
XCPT22X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT23   DS    0X             MISSING WORKCODE FOR ADMIN. SURCHARGE             
         DC    AL2(XCPT23X-*+3)                                                 
         DC    AL2(AE$NASPW)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALLO)                                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXASPNWC),AL2(JXASPIND-JXD)                                  
XCPT23X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT24   DS    0X            ACTUALS EXCEED MAX CE, ADDIT'L R'S NEEDED          
         DC    AL2(XCPT24X-*+3)                                                 
         DC    AL2(AE$AEXCE)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS8NLTH),AL2(JXSTAT8-JXD)                                   
         DC    AL1(0),AL2(IFERF1H-XRUL)                                         
XCPT24X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT25   DS    0X             %EST. BILL - BILLED 100% OR % IS ZER0             
         DC    AL2(XCPT25X-*+3)                                                 
         DC    AL2(AE$PCTEZ)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ESTM)                                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0),AL2(SPR25-XRUL)                                           
         DC    AL1(JXS8PCTZ),AL2(JXSTAT8-JXD)                                   
         DC    AL3(XCORQ)                                                       
         DC    AL1(JXS8P100),AL2(JXSTAT8-JXD)                                   
XCPT25X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT26   DS    0X                    JOB IS CLOSED                              
         DC    AL2(XCPT26X-*+3)                                                 
         DC    AL2(AE$JCLSD)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS4CLSD),AL2(JXSTAT4-JXD)                                   
XCPT26X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT27   DS    0X              JOB IS AN X-JOB                                  
         DC    AL2(XCPT27X-*+3)                                                 
         DC    AL2(AE$XJOB)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS4XJOB),AL2(JXSTAT4-JXD)                                   
XCPT27X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT28   DS    0X              %ESTIMATE IS EQUAL PREVIOUS BILLS                
         DC    AL2(XCPT28X-*+3)                                                 
         DC    AL2(AE$ESTPB)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ESTM)                                                        
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(0),AL2(SPR28-XRUL)                                           
         DC    AL1(JXS8ESFB),AL2(JXSTAT8-JXD)                                   
XCPT28X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT29   DS    0X            JOB ALREADY BILLED TODAY                           
         DC    AL2(XCPT29X-*+3)                                                 
         DC    AL2(AE$JABT)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS8BLDD),AL2(JXSTAT8-JXD)                                   
XCPT29X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT30   DS    0X            MISSING CYCLE RECORDS                              
         DC    AL2(XCPT30X-*+3)                                                 
         DC    AL2(AE$MCYC)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS5NCYC),AL2(JXSTAT5-JXD)                                   
XCPT30X  DC    AL3(XCENDQ)                                                      
                                                                                
XCPT31   DS    0X                 CYCLE OUT OF SEQUENCE                         
         DC    AL2(XCPT31X-*+3)                                                 
         DC    AL2(AE$CBOS)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS5CYCS),AL2(JXSTAT5-JXD)  CYCLE SEQUENCE ERROR             
XCPT31X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT32   DS    0X                 NOT 'AUTO' BILL TYPE                          
         DC    AL2(XCPT32X-*+3)                                                 
         DC    AL2(AE$NABT)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS5NAUT),AL2(JXSTAT5-JXD)                                   
XCPT32X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT33   DS    0X             MISSING DISTRIBUTOR PERCENTS                      
         DC    AL2(XCPT33X-*+3)                                                 
         DC    AL2(AE$MDP)                                                      
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(JXS1DIST),AL2(JXSTAT1-JXD)                                   
         DC    AL1(JXS2NRTL),AL2(JXSTAT2-JXD)                                   
XCPT33X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT34   DS    0X              DISTRIBUTION UNITS NOT EQUAL 100.00%             
         DC    AL2(XCPT34X-*+3)                                                 
         DC    AL2(AE$DNEQ)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(JXS1DIST),AL2(JXSTAT1-JXD)                                   
         DC    AL1(JXS2RNEQ),AL2(JXSTAT2-JXD)                                   
XCPT34X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT35   DS    0X                JOB HAS NO UNBILLED CHARGES                    
         DC    AL2(XCPT35X-*+3)                                                 
         DC    AL2(AE$JHNUC)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(TOTL+PROG+ONEL)                                              
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(0),AL2(SPR35-XRUL)                                           
         DC    AL1(JXS4FULB),AL2(JXSTAT4-JXD)                                   
XCPT35X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT35A  DS    0X                JOB HAS NO UNBILLED CHARGES                    
         DC    AL2(XCPT35AX-*+3)                                                
         DC    AL2(AE$JHNUC)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(TOTL+PROG+ONEL)                                              
         DC    AL1(0)                                                           
         DC    AL1(XCPINREV)                                                    
         DC    AL1(0),AL2(SPR35-XRUL)                                           
         DC    AL1(JXS4BZRO),AL2(JXSTAT4-JXD)                                   
XCPT35AX DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT36   DS    0X            INVALID BILL TYPE FOR JOB WITH STUDIO LINK         
         DC    AL2(XCPT36X-*+3)                                                 
         DC    AL2(AE$ITFSL)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ESTM+SPCL+ALLO)                                              
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS2LKAG),AL2(JXSTAT2-JXD)                                   
XCPT36X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT37   DS    0X              JOB IS NOT FUNDED                                
         DC    AL2(XCPT37X-*+3)                                                 
         DC    AL2(AE$JINF)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS5NFND),AL2(JXSTAT5-JXD)                                   
XCPT37X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT38   DS    0X               MISSING AUTHORIZATION RECORD                    
         DC    AL2(XCPT38X-*+3)                                                 
         DC    AL2(AE$MAR)                                                      
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS5MAUR),AL2(JXSTAT5-JXD)                                   
XCPT38X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT39   DS    0X                     CAN'T UNBILL OR RERUN                     
         DC    AL2(XCPT39X-*+3)                                                 
         DC    AL2(AE$NUNB)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXS5NUNB),AL2(JXSTAT5-JXD)                                   
XCPT39X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT40   DS    0X              MISSING ACCOUNT FOR POB                          
         DC    AL2(XCPT40X-*+3)                                                 
         DC    AL2(AE$MAFP)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(TOTL+PROG+ONEL)                                              
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXPBSMAC),AL2(JXPBSTA-JXD)                                   
XCPT40X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT41   DS    0X               MISSING WORKCODE FOR POB                        
         DC    AL2(XCPT41X-*+3)                                                 
         DC    AL2(AE$MWFP)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(TOTL+PROG+ONEL)                                              
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXPBSMWC),AL2(JXPBSTA-JXD)                                   
XCPT41X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT42   DS    0X                  MUST BE PROG OR % EST FOR WC'S               
         DC    AL2(XCPT42X-*+3)                                                 
         DC    AL2(AE$MPOE)                                                     
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(0)                                                           
         DC    AL1(PROG+ESTM)                                                   
         DC    AL1(0)                                                           
         DC    AL1(JXS8TWCF),AL2(JXSTAT8-JXD)                                   
XCPT42X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT43   DS    0X                     DATE OR BILL NUMBER INCORRECT             
         DC    AL2(XCPT43X-*+3)                                                 
         DC    AL2(AE$DOBNI)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSBNUNB),AL2(JXSTATB-JXD)                                   
XCPT43X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT44   DS    0X               MISSING INTERNAL INC/DR ACCOUNT                 
         DC    AL2(XCPT44X-*+3)                                                 
         DC    AL2(AE$MIIDA)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSANINC),AL2(JXSTATA-JXD)                                   
XCPT44X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT45   DS    0X               NO ACTIVITY FOR REQUESTED PERIOD                
         DC    AL2(XCPT45X-*+3)                                                 
         DC    AL2(AE$NAFRP)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(ALL)                                                         
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSANACT),AL2(JXSTATA-JXD)                                   
XCPT45X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT46   DS    0X               CAN'T BILL - PROGRSSIVE INTERNAL INC.           
         DC    AL2(XCPT46X-*+3)                                                 
         DC    AL2(AE$B7ELS)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(PROG)                                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSAB7EL),AL2(JXSTATA-JXD)                                   
XCPT46X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT47   DS    0X                     CAN'T UNBIL - MUST REVERSE SEQ            
         DC    AL2(XCPT47X-*+3)                                                 
         DC    AL2(AE$MRSEQ)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSBMRSQ),AL2(JXSTATB-JXD)                                   
XCPT47X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT48   DS    0X                     CAN'T UNBIL - BILL IS REVERSAL            
         DC    AL2(XCPT48X-*+3)                                                 
         DC    AL2(AE$BISAR)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSBBISR),AL2(JXSTATB-JXD)                                   
XCPT48X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT49   DS    0X                     CAN'T UNBIL - ALREADY REVERSED            
         DC    AL2(XCPT49X-*+3)                                                 
         DC    AL2(AE$BALRR)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSBBALR),AL2(JXSTATB-JXD)                                   
XCPT49X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT50   DS    0X                     JOB HAS SK INCOME - MUST BE T/%           
         DC    AL2(XCPT50X-*+3)                                                 
         DC    AL2(AE$JHSKI)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACL)                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSASKIN),AL2(JXSTATA-JXD)                                   
XCPT50X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT51   DS    0X                     JOB HAS MEDIA TRANSFER WORKCODES          
         DC    AL2(XCPT51X-*+3)                                                 
         DC    AL2(AE$JHMWC)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(ESTM)                                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSAMTWC),AL2(JXSTATA-JXD)                                   
XCPT51X  DC    AL3(XCENDQ)                                                      
*                                                                               
XCPT52   DS    0X                     BILLTYPE MUST BE TOTAL                    
         DC    AL2(XCPT52X-*+3)                                                 
         DC    AL2(AE$TYTOT)                                                    
         DC    AL1(XCPTSEX),AL1(XCPTACF)                                        
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(0)                                                           
         DC    AL1(JXSBILTY),AL2(JXSTAT7-JXD)                                   
XCPT52X  DC    AL3(XCENDQ)                                                      
*                                                                               
         DC    AL1(EOT)                                                         
         EJECT                                                                  
***********************************************************************         
* DSECT FOR LOCAL WORKING STORAGE                                     *         
***********************************************************************         
LWSD     DSECT                                                                  
RELO     DS    A                                                                
ACOLIST  DS    A          COLIST                                                
ACOLTAB  DS    A          COLTAB                                                
AOPVTAB  DS    A          OPVTAB                                                
*                                                                               
ADXCP    DS    A          XCPTAB                                                
*                                                                               
DATAMGR  DS    A                                                                
DATCON   DS    A                                                                
ADDAY    DS    A                                                                
GETTXT   DS    A                                                                
COMFACS  DS    A                                                                
GETOPT   DS    A                                                                
JOBBER   DS    A                                                                
JOBCOL   DS    A                                                                
AIO      DS    A                                                                
*                                                                               
COMMANDS DS    0CL(DMCMDLNQ)                                                    
DMKEY    DS    CL8                                                              
ACCDIR   DS    CL8                                                              
ACCMST   DS    CL8                                                              
DMREAD   DS    CL8                                                              
DMRDHI   DS    CL8                                                              
DMRSEQ   DS    CL8                                                              
GETREC   DS    CL8                                                              
*                                                                               
AIO1     DS    A                                                                
AIO2     DS    A                                                                
AIO3     DS    A                                                                
*                                                                               
DUB      DS    D                                                                
DUB2     DS    D                                                                
FULL     DS    F                                                                
DMCB     DS    8F                                                               
WORK     DS    CL80                                                             
HALF     DS    H                                                                
DATADISP DS    H                                                                
NEWDISP  DS    H                                                                
BYTE     DS    XL1                                                              
SPACES   DS    CL80                                                             
BINZ     DS    XL15                                                             
PZERO    DS    PL6                                                              
*                                                                               
PL13     DS    PL13                                                             
PL16     DS    PL16                                                             
MODE     DS    XL1                                                              
ACCFRST  EQU   XCPTACF                                                          
ACCLAST  EQU   XCPTACL                                                          
*                                                                               
ERRORS   DS    XL1                                                              
ERRF     EQU   X'80'               ERROR F + (1 OR H)                           
ERR1     EQU   X'40'                     1                                      
ERRH     EQU   X'40'                     H                                      
ERRF1H   EQU   X'C0'                                                            
*                                                                               
BALCKERR DS    XL1                 BALANCE CHECK ERROR                          
*                                                                               
CPY      DS    XL1                 COMPANY CODE                                 
MOS      DS    XL2                                                              
WCODE    DS    CL2                 WORKCODE                                     
WCFTYP   DS    XL1                 WC FILTER TYPE                               
CYCPER   DS    F                   % FROM CYCLE RECORD                          
*                                                                               
LBK      DS    0PL6                                                             
NET      DS    PL(L'LBK)                                                        
COM      DS    PL(L'LBK)                                                        
GRS      DS    PL(L'LBK)                                                        
CSD      DS    PL(L'LBK)                                                        
HRS      DS    PL(L'LBK)                                                        
COMR     DS    PL(L'LBK)                                                        
SKINC    DS    PL(L'LBK)                                                        
LBKN     EQU   (*-LBK)/L'LBK                                                    
*                                                                               
ELCODE   DS    XL1                                                              
*                                                                               
ESACBL   DS    PL(L'JXBK)          ESTIMATE + ACTUAL + BILLING                  
*                                                                               
SVREG    DS    10F                                                              
*                                                                               
SVRE     DS    F                                                                
SVRF     DS    F                                                                
SVR0     DS    F                                                                
SVR1     DS    F                                                                
SVR2     DS    F                                                                
SVR3     DS    F                                                                
SVR4     DS    F                                                                
SVR5     DS    F                                                                
SVR6     DS    F                                                                
SVR7     DS    F                                                                
*                                                                               
SVBTYP   DS    X                   BILLTYPE FROM CHKUNB                         
*                                                                               
WCEL     DS    XL(WCOLNQ)          WORKCODE ELEMENT                             
*                                                                               
ADTRNR   DS    A                   A(TRANSACTION)                               
ABILLTAB DS    A                   A(BILLTAB)                                   
APTARRL  DS    A                   A(PTAEL BEING RERUN/UNBILLED)                
*                                                                               
DKEY     DS    XL42                                                             
DIR      DS    XL60                                                             
DA       DS    F                                                                
DMWORK   DS    XL96                                                             
SVDIR    DS    XL42                                                             
*                                                                               
ALKEY    DS    A                   A(LAST KEY)                                  
LKEY     DS    XL(L'ACCKEY)                                                     
ATKEY    DS    A                   A(TRANSACTION KEY)                           
TKEY     DS    XL(L'ACCKEY)                                                     
*                                                                               
LVACC    DS    0X                                                               
LVARCV   DS    CL(L'ACTKCULA)      LEVEL A RECEIVABLE                           
LVACST   DS    CL(L'ACTKCULA)      LEVEL A COSTING                              
LVACCLNQ EQU   *-LVACC                                                          
LVBRCV   DS    CL(L'ACTKCULA)                                                   
LVBCST   DS    CL(L'ACTKCULA)                                                   
LVCRCV   DS    CL(L'ACTKCULA)                                                   
LVCCST   DS    CL(L'ACTKCULA)                                                   
LVDRCV   DS    CL(L'ACTKCULA)                                                   
LVDCST   DS    CL(L'ACTKCULA)                                                   
LEDGSTA  DS    XL1                 LEDGER STATUS                                
LEDGLVL  DS    XL4                 LEDGER LEVEL LENGTHS                         
*                                                                               
RTLINIQ  EQU   1                   INITIALIZE RETAIL TABLE                      
RTLPRBQ  EQU   2                   ADD PREVIOUS BILLS TO TABLE                  
RTLALLQ  EQU   3                   ALLOCATE BILLABLE CHARGES                    
RTLUNBQ  EQU   4                   ADD AN UNBILLING ENTRY                       
*                                                                               
RETLCMR  DS    PL6                 COMMISSION RATE                              
RETLACT  DS    CL(L'ACTKCULA)      ACCOUNT TO WHICH RATE APPLIES                
TOTCHRG  DS    XL(JXBKRLQ)         TOTAL CHARGES FOR DISTRIBUTION               
TOTREMN  DS    XL(JXBKRLQ)         TOTAL REMAINING                              
CURGST   DS    PL6                                                              
CURPST   DS    PL6                                                              
ORGBDTE  DS    XL3                 ORIGINAL BILL DATE                           
ORGBTYP  DS    X                   ORIGINAL BILL TYPE                           
BILLADTE DS    XL2                 ORIGINAL BILL ACTIVITY DATE                  
LASTADTE DS    XL2                 LAST BILL ACTIVITY DATE                      
LASTBILN DS    CL6                 LAST BILL NUMBER                             
*                                                                               
SRTLNME  DS    CL(L'RTLNME)                                                     
SRTLADDR DS    CL(L'RTLADDR)                                                    
*                                                                               
SVPMDEL  DS    XL(PMDLN1Q)                                                      
*                                                                               
DMBLK    DS    0CL(DMBLKX-DMBPGM)                                               
DMBPGM   DS    CL(L'DMJOBW)         PROGRAM                                     
         DS    CL1                                                              
DMBCOM   DS    CL8                  COMMAND                                     
         DS    CL1                                                              
DMBFIL   DS    CL8                  FILE                                        
         DS    CL1                                                              
DMBDMCW  DS    CL(L'DMCOUNTW)       DMCOUNT=                                    
DMBDMC   DS    CL7                  000                                         
         DS    CL1                                                              
DMBIOW   DS    CL(L'DMSTIOW)        START IO=                                   
DMBIO    DS    CL7                  000                                         
DMBLKX   EQU   *                                                                
       ++INCLUDE ACJOBBLOCK                                                     
*                                                                               
IOLNQ    EQU   2048                                                             
IO1      DS    XL(IOLNQ)                                                        
IO2      DS    XL(IOLNQ)                                                        
IO3      DS    XL(IOLNQ)                                                        
                                                                                
COLISTL  EQU   100                                                              
COLIST   DS    (COLISTL)X                                                       
*                                                                               
COLTABL  EQU   500                                                              
COLTAB   DS    (COLTABL)X                                                       
*                                                                               
OPVTABL  EQU   500                                                              
OPVTAB   DS    (OPVTABL)X                                                       
*                                                                               
LWSLNQ   EQU   *-LWSD                                                           
                                                                                
         EJECT                                                                  
JXD      DSECT                                                                  
       ++INCLUDE ACJAXD                                                         
         EJECT                                                                  
***********************************************************************         
* DSECT TO COVER JOBBER  COLUMNS                                      *         
***********************************************************************         
JBCD     DSECT                                                                  
JBCCE    DS    PL6                 CURRENT ESTIMATE                             
JBCCEG   DS    PL6                 CURRENT ESTIMATE - GROSS                     
JBCHR    DS    PL6                 HIGHEST REVISED                              
JBCHRG   DS    PL6                 HIGHEST REVISED  - GROSS                     
JBCCOMR  DS    PL6                 COMMISSION RATE                              
         EJECT                                                                  
***********************************************************************         
* DSECT TO COVER THE EXCEPTION REASON TABLE                           *         
***********************************************************************         
                                                                                
XCPD     DSECT ,                   EXCEPTION TABLE                              
XCPLEN   DS    AL2                 LENGTH OF ENTRY                              
XCPERRN  DS    AL2                 ERROR/WARNING NUMBER                         
XCPTSTA  DS    XL1                 STATUS                                       
XCPTSEX  EQU   X'80'                EXCEPTION(CAN'T BILL)                       
XCPTSWA  EQU   X'40'                WARNING                                     
XCPTLEV  DS    XL1                 LEVEL AT WHICH IT CAN BE TESTED              
XCPTACF  EQU   1                   CAN BE TESTED AT ACCFRST OR ACCLAST          
XCPTACL  EQU   0                   CAN BE TESTED AT ACCLAST - ONLY              
XCPTBIN  DS    XL1                 BILL TYPES TO INCLUDE                        
XCPTBEX  DS    XL1                 BILL TYPES TO EXCLUDE                        
XCPINDS  DS    XL1                 INDICATORS                                   
XCPISET1 EQU   X'80'                SET ERROR 1                                 
XCPISETF EQU   X'40'                SET ERROR F                                 
XCPISETH EQU   X'20'                SET ERROR H                                 
XCPINREV EQU   X'10'                SKIP RULE TEST FOR REVERSE BILL             
*                                                                               
XCCNDL   DS    XL3                 CONDITION TESTS                              
         ORG   XCCNDL                                                           
XCCBITS  DS    AL1                 BITS TO TEST                                 
*                                   0 INDICATES FOLLOWING IS ROUTINE            
XCCDSP   DS    AL2                 DISP. TO STATUS BYTE OR ROUTINE              
*                                                                               
XCENDQ   EQU   0                   END OF ENTRY                                 
XCORQ    EQU   1                   OR                                           
                                                                                
         EJECT                                                                  
         PRINT ON                                                               
* ACDDEQUS                                                                      
         PRINT OFF                                                              
       ++INCLUDE ACDDEQUS                                                       
         PRINT ON                                                               
* ACGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACGENFILE                                                      
         PRINT ON                                                               
* ACMASTD                                                                       
         PRINT OFF                                                              
       ++INCLUDE ACMASTD                                                        
         PRINT ON                                                               
* ACQD                                                                          
         PRINT OFF                                                              
       ++INCLUDE ACQD                                                           
         PRINT ON                                                               
GOBLOCKD DSECT                                                                  
* ACGOBLOCK                                                                     
*        PRINT OFF                                                              
       ++INCLUDE ACGOBLOCK                                                      
GOXBLKD  DSECT                                                                  
       ++INCLUDE ACGOXBLOCK                                                     
         PRINT ON                                                               
* ACJOBBERD                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACJOBBERD                                                      
         PRINT ON                                                               
* ACMSGEQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACMSGEQUS                                                      
         PRINT ON                                                               
* COMFACSD                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDCOMFACSD                                                     
         PRINT ON                                                               
* DDCOREQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDCOREQUS                                                      
         PRINT ON                                                               
* DDMASTD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDMASTD                                                        
         PRINT ON                                                               
* FAGETTXTD                                                                     
         PRINT OFF                                                              
       ++INCLUDE FAGETTXTD                                                      
         PRINT ON                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'049ACJAX     10/13/16'                                      
         END                                                                    
