*          DATA SET REREPRG03T AT LEVEL 108 AS OF 05/01/02                      
*CATALP RERG03                                                                  
         TITLE 'RERG03 - REREPRG03 - REP REPORT GENERATOR/OUTPUT PHASE'         
*                                                                               
*******************************************************************             
*                                                                 *             
*       REREPRG03 --- REP REPORT GENERATOR/OUTPUT PHASE           *             
*                                                                 *             
*        INPUT PARAMETERS: 0(R1) = A(WORKING STORAGE)             *             
*                          4(R1) = A(MASTER CONTROL)              *             
*                                                                 *             
*                                                                 *             
*                                                                 *             
* --------------------------------------------------------------- *             
* UPDATE HISTORY:                                                 *             
*                                                                 *             
* -----/-- (---) --- HISTORY LOST                                 *             
*                                                                 *             
* OCT10/89 (MRR) --- FIX MISSING LOGOS ON GROUP REPORTS DUE TO    *             
*                     2 LETTER (IN LIEU OF 3) SIGN-ON ID'S        *             
*                                                                 *             
* FEB22/90 (MRR) --- FORCE NO FOOTLINE PROCESSING FOR REPORTS     *             
*                     THAT DON'T PRINT                            *             
*                                                                 *             
* SEP04/90 (MRR) --- PASS PRINT LINE DEFINITION WITH PRINT LINE   *             
*                     FOR DOWNLOADING.  BY-PASS END LOGO LINES    *             
*                     WHEN DOWNLOADING.                           *             
*                                                                 *             
* JAN09/90 (BU ) --- ADD COMPANY TO REPORT STRUCTURE              *             
*                                                                 *             
* APR22/91 (BU ) --- CHANGE 'BNM' INSTRUCTION TO 'BP' BECAUSE OF  *             
*                    LAST MONTH IN YEAR BREAK BEING PLACED IN     *             
*                    'PRIOR' BUCKET.  (POST3 ROUTINE)             *             
*                                                                 *             
* JUL26/91 (BU ) --- ADD TEST FOR 'PRIOR YEAR' BUCKETS IN POST    *             
*                    TO CORRECT DROPPING OF PRIOR YEAR FIGURES    *             
*                    (POST3 ROUTINE)                              *             
*                                                                 *             
* AUG13/91 (BU ) --- CHANGE DSECT REREPQWKD TO DROP MONTH TABLE   *             
*                    FOR CHANGES TO VALUEMON                      *             
*                                                                 *             
* AUG23/91 (BU ) --- IMPLEMENT OPTIONAL LINE SPACING              *             
*                                                                 *             
* OCT09/91 (BU ) --- CHANGES FOR NEW SPACEND HANDLING BEGUN WITH  *             
*                    LEVEL 41:  USE OF COVAIL AND I/O SAVINGS     *             
*                                                                 *             
* NOV11/91 (BU ) --- FIX PRINT OF '*ALL*' LINE FOR MARKET TOTAL   *             
*                                                                 *             
*                                                                 *             
* MAR12/92 (BU ) --- ACTIVATE NEW 'PENDING' FACILITIES            *             
*                    REREPRGEQU --> REREPRGEQA (NOT IN THIS MOD)  *             
*                    REREPQWKD2 --> REREPQWKD3                    *             
*                                                                 *             
* MAY26/92 (BU ) --- STAGGER OPTION ACTIVATION                    *             
*                                                                 *             
* MAY29/92 (BU ) --- MAXIMUM NUMBER OF ROWS PERMITTED = 16        *             
*                    REREPQWKD4 REPLACES REREPQWKD3               *             
*                                                                 *             
* SEP10/92 (BU ) --- TEMPORARILY REMOVE #ROWS PERMITTED = 16      *             
*                    REREPQWKD3 REPLACES REREPQWKD4               *             
*                                                                 *             
* SEP18/92 (BU/TS) - CORRECT USE OF DESTINATION ID                *             
*                                                                 *             
* DEC21/92 (BU ) --- FIX COMBO PRINT:  **ALL** TOTALS HAVE BEEN   *             
*                    DOUBLE-INCLUDING COMBO AND MARKET TOTALS     *             
*                                                                 *             
* DEC28/92 (BU ) --- SUPPRESS 'QUARTER TOTALS' ON ACCOUNTING      *             
*                    REPORTS.  FIX CALCULATION OF COMMISSIONS.    *             
*                                                                 *             
* JAN11/93 (BU ) --- ADDITIONAL DOWNLOAD FORMAT ADJUSTMENTS PER   *             
*                    GD/KH.                                       *             
*                                                                 *             
* FEB19/93 (BU ) --- FOR STAGGERED-FORMAT REPORTS, SUPPRESS OPT-  *             
*                    IONAL SPACING BETWEEN 1ST/STAGGERED LINES.   *             
*                                                                 *             
* MAR08/92 (BU ) --- TURN OFF 'TOTAL INDICATOR' (*) IN            *             
*                    ROUTINE 'FPRT1080'                           *             
*                                                                 *             
* MAR10/92 (BU ) --- DOWNLOAD:  DON'T SEND 'CODE' IF NOT ASKED FOR*             
*                    IN ROUTINE 'CFIR0170'                        *             
*                                                                 *             
*                                                                 *             
* MAR18/93 (BU ) --- DOWNLOAD:  DON'T TREAT ACCOUNTING/STANDARD   *             
*                    REPORTS DIFFERENTLY.  FORMAT SAME WAY.       *             
*                                                                 *             
* APR01/93 (BU ) --- DOWNLOAD:  CHANGE HEADINGS TO PRINT DETAILS  *             
*                                                                 *             
* APR12/93 (BU ) --- ADD 'RMS' COMPANY.                           *             
*                                                                 *             
* MAY06/93 (BU ) --- SUPPRESS 'EXTRAPL' DURING DOWNLOAD RUN       *             
*                                                                 *             
* MAY12/93 (BU ) --- ADD PENDING ACTIVITY DATE DISPLAY            *             
*                                                                 *             
* JUL21/93 (BU ) --- STANDARD COMMENT EXPANSION                   *             
*                                                                 *             
* AUG02/93 (BU ) --- ADD SPL-AS-RUN FEATURE                       *             
*                                                                 *             
* SEP08/93 (BU ) --- COLCOMP:  CORRECT 'CONSTANT' PROCESSING.     *             
*                                                                 *             
* OCT05/93 (BU ) --- NEW PROCESSING FOR AGGTAB SPEC.              *             
*                                                                 *             
* OCT07/93 (BU ) --- FIX CODE/NAME DISPLAY PROBLEM....            *             
*                                                                 *             
* OCT19/93 (BU ) --- SPL-AS-RUN:  ADJUST DECL ALIGN WHEN $000S    *             
*                                                                 *             
* NOV02/93 (BU ) --- IMPLEMENT TSAROFF FOR AGGREG AND SPL TABLES  *             
*                                                                 *             
* NOV12/93 (BU ) --- IMPLEMENT 'ESTIMATED TOTAL' FACILITY         *             
*                                                                 *             
* DEC16/93 (BU ) --- SPL AS-RUN THIS WEEK COLUMN                  *             
*                                                                 *             
* JAN06/94 (BU ) --- ELIMINATE ERRONEOUS LAST LINE IN DOWNLOAD    *             
*                                                                 *             
* JAN13/94 (BU ) --- FIX ERROR IN DAYPART TABLE                   *             
*                                                                 *             
* FEB04/94 (BU ) --- PRODUCE 'DETAILS OF REPORT' FOR              *             
*                    RUNMODE = MULTI RUNS                         *             
*                                                                 *             
* FEB08/94 (BU ) --- ADD DEVELOPMENT S/P + CONTYPE ROWS           *             
*                                                                 *             
* FEB14/94 (BU ) --- ADD 'FORECAST' FLAG TO CONTRACT NUMBER ROW   *             
*                                                                 *             
* MAR04/94 (BU ) --- KILL LOGOS FOR 'DIRECT' WHEN RUNMODE=MULTI   *             
*                                                                 *             
* MAR18/94 (BU ) --- FINISH PRINTING FOR 'MULTI' JOBS             *             
*                                                                 *             
* APR19/94 (BU ) --- CLEAN UP 'CUME COLUMN' PROCESSING            *             
*                                                                 *             
* APR25/94 (BU ) --- BOTTOM LINE TOTALS FOR SPL FIGURES           *             
*                                                                 *             
* APR29/94 (BU ) --- FIX SPL PROCESSING OF EOF RECORD             *             
*                                                                 *             
* MAY10/94 (BU ) --- EXPAND BOTTOM LINE TOTAL ROUTINES            *             
*                                                                 *             
* MAY13/94 (BU ) --- SPL FIGURES TO ONE-DECIMAL PLACE             *             
*                                                                 *             
* JUN16/94 (BU ) --- FIX ROUNDING PROBLEM ON COLCOMP SPEC         *             
*                                                                 *             
* JUN21/94 (BU ) --- ADD SPL THIS YEAR LAST WEEK COLUMN           *             
*                                                                 *             
* JUL14/94 (BU ) --- FIX CALCULATION PROBLEM IN SPL CALCS         *             
*                                                                 *             
* AUG22/94 (BU ) --- FIX ENDLOGO USE....                          *             
*                                                                 *             
* SEP02/94 (BU ) --- SPECIAL RANK MERGE                           *             
*                                                                 *             
* SEP28/94 (BU ) --- RANKS > RANKMAX AS A SINGLE LINE OF DATA     *             
*                                                                 *             
* OCT17/94 (BU ) --- ON OPTION, SUPPRESS DETAILS IF NO CURR$$     *             
*                                                                 *             
* OCT27/94 (BU ) --- FIX SPL BOTTOM LINE TOTALS/CLEAR DETAIL      *             
*                    COLUMNS WHEN NO TABLE MATCH FOUND            *             
*                                                                 *             
* NOV30/94 (BU ) --- ACTIVATE COLUMN DECIMAL PLACE EDIT FEATURE   *             
*                                                                 *             
* DEC02/94 (BU ) --- WORKAREA CHANGE:                             *             
*                       REREPQWKD5 ---> REREPQWKD6                *             
*                                                                 *             
* MAY08/95 (BU ) --- CORRECTION TO COMP ROUTINE                   *             
*                                                                 *             
* SEP20/95 (BU ) --- PASS BACK 'AGY/ADV MISSING' RATHER THAN      *             
*                    A FLAG, TO PREVENT ABORTS                    *             
*                                                                 *             
* OCT06/95 (BU ) --- DATE FIRST BUY ENTERED COMMENT DISPLAY.      *             
*                                                                 *             
* OCT11/95 (BU ) --- WORKAREA CHANGE:                             *             
*                       REREPQWKD6 ---> REREPQWKD7                *             
*                                                                 *             
* OCT20/95 (BU ) --- WORKAREA CHANGE:                             *             
*                       REREPQWKD7 ---> REREPQWKD8                *             
*                                                                 *             
* NOV15/95 (BU ) --- CHANGE REGENALL --> REGENALL1 FOR 2K         *             
*                                                                 *             
* JAN24/96 (BU ) --- FIX AGYNAME/ADVNAME SORT INSERT BUG          *             
*                                                                 *             
* JAN25/96 (BU ) --- DIRECT RESPONSE CUTOFF DATE                  *             
*                    REREPQWKD8 --> REREPQWKD9                    *             
*                                                                 *             
* MAR01/96 (BU ) --- PAID PROGRAMMING CUTOFF DATE                 *             
*                    REREPQWKD9 --> REREPQWKDA                    *             
*                                                                 *             
* APR25/96 (BU ) --- FIX PRODUCT CODE PROBLEM                     *             
*                                                                 *             
* JUN10/96 (BU ) --- PCTCHG COMPUTATION ADJUSTMENT                *             
*                                                                 *             
* JUL22/96 (BU ) --- OPTIONALLY, LEFT-ALIGN REPORT FOR 'VIEWER'   *             
*                                                                 *             
* AUG01/96 (BU ) --- MODIFY SETHEAD TO HANDLE OFFICE SETS         *             
*                                                                 *             
* SEP27/96 (BU ) --- 'BROWSER FILE' OUTPUT                        *             
*                                                                 *             
* NOV11/96 (BU ) --- 'BROWSER':  NO DISPLACEMENT FOR KEY          *             
*                                                                 *             
* NOV13/96 (BU ) --- ADJUST RANKER TO ALWAYS UNWIND TO FIRST      *             
*                    ROW DURING RANK                              *             
*                                                                 *             
* JAN06/97 (BU ) --- FIX DAYPART ROW DISPLAY                      *             
*                                                                 *             
* MAY02/97 (BU ) --- USE REREPQWKDB AS NEW WORK AREA              *             
*                                                                 *             
* OCT02/97 (BU ) --- ADD KEYWORD 'AGENCY' - NO OFFICE ASSOCIATED  *             
*                                                                 *             
* FEB02/98 (BU ) --- CHANGE REGENALL1 --> REGENALL1A FOR 4K       *             
*                                                                 *             
* APR23/98 (BU ) --- 19   COLUMN INCREASE                         *             
*                    REREPQWKDB --> REREPQWKDC                    *             
*                                                                 *             
* MAY07/98 (BU ) --- COMPANY-WIDE BUDGET MODIFICATIONS            *             
*                                                                 *             
* DEC14/98 (BU ) --- REREPQWKDC --> REREPQWKDC                    *             
*                                                                 *             
* FEB12/99 (BU ) --- SPLIT OUT 'DIRECT' INTO SEPARATE REPORTS     *             
*                                                                 *             
* MAR16/99 (BU ) --- OVERRIDE 'DIRECT' FOR KPPRAGER REPORTS       *             
*                                                                 *             
* MAY02/00 (BU ) --- FIX SHARE CALC FIELD TEST                    *             
*                                                                 *             
* FEB21/01 (BU ) --- FOR DOWNLOAD, NO '*' FOR TOTALS FIELDS       *             
*                                                                 *             
* MAY29/01 (BU ) --- DYNALLOC/VTS VERSION                         *             
*                                                                 *             
* JUL31/01 (BU ) --- DYNALLOC:  ACCESS FROM DDSIO                 *             
*                                                                 *             
* OCT04/01 (BU ) --- BUYLINE CODING                               *             
*                                                                 *             
* OCT09/01 (BU ) --- BUYLINE ATTRIBUTE CODING                     *             
*                                                                 *             
* DEC13/01 (BU ) --- COMPENSATION S/P CODING                      *             
*                                                                 *             
*                    **  END TOMBSTONE  **                        *             
*******************************************************************             
*                                                                               
RERG03   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,**RG03**,RA,R9                                                 
*                                                                               
         L     RC,0(R1)                                                         
         USING WORKD,RC                                                         
*                                                                               
         L     R2,4(R1)                                                         
         USING MASTD,R2                                                         
*                                                                               
         L     R8,=A(RGWORKC)                                                   
         USING RGWORKC,R8                                                       
*                                                                               
         ST    R2,MASTDSAV         SAVE A(MS AREA)                              
*                                     USUAL WORKD DSECT REGISTER                
         USING WORKD,RC                                                         
*                                                                               
         MVC   AAGGLINE,AAGGREG    A(AGGLINE OR AGGLINES)                       
         MVC   AAGGSPLN,AAGGSPL    A(AGGSPL LINE OR LINES)                      
*                                                                               
*                                                                               
         ST    RC,AWORKD                                                        
         STM   R2,RC,SAVEREGS      SAVE FOR ADDRESSABILITY                      
*                                                                               
         LA    R0,AXTRAN           SET EXTENTION ROUTINES                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         L     R1,=A(EXTRA)                                                     
         ST    R1,AXTRA(RE)                                                     
         STC   RF,AXTRA(RE)                                                     
         LA    RF,1(RF)                                                         
         LA    RE,4(RE)                                                         
         BCT   R0,*-16                                                          
*                                                                               
*                                                                               
*   SAVE ORIGINAL SE NUMBER                                                     
*                                                                               
         L     RE,MCUTL            SET A(UTL)                                   
         MVC   SAVSENUM,4(RE)      RESET ORIGINAL SE NUMBER                     
*                                                                               
         MVC   RUNMODE,MCRUNMOD    SAVE RUN MODE                                
         MVC   OUTPUT,MCOUTPUT     SAVE OUTPUT CONTROL                          
         MVC   NOLOGOSW,MCPRTIND   SAVE LOGO SWITCH                             
         MVI   DIRECTSW,C'N'                                                    
         LA    RF,MCREMOTE         TEST FOR 'DIRECT TO QUEUE'                   
         USING REMOTED,RF                                                       
         OC    REMOTKEY,REMOTKEY   NON-ZERO IF DIRECT REPORT                    
         BZ    RERG0020            NOT DIRECT: DON'T SET SWITCH                 
         DROP  RF                                                               
         MVI   DIRECTSW,C'Y'       NO  - SET 'DIRECT TO QUEUE' FLAG             
RERG0020 EQU   *                                                                
         SP    MCREQNO,=P'1'       INITIALIZE MASTER REQ NO                     
         DROP  R2                                                               
         ST    R2,MCADDR           SAVE MASTER CONTROL ADDR                     
         MVC   USERRD,4(RD)        SAVE CALLER'S SAVE AREA ADDR                 
*                                                                               
         LA    R1,HEADHK                                                        
         ST    R1,HEADHOOK                                                      
         LA    R1,FOOTHK                                                        
         L     RF,ADCONLST                                                      
         ST    R1,FOOTHOOK-ADCONSD(RF)                                          
*                                                                               
         GOTO1 DATCON,DMCB,(5,0),(5,TODAY)                                      
         MVI   MAXLINES,55                                                      
         MVC   EXTRAPL,SPACES                                                   
         MVC   STAGLINE,SPACES                                                  
         MVI   THISQWK,0                                                        
         MVI   DASH,X'BF'          3800 UNDERLINE CHARACTER                     
         CLI   OUTPUT,C'D'          EXCEPT IF OUTPUT IS DIRECT                  
         BNE   *+8                                                              
         MVI   DASH,C'-'                                                        
         MVI   REQPRNT,C'Y'                                                     
         B     NEXTREQ                                                          
*                                                                               
EQXIT    CR    RB,RB                                                            
         B     *+6                                                              
NEQXIT   LTR   RB,RB                                                            
*                                                                               
EXIT     XIT1                                                                   
         EJECT                                                                  
NEXTREQ  DS    0H                  GET NEW REQUEST OR REPORT                    
*                                                                               
*   TEST                                                                        
**       MVC   P+1(12),=C'NEXTREQ     '                                         
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         XC    BDGREC,BDGREC       CLEAR BUDGET RECORD AREA                     
*                                                                               
*  REINITIALIZE BOTH TSAROFF BUFFERS BETWEEN REQUESTS                           
*                                                                               
         L     R3,ATSARDWA         SET A(TSAR CONTROL BLOCK)                    
*                                                                               
         USING TSARD,R3                                                         
         MVI   TSOFFACT,TSAINI                                                  
         MVC   TSAREC,=A(LENSPL)   SIZE OF SPL BUFFER                           
         GOTO1 ATSAROFF,(R3)       REINITIALIZE SPL BUFFER                      
         LA    R3,TSARDL+2(R3)     BUMP TO SECOND CONTROL BLOCK                 
*                                     KEEP ON FULL-WORD BOUNDARY                
         MVI   TSOFFACT,TSAINI                                                  
         MVC   TSAREC,=A(LENAGG)   SIZE OF AGGREG BUFFER                        
         GOTO1 ATSAROFF,(R3)       REINITIALIZE AGG BUFFER                      
*                                                                               
         DROP  R3                                                               
*                                                                               
         GOTO1 MERGER,DMCB,=C'GET',0                                            
         ICM   R7,15,4(R1)                                                      
         BNZ   NEXR0020                                                         
*                                                                               
*   TEST FOR NO DATA:  IF THIS IS PRINT=ONLINE, AND FILE HASN'T BEEN            
*        OPENED, THE DATASET MUST BE DYNAMICALLY ALLOCATED, OPENED              
*        AND THEN CLOSED, TO ESTABLISH A ZERO-RECORD DATA SET FOR               
*        OPERATIONS.                                                            
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),DOUBLE+8                                                 
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         CLC   DOUBLE+8(6),=C'ONLINE'                                           
*                                  ONLINE SPEC ENCOUNTERED IN RERG02?           
         BNE   NEXR0005            NO  - GO TO EOJ                              
         CLI   WRKOPEN,C'Y'        YES - RGWORK/ONLINE OPEN ALREADY?            
         BE    NEXR0005            YES - DON'T OPEN AGAIN                       
*                                                                               
         GOTO1 =A(DYNCALL),DMCB,(RC)                                            
         OPEN  (ONLINER,OUTPUT)    OPEN  ONLINE TAPE FILE AS OUTPUT             
         CLOSE ONLINER             CLOSE ONLINE TAPE                            
*                                                                               
*   TEST                                                                        
**       MVC   P+1(03),=C'O/C'                                                  
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
*                                                                               
NEXR0005 EQU   *                                                                
         GOTO1 =A(EOJ),DMCB,(RC)   END OF JOB                                   
         B     EXIT                                                             
NEXR0020 EQU   *                                                                
         MVC   REC(RGRECLEN),0(R7)                                              
*                                                                               
         L     R1,FILEC                                                         
         USING FILED,R1                                                         
         CLI   RREPPROF+17,C'Y'    PRINTQUEUE BREAKOUT?                         
         BNE   NEXR0025            NO  -                                        
*                                                                               
         DROP R1                                                                
*                                                                               
         CLI   DIRECTSW,C'Y'       'DIRECT TO QUEUE' FLAG SET?                  
         BNE   NEXR0025            NO  - NO PRINTQUEUE TESTING                  
         GOTO1 =A(REMOTE),DMCB,(RC)                                             
NEXR0025 EQU   *                                                                
         CLC   THISQWK(1),REC      TEST SAME REQUEST                            
         BNE   NEXR0040                                                         
         CLI   REQPRNT,C'N'        YES - THIS IS ANOTHER REPORT                 
         BE    NEXR0120            IF NO PRINT, SKIP THE REPORT                 
         B     NEXR0200                                                         
         SPACE 1                                                                
* INITIALIZE FOR NEW REQUEST *                                                  
         SPACE 1                                                                
NEXR0040 EQU   *                                                                
         CLI   RUNMODE,C'S'               IF RUN MODE NOT SINGLE -              
         BE    NEXR0080                                                         
         L     RF,MCADDR                                                        
         AP    MCREQNO-MASTD(3,RF),=P'1'  INCREMENT MASTER REQ NO               
*                                                                               
NEXR0080 L     R1,=A(RPDATA)       CLEAR REPORT DATA AREAS                      
         L     R0,=A(RPDATX)                                                    
         BAS   RE,CLEAR                                                         
*                                                                               
         L     R1,ATOTRECS         CLEAR TOTRECS AREA                           
         ST    R1,ANEXTTOT                                                      
         L     R0,ATOTRECX                                                      
         BAS   RE,CLEAR                                                         
*                                                                               
         MVC   THISQWK(1),REC      SAVE REQUEST NUMBER                          
         MVI   REQPRNT,C'Y'                                                     
         GOTO1 =A(XRPT),DMCB,(RC)  EXPLODE SPECS FOR THIS REQUEST               
         CLI   REQPRNT,C'N'        TEST FOR NO PRINT                            
         BNE   NEXR0160                                                         
*                                                                               
NEXR0120 GOTO1 MERGER,DMCB,=C'GET',0   NO PRINT - SKIP TO NEXT FILE             
         OC    4(4,R1),4(R1)                                                    
         BNZ   NEXR0120                                                         
         B     NEXTREQ                                                          
*                                                                               
NEXR0160 L     RF,THISQWK          GET QWORK ADDRESS                            
         USING QWKD,RF                                                          
         MVC   QRECORD(80),QWREQ   MOVE REQUEST RECORD                          
         MVC   STARTMON,QWCURST+1  CUR PERIOD START                             
         MVC   ENDMON,QWCURND+1           AND END MONTHS                        
         MVC   AGYOFFLG,QWNAOFLG   SET AGENCY OFFICE FLAG                       
         DROP  RF                                                               
*                                                                               
NEXR0200 MVI   RPTFRST,C'Y'                                                     
         MVI   RPTLAST,C'N'                                                     
         MVI   THISCOPY,1                                                       
*                                                                               
         L     R1,ATOTALS                                                       
         L     R0,ATOTALX                                                       
         BAS   RE,CLEAR                                                         
*                                                                               
         L     R1,ASVTOTS                                                       
         L     R0,ASVTOTX                                                       
         BAS   RE,CLEAR                                                         
*                                                                               
         CLI   RCTRACE,C'Z'        'BROWSER' FILE RUN + PRINTOUT?               
         BE    NEXR0220            YES                                          
         CLI   RCTRACE,C'B'        'BROWSER' FILE RUN?                          
         BNE   NEXR0240            NO                                           
NEXR0220 EQU   *                                                                
         CLI   BROWZOPN,C'Y'       YES - FILE ALREADY OPEN?                     
         BE    NEXR0240            YES                                          
         OPEN  (BROWSER,OUTPUT)    NO  - OPEN BROWSER FILE OUTPUT               
         MVI   BROWZOPN,C'Y'       SET 'BROWSER FILE' TO OPEN                   
NEXR0240 EQU   *                                                                
         CLI   REQPRNT,C'O'        PRINT = ONLINE?                              
         BNE   NEXR0280            NO  - DON'T ACCESS 'ONLINE' FILE             
         CLI   WRKOPEN,C'Y'        YES - RGWORK/ONLINE OPEN ALREADY?            
         BE    NEXR0320            YES - DON'T OPEN AGAIN                       
*                                                                               
         GOTO1 =A(DYNCALL),DMCB,(RC)                                            
         OPEN  (ONLINER,OUTPUT)    OPEN ONLINE TAPE FILE AS OUTPUT              
*                                                                               
*   TEST                                                                        
**       MVC   P+1(12),=C'OPEN ONLINER'                                         
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
*                                                                               
NEXR0280 DS    0H                                                               
         OPEN  (RGWORK,OUTPUT)                                                  
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'OPEN 1'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         MVI   WRKOPEN,C'Y'                                                     
*                                                                               
NEXR0320 ZIC   R2,REC+1            GET REPORT NUMBER                            
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD)                                           
         A     R2,=A(RPDATA)                                                    
         ST    R2,THISRPT          SAVE RPSPEC ADDRESS                          
         ST    R2,APRISPEC         SAVE FOR RECAP FLIP-FLOP                     
         MVI   PRISPEC#,0          CLEAR PRIOR SPEC FLAG                        
         MVC   THISRPT(1),REC+1    AND REPORT NUMBER                            
         EJECT                                                                  
         USING RPSPECD,R2                                                       
NEXR0360 DS    0H                                                               
         GOTO1 MERGER,DMCB,=C'GET',0                                            
         ICM   R7,15,4(R1)                                                      
         BNZ   NEXR0400                                                         
*                                                                               
         MVI   RPTLAST,C'Y'                                                     
         B     NEXR0520                                                         
NEXR0400 EQU   *                                                                
***      CLC   =C'NEXR0400',QUESTOR                                             
***      BNE   NEXR0410                                                         
***      GOTO1 =A(DISPDUMP),DMCB,(R7),1,0,(RC)                                  
NEXR0410 EQU   *                                                                
*                                                                               
*   TEST COMPANY BUDGET W/OFFICE KEY                                            
*        IF EITHER OLD OR NEW RECORD IS BUDGET, DON'T ADD THEM TOGETHER         
*                                                                               
*        TM    REC+RMISCDSP,X'40'  COMPANY BUDGET W/OFFICE SET?                 
*        BO    NEXR0520            YES - DON'T ROLL TOGETHER                    
*        TM    RMISCDSP(R7),X'40'  COMPANY BUDGET W/OFFICE SET?                 
*        BO    NEXR0520            YES - DON'T ROLL TOGETHER                    
*   TEST END                                                                    
*                                                                               
         CLC   REC(RGKEYLEN),0(R7)   TEST KEYS EQUAL                            
         BNE   NEXR0520                                                         
         SPACE 1                                                                
* KEYS EQUAL - ADD RECORDS *                                                    
         SPACE 1                                                                
         LA    RE,REC                                                           
         LA    RF,RGDTADSP         DSPL TO FIRST COL                            
         LA    R0,RGCOLMAX         MAX NUMBER OF COLS                           
*                                                                               
NEXR0440 EQU   *                                                                
         L     R1,0(RE,RF)                                                      
         A     R1,0(R7,RF)                                                      
         ST    R1,0(RE,RF)                                                      
         LA    RF,4(RF)                                                         
NEXR0480 EQU   *                                                                
         BCT   R0,NEXR0440                                                      
         B     NEXR0360                                                         
         SPACE 1                                                                
* KEYS NOT EQUAL *                                                              
         SPACE 1                                                                
NEXR0520 CLI   REC+1,0             TEST FOR TOTAL RECORD                        
         BH    NEXR0600            NO                                           
         SPACE 2                                                                
* TOTAL RECORD  - SAVE IN TOTAL BUFFER *                                        
         SPACE 1                                                                
NEXR0560 L     RE,ANEXTTOT                                                      
         L     R0,ATOTRECX                                                      
         SH    R0,=Y(RGRECLEN)                                                  
         CR    RE,R0               TEST ROOM FOR MORE                           
         BNH   *+6                                                              
         DC    H'0'                                                             
         MVC   0(RGRECLEN,RE),REC                                               
         LA    RE,RGRECLEN(RE)                                                  
         ST    RE,ANEXTTOT                                                      
         B     NEXR0640                                                         
         SPACE 1                                                                
* DATA RECORD - PUT TO WORK FILE *                                              
         SPACE 1                                                                
NEXR0600 DS    0H                                                               
****>>>  GOTO1 =A(DISPDUMP),DMCB,REC,2,0,(RC) ****>>>                           
*                                                                               
*   CHECK FOR NO CURR$$=NO DETAIL OPTION:  IF SELECTED, AND NO                  
*      CURRENT $$, DON'T OUTPUT THIS RECORD                                     
*                                                                               
         L     R1,THISQWK          A(THIS REQUEST WORK AREA)                    
         USING QWKD,R1                                                          
         LA    RF,QWREQ3                                                        
         CLI   Q3SUPDET-QREC3(RF),C'Y'                                          
*                                  OPTION SET TO 'Y'?                           
         BNE   NEXR0630            NO  - PROCESS EVERYTHING                     
*                                  YES - CHECK FOR CURRENT $$                   
         DROP  R1                                                               
*                                                                               
         OC    RPCUREST(16),RPCUREST                                            
*                                  ANY COLUMN ADDRESSES?                        
         BZ    NEXR0630            NO  - NO CURRENT $$ IN REPORT                
*                                     THEREFORE, DON'T TEST FOR $$              
         LA    R1,RPCUREST         YES - A(1ST CURRENT $$ ADDR)                 
         LA    RF,4                SET LOOP CONTROL                             
NEXR0610 EQU   *                                                                
         ZICM  RE,0(R1),2          LOAD D(CURRENT $$ FIELD)                     
         LTR   RE,RE               ANY DISPLACEMENT LOADED?                     
         BZ    NEXR0620            NO  - CHECK NEXT                             
         LA    R6,REC+RGDTADSP     YES - SET A(1ST POS OF RECORD DATA)          
         AR    RE,R6               SET TO A(CURR $$ FLD IN REC)                 
         OC    0(4,RE),0(RE)       YES - ANY $$ AT THAT ADDRESS?                
         BNZ   NEXR0630            YES - USE THIS RECORD                        
*                                  NO  - CHECK NEXT ADDRESS                     
NEXR0620 EQU   *                                                                
         LA    R1,4(R1)            BUMP TO NEXT ADDRESS                         
         BCT   RF,NEXR0610         GO BACK AND CHECK NEXT                       
         B     NEXR0640            NO CURRENT $$ AT ANY ADDRESS -               
*                                     SKIP THIS RECORD                          
NEXR0630 EQU   *                                                                
         LA    R0,REC                                                           
         CLI   REQPRNT,C'O'        PRINT = ONLINE?                              
         BNE   NEXR0635            NO  - DON'T ACCESS 'ONLINE' FILE             
         PUT   ONLINER,(0)                                                      
*                                                                               
*   TEST                                                                        
**       MVC   P+1(12),=C'PUT  ONLINER'                                         
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         B     NEXR0640                                                         
NEXR0635 EQU   *                                                                
         PUT   RGWORK,(0)                                                       
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'PUT  1'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
*                                                                               
NEXR0640 CLI   RPTLAST,C'Y'                                                     
         BE    NEXR0680                                                         
         MVC   REC(RGRECLEN),0(R7)   SAVE NEW RECORD                            
         B     NEXR0360                                                         
         EJECT                                                                  
* END OF DATA *                                                                 
         SPACE 1                                                                
NEXR0680 DS    0H                                                               
         CLI   REC+1,0             TEST FOR TOTAL REC (RPT0)                    
         BE    NEXTREQ                                                          
         CLI   REQPRNT,C'O'        TEST PRINT=ONLINE                            
         BE    NEXTREQ             YES-GO STRAIGHT TO NEXT REQUEST              
*                                                                               
         LA    R1,REC+RGROWSZ        POINT TO ROW 1                             
         LA    R0,RGROWMAX-1                                                    
*                                                                               
NEXR0720 MVC   0(RGROWSZ-1,R1),XFF   SET KEY VALUE TO X'FF'                     
         MVI   RGROWSZ-1(R1),01    SET NORMAL REPORT                            
         LA    R1,RGROWSZ(R1)                                                   
         BCT   R0,NEXR0720                                                      
*                                                                               
         PUT   RGWORK,REC          WRITE THE EOF REC                            
*                                                                               
         CLOSE RGWORK                                                           
*                                                                               
         TM    RPMISFLG,X'01'      REPORT REQUIRES SPECIAL SORT?                
         BNO   NEXR0755            NO  - SKIP IT                                
*                                                                               
*   SPECIAL MERGE SECTION FOR RANK DATA...                                      
*                                                                               
         XC    BDGREC,BDGREC       CLEAR TEMPORARY STORAGE                      
         OPEN  (RGWORK,INPUT)                                                   
         LA    R0,NEXR0740                                                      
         STCM  R0,7,RGWORK+33      SET EOF ADDRESS                              
*                                                                               
         LA    RE,RGRECLEN         SET RECORD LENGTH FOR SORT                   
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  RECCARD+22(3),DUB                                                
         LA    RE,RGKEYLEN         SET KEYLENGTH IN SORT CARD                   
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SORTCD2+15(3),DUB                                                
*                                                                               
         GOTO1 SORTER,DMCB,SORTCD2,RECCARD                                      
*                                                                               
NEXR0725 EQU   *                                                                
         CLI   NEWSPEC#,0          CHANGE IN REPORT SPEC#?                      
         BE    NEXR0731            NO                                           
         CLI   NEWSPEC#,1          YES - GOING BACK TO BASIC SPEC?              
         BNE   NEXR0727            NO  - USE NEW SPEC #                         
         L     R2,APRISPEC         YES - RESET TO ORIGINAL SPEC                 
         B     NEXR0729                                                         
NEXR0727 EQU   *                                                                
         ZIC   R2,NEWSPEC#         RESET REPORT SPEC ADDR                       
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD)                                           
         A     R2,=A(RPDATA)       RESET A(REPORT SPEC)                         
NEXR0729 EQU   *                                                                
         MVI   NEWSPEC#,0                                                       
NEXR0731 EQU   *                                                                
         GET   RGWORK,REC          RETRIEVE A RECORD                            
         OC    BDGREC(16),BDGREC   FIRST TIME?                                  
         BNZ   NEXR0735            NO                                           
         MVC   BDGREC,REC          YES - LOAD REC TO BUDGET RECORD              
NEXR0735 EQU   *                                                                
         MVI   DMCB+16,C'M'        SET SPECIAL PRINT OPTION                     
         GOTO1 =A(DISPDUMP),DMCB,REC,3,0,(RC)                                   
         GOTO1 =A(CHKAGGR3),DMCB,(RC)                                           
         MVC   BDGREC,REC          SET 'OLD' RECORD                             
         MVI   DMCB+16,C'N'        SET SPECIAL PRINT OPTION                     
         GOTO1 =A(DISPDUMP),DMCB,REC,3,0,(RC)                                   
         GOTO1 SORTER,DMCB,=C'PUT',REC                                          
         B     NEXR0725            GO BACK AND GET NEXT                         
NEXR0740 EQU   *                                                                
         CLOSE RGWORK                                                           
*                                                                               
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  1'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         L     R2,APRISPEC         RESET TO ORIGINAL SPEC                       
         MVI   NEWSPEC#,0          CLEAR NEWSPEC VALUE                          
*                                                                               
         OPEN  (RGWORK,OUTPUT)                                                  
*                                                                               
NEXR0745 GOTO1 SORTER,DMCB,=C'GET'                                              
         ICM   RE,15,4(R1)                                                      
         BZ    NEXR0750                                                         
         MVC   REC(RGRECLEN),0(RE)                                              
         PUT   RGWORK,REC                                                       
         GOTO1 =A(DISPDUMP),DMCB,REC,6,0,(RC)                                   
*                                  CHECK FOR DISPLAY                            
         B     NEXR0745                                                         
*                                                                               
NEXR0750 EQU   *                                                                
*                                                                               
         CLOSE RGWORK                                                           
*                                                                               
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  2'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
NEXR0755 EQU   *                                                                
         CLI   RPRANK2,0           TEST RANKED REPORT                           
         BE    NEXR0760                                                         
         GOTO1 =A(RANK),DMCB,(RC),RPRANK2                                       
*                                                                               
NEXR0760 CLI   RPRANK1,0                                                        
         BE    NEXR0800                                                         
         GOTO1 =A(RANK),DMCB,(RC),RPRANK1                                       
         CLI   RPRANK1,2           RANK ROW > SECOND?                           
***>>>   CLI   RPRANK1,3           RANK ROW > THIRD?                            
         BNH   NEXR0800            NO  - NO SPECIAL PROCESSING NEEDED           
         ZICM  RF,RPRANK1+1,3      YES - GET A(33 SPEC)                         
         CLI   4(RF),0             ANY 'W/IN' FOR RANK?                         
         BE    NEXR0800            NO  - NO SPECIAL PROCESSING NEEDED           
         MVC   R33SPEC(5),0(RF)    STORE ORIGINAL 33 SPEC                       
         MVI   R33SPEC+3,X'FF'     SET SPECIAL RANK FLAG IN 33 SPEC             
         ZIC   R4,4(RF)            YES - GET 'W/IN' ROW NUMBER                  
         STC   R4,R33SPEC+4        INSERT INTO 'W/IN' ROW NUMBER                
         LA    RF,R33SPEC          SET A(TEMP 33 SPEC)                          
         ST    RF,RXRANK           STORE A(TEMP 33 SPEC)                        
         MVC   RXRANK(1),RPRANK1   STORE RANK ROW                               
*                                                                               
*   TEST                                                                        
*        MVC   P+1(08),=C'RXRANK ='                                             
*        MVC   P+9(1),RXRANK       INSERT ROW NUMBER                            
*        ZICM  RF,RXRANK+1,3       GET A(33 SPEC)                               
*        MVI   P+10,C'/'                                                        
*        MVC   P+11(5),0(RF)                                                    
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
NEXR0790 EQU   *                                                                
         GOTO1 =A(RENUMBER),DMCB,(RC),RXRANK                                    
         B     NEXR0800                                                         
R33SPEC  DS    CL5                                                              
*                          TEMPORARY 33 SPEC                                    
*             + 0       =  ENTRY CODE 33 (X'21')                                
*             + 1       =  LENGTH OF ENTRY                                      
*             + 2       =  COLUMN NUMBER TO RANK                                
*             + 3       =  'IF' SPEC NUMBER                                     
*             + 4       =  'WITHIN' ROW NUMBER                                  
*                                                                               
RXRANK   DS    A                   SPECIAL ROW PROCESSING                       
*             + 0       =  RANK ROW NUMBER                                      
*             + 1-3     =  A(TEMPORARY 33 SPEC)                                 
*                                                                               
*                                                                               
*                                                                               
NEXR0800 EQU   *                                                                
         CLI   RPADVNM,0           ADVNAME SPEC?                                
         BNE   NEXR0840            YES                                          
         CLI   RPAGYNM,0           NO  - AGYNAME SPEC?                          
         BE    NEXR1280            NO  - NEITHER - NO RESORT                    
*                                                                               
*    ADVNAME AND/OR AGYNAME SPECIFIED - MUST DO SORT AGAIN                      
*                                                                               
NEXR0840 EQU   *                                                                
         CLI   RPADVNM,0           ADVNAME ROW?                                 
         BE    NEXR0880            NO  -                                        
         XC    ADVSAVE,ADVSAVE     YES - SET IT UP                              
         L     R4,RPADVNM          SET A(ADVNAME FIELD)                         
NEXR0880 EQU   *                                                                
         CLI   RPAGYNM,0           AGYNAME ROW?                                 
         BE    NEXR0920            NO  - RESORT NOW                             
         XC    AGYSAVE,AGYSAVE                                                  
         L     R5,RPAGYNM          R5 = A(AGYNAME FIELD)                        
*                                                                               
NEXR0920 OPEN  (RGWORK,INPUT)      NOW RESORT IN ADVNAME AND/OR AGYNAME         
         LA    R0,NEXR1160          SEQUENCE                                    
         STCM  R0,7,RGWORK+33      SET EOF ADDRESS                              
*                                                                               
         LA    RE,RGRECLEN         SET RECORD LENGTH FOR SORT                   
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  RECCARD+22(3),DUB                                                
         LA    RE,RGKEYLEN         SET KEYLENGTH IN SORT CARD                   
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SORTCD2+15(3),DUB                                                
*                                                                               
         GOTO1 SORTER,DMCB,SORTCD2,RECCARD                                      
*                                                                               
         MVI   RECLABEL,C'Y'       SET AGY/ADV RETRIEVE FLAG                    
NEXR0960 GET   RGWORK,REC          RETRIEVE A RECORD                            
         GOTO1 =A(DISPDUMP),DMCB,REC,4,0,(RC)                                   
*                                  CHECK FOR DISPLAY                            
         CLC   REC+RGROWSZ(RGROWSZ-1),XFF                                       
*                                  EOF RECORD REACHED?                          
         BE    NEXR1120            YES                                          
         CLI   RPADVNM,0           NO  - ADV NAME NEEDED?                       
         BE    NEXR1040            NO                                           
         L     R1,RPADVCD          YES - CODE ALREADY RETRIEVED?                
         CLC   ADVSAVE,0(R1)                                                    
         BE    NEXR0980            YES                                          
         MVC   ADVSAVE,0(R1)       NO  - SAVE CODE AND                          
         GOTO1 AGETADV                GO GET EXPANSION                          
         CLI   RECLABEL+1,C'Y'     CODE NOT FOUND - SKIP LOAD?                  
         BNE   NEXR1000            NO  - FOUND                                  
         MVC   ADVSAVE,SPACES      NOT FOUND - CLEAR FIND AREA                  
         MVI   RECLABEL+1,C'*'     RESET NOT FOUND FLAG                         
         B     NEXR1040                                                         
*                                                                               
NEXR0980 EQU   *                                                                
         MVC   0(RGROWSZ-1,R4),ADVNMSV                                          
         B     NEXR1020                                                         
NEXR1000 EQU   *                                                                
         MVC   ADVNMSV,WORK+8      SAVE NAME                                    
         MVC   0(RGROWSZ-1,R4),WORK+8                                           
NEXR1020 EQU   *                                                                
         MVI   RGROWSZ-1(R4),1                                                  
*                                                                               
NEXR1040 CLI   RPAGYNM,0           AGY NAME NEEDED?                             
         BE    NEXR1120            NO                                           
         L     R1,RPAGYCD          YES - CODE ALREADY RETRIEVED?                
         CLC   AGYSAVE,0(R1)                                                    
         BE    NEXR1070            YES                                          
         MVC   AGYSAVE,0(R1)       NO  - SAVE CODE AND                          
         GOTO1 AGETAGY                GO GET EXPANSION                          
         CLI   RECLABEL+1,C'Y'     CODE NOT FOUND - SKIP LOAD?                  
         BNE   NEXR1080            NO  - FOUND                                  
         MVC   AGYSAVE,SPACES      NOT FOUND - CLEAR FIND AREA                  
         MVI   RECLABEL+1,C'*'     RESET NOT FOUND FLAG                         
         B     NEXR1120                                                         
*                                                                               
NEXR1070 EQU   *                                                                
         MVC   0(RGROWSZ-1,R5),AGYNMSV                                          
*                                  LOAD EXPANSION TO ROW                        
         B     NEXR1100                                                         
NEXR1080 EQU   *                                                                
         MVC   AGYNMSV,WORK+8      SAVE NAME                                    
         MVC   0(RGROWSZ-1,R5),WORK+8                                           
*                                  LOAD EXPANSION TO ROW                        
NEXR1100 EQU   *                                                                
         MVI   RGROWSZ-1(R5),1                                                  
*                                                                               
NEXR1120 EQU   *                                                                
         GOTO1 SORTER,DMCB,=C'PUT',REC                                          
         GOTO1 =A(DISPDUMP),DMCB,REC,5,0,(RC)                                   
         B     NEXR0960                                                         
*                                                                               
NEXR1160 DS    0H                  EOF                                          
         MVI   RECLABEL,C'*'       TURN OFF AGY/ADV RETRIEVE FLAG               
         MVI   RECLABEL+1,C'*'     TURN OFF NOT FOUND FLAG                      
         CLOSE RGWORK                                                           
*                                                                               
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  3'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         OPEN  (RGWORK,OUTPUT)                                                  
*                                                                               
*                                                                               
NEXR1200 GOTO1 SORTER,DMCB,=C'GET'                                              
         ICM   RE,15,4(R1)                                                      
         BZ    NEXR1240                                                         
         MVC   REC(RGRECLEN),0(RE)                                              
         PUT   RGWORK,REC                                                       
         B     NEXR1200                                                         
*                                                                               
NEXR1240 CLOSE RGWORK                                                           
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  4'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         EJECT                                                                  
* NOW PROCESS THE WORK FILE AND PRINT THE REPORT *                              
         SPACE 1                                                                
NEXR1280 DS    0H                                                               
         OPEN  (RGWORK,INPUT)                                                   
         XC    BDGREC,BDGREC       CLEAR TEMPORARY STORAGE                      
         LA    R0,NEXT0620                                                      
         STCM  R0,7,RGWORK+33      SET EOF ADDRESS                              
*                                                                               
         GOTO1 =A(SETHEAD),DMCB,(RC),(R8)  SET HEADLINES FOR THIS RPT           
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
*                                                                               
NEXR1320 EQU   *                                                                
*                                                                               
*   PROCESSING DESCRIPTION:  THE RECORD RETURNED (EITHER 'REC' OR               
*      'NEWREC') MAY BE A BASIC DATA RECORD, AN AGGREGATE RECORD                
*      (EITHER STRAIGHT DATA, OR SPL AS RUN DATA), OR A BUDGET RECORD.          
*      FOR RECORDS OTHER THAN A BUDGET RECORD, THIS CAN BE DETERMINED           
*      BY LOOKING AT THE LAST POSITION OF THE LAST ROW IN THE RECORD.           
*      IF THAT POSITION IS NOT ZERO, THE RECORD HAS BASIC DATA.  IF             
*      IT IS ZERO, THE FOLLOWING POSITION WILL CONTAIN X'FF' FOR                
*      SPL AS RUN DATA.                                                         
*      FOR BUDGET RECORDS, THE BUDPAS COLUMN NUMBER IS USED.  IF THE            
*      LAST POSITION OF THAT ROW IS ZERO, AND THE FOLLOWING POSITION            
*      CONTAINS X'FE', IT IS A BUDGET RECORD.                                   
*                                                                               
         CLI   NEWSPEC#,0          CHANGE IN REPORT SPEC#?                      
         BE    NEXR1380            NO                                           
         CLI   NEWSPEC#,1          YES - GOING BACK TO BASIC SPEC?              
         BNE   NEXR1340            NO  - USE NEW SPEC #                         
         L     R2,APRISPEC         YES - RESET TO ORIGINAL SPEC                 
         B     NEXR1360                                                         
NEXR1340 EQU   *                                                                
         ZIC   R2,NEWSPEC#         RESET REPORT SPEC ADDR                       
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD)                                           
         A     R2,=A(RPDATA)       RESET A(REPORT SPEC)                         
NEXR1360 EQU   *                                                                
         MVI   NEWSPEC#,0                                                       
NEXR1380 EQU   *                                                                
         GET   RGWORK,REC                                                       
         OC    BDGREC(16),BDGREC   FIRST TIME?                                  
         BNZ   NEXR1400            NO                                           
         MVC   BDGREC,REC          YES - LOAD REC TO BUDGET RECORD              
NEXR1400 EQU   *                                                                
         GOTO1 =A(DISPDUMP),DMCB,REC,3,0,(RC)                                   
         GOTO1 =A(CHKAGGR2),DMCB,(RC)                                           
         MVC   BDGREC,REC          SET 'OLD' RECORD                             
         CLI   XFERTO,1            TRANSFER TO                                  
         BNE   NEXR1320            NO  - GO BACK FOR NEXT RECORD                
NEXR1600 EQU   *                                                                
         ICM   R7,15,RPREMCPY      TEST FOR REMCOPY SPEC(S)                     
         BZ    NEXR1700                                                         
***>>>   BZ    NEXR1720                                                         
*                                                                               
NEXR1640 CLC   THISCOPY,2(R7)      IS IT TIME TO CHANGE DESTINATION             
         BL    NEXR1700            NO                                           
***>>>   BL    NEXR1720            NO                                           
         BE    NEXR1680            YES                                          
         ZIC   R0,1(R7)                                                         
         AR    R7,R0                                                            
         CLI   0(R7),17            ANY MORE REMCOPY SPECS                       
         BNE   NEXR1720                                                         
         B     NEXR1640                                                         
*                                                                               
NEXR1680 CLI   RUNMODE,C'S'        SKIP LOGOS FOR SINGLE RUN MODE               
         BE    NEXR1700                                                         
*****>>> CLI   RPREMPRT,C'Y'       TEST FOR LOGO STARTED                        
         CLI   XENDLOGO,C'Y'       TEST FOR LOGO STARTED                        
         BNE   *+8                                                              
         BAS   RE,ENDLOGO          END LAST LOGO                                
         MVI   RPREMCPY,C'Y'                                                    
         GOTO1 =A(STLOGO),DMCB,(RC),(R2)                                        
*                                  START NEW LOGO                               
         MVI   RCREQREP,C'Y'                                                    
         L     RE,THISQWK          A(THIS REQUEST WORK AREA)                    
         USING QWKD,RE                                                          
         PRINT GEN                                                              
         GOTO1 =V(REDREQ),DMCB,(RC),QWREQ   PRINT DETAILS OF REQUEST            
         PRINT NOGEN                                                            
         DROP  RE                                                               
         MVI   RCREQREP,C'N'                                                    
NEXR1700 EQU   *                                                                
         CLI   RUNMODE,C'S'        DOWNHEAD NOT TO BE CALLED WHEN               
*                                     NOT SINGLE RUNMODE:  PUTS OUT             
*                                     DUPLICATE HEADINGS BEFORE                 
*                                     'DETAILS OF REQUEST'                      
         BNE   NEXR1720                                                         
         GOTO1 =A(DOWNHEAD),DMCB,(RC)                                           
*                                                                               
NEXR1720 EQU   *                                                                
         MVI   CBLEVEL,1                                                        
         BAS   RE,CBFIRST          GIVE ALL LEVEL FIRSTS                        
*                                                                               
NEXR1760 EQU   *                                                                
         CLI   NEWSPEC#,0          CHANGE IN REPORT SPEC #?                     
         BE    NEXR1780            NO                                           
         CLI   NEWSPEC#,1          YES - GOING BACK TO BASIC SPEC?              
         BNE   NEXR1765            NO  - USE NEW SPEC #                         
         L     R2,APRISPEC         YES - RESET TO ORIGINAL SPEC                 
         B     NEXR1770                                                         
NEXR1765 EQU   *                                                                
         ZIC   R2,NEWSPEC#         YES - RESET REPORT SPEC ADDRESS              
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD)                                           
         A     R2,=A(RPDATA)       RESET A(REPORT SPEC)                         
NEXR1770 EQU   *                                                                
         MVI   NEWSPEC#,0          TURN OFF REPORT SPEC #                       
*                                                                               
NEXR1780 EQU   *                                                                
*                                                                               
         GOTO1 =A(POST),DMCB,(RC)  POST THE RECORD                              
*                                                                               
NEXR1840 GET   RGWORK,NEWREC                                                    
         GOTO1 =A(DISPDUMP),DMCB,NEWREC,3,1,(RC)                                
         GOTO1 =A(CHKAGGRS),DMCB,(RC)                                           
         CLI   XFERTO,1            TRANSFER TO NEXR2160?                        
         BNE   NEXR1840            NO  - GO BACK FOR NEXT RECORD                
NEXR2160 EQU   *                                                                
         LH    R4,RPCBEXLN         GET LENGTH                                   
         EX    R4,NEXR2240         TEST FOR CONTROL BREAK                       
         BE    NEXR2200                                                         
         MVC   CBLEVEL,RPROWS      SET CONTROL BREAK LEVEL                      
         B     NEXT0450                                                         
*                                                                               
NEXR2200 MVC   REC,NEWREC          ELSE MOVE RECORD                             
         B     NEXR1760            AND CONTINUE                                 
*                                                                               
NEXR2240 CLC   REC(0),NEWREC                                                    
         EJECT                                                                  
*                                                                               
         EJECT                                                                  
* PROCESS A CONTROL BREAK *                                                     
         SPACE 1                                                                
NEXT0450 ZIC   R5,RPSTMKTR         POINT TO STATION ROW                         
         MH    R5,=Y(RGROWSZ)      IN NEW RECORD                                
         LA    R5,NEWREC(R5)                                                    
         CLC   2(6,R5),XFFE        IS IT MKT 'FE' (COMBO) RECORD                
         BNE   NEXT0458                                                         
         OI    MKTBYTE,X'02'       SET 'COMBO TOTAL FOUND'                      
         TM    MKTBYTE,X'04'       MORE THAN 1 STA/MKT?                         
         BO    NEXT0470            YES, PRINT COMBO TOTALS                      
         XC    SVMKTSTA,SVMKTSTA   NO  - CLEAR INDICATOR                        
         NI    MKTBYTE,X'F0'       CLEAR FLAG BITS FOR COMBO                    
         B     NEXR1840                                                         
NEXT0458 EQU   *                                                                
         CLC   2(6,R5),XFF         IS IT MARKET 'FF' RECORD                     
         BNE   NEXT0460                                                         
         CLC   0(8,R5),XFF         MAKE SURE IT'S NOT EOF RECORD                
         BE    NEXT0460                                                         
         OI    MKTBYTE,X'20'       YES                                          
         TM    MKTBYTE,X'40'       MORE THAN 1 STA/MKT                          
         BO    NEXT0470            YES, PRINT MKT TOTALS                        
         XC    SVMKT,SVMKT         NO, CLEAR INDICATORS                         
         NI    MKTBYTE,X'0F'       CLEAR FLAG BITS FOR MKT TOTAL                
         B     NEXR1840            AND GET NEXT RECORD                          
*                                                                               
NEXT0460 ZIC   R5,RPSTMKTR         POINT TO STATION ROW                         
         MH    R5,=Y(RGROWSZ)      IN OLD RECORD                                
         LA    R5,REC(R5)                                                       
         CLC   2(6,R5),XFFE        IS IT MARKET COMBO TOTAL?                    
         BNE   NEXT0462            NO  -                                        
         XC    SVMKTSTA,SVMKTSTA   YES - CLEAR INDICATOR (COMBO)                
         NI    MKTBYTE,X'F0'       TURN OFF COMBO BITS                          
         B     NEXT0470                                                         
NEXT0462 EQU   *                                                                
         CLC   2(6,R5),XFF         IS IT MARKET 'FF' RECORD                     
         BNE   NEXT0470                                                         
         CLC   0(8,R5),XFF         MAKE SURE IT'S NOT EOF RECORD                
         BE    NEXT0470                                                         
         XC    SVMKT,SVMKT                                                      
         MVI   MKTBYTE,0                                                        
*                                                                               
NEXT0470 ZIC   R5,CBLEVEL          GET HIGH ROW NUMBER                          
         BCTR  R5,0                DECREMENT                                    
         STC   R5,CBLEVEL          SET ROW NUMBER THIS CONTROL BREAK            
*                                                                               
         CLC   REC+RGROWSZ(RGROWSZ-1),XFF TEST EOF REC                          
         BE    NEXT0620                                                         
*                                                                               
NEXT0480 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        GOTO1 =A(TESTPRT),DMCB,(RC),RPROWS                                     
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
*                                                                               
         CLI   RCTRACE,C'Z'        'BROWSER' FILE RUN + PRINTOUT?               
         BE    NEXT0482            YES                                          
         CLI   RCTRACE,C'B'        'BROWSER' RUN?                               
         BNE   NEXT0485            NO                                           
NEXT0482 EQU   *                                                                
         XC    KTZRECSZ,KTZRECSZ   CLEAR RECORD SIZE COUNTER                    
         LA    RF,KTZREC+KTZ1STEL  SET A(1ST ELEMENT IN KTZREC)                 
         ST    RF,KTZADDR          SAVE FOR RECORD BUILDING                     
         GOTO1 =A(SETBROWZ),DMCB,(RC),CBLEVEL                                   
NEXT0485 EQU   *                                                                
         BAS   RE,FORMPRNT         FORMAT AND PRINT DATA                        
*                                                                               
*                                                                               
*   TEST                                                                        
*        MVC   P+1(10),=C'POST-FORM:'                                           
*        EDIT  CBLEVEL,(3,P+12)                                                 
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
                                                                                
         OC    HEADADDR,HEADADDR   TEST NEED TO CLEAR TEMP HDLINE               
         BZ    NEXT0490                                                         
         L     RE,HEADADDR                                                      
         MVC   0(40,RE),SPACES                                                  
         XC    HEADADDR,HEADADDR                                                
         SPACE 1                                                                
* BLANK HEADLINE OR MIDLINE DATA FOR THIS ROW *                                 
         SPACE 1                                                                
NEXT0490 CLI   CBLEVEL,1           TEST DONE                                    
         BL    NEXT0620                                                         
*                                                                               
         LR    R7,R5               GET ROW NUMBER                               
         SLL   R7,2                X 4                                          
*                                                                               
         L     R6,RPTOTPRT(R7)                                                  
         LTR   R6,R6               TEST ANY TOTPRTS THIS LEVEL                  
         BZ    NEXT0500                                                         
         BAS   RE,FTOT             GO PRINT TOTAL ROWS                          
NEXT0500 EQU   *                                                                
*                                                                               
         L     R6,RPROWNAM(R7)     POINT TO ROWNAME SPEC                        
         USING RNSPECD,R6                                                       
*                                                                               
         CLI   RNLINTYP,1          TEST HEADLINE ROW                            
         BNE   NEXT0510                                                         
         LR    RE,R5                                                            
         BCTR  RE,0                                                             
         MH    RE,=H'132'                                                       
         LA    RE,HEAD4(RE)        FIRST HEADLINE ROW IS R4                     
         MVC   0(80,RE),SPACES     BLANK THE HEADLINE DATA                      
         MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
         B     NEXT0520                                                         
*                                                                               
NEXT0510 CLI   RNLINTYP,2          TEST MIDLINE ROW                             
         BNE   NEXT0520                                                         
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         EJECT                                                                  
* TEST CONTROL BREAK CAUSED BY RECAP *                                          
         SPACE 1                                                                
NEXT0520 LR    RF,R5               SET TO GET DSPL FOR BREAK JUST DONE          
         MH    RF,=Y(RGROWSZ)                                                   
         LA    RF,RGROWSZ-1(RF)    GET DSPL TO RECAP BYTE                       
         LA    RE,REC(RF)          POINT IN CURRENT RECORD                      
         CLI   0(RE),1             WAS A RECAP IN PROCESS                       
         BH    NEXT0590            YES - GO END RECAP                           
         BE    NEXT0525                                                         
         MVI   0(RE),1             ZERO:  SET TO 1 AND CONTINUE                 
*****    DC    H'0'                                                             
NEXT0525 EQU   *                                                                
         LA    RE,NEWREC(RF)       POINT IN NEW RECORD                          
         CLI   0(RE),1             IS A NEW RECAP IN PROCESS                    
         BH    NEXT0600            YES                                          
         EJECT                                                                  
* TEST FOR ADDITIONAL CONTROL BREAKS *                                          
         SPACE 1                                                                
NEXT0530 EQU   *                                                                
         LR    RE,R5                                                            
         MH    RE,=Y(RGROWSZ)                                                   
         BCTR  RE,0                                                             
*                                                                               
*  IF DOWNLOAD/ACCOUNTING REPORT, SHORT-CIRCUIT BREAK TESTING.                  
*     ONLY PROCESS LOWEST LEVEL (DETAIL).  THIS WILL PROBABLY                   
*     INVALIDATE THE INITIALIZATION OF HIGHER LEVELS, BUT IT                    
*     SHOULD NOT MATTER, AS THOSE LEVELS WILL NOT BE DISPLAYED.                 
*                                                                               
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
*                                                                               
****     BNE   NEXT0535            NO                                           
****     L     R7,THISQWK                                                       
****     USING QWKD,R7                                                          
****     CLI   QWACCOPT,C'A'       YES - ACCOUNTING OPTION?                     
****     DROP  R7                                                               
*                                                                               
         BE    NEXT0537            YES - DON'T TEST MORE BREAKS                 
NEXT0535 EQU   *                                                                
         EX    RE,NEXR2240         ANOTHER BREAK?                               
         BNE   NEXT0540            YES                                          
NEXT0537 EQU   *                                                                
         MVC   REC,NEWREC          NO  - MOVE TO PROCESS                        
         BAS   RE,CBFIRST          INITIALIZE FOR NEW RECORD                    
         B     NEXR1760            AND GO PROCESS                               
         SPACE 1                                                                
* CLEAR MKT TOTAL INDICATORS AT LEVEL LOWER THAN STATION                        
         SPACE 1                                                                
NEXT0540 EQU   *                                                                
         LR    R7,R5               ROW NUMBER JUST COMPLETED                    
         BCTR  R7,0                                                             
         ZIC   RE,RPSTMKTR         STAMKT ROW NUMBER                            
         CR    R7,RE                                                            
         BNL   NEXT0550                                                         
         XC    SVMKTSTA,SVMKTSTA   CLEAR INDICATORS                             
         XC    SVMKT,SVMKT                                                      
         MVI   MKTBYTE,0                                                        
         SPACE 1                                                                
* SET ADDITIONAL TITLES FOR PRINTING *                                          
         SPACE 1                                                                
NEXT0550 LR    R7,R5               GET ROW NUMBER JUST COMPLETED                
         SLL   R7,2                                                             
         L     R6,RPROWNAM(R7)     GET ROWNAME SPEC ADDRESS                     
         CLI   RNLINTYP,1          IS IT A HEADLINE ROW                         
         BNE   NEXT0560            NO                                           
         SPACE 1                                                                
*  LINE IS A HEADLINE ROW - SET ** DISDX TOTALS **  *                           
         SPACE 1                                                                
         L     R6,RPROWNAM-4(R7)   POINT TO PRECEDING SPEC                      
         MVI   FORCEHED,C'Y'       ** WHICH IS SOURCE OF TITLE                  
         MVC   WORK,SPACES                                                      
         MVC   WORK(2),=C'**'                                                   
         ZIC   RE,RNTTLLEN                                                      
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   WORK+3(0),RNTITLE                                                
         LA    RE,WORK+5(RE)                                                    
         MVC   0(9,RE),=C'TOTALS **'                                            
         GOTO1 CENTER,DMCB,WORK,40                                              
         LR    RF,R5               GET ROW NUMBER                               
         BCTR  RF,0                                                             
         MH    RF,=H'132'                                                       
         LA    RF,HEAD4+46(RF)     POINT INTO HEADLINE                          
         ST    RF,HEADADDR         SAVE ADDRESS TO CLEAR AFTER PRINT            
         MVC   0(40,RF),WORK                                                    
         B     NEXT0470                                                         
*                                                                               
NEXT0560 CLI   RNLINTYP,2          TEST MIDLINE                                 
         BNE   NEXT0570                                                         
         B     NEXT0470                                                         
         SPACE                                                                  
* NEXT ROW IS A PRINT LINE *                                                    
         SPACE 1                                                                
NEXT0570 EQU   *                                                                
         L     RE,RPROWDEF(R7)                                                  
         ZIC   RF,4(RE)            SET LENGTH OF FIELD                          
         CLI   4(RE),0             TEST FOR CHOP = 0                            
         BNE   *+8                                                              
         LA    R7,4(R7)            YES - PUT =ALL* TO NEXT ROW                  
         LA    RE,P                POINT TO PRINT LINE                          
         A     RE,RPROWDTA(R7)     ADD DSPL                                     
         LTR   RF,RF               ANY LENGTH OF FIELD?                         
         BZ    NEXT0580            NO  - ZERO LENGTH                            
         EX    RF,SPACEALL         YES - SPACE IT OUT                           
NEXT0580 EQU   *                                                                
         MVC   0(5,RE),=C'*ALL*'                                                
         CLI   OTHRNAME,C'Y'       RANKMAX W/OVRFLOW?                           
         BNE   NEXT0585            NO                                           
         MVC   6(16,RE),=C'MINUS **OTHERS**'                                    
NEXT0585 EQU   *                                                                
         L     RF,RPROWDTA(R7)                                                  
         ST    RF,P3                                                            
         XC    P4(4),P4                                                         
         GOTO1 =A(PUTDOWN),DMCB,1,5,,,(RC)                                      
         B     NEXT0470                                                         
*                                                                               
SPACEALL MVC   0(0,RE),SPACES      SPACE OUT FIELD                              
         EJECT                                                                  
* RECAP COMPLETE - RESTORE ORIGINAL REPORT DATA *                               
         SPACE 1                                                                
NEXT0590 LA    RE,NEWREC(RF)       TEST NEW RECAP START                         
         CLI   0(RE),1                                                          
         BH    NEXT0600            YES - SKIP RESTORE/SAVE                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   THISRPT,SAVERPT                                                  
         XC    SAVERPT,SAVERPT                                                  
         L     R2,THISRPT                                                       
*                                                                               
*                                                                               
*                                                                               
         GOTO1 =A(SETHEAD),DMCB,(RC),(R8)                                       
*                                                                               
         L     R1,ASVTOTS          RESTORE TOTALS                               
         L     R0,ASVTOTX                                                       
         L     R4,ATOTALS                                                       
         BAS   RE,MOVE                                                          
*                                                                               
         L     R1,ASVHEAD          AND HEADLINES                                
         LA    R0,12*132(R1)                                                    
         LA    R4,HEAD1                                                         
         BAS   RE,MOVE                                                          
         MVI   FORCEHED,C'Y'                                                    
         B     NEXT0530                                                         
         EJECT                                                                  
* INITIALIZE FOR NEW RECAP *                                                    
         SPACE 1                                                                
NEXT0600 MVC   FULL,THISRPT        SAVE THISRPT                                 
*                                                                               
         ZIC   R2,0(RE)            GET RECAP REPORT NUM                         
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD)                                           
         A     R2,=A(RPDATA)                                                    
         ST    R2,THISRPT                                                       
         MVC   THISRPT(1),0(RE)    SET CURRENT REPORT NUM                       
*                                                                               
         OC    SAVERPT,SAVERPT     TEST RECAP CURRENTLY IN PROCESS              
         BNZ   NEXT0610                                                         
         MVC   SAVERPT,FULL        SAVE CURRENT REPORT                          
*                                                                               
         L     R1,ATOTALS          MOVE TOTALS TO SVTOTALS                      
         L     R0,ATOTALX                                                       
         L     R4,ASVTOTS                                                       
         BAS   RE,MOVE                                                          
*                                                                               
         LA    R1,HEAD1            SAVE CURRENT HEADLINES                       
         LA    R0,12*132(R1)                                                    
         L     R4,ASVHEAD                                                       
         BAS   RE,MOVE                                                          
*                                                                               
NEXT0610 L     R1,ATOTALS                                                       
         L     R0,ATOTALX                                                       
         BAS   RE,CLEAR                                                         
*                                                                               
*                                                                               
         GOTO1 =A(SETHEAD),DMCB,(RC),(R8)  SET NEW HEADLINES                    
         MVI   FORCEHED,C'Y'                                                    
         MVC   REC,NEWREC          MOVE NEW REC TO PROCESS                      
         B     NEXR1720                                                         
*                                                                               
NEXT0620 DS    0H                                                               
         CLOSE (RGWORK)                                                         
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO 14'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
*                                                                               
         L     RE,VXADDR                                                        
         USING VXADDRD,RE                                                       
         L     RF,VXRCDOWN                                                      
         DROP  RE                                                               
         CLI   0(RF),X'01'                                                      
         BNE   NEXT0630                                                         
         GOTO1 REPORT,DMCB,WORKC,=C'END'                                        
         CLI   RUNMODE,C'S'                                                     
         BE    NEXT0630                                                         
         GOTO1 REPORT,DMCB,WORKC,=C'START'                                      
NEXT0630 EQU   *                                                                
*                                                                               
         CLC   THISCOPY,RPCOPIES                                                
         BL    NEXT0640                                                         
         BAS   RE,ENDLOGO                                                       
         B     NEXTREQ                                                          
NEXT0640 EQU   *                                                                
         ZIC   RE,THISCOPY                                                      
         LA    RE,1(RE)                                                         
         STC   RE,THISCOPY                                                      
*                                                                               
         B     NEXR1280                                                         
         EJECT                                                                  
* PROCESS 'FIRSTS' FOR ROWS FROM CBLEVEL TO RPROWS *                            
         SPACE 2                                                                
CBFIRST  NTR1                                                                   
*                                                                               
         L     RE,VXADDR                                                        
         USING VXADDRD,RE                                                       
         L     RE,VXRCDOWN                                                      
         MVI   OTHRNAME,C'N'       TURN OFF 'OTHER NAME' SWITCH                 
         CLI   0(RE),X'01'                                                      
         BNE   CFIR0010                                                         
         MVC   SVCBLVL,CBLEVEL     SAVE CBLEVEL TEMPORARILY                     
         MVI   CBLEVEL,1                                                        
         DROP  RE                                                               
*                                                                               
CFIR0010 EQU   *                                                                
         ZIC   R7,CBLEVEL                                                       
         BCTR  R7,0                                                             
         SLL   R7,2                                                             
         L     RE,RPROWDEF(R7)                                                  
         CLI   3(RE),16            TEST PRECEDING ROW = RANK                    
         BNE   CFIR0020                                                         
         IC    R7,CBLEVEL          YES - FORCE TO PRINT VALUE                   
         BCTR  R7,0                                                             
         STC   R7,CBLEVEL                                                       
*                                                                               
CFIR0020 ZIC   R7,CBLEVEL          GET CONTROL BREAK NUMBER                     
         SLL   R7,2                                                             
         CLI   RUNMODE,C'S'        SKIP LOGOS FOR SINGLE RUN MODE               
         BE    CFIR0050                                                         
         OC    SAVERPT,SAVERPT                                                  
         BNE   CFIR0050            RECAPPING - FORGET LOGOS                     
*                                                                               
         ICM   R6,7,RPREMPRT+1     IS THERE A REMPRINT SPEC ?                   
         BNZ   CFIR0030                                                         
*****>>> CLI   RPREMPRT,0          NO - HAS LOGO BEEN STARTED ?                 
         CLI   XENDLOGO,0          NO - HAS LOGO BEEN STARTED ?                 
         BE    CFIR0040            NO - START NY LOGO                           
         B     CFIR0050            NO                                           
*                                                                               
CFIR0030 CLC   CBLEVEL,2(R6)       YES - AT THIS LEVEL ?                        
         BNE   CFIR0050                                                         
         ZIC   R1,CBLEVEL                YES - NEW LOGO                         
         MH    R1,=Y(RGROWSZ)                                                   
         LA    R1,REC(R1)                                                       
         MVC   WORK(RGROWSZ-1),0(R1)       GET THE ROW VALUE                    
         BAS   RE,ENDLOGO          FINISH OFF LAST LOGO                         
         CLC   WORK(RGROWSZ-1),XFF   IF EOF, NO MORE LOGOS                      
         BE    CFIR0050                                                         
*                                                                               
CFIR0040 EQU   *                                                                
         GOTO1 =A(STLOGO),DMCB,(RC),(R2)                                        
*                                  START NEW LOGO                               
         MVI   RCREQREP,C'Y'                                                    
         L     RE,THISQWK          A(THIS REQUEST WORK AREA)                    
         USING QWKD,RE                                                          
         PRINT GEN                                                              
         GOTO1 =V(REDREQ),DMCB,(RC),QWREQ   PRINT DETAILS OF REQUEST            
         PRINT NOGEN                                                            
         DROP  RE                                                               
         MVI   RCREQREP,C'N'                                                    
         MVI   FORCEHED,C'Y'                                                    
CFIR0045 EQU   *                                                                
         GOTO1 =A(DOWNHEAD),DMCB,(RC)                                           
*                                  CHECK FOR DOWNLOAD+COL HDG REQUEST           
*                                                                               
CFIR0050 EQU   *                                                                
         L     R6,RPROWDEF(R7)     POINT TO ROWDEF SPEC                         
         TM    5(R6),X'02'         TEST PAGE=1 RESET THIS LEVEL                 
         BZ    *+10                                                             
         MVC   PAGE,=H'1'                                                       
*                                                                               
         L     RE,THISQWK          A(THIS REQUEST WORK AREA)                    
         USING QWKD,RE                                                          
         CLI   QWCOMBO,C'Y'        COMBO REP/STAMKT IN HDG?                     
         BE    CFIR0060            YES - COUNT EVERYTHING                       
         DROP  RE                                                               
*                                                                               
         TM    MKTBYTE,X'20'       DON'T COUNT MKT 'FF' RECORD                  
         BO    CFIR0070                                                         
*                                                                               
         TM    MKTBYTE,X'02'       DON'T COUNT MKT 'FE' RECORD                  
         BO    CFIR0070                                                         
*                                                                               
CFIR0060 EQU   *                                                                
         L     RE,RPCBCTRS(R7)                                                  
         LA    RE,1(RE)            BUMP COUNTER                                 
         ST    RE,RPCBCTRS(R7)                                                  
*                                                                               
CFIR0070 L     R6,RPROWNAM(R7)     POINT TO ROWNAME SPEC                        
         LTR   R6,R6                                                            
         BZ    CFIR0230                                                         
*                                                                               
         USING RNSPECD,R6                                                       
*                                                                               
         GOTO1 AGETNAME                                                         
         BNE   EXIT                                                             
*                                                                               
         CLI   RNLINTYP,1          HEADLINE ROW?                                
         BNE   CFIR0072            NO  - KEEP GOING                             
         CLI   RCDNLOAD,C'Y'       YES - DOWNLOAD REQUEST?                      
         BNE   CFIR0080            NO  - TREAT AS TYPE 1                        
         B     CFIR0150            YES - TREAT AS TYPE 3                        
CFIR0072 EQU   *                                                                
         CLI   RNLINTYP,2          MIDLINE ROW?                                 
         BE    CFIR0130            YES                                          
         CLI   RNLINTYP,3          PRINT LINE ROW?                              
         BE    CFIR0150            YES                                          
         DC    H'0'                TAKE A GUESS...                              
         EJECT                                                                  
* HEADLINE ROW *                                                                
         SPACE 1                                                                
CFIR0080 MVI   FORCEHED,C'Y'                                                    
         ZIC   R4,CBLEVEL                                                       
         BCTR  R4,0                                                             
         MH    R4,=H'132'                                                       
         LA    R4,HEAD4(R4)        ROW 1 DATA GOES ON HEAD 4                    
         ZIC   RE,RNTTLLEN         GET TITLE DATA LENGTH                        
         LTR   RE,RE                                                            
         BZ    CFIR0100                                                         
         BCTR  RE,0                                                             
         EX    RE,CFIR0090                                                      
         B     CFIR0100                                                         
CFIR0090 MVC   0(0,R4),RNTITLE                                                  
*                                                                               
CFIR0100 ZIC   RE,RPMAXTTL         GET MAX TITLE LENGTH                         
         LA    R4,1(RE,R4)         SET NEXT OUTPUT POSITION                     
*                                                                               
         TM    RNDTATYP,2          TEST TO PRINT CODE                           
         BZ    CFIR0120                                                         
*                                                                               
         ZIC   RE,RPMAXCOD                                                      
         BCTR  RE,0                                                             
         EX    RE,CFIR0110                                                      
         B     CFIR0120                                                         
CFIR0110 MVC   0(0,R4),WORK                                                     
*                                                                               
CFIR0120 ZIC   RE,RPMAXCOD                                                      
         LA    R4,1(R4,RE)         SET NEXT OUTPUT POSITION                     
*                                                                               
         TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    CFIR0230                                                         
         MVC   0(24,R4),WORK+8     *** ASSUMES MAX NAME = 24 ***                
         B     CFIR0230                                                         
         EJECT                                                                  
* MIDLINE ROW *                                                                 
         SPACE 1                                                                
CFIR0130 MVI   FORCEMID,C'Y'                                                    
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         LA    R4,MID1                                                          
         ZIC   R0,RPMARGIN                                                      
         AR    R4,R0               ADD DSPL TO LEFT HAND MARGIN                 
         ZIC   RE,RNTTLLEN                                                      
         LTR   RE,RE                                                            
         BZ    CFIR0140                                                         
         BCTR  RE,0                                                             
         EX    RE,CFIR0090                                                      
         LA    R4,2(RE,R4)         SET NEXT PRINT POSN                          
*                                                                               
CFIR0140 EQU   *                                                                
         CLC   WORK(2),=X'FFFF'    'BUDGET' CODE?                               
         BNE   CFIR0144            NO                                           
         CLC   WORK+2(6),=C'BUDGET'                                             
         BE    CFIR0148            YES - WIPE IT OUT                            
*                                     NO CODE TO SHOW                           
CFIR0144 EQU   *                                                                
         TM    RNDTATYP,2          TEST TO PRINT CODE                           
         BO    *+10                                                             
CFIR0148 EQU   *                                                                
         MVC   WORK(8),SPACES                                                   
*                                                                               
         GOTO1 SQUASHER,DMCB,WORK,64   SQUASH PRINT LINE                        
*                                                                               
         L     RE,RPROWDEF(R7)     POINT TO ROWDEF SPEC                         
         IC    RE,4(RE)            GET ROW WIDTH                                
         LTR   RE,RE               TEST WIDTH=0                                 
         BZ    CFIR0230                                                         
         BCTR  RE,0                                                             
         EX    RE,CFIR0110                                                      
*                                                                               
         GOTO1 UNDERLIN,DMCB,(132,MID1),(DASH,MID2)                             
         B     CFIR0230                                                         
         EJECT                                                                  
* PRINT LINE ROW *                                                              
         SPACE 1                                                                
CFIR0150 EQU   *                                                                
         LA    RF,RPROWFLG(R7)     CHECK FOR STAGGER                            
         TM    0(RF),X'80'         STAGGERED ROW?                               
         BNO   CFIR0160            NO                                           
         LA    R4,STAGLINE         YES - MOVE TO ALTERNATE LINE                 
         B     CFIR0170                                                         
CFIR0160 EQU   *                                                                
         LA    R4,P                LOAD TO PRIMARY PRINT LINE                   
CFIR0170 EQU   *                                                                
         A     R4,RPROWDTA(R7)     ADD DSPL TO PRINT COL                        
*                                                                               
         TM    RNDTATYP,1          PRINT NAME?                                  
         BO    CFIR0175            YES                                          
         MVC   WORK+8(56),SPACES   NO  - CLEAR NAME                             
CFIR0175 EQU   *                                                                
         CLC   WORK(2),=X'FFFF'    'BUDGET' CODE?                               
         BNE   CFIR0176            NO                                           
         CLC   WORK+2(6),=C'BUDGET'                                             
         BE    CFIR0178            YES - WIPE IT OUT                            
*                                     NO CODE TO SHOW                           
CFIR0176 EQU   *                                                                
         TM    RNDTATYP,2          PRINT CODE?                                  
         BO    CFIR0180            YES                                          
CFIR0178 EQU   *                                                                
         MVC   WORK(8),SPACES      NO  - CLEAR CODE                             
         B     CFIR0200                                                         
*                                                                               
CFIR0180 CLI   BYTE,2              TEST FOR STATION                             
         BE    CFIR0190                                                         
         CLI   BYTE,32             OR STAMKT                                    
         BNE   CFIR0200                                                         
CFIR0190 TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    CFIR0200                                                         
         LA    R1,EXTRAPL          MOVE MARKET TO EXTRA PRINT LINE              
         A     R1,RPROWDTA(R7)                                                  
         MVC   0(19,R1),WORK+8                                                  
         L     RF,RPROWDTA(R7)                                                  
         ST    RF,P3                                                            
         MVC   P4(4),=F'1'                                                      
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    CFIR0192            YES -                                        
         GOTO1 =A(PUTDOWN),DMCB,1,19,,,(RC)                                     
CFIR0192 EQU   *                                                                
         LA    R0,7                FORCE TO ONLY PRINT CODE IN P                
         B     CFIR0210                                                         
*                                                                               
CFIR0200 EQU   *                                                                
         GOTO1 SQUASHER,DMCB,WORK,64   SQUASH PRINT LINE                        
         MVC   DMCB(1),DMCB+4      MOVE SQUASHED LENGTH TO P1                   
*                                                                               
         L     RE,RPROWDEF(R7)     POINT TO ROWDEF SPEC                         
         ZIC   R0,4(RE)            GET ROW WIDTH                                
         LTR   R0,R0               TEST WIDTH=0                                 
         BZ    CFIR0230                                                         
*                                                                               
         TM    5(RE),X'01'         TEST TO FOLD INPUT                           
         BZ    CFIR0210            NO - MOVE AND TRUNCATE                       
         GOTO1 CHOPPER,DMCB,,((R0),(R4)),(C'P',4)                               
         B     CFIR0230                                                         
*                                                                               
CFIR0210 EQU   *                                                                
         LR    RE,R0               GET ROW WIDTH                                
         ST    RE,P2               -STORE FOR PUTDOWN CALL                      
         BCTR  RE,0                                                             
         EX    RE,CFIR0220                                                      
         L     RF,RPROWDTA(R7)                                                  
         ST    RF,P3               TELL PUTDOWN WHERE THE DATA IS               
         XC    P4(4),P4            AND THAT DATA IS PRIMARY LINE                
         GOTO1 =A(PUTDOWN),DMCB,1,,,,(RC)                                       
*                                  CALL PUTDOWN AS TEXT                         
         B     CFIR0230                                                         
CFIR0220 MVC   0(0,R4),WORK *EXECUTED*                                          
*                                                                               
CFIR0230 ZIC   RE,CBLEVEL                                                       
         LA    RE,1(RE)                                                         
         STC   RE,CBLEVEL                                                       
         CLC   CBLEVEL,RPROWS      PROCESS TO ACTUAL ROW - 1                    
         BL    CFIR0020                                                         
         L     RE,VXADDR                                                        
         USING VXADDRD,RE                                                       
         L     RE,VXRCDOWN                                                      
*                                                                               
         DROP  RE                                                               
*                                                                               
         CLI   0(RE),X'01'                                                      
         BNE   CFIR0240                                                         
         MVC   CBLEVEL(1),SVCBLVL                                               
*                                     RELOAD CBLEVEL                            
*                                                                               
CFIR0240 EQU   *                                                                
         B     EXIT                                                             
*                                                                               
         EJECT                                                                  
NEXTEL4  SR    R0,R0                                                            
         ICM   R0,1,1(R4)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R4,R0                                                            
FRSTEL4  CLI   0(R4),0                                                          
         BE    NEXTEL4X                                                         
         CLC   0(1,R4),ELCODE                                                   
         BNE   NEXTEL4                                                          
         BR    RE                                                               
*                                                                               
NEXTEL4X LTR   RE,RE                                                            
         BR    RE                                                               
         EJECT                                                                  
* SUBROUTINE TO TOTAL BUFFER CONTENTS AND PRINT *                               
         SPACE 1                                                                
FORMPRNT NTR1                                                                   
         L     R3,THISQWK                                                       
         USING QWKD,R3                                                          
         ZIC   RE,CBLEVEL          GET ROW NUMBER                               
         BCTR  RE,0                                                             
         MH    RE,=Y(TOTLEN)       X LENGTH OF TOTALS                           
         A     RE,ATOTALS          POINT TO TOTALS FOR THIS ROW                 
         ST    RE,SVTOTROW         AND SAVE                                     
*                                                                               
         ZIC   RE,RPROWS           GET HIGH ROW NUM                             
         BCTR  RE,0                                                             
         CLM   RE,1,CBLEVEL        TEST LOWEST LEVEL BREAK                      
         BE    FPRT0020            YES- ALWAYS PRINT                            
         IC    RE,CBLEVEL          GET ROW NUMBER                               
         SLL   RE,2                                                             
         L     RE,RPCBCTRS+4(RE)   POINT TO ITEM COUNT AT NEXT LEVEL            
         BCTR  RE,0                                                             
         LTR   RE,RE               TEST EXACTLY ONE ITEM                        
         BNZ   FPRT0020                                                         
         MVC   P,SPACES            SINGLE ENTRY: DO NOT PRINT                   
         BAS   RE,CLEARDWN                                                      
         B     FPRT1600                                                         
         SPACE 1                                                                
* CHECK FOR NOTOT SPEC *                                                        
         SPACE 1                                                                
FPRT0020 EQU   *                                                                
         XC    NOTOTS,NOTOTS       CLEAR IND TABLE                              
         ZIC   RE,CBLEVEL                                                       
         SLL   RE,2                                                             
         L     R6,RPROWDEF(RE)                                                  
         CLI   3(R6),16            TEST RANK                                    
         BE    FPRT1600                                                         
         L     R6,RPNOTOTS(RE)                                                  
         LTR   R6,R6                                                            
         BZ    FPRT0060            NO SPEC - PROCESS                            
         ZIC   R0,1(R6)            GET SPEC LENGTH                              
         SH    R0,=H'2'            IF LEN = 2, NO COLS, SUPPRESS ROW            
*        BP    *+14                                                             
         BP    *+18                                                             
         MVC   P,SPACES            MAKE SURE PRINT LINE GETS CLEARED            
         BAS   RE,CLEARDWN                                                      
         B     FPRT1600                                                         
         SPACE 1                                                                
* SET NOTOT TABLE FOR SUPPRESSED COLUMNS *                                      
         SPACE 1                                                                
         LA    R1,2(R6)                                                         
*                                                                               
FPRT0040 ZIC   RE,0(R1)            GET COLUMN NUM                               
         LA    RE,NOTOTS(RE)                                                    
         MVI   0(RE),C'N'                                                       
         LA    R1,1(R1)                                                         
         BCT   R0,FPRT0040                                                      
*                                                                               
FPRT0060 CLI   RPTOTOPT,C'C'                                                    
         BE    FPRT0520                                                         
         CLI   RPREPTYP,C'A'       AVAIL REPORT                                 
         BE    FPRT0520            - SKIP TOTALING                              
         MVI   MONTH,0             SET MONTH=PRIOR                              
*                                                                               
FPRT0080 EQU   *                                                                
         ZIC   R1,MONTH            GET MONTH NUMBER                             
         MH    R1,=Y(TOTROWLN)     X LENGTH OF MONTH ROW                        
         A     R1,SVTOTROW         POINT TO ROW FOR THIS MONTH                  
         LA    RF,TOTROWLN*13      GET DSPL TO TOTAL ROW (M13)                  
         A     RF,SVTOTROW         POINT TO IT                                  
*                                                                               
         SR    R7,R7               CLEAR INDEX                                  
         ZIC   R0,RPCOLS           SET ACTUAL COL COUNT                         
*                                                                               
FPRT0100 L     R6,RPCOLDEF+4(R7)   POINT TO COL SPEC                            
         CLI   6(R6),X'3C'         'CUME' COLUMN?                               
         BE    FPRT0160            YES - ROLL TOTAL: IGNORE PER/YTD             
         CLI   3(R6),1             PERIOD SPEC?                                 
         BNE   FPRT0160            NO  - DON'T ROLL TOTALS                      
         CLI   6(R6),X'46'         'FORCE/REPLACE' COLUMN?                      
         BE    FPRT0120            YES -                                        
         ST    RF,SVRFREG          SAVE RF VALUE                                
         ST    R1,SVR1REG          SAVE R1 VALUE                                
         ST    R0,SVR0REG          SAVE R0 VALUE                                
         GOTO1 =A(SPLACCUM),DMCB,(RC),(R6)                                      
         L     RF,SVRFREG          RESTORE RF VALUE                             
         L     R1,SVR1REG          RESTORE R1 VALUE                             
         L     R0,SVR0REG          RESTORE R0 VALUE                             
         BZ    FPRT0140            ZERO:  NOT SPL - PROCESS                     
         B     FPRT0200            NOT ZERO: SPL DONE                           
FPRT0120 EQU   *                                                                
         L     RE,0(R1,R7)         R1=COL DATA + R7=COL #                       
         LTR   RE,RE               ANY VALUE IN FIELD?                          
         BZ    FPRT0200            NO  - LEAVE IT ALONE                         
         ST    RE,0(RF,R7)         YES - REPLACE IN TOTAL                       
         B     FPRT0200                                                         
FPRT0140 EQU   *                                                                
         L     RE,0(R1,R7)         R1=COL DATA + R7=COL #                       
         A     RE,0(RF,R7)         RF=ROW/MONTH IN TABLE + R7=COL #             
         ST    RE,0(RF,R7)         STORE IT BACK                                
         B     FPRT0200                                                         
         SPACE 2                                                                
FPRT0160 EQU   *                                                                
         CLI   6(R6),X'3C'         'CUME' COLUMN?                               
         BE    FPRT0180            YES - ROLL YTD TO TOTAL                      
         CLI   MONTH,12            TEST DEC                                     
         BE    FPRT0200            YES - DO NOT ROLL YTD TO TOTAL               
FPRT0180 EQU   *                                                                
         L     RE,0(R1,R7)         GET VALUE                                    
         A     RE,TOTROWLN(R1,R7)  ADD TO NEXT ROW                              
         ST    RE,TOTROWLN(R1,R7)                                               
*                                                                               
FPRT0200 LA    R7,4(R7)                                                         
         BCT   R0,FPRT0100                                                      
         CLI   RPFRCACT,C'Y'       FORECAST COLUMN(S) IN REPORT?                
         BNE   FPRT0210            NO                                           
         L     RE,DFORBUCK(R1)     YES - MOVE LAST/FLAG BUCKET ALSO             
         A     RE,DFORBUCK(RF)     ADD WHAT'S ALREADY IN BUCKET                 
         ST    RE,DFORBUCK(RF)     STORE IT IN TOTAL SLOT                       
*                                                                               
FPRT0210 LA    R7,4(R7)                                                         
         ZIC   RE,MONTH                                                         
         LA    RE,1(RE)                                                         
         STC   RE,MONTH                                                         
         CLI   MONTH,13            PROCESS THRU M12                             
         BL    FPRT0080                                                         
*                                                                               
* NOW FIND OUT IF ALL PERIOD COLS ARE ZERO                                      
*                                                                               
         SR    R7,R7               CLEAR INDEX                                  
         ZIC   R0,RPCOLS           SET ACTUAL COL COUNT                         
                                                                                
*                                                                               
FPRT0220 EQU   *                                                                
         L     R6,RPCOLDEF+4(R7)   POINT TO COL SPEC                            
         CLI   3(R6),1             TEST PERIOD SPEC                             
         BNE   FPRT0240                                                         
*                                                                               
FPRT0232 EQU   *                                                                
         L     R6,0(RF,R7)                                                      
         LTR   R6,R6               TEST COL TOTAL FOR ZERO                      
         BNZ   FPRT0280            NOT ZERO - PROCESS THIS LEVEL                
*                                                                               
*   INSUFFICIENT TO CHECK IF TOTAL OF COLUMN IS ZERO:  DETAILS MAY              
*        NET OUT TO ZERO.  NEED TO GO BACK AND SCAN ALL MONTHLY                 
*        ENTRIES FOR THIS COLUMN                                                
*                                                                               
         ST    RF,SVRFREG          SAVE RF VALUE                                
         ST    R1,SVR1REG          SAVE R1 VALUE                                
         ST    R0,SVR0REG          SAVE R0 VALUE                                
         GOTO1 =A(SCANCOL),DMCB,(RC),(R7)                                       
         L     RF,SVRFREG          RESTORE RF VALUE                             
         L     R1,SVR1REG          RESTORE R1 VALUE                             
         L     R0,SVR0REG          RESTORE R0 VALUE                             
         BNZ   FPRT0280            NOT ZERO - PROCESS THIS LEVEL                
*                                                                               
FPRT0240 LA    R7,4(R7)                                                         
         BCT   R0,FPRT0220         BRANCH THROUGH ALL COLS                      
*                                                                               
*                                                                               
         LA    R1,TOTROWLN                                                      
         A     R1,SVTOTROW         M1                                           
         LA    R0,TOTROWLN*13-1                                                 
         A     R0,SVTOTROW         END OF M12                                   
         LR    R7,R1                                                            
         CLI   RPTOTOPT,C'T'       ALLMONTH REPORT?                             
         BNE   FPRT0260            NO  - DO REGULAR CLEAR                       
         OC    RPBCUME(4),RPBCUME  YES - ANY CUME COLUMNS IN REPORT?            
         BZ    FPRT0260            NO  - DO REGULAR CLEAR                       
         GOTO1 =A(PRTCLEAR),DMCB,(RC),(R7),(R0)                                 
*                                  YES - LEAVE CUMES IN THIS ROW                
         B     FPRT0280                                                         
FPRT0260 EQU   *                                                                
         BAS   RE,CLEAR            CLEAR ALL COLS, MONTHS 1-12                  
FPRT0280 DS    0H                                                               
         SPACE 1                                                                
* SAVE CURRENT AND YTD TOTALS IN TOTSAVE *                                      
         SPACE 1                                                                
         SR    R7,R7                                                            
         ZIC   R0,RPCOLS           CYCLE COLS IN REQUEST                        
         XC    TOTSAVE,TOTSAVE                                                  
*                                                                               
FPRT0300 L     R6,RPCOLDEF+4(R7)                                                
         LA    RF,TOTROWLN*13      USE TOTAL ROW FOR PERIOD DATA                
         CLI   3(R6),1             PERIOD SPEC?                                 
         BE    FPRT0320            YES                                          
         CLI   6(R6),X'3C'         NO  - YTD: 'CUME' COLUMN?                    
         BE    FPRT0320            YES - TREAT AS PERIOD                        
         LA    RF,TOTROWLN*12      USE DECEMBER FOR YTD                         
*                                                                               
FPRT0320 A     RF,SVTOTROW                                                      
         L     RE,0(RF,R7)                                                      
         ST    RE,TOTSAVE(R7)                                                   
FPRT0340 EQU   *                                                                
         LA    R7,4(R7)                                                         
         BCT   R0,FPRT0300                                                      
         EJECT                                                                  
* GET QUARTERLY TOTALS IF NEEDED *                                              
         SPACE 1                                                                
         CLI   RCDNLOAD,C'Y'       IS IT A DOWNLOAD REQUEST?                    
         BNE   FPRT0360            NO  - DON'T TEST ACCOUNTING REPORT           
*                                                                               
****     CLI   QWACCOPT,C'A'       DOWNLOAD - IS IT ACCOUNTING REPORT?          
****     BNE   FPRT0360            NO  - CONTINUE TESTING                       
*                                                                               
         CLI   RPTOTOPT,C'Q'       IS IT A QUARTERLY REQUEST?                   
         BE    FPRT0360            YES - DO QUARTERLY TOTALS                    
*                                                                               
         CLI   RPTOTOPT,C'T'       NO  - IS IT AN ANNUAL REQUEST?               
         BNE   FPRT0520            NO  - SKIP TOTALS                            
*                                                                               
*   IF QUARTERLY/ANNUAL REQUEST, SHOW FIGURES, ELSE NO REPORT                   
*      WOULD BE PRODUCED.                                                       
*                                                                               
FPRT0360 EQU   *                                                                
         CLI   RPQTRS,C'Y'                                                      
         BNE   FPRT0520                                                         
*                                                                               
         ZIC   RE,STARTMON           GET START MONTH                            
         SH    RE,QWMONADJ           ADJUST THE MONTH IF NECESSARY              
*                                                                               
FPRT0380 STC   RE,MONTH                                                         
         LA    RE,2(RE)                                                         
         STC   RE,MONTHX                                                        
*                                                                               
         ZIC   RF,MONTHX           GET MONTH END NUMBER                         
         SR    RE,RE                                                            
         D     RE,=F'3'            GIVES QUARTER NUM IN RF                      
         BCTR  RF,0                                                             
         LA    RF,14(RF)           FIRST QUARTER IS M14                         
         MH    RF,=Y(TOTROWLN)     GIVES ROW DISPLACEMENT                       
         A     RF,SVTOTROW         POINT TO QTOT ROW                            
*                                                                               
FPRT0400 ZIC   R1,MONTH                                                         
         MH    R1,=Y(TOTROWLN)     GET DSPL TO THIS ROW                         
         A     R1,SVTOTROW         POINT TO MONTH ROW                           
*                                                                               
         SR    R7,R7               CLEAR INDEX                                  
         ZIC   R0,RPCOLS                                                        
*                                                                               
FPRT0420 L     R6,RPCOLDEF+4(R7)   POINT TO COL SPEC                            
*                                                                               
         CLC   MONTH,MONTHX        TEST LAST MONTH OF QUARTER                   
         BNE   *+12                NO - SKIP QUARTERS ONLY TEST                 
         CLI   RPTOTOPT,C'Q'       TEST QUARTERS ONLY                           
         BE    FPRT0440            YES - ROLL YTD TOO                           
*                                                                               
         CLI   3(R6),1             PERIOD DATA?                                 
         BNE   FPRT0500            NO  - DON'T ROLL TOTALS                      
*                                                                               
FPRT0440 EQU   *                                                                
         CLI   6(R6),70            'FORCE/REPLACE' COLUMN?                      
         BE    FPRT0460            YES -                                        
         ST    RF,SVRFREG          SAVE RF VALUE                                
         ST    R1,SVR1REG          SAVE R1 VALUE                                
         ST    R0,SVR0REG          SAVE R0 VALUE                                
         GOTO1 =A(SPLACCUM),DMCB,(RC),(R6)                                      
         L     RF,SVRFREG          RESTORE RF VALUE                             
         L     R1,SVR1REG          RESTORE R1 VALUE                             
         L     R0,SVR0REG          RESTORE R0 VALUE                             
         BZ    FPRT0480            ZERO:  NOT SPL - PROCESS                     
         B     FPRT0500            NOT ZERO: SPL DONE                           
FPRT0460 EQU   *                                                                
         CLI   QWREQ2,C'A'         'ALLMONTH' REQUEST?                          
         BE    FPRT0500            YES - DON'T DO ANYTHING                      
         L     RE,0(R1,R7)         R1=COL DATA + R7=COL #                       
         LTR   RE,RE               ANY VALUE IN FIELD?                          
         BZ    FPRT0500            NO  - LEAVE IT ALONE                         
         ST    RE,0(RF,R7)         YES - REPLACE IN TOTAL                       
         B     FPRT0500                                                         
FPRT0480 EQU   *                                                                
         L     RE,0(R1,R7)         R1=COL DATA + R7=COL #                       
         A     RE,0(RF,R7)         RF=ROW/MONTH IN TABLE + R7=COL #             
         ST    RE,0(RF,R7)         STORE IT BACK                                
*                                                                               
FPRT0500 LA    R7,4(R7)                                                         
         BCT   R0,FPRT0420                                                      
*                                                                               
         ZIC   RE,MONTH                                                         
         LA    RE,1(RE)                                                         
         STC   RE,MONTH                                                         
         CLC   MONTH,MONTHX                                                     
         BNH   FPRT0400                                                         
*                                                                               
         OC    QWMONADJ,QWMONADJ   TEST FOR MONTH ADJUST                        
         BNZ   *+18                                                             
         CLC   MONTH,ENDMON        NO - TEST REACHED END REQ MONTH              
         BL    FPRT0380                                                         
         B     FPRT0520                                                         
         ZIC   RF,MONTH            YES - RE-ADJUST THE MONTH                    
         AH    RF,QWMONADJ                                                      
         CH    RF,=H'12'                                                        
         BL    FPRT0380                                                         
         SH    RF,=H'12'                                                        
         CLM   RF,1,ENDMON               TEST REACHED END REQ MONTH             
         BL    FPRT0380                                                         
         EJECT                                                                  
* CLEAR ALL MONTHS PRIOR TO REQUEST START *                                     
         SPACE 1                                                                
FPRT0520 ZIC   RF,STARTMON         GET REQUEST START MONTH                      
         SH    RF,QWMONADJ         ADJUST THE MONTH IF NECESSARY                
         LA    RE,1                SET MONTH 1                                  
         CLI   RPTOTOPT,C'Q'       TEST QUARTERS ONLY                           
         BNE   *+8                                                              
         LA    RF,13               SET TO CLEAR M1-M12                          
         CLI   RPTOTOPT,C'T'       TEST TOTALS ONLY                             
         BNE   *+8                                                              
         LA    RF,13               SET TO CLEAR M1-M12                          
         LA    R1,TOTROWLN         SET DSPL TO JAN                              
         A     R1,SVTOTROW         POINT TO JAN                                 
*                                                                               
FPRT0540 CR    RE,RF               TEST REACHED REQUEST START                   
         BNL   FPRT0560                                                         
         XC    0(TOTROWLN,R1),0(R1) CLEAR ROW                                   
         LA    RE,1(RE)             NEXT MONTH                                  
         LA    R1,TOTROWLN(R1)                                                  
         B     FPRT0540                                                         
         SPACE 1                                                                
* CLEAR ALL MONTHS AFTER REQUEST END *                                          
         SPACE 1                                                                
FPRT0560 ZIC   RE,ENDMON           GET REQUEST END MONTH                        
         SH    RE,QWMONADJ         ADJUST THE MONTH IF NECESSAARY               
         BP    *+8                                                              
         LA    RE,12(RE)                                                        
         LA    RE,1(RE)                                                         
         LA    RF,12               SET DEC ROW NUMBER                           
         LR    R1,RE                                                            
         MH    R1,=Y(TOTROWLN)     GET DSPL TO REQ END MONTH +1                 
         A     R1,SVTOTROW         POINT TO THAT ROW                            
*                                                                               
FPRT0580 CR    RE,RF               TEST REACHED M12                             
         BH    FPRT0600                                                         
         XC    0(TOTROWLN,R1),0(R1) CLEAR ROW                                   
         LA    RE,1(RE)             NEXT MONTH                                  
         LA    R1,TOTROWLN(R1)                                                  
         B     FPRT0580                                                         
         EJECT                                                                  
* CALCULATE NUMBER OF LINES TO PRINT *                                          
         SPACE 1                                                                
FPRT0600 EQU   *                                                                
         CLI   RPTOTOPT,C'C'                                                    
         BE    FPRT0740                                                         
         LA    R0,18               12 MONTHS + PRIOR + TOT + QTRS               
         L     RE,SVTOTROW         POINT TO TOTALS                              
*                                                                               
         SR    RF,RF               CLEAR COUNTER                                
         OC    0(TOTROWLN,RE),0(RE) TEST ANY PRIOR                              
         BZ    *+12                                                             
         LA    RF,1(RF)            ADD A LINE                                   
         B     FPRT0620                                                         
         CLC   EXTRAPL,SPACES      TEST FOR EXTRA PRINT LINE                    
         BE    FPRT0620                                                         
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    FPRT0620            YES                                          
         LA    RF,1(RF)            ADD ONE                                      
*                                                                               
FPRT0620 EQU   *                                                                
         CLC   STAGLINE,SPACES     TEST FOR STAGGERED LINE                      
         BE    FPRT0640                                                         
         LA    RF,1(RF)            ADD 1                                        
FPRT0640 OC    0(TOTROWLN,RE),0(RE)  TEST DATA THIS LINE                        
         BZ    FPRT0680                                                         
FPRT0660 EQU   *                                                                
         LA    RF,1(RF)            BUMP COUNTER                                 
FPRT0680 EQU   *                                                                
         CLI   RPTOTOPT,C'Q'       TEST QUARTERS ONLY                           
         BE    FPRT0700            YES - NO SPACES                              
         CH    R0,=H'4'            TEST QUARTER TOT                             
         BH    FPRT0700            NO                                           
         LA    RF,1(RF)            BUMP FOR SPACE BETWEEN                       
FPRT0700 LA    RE,TOTROWLN(RE)     NEXT LINE                                    
         BCT   R0,FPRT0640                                                      
*                                                                               
*   CHECK TO SEE IF COMMENTS ARE TO BE DISPLAYED WITH THE DATA                  
*     IF YES, SEE HOW MANY (AND WHAT TYPE) COMMENTS THEY ARE.                   
*                                                                               
         TM    RPFLAGS,X'02'       'COMMENT' REPORT?                            
         BNO   FPRT0720            NO                                           
         ST    RF,DUB              SAVE VALUE IN RF                             
         GOTO1 =A(COMMENTS),DMCB,(RC),(R2)                                      
         L     RF,DUB              RESTORE VALUE IN RF                          
FPRT0720 EQU   *                                                                
         MVI   PRTSW,0             CLEAR PRINT SWITCH                           
         SPACE 1                                                                
* SEE IF ENOUGH REMAINING LINES *                                               
         SPACE 1                                                                
         ZIC   RE,MAXLINES         USABLE LINES                                 
         ZIC   R0,LINE             CURRENT LINE                                 
         SR    RE,R0               GIVES REMAINING LINES                        
         CR    RE,RF               COMPARE TO REQUIRED LINES                    
         BH    *+8                 ALLOWING FOR 1 SPACE BETWEEN                 
         MVI   LINE,99             FORCE PAGE                                   
*                                                                               
FPRT0740 DS    0H                                                               
         MVI   MONTH,0                                                          
*                                                                               
FPRT0760 NI    PRTSW,X'FE'         TURN OFF 'PRINT CURRENT'                     
         ZIC   R5,MONTH                                                         
         MH    R5,=Y(TOTROWLN)     X LENGTH OF MONTH ROW                        
         A     R5,SVTOTROW         ADD ROWTOT ADDRESS                           
*                                                                               
FPRT0780 SR    R7,R7               CLEAR INDEX                                  
*                                                                               
         LA    R0,RGCOLMAX                                                      
         LR    R1,R5                                                            
         LA    RE,NOTOTS+1         POINT TO COL 1 IND                           
*                                                                               
FPRT0800 CLI   0(RE),C'N'                                                       
         BNE   *+8                                                              
         XC    0(4,R1),0(R1)       CLEAR SUPPRESSED VALUE                       
         LA    R1,4(R1)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,FPRT0800                                                      
*                                                                               
         LA    RE,NOTOTS+1         POINT TO COL 1 NOTOTS INDICATOR              
         ST    RE,ANOTOTS                                                       
         B     FPRT0810                                                         
*                                                                               
ANOTOTS  DS    F                                                                
*                                                                               
FPRT0810 EQU   *                                                                
         OC    0(TOTROWLN,R5),0(R5) TEST DATA                                   
         BZ    FPRT1380                                                         
*                                                                               
FPRT0820 EQU   *                                                                
         MVI   COMPFLAG,C'N'       SET 'NOT COLCOMP'                            
         L     RF,ANOTOTS                                                       
         CLI   0(RF),C'N'          COLUMN SET TO NOTOTS?                        
         BE    FPRT0880            YES - DON'T TEST COLCOMP                     
*                                                                               
         L     R6,RPCOLCOM+4(R7)                                                
         LTR   R6,R6               TEST COLCOMP THIS COL                        
         BZ    FPRT0880            NO                                           
*                                                                               
         MVI   PCTADJ,0            RESET ADJ FACTORS                            
         CLI   MONTH,0             TEST PRIOR                                   
         BE    FPRT0860                                                         
         CLI   MONTH,12            TEST TOTALS OR HIGHER                        
         BH    FPRT0860                                                         
         ZIC   RE,MONTH                                                         
         ZIC   R1,2(R6)            GET FIRST COLCOMP ARGUMENT                   
         SLL   R1,2                                                             
         L     R1,RPCOLDEF(R1)     GET ITS COLDEF SPEC                          
         CLI   3(R1),1             TEST FOR PERIOD                              
         BE    FPRT0840                                                         
         CLI   3(R1),2             TEST FOR YTD                                 
         BE    *+6                                                              
         DC    H'0'                                                             
         LA    R1,RPPWKYTD-1(RE)                                                
         MVC   PCTADJ(1),0(R1)     SET PRIOR WEEKS YTD                          
         LA    R1,RPCWKYTD-1(RE)                                                
         MVC   PCTADJ+1(1),0(R1)   SET CURRENT WEEKS YTD                        
         B     FPRT0860                                                         
*                                                                               
FPRT0840 LA    R1,RPPRIWKS-1(RE)                                                
         MVC   PCTADJ(1),0(R1)     SET PRIOR WEEKS                              
         NI    PCTADJ,X'0F'        DROP ZONE BITS                               
         LA    R1,RPCURWKS-1(RE)                                                
         MVC   PCTADJ+1(1),0(R1)   SET CURRENT WEEKS                            
         NI    PCTADJ+1,X'0F'      DROP ZONE BITS                               
*                                                                               
FPRT0860 EQU   *                                                                
         GOTO1 =A(COMP),DMCB,(RC),(R7)                                          
*                                  PROCESS COLCOMP SPEC                         
         MVI   COMPFLAG,C'Y'       SET 'COLCOMP'                                
         B     FPRT1120                                                         
*                                                                               
FPRT0880 EQU   *                                                                
         GOTO1 =A(SPLSETUP),DMCB,(RC),(R2),(R5),(R7)                            
         GOTO1 =A(SPLMAIN),DMCB,(RC),(R2),(R5),(R7)                             
         L     RF,RPCOLDEF+4(R7)   A(COLUMN DEF SPEC)                           
         LA    RE,0(R5,R7)         POINT TO DATA                                
         ICM   R0,15,0(RE)            AND ROUND                                 
         BZ    FPRT0960            TEST FOR ZERO                                
         CLI   6(RF),52            SPL/CURRENT COLUMN?                          
         BE    FPRT0900            YES - DON'T ROUND                            
         CLI   6(RF),53            SPL/PRIOR   COLUMN?                          
         BE    FPRT0900            YES - DON'T ROUND                            
         CLI   6(RF),62            SPL/THIS WEEK COLUMN?                        
         BE    FPRT0900            YES - DON'T ROUND                            
         CLI   6(RF),76            SPL/THIS WEEK LAST YR COLUMN?                
         BE    FPRT0900            YES - DON'T ROUND                            
         CLI   6(RF),85            SPL/CURRENT/MAIN COLUMN?                     
         BE    FPRT0900            YES - DON'T ROUND                            
         CLI   6(RF),86            SPL/PRIOR/MAIN COLUMN?                       
         BE    FPRT0900            YES - DON'T ROUND                            
         CLI   6(RF),87            SPL/THIS WEEK/MAIN COLUMN?                   
         BE    FPRT0900            YES - DON'T ROUND                            
         CLI   6(RF),78            SPL LOSS COLUMN?                             
         BE    FPRT0940            YES - DON'T ROUND                            
         CLI   RPREPTYP,C'A'       NO ROUNDING FOR AVAILS                       
         BE    FPRT0940                                                         
         CLI   RPMONEY,2           TEST FOR ROUNDED DOLLARS                     
         BE    FPRT0940                                                         
         CLC   =C'SJ',QREP         EXCEPT FOR SJR                               
         BE    FPRT0940                                                         
         MVC   FULL,=F'1000'       ROUND TO 1000'S FROM DOLLARS                 
         CLI   RPMONEY,1                                                        
         BNE   *+10                                                             
         MVC   FULL,=F'100'        ROUND TO DOLLARS FROM PENNIES                
         SR    R1,R1                                                            
         SRDA  R0,31                                                            
         D     R0,FULL                                                          
         LTR   R1,R1                                                            
         BM    *+8                                                              
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
         LTR   R0,R1                                                            
         BZ    FPRT0960                                                         
         B     FPRT0940                                                         
*                                                                               
*                                  SPL GETS 1-DECIMAL EDITING                   
FPRT0900 MVI   PRTSW,X'81'         SET PRINT TOT AND CUR                        
         MVC   FLD,SPACES          CLEAR FIELD                                  
         CLI   RCDNLOAD,C'Y'       IS IT A DOWNLOAD REQUEST?                    
         BE    FPRT0920            YES                                          
         EDIT  (R0),(15,FLD),1,MINUS=YES                                        
         B     FPRT1080            EQU                                          
FPRT0920 EQU   *                                                                
         EDIT  (R0),(14,FLD),1,FLOAT=-                                          
         B     FPRT1080                                                         
*                                                                               
FPRT0940 MVI   PRTSW,X'81'         SET PRINT TOT AND CUR                        
*                                                                               
FPRT0960 EQU   *                                                                
         CLI   RCDNLOAD,C'Y'       IS IT A DOWNLOAD REQUEST?                    
         BE    FPRT1020            YES                                          
         CLI   4(RF),0             NO  - ANY DECIMAL PLACES?                    
         BNE   FPRT0980            YES                                          
**>>> FORECAST EDITING CHECK                                                    
         CLI   RPFRCACT,C'Y'       FORECAST COLUMNS IN REPORT?                  
         BNE   FPRT0978            NO                                           
         L     R1,RPCOLDEF+4(R7)   YES - A(COLUMN DEF SPEC)                     
         CLI   6(R1),44            FORECAST CURRENT COLUMN?                     
         BE    FPRT0962            YES                                          
         CLI   6(R1),45            FORECAST PRIOR   COLUMN?                     
         BE    FPRT0962            YES                                          
         CLI   6(R1),67            TRUE FORECAST CURRENT COLUMN?                
         BE    FPRT0962            YES                                          
         CLI   6(R1),68            TRUE FORECAST PRIOR   COLUMN?                
         BNE   FPRT0978            NO                                           
FPRT0962 EQU   *                                                                
         OC    DFORBUCK(4,R5),DFORBUCK(R5)                                      
*                                  LAST BUCKET NOT ZERO:  THIS                  
*                                     IS THE $0 EXPLICIT FORECAST               
*                                        ENTRY INDICATOR                        
         BZ    FPRT0978            NO EXPLICIT $0 ENTERED                       
         EDIT  (R0),(16,FLD),ZERO=NOBLANK,MINUS=YES                             
*                                  $0 ENTERED:  DISPLAY 0                       
*                                                                               
*   FORECAST $$ WILL NOT SHOW DECIMALS.  THEREFORE, THIS CODE IS                
*        NOT CARRIED DOWN INTO ANY OTHER ROUTINES.                              
*                                                                               
         B     FPRT1080                                                         
*                                                                               
DFORBUCK EQU   (RGCOLMAX*4)-4                                                   
*                                                                               
FPRT0978 EQU   *                                                                
**>>> FORECAST EDITING CHECK                                                    
         EDIT  (R0),(16,FLD),MINUS=YES                                          
         B     FPRT1080                                                         
FPRT0980 EQU   *                                                                
         CLI   4(RF),1             1 DECIMAL PLACE?                             
         BNE   FPRT1000            YES                                          
         EDIT  (R0),(16,FLD),1,MINUS=YES                                        
         B     FPRT1080            EQU                                          
FPRT1000 EQU   *                   MUST BE 2 DECIMAL PLACES                     
         EDIT  (R0),(16,FLD),2,MINUS=YES                                        
         B     FPRT1080            EQU                                          
FPRT1020 EQU   *                                                                
         CLI   4(RF),0             ANY DECIMAL PLACES?                          
         BNE   FPRT1040            YES                                          
         EDIT  (R0),(15,FLD),FLOAT=-                                            
         B     FPRT1080                                                         
FPRT1040 EQU   *                                                                
         CLI   4(RF),1             1 DECIMAL PLACE?                             
         BNE   FPRT1060            YES                                          
         EDIT  (R0),(15,FLD),1,FLOAT=-                                          
         B     FPRT1080                                                         
FPRT1060 EQU   *                   MUST BE 2 DECIMAL PLACES                     
         EDIT  (R0),(15,FLD),2,FLOAT=-                                          
FPRT1080 EQU   *                                                                
         CLI   FLD+15,C'-'         MINUS SIGN ON LINE?                          
         BE    FPRT1100            YES - LEAVE AS IS                            
         MVI   FLD+15,C' '         BLANK LAST POSITION                          
FPRT1100 EQU   *                                                                
         CLI   MONTH,13            TEST TOTAL PRINTING                          
         BL    FPRT1120                                                         
         LTR   R0,R0               TEST DATA OR NEGATIVE                        
         BNP   FPRT1120                                                         
         CLI   RPTOTOPT,C'T'       TEST TOTALS ONLY                             
         BE    FPRT1120                                                         
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    FPRT1120            YES - NO 'TOTAL' FLAG                        
         MVI   FLD+15,C'*'         SET TOTAL FLAG                               
*                                                                               
FPRT1120 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        MVC   P+1(09),=C'FPRT1120='                                            
*        MVC   P+9(16),FLD                                                      
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         CLI   RCTRACE,C'Z'        'BROWSER' FILE RUN + PRINTOUT?               
         BE    FPRT1125            YES                                          
         CLI   RCTRACE,C'B'        'BROWSER' RUN?                               
         BNE   FPRT1130            NO                                           
FPRT1125 EQU   *                                                                
         L     R6,RPCOLDEF+4(R7)   POINT TO COLDEF                              
         ZIC   RE,9(R6)            GET COL WIDTH                                
         LTR   RE,RE               IS COL WIDTH ZERO?                           
         BZ    FPRT115A            YES - DON'T PROCESS THIS COLUMN              
         GOTO1 =A(BROWZELT),DMCB,(RC)                                           
FPRT1130 EQU   *                                                                
         L     R6,RPCOLDEF+4(R7)   POINT TO COLDEF                              
         ZIC   RE,9(R6)            GET COL WIDTH                                
         LTR   RE,RE               IS COL WIDTH ZERO?                           
         BZ    FPRT115A            YES - DON'T PROCESS THIS COLUMN              
         LA    RF,16               STANDARD DEFAULT IF NOT                      
*                                     COLCOMP + DOWNLOAD                        
         CLI   RCDNLOAD,C'Y'       IS IT A DOWNLOAD REQUEST?                    
         BNE   FPRT1135            NO                                           
         CLI   COMPFLAG,C'Y'       YES - IS IT A COLCOMP?                       
         BNE   FPRT1135            NO                                           
         LA    RF,15               YES - ADJUST FLD 1 CHARACTER LEFT            
FPRT1135 EQU   *                                                                
         SR    RF,RE                                                            
         BNM   *+6                                                              
         SR    RF,RF               COL EXCEEDS MAX WIDTH                        
         LA    R1,FLD(RF)          GIVES 'FROM' ADDRESS                         
*                                                                               
*      COLUMN SPEC      REPORT TYPE      SET TO SPACES?                         
*      -----------      -----------      --------------                         
*      FORCE ROW        NOT 'AGGBAS'          YES                               
*      FORCE ROW            'AGGBAS'          NO                                
*      FORCE ROW DELM   ALL                   YES                               
*                                                                               
*    WHERE REPORT IS A BASE REPORT:                                             
*      FORCE ROWS HAVE RECEIVED VALUES FROM COMPLEMENTARY ROWS                  
*      IN 'AGGREGATE' REPORT                                                    
*                                                                               
         CLI   6(R6),51            IS COLUMN 'FORCE ROW DELIMITER'?             
         BE    FPRT1140            YES - SPACE IT OUT                           
         CLI   6(R6),41            IS COLUMN 'FORCE ROW'?                       
         BNE   FPRT1150            NO  -                                        
         OC    RPAGGBAS,RPAGGBAS   YES - IS THIS A 'BASE' REPORT?               
         BNZ   FPRT1150            YES - PASS THRU PRESENT VALUE                
FPRT1140 EQU   *                                                                
         BCTR  RE,0                DECREMENT FOR EXECUTE STATEMENT              
         EX    RE,MVSPC            LOAD FIELD WITH SPACES                       
         LA    RE,1(RE)            RESET LENGTH VALUE                           
FPRT1150 EQU   *                                                                
*                                                                               
         LA    R4,P                                                             
         A     R4,RPCOLDTA+4(R7)   GIVES 'TO' ADDRESS                           
*                                                                               
         BCTR  RE,0                                                             
         EX    RE,MVFLD                                                         
         LA    RE,1(RE)                                                         
         ST    RE,P2                                                            
         L     RE,RPCOLDTA+4(R7)                                                
         ST    RE,P3                                                            
         XC    P4(4),P4                                                         
         PRINT GEN                                                              
         GOTO1 =A(PUTDOWN),DMCB,0,,,,(RC)                                       
*                                  CALL PUTDOWN WITH NUMERIC                    
         PRINT NOGEN                                                            
*                                                                               
FPRT115A EQU   *                                                                
         L     RF,ANOTOTS          BUMP TO NEXT NOTOT INDICATOR                 
         LA    RF,1(RF)                                                         
         ST    RF,ANOTOTS          SAVE IT                                      
         LA    R7,4(R7)            NEXT INDEX                                   
         LA    R0,4(R7)            GET INDEX+4                                  
         SRL   R0,2                DIVIDE BY 4 FOR COL NUM                      
                                                                                
         CLM   R0,1,RPCOLS         COMPARE TO MAX COL THIS RPT                  
         BNH   FPRT0820                                                         
*                                                                               
*   FOR 'BROWSER RUN', WRITE VARIABLE LENGTH RECORD FROM KTZREC                 
*        TO BROWSER FILE.                                                       
*                                                                               
         CLI   RCTRACE,C'Z'        'BROWSER' FILE RUN + PRINTOUT?               
         BE    FPRT1151            YES                                          
         CLI   RCTRACE,C'B'        'BROWSER' RUN?                               
         BNE   FPRT1170            NO                                           
FPRT1151 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        MVC   P+1(06),=C'MONTH='                                               
*        MVC   P+7(2),MONTH                                                     
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         OC    ADATEOP,ADATEOP     ANY VALUE IN DATE?                           
         BZ    FPRT1160            NO  - SKIP SETTING DATE                      
         L     R1,ADATEOP          SET A(DATE IN O/P RECORD)                    
         MVC   0(1,R1),QWCURST     INSERT CURRENT START PERIOD YEAR             
*                                                                               
*   IF DATE IS IN FORMAT X'6083' (FOR EXAMPLE), THE RECORD IS TO                
*        BE CONSIDERED A TOTAL.  THIS WILL BE INDICATED BY THE                  
*        THIRD DATE POSITION BEING SET TO 1, WHILE THE INDICATOR                
*        BIT IS TURNED OFF.  THIS WILL PRESERVE THE SORT SEQUENCE               
*        OF THE DATA WHEN IT IS REUSED BY THE BROWSER LOAD.                     
*                                                                               
         MVC   WORK+48(1),MONTH    SET UP WORK AREA FOR DATE                    
         MVI   2(R1),0             CLEAR THIRD BYTE OF DATE                     
         CLI   WORK+48,X'0D'       TOTAL RECORD?                                
         BE    FPRT1152            YES                                          
         TM    WORK+48,X'80'       DATE: HIGH ORDER ON?                         
         BNO   FPRT1154            NO                                           
         NI    WORK+48,X'7F'       YES - TURN IT OFF                            
FPRT1152 EQU   *                                                                
         MVI   2(R1),1             SET THIRD BYTE OF DATE                       
*                                                                               
FPRT1154 EQU   *                                                                
         ZIC   RE,WORK+48          GET MONTH NUMBER                             
         CLI   WORK+48,X'0D'       TOTAL RECORD?                                
         BE    FPRT1156            YES                                          
         AH    RE,QWMONADJ         ADJUST MONTH IF NEEDED                       
         CH    RE,=H'12'           AFTER DECEMBER?                              
         BNH   FPRT1158            NO                                           
         SH    RE,=H'12'           YES - BRING IT BACK INTO YEAR                
FPRT1156 EQU   *                                                                
         ZIC   RF,QWCURST          BUMP TO NEXT YEAR                            
         LA    RF,1(RF)                                                         
         STC   RF,0(R1)            OVERRIDE CURR PERIOD START YEAR              
*                                     WITH NEXT START YEAR                      
FPRT1158 EQU   *                                                                
         STC   RE,1(R1)            INSERT MONTH INTO OUTPUT RECORD              
*                                                                               
FPRT1160 EQU   *                                                                
         GOTO1 =A(KTZCODE),DMCB,(RC)                                            
FPRT1170 EQU   *                                                                
* FORMAT MONTH NAME + NUMBER OF WEEKS *                                         
         SPACE 1                                                                
         ZIC   RF,RPMONTHS         GET MONTH SPEC DISL                          
         L     RF,RPROWDEF(RF)     POINT TO MONTH ROWDEF SPEC                   
         MVC   ROWIDTH,4(RF)       SAVE THE ROW WIDTH                           
         MVC   WORK,SPACES                                                      
         CLI   RPTOTOPT,C'Q'       TEST QUARTERS ONLY                           
         BNE   FPRT1200                                                         
         TM    MONTH,X'80'         TEST QTR TOT                                 
         BZ    FPRT1180                                                         
         MVC   WORK(3),=C'QTR'                                                  
         MVC   WORK+4(1),QTR                                                    
         B     FPRT1320                                                         
FPRT1180 MVC   WORK(5),=C'PRIOR'                                                
         CLI   MONTH,0                                                          
         BE    FPRT1320                                                         
         MVC   WORK(6),=C'TOTAL*'                                               
         MVI   SPACING,2           SET FOR SPACE AFTER                          
         CLI   MONTH,13                                                         
         BE    FPRT1320                                                         
         DC    H'0'                                                             
*                                                                               
FPRT1200 CLI   MONTH,0             TEST PRIOR                                   
         BNE   FPRT1240                                                         
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    FPRT1220            YES - EXTRA WON'T PRINT                      
         CLC   EXTRAPL,SPACES      TEST FOR NEXT LINE SPACES                    
         BNE   FPRT1240                                                         
FPRT1220 EQU   *                                                                
         MVI   SPACING,2           SET FOR SPACE AFTER                          
*                                                                               
FPRT1240 TM    MONTH,X'80'         TEST PRINTING QTR TOTS                       
         BZ    FPRT1260                                                         
         MVI   SPACING,2           SET FOR SPACE AFTER                          
*                                                                               
         MVC   WORK(11),=C'QTR1 TOTALS'                                         
         MVC   WORK+3(1),QTR       MOVE QTR NUM                                 
         CLI   ROWIDTH,11                                                       
         BNL   FPRT1320                                                         
         MVC   WORK+5(6),SPACES                                                 
         B     FPRT1320                                                         
*                                                                               
FPRT1260 CLI   RPTOTOPT,C'C'       TEST CURRENT MONTH ONLY                      
         BE    FPRT1360                                                         
         CLI   MONTH,13            TEST TOTALS                                  
         BNE   FPRT1280                                                         
         CLI   RPTOTOPT,C'T'       TEST TOTALS ONLY                             
         BE    FPRT1360                                                         
         MVI   SPACING,2           SET FOR SPACE AFTER                          
         MVC   WORK(10),=C'* TOTALS *'                                          
         CLI   ROWIDTH,6                                                        
         BH    FPRT1320                                                         
         MVC   WORK(6),=C'TOTAL*'                                               
         B     FPRT1320                                                         
*                                                                               
FPRT1280 MVC   WORK,SPACES                                                      
         CLI   MONTH,0                                                          
         BNE   *+14                                                             
         MVC   WORK(5),=C'PRIOR'                                                
         B     FPRT1320                                                         
         SR    RF,RF                                                            
         ZIC   RE,MONTH            GET MONTH NUMBER                             
         AH    RE,QWMONADJ         RE-ADJUST MONTH IF NECESSARY                 
         CH    RE,=H'12'                                                        
         BNH   FPRT1285                                                         
         SH    RE,=H'12'                                                        
         LR    RF,RE                                                            
FPRT1285 EQU   *                                                                
*                                                                               
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BNE   FPRT1300            NO                                           
*                                                                               
****     CLI   QWACCOPT,C'A'       YES - ACCOUNTING REPORT?                     
****     BNE   FPRT1300            NO                                           
*                                                                               
*   EDIT MONTH NUMBER INTO OUTPUT, RATHER THAN ALPHA WITH '/'                   
*                                                                               
         LR    R0,RE                                                            
         EDIT  (R0),(2,WORK)                                                    
         OI    WORK,X'F0'          INSERT CHAR 0 IF 1ST POS EMPTY               
         MVC   WORK+2(2),QSTART                                                 
         LTR   RF,RF               TEST FOR SECOND YEAR OF REQUEST              
         BZ    *+10                                                             
         MVC   WORK+2(2),QEND                                                   
         B     FPRT1320                                                         
*                                                                               
FPRT1300 EQU   *                                                                
         BCTR  RE,0                                                             
         MH    RE,=H'3'                                                         
         LA    RE,MONTHS(RE)                                                    
         MVC   WORK(3),0(RE)                                                    
         MVI   WORK+3,C'/'                                                      
         MVC   WORK+4(2),QSTART                                                 
         LTR   RF,RF               TEST FOR SECOND YEAR OF REQUEST              
         BZ    *+10                                                             
         MVC   WORK+4(2),QEND                                                   
*                                                                               
         ZIC   RE,MONTH                                                         
         BCTR  RE,0                                                             
         LA    RF,RPPRIWKS(RE)                                                  
         MVC   WORK+8(1),0(RF)     MOVE PRIOR WEEKS                             
         MVI   WORK+9,C'/'                                                      
         LA    RF,RPCURWKS(RE)                                                  
         MVC   WORK+10(1),0(RF)    MOVE CURRENT WEEKS                           
*                                                                               
FPRT1320 ZIC   RE,ROWIDTH          GET ROW WIDTH                                
         BCTR  RE,0                SET FOR EX                                   
*                                                                               
         ZIC   RF,RPMONTHS         GET MONTH SPEC DSPL                          
         L     RF,RPROWDTA(RF)     GET DSPL FOR MONTH PRINT                     
         ST    RF,P3               TELL PUTDOWN WHERE DATA IS                   
         LA    RF,P(RF)            POINT TO PRINT LINE POSITION                 
         EX    RE,FPRT1340                                                      
         LA    RE,1(RE)                                                         
         ST    RE,P2               TELL PUTDOWN DATA LEN                        
         XC    P4(4),P4            TELL PUTDOWN DATA IS PRIMARY LINE            
         GOTO1 =A(PUTDOWN),DMCB,1,,,,(RC)                                       
*                                  CALL PUTDOWN WITH TEXT                       
         B     FPRT1360                                                         
FPRT1340 MVC   0(0,RF),WORK *EXECUTED*                                          
*                                                                               
FPRT1360 DS    0H                                                               
         B     FPRT1380            ****** NOP CBLEVEL PRINT *****               
         SH    RF,=H'2'                                                         
         MVC   0(1,RF),CBLEVEL                                                  
         OI    0(RF),X'F0'                                                      
**********                                                                      
FPRT1380 TM    PRTSW,X'01'         TEST PRINT CUR LINE                          
         BO    FPRT1400                                                         
         CLI   MONTH,13            TEST TOTAL LINE                              
         BNE   FPRT1500                                                         
         TM    PRTSW,X'80'         TEST PRINT TOT LINE                          
         BZ    FPRT1500            NO                                           
*                                                                               
FPRT1400 CLC   EXTRAPL,SPACES      TEST FOR EXTRA PRINT LINE                    
         BE    FPRT1460                                                         
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    FPRT1460            YES - IGNORE EXTRAPL                         
         CLI   MONTH,0             TEST FOR PRIOR                               
         BE    FPRT1420                                                         
         MVC   PSAVE,P             NO - PRINT EXTRA LINE FIRST                  
         MVC   P,EXTRAPL                                                        
         GOTO1 =A(LOCALREP),DMCB,(RC),1                                         
         MVC   P,PSAVE                                                          
         B     FPRT1440                                                         
*                                                                               
FPRT1420 MVC   PSECOND,EXTRAPL     YES- PRINT EXTRA LINE SECOND                 
*                                                                               
FPRT1440 MVC   EXTRAPL,SPACES      CLEAR EXTRA PRINT LINE                       
*                                                                               
FPRT1460 EQU   *                                                                
         ZIC   R0,RCSPACE          SAVE OPTIONAL SPACING                        
         CLC   STAGLINE,SPACES     TEST FOR STAGGERED LINE                      
         BE    FPRT1480            NOTHING ON STAGGERED LINE                    
         XC    RCSPACE,RCSPACE     STAGGERED:  SINGLE-SPACE 1ST LINE            
FPRT1480 EQU   *                                                                
         GOTO1 =A(LOCALREP),DMCB,(RC),0 PRINT THE LINE                          
         STC   R0,RCSPACE          RESET OPTIONAL SPACING                       
         MVI   PRINTED,C'Y'        PRINTED SOMETHING                            
         CLC   STAGLINE,SPACES     TEST FOR STAGGERED LINE                      
         BE    FPRT1500            NOTHING ON STAGGERLINE                       
         MVC   P,STAGLINE          MOVE AND PRINT STAGGERLINE                   
         MVC   STAGLINE,SPACES     SPACE-FILL THE LINE                          
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         EJECT                                                                  
FPRT1500 EQU   *                                                                
         TM    MONTH,X'80'         TEST PRINTING QTR TOTAL                      
         BO    FPRT1540                                                         
         CLI   RCDNLOAD,C'Y'       IS IT A DOWNLOAD REQUEST?                    
         BNE   FPRT1520            NO  - DON'T TEST ACCOUNTING REPORT           
*                                                                               
****     CLI   QWACCOPT,C'A'       DOWNLOAD - IS IT ACCOUNTING REPORT?          
****     BNE   FPRT1520            NO  - CONTINUE TESTING                       
*                                                                               
         CLI   RPTOTOPT,C'Q'       IS IT A QUARTERLY REPORT?                    
         BE    FPRT1520            YES - DO TOTALS                              
*                                                                               
         CLI   RPTOTOPT,C'T'       IS IT AN ANNUAL REPORT?                      
         BNE   FPRT1540            NO  - SKIP TOTALS                            
*                                                                               
*   IF QUARTERLY/ANNUAL REQUEST, SHOW FIGURES, ELSE NO REPORT                   
*      WOULD BE PRODUCED.                                                       
*                                                                               
FPRT1520 EQU   *                                                                
         CLI   RPQTRS,C'Y'         TEST QTRS ACTIVE                             
         BNE   FPRT1540                                                         
         SR    R0,R0                                                            
         ICM   R0,1,MONTH                                                       
         BZ    FPRT1540                                                         
         AH    R0,QWMONADJ         RE-ADJUST MONTH IF NECESSARY                 
         CH    R0,=H'12'                                                        
         BNH   *+8                                                              
         SH    R0,=H'12'                                                        
         SRDL  R0,32                                                            
         D     R0,=F'3'            GIVES QUARTER NUMBER IN R1                   
         LTR   R0,R0               TEST DIVISIBLE BY 3                          
         BNZ   FPRT1540                                                         
         STC   R1,QTR              SAVE NUMBER                                  
         OI    QTR,X'F0'           MAKE EBCDIC                                  
         OC    QWMONADJ,QWMONADJ   TEST FOR MONTH ADJUST                        
         BZ    *+16                                                             
         IC    R0,MONTH            YES - GET ADJUSTED MONTH                     
         SRDL  R0,32                                                            
         D     R0,=F'3'                                                         
         OI    MONTH,X'80'         SET QTR TOT PRINTING                         
         LA    R5,13(R1)           QTR1 IS M14                                  
         MH    R5,=Y(TOTROWLN)     GET QTR ROW DSPL                             
         A     R5,SVTOTROW         POINT TO ROW                                 
         B     FPRT0780                                                         
*                                                                               
FPRT1540 NI    MONTH,X'7F'         DROP QTR FLAG                                
         ZIC   R1,MONTH                                                         
         LA    R1,1(R1)                                                         
         STC   R1,MONTH                                                         
*                                                                               
*   IF DOWNLOAD, AND TOTAL LINE IS NEXT, SKIP RESET OF LINE DETAILS             
*      AS WELL AS DISPLAY OF LINE.                                              
*                                                                               
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BNE   FPRT1580            NO                                           
*                                                                               
****     CLI   QWACCOPT,C'A'       YES - ACCOUNTING REPORT?                     
****     BNE   FPRT1580            NO                                           
*                                                                               
         CLI   MONTH,13            YES - IS IT TOTAL?                           
         BNE   FPRT1560            NO                                           
         CLI   RPTOTOPT,C'T'       YES - IS IT TOTAL ONLY REPORT?               
         BNE   FPRT1600            NO  - NO RESET OF LINE DETAILS               
*                                    AND SKIP TOTAL PRINT                       
FPRT1560 EQU   *                                                                
         BAS   RE,CBFIRST          NO  - RESET LINE DETAILS                     
*                                     FOR 'PRINT' PURPOSES                      
FPRT1580 EQU   *                                                                
*                                                                               
         CLI   MONTH,13            TEST REACHED TOTALS                          
         BNH   FPRT0760                                                         
*                                                                               
FPRT1600 L     R1,SVTOTROW         POINT TO ROW                                 
         LR    R0,R1                                                            
         AH    R0,=Y(TOTLEN)       POINT TO END                                 
         LR    R7,R1                                                            
         CLI   RPTOTOPT,C'T'       ALLMONTH REPORT?                             
         BNE   FPRT1660            NO  - DO REGULAR CLEAR                       
         OC    RPBCUME(4),RPBCUME  ANY CUME COLUMNS IN REPORT?                  
         BZ    FPRT1660            NO  - DO REGULAR CLEAR                       
FPRT1620 EQU   *                                                                
         CLI   PRINTED,C'Y'        ANYTHING PRINTED FOR ROW?                    
         BNE   FPRT1640            NO                                           
         CLC   CBLEVEL,LSTCBLVL    THIS PRINT AT SAME LEVEL?                    
         BNL   FPRT1640            YES, OR LOWER - NO CLEAR                     
         BAS   RE,CLRCUMES         NO  - CLEAR CUME AT LOWER LVL                
FPRT1640 EQU   *                                                                
         ZIC   RF,RPROWS           NUMBER OF ROWS                               
         BCTR  RF,0                DECREMENT BY 1?                              
         ZIC   RE,CBLEVEL          LEVEL IN PROGRESS                            
         CR    RF,RE               LAST ROW IN PROGRESS?                        
         BNE   FPRT1660            NO  - DON'T CUME IT                          
         GOTO1 =A(PRTCLEAR),DMCB,(RC),(R7),(R0)                                 
*                                  YES - LEAVE CUME FIGURES                     
         B     FPRT1680                                                         
FPRT1660 EQU   *                                                                
         BAS   RE,CLEAR                                                         
*                                                                               
FPRT1680 EQU   *                                                                
         CLI   PRINTED,C'Y'        TEST IF ANYTHING PRINTED                     
         BE    FPRT1720                                                         
FPRT1700 EQU   *                                                                
*                                                                               
*   START OF TEST                                                               
**       MVC   P(15),=C'NOTHING PRINTED'                                        
**       GOTO1 REPORT                                                           
*   END   OF TEST                                                               
*                                                                               
         ZIC   RF,RPMONTHS         NOTHING PRINTED - CLEAR PRINT LINE           
         SH    RF,=H'4'                    FROM ROW BEFORE MONTH ROW            
         L     RF,RPROWDTA(RF)                                                  
         LA    RE,131                                                           
         SR    RE,RF                                                            
         LA    RF,P(RF)                                                         
         EX    RE,CLRLINE                                                       
         MVC   MID1,SPACES         CLEAR MIDS                                   
         MVC   MID2,SPACES                                                      
         B     FPRT1740                                                         
*                                                                               
FPRT1720 EQU   *                                                                
         MVC   LSTCBLVL,CBLEVEL    SAVE LAST CBLEVEL PRINTED                    
FPRT1740 EQU   *                                                                
         MVI   PRINTED,0                                                        
         ZIC   RE,CBLEVEL                                                       
         SLL   RE,2                                                             
         LA    RE,RPCBCTRS+4(RE)                                                
         XC    0(4,RE),0(RE)       CLEAR ITEM COUNT FOR NEXT LEVEL              
         TM    RPFLAGS,X'02'       'COMMENT' REPORT?                            
         BNO   EXIT                NO  -                                        
         ZIC   RE,RPROWS           HIGHEST ROW NUMBER                           
         BCTR  RE,0                MAKE ZERO RELATIVE                           
         CLM   RE,1,CBLEVEL        IS LOWEST LEVEL IN PROCESS?                  
         BNE   EXIT                NO  - DON'T SHOW COMMENTS                    
         GOTO1 =A(SHOWCMTS),DMCB,(RC)                                           
*                                  YES - DISPLAY COMMENTS                       
         B     EXIT                                                             
         DROP  R3                                                               
*                                                                               
MVFLD    MVC   0(0,R4),0(R1)                                                    
MVSPC    MVC   0(0,R1),SPACES      SET TO SPACES                                
CLRLINE  MVC   0(0,RF),SPACES                                                   
*                                                                               
PRINTED  DC    X'00'                                                            
         EJECT                                                                  
*                                                                               
*   CLEAR OUT THE CUMES AT A LOWER PRINT LEVEL                                  
*                                                                               
CLRCUMES NTR1                                                                   
         OC    CLEARR1,CLEARR1     ANY VALUES?                                  
         BZ    CCUM0020            NO  - SKIP CLEAR                             
         L     R1,CLEARR1          SET A(START OF CLEAR)                        
         L     R0,CLEARR0          SET A(END   OF CLEAR)                        
         BAS   RE,CLEAR            CLEAR IT OUT                                 
CCUM0020 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
***********************************************************                     
* SUBROUTINE TO EXTRACT AND PRINT DATA FROM TOTAL RECORDS *                     
* R6 HAS A(TOTPRT SPEC)                                   *                     
* R7 HAS INDEX TO ROW                                     *                     
***********************************************************                     
         SPACE 1                                                                
FTOT     NTR1                                                                   
         STM   R6,R7,FTOTR6                                                     
*                                                                               
FTOT0010 MVI   SKIPTOT,C'N'                                                     
         LA    R0,RGROWMAX                                                      
         LA    RE,REC+RGROWSZ                                                   
         LA    R1,RPROWDEF+4                                                    
FTOT0020 L     RF,0(R1)                                                         
         CLC   3(1,RF),3(R6)                                                    
         BE    FTOT0030                                                         
         LA    RE,RGROWSZ(RE)                                                   
         LA    R1,4(R1)                                                         
         BCT   R0,FTOT0020                                                      
         DC    H'0'                                                             
FTOT0030 MVC   WORK(8),0(RE)       MOVE DATA VALUE FROM RECORD                  
*                                                                               
         ZIC   RE,3(R6)            GET DATA CODE                                
         BCTR  RE,0                                                             
         SLL   RE,3                X 8                                          
         LA    RF,FINDTAB(RE)                                                   
         MVC   BRADDR1(8),0(RF)    SAVE BRANCH TABLE ADDRS                      
*                                                                               
         L     R4,ASPACND4         POINT TO DATA AREA                           
         ICM   RF,15,BRADDR1       GET FIND ROUTINE ADDRESS                     
         BNZ   *+6                                                              
         DC    H'0'                                                             
         BR    RF                  GO FIND RECORD IN SPACEND                    
*                                                                               
FTOT0040 XC    FLD,FLD             CLEAR OUTPUT AREA                            
         MVC   BYTE,3(R6)          SET ATTRIB 1 DATA CODE                       
         LA    R1,FLD              SET OUTPUT ADDRESS                           
         L     RF,BRADDR2          GET EXTRACT ROUTINE ADDRESS                  
         BR    RF                                                               
*                                                                               
FTOT0050 ICM   RF,15,BRADDR2                                                    
         BZ    FTOT0060            NO MORE EXTRACT                              
         XC    BRADDR2,BRADDR2     SET FOR NO RETURN                            
         MVC   BYTE,4(R6)          SET ATTRIB 2 DATA CODE                       
         CLI   BYTE,0                                                           
         BE    FTOT0060                                                         
         LA    R1,FLD+8            SET OUTPUT ADDRESS                           
         BR    RF                                                               
         SPACE 1                                                                
* TABLE ENTRIES ARE A(FIND RTN),A(EXTRACT RTN) *                                
         SPACE 1                                                                
FINDTAB  DC    A(0,0)              01 REP                                       
         DC    A(FINDSTA,EXTSTA)   02 STA                                       
         DC    A(0,0)              03 RGN                                       
         DC    A(FINDOFF,EXTOFF)   04 OFF                                       
         DC    A(0,0)              05                                           
         DC    A(0,0)              06                                           
         DC    A(FINDGRP,EXTGRP)   07 GRP                                       
         DC    A(0,0)              08                                           
         DC    A(0,0)              09                                           
         DC    A(0,0)              10                                           
         DC    A(FTOT0040,EXTAFF)  11 AFFIL                                     
         DC    A(0,0)              12                                           
         DC    A(0,0)              13                                           
         DC    A(0,0)              14                                           
         DC    A(0,0)              15                                           
         DC    A(0,0)              16                                           
         DC    A(0,0)              17                                           
         DC    A(0,0)              18                                           
         DC    A(0,0)              19                                           
         DC    A(0,0)              20                                           
         DC    A(0,0)              21                                           
         DC    A(FINDSTT,EXTSTNTY) 22 STNTYPE                                   
         DC    A(0,0)              23                                           
         DC    A(0,0)              24                                           
         DC    A(FTOT0040,EXTGGRP) 25 GRGRP                                     
         DC    A(0,0)              26                                           
         DC    A(0,0)              27                                           
         DC    A(0,0)              28                                           
         DC    A(0,0)              29                                           
         DC    A(0,0)              30                                           
         DC    A(0,0)              31                                           
         DC    A(FINDSTA,EXTSTA)   32 STAMKT                                    
         DC    A(0,0)              33                                           
         DC    A(0,0)              34                                           
         DC    A(0,0)              35                                           
         DC    A(0,0)              36                                           
         DC    A(0,0)              37                                           
         DC    A(0,0)              38                                           
         DC    A(0,0)              39                                           
         DC    A(0,0)              40 COMPANY                                   
         EJECT                                                                  
FINDSTA  MVC   DUB(5),WORK+2       MAKE FORMAT MATCH SPACEND                    
         CLI   WORK+6,C'T'         TEST TV                                      
         BNE   *+8                                                              
         MVI   DUB+4,C' '                                                       
         CLI   WORK+6,C'V'         TEST 3 CALL LETTERS TV                       
         BNE   *+10                                                             
         MVC   DUB+3(2),SPACES                                                  
         CLI   WORK+6,C'M'         TEST 3 CALL LETTER RADIO                     
         BNE   *+14                                                             
         MVI   DUB+3,C' '                                                       
         MVC   DUB+4(1),WORK+5                                                  
*                                                                               
         MVI   ELCODE,2                                                         
         BAS   RE,FRSTEL4                                                       
         B     *+8                                                              
FSTA2    BAS   RE,NEXTEL4                                                       
         BNE   FINDERR                                                          
         CLC   REC+RGCMPDSP(2),DSTNREP(R4) FIND COMPANY                         
         BNE   FSTA2                                                            
         CLC   DUB(5),DSTNCALL(R4)                                              
         BNE   FSTA2                                                            
         B     FTOT0040            FIND ROUTINE RETURN                          
*                                                                               
EXTSTA   CLI   BYTE,2              TEST ATTRIB = STA                            
         BE    EXTSTA10                                                         
         CLI   BYTE,32             TEST ATTRIB = STAMKT                         
         BNE   EXTSTA20                                                         
EXTSTA10 MVC   0(8,R1),WORK                                                     
         XC    0(2,R1),0(R1)       GET RID OF DISP                              
         B     FTOT0050                                                         
*                                                                               
EXTSTA20 CLI   BYTE,11             TEST ATTRIB=AFFIL                            
         BNE   *+14                                                             
         MVC   0(3,R1),DSTNAFF(R4) STATION AFFIL VALUE                          
         B     FTOT0050            EXTRACT ROUTINE RETURN                       
         DC    H'0'                                                             
*                                                                               
FINDOFF  MVI   ELCODE,4            FIND OFFICE                                  
         BAS   RE,FRSTEL4                                                       
         B     *+8                                                              
FOFF2    BAS   RE,NEXTEL4                                                       
         BNE   FINDERR                                                          
         CLC   REC+RGCMPDSP(2),DOFFREP(R4) FIND COMPANY                         
         BNE   FOFF2                                                            
         CLC   WORK+1(2),DOFFOFF(R4)                                            
         BNE   FOFF2                                                            
         B     FTOT0040            FIND ROUTINE RETURN                          
*                                                                               
EXTOFF   CLI   BYTE,4                                                           
         BNE   *+14                                                             
         MVC   0(3,R1),WORK                                                     
         B     FTOT0050                                                         
         DC    H'0'                                                             
*                                                                               
FINDGRP  MVI   ELCODE,7                                                         
         BAS   RE,FRSTEL4                                                       
         B     *+8                                                              
*                                                                               
FGRP2    BAS   RE,NEXTEL4                                                       
         BNE   FINDERR                                                          
         CLC   WORK(2),2(R4)                                                    
         BNE   FGRP2                                                            
         B     FTOT0040                                                         
*                                                                               
EXTGRP   CLI   BYTE,7              TEST ATTRIB = GRP                            
         BNE   *+14                                                             
         MVC   0(8,R1),WORK                                                     
         B     FTOT0050                                                         
         DC    H'0'                                                             
*                                                                               
EXTAFF   CLI   BYTE,11             TEST ATTRIB = AFFIL                          
         BNE   *+14                                                             
         MVC   0(8,R1),WORK                                                     
         B     FTOT0050                                                         
         DC    H'0'                                                             
*                                                                               
EXTGGRP  CLI   BYTE,25             TEST ATTRIB = GRGRP                          
         BNE   *+14                                                             
         MVC   0(8,R1),WORK                                                     
         B     FTOT0050                                                         
         DC    H'0'                                                             
*                                                                               
FINDSTT  CLI   WORK,C'4'           TEST DATA VALUE = ALL STATIONS               
         BNE   FTOT0040                                                         
         MVI   SKIPTOT,C'Y'        YES - SKIP THIS TOTAL                        
         B     FTOT0140                                                         
*                                                                               
EXTSTNTY CLI   BYTE,22             TEST ATTRIB = STNTYPE                        
         BNE   *+14                                                             
         MVC   0(8,R1),WORK                                                     
         B     FTOT0050                                                         
         DC    H'0'                                                             
         SPACE 2                                                                
FINDERR  DC    H'0'                UNKNOWN VALUE                                
         EJECT                                                                  
* FLD(8) HAS ATTRIB 1 VALUE                                                     
* FLD+8(8) HAS ATTRIB 2 VALUE                                                   
* FIND THE APPROPRIATE TOTAL RECORD *                                           
         SPACE 1                                                                
FTOT0060 DS    0H                                                               
         L     R4,ATOTRECS                                                      
*                                                                               
FTOT0070 CLI   0(R4),0             ANY MORE                                     
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   2(2,R4),3(R6)       MATCH ATTRIBUTE CODES                        
         BNE   FTOT0120                                                         
*                                                                               
         CLI   2(R4),2             IF ATTRIBUTE IS STA OR STAMKT,               
         BE    FTOT0080            COMPARE LAST 6 BYTES                         
         CLI   2(R4),32          I.E. SKIP DISPLACEMENT (1ST 2 BYTES)           
         BNE   FTOT0090                                                         
FTOT0080 CLC   FLD+2(6),RGROWSZ+2(R4)  MATCH VALUE 1                            
         BNE   FTOT0120                                                         
         CLC   FLD+8(8),RGROWSZ*2(R4) MATCH VALUE 2                             
         BE    FTOT0130                                                         
         B     FTOT0120                                                         
*                                                                               
FTOT0090 CLI   3(R4),2                                                          
         BE    FTOT0100                                                         
         CLI   3(R4),32                                                         
         BNE   FTOT0110                                                         
*                                                                               
FTOT0100 CLC   FLD(8),RGROWSZ(R4)  MATCH VALUE 1                                
         BNE   FTOT0120                                                         
         CLC   FLD+10(6),RGROWSZ*2+2(R4) MATCH VALUE 2                          
         BE    FTOT0130                                                         
         B     FTOT0120                                                         
*                                                                               
FTOT0110 CLC   FLD(8),RGROWSZ(R4)  MATCH VALUE 1                                
         BNE   FTOT0120                                                         
         CLC   FLD+8(8),RGROWSZ*2(R4) MATCH VALUE 2                             
         BE    FTOT0130                                                         
*                                                                               
FTOT0120 LA    R4,RGRECLEN(R4)     NEXT TOTREC                                  
         B     FTOT0070                                                         
         SPACE 1                                                                
**** PRINT THE TOTAL LINE(S) ****                                               
         SPACE 1                                                                
FTOT0130 ST    R4,SVTOTREC                                                      
*                                                                               
FTOT0140 L     R6,FTOTR6           GET SPEC ADDRESS                             
         ZIC   R0,1(R6)                                                         
         AR    R6,R0                                                            
         ST    R6,FTOTR6                                                        
*                                                                               
         CLI   0(R6),51            TEST NEW TOTPRT                              
         BNE   FTOT0150                                                         
         CLC   CBLEVEL,2(R6)       YES- IS IT AT SAME LEVEL                     
         BE    FTOT0010                 YES- START AGAIN                        
         B     EXIT                     NO - FINISHED                           
*                                                                               
FTOT0150 CLI   0(R6),52                                                         
         BE    FTOT0160                                                         
         CLI   0(R6),53                                                         
         BE    FTOT0230                                                         
         CLI   0(R6),54                                                         
         BE    FTOT0250                                                         
         CLI   0(R6),55            TOTSAME                                      
         BNE   EXIT                                                             
         LA    R5,TOTSAVE          POINT TO CURRENT TOTALS                      
         SR    R7,R7                                                            
         B     FTOT0170                                                         
         EJECT                                                                  
FTOT0160 CLI   SKIPTOT,C'Y'                                                     
         BE    FTOT0140                                                         
         SR    R7,R7                                                            
         L     R5,SVTOTREC         POINT TO TOTAL RECORD                        
         LA    R5,RGDTADSP(R5)     POINT TO DATA                                
         OC    0(RGDTALEN,R5),0(R5)                                             
         BZ    FTOT0140                                                         
*                                                                               
FTOT0170 MVI   PCTADJ,0            SUPPRESS PCTADJ                              
         L     R6,RPCOLCOM+4(R7)   TEST FOR COLCOMP                             
         LTR   R6,R6                                                            
         BZ    FTOT0180                                                         
         GOTO1 =A(COMP),DMCB,(RC),(R7)                                          
         B     FTOT0210                                                         
*                                                                               
FTOT0180 LA    RE,0(R5,R7)                                                      
         ICM   R0,15,0(RE)                                                      
         CLI   RPMONEY,2           TEST FOR ROUNDED DOLLARS                     
         BE    FTOT0190                                                         
         CLC   =C'SJ',QREP                                                      
         BE    FTOT0190                                                         
         MVC   FULL,=F'1000'       ROUND TO 1000'S FROM DOLLARS                 
         CLI   RPMONEY,1                                                        
         BNE   *+10                                                             
         MVC   FULL,=F'100'        ROUND TO DOLLARS FROM PENNIES                
         SR    R1,R1                                                            
         SRDA  R0,31                                                            
         D     R0,FULL                                                          
         LTR   R1,R1                                                            
         BM    *+8                                                              
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
         LR    R0,R1                                                            
FTOT0190 EQU   *                                                                
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    FTOT0200            YES                                          
         EDIT  (R0),(16,FLD),MINUS=YES                                          
         B     FTOT0210                                                         
FTOT0200 EQU   *                                                                
         EDIT  (R0),(15,FLD),FLOAT=-                                            
*                                                                               
FTOT0210 L     R6,RPCOLDEF+4(R7)                                                
         ZIC   RE,9(R6)            GET COL WIDTH                                
         LA    RF,16                                                            
         SR    RF,RE                                                            
         LA    R1,FLD(RF)          GIVES 'FROM' ADDRESS                         
         LA    RF,P                                                             
         A     RF,RPCOLDTA+4(R7)                                                
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(R1)                                                    
*                                                                               
         LA    R7,4(R7)                                                         
         LA    R0,4(R7)                                                         
         SRL   R0,2                                                             
         CLM   R0,1,RPCOLS         COMPARE TO MAX COL THIS RPT                  
         BNH   FTOT0170                                                         
*                                                                               
FTOT0220 ZIC   R1,RPMARGIN         GET DSPL TO LHS                              
         LA    R1,P(R1)            POINT INTO PRINT LINE                        
         L     R6,FTOTR6                                                        
         ZIC   RE,1(R6)            GET SPEC LENGTH                              
         SH    RE,=H'3'            SET FOR EX                                   
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),2(R6) *EXECUTED*                                         
         MVI   SPACING,2                                                        
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         B     FTOT0140                                                         
         SPACE 2                                                                
FTOT0230 CLI   SKIPTOT,C'Y'                                                     
         BE    FTOT0140                                                         
         SR    R7,R7                                                            
         LA    R1,TOTWORK                                                       
         XC    0(RGDTALEN,R1),0(R1)                                             
         L     R4,SVTOTREC                                                      
         LA    R4,RGDTADSP(R4)     POINT TO TOTAL RECORD                        
         LA    R5,TOTSAVE          POINT TO CURRENT TOTALS                      
*                                                                               
FTOT0240 L     R0,0(R4,R7)         GET TOTAL REC DATA                           
         S     R0,0(R5,R7)         LESS CURRENT VALUE                           
         ST    R0,0(R1,R7)         SAVE RESULT                                  
         LA    R7,4(R7)                                                         
         LA    R0,4(R7)                                                         
         SRL   R0,2                                                             
         CLM   R0,1,RPCOLS                                                      
         BNH   FTOT0240                                                         
*                                                                               
         SR    R7,R7                                                            
         LA    R5,TOTWORK                                                       
         B     FTOT0170                                                         
         EJECT                                                                  
FTOT0250 CLI   SKIPTOT,C'Y'                                                     
         BE    FTOT0140                                                         
         L     R4,SVTOTREC                                                      
         LA    R4,RGDTADSP(R4)                                                  
         LA    R5,TOTSAVE                                                       
         SR    R7,R7                                                            
*                                                                               
FTOT0260 L     R1,0(R5,R7)                                                      
         M     R0,=F'2000'         X 100 X 2                                    
         L     RF,0(R4,R7)                                                      
         LTR   RF,RF                                                            
         BZ    FTOT0280                                                         
         DR    R0,RF                                                            
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
         CH    R1,=H'10000'                                                     
         BL    *+14                                                             
         MVC   FLD+12(4),=C'HIGH'                                               
         B     FTOT0270                                                         
         EDIT  (R1),(16,FLD),1                                                  
*                                                                               
FTOT0270 L     RF,RPCOLDEF+4(R7)                                                
         ZIC   RE,9(RF)            GET COL WIDTH                                
         LA    RF,16                                                            
         SR    RF,RE                                                            
         LA    RF,FLD(RF)          GIVES 'FROM' ADDRESS                         
         BCTR  RE,0                GIVES LENGTH                                 
         LA    R1,P                                                             
         A     R1,RPCOLDTA+4(R7)   GIVES 'TO' ADDRESS                           
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(RF) *EXECUTED*                                         
*                                                                               
FTOT0280 LA    R7,4(R7)                                                         
         LA    R0,4(R7)                                                         
         SRL   R0,2                                                             
         CLM   R0,1,RPCOLS                                                      
         BNH   FTOT0260                                                         
         B     FTOT0220                                                         
         EJECT                                                                  
* SUBR TO CLEAR FROM R1 TO R0 *                                                 
         SPACE 1                                                                
CLEAR    NTR1                                                                   
         SR    R0,R1               GIVES LENGTH TO CLEAR                        
         BP    *+6                                                              
         DC    H'0'                                                             
         LA    RF,256                                                           
*                                                                               
CLEAR2   CR    R0,RF                                                            
         BNH   CLEAR4                                                           
         XC    0(256,R1),0(R1)                                                  
         AR    R1,RF                                                            
         SR    R0,RF                                                            
         B     CLEAR2                                                           
CLEAR4   LR    RF,R0                                                            
         BCTR  RF,0                                                             
         EX    RF,CLEARXC                                                       
         XIT1                                                                   
CLEARXC  XC    0(0,R1),0(R1) *EXECUTED*                                         
         EJECT                                                                  
GETEL    CLI   0(R6),0                                                          
         BE    GETELX                                                           
         SR    R0,R0                                                            
         ICM   R0,1,1(R6)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R6,R0                                                            
         CLC   ELCODE,0(R6)                                                     
         BER   RE                  RETURN WITH CC =                             
         B     GETEL                                                            
GETELX   LTR   RE,RE                                                            
         BR    RE                  RETURN WITH CC NOT =                         
         EJECT                                                                  
*                                                                               
*  NOTE:  THE HEAD- AND FOOT-HOOKS ARE CALLED FROM 'REREPORT'.  TO              
*    ESTABLISH THE ADDRESSABILITY, THE REGISTERS FOR THIS MODULE                
*    HAVE BEEN SAVED IN 'SAVEREGS' AT MODULE START-UP.  R2 IS PASSED            
*    IN TO THE ROUTINES, HOWEVER, AND IS SPECIFICALLY RESET FROM                
*    'THISRPT', WHICH IS THE ADDRESS OF THE EXPLODED SPEC.                      
*                                                                               
HEADHK   DS    0H                                                               
*                                                                               
         USING HEADHK,RF              SET ADDRESSABILITY                        
         LA    R1,SAVEREGS-HEADHK                                               
         AR    R1,RF                                                            
         LM    R2,RC,0(R1)                                                      
         DROP  RF                                                               
         L     R2,THISRPT          RESET A(THIS REPORT)                         
*                                                                               
         L     R4,ADCONLST         FIRST ENABLE FOOTHOOK                        
         MVI   FOOTHOOK-ADCONSD(R4),0                                           
*                                                                               
         TM    RPMISFLG+1,X'04'    LEFT ALIGN REPORT?                           
         BO    HDHK20              YES                                          
*                                                                               
         L     RE,FILEC                                                         
         USING RREPREC,RE                                                       
         MVC   HEAD1(33),RREPNAME                                               
         DROP  RE                                                               
*                                                                               
         MVC   HEAD2(11),=C'REQUESTOR -'                                        
         MVC   HEAD2+12(12),QUESTOR                                             
*                                                                               
         LA    R4,HEAD1+96                                                      
         MVC   0(36,R4),SPACES                                                  
*                                                                               
         MVC   0(9,R4),=C'REPORT RG'                                            
         L     RF,THISQWK                                                       
         MVC   9(2,R4),QWREQPR-QWKD(RF)                                         
         MVI   11(R4),C'-'                                                      
         MVC   12(2,R4),RPRPTCD                                                 
*                                                                               
         LA    R4,HEAD1+112                                                     
         MVC   0(4,R4),=C'PAGE'                                                 
         SR    R0,R0                                                            
         ICM   R0,3,PAGE                                                        
         LA    R4,5(R4)                                                         
         EDIT  (R0),(5,(R4)),ALIGN=LEFT                                         
         AR    R4,R0                                                            
         CLI   THISCOPY,1                                                       
         BNE   *+14                                                             
         MVC   1(8,R4),=C'ORIGINAL'                                             
         B     HDHK10                                                           
         MVC   1(4,R4),=C'COPY'                                                 
         ZIC   R0,THISCOPY                                                      
         EDIT  (R0),(2,5(R4)),ALIGN=LEFT                                        
*                                                                               
HDHK10   LA    R4,HEAD2+96                                                      
         BAS   RE,RUNTIME                                                       
         B     HDHK30                                                           
HDHK20   EQU   *                                                                
         L     RE,FILEC                                                         
         USING RREPREC,RE                                                       
         MVC   HEAD1(20),RREPSHRT  INSERT SHORT REP NAME                        
         DROP  RE                                                               
*                                                                               
         MVC   HEAD2(12),QUESTOR ORINSERT REQUESTOR NAME ONLY                   
*                                                                               
         LA    R4,HEAD1+64                                                      
         MVC   0(36,R4),SPACES                                                  
*                                                                               
         MVC   0(9,R4),=C'REPORT RG'                                            
         L     RF,THISQWK                                                       
         MVC   9(2,R4),QWREQPR-QWKD(RF)                                         
         MVI   11(R4),C'-'                                                      
         MVC   12(2,R4),RPRPTCD                                                 
*                                                                               
         LA    R4,HEAD1+80                                                      
         MVC   0(4,R4),=C'PAGE'                                                 
         SR    R0,R0                                                            
         ICM   R0,3,PAGE                                                        
         LA    R4,5(R4)                                                         
         EDIT  (R0),(5,(R4)),ALIGN=LEFT                                         
         AR    R4,R0                                                            
         CLI   THISCOPY,1                                                       
         BNE   *+14                                                             
         MVC   1(8,R4),=C'ORIGINAL'                                             
         B     HDHK25                                                           
         MVC   1(4,R4),=C'COPY'                                                 
         ZIC   R0,THISCOPY                                                      
         EDIT  (R0),(2,5(R4)),ALIGN=LEFT                                        
*                                                                               
HDHK25   LA    R4,HEAD2+64                                                      
         BAS   RE,RUNTIME                                                       
HDHK30   EQU   *                                                                
         SPACE 1                                                                
* NOW TURN THE BOXES ON  (UNLESS PRINTING REMOTE) *                             
         SPACE 1                                                                
         CLI   OUTPUT,C'D'                                                      
         BE    HEADHKX                                                          
         L     R4,ABOX                                                          
         USING BOXD,R4                                                          
*                                                                               
         MVC   BOXROWS,RPTBXROW    MOVE DEFINED BOX ROWS                        
         MVI   BOXWT,1                                                          
         MVI   BOXYORN,C'Y'                                                     
         MVI   BOXOFF,0                                                         
         MVI   BOXINIT,0                                                        
         MVC   BOXCOLS,RPTBXCOL                                                 
*                                                                               
HEADHKX  B     EXIT                                                             
*                                                                               
         SPACE                                                                  
         DROP  R4                                                               
         SPACE 2                                                                
FHENTRY  NTR1                                                                   
         B     FOOTHK1             DON'T RESET REGS FROM THIS ENTRY             
         SPACE                                                                  
FOOTHK   DS    0H                                                               
*                                                                               
         USING FOOTHK,RF              SET ADDRESSABILITY                        
         LA    R1,SAVEREGS-FOOTHK                                               
         AR    R1,RF                                                            
         LM    R2,RC,0(R1)                                                      
         DROP  RF                                                               
         L     R2,THISRPT          RESET A(THIS REPORT)                         
*                                                                               
FOOTHK1  EQU   *                                                                
         CLI   REQPRNT,C'N'           BY-PASS FOOT PROCESSING?                  
         BE    EXIT                                                             
*                                                                               
         MVC   FOOT1,SPACES                                                     
         MVC   FOOT2,SPACES                                                     
         LA    R1,FOOT1                                                         
         L     RF,THISQWK                                                       
         CLI   QWFOOT-QWKD(RF),C' '   TEST FOR REQ DETAIL LINE                  
         BE    FOOTHK2                                                          
         MVC   0(14,R1),=C'REQ DETAILS - '                                      
         MVC   14(115,R1),QWFOOT-QWKD(RF)                                       
         B     EXIT                                                             
*                                                                               
FOOTHK2  ICM   R6,15,RPCOLFUT      TEST ANY COLFOOT SPECS                       
         BZ    EXIT                                                             
         ZIC   RE,1(R6)                                                         
         SH    RE,=H'3'                                                         
         EX    RE,MOVEFUT                                                       
         B     EXIT                                                             
*                                                                               
         SPACE 2                                                                
MOVEFUT  MVC   0(0,R1),2(R6) *EXECUTED*                                         
*                                                                               
SAVEREGS DS    11A                                                              
         EJECT                                                                  
RUNTIME  DS    0H                                                               
*                                                                               
*        SUBROUTINE TO FORMAT CURRENT DATE/TIME TO PRINT LINE                   
*        INPUT: R4 = A(PRINT LINE)                                              
*                                                                               
         SPACE 1                                                                
         ST    RE,FULL                                                          
         MVC   0(6,R4),=C'RUN ON'                                               
         MVC   7(8,R4),TODAY                                                    
         MVC   16(8,R4),=C'AT HH.MM'                                            
*                                                                               
         THMS                                                                   
         ST    R1,DUB                                                           
         UNPK  WORK(6),DUB(4)                                                   
         MVC   19(2,R4),WORK       HOURS                                        
         CLI   19(R4),C'0'                                                      
         BNE   *+8                                                              
         MVI   19(R4),C' '                                                      
         MVC   22(2,R4),WORK+2     MINUTES                                      
         L     RE,FULL                                                          
         BR    RE                                                               
         EJECT                                                                  
* SUBROUTINE TO MOVE DATA AT R1 FOR LEN (R0-R1) TO ADDRESS AT R4 *              
         SPACE 1                                                                
MOVE     NTR1                                                                   
         SR    R0,R1               GIVES LENGTH                                 
         BP    *+6                                                              
         DC    H'0'                                                             
         LA    RF,256                                                           
*                                                                               
MOVE2    CR    R0,RF                                                            
         BNH   MOVE4                                                            
         MVC   0(256,R4),0(R1)                                                  
         AR    R1,RF                                                            
         AR    R4,RF                                                            
         SR    R0,RF                                                            
         B     MOVE2                                                            
MOVE4    LR    RF,R0                                                            
         BCTR  RF,0                                                             
         EX    RF,MOVEMVC                                                       
         B     EXIT                                                             
MOVEMVC  MVC   0(0,R4),0(R1) *EXECUTED*                                         
         EJECT                                                                  
* SUBROUTINE TO END LOGO                                                        
         SPACE                                                                  
ENDLOGO  NTR1                                                                   
*****>>> CLI   RPREMPRT,C'Y'       TEST IF NEED TO END LOGO                     
         CLI   XENDLOGO,C'Y'       TEST IF NEED TO END LOGO                     
         BNE   ENDL0090                                                         
         TM    NOLOGOSW,MCPRTINL   NOLOGOS SET?                                 
         BO    ENDL0090            YES - EXIT                                   
         CLI   DIRECTSW,C'Y'       DIRECT TO QUEUE?                             
         BE    ENDL0090            YES - EXIT                                   
*                                                                               
         L     RE,VXADDR           NO END LOGO IF DOWNLOADING                   
         USING VXADDRD,RE                                                       
         L     RF,VXRCDOWN                                                      
         CLI   0(RF),X'01'                                                      
         BE    ENDL0090                                                         
         DROP  RE                                                               
*                                                                               
         BAS   RE,FHENTRY          GET THE FOOTLINES                            
         MVC   P,SPACES                                                         
         MVI   FORCEFUT,C'Y'                                                    
         MVI   FORCEHED,C'N'                                                    
         MVI   LINE,1                                                           
         GOTO1 =A(LOCALREP),DMCB,(RC),0 FORCE FOOTLINES                         
         L     R5,LOGOC                                                         
         USING LOGOD,R5                                                         
         MVI   LOGOTYPE,C'E'                                                    
         MVI   LOGOSTTS,C'N'                                                    
*                                                                               
         GOTO1 LOGO,DMCB,(R5)      GO TO LOGO                                   
*                                                                               
         L     R4,LOGO                                                          
         MVC   0(2,R4),=X'07FE'    DEACTIVATE LOGO                              
         L     RF,ADCONLST                                                      
         L     R4,PRNTER-ADCONSD(RF)                                            
         SETPRT (4)             SET CHANGE OF STRIPES IN SYSPRINT DCB           
         B     ENDL0090                                                         
ENDL0080 EQU   *                   LOGOS NOT NEEDED - FOOTLINES NEEDED          
         BAS   RE,FHENTRY          GET THE FOOTLINES                            
         MVC   P,SPACES                                                         
         MVI   FORCEFUT,C'Y'                                                    
         MVI   FORCEHED,C'N'                                                    
         MVI   LINE,1                                                           
         GOTO1 =A(LOCALREP),DMCB,(RC),0 FORCE FOOTLINES                         
ENDL0090 EQU   *                                                                
         MVI   RPREMPRT,0          TURN OFF LOGO SWITCH                         
         MVI   XENDLOGO,0          TURN OFF LOGO SWITCH                         
         B     EXIT                                                             
         SPACE 3                                                                
         DROP  R5                                                               
         EJECT                                                                  
*                                                                               
* --- CLEARDWN --- CLEAR THE DOWNLOAD DEFINITION LINE BECAUSE THE               
*                   CURRENT LINE IS NOT GOING TO BE PRINTED                     
*                                                                               
CLEARDWN NTR1                                                                   
*                                                                               
         L     R4,VXADDR                                                        
         USING VXADDRD,R4                                                       
*                                                                               
         L     RF,VXDOWNDF                                                      
         LA    R1,LVXDOWND                                                      
         EX    R1,CREPEX3                                                       
*                                                                               
         L     RE,=A(DOWNTAB)                                                   
         LA    RF,LDOWNTAB                                                      
         SLL   RF,1                                                             
         XCEF                                                                   
*                                                                               
         B     EXIT                                                             
         SPACE 3                                                                
CREPEX3  XC    0(0,RF),0(RF)                                                    
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   CALL DYNALLOC TO ASSIGN TAPE FILE TO THIS JOB                               
*                                                                               
DYNCALL  NMOD1 0,**DYNC**                                                       
         L     RC,0(R1)            RESET A(WORKSPACE)                           
*                                                                               
         CLC   QUESTOR(9),=C'DSN=DUMMY'                                         
*                                  USE JCL IN RUNSTREAM?                        
         BE    DYNC0060            YES                                          
         CLC   QUESTOR(4),=C'DSN=' PASSING IN A DSNAME NAME?                    
         BNE   DYNC0020            NO                                           
         MVC   DSNAME+08(8),QUESTOR+4                                           
*                                  YES - TAKE FROM REQUESTOR NAME               
         B     DYNC0040            ALLOCATE PASSED-IN NAME                      
DYNC0020 EQU   *                                                                
         MVC   DSNAME+13(2),RCREPFL                                             
*                                  INSERT RUN'S REP CODE                        
DYNC0040 EQU   *                                                                
*                                                                               
*   TEST                                                                        
***      L     RF,ADYNALOC                                                      
***      MVC   P+1(80),0(RF)                                                    
***      GOTO1 REPORT                                                           
***      DC    H'0'                                                             
*   TEST                                                                        
*                                                                               
****     GOTO1 =V(DYNALLOC),DMCB,(X'02',DDNAME),DSNAME                          
         PRINT GEN                                                              
         GOTO1 ADYNALOC,DMCB,(X'02',DDNAME),DSNAME                              
         PRINT NOGEN                                                            
***      DC    H'0'                                                             
DYNC0060 EQU   *                                                                
         XIT1                                                                   
*                                                                               
*                   0         1         2                                       
*                   0.2.4.6.8.0.2.4.6.8.0                                       
DSNAME   DC    CL20'REPTAPE.RE0RTXX1     '                                      
DDNAME   DC    CL8'ONLINER '                                                    
         DS    0H                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
*                                                                               
*  DISPLAY THE RECORD, IF ASKED FOR                                             
*                                                                               
         DS    0F                                                               
DISPDUMP NMOD1 0,**DDMP**                                                       
         L     RC,12(R1)           RESET A(WORKSPACE)                           
         L     R2,0(R1)            LOAD A(INPUT RECORD)                         
         L     R3,4(R1)            DISPLAY FLAG                                 
         C     R3,=F'4'            ADVNAM/AGYNAM DISPLAY?                       
         BE    DISD0060            YES - CHECK REQUEST                          
         C     R3,=F'5'            ADVNAM/AGYNAM DISPLAY?                       
         BE    DISD0060            YES - CHECK REQUEST                          
         C     R3,=F'6'            SPECIAL SORT DISPLAY?                        
         BE    DISD0070            YES - CHECK REQUEST                          
         CLI   RCTRACE,C'I'        NO  - RERG02/03 RECORDS TRACE?               
         BE    DISD0080            YES                                          
         CLI   RCTRACE,C'T'        AGGREG/SPL TABLE DISPLAY?                    
         BE    DISD0080            YES                                          
         CLI   RCTRACE,C'3'        RERG03 RECORDS ONLY TRACE?                   
         BE    DISD0080            YES                                          
         CLI   RCTRACE,C'4'        RERG03 RECORDS ONLY/MERGE TRACE?             
         BNE   DISD0040            YES                                          
         CLI   16(R1),C'M'         REQUEST FROM 'MERGE'?                        
         BNE   DISD0020            NO                                           
         CLI   13(R1),C'T'         FROM 'TABLING' ROUTINE?                      
         BNE   DISD0010            NO                                           
         MVC   P+14(12),=C'FROM TABLING'                                        
DISD0010 EQU   *                                                                
         MVC   P+1(11),=C'MERGE INPUT'                                          
         L     RF,DISPCTR                                                       
         LA    RF,1(RF)                                                         
         ST    RF,DISPCTR                                                       
         EDIT  DISPCTR,(4,P+15),DUB=DISPDUB                                     
         GOTO1 REPORT                                                           
         B     DISD0080                                                         
DISD0020 EQU   *                                                                
         CLI   12(R1),C'N'         REQUEST FROM 'MERGE'?                        
         BNE   DISD0100            NO                                           
         MVC   P+1(12),=C'MERGE OUTPUT'                                         
         EDIT  DISPCTR,(4,P+15),DUB=DISPDUB                                     
         GOTO1 REPORT                                                           
         B     DISD0080                                                         
DISD0040 EQU   *                                                                
         CLI   RCTRACE,C'Y'        FULL TRACE?                                  
         BNE   DISD0100            NO  -                                        
         B     DISD0080                                                         
DISD0060 EQU   *                                                                
         CLI   RCTRACE,C'A'        ADVNAM/AGYNAM TRACE?                         
         BNE   DISD0100            NO  -                                        
         B     DISD0080                                                         
DISD0070 EQU   *                                                                
         CLI   RCTRACE,C'S'        SPECIAL SORT TRACE?                          
         BNE   DISD0100            NO  -                                        
         B     DISD0080                                                         
DISD0080 EQU   *                                                                
         GOTO1 =A(DUMPBUFF),DMCB,(R2),(R3),(RC)                                 
DISD0100 EQU   *                                                                
         XIT1                                                                   
DISPDUB  DS    D                                                                
DISPCTR  DC    F'0'                                                             
         LTORG                                                                  
         EJECT                                                                  
**REMOTE                                                                        
*              SET UP FOR REMOTE PRINT QUEUE                                    
         SPACE 2                                                                
REMOTE   NMOD1 0,*REMO*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
*                                                                               
         L     R4,MASTDSAV         SET MASTD STUFF                              
         USING MASTD,R4                                                         
*                                                                               
         TM    FRSTREMO,X'80'      DON'T CLOSE ON FIRST TIME                    
         BZ    REMO0020                                                         
         GOTO1 PRINT,DMCB,=C'CLOSE'                                             
REMO0020 EQU   *                                                                
         OI    FRSTREMO,X'80'      SET 'NOT FIRST TIME'                         
         L     R3,MCVREMOT         LOAD A(REMOTEC)                              
         MVC   0(80,R3),MCREMOTE   MOVE EXISTING CARD TO REMOTEC                
         USING REMOTED,R3                                                       
*                                                                               
***      MVC   REMOTAOP,=V(PQOPEN)                                              
***      MVC   REMOTABF,=V(PQBUFF)                                              
***      MVC   REMOTADM,=V(DATAMGR)                                             
         MVC   REMOTAOP,MCVPQOPN                                                
         MVC   REMOTABF,MCVPQBUF                                                
         MVC   REMOTADM,MCVDMGR                                                 
***<<<                                                                          
         L     RF,AQWORK                                                        
         USING QWKD,RF                                                          
*                                                                               
REMO0040 CLC   QWREQNUM,REC        MATCH REQUEST NUMBER                         
         BE    REMO0060                                                         
         ICM   RF,7,QWNEXT         POSITION TO CORRECT REQUEST                  
         BNZ   REMO0040                                                         
         SPACE 1                                                                
REMO0060 EQU   *                   SAVE QWORK ADDRESS                           
***<<<                                                                          
         LA    RE,QWREQ                                                         
         CLC   =C'KPPRAGER',QUESTOR-QRECORD(RE)                                 
*                                  SPECIAL KATZ OVERRIDE?                       
         BE    REMO0080            YES - SKIP RESETTING VALUES                  
*                                                                               
         MVC   REMOTDSC(2),QRGPROG-QRECORD(RE)                                  
         MVI   REMOTDSC+2,C'/'                                                  
         MVC   REMOTDSC+3(8),QUESTOR-QRECORD(RE)                                
*                                  INSERT REQUESTOR INTO REMOTE                 
         MVC   REMOTJID,QUESTOR-QRECORD(RE)                                     
*                                  CHANGE REPORT ID TO FIRST 3                  
REMO0080 EQU   *                   SAVE QWORK ADDRESS                           
         DROP  RF                                                               
***      MVC   REMOTDST,RCREPFL    INSERT REP CODE                              
***      MVC   REMOTKEY(11),SPACES                                              
***      MVC   REMOTSYS(4),=C'TEST'                                             
***      MVI   REMOTCPY,C'1'                                                    
***      MVI   REMOTLPP,68                                                      
***      MVI   REMOTCLS,C'K'                                                    
***      MVC   REMOTJID,=C'WDU'                                                 
*                                                                               
*   TEST:  LOOK FOR 'STUFF'                                                     
***      L     R1,FILEC                                                         
***      LA    RF,RCONREC-FILED(R1)                                             
***      MVC   000(080,RF),MCREMOTE                                             
***      MVC   DIE(2),=X'0000'                                                  
         XIT1                                                                   
         DROP  R3                                                               
         DROP  R4                                                               
         LTORG                                                                  
         SPACE 1                                                                
         EJECT                                                                  
**REMOTE                                                                        
*                                                                               
*   BROWZELT:  CONSTRUCT AN ELEMENT FOR THE KTZREC FROM THE DATA                
*        CURRENTLY SITTING IN 'FLD'.  DETERMINE HOW LONG THE ENTRY              
*        IS, THEN CONSTRUCT AN ELEMENT WITH CODE KTZELT#+1, AND                 
*        ADD IT TO THE KTZREC AT A(KTZADDR).                                    
*                                                                               
BROWZELT NMOD1 0,*BREL*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         LA    RF,16               SET LOOP CONTROL                             
         LA    RE,FLD              SET A(INPUT FIELD)                           
BREL0020 EQU   *                                                                
         CLI   0(RE),C' '          SPACE IN FIELD?                              
         BNE   BREL0040            NO  - SIGNIFICANT CHARACTER FOUND            
         LA    RE,1(RE)            BUMP TO NEXT FIELD                           
         BCT   RF,BREL0020         GO BACK FOR NEXT                             
*                                  EMPTY FIELD - SKIP ADDING ELEMENT            
*                                     TO OUTPUT RECORD                          
         L     R1,KTZELT#          SET NEXT ELEMENT CODE                        
         LA    R1,1(R1)            BUMP TO NEXT ELEMENT #                       
         ST    R1,KTZELT#          SAVE NEW NUMBER                              
         B     BREL0080                                                         
BREL0040 EQU   *                                                                
         XC    KTZELEM,KTZELEM     CLEAR OUT ELEMENT                            
         L     R1,KTZELT#          SET NEXT ELEMENT CODE                        
         LA    R1,1(R1)            BUMP TO NEXT ELEMENT #                       
         ST    R1,KTZELT#          SAVE NEW NUMBER                              
         STC   R1,KTZELEM          INSERT ELEMENT CODE                          
         LA    RF,2(RF)            ADD L'CONTROL TO L'DATA                      
         STC   RF,KTZELEM+1        INSERT LENGTH OF REMAINING DATA              
         SH    RF,=H'3'            SET FOR MOVE OF DATA                         
         L     R7,KTZADDR          SET A(KTZREC LOCATION)                       
         EX    RF,BREL0800         MOVE DATA BY LENGTH                          
         LA    RF,2(RF)            SET TO MOVE ELEMENT BY LENGTH                
         EX    RF,BREL0820         MOVE ELEMENT TO KTZREC                       
         LA    RF,1(RF)            RESET L(ENTIRE ELEMENT)                      
         AR    R7,RF               BUMP TO NEXT ADDRESS                         
         ST    R7,KTZADDR          SAVE NEXT ADDRESS                            
         L     RE,KTZRECSZ         ADD TO ENTIRE ELEMENT SIZE                   
         AR    RE,RF                                                            
         ST    RE,KTZRECSZ                                                      
BREL0080 EQU   *                                                                
         XIT1                                                                   
BREL0800 EQU   *                                                                
         MVC   KTZELEM+2(0),0(RE)       INSERT DATA BY LENGTH                   
BREL0820 EQU   *                                                                
         MVC   0(0,R7),KTZELEM          INSERT ELEM BY LENGTH                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   SETBROWZ:  INSERT KEYS INTO BROWSER FILE RECORD, BASED ON                   
*        AT WHICH LEVEL THE BREAK IS TO BE THROUGH.                             
*                                                                               
SETBROWZ NMOD1 0,*BRWZ*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R3,4(R1)            SET A(CBLEVEL)                               
         BAS   RE,SETDISPL         CALCULATE DISPLACEMENT INTO KEY              
*                                     RETURN:  DUB = DISPLACEMENT               
         ZIC   R0,0(R3)            LOAD LEVEL NUMBER                            
         LR    RF,R0               LOAD CBLEVEL                                 
         LA    RF,1(RF)            ADD 1 FOR TOTAL ROWS COMPARE                 
         ZIC   RE,RPROWS           INSERT # ROWS FOR COMPARISON                 
         CR    RF,RE               CBLEVEL = RPROWS?                            
         BNE   SBRO0010            NO                                           
         LR    R0,RE               YES - SET LOOP TO RPROWS                     
*                                     TO INCLUDE 'PERIOD' AT THIS LEVEL         
SBRO0010 EQU   *                                                                
         ST    R0,SAVELOOP         SAVE LOOP CONTROL VALUE                      
         LA    R3,REC+9            SET A(RECORD IN PROGRESS)                    
         LA    R7,RPROWDEF+4       A(ROWDEF SPEC ADDRS)                         
         XC    KTZREC,KTZREC                                                    
         LA    RE,KTZREC           SET A(1ST KEY FIELD)                         
         L     RF,DUB                 ADD DISPLACEMENT TO RECORD                
*                                       SAVE DUB FOR INITIALIZATION USE         
         AR    RE,RF                                                            
         A     RE,=F'-4'           BACK UP TO ADD REP/REPT#                     
         L     R1,THISQWK                                                       
         USING QWKD,R1                                                          
*                                                                               
*   POSSIBILITY 'DATES=' KEY WILL CLOBBER RECORD LENGTH IF                      
*        KEY STARTS DOWN TOO FAR.  IF CALCULATED START OF KEY                   
*        IS TOO FAR DOWN, INITIAL POSITION IS PULLED BACK                       
*                                                                               
         LA    RF,KTZREC+28        SET MAX KEY POSN START                       
         CR    RE,RF               CALC POSITION VS MAX KEY POS                 
         BNH   SBRO0015            OKAY AS ENTERED                              
         LR    RE,RF               TOO FAR DOWN:  MOVE TO MAX KEY POSN          
SBRO0015 EQU   *                                                                
***>>>   MVC   0(2,RE),QWREQ+77                                                 
         MVC   KTZREC(2),QWREQ+77                                               
*                                  INSERT REPORT CODE INTO KEY                  
***>>>   MVC   2(2,RE),QWREQ+2                                                  
         MVC   KTZREC+2(2),QWREQ+2                                              
*                                  INSERT REP CODE INTO KEY                     
         DROP  R1                                                               
*                                                                               
         CLI   RPBRZFLG,0          DATE RECORD OUTPUT?                          
         BNE   SBOR0020            YES                                          
         MVI   RPBRZFLG,1          NO  - PUT IT OUT                             
         MVC   6(6,RE),=C'DATES='                                               
         MVC   12(4,RE),QSTART                                                  
         MVC   16(4,RE),QEND       INSERT START/END                             
         ST    RE,FULL             SAVE BUILDING LOCATION -                     
*                                     DATES WILL BE OVERWRITTEN                 
*                                        AFTER RECORD OUTPPUT                   
         LA    RE,63               SET RECORD LENGTH W/CONTROL                  
         STCM  RE,3,KTZREC-4       INSERT VARIABLE LENGTH INTO REC              
         LA    RE,59               SET RECORD LENGTH OF RECORD                  
         STC   RE,KTZREC+49        INSERT INTO RECORD                           
         MVC   KTZREC+51(2),=X'0108'                                            
*                                  INSERT DUMMY ELEMENT                         
         MVC   KTZREC+53(6),QASAT  INSERT AS AT DATE                            
         PUT   BROWSER,KTZREC-4    PUT RECORD TO BROWSER FILE                   
         L     RE,FULL             RESET BUILDING LOCATION                      
         L     R0,SAVELOOP         RESET LOOP CONTROL                           
         B     SBOR0020                                                         
SAVELOOP DS    F                                                                
*                                                                               
SBOR0020 EQU   *                                                                
         LA    RE,4(RE)            NOW SKIP REP/REPT #                          
         MVI   0(RE),X'FF'         SET LOW-ORDER KEY TO X'FF'                   
         L     RF,DUB              RESET DISPLACEMENT                           
         LNR   RF,RF               NEGATE VALUE                                 
         A     RF,=F'48'           CALCULATE LENGTH TO SET TO X'FF'             
         BCTR  RF,0                SUBTRACT 1 FOR EX                            
         BCTR  RF,0                SUBTRACT 1 FOR PROPAGATE MOVE                
         EX    RF,SBRO0820                                                      
*                                                                               
SBRO0040 EQU   *                                                                
         L     R6,0(R7)            LOAD A(SPEC)                                 
         LA    RF,RECKEYS          SET A(DATA CODE TABLE)                       
SBRO0060 EQU   *                                                                
         CLI   0(RF),0             END OF TABLE?                                
         BNE   *+6                 NO                                           
         DC    H'0'                YES - UNRECOGNIZED DATA CODE IN SPEC         
         CLC   3(1,R6),0(RF)       DATA CODE IN SPEC VS TABLE                   
         BE    SBRO0120            FOUND - PROCESS IT                           
         LA    RF,LRECKEY(RF)      BUMP TO NEXT ENTRY                           
         B     SBRO0060            GO BACK AND CHECK NEXT                       
SBRO0120 EQU   *                                                                
         ZIC   R4,2(RF)            GET SPECIAL ADJUSTMENT FROM TABLE            
         AR    R4,R3               ADD TO A(REC ROW)                            
         ZIC   R5,1(RF)            GET DATA CODE LENGTH FROM TABLE              
         BCTR  R5,0                SUB 1 FOR EX                                 
         EX    R5,SBRO0800         MOVE CODE BY LENGTH                          
         CLI   0(RF),2             STATION DATA CODE?                           
         BNE   SBRO0160            NO  -                                        
         ST    RE,DUB              SAVE VALUE OF REG                            
         ST    RF,DUB+4                                                         
         BAS   RE,STADJUST         YES - ADJUST STATION IF NEEDED               
         L     RE,DUB              RESET REG                                    
         L     RF,DUB+4                                                         
SBRO0160 EQU   *                                                                
         CLI   0(RF),X'11'         DATE FIELD?                                  
         BL    SBRO0200            NO  -                                        
         CLI   0(RF),X'14'         DATE FIELD?                                  
         BH    SBRO0200            NO  -                                        
         ST    RE,ADATEOP          SAVE A(DATE OUTPUT FIELD)                    
SBRO0200 EQU   *                                                                
         LA    R5,1(R5)            RESET DATA CODE LENGTH                       
         AR    RE,R5               BUMP KTZREC BY L(KEY FIELD)                  
         LA    R3,9(R3)            BUMP TO NEXT REC ROW                         
         LA    R7,4(R7)            BUMP TO NEXT ROWDEF SPEC ADDR)               
         BCT   R0,SBRO0040         GO BACK FOR NEXT                             
*                                                                               
*   TEST                                                                        
*        MVC   P+1(07),=C'KTZREC:'                                              
*        MVC   P+8(48),KTZREC                                                   
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         LA    RF,KTZREC+KTZ1STEL  SET A(1ST ELEMENT IN KTZREC)                 
         ST    RF,KTZADDR          SAVE FOR RECORD BUILDING                     
         XC    KTZELT#,KTZELT#     CLEAR ELEMENT # COUNTER                      
         XIT1                                                                   
SBRO0800 MVC   0(0,RE),0(R4)       MOVE DATA TO KTZREC FROM REC                 
SBRO0820 MVC   1(0,RE),0(RE)       INITIALIZE KEY BY LENGTH                     
*                                                                               
         EJECT                                                                  
SETDISPL NTR1                                                                   
         SR    R5,R5               ESTABLISH COUNTER                            
         LA    R7,RPROWDEF+4       A(ROWDEF SPEC ADDRS)                         
SDIP0040 EQU   *                                                                
         L     R6,0(R7)            LOAD A(SPEC)                                 
         LA    R1,RECKEYS          SET A(DATA CODE TABLE)                       
SDIP0060 EQU   *                                                                
         CLI   0(R1),0             END OF TABLE?                                
         BNE   *+6                 NO                                           
         DC    H'0'                YES - UNRECOGNIZED DATA CODE IN SPEC         
         CLC   3(1,R6),0(R1)       DATA CODE IN SPEC VS TABLE                   
         BE    SDIP0120            FOUND - PROCESS IT                           
         LA    R1,LRECKEY(R1)      BUMP TO NEXT ENTRY                           
         B     SDIP0060             GO BACK AND CHECK NEXT                      
SDIP0120 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        MVC   P+1(10),=C'DISP LOOP='                                           
*        MVC   P+10(7),0(R6)                                                    
*        MVI   P+17,C'/'                                                        
*        MVC   P+18(1),1(R1)                                                    
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         ZIC   RE,1(R1)            GET KEY DATA LENGTH                          
         AR    R5,RE               ADD TO ACCUMULATOR                           
         LA    R7,4(R7)            BUMP TO NEXT ROWDEF SPEC ADDR                
         OC    0(4,R7),0(R7)       ANY ADDRESS?                                 
         BNZ   SDIP0040            YES - GO BACK FOR NEXT                       
         LA    R5,4(R5)            ADD 4 FOR LINE COUNTER                       
         LNR   R5,R5               NEGATE REGISTER                              
         A     R5,=F'48'           ADD MAX KEY LENGTH TO CALCULATE              
*                                     DISPLACEMENT VALUE                        
*   TEST                                                                        
*        MVC   P+1(11),=C'DISP VALUE='                                          
*        EDIT  (R5),(3,P+12)                                                    
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         ST    R5,DUB                                                           
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   STADJUST:  LOOK FOR THREE-CHARACTER STATION CODES.  IF FOUND,               
*        MOVE MEDIA TO FIFTH POSITION, INSERT X'40' IN FOURTH POSITION.         
*        REGISTER RE POINTS TO POSITION IN KEY, HAS BEEN SAVED PRIOR            
*        TO TRANSFER TO THIS ROUTINE IN DUB.                                    
*                                                                               
STADJUST NTR1                                                                   
         L     RE,DUB              RESET A(STATION IN KEY)                      
         CLC   3(2,RE),=C'AM'      MEDIA = AM?                                  
         BE    SADJ0040            YES                                          
         CLC   3(2,RE),=C'FM'      MEDIA = FM?                                  
         BE    SADJ0040            YES                                          
         CLC   3(2,RE),=C'TV'      MEDIA = TV?                                  
         BNE   SADJ0080            NO  - FINISHED                               
SADJ0040 EQU   *                                                                
         MVC   4(1,RE),3(RE)       MOVE MEDIA TO FIFTH POSITION                 
         MVI   3(RE),C' '          INSERT SPACE AS FOURTH CHARACTER             
SADJ0080 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   RECKEYS:  TABLE DETAILING LENGTH OF KEY INFORMATION TO BE LOADED            
*        INTO THE KTZREC KEY AREA.  ENTRIES CORRESPOND TO A ROW SPEC            
*        DATA CODE, AND DEFINE THE LENGTH OF THE KEY FIELD IN THE               
*        OUTPUT AREA.                                                           
*        EACH ENTRY CONSISTS OF:                                                
*             BYTE 1    =    DATA CODE FROM SPEC                                
*             BYTE 2    =    LENGTH OF KEY FIELD IN OUTPUT                      
*             BYTE 3    =    SPECIAL ADJUSTMENT IN FIELD                        
*                                                                               
RECKEYS  DC    X'01',X'02',X'00'   REP CODE                                     
LRECKEY  EQU   *-RECKEYS                                                        
         DC    X'02',X'05',X'02'   STATION                                      
         DC    X'20',X'05',X'00'   STATION/MARKET: SHOULDN'T BE USED            
         DC    X'03',X'02',X'00'   REGION                                       
         DC    X'04',X'02',X'01'   OFFICE                                       
         DC    X'05',X'02',X'00'   TEAM                                         
         DC    X'06',X'03',X'00'   SALESPERSON                                  
         DC    X'07',X'02',X'00'   GROUP/SUBGROUP                               
         DC    X'19',X'02',X'00'   GROUP                                        
         DC    X'1A',X'01',X'00'   SUBGROUP                                     
         DC    X'08',X'04',X'00'   ADVERTISER                                   
         DC    X'09',X'08',X'00'   PRODUCT                                      
         DC    X'0A',X'06',X'00'   AGENCY                                       
         DC    X'0B',X'03',X'00'   AFFILIATE                                    
         DC    X'0C',X'04',X'00'   CONTRACT NUMBER                              
         DC    X'0D',X'02',X'00'   CLASS                                        
         DC    X'0E',X'02',X'00'   OFFICE                                       
         DC    X'0F',X'02',X'00'   CATEGORY                                     
         DC    X'10',X'04',X'00'   RANK                                         
         DC    X'11',X'03',X'00'   MONTH                                        
         DC    X'12',X'03',X'00'   CURRMONTH                                    
         DC    X'13',X'03',X'00'   ALLMONTH                                     
         DC    X'14',X'03',X'00'   QUARTER                                      
         DC    X'17',X'02',X'00'   TVB                                          
         DC    X'18',X'03',X'00'   OWNER                                        
         DC    X'1B',X'08',X'00'   ADVERTISER NAME                              
         DC    X'1C',X'08',X'00'   AGENCY NAME                                  
         DC    X'16',X'01',X'00'   STATION TYPE                                 
         DC    X'1D',X'01',X'00'   SERVICE                                      
         DC    X'1E',X'01',X'00'   MARKET RANK                                  
         DC    X'1F',X'01',X'00'   AVAIL PACING                                 
         DC    X'20',X'05',X'00'   STATION MARKET                               
         DC    X'21',X'02',X'00'   CONTRACT TYPE                                
         DC    X'22',X'06',X'00'   POINT PERSON                                 
         DC    X'23',X'08',X'00'   NETWORK CONTRACT NUMBER                      
         DC    X'24',X'06',X'00'   BOOK                                         
         DC    X'25',X'03',X'00'   DYAPART                                      
         DC    X'26',X'07',X'00'   DEMO                                         
         DC    X'27',X'04',X'00'   MARKET                                       
         DC    X'28',X'02',X'00'   COMPANY                                      
         DC    X'29',X'06',X'00'   DAYPARTS                                     
         DC    X'2A',X'11',X'00'   FLIGHT                                       
         DC    X'2C',X'03',X'00'   DEV S/P                                      
         DC    X'2D',X'02',X'00'   DEV CONTYPE                                  
         DC    X'0000'             DEMO                                         
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   KTZCODE:  UPDATE BROWSER FILE RECORDS                                       
*                                                                               
KTZCODE  NMOD1 0,*KZCD*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     RF,KTZCOUNT         INCREMENT RECORD COUNTER                     
         LA    RF,1(RF)                                                         
         ST    RF,KTZCOUNT         REPLACE NEW COUNT                            
         STCM  RF,15,KTZREC+44     RECORD COUNT WILL ALWAYS BE                  
*                                     IN LAST FOUR BYTES OF KEY                 
         L     RF,KTZRECSZ         SET L(KTZREC)                                
         LA    RF,LKTZRCKY(RF)     ADD L(KEY SECTION+REC CONTROL)               
         LA    RF,1(RF)            ADD 1 FOR END-OF-RECORD                      
         STCM  RF,3,KTZREC+48      INSERT L(RECORD) INTO RECORD CTRL            
         LA    RF,LKTZCTRL(RF)     ADD 4 BYTES FOR VARIABLE CTRL                
         STCM  RF,3,KTZREC-4       INSERT L(RECORD) INTO VAR CTRL               
         L     RE,KTZADDR          FIND LAST ELEMENT ADDR                       
         MVI   0(RE),0             INSERT END OF RECORD INDICATOR               
*                                                                               
*   TEST                                                                        
*        L     RF,ADATEOP                                                       
*        MVC   P+1(10),=C'DATEOP   ='                                           
*        S     RF,=F'48'           DISPLAY DATE OUTPUT                          
*        MVC   P+11(64),0(RF)                                                   
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         PUT   BROWSER,KTZREC-4    PUT RECORD TO BROWSER FILE                   
         XC    KTZRECSZ,KTZRECSZ   CLEAR RECORD SIZE                            
         XC    KTZELT#,KTZELT#     CLEAR/RESTART ELT NUMBER CT                  
         LA    RF,KTZREC+KTZ1STEL  SET A(1ST ELEMENT IN KTZREC)                 
         ST    RF,KTZADDR          SAVE FOR RECORD BUILDING                     
*                                                                               
*   TEST                                                                        
*        MVC   P+1(13),=C'FINAL KTZREC>'                                        
*        MVC   P+14(60),KTZREC-4                                                
*        MVI   P+80,C'<'                                                        
*        GOTO1 REPORT                                                           
*        MVC   P+1(13),=C'------------>'                                        
*        MVC   P+14(60),KTZREC+56                                               
*        MVI   P+80,C'<'                                                        
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   TESTPRT:  DISPLAY PRINTOUT OF KEY LEVELS.  CBLEVEL INDICATES                
*        AT WHICH LEVEL THE BREAK IS TO BE THROUGH.                             
*                                                                               
TESTPRT  NMOD1 0,*TPRT*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)            SET A(CBLEVEL)                               
*                                                                               
*        MVC   P+1(10),=C'PRE -FORM:'                                           
*        EDIT  CBLEVEL,(3,P+12)                                                 
*        EDIT  RPROWS,(3,P+18)                                                  
*        GOTO1 REPORT                                                           
*                                                                               
         ZIC   RF,0(R2)            LOAD LEVEL NUMBER                            
         LA    R3,REC+9            SET A(RECORD IN PROGRESS)                    
         LA    R5,P+15                                                          
TPRT0020 EQU   *                                                                
         MVC   0(9,R5),0(R3)                                                    
         MVI   9(R5),C'/'                                                       
         LA    R5,10(R5)                                                        
         LA    R3,9(R3)                                                         
         BCT   RF,TPRT0020         GO BACK FOR NEXT                             
TPRT0040 EQU   *                                                                
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
EOJ      NMOD1 0,*EOJ**                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         CLI   REQPRNT,C'O'        PRINT = ONLINE?                              
         BNE   EOJ1                NO                                           
         CLI   WRKOPEN,C'Y'        RGWORK/ONLINE OPEN?                          
         BNE   EOJ1                NO                                           
         CLOSE RGWORK              YES - CLOSE RGWORK                           
         CLOSE ONLINER                AND ONLINER FILES                         
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  5'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
*                                                                               
EOJ1     EQU   *                                                                
         CLI   BROWZOPN,C'Y'       'BROWSER' FILE OPEN?                         
         BNE   EOJ1A                                                            
         CLOSE BROWSER             YES - CLOSE                                  
*                                                                               
EOJ1A    CLI   RUNMODE,C'S'                                                     
         BNE   EOJ2                                                             
         XC    HEADHOOK,HEADHOOK   DISABLE HEADHOOK                             
         LA    R0,12                                                            
         LA    R1,HEAD1                                                         
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    EOJEXIT             YES - DON'T 'COMPLETE PRINTING'              
         MVI   FORCEHED,C'Y'       COMPLETE PRINTING                            
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         B     EOJEXIT                                                          
*                                                                               
EOJ2     EQU   *                                                                
         XC    HEADHOOK,HEADHOOK   DISABLE HEADHOOK                             
         LA    R0,12                                                            
         LA    R1,HEAD1                                                         
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    EOJ2A               YES - DON'T 'COMPLETE PRINTING'              
         MVI   FORCEHED,C'Y'       COMPLETE PRINTING                            
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                                                               
EOJ2A    OPEN  (RRGEOD,(OUTPUT))   WRITE TO CHECK LIST                          
         LA    R5,P                                                             
         MVC   P+6(18),=C'RRG JOB CHECK LIST'                                   
         LA    R4,P+34                                                          
         BAS   RE,RUNTIME2         FORMAT DATE & TIME                           
         BAS   R7,EOJPUT                                                        
         MVI   P+6,C'-'                                                         
         MVC   P+7(17),P+6                                                      
         BAS   R7,EOJPUT                                                        
         BAS   R7,EOJPUT                                                        
         MVC   P+1(27),=C'CHECK  JOBNAME  DESTINATION'                          
         BAS   R7,EOJPUT                                                        
         MVC   P+1(27),=C'-----  -------  -----------'                          
         BAS   R7,EOJPUT                                                        
         L     R4,=A(CHECKLST)                                                  
*                                                                               
EOJ4     CLI   0(R4),0                                                          
         BE    EOJX                                                             
         CLC   0(3,R4),=C'END'                                                  
         BNE   EOJ6                                                             
         MVC   P+1(17),=C' TOO MANY TO LIST'                                    
         BAS   R7,EOJPUT                                                        
         B     EOJX                                                             
*                                                                               
EOJ6     MVC   P(4),=C' ( )'                                                    
         MVC   P+8(8),0(R4)                                                     
         MVC   P+17(7),8(R4)                                                    
         MVC   P+25(7),15(R4)                                                   
         BAS   R7,EOJPUT                                                        
         LA    R4,22(R4)                                                        
         B     EOJ4                                                             
*                                                                               
EOJX     BAS   R7,EOJPUT                                                        
         MVI   P+1,C'-'                                                         
         MVC   P+2(56),P+1                                                      
         BAS   R7,EOJPUT                                                        
         CLOSE (RRGEOD)                                                         
         B     EOJEXIT                                                          
EOJEXIT  XIT1                                                                   
         SPACE 2                                                                
EOJPUT   PUT   RRGEOD,(R5)                                                      
         MVC   P,SPACES                                                         
         BR    R7                                                               
         EJECT                                                                  
RUNTIME2 DS    0H                                                               
*                                                                               
*        LOCAL SUBROUTINE TO FORMAT CURRENT DATE/TIME TO PRINT LINE             
*        INPUT: R4 = A(PRINT LINE)                                              
*                                                                               
         SPACE 1                                                                
         ST    RE,FULL                                                          
         MVC   0(6,R4),=C'RUN ON'                                               
         MVC   7(8,R4),TODAY                                                    
         MVC   16(8,R4),=C'AT HH.MM'                                            
*                                                                               
         THMS                                                                   
         ST    R1,DUB                                                           
         UNPK  WORK(6),DUB(4)                                                   
         MVC   19(2,R4),WORK       HOURS                                        
         CLI   19(R4),C'0'                                                      
         BNE   *+8                                                              
         MVI   19(R4),C' '                                                      
         MVC   22(2,R4),WORK+2     MINUTES                                      
         L     RE,FULL                                                          
         BR    RE                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* ROUTINE TO DISPLAY RECORDS RETURNED TO THIS MODULE FOR PROCESSING             
*                                                                               
DUMPBUFF NMOD1 0,*DUBU*                                                         
         L     RC,8(R1)            RELOAD A(WORKSPACE)                          
         LA    R2,P                                                             
         LA    R3,PSECOND                                                       
         L     R4,0(R1)            RECORD RETURNED                              
         LR    R0,R4               SAVE A(RECORD)                               
         LA    R5,12                                                            
         CLI   7(R1),1             IS FLAG IN 1 (FIRST PASS)?                   
         BNE   DUMB0002            NO                                           
         MVC   P(16),=C'FIRST PASS INPUT'                                       
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         B     DUMB0010                                                         
DUMB0002 EQU   *                                                                
         CLI   7(R1),2             IS FLAG IN 2 (SORT OUT)?                     
         BNE   DUMB0003            NO                                           
         MVC   P(16),=C'SECOND SORT OUT '                                       
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         SPACE 2                                                                
DUMB0003 EQU   *                                                                
         CLI   7(R1),3             IS FLAG IN 3 (RERG03 INPUT ONLY)?            
         BNE   DUMB0004            NO                                           
         MVC   P(16),=C'RERG03 INPUT:   '                                       
         CLI   11(R1),1            REC OR NEWREC?                               
         BNE   DUMB003A            REC                                          
         MVC   P+20(06),=C'NEWREC'                                              
DUMB003A EQU   *                                                                
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         SPACE 2                                                                
DUMB0004 EQU   *                                                                
         CLI   7(R1),4             IS FLAG IN 4 (ADV/AGY SORT I/P)?             
         BNE   DUMB0005            NO                                           
         MVC   P(16),=C'ADV/AGYNAME INPT'                                       
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         SPACE 2                                                                
DUMB0005 EQU   *                                                                
         CLI   7(R1),5             IS FLAG IN 5 (ADV/AGY SORT O/P)?             
         BNE   DUMB0006            NO                                           
         MVC   P(16),=C'ADV/AGYNAME O/P '                                       
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         SPACE 2                                                                
DUMB0006 EQU   *                                                                
         CLI   7(R1),6             IS FLAG IN 5 (OUTPUT OF SPEC SORT)?          
         BNE   DUMB0010            NO                                           
         MVC   P(16),=C'SPEC SORT   O/P '                                       
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
         SPACE 2                                                                
DUMB0010 EQU   *                                                                
         MVC   0(9,R2),0(R4)       LOAD 9 CHARS INTO PRINT                      
         GOTO1 HEXOUT,DMCB,(R2),(R3),9,=C'SEP'                                  
         MVC   132(9,R3),9(R3)                                                  
         MVI   9(R3),C' '                                                       
         LA    R2,10(R2)                                                        
         LA    R3,10(R3)                                                        
         LA    R4,9(R4)                                                         
         BCT   R5,DUMB0010                                                      
         MVC   PSECOND+119(12),SPACES                                           
         MVI   SPACING,2                                                        
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                                                               
         CLC   =C'KEYSONLY',QUESTOR                                             
         BE    DUMB0040                                                         
*                                                                               
         LR    R4,R0               RELOAD A(RECORD)                             
         MVC   P+50(20),RGKEYLEN(R4)                                            
*                                  MOVE COMMENT FIELD TO PRINT                  
         MVI   SPACING,2                                                        
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                                                               
         LA    R3,P                                                             
         LR    R4,R0               RELOAD A(RECORD)                             
         LA    R4,RGDTADSP(R4)     OFFSET TO NUMERIC DATA                       
         LA    R5,20                                                            
         SPACE 2                                                                
DUMB0020 EQU   *                                                                
         GOTO1 HEXOUT,DMCB,(R4),(R3),4,=C'SEP'                                  
         MVC   132(4,R3),4(R3)                                                  
         MVI   4(R3),C' '                                                       
         LA    R3,5(R3)                                                         
         LA    R4,4(R4)                                                         
         BCT   R5,DUMB0020                                                      
         MVC   P+99(32),SPACES                                                  
         MVI   SPACING,3                                                        
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
DUMB0040 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*  RESEQUENCE SORTED RECORDS OVER ENTIRE KEY TO ACCOMPLISH 'WITHIN'             
*        AT LOWER KEY LEVEL THAN POSITION TWO                                   
*                                                                               
RENUMBER NMOD1 0,*RENU*                                                         
         L     RC,0(R1)                                                         
         LA    R1,4(R1)            -->>POINT<<-- TO RANK SPEC                   
         ZIC   RF,0(R1)            RETRIEVE # OF RANK ROW                       
         BCTR RF,0                 BACK UP 1 ROW                                
         MH    RF,=Y(RGROWSZ)      MULTIPLY BY ROW SIZE TO GET                  
*                                     LENGTH OF COMPARISON                      
         ST    RF,LENCOMP          SAVE COMPARISON LENGTH                       
         ZIC   RF,0(R1)            RETRIEVE # OF RANK ROW AGAIN                 
         MH    RF,=Y(RGROWSZ)      MULTIPLY BY ROW SIZE                         
         LA    RE,REC                                                           
         AR    RE,RF               SET A(RANK VALUE)                            
         ST    RE,ADDRRANK         SAVE A(RANK VALUE)                           
         XC    PRIRANK,PRIRANK                                                  
         XC    PRIKEY,PRIKEY       CLEAR COMPARISON AREAS                       
*                                                                               
         OPEN  (RGWORK,INPUT)                                                   
         LA    R0,RENU0160                                                      
         STCM  R0,7,RGWORK+33      SET EOF ADDRESS                              
*                                                                               
         LA    RE,RGKEYLEN         SET KEYLENGTH IN SORT CARD                   
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SORTCD2+15(3),DUB                                                
*                                                                               
         GOTO1 SORTER,DMCB,SORTCD2,RECCARD                                      
*                                                                               
RENU0040 GET   RGWORK,REC                                                       
*                                                                               
*   TEST                                                                        
         CLC   =C'IN3OUT3',QUESTOR                                              
         BNE   RENU004X                                                         
         MVC   P+1(11),=C'INN(RENUM)='                                          
         MVC   P+12(108),REC                                                    
         GOTO1 REPORT                                                           
         MVI   P+1,C'G'                                                         
         MVI   P+2,C'='                                                         
         MVC   P+3(1),RPAGGTOT                                                  
         MVC   P+5(48),REC+RGDTADSP                                             
         GOTO1 REPORT                                                           
RENU004X EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         ZIC   RF,RPAGGTOT         AGGREGATE BASE REPORT:                       
         LTR   RF,RF                 TOTAL #ROWS NOT = ZERO?                    
         BZ    RENU0080            NO  - NOT AGGREGATE REPORT -                 
*                                  YES - OVERRIDE VALUE IF AGGREG               
*                                     OR AGGSPL RECORD                          
         LA    RF,1(RF)            TOTAL ROWS +1 FOR CONTROL                    
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                SET TO LAST POS, LAST ROW                    
         LA    RF,REC(RF)          ADD A(REC)                                   
         CLI   0(RF),X'00'         BYTE = 0?  AGGREGATE OR SPL                  
*                                     AS-RUN RECORD?                            
         BNE   RENU0080            NO - CONTINUE PROCESSING                     
*                                  YES - NEED TO CLEAR VALUE IN ROW             
         L     RF,ADDRRANK         LOAD A(RANK ROW)                             
         XC    0(9,RF),0(RF)       CLEAR THE RANK ROW                           
         B     RENU0120                                                         
RENU0080 EQU   *                                                                
         L     RF,LENCOMP          SET LENGTH OF COMPARE                        
         EX    RF,RENU0119         KEY = PRIOR KEY?                             
         BE    RENU0084            YES                                          
         XC    RANKCNT,RANKCNT     NO  - CLEAR RANK COUNTER                     
         B     RENU0088                                                         
RENU0084 EQU   *                                                                
         L     RF,ADDRRANK         SET A(RANK VALUE)                            
         CLC   0(4,RF),PRIRANK     RANK VALUE SAME AS PRIOR VALUE?              
         BE    RENU0092            YES - DON'T INCREMENT COUNTER                
RENU0088 EQU   *                                                                
         L     RF,RANKCNT          INCREMENT RANK COUNTER                       
         LA    RF,1(RF)                                                         
         ST    RF,RANKCNT                                                       
RENU0092 EQU   *                                                                
         L     RF,ADDRRANK         SET A(RANK VALUE)                            
         MVC   PRIRANK,0(RF)       SET PRIOR RANK VALUE                         
         L     RE,RANKCNT          INSERT NEW RANK NUMBER                       
         STCM  RE,15,0(RF)                                                      
         MVC   PRIKEY(99),REC+9    SAVE PRIOR KEY                               
         B     RENU0120                                                         
RENU0119 CLC   REC+9(0),PRIKEY                                                  
RENU0120 EQU   *                                                                
*                                                                               
*   TEST                                                                        
         CLC   =C'IN3OUT3',QUESTOR                                              
         BNE   RENU012X                                                         
         MVC   P+1(11),=C'OUT(RENUM)='                                          
         MVC   P+12(108),REC                                                    
         GOTO1 REPORT                                                           
RENU012X EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         GOTO1 SORTER,DMCB,=C'PUT',REC                                          
         B     RENU0040            GO BACK FOR NEXT RECORD                      
*                                                                               
RENU0160 DS    0H                  EOF                                          
         CLOSE RGWORK                                                           
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  6'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
*                                                                               
         OPEN  (RGWORK,OUTPUT)                                                  
*                                                                               
RENU0200 GOTO1 SORTER,DMCB,=C'GET'                                              
         ICM   RE,15,4(R1)                                                      
         BZ    RENU0240                                                         
         MVC   REC(RGRECLEN),0(RE)                                              
         PUT   RGWORK,REC                                                       
         B     RENU0200                                                         
*                                                                               
RENU0240 CLOSE RGWORK                                                           
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  7'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         XIT1                                                                   
*                                                                               
RANKCNT  DS    F                   RANK COUNTER                                 
LENCOMP  DS    F                   L(COMPARISON)                                
ADDRRANK DS    F                   ADDRESS OF RANK VALUE                        
PRIRANK  DS    F                   PRIOR RANK VALUE                             
PRIKEY   DS    CL108               PREVIOUS KEY FOR COMPARE                     
         EJECT                                                                  
*                                                                               
* --- LOCALREP - LOCAL REPORT INTERFACE CALL DUE TO DOWNLOADING                 
*                                                                               
*     P1  =  A(WORKSPACE)                                                       
*     P2  =  (1ST OR 2ND HALF INSTRUCTION FLAG)                                 
*            0 = USE 1ST HALF                                                   
*            1 = USE 2ND HALF                                                   
*                                                                               
LOCALREP NMOD1 0,*LOCA*                                                         
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
*                                                                               
         CLI   RCTRACE,C'Z'        'BROWSER' FILE RUN + PRINTOUT?               
         BE    LREP0020            YES                                          
         CLI   RCTRACE,C'B'        'BROWSER' RUN?                               
         BNE   LREP0020            NO                                           
         XC    P,P                 CLEAR OUT ALL PRINT LINES                    
         XC    PSECOND,PSECOND                                                  
         XC    PTHIRD,PTHIRD                                                    
         XC    PFOURTH,PFOURTH                                                  
         B     LREP0100            EXIT ROUTINE WITHOUT PRINTING                
LREP0020 EQU   *                                                                
         L     R4,VXADDR                                                        
         USING VXADDRD,R4                                                       
*                                                                               
         ZICM  R5,4(R1),4         GET HALF FLAG                                 
         BZ    LREP0040                                                         
*                                                                               
         L     RE,=A(DOWNTAB)                                                   
         LR    RF,RE                                                            
         LA    R1,LDOWNTAB                                                      
         AR    RF,R1                                                            
         BCTR  R1,0                                                             
         EX    R1,LREPEX1                                                       
         EX    R1,LREPEX2                                                       
         EX    R1,LREPEX1                                                       
*                                                                               
LREP0040 EQU   *                                                                
         GOTO1 =A(CONDOWN),DMCB,(RC)                                            
*                                                                               
*   CHECK IF DOWNLOAD REQUEST.  IF YES, CHECK DOWNLOAD TABLE TO                 
*     DETERMINE POSITION OF FIRST TEXT ON LINE.  IF THAT TEXT IS                
*     '*ALL*', DON'T OUTPUT THE LINE                                            
*                                                                               
         L     RF,VXRCDOWN                                                      
         CLI   0(RF),X'01'         DOWNLOAD REQUEST?                            
         BNE   LREP0080            NO                                           
         L     RF,VXDOWNDF         YES - EXAMINE TABLE                          
         LA    RE,P                A(PRINT LINE)                                
*                                                                               
*   TEST                                                                        
*        MVC   FOOT1(250),0(RF)                                                 
*   TEST END                                                                    
*                                                                               
         CLI   0(RF),C'O'          1ST ENTRY AN OFFSET?                         
         BNE   LREP0060            NO  -                                        
         ZIC   R3,1(RF)            YES - ADD OFFSET TO A(P)                     
         AR    RE,R3                                                            
         LA    RF,2(RF)            BUMP A(TABLE ENTRY)                          
LREP0060 EQU   *                                                                
         CLI   0(RF),C'T'          TABLE ENTRY TEXT?                            
         BNE   LREP0080            NO  - FINISHED                               
         CLC   =C'*ALL*',0(RE)     'ALL' LINE?                                  
         BNE   LREP0080            NO                                           
         BAS   RE,CLERDWN2         YES - CLEAR TABLE                            
LREP0080 EQU   *                                                                
         PRINT GEN                                                              
         GOTO1 REPORT,DMCB,WORKC,=C'PRINT'                                      
         PRINT NOGEN                                                            
*                                                                               
         L     RF,VXDOWNDF                                                      
         LA    R1,LVXDOWND                                                      
         SRL   R1,1                                                             
         EX    R1,LREPEX3                                                       
*                                                                               
         LTR   R5,R5              CHECK FLAG AGAIN                              
         BZ    LREP0100                                                         
*                                                                               
         L     RE,=A(DOWNTAB)                                                   
         LR    RF,RE                                                            
         LA    R1,LDOWNTAB                                                      
         AR    RF,R1                                                            
         BCTR  R1,0                                                             
         EX    R1,LREPEX1                                                       
         EX    R1,LREPEX2                                                       
         EX    R1,LREPEX1                                                       
LREP0100 EQU   *                                                                
*                                                                               
         XIT1                                                                   
         SPACE 2                                                                
LREPEX1  XC    0(0,RE),0(RF)                                                    
LREPEX2  XC    0(0,RF),0(RE)                                                    
LREPEX3  XC    0(0,RF),0(RF)                                                    
         SPACE 2                                                                
         DROP  R4                                                               
         SPACE 4                                                                
*                                                                               
* --- CLERDWN2 --- CLEAR THE DOWNLOAD DEFINITION LINE BECAUSE THE               
*                   CURRENT LINE IS NOT GOING TO BE PRINTED                     
*                                                                               
CLERDWN2 NTR1                                                                   
*                                                                               
         L     R4,VXADDR                                                        
         USING VXADDRD,R4                                                       
*                                                                               
         L     RF,VXDOWNDF                                                      
         LA    R1,LVXDOWND                                                      
         EX    R1,LREPEX3                                                       
*                                                                               
         L     RE,=A(DOWNTAB)                                                   
         LA    RF,LDOWNTAB                                                      
         SLL   RF,1                                                             
         XCEF                                                                   
*                                                                               
         XIT1                                                                   
         SPACE 3                                                                
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* --- PUTDOWN - ADD THE NEXT ENTRY TO THE DOWNLOAD DEFN LIST                    
*                                                                               
*     P1  =  (DATA TYPE)                    +0                                  
*             0 = NUMERIC                                                       
*             1 = TEXT                                                          
*     P2  =  (DATA LEN)                     +4                                  
*     P3  =  (PRINT COL OFFSET)             +8                                  
*     P4  =  (1ST OR 2ND HALF FLAG)         +12                                 
*            0 = FIRST HALF                                                     
*            1 = SECOND HALF                                                    
*     P5  =  A(WORKSPACE)                   +16                                 
*                                                                               
PUTDOWN  NMOD1 0,*PDOW*                                                         
         L     RC,16(R1)           RESET A(WORKSPACE)                           
         L     R5,VXADDR                                                        
         USING VXADDRD,R5                                                       
*                                                                               
         L     RF,VXRCDOWN                                                      
         CLI   0(RF),X'01'                                                      
         BNE   PDOWNOK                                                          
*                                                                               
         L     R4,=A(DOWNTAB)                                                   
         LR    R3,R4                                                            
*                                                                               
         OC    12(4,R1),12(R1)          PUT IN FIRST HALF OR SECOND?            
         BZ    PDOWN10                                                          
         LA    RF,LDOWNTAB                                                      
         AR    R4,RF                                                            
PDOWN10  EQU   *                                                                
         XC    FULL,FULL                BUILD ENTRY IN FULL                     
         MVC   FULL+0(1),P3+3           SET DATA COL                            
         MVC   FULL+1(1),P2+3           SET DATA LEN                            
         MVC   FULL+2(1),P1+3           SET TEXT FLAG                           
*                                                                               
         CLI   0(R4),0                  END OF LIST?                            
         BE    PDOWN50                  YES                                     
         CLC   0(1,R4),FULL             ENTRY ALREADY THERE?                    
         BE    PDOWN70                  YES, SKIP IT                            
         LA    R4,3(R4)                 BUMP TO NEXT ENTRY                      
         B     PDOWN10                  ...LOOP                                 
*                                                                               
PDOWN50  EQU   *                                                                
         MVC   0(3,R4),FULL             LOAD ENTRY                              
         CLI   PCTFLAG,1                                                        
         BNE   PDOWN70                                                          
         ZIC   RF,1(R4)                                                         
         LA    RF,1(RF)                                                         
         STC   RF,1(R4)                                                         
         MVI   PCTFLAG,0                                                        
PDOWN70  EQU   *                                                                
         XC    FULL,FULL                                                        
*                                                                               
PDOWNOK  EQU   *                                                                
         SR    R0,R0                                                            
         LTR   R0,R0                                                            
         XIT1                                                                   
         SPACE 3                                                                
         DS    0D                                                               
         SPACE 3                                                                
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
PRTCLEAR NMOD1 0,*PCLR*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R0,8(R1)            RESET R0                                     
         L     R1,4(R1)            RESET R1 (DONE LAST!)                        
         CLI   PRINTED,C'Y'        ANYTHING PRINTED AT THIS LEVEL?              
         BNE   PCLR0010            NO                                           
         ST    R1,CLEARR1          YES - SAVE CLEAR START ADDR                  
         ST    R0,CLEARR0          SAVE CLEAR END   ADDR                        
PCLR0010 EQU   *                                                                
         ST    R0,PR2R0            **TEST                                       
         ST    R1,PR2R1            **TEST                                       
         XC    PR2CTR,PR2CTR       **TEST                                       
*****>   BAS   RE,PR2CLEAR         **TEST                                       
         SR    R0,R1               GIVES LENGTH TO CLEAR                        
         BP    *+6                                                              
         DC    H'0'                                                             
         LA    R7,TOTROWLN                                                      
*                                                                               
PCLR0020 CR    R0,R7               FULL ROW LEFT?                               
         BL    PCLR0120            NO  -                                        
         OC    RPBCUME,RPBCUME     ANY BILLING CUME?                            
         BZ    PCLR0040            NO                                           
         LR    R4,R1                                                            
         LH    R5,RPBCUME          LOAD DISPLACE FOR BILLING CUME               
         AR    R4,R5                                                            
         MVC   DUB(4),0(R4)        YES - SAVE BILLING CUME FIGURE               
PCLR0040 EQU   *                                                                
         OC    RPPCCUME,RPPCCUME   ANY BILLING % CUME?                          
         BZ    PCLR0060            NO                                           
         LR    R4,R1                                                            
         LH    R5,RPPCCUME         LOAD DISPLACE FOR BILLING % CUME             
         AR    R4,R5                                                            
         MVC   DUB+4(4),0(R4)      SAVE BILLING CUME % FIGURE                   
PCLR0060 EQU   *                                                                
*        MVC   P(2),=C'IN'         **TEST**                                     
*        MVC   P+5(64),0(R1)       **TEST**                                     
*        MVC   P+75(4),=C'DUB='    **TEST**                                     
*        MVC   P+79(8),DUB         **TEST**                                     
*        MVC   P+89(4),=C'BPC='    **TEST**                                     
*        MVC   P+93(4),RPBCUME     **TEST**                                     
*        ST    R1,FULL             **TEST**                                     
*        MVC   P+98(3),=C'R1='     **TEST**                                     
*        MVC   P+102(4),FULL       **TEST**                                     
*        GOTO1 REPORT                                                           
***                                                                             
         XC    0(TOTROWLN,R1),0(R1)                                             
*                                  CLEAR ROW MONTH                              
*                                                                               
*                                  NOW REINSERT CUME COLUMNS                    
*                                                                               
         OC    RPBCUME,RPBCUME     ANY BILLING CUME?                            
         BZ    PCLR0080            NO                                           
         LR    R4,R1                                                            
         LH    R5,RPBCUME          LOAD DISPLACE FOR BILLING CUME               
         AR    R4,R5                                                            
         MVC   0(4,R4),DUB         RESTORE BILLING CUME FIGURE                  
PCLR0080 EQU   *                                                                
         OC    RPPCCUME,RPPCCUME   ANY BILLING % CUME?                          
         BZ    PCLR0100            NO                                           
         LR    R4,R1                                                            
         LH    R5,RPPCCUME         LOAD DISPLACE FOR BILLING % CUME             
         AR    R4,R5                                                            
         MVC   0(4,R4),DUB+4       RESTORE BILLING CUME % FIGURE                
PCLR0100 EQU   *                                                                
*        MVC   P(3),=C'OUT'        **TEST**                                     
*        MVC   P+5(64),0(R1)       **TEST**                                     
*        MVC   P+75(4),=C'DUB='    **TEST**                                     
*        MVC   P+79(8),DUB         **TEST**                                     
*        MVC   P+89(4),=C'BPC='    **TEST**                                     
*        MVC   P+93(4),RPBCUME     **TEST**                                     
*        ST    R1,FULL             **TEST**                                     
*        MVC   P+98(3),=C'R1='     **TEST**                                     
*        MVC   P+102(4),FULL       **TEST**                                     
*        GOTO1 REPORT                                                           
***                                                                             
         AR    R1,R7                                                            
         SR    R0,R7                                                            
         B     PCLR0020                                                         
PCLR0120 EQU   *                                                                
         LTR   R0,R0               ANYTHING LEFT?                               
         LR    R7,R0                                                            
         BCTR  R7,0                                                             
PCLR0140 EQU   *                                                                
         XC    PR2CTR,PR2CTR       **TEST                                       
*****    BAS   RE,PR2CLR2          **TEST                                       
         XIT1                                                                   
         SPACE 2                                                                
PR2R0    DS    F                                                                
PR2R1    DS    F                                                                
PR2CTR   DS    F                                                                
PR2FLG   DS    F                                                                
PR2CLEAR NTR1                                                                   
         MVC   P(09),=C'PRE-CLEAR'                                              
         MVC   P+17(3),=C'R1='                                                  
         EDIT  PR2R1,(6,P+20)                                                   
         MVC   P+27(3),=C'R0='                                                  
         EDIT  PR2R0,(6,P+30)                                                   
         L     R0,PR2R0            RESTORE START/END REGS                       
         L     R1,PR2R1                                                         
         B     P2CLEAR1                                                         
PR2CLR2  NTR1                                                                   
         MVC   P(10),=C'POST-CLEAR'                                             
         MVC   P+17(3),=C'R1='                                                  
         EDIT  PR2R1,(6,P+20)                                                   
         MVC   P+27(3),=C'R0='                                                  
         EDIT  PR2R0,(6,P+30)                                                   
         L     R0,PR2R0            RESTORE START/END REGS                       
         L     R1,PR2R1                                                         
P2CLEAR1 EQU   *                                                                
*******> B     P2CLEAR5            **TEST                                       
         GOTO1 REPORT              PRINT MESSAGE                                
         XC    PR2FLG,PR2FLG       CLEAR FLAG                                   
         SR    R0,R1               GIVES LENGTH TO CLEAR                        
         BP    *+6                                                              
         DC    H'0'                                                             
         LA    R5,TOTROWLN                                                      
         SRL   R5,1                DIVIDE ROW LENGTH BY 2                       
*                                                                               
P2CLEAR2 CR    R0,R5                                                            
         BL    P2CLEAR4                                                         
         BAS   RE,P2DISP                                                        
         GOTO1 REPORT                                                           
         AR    R1,R5                                                            
         SR    R0,R5                                                            
         B     P2CLEAR2                                                         
P2CLEAR4 EQU   *                                                                
         LTR   R0,R0               ANYTHING LEFT?                               
         BZ    P2CLEAR5            NO  FINISHED                                 
         LR    R5,R0                                                            
         BCTR  R5,0                                                             
         EX    R5,P2CLRXC                                                       
         GOTO1 REPORT                                                           
P2CLEAR5 EQU   *                                                                
         GOTO1 REPORT              PRINT BLANK LINE                             
         XIT1                                                                   
P2CLRXC  MVC   P(0),0(R1) *EXECUTED*                                            
*                                                                               
P2DISP   NTR1                                                                   
         LR    R2,R1                                                            
         OC    PR2FLG,PR2FLG       FLAG SET?                                    
         BNZ   P2DI0020            YES                                          
         L     RE,PR2CTR           NO  - BUMP COUNTER BY 1                      
         LA    RE,1(RE)                                                         
         ST    RE,PR2CTR           PUT IT BACK                                  
         EDIT  PR2CTR,(3,P)        EDIT COUNT INTO PRINT LINE                   
         ST    RE,PR2FLG           SET FLAG                                     
         B     P2DI0040                                                         
P2DI0020 EQU   *                                                                
         XC    PR2FLG,PR2FLG       TURN OFF FLAG                                
P2DI0040 EQU   *                                                                
         PRINT GEN                                                              
         GOTO1 HEXOUT,DMCB,(R2),P+10,(R5),=C'TOG'                               
         PRINT NOGEN                                                            
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* --- CHKSPEC# - COMPARE REC/NEWREC TO SEE IF A REPORT SPECIFICATION            
*        CHANGE HAS OCCURRED.  IF SO, SET NEWSPEC# TO PROVIDE CHANGE            
*        REQUIREMENT.                                                           
*                                                                               
         DS    0H                                                               
CHKSPEC# NMOD1 0,*CSPC*                                                         
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)            SET A(NEWREC)                                
         L     R3,8(R1)            SET A(REC)                                   
         MVI   NEWSPEC#,0          CLEAR NEW SPEC NUMBER                        
         LA    R2,17(R2)           A(1ST FIELD REPORT #) (NEWREC)               
         LA    R3,17(R3)           A(1ST FIELD REPORT #) (REC)                  
         LA    R0,12               MAXIMUM NUMBER OF FIELDS                     
CSPC0020 EQU   *                                                                
         CLI   0(R2),0             FIELD REPORT # = ZERO? (NEWREC)              
         BE    CSPC0100            YES - TEST NO FURTHER                        
         CLI   0(R3),0             FIELD REPORT # = ZERO? (REC)                 
         BE    CSPC0100            YES - TEST NO FURTHER                        
         CLC   0(1,R2),0(R3)       FIELD REPORT #S EQUAL?                       
         BNE   CSPC0040            NO  - CHANGE FOUND                           
         LA    R2,9(R2)            YES - BUMP TO NEXT FIELD                     
         LA    R3,9(R3)                                                         
         BCT   R0,CSPC0020                                                      
         B     CSPC0100            FINISHED                                     
CSPC0040 EQU   *                                                                
         MVC   NEWSPEC#,0(R2)      SAVE NEW REPORT #                            
CSPC0100 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   CHKAGGRS:  1.  CHECK FOR CHANGE IN REPORT SPEC #                            
*                  IF YES, SET FLAG, CHANGE REPORT, CHECK RECORD                
*              2.  CHECK RECORD TYPE                                            
*                  IF AGGREGATE BASE REPORT                                     
*                     IF AGGREGRATE OR SPL, TABLE IT                            
*                        ELSE                                                   
*                     IF DETAIL CHECK IT AGAINST TABLE                          
*                  ELSE                                                         
*                     CALL FOR 'ESTTOTAL' ROUTINE                               
*                     EXIT TO BREAK TESTING ROUTINE NEXR2160.                   
*   REPORT SPEC # ADDRESS IS CHANGED LOCALLY FOR TESTING THE NEW                
*      RECORD.  UPON EXIT, THE NEWSPEC# FLAG WILL SERVE TO RESET                
*      THE ADDRESS JUST BEFORE POSTING THE NEW FORMAT                           
*                                                                               
CHKAGGRS NMOD1 0,*AGRS*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         GOTO1 =A(CHKSPEC#),DMCB,(RC),NEWREC,REC                                
         CLI   NEWSPEC#,0          CHANGE IN REPORT SPEC #?                     
         BE    CAGG0020            NO                                           
         ZIC   R2,NEWSPEC#         YES - RESET REPORT SPEC ADDRESS              
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD)                                           
         A     R2,=A(RPDATA)       RESET A(REPORT SPEC)                         
*                                                                               
CAGG0020 EQU   *                                                                
****>>>  BAS   RE,CAGGDISP         **TEST**                                     
         ZIC   RF,RPAGGTOT         IS THIS AGGREGATE BASE REPORT?               
         LTR   RF,RF                 TOTAL #ROWS NOT = ZERO?                    
         BNZ   CAGG0040            YES - AGGREGATE REPORT                       
         LA    RF,NEWREC                                                        
         ST    RF,AACTIVE          SET A(ACTIVE RECORD)                         
         GOTO1 =A(AGGRTEST),DMCB,(RC),(R2),NEWREC,1                             
*                                  CALL FOR 'ESTTOTAL' ROUTINE ONLY             
         MVI   XFERTO,1            SET TRANSFER EXIT TO NEXR2160                
         B     CAGG0200            EXIT ROUTINE                                 
CAGG0040 EQU   *                                                                
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                SET TO LAST POS, LAST ROW                    
*                                                                               
*   TEST                                                                        
*        LR    R1,RF               SAVE RF                                      
*        BAS   RE,CAGGDIS2         DISPLAY NEWREC                               
*        LR    RF,R1               RESTORE RF                                   
*   END TEST                                                                    
*                                                                               
         LA    RF,NEWREC(RF)       ADD A(NEWREC)                                
         CLI   0(RF),X'00'         BYTE = 0: AGGREGATE OR SPL                   
*                                     AS-RUN RECORD                             
         BNE   CAGG0080            NO - CHECK ACTIVE VS AGGREGATE               
         PRINT GEN                                                              
         GOTO1 ,DMCB,(RC),(R2),(R8),NEWREC                                      
         PRINT NOGEN                                                            
         MVI   DMCB+12,1           SET FOR SPL AS-RUN RECORD                    
         CLI   1(RF),X'FF'         BYTE = FF: SPL AS-RUN RECORD                 
         BE    CAGG0060            YES - SPL RECORD                             
         MVI   DMCB+12,2           NO  - SET FOR AGGREGATE RECORD               
*                                  TABLE SPL RECORD                             
CAGG0060 EQU   *                   TABLE AGGREG RECORD                          
         GOTO1 =A(TABLDATA)                                                     
         MVI   XFERTO,2            SET TRANSFER EXIT TO NEXR1840                
         B     CAGG0200            GO BACK FOR NEXT                             
*                                                                               
CAGG0080 EQU   *                                                                
*                                                                               
         GOTO1 =A(AGGRTEST),DMCB,(RC),(R2),NEWREC,0                             
         GOTO1 =A(SPLASRUN),DMCB,(RC),(R2),NEWREC                               
         MVI   XFERTO,1            SET TRANSFER EXIT TO NEXR2160                
         B     CAGG0200            GO BACK FOR NEXT                             
CAGG0200 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   TEST                                                                        
CAGGDISP NTR1                                                                   
         MVC   P+1(09),=C'RPAGGBAS='                                            
         EDIT  RPAGGBAS,(2,P+11),FILL=0,ZERO=NOBLANK                            
         MVC   P+15(09),=C'RPAGGTOT='                                           
         EDIT  RPAGGTOT,(2,P+26),FILL=0,ZERO=NOBLANK                            
         MVC   P+30(08),=C'ADDRESS='                                            
         ST    R2,DMCB                                                          
         GOTO1 HEXOUT,DMCB,,P+40,4,=C'TOG'                                      
         GOTO1 REPORT                                                           
         XIT1                                                                   
*   END TEST                                                                    
*                                                                               
*                                                                               
*   TEST                                                                        
CAGGDIS2 NTR1                                                                   
         MVC   P+1(09),=C'NEWREC=  '                                            
         MVC   P+11(60),NEWREC                                                  
         MVC   P+75(08),=C'DISPLAC='                                            
         ST    R1,DMCB                                                          
         GOTO1 HEXOUT,DMCB,DMCB,P+85,4,=C'TOG'                                  
         GOTO1 REPORT                                                           
         XIT1                                                                   
*   END TEST                                                                    
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* --- CHKSPC#2 - COMPARE REC/BDGREC TO SEE IF A REPORT SPECIFICATION            
*        CHANGE HAS OCCURRED.  IF SO, SET NEWSPEC# TO PROVIDE CHANGE            
*        REQUIREMENT.                                                           
*                                                                               
         DS    0H                                                               
CHKSPC#2 NMOD1 0,*CSP2*                                                         
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)            SET A(REC)                                   
         L     R3,8(R1)            SET A(BDGREC)                                
         MVI   NEWSPEC#,0          CLEAR NEW SPEC NUMBER                        
         LA    R2,17(R2)           A(1ST FIELD REPORT #) (NEWREC)               
         LA    R3,17(R3)           A(1ST FIELD REPORT #) (REC)                  
         LA    R0,12               MAXIMUM NUMBER OF FIELDS                     
CSP20020 EQU   *                                                                
         CLI   0(R2),0             FIELD REPORT # = ZERO? (NEWREC)              
         BE    CSP20100            YES - TEST NO FURTHER                        
         CLI   0(R3),0             FIELD REPORT # = ZERO? (REC)                 
         BE    CSP20100            YES - TEST NO FURTHER                        
         CLC   0(1,R2),0(R3)       FIELD REPORT #S EQUAL?                       
         BNE   CSP20040            NO  - CHANGE FOUND                           
         LA    R2,9(R2)            YES - BUMP TO NEXT FIELD                     
         LA    R3,9(R3)                                                         
         BCT   R0,CSP20020                                                      
         B     CSP20100            FINISHED                                     
CSP20040 EQU   *                                                                
         MVC   NEWSPEC#,0(R2)      SAVE NEW REPORT #                            
CSP20100 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   CHKAGGR2:  1.  CHECK FOR CHANGE IN REPORT SPEC #                            
*                  IF YES, SET FLAG, CHANGE REPORT, CHECK RECORD                
*              2.  CHECK RECORD TYPE                                            
*                  IF AGGREGATE BASE REPORT                                     
*                     IF AGGREGRATE OR SPL, TABLE IT                            
*                        ELSE                                                   
*                     IF DETAIL CHECK IT AGAINST TABLE                          
*                  ELSE                                                         
*                     CALL FOR 'ESTTOTAL' ROUTINE                               
*                     EXIT TO BREAK TESTING ROUTINE NEXR2160.                   
*   REPORT SPEC # ADDRESS IS CHANGED LOCALLY FOR TESTING THE NEW                
*      RECORD.  UPON EXIT, THE NEWSPEC# FLAG WILL SERVE TO RESET                
*      THE ADDRESS JUST BEFORE POSTING THE NEW FORMAT                           
*                                                                               
CHKAGGR2 NMOD1 0,*AGR2*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         GOTO1 =A(CHKSPC#2),DMCB,(RC),REC,BDGREC                                
         CLI   NEWSPEC#,0          CHANGE IN REPORT SPEC #?                     
         BE    CAG20020            NO                                           
         ZIC   R2,NEWSPEC#         YES - RESET REPORT SPEC ADDRESS              
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD)                                           
         A     R2,=A(RPDATA)       RESET A(REPORT SPEC)                         
*                                                                               
CAG20020 EQU   *                                                                
****>>>  BAS   RE,CAG2DISP         **TEST**                                     
         ZIC   RF,RPAGGTOT         IS THIS AGGREGATE BASE REPORT?               
         LTR   RF,RF                 TOTAL #ROWS NOT = ZERO?                    
         BNZ   CAG20040            YES - AGGREGATE REPORT                       
         LA    RF,REC                                                           
         ST    RF,AACTIVE          SET A(ACTIVE RECORD)                         
         GOTO1 =A(AGGRTEST),DMCB,(RC),(R2),REC,1                                
*                                  CALL FOR 'ESTTOTAL' ROUTINE ONLY             
         MVI   XFERTO,1            SET TRANSFER EXIT TO NEXR2160                
         B     CAG20200            EXIT ROUTINE                                 
CAG20040 EQU   *                                                                
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                SET TO LAST POS, LAST ROW                    
*                                                                               
*   TEST                                                                        
*        LR    R1,RF               SAVE RF                                      
*        BAS   RE,CAG2DIS2         DISPLAY REC                                  
*        LR    RF,R1               RESTORE RF                                   
*   END TEST                                                                    
*                                                                               
         LA    RF,REC(RF)          ADD A(REC)                                   
         CLI   0(RF),X'00'         BYTE = 0: AGGREGATE OR SPL                   
*                                     AS-RUN RECORD                             
         BNE   CAG20080            NO - CHECK ACTIVE VS AGGREGATE               
         PRINT GEN                                                              
         GOTO1 ,DMCB,(RC),(R2),(R8),REC                                         
         PRINT NOGEN                                                            
         MVI   DMCB+12,1           SET FOR SPL AS-RUN RECORD                    
         CLI   1(RF),X'FF'         BYTE = FF: SPL AS-RUN RECORD                 
         BE    CAG20060            YES - SPL RECORD                             
         MVI   DMCB+12,2           NO  - SET FOR AGGREGATE RECORD               
*                                  TABLE SPL RECORD                             
CAG20060 EQU   *                   TABLE AGGREG RECORD                          
         GOTO1 =A(TABLDATA)                                                     
         MVI   XFERTO,2            SET TRANSFER EXIT TO NEXR1840                
         B     CAG20200            GO BACK FOR NEXT                             
*                                                                               
CAG20080 EQU   *                                                                
*                                                                               
         GOTO1 =A(AGGRTEST),DMCB,(RC),(R2),REC,0                                
         GOTO1 =A(SPLASRUN),DMCB,(RC),(R2),REC                                  
         MVI   XFERTO,1            SET TRANSFER EXIT TO NEXR2160                
         B     CAG20200            GO BACK FOR NEXT                             
CAG20200 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   TEST                                                                        
CAG2DISP NTR1                                                                   
         MVC   P+1(09),=C'RPAGGBAS='                                            
         EDIT  RPAGGBAS,(2,P+11),FILL=0,ZERO=NOBLANK                            
         MVC   P+15(09),=C'RPAGGTOT='                                           
         EDIT  RPAGGTOT,(2,P+26),FILL=0,ZERO=NOBLANK                            
         MVC   P+30(08),=C'ADDRESS='                                            
         ST    R2,DMCB                                                          
         GOTO1 HEXOUT,DMCB,,P+40,4,=C'TOG'                                      
         GOTO1 REPORT                                                           
         XIT1                                                                   
*   END TEST                                                                    
*                                                                               
*                                                                               
*   TEST                                                                        
CAG2DIS2 NTR1                                                                   
         MVC   P+1(09),=C'REC=     '                                            
         MVC   P+11(60),REC                                                     
         MVC   P+75(08),=C'DISPLAC='                                            
         ST    R1,DMCB                                                          
         GOTO1 HEXOUT,DMCB,DMCB,P+85,4,=C'TOG'                                  
         GOTO1 REPORT                                                           
         XIT1                                                                   
*   END TEST                                                                    
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* --- CHKSPC#3 - COMPARE REC/BDGREC TO SEE IF A REPORT SPECIFICATION            
*        CHANGE HAS OCCURRED.  IF SO, SET NEWSPEC# TO PROVIDE CHANGE            
*        REQUIREMENT.                                                           
*                                                                               
         DS    0H                                                               
CHKSPC#3 NMOD1 0,*CSP3*                                                         
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)            SET A(REC)                                   
         L     R3,8(R1)            SET A(BDGREC)                                
         MVI   NEWSPEC#,0          CLEAR NEW SPEC NUMBER                        
         LA    R2,17(R2)           A(1ST FIELD REPORT #) (NEWREC)               
         LA    R3,17(R3)           A(1ST FIELD REPORT #) (REC)                  
         LA    R0,12               MAXIMUM NUMBER OF FIELDS                     
CSP30020 EQU   *                                                                
         CLI   0(R2),0             FIELD REPORT # = ZERO? (NEWREC)              
         BE    CSP30100            YES - TEST NO FURTHER                        
         CLI   0(R3),0             FIELD REPORT # = ZERO? (REC)                 
         BE    CSP30100            YES - TEST NO FURTHER                        
         CLC   0(1,R2),0(R3)       FIELD REPORT #S EQUAL?                       
         BNE   CSP30040            NO  - CHANGE FOUND                           
         LA    R2,9(R2)            YES - BUMP TO NEXT FIELD                     
         LA    R3,9(R3)                                                         
         BCT   R0,CSP30020                                                      
         B     CSP30100            FINISHED                                     
CSP30040 EQU   *                                                                
         MVC   NEWSPEC#,0(R2)      SAVE NEW REPORT #                            
CSP30100 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   CHKAGGR3:  1.  CHECK RECORD TYPE                                            
*                  IF AGGREGATE BASE REPORT                                     
*                     IF AGGREGRATE OR SPL, TABLE IT                            
*                        ELSE                                                   
*                     IF DETAIL CHECK IT AGAINST TABLE                          
*                                                                               
CHKAGGR3 NMOD1 0,*AGR3*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         GOTO1 =A(CHKSPC#3),DMCB,(RC),REC,BDGREC                                
         CLI   NEWSPEC#,0          CHANGE IN REPORT SPEC #?                     
         BE    CAG30020            NO                                           
         ZIC   R2,NEWSPEC#         YES - RESET REPORT SPEC ADDRESS              
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD)                                           
         A     R2,=A(RPDATA)       RESET A(REPORT SPEC)                         
*                                                                               
*   TEST                                                                        
*        CLC   =C'TABLDATA',QUESTOR                                             
*        BNE   CAG30005                                                         
*        MVC   P+1(13),=C'CHG IN SPEC ='                                        
*        MVC   P+15(1),NEWSPEC#                                                 
*        GOTO1 REPORT                                                           
CAG30005 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
*                                                                               
CAG30020 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        CLC   =C'TABLDATA',QUESTOR                                             
*        BNE   CAG30022                                                         
*        BAS   RE,CAG3DISP         **TEST**                                     
CAG30022 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         ZIC   RF,RPAGGTOT         IS THIS AGGREGATE BASE REPORT?               
         LTR   RF,RF                 TOTAL #ROWS NOT = ZERO?                    
         BNZ   CAG30040            YES - AGGREGATE REPORT                       
         LA    RF,REC                                                           
         ST    RF,AACTIVE          SET A(ACTIVE RECORD)                         
         GOTO1 =A(AGGRTEST),DMCB,(RC),(R2),REC,1                                
*                                  CALL FOR 'ESTTOTAL' ROUTINE ONLY             
         B     CAG30200            EXIT ROUTINE                                 
CAG30040 EQU   *                                                                
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                SET TO LAST POS, LAST ROW                    
*                                                                               
*   TEST                                                                        
*        CLC   =C' ABLDATA',QUESTOR                                             
*        BNE   CAG30042                                                         
*        LR    R1,RF               SAVE RF                                      
*        BAS   RE,CAG3DIS2         DISPLAY REC                                  
*        LR    RF,R1               RESTORE RF                                   
CAG30042 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         LA    RF,REC(RF)          ADD A(REC)                                   
         CLI   0(RF),X'00'         BYTE = 0: AGGREGATE OR SPL                   
*                                     AS-RUN RECORD                             
         BNE   CAG30080            NO - CHECK ACTIVE VS AGGREGATE               
*                                                                               
*   TEST                                                                        
*        LR    R1,RF               SAVE RF                                      
*        CLC   =C'TABLDATA',QUESTOR                                             
*        BNE   CAG30050                                                         
*        MVC   P+1(8),=C'CHKAGGR3'                                              
*        MVC   P+12(60),REC                                                     
*        GOTO1 REPORT                                                           
*        LR    RF,R1               RESTORE RF                                   
CAG30050 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         GOTO1 ,DMCB,(RC),(R2),(R8),REC                                         
         MVI   DMCB+12,1           SET FOR SPL AS-RUN RECORD                    
         CLI   1(RF),X'FF'         BYTE = FF: SPL AS-RUN RECORD                 
         BE    CAG30060            YES - SPL RECORD                             
         MVI   DMCB+12,2           NO  - SET FOR AGGREGATE RECORD               
*                                  TABLE SPL RECORD                             
CAG30060 EQU   *                   TABLE AGGREG RECORD                          
         GOTO1 =A(TABLDATA)                                                     
         B     CAG30200            GO BACK FOR NEXT                             
*                                                                               
CAG30080 EQU   *                                                                
*                                                                               
         GOTO1 =A(AGGRTEST),DMCB,(RC),(R2),REC,0                                
****>>>  GOTO1 =A(SPLASRUN),DMCB,(RC),(R2),REC                                  
         B     CAG30200            GO BACK FOR NEXT                             
CAG30200 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   TEST                                                                        
CAG3DISP NTR1                                                                   
         MVC   P+1(7),=C'SPECIAL'                                               
         MVC   P+11(09),=C'RPAGGBAS='                                           
         EDIT  RPAGGBAS,(2,P+21),FILL=0,ZERO=NOBLANK                            
         MVC   P+25(09),=C'RPAGGTOT='                                           
         EDIT  RPAGGTOT,(2,P+36),FILL=0,ZERO=NOBLANK                            
         MVC   P+40(08),=C'ADDRESS='                                            
         ST    R2,DMCB                                                          
         GOTO1 HEXOUT,DMCB,,P+50,4,=C'TOG'                                      
         GOTO1 REPORT                                                           
         XIT1                                                                   
*   END TEST                                                                    
*                                                                               
*                                                                               
*   TEST                                                                        
CAG3DIS2 NTR1                                                                   
         MVC   P+1(09),=C'REC=     '                                            
         MVC   P+11(60),REC                                                     
         MVC   P+75(08),=C'DISPLAC='                                            
         ST    R1,DMCB                                                          
         GOTO1 HEXOUT,DMCB,DMCB,P+85,4,=C'TOG'                                  
         GOTO1 REPORT                                                           
         XIT1                                                                   
*   END TEST                                                                    
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* --- CONDOWN - CONVERT DOWNTAB TO A TABLE THE DOWNLOADER CAN USE               
*                                                                               
         DS    0H                                                               
CONDOWN  NMOD1 0,*CDOW*                                                         
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R5,VXADDR                                                        
         USING VXADDRD,R5                                                       
*                                                                               
         L     RF,VXRCDOWN                                                      
         CLI   0(RF),X'01'                                                      
         BNE   CONDNOK                                                          
*                                                                               
         L     R4,=A(DOWNTAB)                                                   
         CLI   0(R4),0                                                          
         BE    CONDNOK                                                          
*                                                                               
CONDN10  EQU   *                                                                
         LR    R6,R4                                                            
         SR    R7,R7                                                            
CONDN20  EQU   *                                                                
         CLC   3(3,R6),=X'000000'                                               
         BE    CONDN30                                                          
         CLC   0(1,R6),3(R6)                                                    
         BNH   CONDN25                                                          
         MVC   DMCB(3),0(R6)                                                    
         MVC   0(3,R6),3(R6)                                                    
         MVC   3(3,R6),DMCB                                                     
         LA    R7,1                                                             
CONDN25  EQU   *                                                                
         LA    R6,3(R6)                                                         
         B     CONDN20                                                          
CONDN30  EQU   *                                                                
         LTR   R7,R7                                                            
         BNZ   CONDN10                                                          
*                                                                               
         L     R3,VXDOWNDF                                                      
         L     R4,=A(DOWNTAB)                                                   
         SR    R2,R2                                                            
CONDN60  EQU   *                                                                
         ZICM  RF,0(R4),1                                                       
         BZ    CONDN90                                                          
         CLC   0(3,R4),3(R4)          DUPLICATE ENTRY                           
         BE    CONDN85                  YES, SKIP IT                            
         CR    R2,RF                                                            
         BE    CONDN70                                                          
         BL    *+6                                                              
         DC    H'0'                                                             
         MVI   0(R3),C'O'                                                       
         SR    RF,R2                                                            
         STC   RF,1(R3)                                                         
         LA    R3,2(R3)                                                         
         AR    R2,RF                                                            
CONDN70  EQU   *                                                                
         CLI   1(R4),0                                                          
         BE    CONDN85                  NULL ENTRY                              
         MVI   0(R3),C'N'               SET TO NUMERIC                          
         CLI   2(R4),X'00'                                                      
         BE    CONDN80                                                          
         MVI   0(R3),C'T'               BUT RE-SET TO TEXT IF SO                
CONDN80  EQU   *                                                                
         ZIC   RF,1(R4)                                                         
         STC   RF,1(R3)                                                         
         AR    R2,RF                                                            
         LA    R3,2(R3)                                                         
CONDN85  EQU   *                                                                
         LA    R4,3(R4)                                                         
         B     CONDN60                                                          
*                                                                               
CONDN90  EQU   *                                                                
         L     R4,=A(DOWNTAB)                                                   
         XC    0(LDOWNTAB,R4),0(R4)                                             
*                                                                               
CONDNOK  EQU   *                                                                
         SR    R0,R0                                                            
         LTR   R0,R0                                                            
         XIT1                                                                   
*                                                                               
         DROP  R5                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* EXTENSION ROUTINES                                                  *         
***********************************************************************         
         SPACE 1                                                                
         DS     0F                                                              
EXTRA    NMOD1  0,**RG3X**                                                      
         L     RC,AWORKD                                                        
         USING WORKD,RC                                                         
         SRL   RF,24                                                            
         SLL   RF,2                                                             
         B     *+4(RF)                                                          
*                                                                               
         B     GETNAME                                                          
         B     GETADV                                                           
         B     GETAGY                                                           
         B     GETCONT                                                          
*                                                                               
XIT      XIT1  ,                                                                
         EJECT                                                                  
***********************************************************************         
* SUBROUTINE TO BUILD PRINTABLE CODES AND EXTRACT NAMES AS REQUIRED   *         
* PRINTABLE DATA IS RETURNED IN WORK(64)                              *         
* EXIT - CC EQ - OK                                                   *         
*        CC NE - EOF                                                  *         
***********************************************************************         
         SPACE 1                                                                
GETNAME  MVC   WORK,SPACES                                                      
         CLC   REC+RGROWSZ(RGROWSZ-1),XFF  TEST EOF                             
         BE    GETNMEOF                                                         
         ZIC   R1,CBLEVEL          GET ROW NUMBER                               
         MH    R1,=Y(RGROWSZ)                                                   
         LA    R1,REC(R1)          POINT TO ROW CODE                            
         MVC   WORK(8),0(R1)       MOVE DATA CODE                               
         ZIC   RE,RPBUDPAS         BUDPAS SPEC?                                 
         LTR   RE,RE                                                            
         BZ    GETN0020            NO                                           
*                                                                               
*  FOR BUDGET SPECS, BUDGET RECORDS WILL CONTAIN TWO POSITIONS OF               
*      'FFFF', FOLLOWED BY KEYWORD 'BUDGET' WHERE NAMES CANNOT                  
*      BE RETRIEVED.                                                            
*                                                                               
         CLC   WORK(2),=X'FFFF'    YES - 'BUDGET' ROW?                          
         BNE   GETN0020            NO                                           
         CLC   WORK+2(6),=C'BUDGET'                                             
         BE    GETNAMX             BUDGET:  DON'T GET NAME                      
*                                                                               
GETN0020 EQU   *                                                                
         L     R4,ASPACND4         POINT TO DATA BUFFER                         
         SPACE 1                                                                
* GET BRANCH TABLE ADDRESS *                                                    
         SPACE 1                                                                
         ZIC   RE,CBLEVEL          GET ROW NUMBER                               
         SLL   RE,2                X 4                                          
         L     RE,RPROWDEF(RE)     POINT TO ROWDEF SPEC                         
         MVC   BYTE,3(RE)          MOVE DATA CODE                               
         ZIC   RE,BYTE                                                          
         CH    RE,=Y((GETTABX-GETTAB)/4) TEST DATA CODE IN TABLE                
         BNH   *+6                                                              
         DC    H'0'                                                             
         BCTR  RE,0                                                             
         SLL   RE,2                X 4                                          
         L     RF,GETTAB(RE)       GET ROUTINE ADDRESS                          
         BR    RF                  GO                                           
*                                                                               
* MAKE DUB MATCH SPACEND, AND WORK BE IN PRINTABLE FORM                         
*                                                                               
GETSTA   EQU   *                                                                
         LR    RF,R1                                                            
         GOTO1 =A(GGENNMOD),DMCB,(RC),(RF),(1,0)                                
         BZ    GETNAMX             CC = 0: EXIT GETNAME ROUTINE                 
         B     BADNAME             CC N= ZERO: EXIT **UNKNOWN**                 
*                                                                               
GETRGN   TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    GETNAMX                                                          
*                                                                               
GETRGN2  MVI   ELCODE,3                                                         
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETRGN4  BAS   RE,NXTEL4                                                        
         BE    GETRGN5                                                          
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RREGNAME-RREGREC(RF)                                  
         B     GETNAMX                                                          
GETRGN5  EQU   *                                                                
         CLC   REC+RGCMPDSP(2),DRGNREP(R4)     MATCH REP ID                     
         BNE   GETRGN4                                                          
         CLC   0(2,R1),DRGNRGN(R4)       MATCH REGION                           
         BNE   GETRGN4                                                          
         MVC   WORK+8(20),DRGNNAM(R4)                                           
         B     GETNAMX                                                          
         SPACE 1                                                                
GETOFC   EQU   *                                                                
         LR    RF,R1                                                            
         GOTO1 =A(GGENNMOD),DMCB,(RC),(RF),(3,0)                                
         BZ    GETNAMX             CC = 0: EXIT GETNAME ROUTINE                 
         B     BADNAME             CC N= ZERO: EXIT **UNKNOWN**                 
GETTM    TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    GETNAMX                                                          
*                                                                               
GETTM2   MVI   ELCODE,5                                                         
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETTM4   BAS   RE,NXTEL4                                                        
         BE    GETTM5                                                           
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(10),RTEMNAME-RTEMREC(RF)                                  
         B     GETNAMX                                                          
GETTM5   EQU   *                                                                
         CLC   =C'**',2(R4)        FLAG TO IGNORE REP TEST?                     
         BE    GETTM6              YES                                          
         CLC   REC+RGCMPDSP(2),2(R4)                                            
*                                  NO  - REP ID'S MATCHED?                      
         BNE   GETTM4              NO                                           
GETTM6   EQU   *                                                                
         CLC   0(2,R1),4(R4)       SAME DIV/TEAM?                               
         BNE   GETTM4              NO                                           
         MVC   WORK+8(10),16(R4)   YES - EXTRACT TEAM NAME                      
         B     GETNAMX                                                          
*                                                                               
GETSP    TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    GETNAMX                                                          
*                                                                               
GETSP2   MVI   ELCODE,6                                                         
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETSP4   BAS   RE,NXTEL4                                                        
         BE    GETSP5                                                           
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RSALNAME-RSALREC(RF)                                  
         B     GETNAMX                                                          
GETSP5   EQU   *                                                                
         CLC   =C'**',DSALREP(R4)  FLAG TO IGNORE REP TEST?                     
         BE    GETSP6              YES                                          
         CLC   REC+RGCMPDSP(2),DSALREP(R4)                                      
*                                  NO  - REP ID'S MATCHED?                      
         BNE   GETSP4              NO                                           
GETSP6   EQU   *                                                                
         CLC   0(3,R1),DSALSAL(R4)       MATCH SALESPERSON ID                   
         BNE   GETSP4                                                           
         MVC   WORK+8(20),DSALNAM(R4)                                           
         B     GETNAMX                                                          
*                                                                               
GETDEVSP TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    GETNAMX                                                          
*                                                                               
GETDSP2  MVI   ELCODE,X'3A'        DEV S/P ELEMENT CODE                         
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETDSP4  BAS   RE,NXTEL4                                                        
         BNE   BADNAME                                                          
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RDSPNAME-RDSPREC(RF)                                  
         B     GETNAMX                                                          
GETDSP5  EQU   *                                                                
         CLC   =C'**',2(R4)        FLAG TO IGNORE REP TEST?                     
         BE    GETDSP6             YES                                          
         CLC   REC+RGCMPDSP(2),2(R4)                                            
*                                  NO  - REP ID'S MATCHED?                      
         BNE   GETDSP4             NO                                           
GETDSP6  EQU   *                                                                
         CLC   0(3,R1),4(R4)       MATCH DEV S/P ID                             
         BNE   GETDSP4                                                          
         MVC   WORK+8(20),7(R4)                                                 
         B     GETNAMX                                                          
*                                                                               
GETDEVCT TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    GETNAMX                                                          
*                                                                               
GETDCT2  MVI   ELCODE,X'3B'        DEV CONTYPE ELEMENT CODE                     
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETDCT4  BAS   RE,NXTEL4                                                        
         BE    GETDCT5                                                          
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RDCTDESC-RDCTREC(RF)                                  
         B     GETNAMX                                                          
GETDCT5  EQU   *                                                                
         CLC   0(2,R1),DCTCTY(R4)       MATCH CONTRACT TYPE                     
         BNE   GETDCT4                                                          
         MVC   WORK+8(20),DCTDESC(R4)                                           
         B     GETNAMX                                                          
*                                                                               
GETGRP   EQU   *                                                                
         LR    RF,R1                                                            
         GOTO1 =A(GGENNMOD),DMCB,(RC),(RF),(4,0)                                
         BZ    GETNAMX             CC = 0: EXIT GETNAME ROUTINE                 
         B     BADNAME             CC N= ZERO: EXIT **UNKNOWN**                 
*                                                                               
GETADV   EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        CLC   =C'A010',0(R1)                                                   
*        BNE   GETEST01                                                         
*        LTR   RB,RB                                                            
GETEST01 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         LA    RF,WORK+3           EVEN UP WORK-AREA CODE LENS                  
GADV0010 EQU   *                                                                
         CLI   0(RF),C' '          SPACE?                                       
         BNE   GADV0020            NO  - FINISHED                               
         MVI   0(RF),X'FF'         YES - REPL WITH NON-SQUASH VALUE             
         BCTR  RF,0                                                             
         B     GADV0010                                                         
GADV0020 EQU   *                                                                
         MVC   ADVSAVE,0(R1)       SAVE ADV CODE FOR PRODUCTS                   
         ZIC   RE,RPBUDPAS         BUDPAS SPEC?                                 
         LTR   RE,RE                                                            
         BZ    GADV0030            NO                                           
*                                                                               
*  FOR BUDGET SPECS, BUDGET RECORDS WILL CONTAIN TWO POSITIONS OF               
*      'FFFF', FOLLOWED BY KEYWORD 'BUDGET' WHERE NAMES CANNOT                  
*      BE RETRIEVED.                                                            
*                                                                               
         CLC   0(2,R1),=X'FFFF'    YES - 'BUDGET' ROW?                          
         BNE   GADV0030            NO                                           
         CLC   2(6,R1),=C'BUDGET'                                               
         BNE   GADV0030            NO                                           
         MVC   WORK+8(8),0(R1)     INSERT BUDFLAG VALUE                         
         B     GETNAMX             BUDGET:  DON'T GET NAME                      
*                                                                               
GADV0030 EQU   *                                                                
         XC    KEY,KEY                                                          
         MVI   KEY,8                                                            
         MVC   KEY+21(4),0(R1)                                                  
         MVC   KEY+25(2),RCREPFL                                                
*                                                                               
GADV0040 BAS   RE,HIGH                                                          
         CLC   KEY(27),KEYSAVE                                                  
         BE    GADV0050                                                         
***      CLC   KEY(25),KEYSAVE     ZZ CODES NOT IN USE ANYMORE                  
***      BE    GADV0048                                                         
         CLI   RECLABEL,C'Y'       ADVNAME FILL-IN?                             
         BNE   GADV0042            NO  - DUMP IT OUT                            
****>>>  MVI   RECLABEL+1,C'Y'     YES - SEND BACK NO-FIND FLAG                 
         MVC   WORK+8(20),SPACES                                                
         MVC   WORK+8(14),=C'ADVERT MISSING'                                    
         B     GETNAMX                                                          
GADV0042 EQU   *                                                                
         MVI   ELCODE,X'08'        SET TO ADVERTISER REC CODE                   
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RADVNAME-RADVREC(RF)                                  
         B     GETNAMX                                                          
GADV0048 EQU   *                                                                
*        MVC   KEY+25(2),=C'ZZ'                                                 
*        XC    KEY+27(5),KEY+27                                                 
*        B     GADV0040                                                         
*                                                                               
GADV0050 L     R1,FILEC                                                         
         LA    RF,RADVREC-FILED(R1)                                             
         BAS   RE,LINKFILE                                                      
         MVC   WORK+8(20),RADVNAME-FILED(R1)                                    
         B     GETNAMX                                                          
*                                                                               
*   PRODUCT CODE:  ORIGINAL CODING HAD IDENTIFIED LEGITIMATE PROD               
*        CODES AS HAVING THE X'80' BIT TURNED ON IN THE FIRST CHAR.             
*        PRODUCT NAMES HAD THIS BIT TURNED OFF.  HOWEVER, PROD                  
*        CODES COULD BE ESTABLISHED IN WHICH THE FIRST CHAR WAS                 
*        A SPECIAL CHARACTER, IN WHICH CASE THE TEST FAILED.                    
*        A CHANGE TO RERG02 SETS THE FOURTH CHAR OF THE FIELD TO                
*        X'FF' IF A PRODUCT CODE BEGINNING WITH A SPECIAL CHARACTER             
*        IS ENCOUNTERED.  THE SPECIAL CHARACTER WILL NOT PRINT.                 
*                                                                               
GETPRD   TM    0(R1),X'80'         TEST SPECIAL PRODUCT CODE                    
         BO    GETPRD2             NO                                           
         CLI   3(R1),X'FF'         SPECIAL CHAR IN FIRST POSITION?              
         BE    GETPRD2             YES                                          
         OI    WORK,X'80'          NO  - PRODUCT NAME LITERAL                   
         TM    6(R1),X'80'         TEST JUST FIRST 8 CHARCATERS                 
         BZ    GETPRD0             NO                                           
         MVC   WORK+8(8),0(R1)     YES-                                         
         OI    WORK+8,X'80'                                                     
         CLI   WORK+14,X'C0'                                                    
         BNE   *+8                                                              
         MVI   WORK+14,X'40'                                                    
         B     GETNAMX                                                          
*                                                                               
GETPRD0  L     RE,ASPACND4          YES-LOOK FOR IT IN SPACEND                  
         SR    R0,R0                                                            
*                                                                               
GETPRD1  CLI   0(RE),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(RE),9                                                          
         BNE   *+14                                                             
         CLC   6(2,R1),2(RE)                                                    
         BE    *+14                                                             
         IC    R0,1(RE)                                                         
         AR    RE,R0                                                            
         B     GETPRD1                                                          
         MVC   WORK+8(20),4(RE)                                                 
         B     GETNAMX                                                          
*                                                                               
GETPRD2  EQU   *                                                                
*                                                                               
         CLC   0(3,R1),SPACES      GET PRODUCT NAME FROM CODE                   
         BNH   GETNAMX                                                          
         XC    KEY,KEY                                                          
         MVI   KEY,9                                                            
         MVC   KEY+18(4),ADVSAVE                                                
         MVC   KEY+22(3),0(R1)                                                  
         MVC   KEY+25(2),RCREPFL                                                
         BAS   RE,HIGH                                                          
         CLC   KEY(27),KEYSAVE                                                  
         BNE   GETPRD3            PRODUCT RECORD NOT THERE                      
*                                                                               
         L     R1,FILEC                                                         
         LA    RF,RPRDREC-FILED(R1)                                             
         BAS   RE,LINKFILE                                                      
         MVC   WORK+8(20),RPRDNAME-FILED(R1)                                    
         B     GETNAMX                                                          
*                                                                               
GETPRD3  MVC   WORK+8(17),=CL17'NEED PRODUCT CODE'                              
         B     GETNAMX                                                          
*                                                                               
GETAGY   EQU   *                                                                
         LR    RF,R1                                                            
         GOTO1 =A(GGENNMOD),DMCB,(RC),(RF),(2,0)                                
         BZ    GETNAMX             CC = 0: EXIT GETNAME ROUTINE                 
         B     BADNAME             CC N= ZERO: EXIT **UNKNOWN**                 
*                                                                               
GETAFL   MVC   WORK+8(3),0(R1)     CODE = NAME                                  
         B     GETNAMX                                                          
*                                                                               
*   RETRIEVE BUYLINE CODE:  TYPE 1 SUBTYPE OF 4B RECORD                         
*                                                                               
GETBCOD  EQU   *                                                                
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVI   ELCODE,X'4B'                                                     
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETBCOD2 BAS   RE,NXTEL4                                                        
         BNE   BADNAME             NOT FOUND                                    
         CLI   2(R4),1             TYPE 1 SUBTYPE?                              
         BNE   GETBCOD2            NO  - GO BACK FOR NEXT                       
         CLC   0(3,R1),3(R4)       YES - BUYLINE CODE FOUND?                    
         BNE   GETBCOD2            NO  - GO BACK FOR NEXT                       
         MVC   WORK+8(20),6(R4)    YES -                                        
         B     GETNAMX                                                          
*                                                                               
*                                                                               
*   RETRIEVE ATTRIBUTE 1 :  TYPE 0 SUBTYPE OF 4B RECORD                         
*                                                                               
GETATT1  EQU   *                                                                
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVI   ELCODE,X'4B'                                                     
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETATT12 BAS   RE,NXTEL4                                                        
         BNE   BADNAME             NOT FOUND                                    
         CLI   2(R4),0             TYPE 1 SUBTYPE?                              
         BNE   GETATT12            NO  - GO BACK FOR NEXT                       
         CLC   0(2,R1),3(R4)       YES - ATTRIBUTE1 FOUND?                      
         BNE   GETATT12            NO  - GO BACK FOR NEXT                       
         MVC   WORK+8(20),6(R4)    YES -                                        
         B     GETNAMX                                                          
*                                                                               
*                                                                               
*                                                                               
*   RETRIEVE ATTRIBUTE 2 :  TYPE 0 SUBTYPE OF 4B RECORD                         
*                                                                               
GETCONED EQU   *                   CONTRACT END DATE                            
*                                     ALREADY SET UP IN FIELD                   
*                                        WILL USE DATA IN BUCKET                
         B     GETNAMX                                                          
*                                                                               
GETJOIND EQU   *                   STATION JOIN DATE                            
*                                     ALREADY SET UP IN FIELD                   
*                                        WILL USE DATA IN BUCKET                
         B     GETNAMX                                                          
*                                                                               
GETATT2  EQU   *                                                                
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVI   ELCODE,X'4B'                                                     
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETATT22 BAS   RE,NXTEL4                                                        
         BNE   BADNAME             NOT FOUND                                    
         CLI   2(R4),0             TYPE 1 SUBTYPE?                              
         BNE   GETATT22            NO  - GO BACK FOR NEXT                       
         CLC   0(2,R1),3(R4)       YES - ATTRIBUTE2 FOUND?                      
         BNE   GETATT22            NO  - GO BACK FOR NEXT                       
         MVC   WORK+8(20),6(R4)    YES -                                        
         B     GETNAMX                                                          
*                                                                               
GETCON   UNPK  WORK(9),0(5,R1)     UNPACK 1 EXTRA BYTE                          
****>>   MVI   WORK+8,C' '                                                      
         MVC   WORK+8(1),REC+RGFCSDSP                                           
*                                  ADD 'FORECAST?' FLAG ('F' OR ' ')            
         B     GETNAMX                                                          
*                                                                               
GETCLS   XC    KEY,KEY                                                          
         MVI   KEY,X'0D'                                                        
         MVC   KEY+23(2),RCREPFL                                                
         MVC   KEY+25(2),0(R1)                                                  
         BAS   RE,HIGH                                                          
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+14                                                             
         MVC   WORK+8(13),=C'** UNKNOWN **'                                     
         B     GETNAMX                                                          
         L     R1,FILEC                                                         
         LA    RF,RCLSREC-FILED(R1)                                             
         BAS   RE,LINKFILE                                                      
         MVC   WORK+8(30),RCLSNAME-FILED(R1)                                    
         B     GETNAMX                                                          
*                                                                               
GETCTG   TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVI   ELCODE,15                                                        
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
*                                                                               
GETCTG2  BAS   RE,NXTEL4                                                        
         BE    GETCTG5                                                          
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RCTGNAME-RCTGREC(RF)                                  
         B     GETNAMX                                                          
GETCTG5  EQU   *                                                                
         CLC   0(2,R1),2(R4)                                                    
         BNE   GETCTG2                                                          
         MVC   WORK+8(30),6(R4)                                                 
         B     GETNAMX                                                          
*                                                                               
GETRANK  L     R0,0(R1)                                                         
         CVD   R0,DUB                                                           
         MVC   WORK(6),=X'402020202120'                                         
         ED    WORK(6),DUB+5                                                    
         MVC   WORK+8(4),WORK+2    MOVE 4 DIGITS TO NAME                        
         MVC   WORK+12(2),4(R1)    MOVE = AND/OR * SIGN IF PRESENT              
         CLI   4(R1),C'+'          RANKMAX+1?                                   
         BNE   GRNK0010            NO                                           
         MVI   OTHRNAME,C'Y'       YES - SET NAME OVERRIDE FLAG                 
GRNK0010 EQU   *                                                                
         MVC   WORK(8),SPACES      BLANK ROW CODE DATA                          
         MVC   WORK(6),WORK+8      LOAD RANK NUMBER TO CODE FIELD               
         B     GETNAMX                                                          
*                                                                               
GETSTNTY CLI   0(R1),C'1'                                                       
         BNE   *+10                                                             
         MVC   WORK+8(13),=C'COMP STATIONS'                                     
         CLI   0(R1),C'2'                                                       
         BNE   *+10                                                             
         MVC   WORK+8(12),=C'NEW STATIONS'                                      
         CLI   0(R1),C'3'                                                       
         BNE   *+10                                                             
         MVC   WORK+8(12),=C'OLD STATIONS'                                      
         CLI   0(R1),C'4'                                                       
         BNE   *+10                                                             
         MVC   WORK+8(12),=C'ALL STATIONS'                                      
         B     GETNAMX                                                          
*                                                                               
GETOWNER TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
*                                                                               
         XC    KEY,KEY                                                          
         MVI   KEY,X'2A'                                                        
         MVC   KEY+22(2),RCREPFL                                                
         MVC   KEY+24(3),0(R1)                                                  
*                                                                               
         BAS   RE,HIGH                                                          
         CLC   KEY(27),KEYSAVE                                                  
         BE    GETOWN5                                                          
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),ROWNNAME-ROWNREC(RF)                                  
         B     GETNAMX                                                          
*                                                                               
GETOWN5  EQU   *                                                                
         L     R1,FILEC                                                         
         LA    RF,ROWNREC-FILED(R1)                                             
         BAS   RE,LINKFILE                                                      
         MVC   WORK+8(20),ROWNNAME-FILED(R1)                                    
         B     GETNAMX                                                          
         SPACE 2                                                                
GETTVB   TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         L     R4,=A(TVBLST)                                                    
*                                                                               
GETTVB2  CLI   0(R4),X'FF'                                                      
         BE    BADNAME                                                          
         CLC   0(2,R4),0(R1)                                                    
         BE    *+12                                                             
         LA    R4,20(R4)                                                        
         B     GETTVB2                                                          
         MVC   WORK+8(18),2(R4)                                                 
         B     GETNAMX                                                          
*                                                                               
GETSVC   TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVC   WORK+8(3),=C'ARB'                                                
         CLI   0(R1),C'A'                                                       
         BE    GETNAMX                                                          
         MVC   WORK+8(3),=C'NSI'                                                
         CLI   0(R1),C'N'                                                       
         BE    GETNAMX                                                          
         MVC   WORK+8(3),=C'SRC'                                                
         CLI   0(R1),C'S'                                                       
         BE    GETNAMX                                                          
         MVC   WORK+8(3),=C'BIR'                                                
         CLI   0(R1),C'B'                                                       
         BE    GETNAMX                                                          
         MVC   WORK+8(3),=C'U ?'                                                
         MVC   WORK+9(1),0(R1)                                                  
         B     GETNAMX                                                          
*                                                                               
GETMKTRK MVC   WORK+8(1),0(R1)                                                  
         B     GETNAMX                                                          
*                                                                               
GETCTY   TM    RNDTATYP,1          CONTRACT TYPE                                
         BZ    GETNAMX                                                          
         MVI   ELCODE,X'32'                                                     
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
GETCTY2  EQU   *                                                                
         BAS   RE,NXTEL4                                                        
         BE    GETCTY5                                                          
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RCTYDESC-RCTYREC(RF)                                  
         B     GETNAMX                                                          
GETCTY5  EQU   *                                                                
         CLC   REC+RGCMPDSP(2),DCTYREP(R4)     MATCH REP ID                     
         BNE   GETCTY2                                                          
         CLC   0(2,R1),DCTYCTY(R4)       MATCH CONTRACT TYPE                    
         BNE   GETCTY2                                                          
         MVC   WORK+8(20),DCTYNAM(R4)                                           
         B     GETNAMX                                                          
*                                                                               
GETPTP   CLC   0(3,R1),XFE         POINT PERSON                                 
         BNE   GETPTP2                                                          
         MVC   WORK(3),=C'???'                                                  
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         B     BADNAME                                                          
*                                                                               
GETPTP2  MVI   ELCODE,X'31'                                                     
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
GETPTP4  EQU   *                                                                
         BAS   RE,NXTEL4                                                        
         BE    GETPTP5                                                          
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RPTPNAME-RPTPREC(RF)                                  
         B     GETNAMX                                                          
GETPTP5  EQU   *                                                                
         CLC   0(3,R1),2(R4)                                                    
         BNE   GETPTP4                                                          
         MVC   WORK+4(2),25(R4)    SUBSIDIARY REP                               
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVC   WORK+8(20),5(R4)                                                 
         B     GETNAMX                                                          
*                                                                               
GETNCON  CLC   0(8,R1),XFE         NETWORK CONTRACT NUMBER                      
         BNE   GETNCON2                                                         
         MVC   WORK(8),=C'UNKNOWN '                                             
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         B     BADNAME                                                          
*                                                                               
GETNCON2 TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVC   WORK+8(8),0(R1)                                                  
         B     GETNAMX                                                          
*                                                                               
GETBOOK  MVC   WORK+6(2),SPACES    BOOK                                         
         CLC   0(3,R1),XFE                                                      
         BNE   GETBOOK2                                                         
         MVC   WORK(6),=C'NOBOOK'                                               
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         B     BADNAME                                                          
*                                                                               
GETBOOK2 CLI   0(R1),C'1'          TEST BOOK FROM BOP ELEMENT                   
         BL    *+14                                                             
         MVC   WORK(6),1(R1)       YES                                          
         B     GETBOOK4                                                         
         CLC   0(2,R1),=C'DR'      NO-FROM SAR ELEMENT                          
         BE    GETBOOK4            DIRECT RESPONSE                              
         MVC   WORK(1),2(R1)                                                    
         MVC   WORK+1(2),0(R1)                                                  
         MVC   THREE(2),0(R1)                                                   
         MVI   THREE+2,1                                                        
         CLI   THREE+1,0           MONTH=0 IS ESTIMATED DEMO                    
         BNE   *+8                                                              
         MVI   THREE+1,1                                                        
         GOTO1 DATCON,DMCB,(3,THREE),(6,DUB)                                    
         CLI   WORK+2,0                                                         
         BNE   *+10                                                             
         MVC   DUB(3),=C'EST'                                                   
         MVC   WORK+1(3),DUB                                                    
         MVC   WORK+4(2),DUB+4                                                  
*                                                                               
GETBOOK4 TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVC   WORK+8(6),WORK                                                   
         B     GETNAMX                                                          
*                                                                               
GETDPT   CLC   0(3,R1),XFE         DAYPART                                      
         BNE   GETDPT2                                                          
         MVC   WORK(3),=C'???'                                                  
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         B     BADNAME                                                          
*                                                                               
GETDPT2  TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVC   WORK+8(3),0(R1)                                                  
         B     GETNAMX                                                          
*                                                                               
GETDEM   CLC   0(7,R1),XFE         DEMO                                         
         BNE   GETDEM2                                                          
         MVC   WORK(7),=C'NO DEMO'                                              
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         B     BADNAME                                                          
*                                                                               
GETDEM2  TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVC   WORK+8(7),0(R1)                                                  
         B     GETNAMX                                                          
*                                                                               
GETMKT   CLC   0(4,R1),XFE         MARKET                                       
         BNE   GETMKT2                                                          
         MVC   WORK(4),=C'????'                                                 
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         B     BADNAME                                                          
*                                                                               
GETMKT2  EQU   *                                                                
         TM    RNDTATYP,1                                                       
         BZ    GETNAMX                                                          
         MVI   ELCODE,X'2B'        MARKET                                       
         BAS   RE,FSTEL4                                                        
         B     *+8                                                              
GETMKT3  EQU   *                                                                
         BAS   RE,NXTEL4                                                        
         BE    GETMKT5                                                          
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RMKTNAME-RMKTREC(RF)                                  
         B     GETNAMX                                                          
GETMKT5  EQU   *                                                                
         CLC   0(4,R1),2(R4)                                                    
         BNE   GETMKT3                                                          
         MVC   WORK+8(20),6(R4)                                                 
         B     GETNAMX                                                          
*                                                                               
GETCMPY  EQU   *                                                                
         L     RF,VXADDR                                                        
         USING VXADDRD,RF                                                       
         L     RE,VXSREP           A(MASTER/SUBSIDIARY TABLE)                   
         USING RSREPD,RE                                                        
         CLI   MASTREP,1           MASTER REP?                                  
         BNE   GC0020              NO  - USE NAME FROM REP REC                  
*                                                                               
         LA    R2,SUBREPTB         FIRST CODE IN SUBREP TABLE                   
GC0001   EQU   *                                                                
         CLC   0(2,R2),=X'FFFF'    END OF TABLE?                                
         BE    GC0040              YES                                          
         CLC   0(2,R2),REC+RGCMPDSP      REP ID FROM RECORD AREA                
         BE    GC0008                                                           
         LA    R2,LSUBREP(R2)      BUMP TO NEXT TABLE ENTRY                     
         B     GC0001                                                           
GC0008   EQU   *                                                                
         MVC   WORK+8(20),2(R2)    MOVE NAME FROM TABLE                         
         B     GETNAMX             EXIT                                         
*                                                                               
         DROP  RE,RF                                                            
*                                                                               
GC0020   L     RE,FILEC                                                         
         USING RREPREC,RE                                                       
         MVC   WORK+8(20),RREPSHRT                                              
         DROP  RE                                                               
         B     GETNAMX                                                          
BADNAMX  DS    XL1                                                              
         DS    0F                                                               
GC0040   EQU   *                                                                
*                                                                               
*   GC0040 TEST                                                                 
*        MVI   BADNAMX,0           SET FLAG OFF                                 
*        MVC   P+1(18),=C'COMPANY NOT FOUND:'                                   
*        MVC   P+19(2),REC+RGCMPDSP      REP ID FROM RECORD AREA                
*        GOTO1 REPORT                                                           
*        MVI   BADNAMX,1           SET FLAG ON                                  
*   GC0040 TEST                                                                 
*                                                                               
                                                                                
         MVI   ELCODE,X'01'        SET TO COMPANY CODE                          
         LA    R1,REC+RGCMPDSP     REP ID FROM RECORD AREA                      
         BAS   RE,CHKBADNM                                                      
         BNZ   BADNAME             CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RREPNAME-RREPREC(RF)                                  
         B     GETNAMX                                                          
*                                                                               
GETDYPTS EQU   *                                                                
         TM    RNDTATYP,1          NAME REQUESTED?                              
         BZ    GETNAMX             NO  - SKIP ROUTINE                           
         CLC   0(3,R1),XFE         ANY DAYPARTS IN FIELD?                       
         BE    GDYP0020                                                         
*                                                                               
         OC    0(8,R1),0(R1)       ANY DAYPARTS?                                
         BNZ   GDYP0040            YES                                          
GDYP0020 EQU   *                                                                
         MVC   WORK+8(13),=C'*NO DAYPARTS*'                                     
         B     GETNAMX                                                          
GDYP0040 EQU   *                                                                
         LA    R2,WORK+8           SET A(RECEIVING FIELD)                       
         XC    WORK+8(56),WORK+8   CLEAR RECEIVING FIELD                        
         LR    RE,R1               SET A(SENDING FIELD)                         
         LA    R0,8                SET LOOP CONTROL                             
GDYP0060 EQU   *                                                                
         CLI   0(RF),X'FE'         DUMMY DAYPART ENTRY?                         
         BE    GDYP0140            YES - SKIP IT                                
         LA    RF,DYPTTABL         SET A(DAYPART TABLE)                         
GDYP0080 EQU   *                                                                
         CLI   0(RF),0             END OF TABLE?                                
         BE    GDYP0100            YES - FORCE ??? INTO DAYPART                 
         CLC   0(1,RF),0(RE)       DAYPART IN TABLE?                            
         BE    GDYP0100            YES                                          
         LA    RF,4(RF)            NO  - BUMP TO NEXT ENTRY                     
         B     GDYP0080            GO BACK FOR NEXT ITEM                        
GDYP0100 EQU   *                                                                
         CR    RE,R1               FIRST ENTRY?                                 
         BE    GDYP0120            YES                                          
         MVI   0(R2),C','          NO  - INSERT SEPARATOR                       
         LA    R2,1(R2)            INCREMENT RECVG FIELD                        
GDYP0120 EQU   *                                                                
         MVC   0(3,R2),1(RF)       MOVE IN DAYPART NAME                         
         LA    R2,3(R2)            BUMP A(RECVG FIELD)                          
GDYP0140 EQU   *                                                                
         LA    RE,1(RE)            BUMP A(SENDING FIELD)                        
         CLI   0(RE),0             ANY ENTRY?                                   
         BE    GETNAMX             NO  - FINISHED                               
         BCT   R0,GDYP0060         CHECK NEXT DAYPART                           
         B     GETNAMX                                                          
*                                                                               
GETFLITE EQU   *                                                                
         OC    0(3,R1),0(R1)       ANY START DATE?                              
         BZ    GFLT0004            NO  - SKIP IT                                
         ST    R1,FULL             SAVE R1 PAST MACRO                           
         MVC   DUB(3),0(R1)        LOAD START DATE FOR CONVERT                  
         GOTO1 DATCON,DMCB,(3,DUB),(5,WORK+8)                                   
         L     R1,FULL             RESET R1 AFTER MACRO                         
GFLT0004 EQU   *                                                                
         OC    3(3,R1),3(R1)       AND END  DATE?                               
         BZ    GFLT0008            NO  - SKIP IT                                
         MVC   DUB(3),3(R1)        LOAD START DATE FOR CONVERT                  
         GOTO1 DATCON,DMCB,(3,DUB),(5,WORK+17)                                  
GFLT0008 EQU   *                                                                
         B     GETNAMX                                                          
*                                                                               
GETBUYER EQU   *                                                                
         L     RF,ABUYNAMS         USE A(BUYNAMS TABLE) AS BUFFER               
*                                                                               
*                                  KEY SAVED IN 1ST PART OF BUFFER              
         CLC   28(4,RF),REC+RGDSKDSP                                            
*                                  IS RECORD ALREADY IN CORE?                   
         BE    GBUY0010            YES                                          
         XC    KEY,KEY             NO                                           
         MVC   KEY+28(4),REC+RGDSKDSP                                           
*                                  LOAD DISK ADDR RETRIEVE RECORD               
         GOTO1 AGETCONT                                                         
GBUY0010 EQU   *                                                                
         L     RF,ABUYNAMS         USE A(BUYNAMS TABLE) AS BUFFER               
         MVC   0(34,RF),KEY        SAVE KEY IN FIRST PART OF BUFFER             
         LA    RF,50(RF)           RECORD IS 50 BYTES IN                        
         USING RCONREC,RF                                                       
         MVC   WORK+8(20),RCONBUYR                                              
*                                  LOAD BUYER NAME                              
         DROP  RF                                                               
*                                                                               
         B     GETNAMX                                                          
*                                                                               
*                                                                               
*   FOLLOWING CODE IS DEACTIVATED.  IT RETRIEVES BUYER NAME FROM A              
*   TABLE (MAX ENTRIES: 10K) BUILT BY RERG02.  THE ROW FIELD CONTAINS           
*   THE NUMBER OF THE SLOT IN WHICH THE BUYER NAME IS HELD.  BECAUSE            
*   COMMENTS COULD NOT BE TABLED, AND A CONTRACT READ IS REQUIRED,              
*   BUYER IS ALSO RETURNED THAT WAY.                                            
*                                                                               
*         L     RF,ABUYNAMS         A(BUYER NAME TABLE)                         
*         L     RE,0(R1)            BUYER NAME COUNTER                          
*         CH    RE,=H'10000'        10000 IS MAX IN TABLE                       
*         BH    GBUY0004            BEYOND TABLE                                
*         BCTR  RE,0                MAKE ZERO RELATIVE                          
*         MH    RE,=H'20'           MULTIPLY BY 20                              
*         AR    RF,RE               ADD DISPLACEMENT                            
*         MVC   WORK+8(20),0(RF)    MOVE NAME OUT                               
*         B     GETNAMX                                                         
*GBUY0004 EQU   *                                                               
*         MVC   WORK+8(20),=C'NAME NOT AVAILABLE  '                             
*         B     GETNAMX                                                         
         EJECT                                                                  
*                                                                               
*   CHKBADNM:  IF CROSS-FILE REPORTING, CHECK OTHER PARTICIPATING               
*        FILES FOR EXPANSIONS PRIOR TO REPORTING **UNKNOWN**                    
*        RECORD TYPE WILL BE IN ELCODE                                          
*        RETURN CC = ZERO IF FOUND                                              
*        RETURN CC NZ     IF NOT FOUND                                          
*                                                                               
CHKBADNM NTR1                                                                   
         L     R3,THISQWK                                                       
         USING QWKD,R3                                                          
         LA    R3,QWREQ3                                                        
         DROP  R3                                                               
         USING QREC3,R3                                                         
         OC    Q3XFILNM,Q3XFILNM   CROSS-FILE REPORT?                           
         BZ    CBAD0090            NO                                           
         CLC   Q3XFILNM,SPACES     CROSS-FILE REPORT?                           
         BE    CBAD0090            NO                                           
*                                                                               
***>>>   NEED TO FIND THE CROSS-FILE CODE                                       
*                                                                               
         LR    R2,R1               SET A(CODE BEING TESTED)                     
         GOTO1 =A(XFILCHK),DMCB,(RC),(R2),(ELCODE,Q3XFILNM)                     
*                                                                               
         DROP  R3                                                               
*                                                                               
         BNZ   CBAD0090            NOT FOUND                                    
         SR    R0,R0                                                            
         B     CBAD0100            FOUND - EXIT CC = ZERO                       
CBAD0090 EQU   *                                                                
         LR    R0,RB               SET CC N= ZERO                               
CBAD0100 EQU   *                                                                
         L     R3,ADCONLST                                                      
         USING ADCONSD,R3                                                       
         L     R5,MASTC                                                         
         USING MASTD,R5            USING STILL IN EFFECT                        
         L     RE,MCUTL            SET A(UTL)                                   
*                                                                               
         DROP R3,R5                                                             
*                                                                               
         MVC   4(1,RE),SAVSENUM    RESET ORIGINAL SE NUMBER                     
*                                                                               
         LTR   R0,R0               SET FINAL CONDITION CODE                     
         XIT1                                                                   
*   TEST END                                                                    
*                                                                               
                                                                                
BADNAME  EQU   *                                                                
         MVC   WORK+8(13),=C'** UNKNOWN **'                                     
         TM    REC+RMISCDSP,X'80'  C*MP BUDGET RECORD?                          
         BNO   BADN0020            NO                                           
         MVC   WORK+8(13),=C'BUDGET       '                                     
BADN0020 EQU   *                                                                
         B     GETNAMX                                                          
*                                                                               
GETNMEOF LTR   RB,RB               END-OF-FILE EXIT                             
         B     XIT                                                              
*                                                                               
GETNAMX  EQU   *                                                                
         CLI   OTHRNAME,C'Y'       SHOW 'OTHER' NAME?                           
         BNE   GNMX0010            NO                                           
         MVC   WORK(28),SPACES     YES - CLEAR CODE/NAME FIELD                  
         MVC   WORK+8(10),=C'**OTHERS**'                                        
GNMX0010 EQU   *                                                                
         CR    RB,RB                                                            
         B     XIT                                                              
         EJECT                                                                  
NXTEL4   SR    R0,R0                                                            
         ICM   R0,1,1(R4)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R4,R0                                                            
FSTEL4   CLI   0(R4),0                                                          
         BE    NXTEL4X                                                          
         CLC   0(1,R4),ELCODE                                                   
         BNE   NXTEL4                                                           
         BR    RE                                                               
*                                                                               
NXTEL4X  LTR   RE,RE                                                            
         BR    RE                                                               
         EJECT                                                                  
** TABLE OF SPECIAL ROUTINE ADDRESSES FOR PRINTING ROW CODES/NAMES **           
         SPACE 1                                                                
GETTAB   DC    A(0)                01 - REP                                     
         DC    A(GETSTA)           02 - STA                                     
         DC    A(GETRGN)           03 - RGN                                     
         DC    A(GETOFC)           04 - OFC (ALPHA)                             
         DC    A(GETTM)            05 - TEAM                                    
         DC    A(GETSP)            06 - SALESPERSON                             
         DC    A(GETGRP)           07 - GROUP                                   
         DC    A(GETADV)           08 - ADVERTISER                              
         DC    A(GETPRD)           09 - PRD                                     
         DC    A(GETAGY)           10 - AGY                                     
         DC    A(GETAFL)           11 - AFFILIATE                               
         DC    A(GETCON)           12 - CONTRACT                                
         DC    A(GETCLS)           13 - CLASS                                   
         DC    A(GETOFC)           14 - OFFICE (NON-ALPHA)                      
         DC    A(GETCTG)           15 - CATEGORY                                
         DC    A(GETRANK)          16 - RANK                                    
         DC    4A(0)               17-20 ARE PERIOD SPECS                       
         DC    A(0)                21 - FREE                                    
         DC    A(GETSTNTY)         22 - STNTYPE                                 
         DC    A(GETTVB)           23 - TVB REGION                              
         DC    A(GETOWNER)         24 - OWNER                                   
         DC    A(GETGRP)           25 - GROUP ONLY                              
         DC    A(GETGRP)           26 - SUBGROUP ONLY                           
         DC    A(GETNAMX)          27 - ADVNAME                                 
         DC    A(GETNAMX)          28 - AGYNAME                                 
         DC    A(GETSVC)           29 - SERVICE                                 
         DC    A(GETMKTRK)         30 - MKTRANK                                 
         DC    A(0)                31 - FREE                                    
         DC    A(GETSTA)           32 - STAMKT                                  
         DC    A(GETCTY)           33 - CONTYPE                                 
         DC    A(GETPTP)           34 - PTPERSON                                
         DC    A(GETNCON)          35 - NETCON                                  
         DC    A(GETBOOK)          36 - BOOK                                    
         DC    A(GETDPT)           37 - DAYPART                                 
         DC    A(GETDEM)           38 - DEMO                                    
         DC    A(GETMKT)           39 - MARKET                                  
         DC    A(GETCMPY)          40 - COMPANY                                 
         DC    A(GETDYPTS)         41 - DAYPARTS (MULTIPLE)                     
         DC    A(GETFLITE)         42 - FLIGHT DATES                            
         DC    A(GETBUYER)         43 - BUYER                                   
         DC    A(GETDEVSP)         44 - DEVELOPMENTAL SALESPERSON               
         DC    A(GETDEVCT)         45 - DEVELOPMENTAL CONTRACT TYPE             
         DC    A(0)                46 - FREE                                    
         DC    A(GETAGY)           47 - AGY - NO OFFICE                         
         DC    A(GETBCOD)          48 - BUYLINE CODE                            
         DC    A(GETATT1)          49 - BUYLINE CODE ATTRIBUTE 1                
         DC    A(GETATT2)          50 - BUYLINE CODE ATTRIBUTE 2                
         DC    A(GETSP)            51 - COMPENSATION S/P                        
*                                       RETRIEVE S/P DATA                       
         DC    A(GETCONED)         52 - CONTRACT END DATE                       
         DC    A(GETJOIND)         53 - STATION JOIN DATE                       
GETTABX  EQU   *                                                                
         SPACE 2                                                                
XFE      DC    XL8'FEFEFEFEFEFEFEFE'                                            
         EJECT                                                                  
*                                                                               
*   DAYPART CODE TRANSLATION TABLE                                              
*                                                                               
DYPTTABL DC    C'MMNG'                                                          
         DC    C'DDAY'                                                          
         DC    C'EELY'                                                          
         DC    C'RENW'                                                          
         DC    C'AACC'                                                          
         DC    C'TLNW'                                                          
         DC    C'LLTE'                                                          
         DC    C'WWKD'                                                          
         DC    C'KKID'                                                          
         DC    C'FFRG'                                                          
         DC    C'NNWS'                                                          
         DC    C'PPRI'                                                          
         DC    C'VMOV'                                                          
         DC    C'SSPE'                                                          
         DC    C'JSPO'                                                          
         DC    C'OSPS'                                                          
         DC    C'XCOM'                                                          
         DC    C'YLOC'                                                          
         DC    C'ZOTH'                                                          
         DC    X'00',C'???'        DELIMITER                                    
         EJECT                                                                  
*                                                                               
*        I/O ROUTNES                                                            
*                                                                               
         SPACE                                                                  
HIGH     NTR1                                                                   
         LA    RF,DMRDHI                                                        
         MVC   KEYSAVE,KEY                                                      
         B     LINKDIR                                                          
*                                                                               
SEQ      NTR1                                                                   
         LA    RF,DMRSEQ                                                        
         MVC   KEYSAVE,KEY                                                      
         B     LINKDIR                                                          
*                                                                               
LINKDIR  EQU   *                                                                
         ST    RF,DMCB                                                          
         MVC   DMCB(1),DMINBTS                                                  
         GOTO1 DATAMGR,DMCB,,REPDIR,KEY,KEY,0                                   
         B     DMCHECK                                                          
*                                                                               
GETCONT  EQU   *                   RETRIEVE CONTRACT RECORD                     
         L     RF,ABUYNAMS         USE A(BUYNAMS TABLE) AS BUFFER               
         LA    RF,50(RF)           SET RECORD 50 BYTES IN                       
         B     LINKFILE                                                         
*                                                                               
LINKFILE NTR1                                                                   
         LR    R2,RF                                                            
         GOTO1 DATAMGR,DMCB,(DMINBTS,GETREC),REPFILE,KEY+28,           X        
               (R2),(0,DMWORK)                                                  
         MVC   LASTIO,DMCB+12      SAVE THESE VALUES                            
         MVC   LASTDA,KEY+28                                                    
         MVC   LASTLEN,27(R2)                                                   
         B     DMCHECK                                                          
*                                                                               
DMCHECK  TM    DMCB+8,X'10'        TEST FOR RECORD NOT FOUND                    
         BZ    DM010                                                            
         TM    29(R2),X'80'        IS RECORD MARKED FOR DELETION                
         BZ    DM020               NO - ERROR                                   
         LTR   RB,RB               YES - RETURN WITH CC NE 0                    
         B     XIT                                                              
*                                                                               
DM010    TM    DMCB+8,X'EF'        TEST FOR OTHER ERRORS                        
         BZ    XIT                                                              
*                                                                               
DM020    MVC   WORK(27),=C'*** DATA MANAGER ERROR  ***'                         
         GOTO1 LOGIO,WORK+32,1,(27,WORK)                                        
         MVC   WORK(27),=C'*** REQUEST NUMBER NNNN ***'                         
         L     R5,MCADDR                                                        
         UNPK  WORK+19(4),MCREQNO-MASTD(3,R5)                                   
         OI    WORK+22,X'F0'                                                    
         BASR  RE,RF                                                            
         DC    H'0'            BLOW UP                                          
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* XFILCHK:  LOOK IN OTHER FILES FOR RECORD MISSING EXPANSION IN                 
*        TABLE.  RETURN CC = ZERO FOR FIND, N= ZERO FOR MISS.                   
*                                                                               
XFILCHK  NMOD1 0,**XFIL**                                                       
         L     RC,0(R1)            SET A(WORKSPACE)                             
         MVC   ELRECTYP,8(R1)      SAVE RECORD TYPE                             
         ZICM  R2,9(R1),3          SET A(XFIL OPTION NAME IN REQ3)              
         L     R1,4(R1)            SET A(CODE BEING TESTED)                     
*                                     RESET R1 LAST!!                           
         CLI   ELRECTYP,2          STATION CODE BEING TESTED?                   
         BNE   XFIL0020            NO                                           
         MVC   SAVSTATN,0(R1)      YES - SAVE STATION CALL LETTERS              
         LA    R1,SAVSTATN         REPOINT A(CODE BEING TESTED)                 
*                                     FOR STATION                               
         CLI   SAVSTATN+4,C'T'     TV STATION?                                  
         BNE   XFIL0020            NO                                           
         MVI   SAVSTATN+4,C' '     YES - CLEAR IT OUT                           
XFIL0020 EQU   *                                                                
         LA    RF,XFILTAB          FIND CODE IN XFILTAB                         
XFIL0040 EQU   *                                                                
         CLI   0(RF),X'00'         END OF TABLE?                                
         BNE   *+6                 NO                                           
         DC    H'0'                YES - MUST BE IN TABLE                       
         CLC   0(1,RF),ELRECTYP    TABLE VS RECORD TYPE                         
         BE    XFIL0060            FOUND                                        
         LA    RF,LXFILTAB(RF)     BUMP TO NEXT ENTRY                           
         B     XFIL0040            GO BACK FOR NEXT                             
XFIL0060 EQU   *                                                                
         ST    RF,SAVAXFIL         SAVE A(XFIL LIST ENTRY)                      
         LA    R7,XFILCODE         SET A(TABLE OF XFIL SETS)                    
XFIL0080 EQU   *                                                                
         CLI   0(R7),0             END OF TABLE?                                
         BNE   *+6                                                              
         DC    H'0'                YES - MUST BE IN TABLE                       
         CLC   0(4,R7),0(R2)       XFIL SET NAME IN TABLE?                      
         BE    XFIL0100            YES                                          
         LA    R7,LXFILSET(R7)     NO  - BUMP TO NEXT SET                       
         B     XFIL0080            GO BACK FOR NEXT                             
XFIL0100 EQU   *                                                                
         LA    R7,LXFILCDE(R7)     SKIP ID, SET A(REPLIST ENTRY)                
         XC    KEY,KEY                                                          
         MVC   KEY(1),XFILTYP(RF)  INSERT RECORD TYPE INTO KEY                  
XFIL0120 EQU   *                                                                
         XC    SVMSTREP(LSUBREP),SVMSTREP                                       
*                                  CLEAR POSSIBLE SUBREP SET                    
         CLI   RLMODECD(R7),X'FC'  END OF LIST?                                 
         BE    XFIL0800            YES - CODE NOT FOUND                         
XFIL0130 EQU   *                                                                
         MVC   SVSUBKEY,KEY        SAVE KEY FOR SUBROUTINE                      
         BAS   RE,TSTSUBRP         TEST FOR MASTER/SUBREP                       
         BZ    XFIL0140            CONTINUE PROCESSING TABLE                    
         MVC   KEY,SVSUBKEY        SET KEY FROM SUBROUTINE                      
         B     XFIL0180            SUBREP TABLE DONE -                          
*                                     CYCLE TO NEXT COMPANY ENTRY               
XFIL0140 EQU   *                                                                
         MVC   KEY,SVSUBKEY        SET KEY FROM SUBROUTINE                      
         L     RF,SAVAXFIL         RELOAD A(XFIL LIST ENTRY)                    
*                                     (TOP OF LOOP)                             
         ZIC   RE,XFILREP(RF)      GET DISPLACEMENT TO REP                      
         LA    R6,KEY                                                           
         AR    R6,RE               DISPLACE TO REP CODE IN KEY                  
         MVC   0(2,R6),RLPOWRCD(R7)                                             
*                                  SET REP CODE FROM TABLE                      
         OC    ASUBREP,ASUBREP     REPLACE FROM A(SUB REP TABLE)?               
         BZ    XFIL0160            NO                                           
         L     R3,ASUBREP          YES                                          
         MVC   0(2,R6),0(R3)       INSERT CODE FROM TABLE                       
*                                  INSERT POWER CODE INTO KEY                   
XFIL0160 EQU   *                                                                
         ZIC   RE,XFILCOD(RF)      GET DISPLACEMENT TO CODE                     
         LA    R6,KEY                                                           
         AR    R6,RE               DISPLACE TO RECORD CODE IN KEY               
         ZIC   RE,XFILLEN(RF)      SET CODE LENGTH                              
         BCTR  RE,0                BACK UP 1 FOR EX                             
         EX    RE,XFIL0700         MOVE CODE BY LENGTH                          
*                                                                               
*   SHIFT TO PROPER FILE FOR READ                                               
*                                                                               
         L     R3,ADCONLST                                                      
         USING ADCONSD,R3                                                       
         L     R5,MASTC                                                         
         USING MASTD,R5            USING STILL IN EFFECT                        
         L     RE,MCUTL            SET A(UTL)                                   
*                                                                               
         DROP R3,R5                                                             
*                                                                               
         MVC   4(1,RE),RLSENUM(R7) OVERRIDE CONTROL FILE UTL                    
*                                                                               
XFIL0170 EQU   *                                                                
         GOTO1 HIGHY                                                            
         CLC   KEY(27),KEYSAVE                                                  
         BE    XFIL0200            KEY FOUND                                    
         MVC   KEY(27),KEYSAVE     RESTORE KEY                                  
         OC    ASUBREP,ASUBREP     SUBREP TABLE IN USE?                         
         BNZ   XFIL0130            YES - CYCLE SUBREPS                          
XFIL0180 EQU   *                                                                
         LA    R7,LREPSLST(R7)                                                  
         B     XFIL0120            GO BACK FOR NEXT REP                         
XFIL0200 EQU   *                                                                
         L     R1,FILEC                                                         
         LA    R2,RCONREC-FILED(R1)                                             
*                                  READ INTO CONTRACT RECORD                    
         BAS   RE,LINKFILY         RETRIEVE THE RECORD                          
         B     XFIL0820            EXIT CC = ZERO                               
XFIL0700 MVC   0(0,R6),0(R1)       MOVE CODE BY LENGTH                          
XFIL0800 EQU   *                                                                
         LR    R0,RB               SET CC N= ZERO                               
         B     XFIL0900                                                         
XFIL0820 EQU   *                                                                
         SR    R0,R0                                                            
XFIL0900 EQU   *                                                                
         LTR   R0,R0               SET CONDITION CODE RETURN                    
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
*                                                                               
ELRECTYP DS    CL1                                                              
SAVSTATN DS    CL5                                                              
SVSUBKEY DS    CL27                                                             
SAVAXFIL DS    F                   SAVE ADDR(XFIL LIST ENTRY)                   
SVMSTREP DS    CL2                 MASTER REP CODE TO SAVE                      
SVSUBREP DS    CL40                SUBREP LIST                                  
ASUBREP  DS    F                   A(REP CODE TO USE)                           
LSUBSET  EQU   *-SVMSTREP                                                       
*                                                                               
*   XFILTAB:  TABLE OF RECORD TYPES WHICH MAY BE MISSING EXPANSIONS             
*        BYTE   1        =   RECORD TYPE                                        
*        BYTE   2        =   DISP(REP CODE IN KEY)                              
*        BYTE   3        =   DISP(CODE IN KEY)                                  
*                                     AGENCY/ADV ARE PRE-REP CODE               
*        BYTE   4        =   L(CODE BEING TESTED)                               
*        BYTE   5        =   CODE FILL CHARACTER                                
*                                     SPACE OR BINARY ZERO                      
*                                                                               
XFILTYP  EQU   0                   DISP(RECORD TYPE)                            
XFILREP  EQU   1                   DISP(REP CODE)                               
XFILCOD  EQU   2                   DISP(RECORD CODE)                            
XFILLEN  EQU   3                   CODE TEST LENGTH                             
XFILFIL  EQU   4                   FILL CHARACTER                               
*                                                                               
XFILTAB  EQU   *                                                                
         DC    AL1(01),AL1(25),AL1(25),AL1(2),X'00'    REP(CO) CODE             
LXFILTAB EQU   *-XFILTAB           L(ENTRY)                                     
         DC    XL1'02',AL1(20),AL1(22),AL1(5),X'00'    STATION                  
         DC    XL1'03',AL1(23),AL1(25),AL1(2),X'00'    REGION                   
         DC    XL1'04',AL1(23),AL1(25),AL1(2),X'00'    OFFICE                   
         DC    XL1'05',AL1(23),AL1(25),AL1(2),X'00'    TEAM                     
         DC    XL1'06',AL1(22),AL1(24),AL1(3),X'00'    S/P                      
         DC    XL1'07',AL1(23),AL1(25),AL1(2),X'40'    GROUP/SUBGROUP           
         DC    XL1'08',AL1(25),AL1(21),AL1(4),X'40'    ADVERTISER               
         DC    XL1'0A',AL1(25),AL1(19),AL1(6),X'40'    AGENCY                   
         DC    XL1'0F',AL1(23),AL1(25),AL1(2),X'00'    CATEGORY                 
         DC    XL1'2A',AL1(22),AL1(24),AL1(3),X'00'    OWNER                    
         DC    XL1'2B',AL1(21),AL1(23),AL1(4),X'00'    MARKET                   
         DC    XL1'31',AL1(22),AL1(24),AL1(3),X'40'    POINT PERSON             
         DC    XL1'32',AL1(24),AL1(26),AL1(1),X'40'    CONTRACT TYPE            
         DC    X'0000'                                                          
         DS    H'0'                REALIGNMENT                                  
*                                                                               
*   IF NOT MASTER, CLEAR A(POWER CODE TO USE), SET CC = ZERO.                   
*   IF MASTER, AND LIST OF SUBS NOT RETRIEVED, DO SO,                           
*        THEN SET A(SUBREP TO USE)                                              
*   IF MASTER, AND LIST RETRIEVED, SET NEXT SUB TO USE.                         
*        PASS BACK CC NZ AT END OF LIST, TO CYCLE THROUGH                       
*                                                                               
TSTSUBRP NTR1                                                                   
         LA    RF,RLMSTFLG(R7)     SET A(POWER CODE NON-MASTER)                 
         CLI   RLMSTFLG(R7),C'*'   MASTER ENTRY?                                
         BE    TSRP0020            YES - CHECK SUBREP SETUP                     
         XC    ASUBREP,ASUBREP     CLEAR A(SUBREP ENTRY)                        
         B     TSRP0200            NO  - EXIT CC ZERO                           
TSRP0020 EQU   *                                                                
         OC    SVSUBREP,SVSUBREP   YES - SUBREPS LOADED?                        
         BNZ   TSRP0180            YES - BUMP TO NEXT SUBREP                    
*                                                                               
*   SHIFT TO PROPER FILE FOR READ                                               
*                                                                               
         L     R3,ADCONLST                                                      
         USING ADCONSD,R3                                                       
         L     R5,MASTC                                                         
         USING MASTD,R5                                                         
         L     RE,MCUTL            SET A(UTL)                                   
*                                                                               
         DROP R3,R5                                                             
*                                                                               
         MVC   4(1,RE),RLSENUM(R7) OVERRIDE CONTROL FILE UTL                    
*                                                                               
         XC    KEY,KEY             CLEAR THE KEY                                
         MVI   KEY,1               SET TO REP RECORD                            
         MVC   KEY+25(2),RLPOWRCD(R7)                                           
*                                  INSERT COMPANY MASTER POWER CODE             
*                                     TO GET REP RECORD                         
         GOTO1 HIGHY                                                            
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+6                 KEY FOUND?                                   
         DC    H'0'                MUST BE THERE                                
         L     R1,FILEC                                                         
         LA    R2,RREPREC-FILED(R1)                                             
*                                  READ INTO REP RECORD                         
         BAS   RE,LINKFILY         RETRIEVE THE RECORD                          
         LA    R1,RREPELEM-FILED(R1)                                            
*                                  SET A(DESC ELT OF REP RECORD)                
*                                                                               
TSRP0040 EQU   *                                                                
         CLI   0(R1),0             END OF RECORD?                               
         BNE   *+6                 NO                                           
         DC    H'0'                YES - ELEMENT MUST BE PRESENT                
         CLI   0(R1),2             SUBREP ELEMENT?                              
         BE    TSRP0060            YES                                          
         ZIC   RE,1(R1)            NO  - BUMP TO NEXT ELEMENT                   
         AR    R1,RE                                                            
         B     TSRP0040            GO BACK FOR NEXT                             
TSRP0060 EQU   *                                                                
         USING RREPSUB,R1                                                       
         ZIC   RF,RREPSCNT         LOAD NUMBER OF SUBS                          
         SLL   RF,1                DOUBLE FOR # CHARS                           
         BCTR  RF,0                BACK OFF 1 FOR EX                            
         EX    RF,TSRP006A         MOVE BY LENGTH                               
         LA    RF,SVSUBREP         SET A(1ST ENTRY)                             
         ST    RF,ASUBREP                                                       
         B     TSRP0200            EXIT CC = ZERO                               
*                                                                               
TSRP006A MVC   SVSUBREP(0),RREPSCOD                                             
*                                                                               
         DROP  R1                                                               
*                                                                               
TSRP0180 EQU   *                                                                
         L     R3,ASUBREP          SET A(REP IN USE)                            
         LA    R3,2(R3)            BUMP TO NEXT ENTRY                           
         ST    R3,ASUBREP          SET NEW A(REP IN USE)                        
         OC    0(2,R3),0(R3)       ANY ENTRY?                                   
         BZ    TSRP0220            NO  - SET CC NZ FOR EXIT                     
TSRP0200 EQU   *                                                                
         SR    R0,R0               SET CC = ZERO                                
         B     TSRP0240                                                         
TSRP0220 EQU   *                                                                
         LTR   RB,RB               SET CC NOT ZERO                              
TSRP0240 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
       ++INCLUDE REGENCROSS                                                     
         DS    H'0'                REALIGNMENT                                  
**==>>                                                                          
HIGHY    NTR1                                                                   
         LA    RF,DMRDHI                                                        
         MVC   KEYSAVE,KEY                                                      
         B     LINKDIRY                                                         
*                                                                               
SEQY     NTR1                                                                   
         LA    RF,DMRSEQ                                                        
         MVC   KEYSAVE,KEY                                                      
         B     LINKDIRY                                                         
*                                                                               
LINKDIRY EQU   *                                                                
         ST    RF,DMCB                                                          
         MVC   DMCB(1),DMINBTS                                                  
         GOTO1 DATAMGR,DMCB,,REPDIR,KEY,KEY,0                                   
         B     DMCHECKY                                                         
*                                                                               
LINKFILY NTR1                                                                   
         GOTO1 DATAMGR,DMCB,(DMINBTS,GETREC),REPFILE,KEY+28,           X        
               (R2),(0,DMWORK)                                                  
         MVC   LASTIO,DMCB+12      SAVE THESE VALUES                            
         MVC   LASTDA,KEY+28                                                    
         MVC   LASTLEN,27(R2)                                                   
*                                                                               
DMCHECKY TM    DMCB+8,X'10'        TEST FOR RECORD NOT FOUND                    
         BZ    DMY010                                                           
         TM    29(R2),X'80'        IS RECORD MARKED FOR DELETION                
         BZ    DMY020              NO - ERROR                                   
         LTR   RB,RB               YES - RETURN WITH CC NE 0                    
         B     DMYXIT                                                           
*                                                                               
DMY010   TM    DMCB+8,X'EF'        TEST FOR OTHER ERRORS                        
         BZ    DMYXIT                                                           
*                                                                               
DMY020   MVC   WORK(27),=C'*** DATA MANAGER ERROR  ***'                         
         GOTO1 LOGIO,WORK+32,1,(27,WORK)                                        
         MVC   WORK(27),=C'*** REQUEST NUMBER NNNN ***'                         
         L     R5,MCADDR                                                        
         UNPK  WORK+19(4),MCREQNO-MASTD(3,R5)                                   
         OI    WORK+22,X'F0'                                                    
         BASR  RE,RF                                                            
         DC    H'0'            BLOW UP                                          
DMYXIT   XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
**==>>                                                                          
*                                                                               
* GGENNMOD - GET*** CODE RELOCATED TO ALLOW ADDRESSABILITY                      
*        DMCB+4  =  ORIGINAL VALUE OF R1                                        
*        DMCB+8  =  ROUTINE TO CALL:                                            
*                   1  =  GETSTA                                                
*                   2  =  GETAGY                                                
*                   3  =  OFFICE                                                
*                                                                               
GGENNMOD NMOD1 0,**GGEN**                                                       
         CLI   8(R1),1             STATION ROUTINE?                             
         BNE   GAGYNMOD            NO  - TRY AGENCY                             
*                                                                               
*   STATION CODE RELOCATION                                                     
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R1,4(R1)            RESET VALUE OF R1                            
         MVI   RPLSTSTA,C'N'       SET LAST STATION TO 'NO'                     
         MVC   DUB+6(2),0(R1)      SAVE MARKET STATION NUMBER                   
         MVC   DUB(5),2(R1)                                                     
         MVC   WORK,SPACES                                                      
*                                                                               
         CLC   2(6,R1),XFFE        COMBO TOTAL RECORD?                          
         BNE   GSTA0020            NO                                           
         MVC   WORK+8(16),=C' **COMBO TOTAL**'                                  
         XC    SVMKTSTA,SVMKTSTA                                                
         B     GNAMXIT                                                          
*                                                                               
GSTA0020 EQU   *                                                                
         CLC   DUB(5),XFF                                                       
         BNE   GSTA0040                                                         
         MVC   WORK+8(16),=C'**MARKET TOTAL**'                                  
         XC    SVMKT,SVMKT                                                      
         B     GNAMXIT                                                          
*                                                                               
GSTA0040 EQU   *                                                                
         CLC   =C'C*MP',2(R1)      C*MP (CO. BUDGET RECORD?)                    
         BNE   GSTA0050            NO                                           
         MVC   WORK(6),=C'BUDGET'  YES - INSERT STATION=BUDGET                  
         B     GNAMXIT                                                          
GSTA0050 EQU   *                                                                
         MVC   WORK(4),2(R1)                                                    
         MVC   WORK+4(3),=C'- M'   RADIO                                        
         MVC   WORK+5(1),6(R1)                                                  
         CLI   6(R1),C'T'          TEST TV                                      
         BNE   *+12                                                             
         MVI   DUB+4,C' '                                                       
         MVI   WORK+6,C'V'                                                      
*                                                                               
         CLI   6(R1),C'V'          TEST 3 CALL LETTERS TV                       
         BNE   *+16                                                             
         MVC   DUB+3(2),SPACES                                                  
         MVC   WORK+3(4),=C'-TV '                                               
*                                                                               
         CLI   6(R1),C'M'          TEST 3 CALL LETTER RADIO                     
         BNE   GSTA0060                                                         
         MVI   DUB+3,C' '                                                       
         MVC   DUB+4(1),5(R1)                                                   
         MVC   WORK+3(4),=C'- M '                                               
         MVC   WORK+4(1),5(R1)                                                  
*                                                                               
GSTA0060 EQU   *                                                                
         CLI   RPSPLACT,C'Y'       NEED AFFILIATION FOR STATION?                
         BNE   GSTA0080            NO  -                                        
         CLC   RPSPLSTA,CBLEVEL    YES - SPL STATION ROW?                       
         BNE   GSTA0080            NO  -                                        
*                                                                               
*   NOTE:  FOR 'SPL' REPORTS (STACKED FORMAT), IT IS NECESSARY TO               
*     CHECK THE SPL STATION ROW FIELD.  IF THE SECOND BYTE OF THE               
*     FIELD CONTAINS A '2', THIS IS AN INDICATOR OF THE LAST STATION            
*     FOR THIS ORDER, AND PERMITS THE COMMENT TO BE INSERTED AFTER              
*     IT HAS BEEN PRINTED.                                                      
*                                                                               
         CLI   1(R1),2             YES - LAST STATION BEING DONE?               
         BNE   GSTA0300            NO  -                                        
         MVI   RPLSTSTA,C'Y'       YES - SET 'COMMENTS' INDICATOR               
         B     GSTA0300            YES - GET AFFIL FROM SPACEND                 
GSTA0080 EQU   *                                                                
         TM    RNDTATYP,1          NO - PRINT NAME?                             
         BZ    GNAMXIT             NO - DON'T BOTHER WITH SPACEND               
*                                                                               
GSTA0100 MVI   ELCODE,2            FIND STATION ELEM IN SPACEND                 
         BAS   RE,FSTEL5                                                        
         BNE   GSTA0320            STATION NOT FOUND                            
*                                                                               
GSTA0120 EQU   *                                                                
         OC    0(2,R1),0(R1)       IS THERE DISPLACEMENT                        
         BZ    GSTA0220            NO                                           
         CLI   XFILYES,C'Y'        YES - CROSS-FILE REPORT?                     
         BNE   GSTA0140            NO  - USE SPACEND TABLE                      
***>>>   BE    GSTA0320            YES - TREAT AS IF NO STATION                 
         EJECT                                                                  
*                                                                               
*                                                                               
*     CROSS-FILE REPORTING IS BEING DONE.  THE DISPLACEMENT                     
*        CALCULATED FROM SPACEND IS NOT CORRECT, SO IT MUST BE                  
*        REDONE FROM A TABLE WHICH CONTAINS ALL STATIONS FOR ALL                
*        REP FILES BEING CONSIDERED.                                            
*        MARKET STATION TABLE IS SET UP AS:                                     
MKSTNAME EQU   0                   POS 0  -  19  =  MARKET NAME                 
MKSTSTA  EQU   20                  POS 20  - 24   = STATION CALLS               
MKSTREP  EQU   25                  POS 25  - 26   = STATION REP                 
MKSTLEN  EQU   27                  LENGTH OF TABLE ENTRY                        
*                                                                               
         SR    RE,RE               YES - USE MARKET STN TABLE                   
         ICM   RE,3,0(R1)          (DISP IS 1ST 2 BYTES)                        
         BCTR  RE,0                MAKE ZERO RELATIVE                           
         STH   RE,HALF                                                          
         L     RF,AMKTSTA          SET A(MKT STATION TABLE)                     
         SR    RE,RE                                                            
         LA    RE,MKSTLEN          LENGTH OF MARKET STATION ENTRY               
         MH    RE,HALF             X RELATIVE STATION NUMBER                    
         AR    RF,RE                                                            
         MVC   WORK+8(20),MKSTNAME(RF)                                          
         B     GSTA0260            POINTS TO CORRECT STATION                    
*                                                                               
*                                                                               
GSTA0140 EQU   *                                                                
         SR    RE,RE                                                            
         ICM   RE,3,0(R1)          (DISP IS 1ST 2 BYTES)                        
         BCTR  RE,0                                                             
         STH   RE,HALF                                                          
         SR    RE,RE                                                            
         IC    RE,1(R4)            LENGTH OF STATION RECORD                     
         MH    RE,HALF             X RELATIVE STATION NUMBER                    
         AR    R4,RE                                                            
         B     GSTA0240                                                         
*                                                                               
*                                                                               
GSTA0180 EQU   *                                                                
         BAS   RE,NXTEL5                                                        
         BNE   GSTA0320                                                         
GSTA0200 EQU   *                                                                
         OC    0(2,R1),0(R1)                   DISPLACEMENT?                    
         BNZ   GSTA0140                        YES                              
GSTA0220 EQU   *                                                                
         CLC   REC+RGCMPDSP(2),DSTNREP(R4)     MATCH REP ID                     
         BNE   GSTA0180                                                         
         CLC   DUB(5),DSTNCALL(R4)             MATCH STATION                    
         BNE   GSTA0180                                                         
GSTA0240 EQU   *                                                                
         MVC   WORK+8(20),DMKTNAM(R4)          MOVE MKT NAME                    
GSTA0260 EQU   *                                                                
         CLC   SVMKT,DMKTNAM(R4)               SAME MARKET?                     
         BNE   GSTA0280            NO                                           
         OI    MKTBYTE,X'40'       > 1 STN IN MKT                               
         CLC   SVMKTSTA,DUB+6      SAME MARKET STATION #?                       
         BNE   GSTA0280            NO                                           
         OI    MKTBYTE,X'04'       YES - > 1 STN IN COMBO                       
GSTA0280 MVC   SVMKT,DMKTNAM(R4)   SAVE MARKET NAME                             
         MVC   SVMKTSTA,DUB+6      SAVE MARKET STATION #                        
         B     GNAMXIT                                                          
GSTA0300 EQU   *                                                                
         MVC   WORK+8(8),WORK                                                   
         MVC   WORK+16(5),=C'(   )'                                             
         MVC   WORK+17(3),REC+RGAFFDSP                                          
*                                  INSERT AFFIL FROM REC CMNT AREA              
*                                                                               
*   TEST                                                                        
*        MVC   P+1(16),=C'STATION ENTRY = '                                     
*        MVC   P+20(72),0(R4)                                                   
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
*                                  INSERT AFFILIATION                           
         B     GNAMXIT                                                          
GSTA0320 EQU   *                                                                
         LA    R1,DUB              RESET A(CODE) FOR STATION LOOKUP             
*                                     (HANDLES 3-CHARACTER STATIONS)            
         MVI   ELCODE,X'02'        SET TO STATION REC CODE                      
         BAS   RE,CHKBDNM2                                                      
         BNZ   GBADNAME            CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RSTAMKT-RSTAREC(RF)                                   
         CLI   RPSPLACT,C'Y'       NEED AFFILIATION FOR STATION?                
         BNE   GNAMXIT             NO  -                                        
         CLC   RPSPLSTA,CBLEVEL    YES - SPL STATION ROW?                       
         BNE   GNAMXIT             NO  -                                        
         MVC   WORK+8(8),WORK      YES - LOAD WHAT WE HAVE                      
         MVC   WORK+16(5),=C'(   )'                                             
         MVC   WORK+17(3),=C'UNK'  SET AFFILIATE TO 'UNKNOWN'                   
         B     GNAMXIT                                                          
*                                                                               
GAGYNMOD EQU   *                                                                
         CLI   8(R1),2             AGENCY ROUTINE?                              
         BNE   GOFFNMOD            NO  - CHECK FOR OFFICE                       
*                                                                               
*   AGENCY  CODE RELOCATION                                                     
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R1,4(R1)            RESET VALUE OF R1                            
         LA    RF,WORK+5           EVEN UP WORK-AREA CODE LENS                  
         LA    RE,WORK             DELIMITER                                    
GAGY0010 EQU   *                                                                
         CLI   0(RF),C' '          SPACE?                                       
         BNE   GAGY0015            NO  - SKIP THIS SPACE                        
         MVI   0(RF),X'FF'         YES - REPL WITH NON-SQUASH VALUE             
GAGY0015 EQU   *                                                                
         BCTR  RF,0                                                             
         CR    RF,RE               LAST POSITION CHECKED?                       
         BL    GAGY0020            YES - FINISHED                               
         B     GAGY0010                                                         
GAGY0020 EQU   *                                                                
         ZIC   RE,RPBUDPAS         BUDPAS SPEC?                                 
         LTR   RE,RE                                                            
         BZ    GAGY0030            NO                                           
*                                                                               
*  FOR BUDGET SPECS, BUDGET RECORDS WILL CONTAIN TWO POSITIONS OF               
*      'FFFF', FOLLOWED BY KEYWORD 'BUDGET' WHERE NAMES CANNOT                  
*      BE RETRIEVED.                                                            
*                                                                               
         CLC   0(2,R1),=X'FFFF'    YES - 'BUDGET' ROW?                          
         BNE   GAGY0030            NO                                           
         CLC   2(6,R1),=C'BUDGET'                                               
         BNE   GAGY0030            NO                                           
         MVC   WORK+8(8),0(R1)     INSERT BUDFLAG INTO WORK AREA                
         B     GNAMXIT             BUDGET:  DON'T GET NAME                      
*                                                                               
GAGY0030 EQU   *                                                                
         XC    KEY,KEY                                                          
         MVI   KEY,X'0A'                                                        
         MVC   KEY+19(6),0(R1)                                                  
         MVC   KEY+25(2),RCREPFL                                                
*                                                                               
GAGY0040 BAS   RE,HIGHA                                                         
         CLC   KEY(27),KEYSAVE                                                  
         BE    GAGY0060                                                         
*                                                                               
****     CLC   KEY(25),KEYSAVE     NO ZZ AGENCY IN USE                          
****     BE    GAGY0050               ANY LONGER                                
         CLI   RECLABEL,C'Y'       AGYNAME FILL-IN?                             
         BNE   GAGY0042            NO  - DUMP IT OUT                            
****>>>  MVI   RECLABEL+1,C'Y'     YES - SEND BACK NO-FIND FLAG                 
         MVC   WORK+8(20),SPACES                                                
         MVC   WORK+8(14),=C'AGENCY MISSING'                                    
         B     GNAMXIT                                                          
GAGY0042 EQU   *                                                                
         MVI   ELCODE,X'0A'        SET TO AGENCY REC CODE                       
         BAS   RE,CHKBDNM2                                                      
         BNZ   GBADNAME            CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),RAGYNAM1-RAGYREC(RF)                                  
         B     GNAMXIT                                                          
GAGY0050 EQU   *                                                                
         MVC   KEY+25(2),=C'ZZ'                                                 
         XC    KEY+27(5),KEY+27                                                 
         B     GAGY0040                                                         
*                                                                               
GAGY0060 L     R1,FILEC                                                         
         LA    R2,RAGYREC-FILED(R1)                                             
         BAS   RE,LINKFILA                                                      
         MVC   WORK+8(20),RAGYNAM1-FILED(R1)                                    
         B     GNAMXIT                                                          
*                                                                               
GOFFNMOD EQU   *                                                                
         CLI   8(R1),3             OFFICE ROUTINE?                              
         BNE   GGRPNMOD            NO  - CHECK FOR GROUP                        
*                                                                               
*   OFFICE  CODE RELOCATION                                                     
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R1,4(R1)            RESET VALUE OF R1                            
         MVC   WORK(8),SPACES                                                   
         MVC   WORK(2),1(R1)       MOVE ALPHA OFFICE CODE                       
*                                                                               
         TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    GNAMXIT                                                          
*                                                                               
GETOFC2  MVI   ELCODE,4                                                         
         BAS   RE,FSTEL5                                                        
         B     *+8                                                              
*                                                                               
GETOFC4  BAS   RE,NXTEL5                                                        
         BE    GETOFC5                                                          
         LA    R1,1(R1)            ADJUST ADDRESS OF OFFICE FOR                 
*                                     'BADNAME' CHECKER ROUTINE                 
         BAS   RE,CHKBDNM2                                                      
         BNZ   GBADNAME            CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         MVC   WORK+8(20),ROFFNAME-ROFFREC(RF)                                  
         B     GNAMXIT                                                          
GETOFC5  EQU   *                                                                
         CLC   REC+RGCMPDSP(2),DOFFREP(R4)     MATCH REP ID                     
         BNE   GETOFC4                                                          
         CLC   1(2,R1),DOFFOFF(R4)       MATCH OFFICE CODE                      
         BNE   GETOFC4                                                          
         MVC   WORK+8(20),DOFFNAM(R4)                                           
         B     GNAMXIT                                                          
GGRPNMOD EQU   *                                                                
         CLI   8(R1),4             OFFICE ROUTINE?                              
         BE    *+6                 YES - LAST ROUTINE AT THIS TIME              
         DC    H'0'                                                             
*                                                                               
*   GROUP   CODE RELOCATION                                                     
*                                                                               
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R1,4(R1)            RESET VALUE OF R1                            
         TM    RNDTATYP,1          TEST TO PRINT NAME                           
         BZ    GNAMXIT                                                          
*                                                                               
GETGRP2  MVI   GETGRPCL+1,0        SET EX LEN = 1                               
         CLI   BYTE,25             TEST GROUP ONLY                              
         BE    *+8                                                              
         MVI   GETGRPCL+1,1        ELSE SET LEN = 2                             
*                                                                               
         MVI   ELCODE,X'07'                                                     
         BAS   RE,FSTEL5                                                        
         B     *+8                                                              
*                                                                               
GETGRP4  BAS   RE,NXTEL5                                                        
         BE    GETGRP5                                                          
         BAS   RE,CHKBDNM2                                                      
         BNZ   GBADNAME            CC NZ = NOT FOUND                            
         L     R1,FILEC                                                         
         LA    RF,RCONREC-FILED(R1)                                             
         CLI   BYTE,26             SUBGROUP ONLY?                               
         BNE   GETGRP4C            NO                                           
         MVC   WORK+8(10),RGRPSBNM-RGRPREC(RF)                                  
*                                  YES - LOAD SUBGRP NAME ONLY                  
         B     GNAMXIT             DONE - EXIT                                  
GETGRP4C EQU   *                                                                
         MVC   WORK+8(10),RGRPNAME-RGRPREC(RF)                                  
*                                  LOAD GROUP NAME                              
         CLI   BYTE,7              GROUP+SUBGROUP?                              
         BNE   GNAMXIT             NO                                           
         MVC   WORK+19(10),RGRPSBNM-RGRPREC(RF)                                 
*                                  YES - LOAD SUBGRP NAME ALSO                  
         B     GNAMXIT                                                          
GETGRP5  EQU   *                                                                
         CLC   =C'**',2(R4)        FLAG TO IGNORE REP TEST?                     
         BE    GETGRPCL            YES                                          
         CLC   REC+RGCMPDSP(2),2(R4)                                            
*                                  NO  - REP ID'S MATCHED?                      
         BNE   GETGRP4             NO                                           
GETGRPCL CLC   0(0,R1),4(R4)       *** DYNAMICALLY MODIFIED ***                 
         BNE   GETGRP4                                                          
         CLI   BYTE,26             TEST SUBGROUP ONLY                           
         BNE   *+14                                                             
         MVC   WORK+8(10),16(R4)                                                
         B     *+10                                                             
         MVC   WORK+8(10),6(R4)                                                 
         CLI   BYTE,7              TEST GROUP (I.E. GRP AND SUBGRP)             
         BNE   *+10                                                             
         MVC   WORK+19(10),16(R4)                                               
         B     GNAMXIT                                                          
         SPACE  1                                                               
*                                                                               
GNAMXIT  EQU   *                                                                
         SR    R0,R0                                                            
         B     GGENXIT                                                          
GBADNAME EQU  *                                                                 
         LTR   RB,RB                                                            
GGENXIT  EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   CHKBDNM2:  IF CROSS-FILE REPORTING, CHECK OTHER PARTICIPATING               
*        FILES FOR EXPANSIONS PRIOR TO REPORTING **UNKNOWN**                    
*        RECORD TYPE WILL BE IN ELCODE                                          
*        RETURN CC = ZERO IF FOUND                                              
*        RETURN CC NZ     IF NOT FOUND                                          
*                                                                               
CHKBDNM2 NTR1                                                                   
         L     R3,THISQWK                                                       
         USING QWKD,R3                                                          
         LA    R3,QWREQ3                                                        
         DROP  R3                                                               
         USING QREC3,R3                                                         
         OC    Q3XFILNM,Q3XFILNM   CROSS-FILE REPORT?                           
         BZ    CBNM0090            NO                                           
         CLC   Q3XFILNM,SPACES     CROSS-FILE REPORT?                           
         BE    CBNM0090            NO                                           
*                                                                               
***>>>   NEED TO FIND THE CROSS-FILE CODE                                       
*                                                                               
         LR    R2,R1               SET A(CODE BEING TESTED)                     
         GOTO1 =A(XFILCHK),DMCB,(RC),(R2),(ELCODE,Q3XFILNM)                     
*                                                                               
         DROP  R3                                                               
*                                                                               
         BNZ   CBNM0090            NOT FOUND                                    
         SR    R0,R0                                                            
         B     CBNM0100            FOUND - EXIT CC = ZERO                       
CBNM0090 EQU   *                                                                
         LR    R0,RB               SET CC N= ZERO                               
CBNM0100 EQU   *                                                                
         L     R3,ADCONLST                                                      
         USING ADCONSD,R3                                                       
         L     R5,MASTC                                                         
         USING MASTD,R5            USING STILL IN EFFECT                        
         L     RE,MCUTL            SET A(UTL)                                   
*                                                                               
         DROP R3,R5                                                             
*                                                                               
         MVC   4(1,RE),SAVSENUM    RESET ORIGINAL SE NUMBER                     
*                                                                               
         LTR   R0,R0               SET FINAL CONDITION CODE                     
         XIT1                                                                   
         EJECT                                                                  
HIGHA    NTR1                                                                   
         LA    RF,DMRDHI                                                        
         MVC   KEYSAVE,KEY                                                      
         B     LINKDIRA                                                         
*                                                                               
SEQA     NTR1                                                                   
         LA    RF,DMRSEQ                                                        
         MVC   KEYSAVE,KEY                                                      
         B     LINKDIRA                                                         
*                                                                               
LINKDIRA EQU   *                                                                
         ST    RF,DMCB                                                          
         MVC   DMCB(1),DMINBTS                                                  
         GOTO1 DATAMGR,DMCB,,REPDIR,KEY,KEY,0                                   
         B     DMCHECKA                                                         
*                                                                               
*                                                                               
LINKFILA NTR1                                                                   
         GOTO1 DATAMGR,DMCB,(DMINBTS,GETREC),REPFILE,KEY+28,           X        
               (R2),(0,DMWORK)                                                  
         MVC   LASTIO,DMCB+12      SAVE THESE VALUES                            
         MVC   LASTDA,KEY+28                                                    
         MVC   LASTLEN,27(R2)                                                   
*                                                                               
DMCHECKA TM    DMCB+8,X'10'        TEST FOR RECORD NOT FOUND                    
         BZ    DMA010                                                           
         TM    29(R2),X'80'        IS RECORD MARKED FOR DELETION                
         BZ    DMA020              NO - ERROR                                   
         LTR   RB,RB               YES - RETURN WITH CC NE 0                    
         B     DMAIT                                                            
*                                                                               
DMA010   TM    DMCB+8,X'EF'        TEST FOR OTHER ERRORS                        
         BZ    DMAIT                                                            
*                                                                               
DMA020   MVC   WORK(27),=C'*** DATA MANAGER ERROR  ***'                         
         GOTO1 LOGIO,WORK+32,1,(27,WORK)                                        
         MVC   WORK(27),=C'*** REQUEST NUMBER NNNN ***'                         
         L     R5,MCADDR                                                        
         UNPK  WORK+19(4),MCREQNO-MASTD(3,R5)                                   
         OI    WORK+22,X'F0'                                                    
         BASR  RE,RF                                                            
         DC    H'0'            BLOW UP                                          
DMAIT    XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
                                                                                
         SPACE 1                                                                
         EJECT                                                                  
NXTEL5   SR    R0,R0                                                            
         ICM   R0,1,1(R4)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R4,R0                                                            
FSTEL5   CLI   0(R4),0                                                          
         BE    NXTEL5X                                                          
         CLC   0(1,R4),ELCODE                                                   
         BNE   NXTEL5                                                           
         BR    RE                                                               
*                                                                               
NXTEL5X  LTR   RE,RE                                                            
         BR    RE                                                               
         EJECT                                                                  
* RANK DATA RECORDS - 4(R1) POINTS TO AL1(ROW)/AL3(ROWRANK SPEC) *              
         SPACE 1                                                                
         DS     0F                                                              
RANK     NMOD1  0,**RANK**                                                      
*                                                                               
         L     RC,0(R1)                                                         
         USING WORKD,RC                                                         
*                                                                               
         LA    R1,4(R1)            POINT TO ROW PARM                            
*                                                                               
*   RANK PARAMETER IS SET UP LIKE THIS:                                         
*        BYTE    1      =  ROW NUMBER OF RANK                                   
*        BYTES   2-3    =  A(33 SPEC) WHICH IS IN THIS FORMAT:                  
*             + 0       =  ENTRY CODE 33 (X'21')                                
*             + 1       =  LENGTH OF ENTRY                                      
*             + 2       =  COLUMN NUMBER TO RANK                                
*             + 3       =  'IF' SPEC NUMBER                                     
*             + 4       =  'WITHIN' ROW NUMBER                                  
*                                                                               
         SR    R6,R6                                                            
         IC    R6,0(R1)            GET ROW NUMBER                               
         MH    R6,=Y(RGROWSZ)                                                   
         STH   R6,HALF             SAVE DSPL                                    
         LA    R6,REC(R6)          POINT TO RANK VALUE ROW                      
         XC    RKRECAP,RKRECAP     INIT RANK RECAP                              
*                                                                               
         L     RE,0(R1)                                                         
         ZIC   R7,2(RE)            GET COL NUMBER ON WHICH TO RANK              
         BCTR  R7,0                                                             
         SLL   R7,2                X 4                                          
         LA    R3,NULLS            DEFAULT SORT KEY = NULLS                     
         CLI   4(RE),0             RANKING WITHIN?                              
         BE    RANK0040            NO  -                                        
         ZIC   R3,4(RE)            YES - 'WITHIN' ROW NUMBER                    
         MH    R3,=Y(RGROWSZ)      MULTIPLY BY ROW SIZE                         
         LA    R3,REC(R3)          SET A('WITHIN' ROW)                          
         ST    R3,P6+4             SAVE A('WITHIN' ROW) TEMPORARILY             
         B     *+8                                                              
*                                                                               
RANK0040 MVI   RKRECAP,C'N'        NOT RANKING WITHIN LEVEL -                   
*                                     ALLOW NO RECAP                            
         XC    RANKSUB,RANKSUB                                                  
         L     RE,RPCOLCOM+4(R7)                                                
         LTR   RE,RE               TEST COLCOMP THIS COL                        
         BZ    RANK0120            NO                                           
         LA    RF,RANKPCT                                                       
         CLI   3(RE),5             TEST COMP=PCT                                
         BE    RANK0080                                                         
         CLI   3(RE),7             TEST COMP=PCTADJ                             
         BE    RANK0080                                                         
         DC    H'0'                                                             
RANK0080 ST    RF,RANKSUB                                                       
         MVC   RANKSPEC,2(RE)      MOVE SPEC                                    
         ZIC   RF,1(RE)            GET LENGTH                                   
         LA    RE,RANKSPEC-2(RF)   POINT TO END                                 
         MVI   0(RE),0             SET EOL FLAG                                 
*                                                                               
RANK0120 LA    R7,REC+RGDTADSP(R7) POINT TO COL DATA                            
*                                                                               
         LA    RE,RGRECLEN         SET RECORD LENGTH FOR SORT                   
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  RECCARD+22(3),DUB                                                
*                                                                               
         LA    RE,RGKEYLEN         SET KEYLENGTH IN SORT CARD                   
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SORTCD1+15(3),DUB                                                
*                                                                               
         GOTO1 SORTER,DMCB,SORTCD1,RECCARD                                      
*                                                                               
         OPEN  (RGWORK,INPUT)                                                   
         LA    R0,RANK0560         SET EOF ADDRESS                              
         STCM  R0,7,RGWORK+33                                                   
         ZIC   R4,RPROWS                                                        
         MH    R4,=Y(RGROWSZ)                                                   
         LA    R4,REC(R4)          R4 = A(MONTH ROW)                            
*                                                                               
RANK0160 GET   RGWORK,REC                                                       
*                                                                               
*   TEST                                                                        
         CLC   =C'IN OUT',QUESTOR                                               
         BNE   RANK0200                                                         
         MVC   P+1(04),=C'IN ='                                                 
         MVC   P+5(108),REC                                                     
         GOTO1 REPORT                                                           
         MVC   P+5(48),REC+RGDTADSP                                             
         GOTO1 REPORT                                                           
RANK0200 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         CLC   REC+RGROWSZ(RGROWSZ-1),XFF  TEST EOF REC                         
         BNE   RANK0240                                                         
         MVC   REC(8),XFF          SET HIGH VALUE                               
         B     RANK0480                                                         
*                                                                               
RANK0240 EQU   *                                                                
         TM    1(R4),X'80'         TEST FOR NOT TOTAL MONTH                     
         BO    RANK0320                                                         
         ICM   RF,15,RANKSUB       TEST COMP REQUIRED                           
         BZ    *+6                                                              
         BASR  RE,RF               YES- GO TO COMP SUBR                         
         ICM   R5,15,0(R7)         NO- GET COL DATA                             
*                                                                               
*   TEST                                                                        
*        MVC   P+1(21),=C'DATA=1234567890 ADDR='                                
*        ST    R7,DUB                                                           
*        GOTO1 HEXOUT,DMCB,DUB,P+22,4,=C'TOG'                                   
*        EDIT  (R5),(10,P+6),FILL=0                                             
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
RANK0280 LCR   R5,R5               COMPLEMENT FOR DESCENDING SEQUENCE           
*                                                                               
RANK0320 EQU   *                                                                
         LTR   R5,R5               TEST FOR POSITIVE                            
         BNZ   *+6                 TEST FOR ZERO                                
         BCTR  R5,0                YES - SUBTRACT 1 TO COME OUT LAST            
         STCM  R5,15,REC+5         SET VALUE FOR SORT                           
         LTR   R5,R5                                                            
         BNP   *+12                                                             
         OI    REC+5,X'80'         IF POSITIVE, TURN ON HIGH BIT                
         B     *+8                                                              
         NI    REC+5,X'7F'         IF NEGATIVE, TURN OFF HIGH BIT               
         CLI   RKRECAP,C'Y'        ARE WE ALREADY IN A RANK RECAP               
         BE    RANK0440            YES                                          
         CLI   RKRECAP,C'N'        ARE WE ALLOWING A RANK RECAP                 
         BE    RANK0440            NO                                           
         LR    R1,R3               LOOK FOR RECAP RPT NUM IN ROWS               
         BCTR  R1,0                    BEFORE THE WITHIN LEVEL                  
         C     R1,=A(REC+9)        IS SEARCH STARTING BEFORE                    
*                                     THE **FIRST** ROW?                        
         BL    RANK0400            YES - CONSIDER IT 'FOUND'                    
*                                  NO  - START SEARCHING IN ROW #               
*                                     'WITHIN-ROW# - 1'                         
RANK0360 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        MVC   P+10(10),0(R1)      DISPLAY RECAP NUMBER FIELD                   
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         CLI   0(R1),1             ROW RECAP NUMBER = 1?                        
         BH    RANK0400            NO  - GREATER: START RECAP                   
         SH    R1,=Y(RGROWSZ)      YES - BACK UP ONE ROW                        
         C     R1,=A(REC+RGROWSZ)  POSITION PRIOR TO 1ST ROW?                   
         BL    RANK0440            YES - NOT FOUND                              
         B     RANK0360            NO  - KEEP LOOKING FOR RECAP NUM             
*                                                                               
RANK0400 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        MVC   P+1(12),=C'RECAP NUMBER'                                         
*        MVC   P+18(64),REC                                                     
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         MVI   RKRECAP,C'Y'        FOUND - NOW WE START THE RANK RECAP          
         ZIC   RF,0(R1)                                                         
         BCTR  RF,0                                                             
         MH    RF,=Y(RPSPECX-RPSPECD)  FIND THE RECAP RPSPECS                   
         A     RF,=A(RPDATA)                                                    
         ZIC   RE,RPRANK1-RPSPECD(RF)  FIND THE RECAP RANK ROW                  
         MH    RE,=Y(RGROWSZ)                                                   
         LA    RE,REC(RE)                                                       
         STCM  RE,7,RKRECAP+1      STORE THE RECAP RANK ROW ADDRESS             
         ZIC   R4,RPROWS-RPSPECD(RF)                                            
         MH    R4,=Y(RGROWSZ)                                                   
         LA    R4,REC(R4)                                                       
         ST    R4,FULL             R4 = A(MONTH ROW FOR RECAP)                  
         LA    R3,XFF              MOVE HIGHVALS INTO SORTKEY FOR RECAP         
*                                                                               
RANK0440 MVC   REC(5),0(R3)        SET SORT KEY                                 
         TM    RPMISFLG,X'01'      SPECIAL RANK REQUIRED?                       
         BNO   RANK0480            NO                                           
         L     RF,P6+4             YES - GET A(RANK ROW) FROM TEMP              
         LA    RF,RGROWSZ-1(RF)    BUMP TO LAST POSITION                        
         MVC   REC+4(1),0(RF)      INSERT LEVEL INTO SORT KEY                   
*                                                                               
RANK0480 EQU   *                                                                
*                                                                               
*   TEST                                                                        
         CLC   =C'IN OUT',QUESTOR                                               
         BNE   RANK0520                                                         
         MVC   P+1(04),=C'OUT='    **TEST**                                     
         MVC   P+5(108),REC        **TEST**                                     
         GOTO1 REPORT              **TEST**                                     
RANK0520 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         GOTO1 SORTER,DMCB,=C'PUT',REC                                          
         B     RANK0160                                                         
*                                                                               
RANK0560 CLOSE RGWORK                                                           
*                                                                               
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  8'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         XC    RANKFLGS,RANKFLGS   CLEAR ALL SPECIAL FLAGS                      
         TM    RPMISFLG,X'01'      SPECIAL RANK REQUIRED?                       
         BNO   RANK0580            NO                                           
         OI    RANKFLGS,X'80'      YES - SET 'SPECIAL SORT' FLAG                
RANK0580 EQU   *                                                                
         ST    R2,AOLDSPEC         SAVE ORIGINAL SPEC ADDR                      
*                                                                               
         OPEN  (RGWORK,OUTPUT)                                                  
*                                                                               
         XC    RANKROWS,RANKROWS   CLEAR RANKMAX+1 KEY AREA                     
         XC    RANKCOMP,RANKCOMP   CLEAR COMPARE RANK  AREA                     
         SR    R5,R5               CLEAR CURRENT RANK NUMBER                    
         XC    RANKDUB,RANKDUB                                                  
         MVI   RANKDONE,C'N'                                                    
         ZIC   R7,RPROWS                                                        
         MH    R7,=Y(RGROWSZ)                                                   
         LA    R7,REC(R7)          R7 = A(MONTH ROW)                            
         MVI   DELTOTS,C'N'                                                     
         ZIC   R1,RPROWS                                                        
         SLL   R1,2                                                             
         L     R1,RPROWDEF(R1)     POINT TO MONTH ROW DEF                       
         CLI   3(R1),17            TEST FOR 'MONTH'                             
         BE    *+12                                                             
         CLI   3(R1),20            TEST FOR 'QTR'                               
         BNE   RANK0600                                                         
         MVI   DELTOTS,C'Y'        EQUAL - DISCARD TOTAL MONTH RECS             
*                                                                               
RANK0600 GOTO1 SORTER,DMCB,=C'GET'         GET FIRST RECORD                     
         ICM   RE,15,4(R1)                                                      
         BZ    RANK1880                                                         
         MVC   REC(RGRECLEN),0(RE)         MOVE RECORD                          
*                                                                               
*   TEST                                                                        
         CLC   =C'IN2OUT2',QUESTOR                                              
         BNE   RANK0610                                                         
         MVC   P+1(04),=C'IN2='    **TEST**                                     
         MVC   P+5(1),RPAGGTOT     **TEST**                                     
         MVC   P+06(108),REC       **TEST**                                     
         GOTO1 REPORT              **TEST**                                     
RANK0610 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         CLC   REC+RGROWSZ(RGROWSZ-1),XFF  TEST EOF REC                         
         BE    RANK0600                                                         
         MVC   SORTKEY,REC         SAVE CURRENT SORT KEY                        
         B     RANK1320                                                         
*                                                                               
RANK0640 GOTO1 SORTER,DMCB,=C'GET'                                              
         ICM   RE,15,4(R1)                                                      
         BZ    RANK1880                                                         
         MVC   REC(RGRECLEN),0(RE)         MOVE RECORD                          
*                                                                               
*   TEST                                                                        
         CLC   =C'IN2OUT2',QUESTOR                                              
         BNE   RANK0680                                                         
         MVC   P+1(04),=C'IN2='    **TEST**                                     
         MVC   P+5(1),RPAGGTOT     **TEST**                                     
         MVC   P+06(108),REC       **TEST**                                     
         GOTO1 REPORT              **TEST**                                     
RANK0680 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         TM    RPMISFLG,X'01'      SPECIAL SORT?                                
         BNO   RANK0720            NO                                           
         ZIC   RF,REC+4            YES = GET SPEC# FROM SORT KEY                
         BCTR  RF,0                MAKE ZERO RELATIVE                           
         MH    RF,=Y(RPSPECX-RPSPECD)                                           
*                                  MULT BY SIZE OF ENTRY                        
         A     RF,=A(RPDATA)       ADD A(SPECS THEMSELVES)                      
         LR    R2,RF               INSERT NEW ADDRESS                           
*                                                                               
RANK0720 EQU   *                                                                
         CLC   REC+RGROWSZ(RGROWSZ-1),XFF  TEST EOF REC                         
         BE    RANK1800                                                         
*                                                                               
*   IF AGGREGATE BASE REPORT, AND RECORD IS AGGREG OR AGGSPL,                   
*      PASS IT THROUGH AUTOMATICALLY                                            
*                                                                               
         ZIC   RF,RPAGGTOT         AGGREGATE BASE REPORT:                       
         LTR   RF,RF                 TOTAL #ROWS NOT = ZERO?                    
         BZ    RANK0760            NO  - NOT AGGREGATE REPORT -                 
*                                  YES - DON'T BUMP VALUE IF AGGREG             
*                                     OR AGGSPL RECORD                          
         LA    RF,1(RF)            TOTAL ROWS +1 FOR CONTROL                    
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                SET TO LAST POS, LAST ROW                    
         LA    RF,REC(RF)          ADD A(REC)                                   
         CLI   0(RF),X'00'         BYTE = 0?  AGGREGATE OR SPL                  
*                                     AS-RUN RECORD?                            
         BNE   RANK0740            NO  - NEED TO BUMP RANK NUMBER               
         TM    1(R7),X'80'         YES - DETAIL MONTH?                          
         BZ    RANK1820            YES                                          
*                                                                               
*********************************************************************           
***>>    TM    RPMISFLG+1,X'01'    NO  - SPECIAL RANK NUMBERING?                
***>>    BO    RANK1820            YES - LEAVE 'HIGH BIT'                       
*********************************************************************           
         NI    1(R7),X'7F'         TURN OFF HIGH BIT                            
         B     RANK1820                                                         
RANK0740 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        MVC   P+1(05),=C'0610='   **TEST**                                     
*        MVC   P+8(1),RPAGGTOT     **TEST**                                     
*        MVC   P+18(64),REC        **TEST**                                     
*        GOTO1 REPORT              **TEST**                                     
*   END TEST                                                                    
*                                                                               
RANK0760 EQU   *                                                                
         CLI   RANKDONE,C'Y'       TEST FOR CURRENT RANK DONE                   
         BNE   RANK0800                                                         
         CLC   SORTKEY,REC         YES- TEST FOR SAME SORT KEY                  
         BE    RANK0640                 YES- READ NEXT REC                      
         MVI   RANKDONE,C'N'            NO - START NEW RANK                     
         B     RANK1000                                                         
*                                                                               
RANK0800 EQU   *                                                                
         TM    1(R7),X'80'         DETAIL MONTH?                                
         BZ    RANK0960            YES                                          
         MVC   0(6,R6),RANKDUB     NO  - MOVE CURRENT RANK NUMBER               
*                                                                               
         NI    1(R7),X'7F'         TURN OFF HIGH BIT                            
         TM    RPMISFLG+1,X'01'    SPECIAL RANK NUMBERING?                      
         BO    RANK1800            YES - LEAVE 'HIGH BIT'                       
         CLI   RANKDUB+4,C'+'      RANK > RANKMAX?                              
         BNE   RANK1800            NO  - PROCESS                                
         OC    RANKROWS,RANKROWS   FIRST PASS?                                  
         BNZ   RANK0880            NO                                           
         ZIC   RE,RPROWS           COMPUTE LENGTH TO SAVE --                    
*                                     LEAVE THE DATE ROW ALONE...               
         MH    RE,=H'9'            MULTIPLY BY ROWSIZE                          
         BCTR  RE,0                SUBTRACT 1 FOR EX STATEMENT                  
         EX    RE,RANK0840         MOVE BY LENGTH                               
         B     RANK1800                                                         
RANK0840 MVC   RANKROWS(0),REC     YES - SAVE KEY OF 1ST RECORD WITH            
*                                     RANKMAX+1 (UP TO DATE ROW)                
RANK0880 EQU   *                                                                
         ZIC   RE,RPROWS           COMPUTE LENGTH TO RESTORE --                 
*                                     UP TO THE DATE ROW                        
         MH    RE,=H'9'            MULTIPLY BY ROWSIZE                          
         BCTR  RE,0                SUBTRACT 1 FOR EX STATEMENT                  
         EX    RE,RANK0920         MOVE BY LENGTH                               
         B     RANK1800                                                         
RANK0920 MVC   REC(0),RANKROWS     INSERT 1ST KEY INTO EACH                     
*                                     RANKMAX+1 RECORD                          
*                                                                               
RANK0960 EQU   *                                                                
         CLC   SORTKEY,REC         START OF NEW RANK?                           
         BE    RANK1040            NO                                           
*                                                                               
RANK1000 EQU   *                                                                
         MVC   SORTKEY,REC         SAVE NEW SORT KEY                            
         SR    R5,R5               CLEAR CURRENT RANK NUMBER                    
         XC    RANKDUB,RANKDUB                                                  
         CLC   REC(5),XFF          RECAP RANK?                                  
         BNE   RANK1320                                                         
         L     R6,RKRECAP          YES - CHANGE THE RANK ROW ADDR               
         L     R7,FULL             CHANGE THE MONTH ROW ADDR                    
         B     RANK1320            START NEW RANK                               
*                                                                               
RANK1040 EQU   *                                                                
*                                  R4 = INVERTED VALUE FOR DESCENDING           
*                                     SORT SEQUENCING                           
*                                                                               
         CLM   R4,15,REC+5         COMPARE VALUES                               
         BNE   RANK1320                                                         
         TM    RPMISFLG+2,X'01'    RANK > RANKMAX AS SINGLE VALUE?              
         BNO   RANK1080            NO  - CONTINUE AS USUAL                      
         L     RF,THISQWK                                                       
         CLI   QWRKMAX-QWKD(RF),0  ANY RANKMAX?                                 
         BE    RANK1080            NO                                           
*                                                                               
*   TEST                                                                        
*        L     RF,THISQWK                                                       
*        MVC   P+1(06),=C'RANK#='                                               
*        MVC   P+10(1),QWRKMAX-QWKD(RF)                                         
*        OI    P+10,X'F0'                                                       
*        EDIT  (R4),(2,P+14),ZERO=NOBLANK,DUB=MYDUB                             
*        GOTO1 REPORT                                                           
*        B     RENDTEST                                                         
*MYDUB    DS    D                                                               
*RENDTEST EQU   *                                                               
*                                                                               
*   END TEST                                                                    
*                                                                               
*                                  DUB = COUNTER OF POSITIONAL RANK             
*                                                                               
         CLC   RANKDUB+3(1),QWRKMAX-QWKD(RF) BEYOND UPPER LIMIT?                
         BH    RANK1400                                                         
*                                                                               
RANK1080 EQU   *                                                                
         CLI   RANKDUB+4,C'*'                                                   
         BNE   *+8                                                              
         MVI   RANKDUB+5,C'*'                                                   
         TM    RPMISFLG,X'01'      SPECIAL SORT?                                
         BNO   RANK1240            NO                                           
         ZIC   RF,RPAGGBAS         SET COMP/MOVE LENGTH: # OF ROWS              
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=Y(RGROWSZ)      MULTIPLY BY ROWSIZE                          
         BCTR  RF,0                MINUS 1 FOR EX STATEMENT                     
         B     RANK1200            NO                                           
RANK1120 MVC   RANKCOMP(0),REC     MOVE TO COMPARE STORAGE                      
RANK1160 CLC   RANKCOMP(0),REC     COMPARE TO STORAGE                           
*                                                                               
RANK1200 EQU   *                                                                
         EX    RF,RANK1160         COMPARE KEYS                                 
         BNE   RANK1240                                                         
         MVI   RANKDUB+5,X'00'     CLEAR SECOND ASTERISK                        
         B     RANK1280                                                         
RANK1240 EQU   *                                                                
         MVI   RANKDUB+4,C'='      SAME RANK NUMBER AS PREVIOUS                 
RANK1280 EQU   *                                                                
         MVC   0(6,R6),RANKDUB                                                  
         TM    RPMISFLG+1,X'01'    SPECIAL RANK NUMBERING?                      
         BO    RANK1760            YES - DON'T BUMP ON EQUAL                    
         LA    R5,1(R5)            BUMP RANK NUMBER                             
         B     RANK1760                                                         
*                                                                               
RANK1320 EQU   *                                                                
         MVC   RANKCOMP,REC        SAVE CURRENT KEY                             
         ZIC   RF,RPAGGTOT         AGGREGATE BASE REPORT:                       
         LTR   RF,RF                 TOTAL #ROWS NOT = ZERO?                    
         BZ    RANK1360            NO  - NOT AGGREGATE REPORT -                 
*                                  YES - DON'T BUMP VALUE IF AGGREG             
*                                     OR AGGSPL RECORD                          
         LA    RF,1(RF)            TOTAL ROWS +1 FOR CONTROL                    
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                SET TO LAST POS, LAST ROW                    
         LA    RF,REC(RF)          ADD A(REC)                                   
         CLI   0(RF),X'00'         BYTE = 0?  AGGREGATE OR SPL                  
*                                     AS-RUN RECORD?                            
         BE    RANK1820            YES - DON'T BUMP THIS RECORD                 
*                                  NO  - NEED TO BUMP RANK NUMBER               
RANK1360 EQU   *                                                                
         ICM   R4,15,REC+5         SAVE THIS VALUE                              
         LA    R5,1(R5)            BUMP RANK NUMBER                             
*                                                                               
*   TEST                                                                        
*        L     RF,THISQWK                                                       
*        MVC   P+1(06),=C'RANK#='                                               
*        MVC   P+10(1),QWRKMAX-QWKD(RF)                                         
*        OI    P+10,X'F0'                                                       
*        EDIT  (R5),(2,P+14),ZERO=NOBLANK                                       
*        GOTO1 REPORT                                                           
*        DC    H'0'                                                             
*   END TEST                                                                    
*                                                                               
RANK1400 EQU   *                                                                
         L     RF,THISQWK                                                       
         CLI   QWRKMAX-QWKD(RF),0                                               
         BE    RANK1640                                                         
         CLM   R5,1,QWRKMAX-QWKD(RF)   TEST FOR BEYOND UPPER LIMIT              
         BL    RANK1640                                                         
         BE    RANK1600                                                         
         TM    RPMISFLG+2,X'01'    TREAT > RANKMAX AS SINGLE VALUE?             
         BNO   RANK1560            NO                                           
         ZIC   R5,QWRKMAX-QWKD(RF) YES - RESET VALUE TO RANKMAX+1               
         LA    R5,1(R5)                                                         
         ST    R5,RANKDUB                                                       
         MVI   RANKDUB+4,C'+'      SET INDICATOR                                
         MVC   0(5,R6),RANKDUB     INSERT INTO RECORD                           
         OC    RANKROWS,RANKROWS   FIRST PASS?                                  
         BNZ   RANK1480            NO                                           
         ZIC   RE,RPROWS           COMPUTE LENGTH TO SAVE --                    
*                                     LEAVE THE DATE ROW ALONE...               
         MH    RE,=H'9'            MULTIPLY BY ROWSIZE                          
         BCTR  RE,0                SUBTRACT 1 FOR EX STATEMENT                  
         EX    RE,RANK1440         MOVE BY LENGTH                               
         B     RANK1760                                                         
RANK1440 MVC   RANKROWS(0),REC     YES - SAVE KEY OF 1ST RECORD WITH            
*                                     RANKMAX+1 (UP TO DATE ROW)                
RANK1480 EQU   *                                                                
         ZIC   RE,RPROWS           COMPUTE LENGTH TO RESTORE --                 
*                                     UP TO THE DATE ROW                        
         MH    RE,=H'9'            MULTIPLY BY ROWSIZE                          
         BCTR  RE,0                SUBTRACT 1 FOR EX STATEMENT                  
         EX    RE,RANK1520         MOVE BY LENGTH                               
         B     RANK1760                                                         
RANK1520 MVC   REC(0),RANKROWS     INSERT 1ST KEY INTO EACH                     
*                                     RANKMAX+1 RECORD                          
RANK1560 EQU   *                                                                
         MVI   RANKDONE,C'Y'          BEYOND MAX - SKIP REST OF RECS            
         B     RANK0640                                                         
RANK1600 EQU   *                                                                
         MVI   RANKDUB+4,C'*'      EQUAL UPPER LIMIT - GIVE A STAR              
         B     RANK1680                                                         
*                                                                               
RANK1640 EQU   *                                                                
         MVI   RANKDUB+4,0                                                      
         XC    RANKROWS,RANKROWS   CLEAR KEY RESET VALUE                        
RANK1680 EQU   *                                                                
RANK1720 EQU   *                                                                
         ST    R5,RANKDUB          SAVE RANK NUMBER                             
         MVC   0(5,R6),RANKDUB     SET RANK IN RECORD                           
RANK1760 EQU   *                                                                
         CLI   DELTOTS,C'Y'        TEST FOR DISCARDING TOTAL MONTHS             
         BE    RANK0640            YES- READ NEXT RECORD                        
*                                                                               
RANK1800 EQU   *                                                                
         MVI   8(R6),1             FORCE REPORT TYPE 1                          
RANK1820 EQU   *                                                                
         XC    REC(RGROWSZ),REC    CLEAR SORT KEY AND RANK VALUE                
*                                                                               
*   TEST                                                                        
         CLC   =C'IN2OUT2',QUESTOR                                              
         BNE   RANK1840                                                         
         MVC   P+1(04),=C'OUT='    **TEST**                                     
         MVC   P+5(1),RPAGGTOT     **TEST**                                     
         MVC   P+06(108),REC       **TEST**                                     
         GOTO1 REPORT              **TEST**                                     
RANK1840 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         LA    R0,REC                                                           
         PUT   RGWORK,(R0)                                                      
         B     RANK0640                                                         
*                                                                               
OLDSPEC  DS    XL1                                                              
RANKROWS DS    CL(RGKEYLEN)        STORAGE FOR RANKMAX+1 MERGE KEY              
RANKCOMP DS    CL(RGKEYLEN)        STORAGE FOR RANK COMPARISON                  
AOLDSPEC DS    A                   A(OLD SPEC)                                  
SAVERF   DS    A                                                                
RANKDUB  DS    D                                                                
RANKFLGS DS    F                                                                
*                                  BYTE 1  X'80'  =  RPMISFLG = X'01'           
*                                                    SPECIAL SORT               
*                                                                               
RANK1880 EQU   *                                                                
****     TM    RPMISFLG,X'01'      SPECIAL SORT?                                
         TM    RANKFLGS,X'80'      SPECIAL SORT?                                
         BNO   RANK1920            NO                                           
         L     R2,AOLDSPEC         RESET A(ORIGINAL SPEC)                       
*                                                                               
*   TEST                                                                        
         CLC   =C'IN2OUT2',QUESTOR                                              
         BNE   RANK1881                                                         
         MVC   P+1(26),=C'RESETTING ORIGINAL MISFLGS'                           
         GOTO1 REPORT              **TEST**                                     
RANK1881 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
RANK1920 EQU   *                                                                
         CLOSE RGWORK                                                           
*                                                                               
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO  9'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         EJECT                                                                  
* NOW RESORT RECORDS ON ORIGINAL KEYS WITH RANK POSITIONS IN PLACE *            
         SPACE 1                                                                
         OPEN  (RGWORK,INPUT)                                                   
         LA    R0,RANK2080                                                      
         STCM  R0,7,RGWORK+33      SET EOF ADDRESS                              
*                                                                               
         LA    RE,RGKEYLEN         SET KEYLENGTH IN SORT CARD                   
         CVD   RE,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  SORTCD2+15(3),DUB                                                
*                                                                               
         GOTO1 SORTER,DMCB,SORTCD2,RECCARD                                      
*                                                                               
RANK1960 GET   RGWORK,REC                                                       
*                                                                               
*   TEST                                                                        
         CLC   =C'IN2OUT2',QUESTOR                                              
         BNE   RANK1961                                                         
         MVC   P+1(04),=C'INX='    **TEST**                                     
         MVC   P+5(1),RPAGGTOT     **TEST**                                     
         MVC   P+06(108),REC       **TEST**                                     
         GOTO1 REPORT              **TEST**                                     
RANK1961 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         ZIC   RF,RPAGGTOT         AGGREGATE BASE REPORT:                       
         LTR   RF,RF                 TOTAL #ROWS NOT = ZERO?                    
         BZ    RANK2040            NO  - NOT AGGREGATE REPORT -                 
*                                  YES - OVERRIDE VALUE IF AGGREG               
*                                     OR AGGSPL RECORD                          
         LA    RF,1(RF)            TOTAL ROWS +1 FOR CONTROL                    
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                SET TO LAST POS, LAST ROW                    
         LA    RF,REC(RF)          ADD A(REC)                                   
         CLI   0(RF),X'00'         BYTE = 0?  AGGREGATE OR SPL                  
*                                     AS-RUN RECORD?                            
         BNE   RANK2000            NO - CONTINUE PROCESSING                     
*                                  YES - NEED TO CLEAR VALUE IN ROW             
         LH    RF,HALF             LOAD DISP(RANK ROW)                          
         LA    RF,REC(RF)          CALCULATE A(RANK ROW)                        
         XC    0(9,RF),0(RF)       CLEAR THE ROW                                
RANK2000 EQU   *                                                                
RANK2040 EQU   *                                                                
         GOTO1 SORTER,DMCB,=C'PUT',REC                                          
*                                                                               
*   TEST                                                                        
         CLC   =C'IN2OUT2',QUESTOR                                              
         BNE   RANK2041                                                         
         MVC   P+1(04),=C'OUX='    **TEST**                                     
         MVC   P+5(1),RPAGGTOT     **TEST**                                     
         MVC   P+06(108),REC       **TEST**                                     
         GOTO1 REPORT              **TEST**                                     
RANK2041 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         B     RANK1960                                                         
*                                                                               
RANK2080 DS    0H                  EOF                                          
         CLOSE RGWORK                                                           
*                                                                               
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO 10'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         OPEN  (RGWORK,OUTPUT)                                                  
*                                                                               
RANK2120 GOTO1 SORTER,DMCB,=C'GET'                                              
         ICM   RE,15,4(R1)                                                      
         BZ    RANK2160                                                         
         MVC   REC(RGRECLEN),0(RE)                                              
         PUT   RGWORK,REC                                                       
         B     RANK2120                                                         
*                                                                               
RANK2160 CLOSE RGWORK                                                           
*                                                                               
*   TEST                                                                        
**       MVC   P+1(06),=C'CLO 11'                                               
**       GOTO1 REPORT                                                           
*   TEST                                                                        
*                                                                               
         XIT1                                                                   
         EJECT                                                                  
RANKPCT  SR    R5,R5               PRESET RESULT ZERO                           
         ZIC   RE,RANKSPEC         GET COL 1                                    
         BCTR  RE,0                                                             
         SLL   RE,2                X 4                                          
         L     R1,REC+RGDTADSP(RE) GET VALUE                                    
         ZIC   RE,RANKSPEC+2       GET COL 2                                    
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         L     RF,REC+RGDTADSP(RE)                                              
         LTR   RF,RF               TEST 0                                       
         BZ    RANK0280                                                         
         M     R0,=F'2000'         X 1000 X 2                                   
         DR    R0,RF                                                            
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
         LR    R5,R1               R5 = RESULT                                  
         B     RANK0280                                                         
         LTORG                                                                  
         EJECT                                                                  
* EXPLODE REPORT SPECS FOR THIS REQUEST *                                       
         SPACE 1                                                                
         DS    0F                                                               
XRPT     NMOD1 0,*XRPT*                                                         
*                                                                               
         L     RC,0(R1)            RESET A(WORK SPACE)                          
         MVI   RPBRZFLG,X'00'      CLEAR BROWSER DATE REC FLAG                  
         L     RF,AQWORK                                                        
         USING QWKD,RF                                                          
*                                                                               
XR2      CLC   QWREQNUM,REC        MATCH REQUEST NUMBER                         
         BE    XR10                                                             
         ICM   RF,7,QWNEXT         POSITION TO CORRECT REQUEST                  
         BNZ   XR2                                                              
         SPACE 1                                                                
XR10     STCM  RF,7,THISQWK+1      SAVE QWORK ADDRESS                           
*                                                                               
         L     R6,QWSPECS          GET ADDRESS OF REPORT SPECS                  
         GOTO1 SETSPACE,DMCB,(RF)  SET OPTL SPACING FOR REQUEST                 
         DROP  RF                                                               
*                                                                               
XR20     EQU   *                                                                
         TM    0(R6),X'80'         TEST FOR DEFUNCT SPEC                        
         BO    XR26                                                             
         LA    RE,SPECTAB                                                       
*                                                                               
XR22     CLC   0(1,R6),0(RE)                                                    
         BE    XR24                                                             
         LA    RE,4(RE)                                                         
         CLI   0(RE),X'FF'                                                      
         BNE   XR22                                                             
         DC    H'0'                                                             
*                                                                               
XR24     ST    R6,SPECADDR         SAVE SPEC ADDRESS                            
         L     RF,0(RE)                                                         
         BASR  RE,RF               DO BALR FOR HELP IN DUMPS                    
*                                                                               
XRNEXT   L     R6,SPECADDR                                                      
*                                                                               
XR26     ZIC   R0,1(R6)            NEXT SPEC                                    
         AR    R6,R0                                                            
         CLI   0(R6),0                                                          
         BNE   XR20                                                             
XRPTEXIT EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
SPECTAB  DC    AL1(01),AL3(XRNEXT)                                              
         DC    AL1(02),AL3(SPEC02)                                              
         DC    AL1(06),AL3(XRNEXT) TOTDEF (IGNORE)                              
*                                                                               
         DC    AL1(07),AL3(SPEC07) PENDING                                      
         DC    AL1(08),AL3(SPEC08) COMMENT                                      
         DC    AL1(09),AL3(SPEC09) SPLITPND                                     
         DC    AL1(10),AL3(SPEC10) REPORT                                       
         DC    AL1(11),AL3(SPEC11) RPTCODE                                      
         DC    AL1(12),AL3(SPEC12) RPTNAME                                      
         DC    AL1(13),AL3(SPEC13) RPTRIGHT                                     
         DC    AL1(14),AL3(SPEC14) COPIES                                       
         DC    AL1(15),AL3(SPEC15) REMPRINT                                     
         DC    AL1(16),AL3(SPEC16) MONEY                                        
         DC    AL1(17),AL3(SPEC17) REMCOPY                                      
         DC    AL1(18),AL3(XRNEXT) ONLINE                                       
         DC    AL1(19),AL3(SPEC19) REPTYPE                                      
         DC    AL1(20),AL3(XRNEXT) RPTFILT                                      
         DC    AL1(21),AL3(SPEC21) RPTFLAGS                                     
*                                                                               
         DC    AL1(24),AL3(SPEC24) AGGBAS                                       
         DC    AL1(25),AL3(XRNEXT) AGGREG                                       
         DC    AL1(26),AL3(XRNEXT) RECAP                                        
         DC    AL1(27),AL3(XRNEXT) AGGSPL                                       
         DC    AL1(28),AL3(SPEC28) AGGTAB                                       
         DC    AL1(29),AL3(SPEC29) BUDPAS                                       
*                                                                               
         DC    AL1(30),AL3(SPEC30) ROW                                          
         DC    AL1(31),AL3(SPEC31) ROWNAME/CODE/BOTH                            
         DC    AL1(32),AL3(SPEC32) ROW EQU                                      
         DC    AL1(33),AL3(SPEC33) ROW RANK                                     
         DC    AL1(35),AL3(SPEC35) NOTOT                                        
         DC    AL1(36),AL3(XRNEXT) ROWFILT                                      
*                                                                               
         DC    AL1(40),AL3(SPEC40) COL                                          
         DC    AL1(41),AL3(SPEC41) COLNAME/CODE/BOTH                            
         DC    AL1(42),AL3(SPEC42) COL EQU                                      
         DC    AL1(43),AL3(SPEC43) COLCOMP                                      
         DC    AL1(44),AL3(SPEC44) CHUNK                                        
         DC    AL1(45),AL3(SPEC45) COLFOOT                                      
*                                                                               
         DC    AL1(51),AL3(SPEC51) TOTPRNT                                      
         DC    AL1(52),AL3(XRNEXT) TOTROW                                       
         DC    AL1(53),AL3(XRNEXT) TOTDIFF                                      
         DC    AL1(54),AL3(XRNEXT) TOTPCT                                       
         DC    AL1(55),AL3(XRNEXT) TOTSAME                                      
*                                                                               
         DC    AL1(60),AL3(XRNEXT) IF                                           
*                                                                               
SPECTABX DC    X'FF'                                                            
         EJECT                                                                  
*                                                                               
*   ALL RRG REPORT REQUESTS HAVE AT LEAST TWO CARDS.  THE SECOND CARD           
*     MAY CONTAIN AN OPTIONAL SPACING INDICATOR WHICH IS PASSED                 
*     THROUGH TO REPFILCON FOR PRINT SPACING.                                   
*                                                                               
DISPSPAC EQU   Q2SPACE-QREC2       DISP OF OPTL SPACE ON REQ CARD2              
*                                                                               
SETSPACE NTR1                                                                   
*                                                                               
         L     RF,0(R1)            A(CURRENT REQUEST)                           
         USING QWKD,RF                                                          
*                                                                               
         LA    RF,QWREQ2           SET A(REQUEST CARD 2)                        
*                                                                               
         DROP  RF                                                               
*                                                                               
         NI    DISPSPAC(RF),X'0F'  TURN OFF ZONE BITS                           
         OC    DISPSPAC(1,RF),DISPSPAC(RF)    WAS SPACING ENTERED?              
         BNZ   SETS0020            YES                                          
SETS0010 EQU   *                                                                
         MVI   DISPSPAC(RF),1      NO  - SET SPACING TO 1                       
SETS0020 EQU   *                                                                
         MVC   RCSPACE,DISPSPAC(RF) MOVE BINARY FIELD TO STORE                  
         CLI   RCSPACE,3                                                        
         BH    SETS0010                                                         
         B     XRPTEXIT                                                         
         EJECT                                                                  
         USING RPSPECD,R2                                                       
         SPACE 1                                                                
SPEC02   DS    0H                  PRINT SWITCH                                 
         CLI   2(R6),1             ON                                           
         BE    XRNEXT                                                           
         MVI   REQPRNT,C'N'                                                     
         CLI   2(R6),0             OFF                                          
         BE    XRPTEXIT                                                         
         MVI   REQPRNT,C'O'                                                     
         CLI   2(R6),2             ONLINE                                       
         BE    XRNEXT                                                           
         MVI   REQPRNT,C'Y'                                                     
         B     XRNEXT                                                           
*                                                                               
SPEC07   DS    0H                                                               
         OI    RPFLAGS,X'01'       SET 'PENDING' REPORT FLAG                    
         B     XRNEXT                                                           
*                                                                               
SPEC08   DS    0H                                                               
         OI    RPFLAGS,X'02'       SET 'COMMENT' REPORT FLAG                    
         B     XRNEXT                                                           
*                                                                               
SPEC09   DS    0H                                                               
         OI    RPFLAGS,X'04'       SET 'SPLITPND' REPORT FLAG                   
         B     XRNEXT                                                           
*                                                                               
SPEC10   DS    0H                  REPORT CODE                                  
         ZIC   R2,2(R6)            GET REPORT NUM                               
         BCTR  R2,0                                                             
         MH    R2,=Y(RPSPECX-RPSPECD) X BUFFER LENGTH                           
         A     R2,=A(RPDATA)       POINT TO BUFFER                              
         B     XRNEXT                                                           
*                                                                               
SPEC11   DS    0H                  RPTCODE                                      
         MVC   RPRPTCD,2(R6)                                                    
         B     XRNEXT                                                           
*                                                                               
SPEC12   DS    0H                  RPTNAME                                      
         ST    R6,RPRPTNAM                                                      
         B     XRNEXT                                                           
*                                                                               
SPEC13   DS    0H                  RPTRIGHT                                     
         OC    RPRPTRGT,RPRPTRGT   TEST FIRST ADDRESS SAVED                     
         BNZ   XRNEXT                                                           
         ST    R6,RPRPTRGT                                                      
         B     XRNEXT                                                           
*                                                                               
SPEC14   DS    0H                  COPIES                                       
         MVC   RPCOPIES,2(R6)                                                   
         B     XRNEXT                                                           
*                                                                               
SPEC15   ST    R6,RPREMPRT         REMPRINT                                     
         B     XRNEXT                                                           
*                                                                               
SPEC16   MVC   RPMONEY,2(R6)       MONEY                                        
         B     XRNEXT                                                           
*                                                                               
SPEC17   OC    RPREMCPY,RPREMCPY   REMCOPY                                      
         BNZ   XRNEXT                                                           
         ST    R6,RPREMCPY                                                      
         MVI   RPREMCPY,0                                                       
         B     XRNEXT                                                           
*                                                                               
SPEC19   MVC   RPREPTYP,2(R6)      REPORT TYPE                                  
         B     XRNEXT                                                           
*                                                                               
SPEC21   EQU   *                                                                
         XC    RPMISFLG,RPMISFLG   CLEAR AREA                                   
         ZIC   RF,1(R6)            TAKE ELEMENT LENGTH                          
         LA    RE,3                MINUS CONTROL + 1 FOR EX                     
         SR    RF,RE                                                            
         EX    RF,SPEC21A          MOVE BY LENGTH                               
         B     XRNEXT                                                           
SPEC21A  MVC   RPMISFLG(0),2(R6)   MISCELLANEOUS FLAGS                          
*                                                                               
SPEC24   MVC   RPAGGBAS(2),3(R6)   AGG #ROWS TO COMPARE, TOTAL ROWS             
         B     XRNEXT                                                           
*                                                                               
SPEC28   MVC   RPAGGTAB(1),3(R6)   AGG #ROWS TO COMPARE, # ROWS OFF-            
*                                     SET TO INSERT ROW                         
         B     XRNEXT                                                           
*                                                                               
SPEC29   MVC   RPBUDPAS(1),3(R6)   SET BUDPAS SPEC FLAG 'ON'                    
         B     XRNEXT                                                           
*                                                                               
SPEC30   DS    0H                  ROWCODE                                      
         CLI   2(R6),X'01'         1ST ROW OF SPEC OR RECAP?                    
         BNE   SPEC30D             NO                                           
         XC    COSPEC#(2),COSPEC#  YES - INITIALIZE STORAGE                     
SPEC30D  EQU   *                                                                
         CLI   3(R6),40            'COMPANY' DATA CODE                          
         BNE   SPEC30E             NO                                           
         L     RF,VXADDR                                                        
         USING VXADDRD,RF                                                       
         L     RF,VXSREP           A(MASTER/SUBSIDIARY TABLE)                   
         USING RSREPD,RF                                                        
         CLI   MASTREP,1           MASTER REP?                                  
         BE    SPEC30E             YES                                          
*                                                                               
         DROP  RF                                                               
*                                                                               
         MVC   COSPEC#,2(R6)       NO  - SAVE COMPANY ROW SPEC #                
         MVC   COSPEC#2,2(R6)      SET SKIP FLAG ALSO                           
*                                                                               
*   IF THE COMPANY CODE IS TO BE DROPPED, THE FOLLOWING TYPE 31                 
*     ENTRY MUST ALSO BE DROPPED.  THE FLAG IS SET TO SIGNAL.                   
*                                                                               
*   IF THE REPORT IS AN 'AGGREGATE', THE TOTAL NUMBER OF ROWS MUST              
*     BE DECREASED BY 1.  A TEST TO DETERMINE WHETHER THE COMPANY               
*     ROW BEING DROPPED IS WITHIN THE ROWS BEING COMPARED MUST BE               
*     DONE.  IF IT IS, THE NUMBER OF ROWS TO COMPARE MUST BE                    
*     DECREASED BY 1 ALSO.                                                      
*                                                                               
         OC    RPAGGBAS(2),RPAGGBAS AGGREGATE REPORT?                           
         BZ    XRNEXT              NO                                           
         ZIC   RF,RPAGGTOT         YES - TOTAL # ROWS                           
         BCTR  RF,0                   MINUS 1                                   
         STC   RF,RPAGGTOT         PUT IT BACK                                  
         CLC   COSPEC#,RPAGGBAS    IS COMPANY ROW WITHIN                        
*                                     ROWS BEING COMPARED?                      
         BH    XRNEXT              NO                                           
         ZIC   RF,RPAGGBAS         YES - # ROWS COMPARED                        
         BCTR  RF,0                   MINUS 1                                   
         STC   RF,RPAGGBAS         PUT IT BACK                                  
         B     XRNEXT              SKIP THIS CODE                               
SPEC30E  EQU   *                                                                
         XC    COSPEC#2,COSPEC#2   RESET SKIP FLAG                              
         ZIC   RE,2(R6)            GET ROW NUMBER                               
         OC    COSPEC#,COSPEC#     'COMPANY' ROW SPEC ELIMINATED?               
         BZ    SPEC30F             NO  - DON'T ADJUST ROW #                     
         ZIC   RF,COSPEC#          YES - IS ROW AFTER 'COMPANY' ROW?            
         CR    RE,RF                                                            
         BL    SPEC30F             NO  - DON'T ADJUST ROW #                     
         BCTR  RE,0                YES - DECREASE ROW #                         
SPEC30F  EQU   *                                                                
         STC   RE,RPROWS                                                        
         CLI   3(R6),32            STAMKT ROW?                                  
         BNE   *+8                 NO                                           
         STC   RE,RPSTMKTR         YES - SAVE STAMKT ROW NUMBER                 
         CLI   3(R6),2             STATION ROW?                                 
         BNE   *+8                 NO                                           
         STC   RE,RPSPLSTA         YES - SAVE ROW NUMBER FOR SPL                
         LA    R1,RPADVCD                                                       
         CLI   3(R6),8             ADV                                          
         BE    SPEC30H                                                          
         LA    R1,RPAGYCD                                                       
         CLI   3(R6),10            AGY                                          
         BE    SPEC30H                                                          
         LA    R1,RPADVNM                                                       
         CLI   3(R6),27            ADVNAME                                      
         BE    SPEC30H                                                          
         LA    R1,RPAGYNM                                                       
         CLI   3(R6),28            AGYNAME                                      
         BNE   SPEC30J                                                          
*                                                                               
SPEC30H  STC   RE,0(R1)            ROW NUMBER                                   
         LR    RF,RE                                                            
         MH    RF,=Y(RGROWSZ)                                                   
         LA    RF,REC(RF)                                                       
         STCM  RF,7,1(R1)          RECORD ROW POSITION                          
*                                                                               
SPEC30J  SLL   RE,2                X 4                                          
         STH   RE,ROWDSPL          SAVE ROW DISPLACEMENT (0 REL)                
         LA    RE,RPROWDEF(RE)                                                  
         ST    R6,0(RE)            SAVE ADDRESS OF ROWDEF SPEC                  
         B     XRNEXT                                                           
*                                                                               
SPEC31   DS    0H                  ROWNAME/CODE/BOTH                            
         OC    COSPEC#2,COSPEC#2   SKIP FLAG SET?                               
         BNZ   XRNEXT              YES                                          
         LH    RE,ROWDSPL                                                       
         ST    R6,RPROWNAM(RE)     SAVE ADDRESS OF ROWNAME SPEC                 
         B     XRNEXT                                                           
*                                                                               
SPEC32   DS    0H                  ROW EQU                                      
         ZIC   RE,2(R6)            GET EQUATED REPORT NUM                       
         BCTR  RE,0                                                             
         MH    RE,=Y(RPSPECX-RPSPECD)        X BUFFER LENGTH                    
         A     RE,=A(RPDATA)                 POINT TO REPORT                    
         MVC   RPROWS,RPROWS-RPSPECD(RE)     SET HIGH ROW                       
         MVC   RPROWDEF,RPROWDEF-RPSPECD(RE) MOVE ROW DATA                      
         MVC   RPROWNAM,RPROWNAM-RPSPECD(RE) MOVE ROW DATA                      
         B     XRNEXT                                                           
*                                                                               
SPEC33   DS    0H                  ROW RANK                                     
         LA    R1,RPRANK1          SET A(HI-ORDER RANK)                         
         LA    RF,RPRKCOL1         SET A(FLAG COLUMN)                           
         OC    0(4,R1),0(R1)       ALREADY ENTERED?                             
         BZ    *+12                NO                                           
         LA    R1,RPRANK2          YES - SET A(SECONDARY RANK)                  
         LA    RF,RPRKCOL2                                                      
         ST    R6,0(R1)            SAVE A(33 SPEC)                              
         MVC   0(1,R1),RPROWS      SAVE ROW NUMBER                              
*                                                                               
****>>>  CLI   3(R6),0             TEST FOR CONDITIONAL RANK                    
****>>>  BE    XRNEXT                                                           
*                                                                               
         MVC   0(1,RF),2(R6)       SAVE RANK COL FOR MARKING                    
         B     XRNEXT                                                           
*                                                                               
SPEC35   DS    0H                  NOTOTS                                       
         LH    RE,ROWDSPL                                                       
         ST    R6,RPNOTOTS(RE)     SAVE ADDRESS OF NOTOT SPEC                   
         B     XRNEXT                                                           
*                                                                               
SPEC40   DS    0H                  COLUMN                                       
         ZIC   RE,2(R6)            GET COL NUMBER                               
         STC   RE,RPCOLS                                                        
         SLL   RE,2                X 4                                          
         STH   RE,COLDSPL          SAVE COL DISPLACEMENT                        
         ST    R6,RPCOLDEF(RE)     SAVE SPEC ADDRESS                            
         CLI   6(R6),SPL$$VAL      SPL DOLLAR VALUE COLUMN?                     
         BE    SPEC4020            NO                                           
         CLI   6(R6),SPLM$VAL      SPL MKT DOLLAR VALUE COLUMN?                 
         BE    SPEC4020            NO                                           
         CLI   6(R6),SPLD$VAL      GROSS SPL DOLLAR VALUE COLUMN?               
         BE    SPEC4020            NO                                           
         CLI   6(R6),SPLG$VAL      GROSS SPL MKT DOLLAR VALUE COLUMN?           
         BE    SPEC4020            NO                                           
         LA    RF,RPCUREST         SET A(CURRENT ESTIMATE DISPLACEMENT)         
         CLI   6(R6),21            CURRENT ESTIMATE COLUMN?                     
         BE    SPEC4010            YES                                          
         LA    RF,RPCURACT         SET A(CURRENT ACTUAL   DISPLACEMENT)         
         CLI   6(R6),23            CURRENT ACTUAL COLUMN?                       
         BE    SPEC4010            YES                                          
         LA    RF,RPCURBOK         SET A(CURRENT BOOKED   DISPLACEMENT)         
         CLI   6(R6),32            CURRENT BOOKED COLUMN?                       
         BE    SPEC4010            YES                                          
         LA    RF,RPCURBIL         SET A(CURRENT BILLED   DISPLACEMENT)         
         CLI   6(R6),38            CURRENT BOOKED COLUMN?                       
         BE    SPEC4010            YES                                          
         LA    RF,RPBUDGET         SET A(BUDGET COLUMN DISPLACEMENT)            
         CLI   6(R6),25            BUDGET COLUMN?                               
         BE    SPEC4010            YES                                          
         LA    RF,RPBCUME          SET A(SAVE BILLING CUME COL ADDR)            
         CLI   6(R6),60            CURR BILLING CUME COL?                       
         BE    SPEC4010            YES                                          
         LA    RF,RPPCCUME         SET A(SAVE BILLING CUME % COL ADDR)          
         CLI   6(R6),61            CURR BILLING % CUME COL?                     
         BE    SPEC4010            YES                                          
*                                                                               
*   NOTE:  AS IT IS UNLIKELY THAT A REPORT WILL BE SET UP WITH                  
*        BOTH REGULAR AND TRUE FORECAST, THE SAME FLAG IS USED                  
*        FOR REG/TRUE-CURR/PRIOR.  THERE IS NO DIFFERENTIATION                  
*        FOR CURR/PRIOR:  IF ONE HAS BEEN ENTERED EXPLICITLY AS                 
*        $0, AND THE REPORT HAS BOTH CURRENT AND PRIOR, BOTH WILL               
*        DISPLAY '$0'.                                                          
*                                                                               
         CLI   6(R6),44            CURR FORECAST COL?                           
         BE    SPEC4005            YES                                          
         CLI   6(R6),67            TRUE CURR FORECAST COL?                      
         BE    SPEC4005            YES                                          
         CLI   6(R6),45            CURR FORECAST COL?                           
         BE    SPEC4005            YES                                          
         CLI   6(R6),68            TRUE CURR FORECAST COL?                      
         BNE   XRNEXT              NO                                           
SPEC4005 EQU   *                                                                
         MVI   RPFRCACT,C'Y'       SET FORECAST ACTIVE TO YES                   
         B     XRNEXT              NO                                           
SPEC4010 EQU   *                                                                
         LA    R1,4                                                             
         SR    RE,R1               SET ZERO RELATIVE DISPLACEMENT               
         STH   RE,0(RF)            SAVE CUME COLUMN DISPLACEMENT                
         B     XRNEXT                                                           
SPEC4020 EQU   *                                                                
         MVI   RPSPLACT,C'Y'       SET 'SPL COLUMNS PRESENT' TO YES             
         B     XRNEXT                                                           
*                                                                               
SPL$$VAL EQU   79                  SPL $$ COLUMN NUMBER                         
SPLM$VAL EQU   80                  SLP MKT $$ COLUMN NUMBER                     
SPLD$VAL EQU   81                  GROSS SPL $$ COLUMN NUMBER                   
SPLG$VAL EQU   82                  GROSS SPL MKT $$ COLUMN NUMBER               
*                                                                               
SPEC41   DS    0H                  COLNAME                                      
         LH    RE,COLDSPL                                                       
         LA    RE,RPCOLNAM(RE)                                                  
         STCM  R6,7,1(RE)          SAVE ADDRESS OF COLNAME SPEC                 
         CLC   RPCOLS,RPRKCOL1     TEST FOR RANKING ON THIS COL                 
         BE    SPEC41A                                                          
         CLC   RPCOLS,RPRKCOL2                                                  
         BNE   XRNEXT                                                           
*                                                                               
SPEC41A  ZIC   RE,1(R6)                                                         
         AR    RE,R6                                                            
         BCTR  RE,0                                                             
         CLI   0(RE),C' '          IF LAST CHAR OF COL TITLE IS SPACE,          
         BNE   XRNEXT               MAKE IT A * (TO MARK THE RANK COL)          
         TM    RPMISFLG,X'02'      DON'T DISPLAY '*'?                           
         BO    XRNEXT              RIGHT - DON'T!                               
         MVI   0(RE),C'*'                                                       
         B     XRNEXT                                                           
*                                                                               
SPEC42   DS    0H                  COL EQU                                      
         ZIC   RE,2(R6)            GET EQUATED REPORT NUM                       
         BCTR  RE,0                                                             
         MH    RE,=Y(RPSPECX-RPSPECD)        X BUFFER LENGTH                    
         A     RE,=A(RPDATA)                 POINT TO REPORT                    
         MVC   RPCOLS,RPCOLS-RPSPECD(RE)     SET HIGH COLUMN                    
         MVC   RPCOLDEF,RPCOLDEF-RPSPECD(RE) MOVE COLDEF DATA                   
         MVC   RPCOLNAM,RPCOLNAM-RPSPECD(RE) MOVE COLNAM DATA                   
         MVC   RPCOLCHK,RPCOLCHK-RPSPECD(RE) MOVE COLCHK DATA                   
         MVC   RPCOLCOM,RPCOLCOM-RPSPECD(RE) MOVE COLCOM DATA                   
         OC    RPCOLFUT,RPCOLFUT             TEST HAD COLFUT ALREADY            
         BNZ   *+10                          YES - DO NOT COPY                  
         MVC   RPCOLFUT,RPCOLFUT-RPSPECD(RE) MOVE COLFUT DATA                   
         B     XRNEXT                                                           
         EJECT                                                                  
SPEC43   DS    0H                  COLCOMP                                      
         LH    RE,COLDSPL                                                       
         LA    RE,RPCOLCOM(RE)                                                  
         STCM  R6,7,1(RE)          SAVE SPEC ADDRESS                            
         B     XRNEXT                                                           
*                                                                               
SPEC44   DS    0H                  CHUNK                                        
         OC    RPCOLCHK,RPCOLCHK                                                
         BNZ   *+8                                                              
         ST    R6,RPCOLCHK         SAVE ADDRESS OF FIRST COLCHUNK SPEC          
         B     XRNEXT                                                           
*                                                                               
SPEC45   OC    RPCOLFUT,RPCOLFUT                                                
         BNZ   *+8                                                              
         ST    R6,RPCOLFUT         SAVE ADDRESS OF FIRST COLFOOT SPEC           
         B     XRNEXT                                                           
*                                                                               
SPEC51   DS    0H                  TOTPRNT                                      
         CLI   RUNMODE,C'S'        IGNORE FOR SINGLE RUN MODE                   
         BE    XRNEXT                                                           
         ZIC   RE,2(R6)            GET ROW NUMBER                               
         SLL   RE,2                                                             
         ST    R6,RPTOTPRT(RE)                                                  
         B     XRNEXT                                                           
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*******************************************************************             
*                                                                 *             
* SUBROUTINE TO POST RECORD TO CORRECT MONTH FOR EACH ROW         *             
*                                                                 *             
* FORMAT OF TOTAL AREA IS AS FOLLOWS                              *             
*                                                                 *             
*                   +00  +04  +08   ...                           *             
* ROW 1 . M00 PRI  .COL1.COL2.COL3. ... .COL(RGCOLMAX+8)          *             
*       . M01 JAN  .    .    .    .     .             . LENGTH=   *             
*       . M02 FEB  .    .    .    .     .             . (RGCOLMAX *             
*       . ..       .    .    .    .     .             .  + 8)     *             
*       . M12 DEC  .    .    .    .     .             .  * 4      *             
*       . M13 TOT  .    .    .    .     .             .  * 18     *             
*       . Q1  TOT  .    .    .    .     .             .           *             
*       . Q2  TOT  .    .    .    .     .             . LAST 8    *             
*       . Q3  TOT  .    .    .    .     .             . COLS ARE  *             
*       . Q4  TOT  .    .    .    .     .             . BASES FOR *             
* ROW 2 .          .    .    .    .     .             . SPL CALCS *             
*       .          .    .    .    .     .             .           *             
* ...   .          .    .    .    .     .             .           *             
*       .          .    .    .    .     .             .           *             
*                                                                 *             
*                                                                 *             
* ROW N   WHERE N = RGROWMAX-1 SINCE NO ROW FOR MONTHLY SPEC      *             
*                                                                 *             
*  EACH ROW'S SPACE IS DEFINED AS:                                *             
*    RGCOLMAX (16+10(SPLS)) * RGCOLSZ (4) * (12 MONTHS + 1 PRIOR  *             
*    + 1 TOTAL + 4 QTR TOTALS = 18)  =  26 * 4 * 18 = 1872.       *             
*                                                                 *             
*  THIS SPACE IS FIXED FOR EACH ROW.  THERE ARE RGROWMAX (SEE EQU)*             
*    OCCURRENCES IN THE WORKAREA.                                 *             
*                                                                 *             
*******************************************************************             
         EJECT                                                                  
         DS    0F                                                               
POST     NMOD1 0,*POST*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         MVI   BYTE,1              SET INITIAL  ROW NUMBER                      
         TM    REC+RMISCDSP,X'40'  COMPANY+OFFICE BUDGET REC?                   
         BNO   POST0010            NO                                           
         MVI   BYTE,2              SET INITIAL ROW TO 2ND                       
POST0010 EQU   *                                                                
         ZIC   RE,BYTE                                                          
*                                                                               
*   ROW# * ROW SIZE = DISPLACEMENT INTO 'DATA CARD' FOR ROW                     
*      INFORMATION.  IF FIELD IS ZERO, NO INFO, POST DONE.                      
*                                                                               
POST0020 EQU   *                                                                
         TM    REC+RMISCDSP,X'80'  COMPANY BUDGET REC?                          
         BNO   POST0022            NO                                           
*                                                                               
*   TEST POST                                                                   
*        MVC   P+1(05),=C'POST='                                                
*        MVC   P+6(128),REC                                                     
*        GOTO1 REPORT                                                           
*   TEST POST END                                                               
*                                                                               
         TM    REC+RMISCDSP,X'40'  COMPANY+OFFICE BUDGET REC?                   
         BO    POST0022            YES - PASS IT THROUGH                        
         CLI   BYTE,1              NO  - COMPANY BUDGET:  POST IT               
*                                     ONLY AT HIGHEST ROW                       
         BH    POST0360                                                         
POST0022 EQU   *                                                                
         MH    RE,=Y(RGROWSZ)                                                   
         LA    RE,REC(RE)             POINT TO ROW DATA                         
         OC    0(RGROWSZ-1,RE),0(RE)  TEST ROW VALUE = 0                        
         BZ    POST0360               YES - DO NOT POST                         
*                                                                               
*   MKTBYTE INDICATES WHETHER MARKET TOTALS ARE TO BE POSTED.  IF               
*      THE RUN IS A 'COMBO' RUN, MARKET TOTALS AND COMBO TOTALS                 
*      ARE TO BE POSTED AT ALL LEVELS, NOT ONLY STATION LEVEL.                  
*                                                                               
         L     R1,THISQWK          A(THIS REQUEST WORK AREA)                    
         USING QWKD,R1                                                          
         CLI   QWCOMBO,C'Y'        COMBO REP/STAMKT IN HDG?                     
         BE    POST0060            YES - POST EVERYTHING                        
*                                                                               
         DROP  R1                                                               
*                                                                               
         TM    MKTBYTE,X'60'       MARKET TOTALS/> 1 STATION?                   
         BO    POST0040            YES - POST ONLY AT STATION LEVEL             
         TM    MKTBYTE,X'06'       NO  - COMBO TOTALS/> 1 STATION?              
         BNO   POST0060            NO  - POST AT ALL LEVELS                     
POST0040 EQU   *                                                                
         CLC   BYTE,RPSTMKTR       ARE WE AT STATION LEVEL                      
         BNE   POST0340                                                         
*                                                                               
POST0060 EQU   *                                                                
         CLI   OTHRNAME,C'Y'       POSTING A 'RANKMAX EXCEEDED' ROW?            
         BNE   POST0070            NO                                           
         ZIC   RE,RPROWS           YES - ACCUMULATE LOWEST ROW                  
*                                  FOR HIGHER ROWS, DON'T POST                  
*                                     TO SEE IF ALREADY ROLLED IN               
         BCTR  RE,0                NUMBER OF ROWS, - 1                          
         ZIC   R4,BYTE             ROW IN PROGRESS                              
         CR    RE,R4               LOWEST ROW IN PROGRESS?                      
         BNE   POST0340            NO  - DON'T ACCUMULATE                       
POST0070 EQU   *                                                                
         ZIC   RE,BYTE             ROW NUMBER IN PROGRESS                       
         BCTR  RE,0                SUBTRACT 1:  THIS MAKES IT                   
*                                     ZERO RELATIVE, WHICH ARE THE              
*                                     TOTALS FOR THE NEXT LEVEL ROW             
         MH    RE,=Y(TOTLEN)       POSITION TO TOTS FOR THIS ROW                
         A     RE,ATOTALS          A(TOTALS ARRAY)                              
*                                                                               
         ZIC   R1,RPROWS           GET HI ROW NUMBER (MONTH SPEC)               
         MH    R1,=Y(RGROWSZ)         * WIDTH OF EACH ROW                       
         LA    R1,REC(R1)          POINT TO ROW IN RECORD (0 REL)               
*                                                                               
*   HIGH ROW IS ALWAYS DATED (MONTH, QTR, YEARLY)                               
*                                                                               
         ZIC   RF,1(R1)            GET MONTH NUMBER: R1 = YYMM                  
         LTR   RF,RF               PRIOR YEAR FIGURES: MONTH = ZERO             
         BZ    POST0080            YES - DON'T ADJUST AT ALL                    
         L     R1,THISQWK                                                       
         USING QWKD,R1                                                          
         SH    RF,QWMONADJ         ADJUST THE MONTH IF NECESSARY                
         BP    *+8                                                              
         LA    RF,12(RF)                                                        
POST0080 EQU   *                                                                
         MH    RF,=Y(TOTROWLN)     * LENGTH OF ROW: #COLS * 4                   
         AR    RF,RE               POINT TO BKTS FOR THIS ROW/MONTH             
*                                                                               
         DROP  R1                                                               
         EJECT                                                                  
         SR    R7,R7                                                            
         LA    R6,RGDTADSP+REC     POINT TO FIRST DATA COL IN REC               
         LA    R0,RGCOLMAX                                                      
*                                                                               
POST0100 EQU   *                                                                
         ST    RF,SVRFREG          SAVE RF VALUE: SPL RTNS WILL                 
*                                     STEP ON IT                                
*   TEST                                                                        
*        MVC   P+1(06),=C'ARRAY:'                                               
*        MVC   P+10(104),0(RF)                                                  
*        GOTO1 REPORT                                                           
*        L     RF,SVRFREG          RESET RF                                     
*   TEST END                                                                    
*                                                                               
         L     R3,RPCOLDEF+4(R7)   POINT TO COL SPEC                            
         CLI   6(R3),43            'SHARE GOAL' COLUMN?                         
         BNE   POST0120            NO  -                                        
         ZIC   R3,RPROWS           YES - ONLY ACCUMULATE LOWEST ROW             
         BCTR  R3,0                NUMBER OF ROWS, - 1                          
         ZIC   R4,BYTE             ROW IN PROGRESS                              
         CR    R3,R4               LOWEST ROW IN PROGRESS?                      
         BNE   POST0320            NO  - DON'T ACCUMULATE                       
         B     POST0300                                                         
POST0120 EQU   *                                                                
         CLI   6(R3),41            'FORCE ROW' COLUMN?                          
         BNE   POST0140            NO  -                                        
         ZIC   R3,RPROWS           YES - ACCUMULATE LOWEST ROW                  
*                                  FOR HIGHER ROWS, CHECK COUNT                 
*                                     TO SEE IF ALREADY ROLLED IN               
         BCTR  R3,0                NUMBER OF ROWS, - 1                          
         ZIC   R4,BYTE             ROW IN PROGRESS                              
         CR    R3,R4               LOWEST ROW IN PROGRESS?                      
         BE    POST0300            YES - ACCUMULATE                             
         CLI   AGGCOUNT,1          NO  - ALREADY TOTALLED?                      
         BE    POST0320            YES - DON'T COUNT AGAIN                      
         B     POST0300            NO  - COUNT IT                               
POST0140 EQU   *                                                                
         CLI   6(R3),70            'FORCE/REP' COLUMN?                          
         BNE   POST0160            NO  -                                        
         ZIC   R3,RPROWS           YES - REPLACE LOWEST ROW                     
*                                     DON'T ACCUMULATE AGAIN                    
*                                  FOR HIGHER ROWS, CHECK COUNT                 
*                                     TO SEE IF ALREADY ROLLED IN               
         BCTR  R3,0                NUMBER OF ROWS, - 1                          
         ZIC   R4,BYTE             ROW IN PROGRESS                              
         CR    R3,R4               LOWEST ROW IN PROGRESS?                      
         BNE   POST0150            NO  - CHECK HIGHER ROW                       
         L     RE,0(R7,R6)         YES - R6=COL DATA + R7=COL #                 
*                                                                               
         ST    RE,0(R7,RF)         STORE VALUE DIRECTLY:  DON'T ACCUM           
         B     POST0320                                                         
POST0150 EQU   *                                                                
         CLI   AGGCOUNT,1          NO  - ALREADY TOTALLED?                      
         BE    POST0320            YES - DON'T COUNT AGAIN                      
         B     POST0300            NO  - COUNT IT                               
POST0160 EQU   *                                                                
         CLI   6(R3),52            SPL AS-RUN CURRENT COLUMN?                   
         BE    POST0180            YES -                                        
         CLI   6(R3),53            SPL AS-RUN PRIOR   COLUMN?                   
         BE    POST0180            YES -                                        
         CLI   6(R3),62            SPL AS-RUN THIS WEEK COLUMN?                 
         BE    POST0180            YES -                                        
         CLI   6(R3),76            SPL AS-RUN THIS WK LAST YR COLUMN?           
         BE    POST0180            YES -                                        
         CLI   6(R3),63            SPL AS-RUN ESTIMATE COLUMN?                  
         BNE   POST0300            NO  - POST COLUMN                            
POST0180 EQU   *                                                                
*                                  SPL COLUMNS:                                 
         ZIC   RF,RPROWS           ACCUMULATE LOWEST ROW                        
*                                  FOR HIGHER ROWS, CHECK COUNT                 
*                                     TO SEE IF ALREADY ROLLED IN               
         BCTR  RF,0                NUMBER OF ROWS, - 1                          
         ZIC   R4,BYTE             ROW IN PROGRESS                              
         CR    RF,R4               LOWEST ROW IN PROGRESS?                      
         BE    POST0200            YES - ACCUMULATE                             
         CLI   SPLCOUNT,1          NO  - ALREADY TOTALLED?                      
         BE    POST0320            YES - DON'T COUNT AGAIN                      
         L     RF,SVRFREG          RESET RF VALUE                               
         B     POST0200            NO  - COUNT IT                               
POST0200 EQU   *                                                                
         CLI   6(R3),52            SPL AS-RUN CURRENT?                          
         BNE   POST0220            NO                                           
         BAS   RE,POSCCALC         YES - SET COMPONENTS INTO ARRAY              
         B     POST0320                                                         
POST0220 EQU   *                                                                
         CLI   6(R3),53            SPL AS-RUN PRIOR?                            
         BNE   POST0240            NO                                           
         BAS   RE,POSPCALC         YES - SET COMPONENTS INTO ARRAY              
         B     POST0320                                                         
POST0240 EQU   *                                                                
         CLI   6(R3),62            SPL AS-RUN THIS WEEK?                        
         BNE   POST0260            NO                                           
         BAS   RE,POSTCALC         YES - SET COMPONENTS INTO ARRAY              
         B     POST0320                                                         
POST0260 EQU   *                                                                
         CLI   6(R3),63            SPL AS-RUN ESTIMATED?                        
         BNE   POST0280            NO                                           
         BAS   RE,POSECALC         YES - SET COMPONENTS INTO ARRAY              
         B     POST0320                                                         
POST0280 EQU   *                                                                
         CLI   6(R3),76            SPL AS-RUN THIS WEEK LAST YEAR?              
         BNE   POST0300            NO                                           
         BAS   RE,POSLCALC         YES - SET COMPONENTS INTO ARRAY              
         B     POST0320                                                         
POST0300 EQU   *                                                                
         L     RE,0(R7,R6)         R6=COL DATA + R7=COL #                       
*                                                                               
         A     RE,0(R7,RF)         RF=ROW/MONTH IN TABLE + R7=COL #             
         ST    RE,0(R7,RF)         STORE IT BACK                                
POST0320 EQU   *                                                                
         L     RF,SVRFREG          RESET RF VALUE                               
*                                     IN CASE SPL RTN CALLED                    
         LA    R7,4(R7)            CYCLE THROUGH ALL COLUMNS                    
         BCT   R0,POST0100                                                      
*                                                                               
POST0340 EQU   *                                                                
         ZIC   RE,BYTE             NEXT ROW NUMBER                              
         LA    RE,1(RE)                                                         
         STC   RE,BYTE                                                          
         CLC   BYTE,RPROWS         COMPARE TO MAX ROW COUNT                     
         BL    POST0020            STOP AT MAX ROW - 1                          
*                                                                               
POST0360 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   SPL AS-RUN COLUMN HANDLING:  WHEN THE DETAIL IS TO BE POSTED,               
*    THE SPL AS-RUN DATA MERGE HAS INSERTED THE ADDRESS OF THE                  
*    SPL COMPONENTS INTO THE COLUMN.  THE POST ROUTINE ACCESSES                 
*    THAT ADDRESS, RETRIEVES THE TWO COMPONENTS, AND INSERTS THEM               
*    INTO THE ROW/COLUMN ARRAY.  AT THE TIME THE ROW IS PRINTED,                
*    THE CALCULATION FOR THE COLUMN IS DONE.                                    
*                                                                               
POSCCALC NTR1                                                                   
         L     R3,SVRFREG          RESET A(ARRAY)                               
         LA    R3,TOTRSPLC(R3)     DISPLACE TO SPL AS-RUN CURRENT               
*                                                                               
*   START TEST                                                                  
*        MVC   P(10),=C'SVRFREG:  '                                             
*        GOTO1 HEXOUT,DMCB,SVRFREG,P+15,4,=C'TOG'                               
*        EDIT  (4,0(R3)),(10,P+24)                                              
*        EDIT  (4,4(R3)),(10,P+36)                                              
*        GOTO1 REPORT                                                           
*   END   TEST                                                                  
*                                                                               
         B     POSTSPLS                                                         
POSPCALC NTR1                                                                   
         L     R3,SVRFREG          RESET A(ARRAY)                               
         LA    R3,TOTRSPLP(R3)     DISPLACE TO SPL AS-RUN PRIOR                 
         B     POSTSPLS                                                         
POSTCALC NTR1                                                                   
         L     R3,SVRFREG          RESET A(ARRAY)                               
         LA    R3,TOTRSPLT(R3)     DISPLACE TO SPL AS-RUN THIS WEEK             
         B     POSTSPLS                                                         
POSECALC NTR1                                                                   
         L     R3,SVRFREG          RESET A(ARRAY)                               
         LA    R3,TOTRSPLE(R3)     DISPLACE TO SPL AS-RUN ESTIMATED             
         B     POSTSPLS                                                         
POSLCALC NTR1                                                                   
         L     R3,SVRFREG          RESET A(ARRAY)                               
         LA    R3,TOTRSPLL(R3)     DISPL TO SPL AS-RUN THS WK LST YR            
         B     POSTSPLS                                                         
POSTSPLS EQU   *                                                                
         LA    RF,REC+RGROWSZ      CHECK FOR EOF RECORD                         
         CLC   0(8,RF),XFF         ALL 'X'FF' = EOF RECORD                      
         BE    POSSEXIT            YES - DON'T DO ANYTHING                      
         L     R2,0(R7,R6)         GET A(SPL COMPONENTS) FROM                   
*                                     COLUMN                                    
         ST    R2,FULL                                                          
         CLC   =X'FFFFFF',FULL     COLUMN CONTAINS INDICATOR?                   
         BE    POSSEXIT            NEGATIVE VALUE INDICATES 'NO-ADD'            
*                                                                               
**       C     R2,=F'-1'           COLUMN CONTAINS INDICATOR?                   
**       BE    POSSEXIT            YES - DON'T POST ANYTHING                    
**       C     R2,=F'-2'           COLUMN CONTAINS INDICATOR?                   
**       BE    POSSEXIT            YES - DON'T POST ANYTHING                    
         LTR   R2,R2               ANY VALUE IN ROW?                            
         BZ    POSSEXIT            NO  - DON'T POST ANYTHING                    
*                                                                               
*   START TEST                                                                  
*        MVC   P(05),=C'REC1:'                                                  
***>>>   GOTO1 HEXOUT,DMCB,SVRFREG,P+15,4,=C'TOG'                               
*        MVC   P+10(108),REC                                                    
*        GOTO1 REPORT                                                           
*        MVC   P(05),=C'REC2:'                                                  
***>>>   GOTO1 HEXOUT,DMCB,SVRFREG,P+15,4,=C'TOG'                               
*        MVC   P+10(64),REC+RGDTADSP                                            
*        GOTO1 REPORT                                                           
*   END   TEST                                                                  
*                                                                               
         L     RE,0(R2)            GET SPL STATION VALUE                        
         A     RE,0(R3)            ADD ARRAY VALUE                              
         ST    RE,0(R3)            STORE IN BACK                                
*                                                                               
         L     RE,4(R2)            GET SPL MARKET  VALUE                        
         A     RE,4(R3)            ADD ARRAY VALUE                              
         ST    RE,4(R3)            STORE IN BACK                                
*                                                                               
*                                                                               
*   START TEST                                                                  
*        MVC   P(12),=C'COMPONENTS: '                                           
*        EDIT  (4,0(R2)),(8,P+15)                                               
*        EDIT  (4,4(R2)),(8,P+25)                                               
*        EDIT  (4,0(R3)),(8,P+35)                                               
*        EDIT  (4,4(R3)),(8,P+45)                                               
*        ST    R2,SVR2QUIK                                                      
*        GOTO1 HEXOUT,DMCB,SVR2QUIK,P+60,4,=C'TOG'                              
*        ST    R3,SVR2QUIK                                                      
*        GOTO1 HEXOUT,DMCB,SVR2QUIK,P+60,4,=C'TOG'                              
*        ST    R6,SVR2QUIK                                                      
*        GOTO1 HEXOUT,DMCB,SVR2QUIK,P+70,4,=C'TOG'                              
*        ST    R7,SVR2QUIK                                                      
*        GOTO1 HEXOUT,DMCB,SVR2QUIK,P+80,4,=C'TOG'                              
*        GOTO1 REPORT                                                           
*   END   TEST                                                                  
*                                                                               
POSSEXIT EQU   *                                                                
         XIT1                                                                   
SVR2QUIK DS    F                                                                
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
DOWNHEAD NMOD1 0,*DHED*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BNE   DHED0020            NO  - DON'T SET UP COLUMN HEADS              
*                                                                               
*   CHECK FOR HEADING DOWNLOAD OPTION:  IF NOT SELECTED, EXIT                   
*      THIS ROUTINE:  HEADINGS ARE NOT EXPECTED.                                
*                                                                               
         L     R1,THISQWK          A(THIS REQUEST WORK AREA)                    
         USING QWKD,R1                                                          
         LA    RF,QWREQ3                                                        
         CLI   Q3DNHEAD-QREC3(RF),C'Y'                                          
*                                  OPTION SET TO 'Y'?                           
         BNE   DHED0020            NO  - EXIT ROUTINE                           
*                                  YES - DEVELOP THE COLUMN HEADINGS            
         DROP  R1                                                               
*                                                                               
         BAS   RE,DOWNHED1         YES - SET UP COL HDGS FOR D/L                
DHED0020 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
* SET UP COLUMN HEADINGS AND OUTPUT TO DOWNLOAD                                 
*                                                                               
DOWNHED1 NTR1                                                                   
         MVI   SCRATCH1,C' '       SPACE-FILL WORK AREAS                        
         MVC   SCRATCH1+1(199),SCRATCH1                                         
         MVC   SCRATCH2,SCRATCH1                                                
*                                                                               
*   FIRST, PRELOAD TABLE WITH DUMMY ENTRY FOR EACH ROW WHOSE                    
*        ROW-HEADING IS DOWNLOADED ON EACH DATA LINE.  THESE WILL               
*        ALWAYS CONTAIN SPACES ON THE CONSTRUCTED DOWNLOAD LINE.                
*                                                                               
         ZIC   R3,RPROWS           SET NUMBER OF ROWS                           
         ZIC   R1,RPROWS           NOW SCAN ROWS FOR ZERO-LENGTH (CHOP)         
         LA    R7,RPROWDEF+4       SET A(FIRST ROW DEF ADDRESS)                 
DNLD0040 EQU   *                                                                
         L     RF,0(R7)            GET A(ROW NAME)                              
         CLI   4(RF),0             DOES ROW HAVE A WIDTH?  (0 = CHOP=0)         
         BNE   DNLD0060            YES - COUNT IT                               
         BCTR  R3,0                NO  - DROP ROW-COUNT                         
DNLD0060 EQU   *                                                                
         LA    R7,4(R7)            BUMP TO NEXT ROW DEF                         
         BCT   R1,DNLD0040         GO BACK FOR NEXT                             
*                                                                               
         ST    R3,ROWHEADS         SAVE NUMBER OF ROW HEADINGS                  
         B     DNLD0070                                                         
*                                                                               
ROWHEADS DS    F                                                                
*                                                                               
DNLD0070 EQU   *                                                                
         LA    R7,1                SET COLUMN OFFSET (DUMMY VALUE)              
         XC    P4(4),P4            CLEAR TO 1ST HALF                            
DNLD0080 EQU   *                                                                
         GOTO1 =A(PUTDOWN),DMCB,1,1,(R7),,(RC)                                  
*                                  P1  =  1  = TEXT                             
*                                  P2  =  L(DATA) - DUMMY OF 1                  
*                                  P3  =  COLUMN OFFSET - DUMMY R7              
*                                  P4  =  1ST/2ND HALF FLAG                     
*                                  P5  =  A(WORKSPACE)                          
*                                                                               
         LA    R7,2(R7)            BUMP DUMMY OFFSET                            
         BCT   R3,DNLD0080         GO BACK FOR NEXT ENTRY                       
*                                                                               
         LA    R7,4                SET INDEX FOR COL 1                          
         ZIC   R0,RPCOLS           GET HIGH COLUMN NUM                          
*                                                                               
DNLD0100 EQU   *                                                                
         L     R1,RPCOLDTA(R7)     GET PRINT DSPL FOR THIS COL                  
         LTR   R1,R1                                                            
         BZ    DNLD0140                                                         
         OC    ADJHDISP,ADJHDISP   FIRST TIME?                                  
         BNZ   DNLD0110            NO  - JUST APPLY CORRECTION                  
         LR    RF,R1               YES - CALCULATE CORRECTION TO PULL           
*                                     HEADING WITHIN PRINTLINE                  
         S     RF,=F'40'           PULL BACK TO POS 40                          
         ST    RF,ADJHDISP         SAVE THE CORRECTION                          
DNLD0110 EQU   *                                                                
         L     RF,ADJHDISP         LOAD THE CORRECTION                          
         SR    R1,RF               SUBTRACT CORRECTION FACTOR                   
         ST    R1,SAVHDISP         SAVE ADJUSTED DISP TO HEADING                
         LA    R1,SCRATCH1(R1)                                                  
         L     R6,RPCOLNAM(R7)     GET COLNAME SPEC                             
         LA    R4,2(R6)            POINT TO TITLE                               
         ZIC   R5,1(R6)            GET SPEC LENGTH                              
         SH    R5,=H'2'            GIVES TITLE LENGTH                           
         L     RE,RPCOLDEF(R7)     POINT TO COLDEF SPEC                         
         MVC   HALF(1),9(RE)       MOVE COLUMN WIDTH                            
         ZIC   RF,9(RE)            SAVE DATA WIDTH (LENGTH)                     
         ST    RF,SAVWIDTH                                                      
         MVI   HALF+1,C'L'         SET TO LEFT ALIGN                            
         BAS   RE,SPLTHEAD                                                      
         L     RF,SAVWIDTH         SET COLUMN WIDTH                             
         CLI   SAVWIDTH+3,1        SIGNIFICANT DATA?                            
         BL    DNLD0140            NO  - DON'T D/L 0 CHAR LENGTH                
         BE    DNLD0120            1 CHAR:  DON'T INCREASE                      
**       BNH   DNLD0140            NO  - DON'T D/L 0/1 CHAR LENGTH              
         LA    RF,1(RF)            YES - INCREASE WIDTH BY 1 CHAR               
DNLD0120 EQU   *                                                                
         ST    RF,P2               INSERT DATA LENGTH                           
         MVC   P3,SAVHDISP         SET DISPLACEMENT TO DATA                     
         XC    P4(4),P4            CLEAR TO 1ST HALF                            
         GOTO1 =A(PUTDOWN),DMCB,1,,,,(RC)                                       
*                                  P1  =  1  = TEXT                             
*                                  P2  =  L(DATA)                               
*                                  P3  =  COLUMN OFFSET                         
*                                  P4  =  1ST/2ND HALF FLAG                     
*                                  P5  =  A(WORKSPACE)                          
*                                                                               
DNLD0140 EQU   *                                                                
         LA    R7,4(R7)                                                         
         BCT   R0,DNLD0100                                                      
         MVC   P(200),SCRATCH1                                                  
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                  PRINT THE LINE                               
*                                                                               
*   PRELOAD TABLE WITH DUMMY ENTRY FOR SECOND LINE FOR EACH ROW WHOSE           
*        ROW-HEADING IS DOWNLOADED ON EACH DATA LINE.  THESE WILL               
*        ALWAYS CONTAIN SPACES ON THE CONSTRUCTED DOWNLOAD LINE.                
*                                                                               
*                                                                               
         MVI   SCRATCH1,C' '       SPACE-FILL WORK AREAS                        
         MVC   SCRATCH1+1(199),SCRATCH1                                         
         MVC   SCRATCH2,SCRATCH1                                                
*                                                                               
         L     R3,ROWHEADS         RELOAD NUMBER OF ROWS IN HEADING             
         LA    R7,1                SET COLUMN OFFSET (DUMMY VALUE)              
         XC    P4(4),P4            CLEAR TO 1ST HALF                            
DNLD0180 EQU   *                                                                
         GOTO1 =A(PUTDOWN),DMCB,1,1,(R7),,(RC)                                  
*                                  P1  =  1  = TEXT                             
*                                  P2  =  L(DATA) - DUMMY OF 1                  
*                                  P3  =  COLUMN OFFSET - DUMMY R7              
*                                  P4  =  1ST/2ND HALF FLAG                     
*                                  P5  =  A(WORKSPACE)                          
*                                                                               
         LA    R7,2(R7)            BUMP DUMMY OFFSET                            
         BCT   R3,DNLD0180         GO BACK FOR NEXT ENTRY                       
*                                                                               
         LA    R7,4                SET INDEX FOR COL 1                          
         ZIC   R0,RPCOLS           GET HIGH COLUMN NUM                          
         XC    SAV1DISP,SAV1DISP   CLEAR SAVE AREA                              
*                                                                               
DNLD0200 EQU   *                                                                
         L     R1,RPCOLDTA(R7)     GET PRINT DSPL FOR THIS COL                  
         LTR   R1,R1                                                            
         BZ    DNLD0260                                                         
         L     RF,ADJHDISP         LOAD THE CORRECTION                          
         SR    R1,RF               SUBTRACT CORRECTION FACTOR                   
         ST    R1,SAVHDISP         SAVE DISP TO HEADING                         
         OC    SAV1DISP,SAV1DISP   FIRST TIME SWITCH                            
         BNZ   DNLD0220            NOT FIRST TIME                               
         ST    R1,SAV1DISP         FIRST TIME: SAVE 1ST DISP                    
DNLD0220 EQU   *                                                                
         LA    R1,SCRATCH1(R1)                                                  
         L     R6,RPCOLNAM(R7)     GET COLNAME SPEC                             
         LA    R4,2(R6)            POINT TO TITLE                               
         ZIC   R5,1(R6)            GET SPEC LENGTH                              
         SH    R5,=H'2'            GIVES TITLE LENGTH                           
         L     RE,RPCOLDEF(R7)     POINT TO COLDEF SPEC                         
         MVC   HALF(1),9(RE)       MOVE COLUMN WIDTH                            
         ZIC   RF,9(RE)            SAVE DATA WIDTH (LENGTH)                     
         ST    RF,SAVWIDTH                                                      
         MVI   HALF+1,C'L'         SET TO LEFT ALIGN                            
         BAS   RE,SPLTHEAD                                                      
         L     RF,SAVWIDTH         SET COLUMN WIDTH                             
         CLI   SAVWIDTH+3,1        SIGNIFICANT DATA?                            
         BL    DNLD0260            NO  - DON'T D/L 0 CHAR LENGTH                
         BE    DNLD0240            NO  - DON'T INCREASE                         
**       BNH   DNLD0260            NO  - DON'T D/L 0/1 CHAR LENGTH              
         LA    RF,1(RF)            YES - INCREASE WIDTH BY 1 CHAR               
DNLD0240 EQU   *                                                                
         ST    RF,P2               INSERT DATA LENGTH                           
         MVC   P3,SAVHDISP         SET DISPLACEMENT TO DATA                     
*                                                                               
         XC    P4(4),P4            CLEAR TO 1ST HALF                            
         CLI   P2+3,1              CHECK FOR SIGNIFICANT DATA                   
         BL    DNLD0260            DON'T DOWNLOAD 0 CHAR LENGTH                 
         GOTO1 =A(PUTDOWN),DMCB,1,,,,(RC)                                       
*                                  P1  =  1  = TEXT                             
*                                  P2  =  L(DATA)                               
*                                  P3  =  COLUMN OFFSET                         
*                                  P4  =  1ST/2ND HALF FLAG                     
*                                  P5  =  A(WORKSPACE)                          
*                                                                               
DNLD0260 EQU   *                                                                
         LA    R7,4(R7)                                                         
         BCT   R0,DNLD0200                                                      
         MVC   P(200),SCRATCH1+132                                              
         L     RF,SAV1DISP         CLEAR FIRST PART OF LINE                     
         SH    RF,=H'2'            BACK OFF 2 POSITIONS                         
         EX    RF,DNLD0280         CLEAR START OF LINE                          
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                  PRINT THE LINE                               
         XIT1                                                                   
*                                                                               
DNLD0280 MVC   P(0),SPACES                                                      
*                                                                               
SAVHDISP DS    F                                                                
SAV1DISP DS    F                                                                
ADJHDISP DS    F                                                                
SAVWIDTH DS    F                                                                
SCRATCH1 DS    CL200                                                            
SCRATCH2 DS    CL200                                                            
         EJECT                                                                  
* SUBROUTINE TO SPLIT ROW/COL TITLES.                                           
*    NOTE:  THIS ROUTINE IS IDENTICAL TO 'SPLT'.  IT HAS BEEN COPIED            
*          LOCALLY BECAUSE NMOD'ING IT AND CHANGING ALL REGISTER                
*          USAGE WOULD INTRODUCE MORE PROBLEMS THAN IT WAS WORTH.               
* ON ENTRY R1 HAS HEADLINE ADDRESS                                              
*          R4 HAS TITLE ADDRESS                                                 
*          R5 HAS TITLE LENGTH                                                  
*          HALF(1) HAS PRINT LINE WIDTH                                         
*          HALF+1(1) HAS L/C/R FOR ALIGNMENT                                    
         SPACE 1                                                                
SPLTHEAD NTR1                                                                   
*                                                                               
         XC    MID1,MID1                                                        
         XC    MID2,MID2                                                        
*                                                                               
         STC   R5,MID2             SET ORIGINAL DATA LENGTH                     
         LA    RE,MID2+1                                                        
*                                                                               
SPHD0020 MVC   0(1,RE),0(R4)                                                    
         LA    RE,1(RE)                                                         
         LA    R4,1(R4)                                                         
         CLI   0(R4),C','                                                       
         BE    SPHD0040                                                         
         BCT   R5,SPHD0020                                                      
         B     SPHD0080                                                         
*                                                                               
SPHD0040 MVC   MID1,MID2                                                        
         LA    RF,MID2+1           GET ORIGINAL 'TO' ADDRESS                    
         SR    RE,RF                                                            
         STC   RE,MID1             SAVE ACTUAL DATA LENGTH                      
         XC    MID2,MID2           RE-CLEAR                                     
*                                                                               
         LR    RF,R5                                                            
         SH    RF,=H'2'            -2 GIVES ACTUAL DATA LEN                     
         STC   RF,MID2             SET IT                                       
         BCTR  RF,0                SET FOR EX                                   
         EX    RF,SPHD0060                                                      
         B     SPHD0080                                                         
SPHD0060 MVC   MID2+1(0),1(R4)                                                  
*                                                                               
SPHD0080 OC    MID1+1(131),SPACES                                               
         OC    MID2+1(131),SPACES                                               
         CLI   HALF+1,C'L'         TEST LEFT ALIGN                              
         BE    SPHD0100                                                         
         CLI   HALF+1,C'S'         TEST LEFT ALIGN/STAGGER                      
         BNE   SPHD0180                                                         
* LEFT ALIGN * LEFT ALIGN/STAGGER                                               
SPHD0100 EQU   *                                                                
         ZIC   RE,HALF                                                          
         LTR   RE,RE               LENGTH ZERO?                                 
         BZ    SPHD0260            YES - DON'T MOVE ANYTHING                    
         BCTR  RE,0                                                             
         CLI   HALF+1,C'S'         TEST LEFT ALIGN/STAGGER                      
         BE    SPHD0120            STAGGER: ONLY PUT OUT 1 LINE                 
         EX    RE,SPHD0140                                                      
SPHD0120 EQU   *                                                                
         EX    RE,SPHD0160                                                      
         B     SPHD0260                                                         
*                                                                               
SPHD0140 MVC   0(0,R1),MID1+1                                                   
SPHD0160 MVC   132(0,R1),MID2+1                                                 
         EJECT                                                                  
SPHD0180 CLI   HALF+1,C'C'         TEST CENTER                                  
         BNE   SPHD0220                                                         
         SPACE 1                                                                
* CENTER *                                                                      
         SPACE 1                                                                
         ZIC   RE,HALF             GET PRINT LINE WIDTH                         
         SR    R0,R0                                                            
         ICM   R0,1,MID1           GET MID1 DATA LENGTH                         
         BZ    SPHD0200                                                         
         SR    RE,R0                                                            
         LA    RE,1(RE)                                                         
         SRL   RE,1                DIVIDE BY 2 AND ROUND                        
         LA    RF,0(R1,RE)                                                      
*                                                                               
         IC    RE,MID1             GET LENGTH AGAIN                             
         BCTR  RE,0                                                             
         EX    RE,SPHD0280                                                      
*                                                                               
SPHD0200 ZIC   RE,HALF             GET PRINT LINE WIDTH                         
         SR    R0,R0                                                            
         ICM   R0,1,MID2           GET MID2 DATA LENGTH                         
         SR    RE,R0                                                            
         LA    RE,1(RE)                                                         
         SRL   RE,1                DIVIDE BY 2 AND ROUND                        
         LA    RF,0(R1,RE)                                                      
*                                                                               
         IC    RE,MID2             GET LENGTH AGAIN                             
         BCTR  RE,0                                                             
         EX    RE,SPHD0300                                                      
         B     SPHD0260                                                         
         EJECT                                                                  
* RIGHT ALIGN *                                                                 
         SPACE 1                                                                
SPHD0220 ZIC   RE,HALF             GET PRINT LINE WIDTH                         
         SR    R0,R0                                                            
         ICM   R0,1,MID1           GET MID1 DATA LENGTH                         
         BZ    SPHD0240                                                         
         SR    RE,R0                                                            
         LA    RF,0(R1,RE)                                                      
*                                                                               
         IC    RE,MID1             GET LENGTH AGAIN                             
         BCTR  RE,0                                                             
         EX    RE,SPHD0280                                                      
*                                                                               
SPHD0240 ZIC   RE,HALF             GET PRINT LINE WIDTH                         
         SR    R0,R0                                                            
         ICM   R0,1,MID2           GET MID2 DATA LENGTH                         
         SR    RE,R0                                                            
         LA    RF,0(R1,RE)                                                      
*                                                                               
         IC    RE,MID2             GET LENGTH AGAIN                             
         BCTR  RE,0                                                             
         EX    RE,SPHD0300                                                      
*                                                                               
SPHD0260 MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         XIT1                                                                   
*                                                                               
SPHD0280 MVC   0(0,RF),MID1+1                                                   
SPHD0300 MVC   132(0,RF),MID2+1                                                 
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
* SUBROUTINE TO CREATE HEADLINES FOR A REPORT *                                 
         SPACE 1                                                                
         DS    0F                                                               
SETHEAD  NMOD1 0,SETHEAD                                                        
*                                                                               
         L     RC,0(R1)                                                         
         USING WORKD,RC                                                         
         L     R8,4(R1)                                                         
         USING RGWORKC,R8                                                       
         USING RPSPECD,R2                                                       
         L     R3,THISQWK                                                       
         USING QWKD,R3                                                          
*                                                                               
         MVI   CLEARHED,C'N'       SUPPRESS HEADLINE CLEARING                   
         LA    R0,12                                                            
         LA    R1,HEAD1                                                         
*                                                                               
SHED0004 MVC   0(132,R1),SPACES    SPACE-FILL HEADLINE N                        
         CLM   R0,1,6              COMPARE LOOP CONTROL                         
         BL    *+8                    FOR 1ST 7 LINES                           
         MVI   0(R1),0             FORCE FIRST 7 HEADLINES TO PRINT             
*                                     BY MOVING NON-SPACE VALUE INTO            
*                                        1ST PRINT POSITION                     
         LA    R1,132(R1)          BUMP TO NEXT PRINT LINE                      
         BCT   R0,SHED0004         LOOP THRU 12 LINES                           
*                                                                               
         MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
*                                                                               
         LA    R0,4                FIRST 4 LINES ARE RE-SPACED                  
*                                     WHAT HAPPENS TO FORCING PRINT?            
         LA    R1,P                                                             
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         LA    R7,RPROWNAM+4       POINT TO LIST OF ROWNAME SPECS               
         SR    RE,RE               CLEAR MAX ROW TITLE LENGTH                   
         SR    RF,RF               CLEAR MAX ROW CODE LENGTH                    
*                                                                               
SHED0008 ICM   R6,15,0(R7)         GET ROWNAME SPEC ADDRESS                     
         BZ    SHED0016            NO ADDRESS - FINISHED                        
         USING RNSPECD,R6                                                       
*                                                                               
         CLI   RNLINTYP,1          HEADLINE ROW?                                
         BNE   SHED0012            NO  - BUMP TO NEXT ROW                       
         CLM   RE,1,RNTTLLEN       YES - IS L(TITLE) > LAST TITLE?              
         BH    *+8                 NO  - USE LAST LENGTH                        
         IC    RE,RNTTLLEN         YES - USE THIS LENGTH                        
         CLM   RF,1,RNCODLEN       IS L(CODE) > LAST CODE?                      
         BH    *+8                 NO  - USE LAST LENGTH                        
         IC    RF,RNCODLEN         YES - USE THIS LENGTH                        
*                                                                               
SHED0012 LA    R7,4(R7)            BUMP TO NEXT ROW SPEC                        
         B     SHED0008                                                         
*                                                                               
SHED0016 STC   RE,RPMAXTTL         SET MAX ROW TITLE LENGTH                     
         STC   RF,RPMAXCOD         SET MAX ROW CODE LENGTH                      
*                                                                               
         ZIC   R0,RPROWS           GET HIGH ROW NUM                             
         MH    R0,=Y(RGROWSZ)      ** NOTE THAT ROW0 IS INCLUDED                
         BCTR  R0,0                ** THIS GIVES LENGTH UP TO MON ROW           
         STH   R0,RPCBEXLN         SAVE PRIMARY CNTL BRK LEN                    
*                                                                               
         LA    R7,4                SET INDEX TO ROW 1                           
         ZIC   R0,RPROWS           SET NUMBER OF ROWS AGAIN                     
         MVI   RPMONTHS,0                                                       
         MVI   RPTOTOPT,0                                                       
*                                                                               
SHED0020 L     R6,RPROWDEF(R7)     POINT TO ROWDEF SPEC (+ INDEX)               
         LTR   R6,R6               ANY ADDRESS THERE?                           
         BZ    SHED0040            NO  - FINISHED                               
*                                                                               
SHED0024 CLI   3(R6),17            IS ROW FOR 'MONTH'?                          
         BNE   SHED0028            NO                                           
         STC   R7,RPMONTHS         YES - SAVE INDEX TO MONTH ROW                
         B     SHED0044            SKIP OUT                                     
*                                                                               
SHED0028 CLI   3(R6),18            IS ROW FOR 'CURRENT MONTH'?                  
         BNE   SHED0032            NO                                           
         STC   R7,RPMONTHS         YES - SAVE INDEX                             
         MVI   RPTOTOPT,C'C'       INDICATE CURRENT MONTH ONLY                  
         B     SHED0044            SKIP OUT                                     
*                                                                               
SHED0032 CLI   3(R6),19            IS ROW FOR 'ALLMONTHS'?                      
         BNE   SHED0036            NO                                           
         STC   R7,RPMONTHS         YES                                          
         MVI   RPTOTOPT,C'T'       INDICATE TOTALS ONLY                         
         B     SHED0044            SKIP OUT                                     
*                                                                               
SHED0036 CLI   3(R6),20            IS ROW FOR 'ALLMONTHS'?                      
         BNE   SHED0040            NO                                           
         STC   R7,RPMONTHS         YES                                          
         MVI   RPTOTOPT,C'Q'       INDICATE QUARTERS ONLY                       
         B     SHED0044            SKIP OUT                                     
*                                                                               
SHED0040 LA    R7,4(R7)            BUMP TO NEXT ROW                             
         BCT   R0,SHED0020         GO BACK FOR NEXT                             
         EJECT                                                                  
SHED0044 DS    0H                                                               
         L     R6,RPRPTNAM         GET REPORT NAME SPEC ADDRESS                 
         ZIC   RE,1(R6)                                                         
         SH    RE,=H'3'            SET FOR EX                                   
         LA    R1,HEAD1                                                         
         EX    RE,SHED0060                                                      
*                                                                               
         TM    RPMISFLG+1,X'04'    LEFT-ALIGN HEADINGS?                         
         BNO   SHED0045            NO                                           
*                                  YES                                          
         GOTO1 CENTER,DMCB,HEAD1,80                                             
*                                                                               
         GOTO1 UNDERLIN,(R1),(80,HEAD1),(DASH,HEAD2)                            
         LA    R1,HEAD3+32         SET ADDRESS FOR DATES                        
         B     SHED0046                                                         
SHED0045 EQU   *                                                                
         GOTO1 CENTER,DMCB,HEAD1,132                                            
*                                                                               
         GOTO1 UNDERLIN,(R1),(132,HEAD1),(DASH,HEAD2)                           
*                                                                               
         LA    R1,HEAD3+47                                                      
         MVC   0(19,R1),=C'FOR THE PERIOD FROM'                                 
*                                                                               
         LA    R1,20(R1)                                                        
SHED0046 EQU   *                                                                
         CLI   RPTOTOPT,C'C'                                                    
         BNE   SHED0048                                                         
         L     RF,THISQWK                                                       
         ZIC   RE,QWCURMON-QWKD(RF)                                             
         B     SHED0052                                                         
*                                                                               
SHED0048 PACK  DUB,QSTART+2(2)                                                  
         CVB   RE,DUB                                                           
*                                                                               
SHED0052 BCTR  RE,0                                                             
         MH    RE,=H'3'                                                         
         LA    RE,MONTHS(RE)                                                    
         MVC   0(3,R1),0(RE)                                                    
         MVI   3(R1),C'/'                                                       
         MVC   4(2,R1),QSTART                                                   
         MVC   7(2,R1),=C'TO'                                                   
*                                                                               
         LA    R1,10(R1)                                                        
         CLI   RPTOTOPT,C'C'                                                    
         BE    SHED0056                                                         
         PACK  DUB,QEND+2(2)                                                    
         CVB   RE,DUB                                                           
         BCTR  RE,0                                                             
         MH    RE,=H'3'                                                         
         LA    RE,MONTHS(RE)                                                    
*                                                                               
SHED0056 MVC   0(3,R1),0(RE)                                                    
         MVI   3(R1),C'/'                                                       
         MVC   4(2,R1),QEND                                                     
         B     SHED0064                                                         
*                                                                               
SHED0060 MVC   0(0,R1),2(R6)                                                    
*                                                                               
SHED0064 ICM   R6,15,RPRPTRGT      GET FIRST RPTRIGHT SPEC ADDRESS              
         BZ    SHED0128                                                         
*                                                                               
         LA    R1,HEAD4+96         R1 = PRINT POSITION                          
         TM    RPMISFLG+1,X'04'    LEFT-ALIGN HEADINGS?                         
         BNO   SHED0068            NO                                           
*                                  YES                                          
         LA    R1,HEAD4+64         YES - RESET PRINT POSITION                   
*                                                                               
SHED0068 CLI   2(R6),X'FF'         TEST FOR SOFT RPTRIGHT                       
         BNE   SHED0120                                                         
         LA    RE,SHEDTABL                                                      
*                                                                               
SHED0072 CLI   0(RE),X'FF'         SEARCH FOR DATA CODE                         
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   0(1,RE),3(R6)                                                    
         BE    SHED0076                                                         
         LA    RE,6(RE)                                                         
         B     SHED0072                                                         
*                                                                               
SHED0076 ZIC   R4,1(R6)                                                         
         SH    R4,=H'5'            R4 = LENGTH FOR LITERAL MOVE                 
         SR    R7,R7                                                            
         ICM   R7,1,1(RE)          TEST DATA FILTER EXISTS ON QRECORD           
         BZ    SHED0080            NO  - PRINT 'ALL'                            
         LA    R7,QRECORD(R7)      R7  = ADDR IN QRECORD                        
         ZIC   RF,2(RE)                                                         
         BCTR  RF,0                RF = LENGTH FOR SPACES COMPARE               
         EX    RF,SHED0108                                                      
         BNE   SHED0084                                                         
*                                                                               
SHED0080 MVC   0(3,R1),=C'ALL'     EQ SPACES - MOVE 'ALL' LINE                  
         EX    R4,SHED0112                                                      
         LA    R4,5(R1,R4)                                                      
         MVI   0(R4),C'S'                                                       
         B     SHED0124                                                         
*                                                                               
SHED0084 EX    R4,SHED0116         NE SPACES -                                  
         LA    R5,2(R4,R1)         R5 = PRINT LINE POS FOR VARIABLE             
         SR    RF,RF                                                            
         ICM   RF,7,3(RE)                                                       
         BASR  RE,RF               PERFORM DATA CODE ROUTINE                    
*                                                                               
SHED0088 MVC   0(4,R5),0(R7)                                                    
         LA    R4,3(R5)                                                         
         CLI   0(R4),C' '                                                       
         BNE   *+8                                                              
         BCT   R4,*-8                                                           
         MVI   1(R4),C'-'                                                       
         MVI   3(R4),C'M'                                                       
         MVC   2(1,R4),4(R7)                                                    
         CLI   4(R7),C' '                                                       
         BNE   SHED0124                                                         
         MVC   2(2,R4),=C'TV'                                                   
         B     SHED0124                                                         
*                                                                               
SHED0092 L     R4,ASPACND4                                                      
         SR    R0,R0                                                            
         CLC   =C'* ',0(R7)        SET REQUEST?                                 
         BNE   SHED0096                                                         
         MVC   0(20,R5),=C'*OFFICE SET IN USE* '                                
         B     SHED0124                                                         
*                                                                               
SHED0096 CLI   0(R4),0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   0(R4),4                                                          
         BNE   SHED0100                                                         
         CLC   0(2,R7),DOFFOFF(R4)                                              
         BNE   SHED0100                                                         
         MVC   0(20,R5),DOFFNAM(R4)                                             
         B     SHED0124                                                         
*                                                                               
SHED0100 IC    R0,1(R4)                                                         
         AR    R4,R0                                                            
         B     SHED0096                                                         
*                                                                               
SHED0104 MVC   0(2,R5),0(R7)                                                    
         B     SHED0124                                                         
*                                                                               
SHED0108 CLC   0(0,R7),SPACES      * EXECUTED                                   
SHED0112 MVC   4(0,R1),4(R6)       * EXECUTED                                   
SHED0116 MVC   0(0,R1),4(R6)       * EXECUTED                                   
*                                                                               
SHEDTABL DC    AL1(2,QSTATION-QRECORD,L'QSTATION),AL3(SHED0088)                 
         DC    AL1(4,QOFFICE-QRECORD,L'QOFFICE),AL3(SHED0092)                   
         DC    AL1(15,QCATY-QRECORD,L'QCATY),AL3(SHED0104)                      
         DC    AL1(39,0,0),AL3(0)                                               
         DC    X'FF'                                                            
*                                                                               
*                                                                               
SHED0120 ZIC   RE,1(R6)                                                         
         SH    RE,=H'3'            SET FOR EX                                   
         EX    RE,SHED0060                                                      
*                                                                               
SHED0124 LA    R1,132(R1)          POSITION TO NEXT HEADLINE                    
         ZIC   R0,1(R6)                                                         
         AR    R6,R0                                                            
         CLI   0(R6),13            TEST MORE RPTRIGHT SPECS                     
         BE    SHED0068            YES - GO PROCESS                             
         EJECT                                                                  
* WORK OUT PRINT LINE ROW DISPLACEMENTS *                                       
         SPACE 2                                                                
SHED0128 XC    RPROWDTA,RPROWDTA                                                
         LA    R7,4                SET INDEX TO ROW 1                           
*                                                                               
SHED0132 L     R6,RPROWNAM(R7)     POINT TO ROWNAME SPEC                        
         LTR   R6,R6                                                            
         BZ    SHED0152                                                         
*                                                                               
         USING RNSPECD,R6                                                       
*                                                                               
         CLI   RNLINTYP,3          TEST PRINT LINE DATA                         
         BE    SHED0133            YES                                          
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BNE   SHED0148            NO                                           
         CLI   RNLINTYP,1          HEADER: FORCE HEADER TO PRINT?               
         BNE   SHED0148            NO                                           
SHED0133 EQU   *                                                                
         L     R1,RPROWDEF(R7)     POINT TO ROW DEF SPEC                        
         LA    RE,RPROWDTA(R7)     A(DISPLACEMENT ARRAY)                        
         LA    RF,RPROWFLG(R7)     A(STAGGER FLAG ARRAY)                        
         CLI   3(R1),2             TEST FOR STATION                             
         BE    SHED0136                                                         
         CLI   3(R1),32            OR STAMKT                                    
         BNE   SHED0140                                                         
SHED0136 CLI   RNDTATYP,3          TEST FOR ROWBOTH                             
         BNE   SHED0140                                                         
         CLI   4(R1),28                                                         
         BNE   SHED0140                                                         
         MVI   3(RE),7             FORCE WIDTH                                  
         B     SHED0144                                                         
*                                                                               
SHED0140 MVC   3(1,RE),4(R1)       MOVE ROW WIDTH                               
*                                                                               
SHED0144 EQU   *                                                                
         TM    5(R1),X'80'         IS STAGGER BIT ON?                           
         BNO   SHED0148            NO                                           
         OI    0(RF),X'80'         YES - SET ARRAY FLAG ALSO                    
         L     RF,FULL             LOAD A(PREVIOUS ENTRY)                       
         OI    0(RF),X'40'         SET PREVIOUS FLAG ALSO                       
         LA    RF,4(RF)            GO BACK TO CURRENT ENTRY                     
SHED0148 EQU   *                                                                
         ST    RF,FULL             SAVE A(CURRENT AS PREVIOUS)                  
         LA    R7,4(R7)            DISP INTO DISPLACEMENT ARRAY                 
         B     SHED0132                                                         
         SPACE 1                                                                
* NOW DO THE COLUMNS *                                                          
         SPACE 1                                                                
SHED0152 LA    R7,4                SET INDEX TO COL1                            
         XC    RPCOLDTA,RPCOLDTA                                                
*                                                                               
SHED0156 L     R6,RPCOLDEF(R7)     POINT TO COLDEF SPEC                         
         LTR   R6,R6                                                            
         BZ    SHED0160                                                         
         LA    RE,RPCOLDTA(R7)                                                  
         MVC   3(1,RE),9(R6)       MOVE COL WIDTH                               
         LA    R7,4(R7)                                                         
         B     SHED0156                                                         
*                                                                               
SHED0160 LA    R0,RGROWMAX-1                                                    
         LA    RF,RPROWDTA+4       A(DISPLACEMENT ARRAY)                        
         LA    RE,RPROWFLG+4       A(STAGGER FLAG ARRAY)                        
         SR    R1,R1                                                            
*                                                                               
SHED0164 OC    0(4,RF),0(RF)                                                    
         BZ    SHED0168                                                         
         TM    0(RE),X'80'         IS ROW 'STAGGERED'?                          
         BO    SHED0168            YES - DON'T INCREMENT FOR IT                 
         A     R1,0(RF)            ADD LENGTH OF THIS FIELD                     
         LA    R1,1(R1)              + SPACE BETWEEN                            
SHED0168 EQU   *                                                                
         LA    RE,4(RE)            BUMP A(STAGGER FLAG ARRAY)                   
         LA    RF,4(RF)            BUMP A(DISPLACEMENT ARRAY)                   
         BCT   R0,SHED0164                                                      
*                                                                               
SHED0172 LA    R0,RGCOLMAX-1                                                    
         LA    RF,RPCOLDTA+4                                                    
*                                                                               
SHED0176 OC    0(4,RF),0(RF)                                                    
         BZ    *+12                                                             
         A     R1,0(RF)                                                         
         LA    R1,1(R1)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,SHED0176                                                      
*                                                                               
SHED0178 BCTR  R1,0                ADJUST FOR FINAL SPACE                       
*                                                                               
         TM    RPMISFLG+1,X'04'    OPTION FLAG TO FORCE LEFT-                   
*                                     ALIGNMENT OF REPORT SET?                  
         BNO   SHED0179            NO  - CENTER THE REPORT, IF NOT              
*                                     DOWNLOAD                                  
         LA    RE,0                YES - SET INITL LEFTMOST PRINT DSPL          
         MVC   RPTBXCOL,SPACES     CLEAR PREVIOUS BOX DEFINITIONS               
         ST    RE,FULL             SAVE LEFTMOST PRINT DISPLACEMENT             
         B     SHED0182            SKIP OTHER SETTINGS                          
SHED0179 EQU   *                                                                
         LA    RE,1                SET INITIAL LEFTMOST PRINT DSPL              
*                                     IN CASE THIS IS DOWNLOAD                  
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    SHED0181            YES - IGNORE LINE LIMIT                      
         LA    RE,132              NO  - CENTER REPORT BASED ON WIDTH           
         SR    RE,R1                                                            
         BNM   *+6                                                              
         DC    H'0'                TOO MUCH PRINT LINE DATA                     
SHED0181 EQU   *                                                                
         LA    RE,1(RE)            ROUND UP                                     
         SRL   RE,1                GIVES LEFTMOST PRINT DSPL                    
         ST    RE,FULL             SAVE IT FOR A MOMENT                         
*                                                                               
         MVC   RPTBXCOL,SPACES     CLEAR PREVIOUS BOX DEFINITIONS               
         LA    RE,RPTBXCOL-1(RE)                                                
         MVI   0(RE),C'L'          SET LEFT HAND BOX COL                        
         LA    RE,1(R1,RE)                                                      
         MVI   0(RE),C'R'          SET RIGHT HAND BOX COL                       
*                                                                               
* NOW GO BACK AND SET ACTUAL PRINT LINE DISPLACEMENTS *                         
*                                                                               
SHED0182 EQU   *                                                                
         ZIC   R0,RPROWS           SET # ROWS IN SPEC                           
         LA    RF,RPROWDTA+4       A(DISPLACEMENT ARRAY)                        
         LA    RE,RPROWFLG+4       A(STAGGER FLAG ARRAY)                        
         L     R1,FULL             GET LEFTMOST COL                             
         LA    R1,4(R1)            OFFSET 4 CHARS FOR COMMENTS                  
         STC   R1,RPCOMDSP         SET COMMENT DISPLACEMENT LEFT                
         L     R1,FULL             GET LEFTMOST COL AGAIN                       
         STC   R1,RPMARGIN         SET LEFT HAND MARGIN DSPL                    
*                                                                               
SHED0184 OC    0(4,RF),0(RF)       FIND FIRST PRINT LINE ROW                    
         BNZ   SHED0188                                                         
         LA    RF,4(RF)            A(DISPLACEMENT ARRAY)                        
         LA    RE,4(RE)            A(STAGGER ARRAY)                             
         BCT   R0,SHED0184                                                      
         B     SHED0200                                                         
*                                                                               
SHED0188 EQU   *                                                                
         TM    0(RE),X'80'         IS ROW STAGGERED?                            
         BNO   SHED0192            NO                                           
         LR    R7,R1               YES - OFFSET IT TWO POSITIONS                
         AH    R7,=H'2'            YES - OFFSET TWO POSITIONS                   
         ST    R7,0(RF)            STORE IT BACK                                
         B     SHED0194                                                         
SHED0192 MVC   FULL,0(RF)          MOVE FIELD LENGTH                            
         ST    R1,0(RF)            SET DISPLACEMENT                             
         TM    0(RE),X'40'         IS NEXT ROW STAGGERED?                       
         BO    SHED0196            YES - DON'T DISPLACE YET                     
SHED0194 EQU   *                                                                
         A     R1,FULL                                                          
         OC    FULL,FULL           ANY LENGTH? (CHOP=0?)                        
         BZ    SHED0196            NO  - DON'T ADD FOR BETWEEN                  
         LA    R1,1(R1)            ONE COL BETWEEN FIELDS                       
SHED0196 EQU   *                                                                
         LA    RF,4(RF)            A(DISPLACEMENT ARRAY)                        
         LA    RE,4(RE)            A(STAGGER ARRAY)                             
****>    OC    0(4,RF),0(RF)       IS ITEM EMPTY?                               
****>    BZ    SHED0200            YES - NO MORE ROWS                           
*                                                                               
*   ABOVE TEST IS NOT TRUE, BECAUSE A ROW WITH CHOP=0 CAN BE ENTERED.           
*                                                                               
         BCT   R0,SHED0188                                                      
*                                                                               
SHED0200 LA    R0,RGCOLMAX-1                                                    
         LA    RF,RPCOLDTA+4                                                    
*                                                                               
SHED0204 MVC   FULL,0(RF)          MOVE FIELD LENGTH                            
         ST    R1,0(RF)            SET DISPLACEMENT                             
         A     R1,FULL                                                          
         OC    FULL,FULL           IS LENGTH ZERO?                              
         BZ    SHED0206            YES - NO COL BETWEEN FIELDS                  
         LA    R1,1(R1)            ONE COL BETWEEN FIELDS                       
SHED0206 EQU   *                                                                
         LA    RF,4(RF)                                                         
         BCT   R0,SHED0204                                                      
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    SHED0256            YES - SKIP COLUMN HEADINGS                   
* MOVE TITLES OF PRINT LINE ROWS TO HEADLINES *                                 
SHED0207 EQU   *                                                                
         LA    R7,4                SET INDEX FOR ROW 1                          
         ZIC   R0,RPROWS           GET HIGH ROW NUMBER                          
*                                                                               
SHED0208 L     R6,RPROWNAM(R7)                                                  
         LTR   R6,R6                                                            
         BZ    SHED0224                                                         
*                                                                               
         USING RNSPECD,R6                                                       
*                                                                               
SHED0212 CLI   RNLINTYP,3          TEST PRINT LINE                              
         BNE   SHED0224                                                         
*                                                                               
         L     R1,RPROWDTA(R7)     PRINT DSPL FOR THIS ROW                      
         LA    RF,RPROWFLG(R7)     A(STAGGER ARRAY) FOR ROW                     
         TM    0(RF),X'40'         IS IT A 'PREVIOUS' ROW?                      
         BNO   SHED0216            NO                                           
         LA    R1,HEAD9(R1)        YES - PUT TITLE ON PREV LINE                 
         B     SHED0220                                                         
SHED0216 EQU   *                                                                
         LA    R1,HEAD10(R1)       POINT TO HEADLINE POSITION                   
SHED0220 EQU   *                                                                
         LA    R4,RNTITLE          POINT TO TITLE                               
         ZIC   R5,RNTTLLEN         GET TITLE LENGTH                             
         L     RE,RPROWDEF(R7)     POINT TO ROWDEF SPEC                         
         MVC   HALF(1),4(RE)       MOVE ROW WIDTH                               
         MVI   HALF+1,C'L'         SET TO LEFT ALIGN                            
         TM    0(RF),X'C0'         IS ROW A STAGGER/OR BEFORE                   
         BZ    SHED0222            NO  -                                        
         MVI   HALF+1,C'S'         SET TO LEFT ALIGN/STAGGER                    
SHED0222 EQU   *                                                                
*                                                                               
         CLI   HALF,0              TEST WIDTH=0                                 
         BE    SHED0224                                                         
         BAS   RE,SPLT                                                          
*                                                                               
SHED0224 LA    R7,4(R7)                                                         
         BCT   R0,SHED0208                                                      
         SPACE 1                                                                
* NOW MOVE COLUMN NAMES *                                                       
         SPACE 1                                                                
         LA    R7,4                SET INDEX FOR COL 1                          
         ZIC   R0,RPCOLS           GET HIGH COLUMN NUM                          
*                                                                               
SHED0228 L     R1,RPCOLDTA(R7)     GET PRINT DSPL FOR THIS COL                  
         LTR   R1,R1                                                            
         BZ    SHED0232                                                         
         LA    R1,HEAD10(R1)                                                    
         L     R6,RPCOLNAM(R7)     GET COLNAME SPEC                             
         LA    R4,2(R6)            POINT TO TITLE                               
         ZIC   R5,1(R6)            GET SPEC LENGTH                              
         SH    R5,=H'2'            GIVES TITLE LENGTH                           
         L     RE,RPCOLDEF(R7)     POINT TO COLDEF SPEC                         
         MVC   HALF(1),9(RE)       MOVE COLUMN WIDTH                            
         MVI   HALF+1,C'R'         SET TO RIGHT ALIGN                           
         BAS   RE,SPLT                                                          
*                                                                               
SHED0232 LA    R7,4(R7)                                                         
         BCT   R0,SHED0228                                                      
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    SHED0256            YES - DON'T SET BOX LOCS                     
         EJECT                                                                  
* NOW SET BOX LOCATIONS FOR COLUMN CHUNKS *                                     
         SPACE 1                                                                
         ICM   R6,15,RPCOLCHK                                                   
         BZ    SHED0256                                                         
*                                                                               
SHED0236 ZIC   RE,2(R6)            GET LOW COL NUMBER                           
         SLL   RE,2                X 4                                          
         L     RE,RPCOLDTA(RE)     PICK UP COL DSPL (0 REL)                     
         STH   RE,FULL             SAVE DSPL                                    
         BCTR  RE,0                BACK UP ONE PRINT POSITION                   
*                                                                               
         LA    RE,RPTBXCOL(RE)                                                  
         MVI   0(RE),C'C'          SET 'MIDDLE'                                 
*                                                                               
*                                                                               
         ZIC   RE,3(R6)            GET HI COL NUM                               
         SLL   RE,2                X 4                                          
         L     RE,RPCOLDTA+4(RE)   PICK UP SUBSEQUENT COL DSPL                  
         BCTR  RE,0                BACK UP ONE                                  
         STH   RE,FULL+2           AND SAVE DSPL                                
*                                                                               
         LA    RE,RPTBXCOL(RE)                                                  
         CLI   0(RE),C' '          TEST PREVIOUS DATA                           
         BH    *+8                                                              
         MVI   0(RE),C'C'                                                       
         EJECT                                                                  
* MOVE CHUNK TITLE TO HEADLINE *                                                
         SPACE 1                                                                
         LA    R4,4(R6)            POINT TO TITLE                               
         ZIC   R5,1(R6)            GET SPEC LENGTH                              
         SH    R5,=H'5'            GIVES TITLE LENGTH -1                        
         LH    R4,FULL             GET LEFT HAND LIMIT                          
         LA    R4,HEAD9(R4)        POINT TO HEADLINE SLOT                       
         EX    R5,*+8              MOVE THE TITLE (LEFT ALIGN)                  
         B     *+10                                                             
         MVC   0(0,R4),4(R6) *EXECUTED*                                         
* NOW CENTER IT *                                                               
         LH    R5,FULL+2           GET RIGHT HAND LIMIT                         
         SH    R5,FULL             LESS LEFT HAND LIMIT                         
         GOTO1 CENTER,DMCB,(R4),(R5)                                            
         SPACE 1                                                                
* OVERWRITE BLANKS WITH - CHAR *                                                
         SPACE 1                                                                
SHED0240 CLI   0(R4),C' '                                                       
         BNE   SHED0244                                                         
         MVC   0(1,R4),DASH                                                     
         LA    R4,1(R4)                                                         
         BCT   R5,SHED0240                                                      
         B     SHED0252                                                         
*                                                                               
SHED0244 LH    R4,FULL+2           GET RIGHT HAND LIMIT                         
         LA    R4,HEAD9(R4)        POINT TO END + 1                             
*                                                                               
SHED0248 BCTR  R4,0                BACK UP                                      
         CLI   0(R4),C' '                                                       
         BNE   SHED0252                                                         
         MVC   0(1,R4),DASH                                                     
         B     SHED0248                                                         
         SPACE 1                                                                
*                                                                               
SHED0252 SR    R0,R0                                                            
         IC    R0,1(R6)                                                         
         AR    R6,R0                                                            
         CLI   0(R6),44            TEST MORE CHUNK SPECS                        
         BE    SHED0236            YES - GO PROCESS                             
         EJECT                                                                  
* SET UP WEEKS PER MONTH FOR PRIOR/CURRENT YEARS *                              
         SPACE 1                                                                
SHED0256 EQU   *                                                                
         OC    RPCURWKS,RPCURWKS   TEST ALREADY DONE                            
         BNZ   SHED0288                                                         
*                                                                               
         LA    R4,RPCURWKS                                                      
         LA    R5,RPCWKYTD                                                      
         SR    R0,R0                                                            
         SR    R6,R6                                                            
         MVC   WORK(2),QSTART      MOVE REQ START YEAR                          
         MVC   WORK+4(2),=C'15'                                                 
         MVC   WORK+2(2),=C'01'    SET MONTH TO JANUARY                         
         OC    QWMONADJ,QWMONADJ   MONTH ADJUSTMENT?                            
         BZ    SHED0260            NO                                           
*                                    START/END NOT IN SAME YEAR                 
         MVC   WORK+2(2),QSTART+2  YES - START WITH START MONTH                 
SHED0260 EQU   *                                                                
         GOTO1 DATCON,DMCB,(0,WORK),(3,WORK+24)                                 
*                                  SET UP A BINARY START CURRENT                
         ZIC   RE,WORK+24          GET PRIOR YEAR DATE                          
         BCTR  RE,0                BACK OFF 1 YEAR                              
         MVC   WORK+30(3),WORK+24  SET PRIOR YEAR OFF CURRENT YEAR              
         STC   RE,WORK+30          INSERT PRIOR YEAR                            
         MVC   WORK(4),QEND        SET UP BINARY END CURRENT                    
         GOTO1 DATCON,DMCB,(0,WORK),(3,WORK+27)                                 
         ZIC   RE,WORK+27          GET PRIOR YEAR DATE                          
         BCTR  RE,0                BACK OFF 1 YEAR                              
         MVC   WORK+33(3),WORK+27  SET PRIOR YEAR OFF CURRENT YEAR              
         STC   RE,WORK+33          INSERT PRIOR YEAR                            
*                                                                               
*   TEST                                                                        
**       MVC   P+1(15),=C'CURR/PRIOR    :'                                      
**       MVC   P+20(6),WORK+24                                                  
**       MVI   P+27,C'/'                                                        
**       MVC   P+28(6),WORK+30                                                  
**       GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
SHED0262 EQU   *                                                                
*                                                                               
*        PROCESS CURRENT YEAR BUCKETS                                           
*                                                                               
SHED0264 EQU   *                                                                
         GOTO1 DATCON,DMCB,(3,WORK+24),(0,WORK)                                 
*                                                                               
*        CONVERT CURRENT DATE TO EBCDIC (FAF0 VARIETY FOR Y2K)                  
*                                                                               
         GOTO1 GETBROAD,DMCB,WORK,WORK+6                                        
*                                                                               
*        GET BROADCAST DATES FOR THIS MONTH                                     
*                                                                               
         IC    R0,0(R1)                                                         
         AR    R6,R0                                                            
         STC   R6,0(R5)                                                         
         MVC   0(1,R4),0(R1)       MOVE NUMBER OF WEEKS                         
         OI    0(R4),X'F0'         MAKE EBCDIC                                  
         LA    R4,1(R4)                                                         
         LA    R5,1(R5)                                                         
         ZIC   RE,WORK+25          GET CURRENT DATE MONTH                       
         LA    RE,1(RE)            BUMP TO NEXT MONTH                           
         C     RE,=F'13'           YEAR CHANGE?                                 
         BNE   SHED0268            NO                                           
         LA    RE,1                YES - RESET TO JANUARY                       
         ZIC   RF,WORK+24          BUMP YEAR                                    
         LA    RF,1(RF)                                                         
         STC   RF,WORK+24          REPLACE YEAR                                 
SHED0268 EQU   *                                                                
         STC   RE,WORK+25          REPLACE MONTH                                
         CLC   WORK+24(3),WORK+27  REQUEST PERIOD DONE?                         
         BNH   SHED0264            YES - DO PRIOR PERIOD                        
*                                                                               
         LA    R4,RPPRIWKS                                                      
         LA    R5,RPPWKYTD                                                      
         SR    R6,R6                                                            
**>> PRIOR PERIOD                                                               
*                                                                               
*        PROCESS PRIOR   YEAR BUCKETS                                           
*                                                                               
SHED0272 EQU   *                                                                
         GOTO1 DATCON,DMCB,(3,WORK+30),(0,WORK)                                 
*                                                                               
*        CONVERT CURRENT DATE TO EBCDIC (FAF0 VARIETY FOR Y2K)                  
*                                                                               
         GOTO1 GETBROAD,DMCB,WORK,WORK+6                                        
*                                                                               
*        GET BROADCAST DATES FOR THIS MONTH                                     
*                                                                               
         IC    R0,0(R1)                                                         
         AR    R6,R0                                                            
         STC   R6,0(R5)                                                         
         MVC   0(1,R4),0(R1)       MOVE NUMBER OF WEEKS                         
         OI    0(R4),X'F0'         MAKE EBCDIC                                  
         LA    R4,1(R4)                                                         
         LA    R5,1(R5)                                                         
         ZIC   RE,WORK+31          GET CURRENT DATE MONTH                       
         LA    RE,1(RE)            BUMP TO NEXT MONTH                           
         C     RE,=F'13'           YEAR CHANGE?                                 
         BNE   SHED0276            NO                                           
         LA    RE,1                YES - RESET TO JANUARY                       
         ZIC   RF,WORK+30          BUMP YEAR                                    
         LA    RF,1(RF)                                                         
         STC   RF,WORK+30          REPLACE YEAR                                 
SHED0276 EQU   *                                                                
         STC   RE,WORK+31          REPLACE MONTH                                
         CLC   WORK+30(3),WORK+33  REQUEST PERIOD DONE?                         
         BNH   SHED0272            YES - DO PRIOR PERIOD                        
*                                                                               
**>> PRIOR PERIOD                                                               
         EJECT                                                                  
* TEST IF REPORT WILL PRINT QUARTERLY TOTALS *                                  
         SPACE 1                                                                
SHED0288 EQU   *                                                                
*                                                                               
*   TEST                                                                        
***      MVC   P+1(15),=C'WEEK ARRAY    :'                                      
***      MVC   P+20(48),RPCURWKS                                                
***      GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         MVI   RPQTRS,0                                                         
*                                                                               
         CLI   RPTOTOPT,C'C'       TEST CURRENT MONTH ONLY                      
         BE    SHED0296                                                         
         CLI   RPTOTOPT,C'T'       TEST TOTALS ONLY                             
         BE    SHED0296                                                         
         CLI   RPTOTOPT,C'Q'       TEST QUARTERS ONLY                           
         BE    SHED0292                                                         
*                                                                               
         ZIC   R0,STARTMON         GET START MONTH                              
         BCTR  R0,0                                                             
         SRDL  R0,32                                                            
         D     R0,=F'3'                                                         
         LTR   R0,R0               TEST REMAINDER                               
         BNZ   SHED0296                                                         
         ZIC   R1,ENDMON                                                        
         D     R0,=F'3'                                                         
         LTR   R0,R0                                                            
         BNZ   SHED0296                                                         
         OC    QWMONADJ,QWMONADJ   TEST ACROSS YEARS                            
         BNZ   SHED0292            YES - MUST BE MORE THAN ONE QTR              
         IC    R1,ENDMON                                                        
         IC    R0,STARTMON                                                      
         SR    R1,R0                                                            
         C     R1,=F'3'                                                         
         BNH   SHED0296                                                         
*                                                                               
SHED0292 MVI   RPQTRS,C'Y'                                                      
*                                                                               
SHED0296 XIT1                                                                   
*                                                                               
         EJECT                                                                  
* SUBROUTINE TO SPLIT ROW/COL TITLES.                                           
* ON ENTRY R1 HAS HEADLINE ADDRESS                                              
*          R4 HAS TITLE ADDRESS                                                 
*          R5 HAS TITLE LENGTH                                                  
*          HALF(1) HAS PRINT LINE WIDTH                                         
*          HALF+1(1) HAS L/C/R FOR ALIGNMENT                                    
         SPACE 1                                                                
SPLT     NTR1                                                                   
*                                                                               
         XC    MID1,MID1                                                        
         XC    MID2,MID2                                                        
*                                                                               
         STC   R5,MID2             SET ORIGINAL DATA LENGTH                     
         LA    RE,MID2+1                                                        
*                                                                               
SPHE0020 MVC   0(1,RE),0(R4)                                                    
         LA    RE,1(RE)                                                         
         LA    R4,1(R4)                                                         
         CLI   0(R4),C','                                                       
         BE    SPHE0040                                                         
         BCT   R5,SPHE0020                                                      
         B     SPHE0080                                                         
*                                                                               
SPHE0040 MVC   MID1,MID2                                                        
         LA    RF,MID2+1           GET ORIGINAL 'TO' ADDRESS                    
         SR    RE,RF                                                            
         STC   RE,MID1             SAVE ACTUAL DATA LENGTH                      
         XC    MID2,MID2           RE-CLEAR                                     
*                                                                               
         LR    RF,R5                                                            
         SH    RF,=H'2'            -2 GIVES ACTUAL DATA LEN                     
         STC   RF,MID2             SET IT                                       
         BCTR  RF,0                SET FOR EX                                   
         EX    RF,SPHE0060                                                      
         B     SPHE0080                                                         
SPHE0060 MVC   MID2+1(0),1(R4)                                                  
*                                                                               
SPHE0080 OC    MID1+1(131),SPACES                                               
         OC    MID2+1(131),SPACES                                               
         CLI   HALF+1,C'L'         TEST LEFT ALIGN                              
         BE    SPHE0100                                                         
         CLI   HALF+1,C'S'         TEST LEFT ALIGN/STAGGER                      
         BNE   SPHE0180                                                         
* LEFT ALIGN * LEFT ALIGN/STAGGER                                               
SPHE0100 EQU   *                                                                
         ZIC   RE,HALF                                                          
         BCTR  RE,0                                                             
         CLI   HALF+1,C'S'         TEST LEFT ALIGN/STAGGER                      
         BE    SPHE0120            STAGGER: ONLY PUT OUT 1 LINE                 
         EX    RE,SPHE0140                                                      
SPHE0120 EQU   *                                                                
         EX    RE,SPHE0160                                                      
         B     SPHE0260                                                         
*                                                                               
SPHE0140 MVC   0(0,R1),MID1+1                                                   
SPHE0160 MVC   132(0,R1),MID2+1                                                 
         EJECT                                                                  
SPHE0180 CLI   HALF+1,C'C'         TEST CENTER                                  
         BNE   SPHE0220                                                         
         SPACE 1                                                                
* CENTER *                                                                      
         SPACE 1                                                                
         ZIC   RE,HALF             GET PRINT LINE WIDTH                         
         SR    R0,R0                                                            
         ICM   R0,1,MID1           GET MID1 DATA LENGTH                         
         BZ    SPHE0200                                                         
         SR    RE,R0                                                            
         LA    RE,1(RE)                                                         
         SRL   RE,1                DIVIDE BY 2 AND ROUND                        
         LA    RF,0(R1,RE)                                                      
*                                                                               
         IC    RE,MID1             GET LENGTH AGAIN                             
         BCTR  RE,0                                                             
         EX    RE,SPHE0280                                                      
*                                                                               
SPHE0200 ZIC   RE,HALF             GET PRINT LINE WIDTH                         
         SR    R0,R0                                                            
         ICM   R0,1,MID2           GET MID2 DATA LENGTH                         
         SR    RE,R0                                                            
         LA    RE,1(RE)                                                         
         SRL   RE,1                DIVIDE BY 2 AND ROUND                        
         LA    RF,0(R1,RE)                                                      
*                                                                               
         IC    RE,MID2             GET LENGTH AGAIN                             
         BCTR  RE,0                                                             
         EX    RE,SPHE0300                                                      
         B     SPHE0260                                                         
         EJECT                                                                  
* RIGHT ALIGN *                                                                 
         SPACE 1                                                                
SPHE0220 ZIC   RE,HALF             GET PRINT LINE WIDTH                         
         SR    R0,R0                                                            
         ICM   R0,1,MID1           GET MID1 DATA LENGTH                         
         BZ    SPHE0240                                                         
         SR    RE,R0                                                            
         LA    RF,0(R1,RE)                                                      
*                                                                               
         IC    RE,MID1             GET LENGTH AGAIN                             
         BCTR  RE,0                                                             
         EX    RE,SPHE0280                                                      
*                                                                               
SPHE0240 ZIC   RE,HALF             GET PRINT LINE WIDTH                         
         SR    R0,R0                                                            
         ICM   R0,1,MID2           GET MID2 DATA LENGTH                         
         SR    RE,R0                                                            
         LA    RF,0(R1,RE)                                                      
*                                                                               
         IC    RE,MID2             GET LENGTH AGAIN                             
         BCTR  RE,0                                                             
         EX    RE,SPHE0300                                                      
*                                                                               
SPHE0260 MVC   MID1,SPACES                                                      
         MVC   MID2,SPACES                                                      
         B     SHED0296                                                         
*                                                                               
SPHE0280 MVC   0(0,RF),MID1+1                                                   
SPHE0300 MVC   132(0,RF),MID2+1                                                 
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*  ROUTINE TO PASS AGGREGATE VALUES TO ACTIVE REPORT                            
*    GENERAL DESCRIPTION:                                                       
*    DATA IS DEVELOPED FOR TWO REPORTS, THE 1ST OF WHICH IS MARKED              
*      AGGBASE, AND THE SECOND AGGREG.  EACH SPEC INDICATES HOW MANY            
*      ROWS OF KEY STRUCTURE ARE THE SAME.  THE DATA IS CONSTRUCTED             
*      SO THAT THE KEY STRUCTURE OF THE AGGREG SPEC CONTAINS A ZERO             
*      IN THE LAST POSITION OF THE LAST ROW.  THIS ENSURES THAT THE             
*      AGGREG DATA SORTS FIRST.  AS THE DATA IS BROUGHT IN, IT IS               
*      EXAMINED.  IF IT IS AGGREG, THE WHOLE RECORD IS SAVED, AND THE           
*      NEXT RECORD IS RETRIEVED.  IF IT IS AGGBAS, IT IS COMPARED               
*      WITH THE SAVED RECORD TO SEE IF THE KEYS ARE THE SAME.  IF SO,           
*      VALUES IN THE SAVED RECORD ARE TRANSFERRED TO THE ACTIVE                 
*      RECORD.                                                                  
*                                                                               
         DS    0F                                                               
AGGRTEST NMOD1 0,*AGGREG*                                                       
         L     RC,0(R1)                                                         
         L     R2,4(R1)            RPDATA WORKAREA                              
         L     RF,12(R1)           TEST FLAG:  ESTTOTAL ONLY?                   
         LTR   RF,RF               ESTTOTAL ONLY IF NON=ZERO                    
         BNZ   AGGR0120            YES - ESTTOTAL ONLY - GO DO IT               
         L     R3,8(R1)            NO  - ACTIVE REPORT RECORD                   
         ST    R3,AACTIVE          SAVE A(ACTIVE RECORD)                        
*                                                                               
         USING TSARD,R5                                                         
*                                                                               
         L     R5,ATSARDWA         SET A(TSAR CONTROL BLOCK)                    
         LA    R5,TSARDL+2(R5)     CONTROL BLOCK FOR AGGREG IS SECOND           
*                                     KEEP ON FULL-WORD BOUNDARY                
         LA    RE,AGGRBUF          CLEAR BUFFER RECORD                          
         LH    RF,=Y(L'AGGRBUF)                                                 
         XCEFL                                                                  
         LA    RF,AGGRBUF          SET A(BUFFER READ AREA)                      
         ST    RF,TSAREC                                                        
         ZIC   RF,RPAGGBAS         #ROWS TO COMPARE                             
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                REMOVE LAST POS, LAST ROW                    
         BCTR  RF,0                REMOVE 1 FOR EX STATEMENT                    
         ST    RF,FULL             SAVE COMPARISON LENGTH                       
         EX    RF,AGGR0160         MOVE ACTIVE RECORD TO TSAR KEY               
         GOTO1 TESTABRK            INTERRUPTED KEY TEST: PART 1                 
*                                                                               
*   TEST                                                                        
*        CLC   =C'AGGKEYS',QUESTOR                                              
*        BNE   AGGR0010                                                         
*        MVC   P+1(15),=C'AGG KEY SOUGHT:'                                      
*        MVC   P+20(60),AGGRBUF                                                 
*        GOTO1 REPORT                                                           
AGGR0010 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         LA    R4,AGGRBUF          A(TSAR RDA)                                  
         MVI   TSOFFACT,TSARDH     SET TO READ HIGH                             
         GOTO1 ATSAROFF,(R5)                                                    
         TM    TSERRS,TSEEOF       END OF FILE (REC NOT FOUND)?                 
         BO    AGGR0030            YES                                          
*                                                                               
*   TEST                                                                        
*        CLC   =C'AGGKEYS',QUESTOR                                              
*        BNE   AGGR0020                                                         
*        MVC   P+1(15),=C'AGG KEY FOUND :'                                      
*        MVC   P+20(60),AGGRBUF                                                 
*        GOTO1 REPORT                                                           
AGGR0020 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         GOTO1 TESTABR2            INTERRUPTED KEY TEST: PART 2                 
         L     RF,FULL                                                          
         EX    RF,AGGR0140         COMPARE KEYS                                 
         BE    AGGR0040            EQUAL - LOAD FROM AGGREG TO BASE             
AGGR0030 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        CLC   =C'AGGKEYS',QUESTOR                                              
*        BNE   AGGR0035                                                         
*        LR    RE,R3                                                            
*        LA    RE,RGDTADSP(RE)                                                  
*        MVC   P+1(5),=C'PRE :'                                                 
*        MVC   P+10(RGDTALEN),0(RE)                                             
*        GOTO1 REPORT                                                           
AGGR0035 EQU   *                                                                
*   END   TEST                                                                  
*                                                                               
*                                  NOT EQUAL                                    
         XC    AGGCOMP,AGGCOMP                                                  
         XC    AGGCOUNT,AGGCOUNT                                                
         XC    AGGRBUF,AGGRBUF     CLEAR TO ZERO                                
         B     AGGR0060               TO SET ACTIVE REC FIELDS                  
*                                                                               
*   NO MATCH:  AGGREGATE RECORD IS UNMATCHED.  TABLE IS NOW POINTING            
*    TO AN AGGREGATE RECORD WITH ZEROS.  AGGREGATE RECORD IS USED TO            
*    SET CORRESPONDING ACTIVE FIELDS TO ZERO.                                   
*                                                                               
AGGR0040 EQU   *                                                                
         GOTO1 AGGKEYCT            SET COUNTER FOR THIS KEY                     
         LA    R4,RGDTADSP(R4)     DISPLACE TO DATA: AGGREG RECORD              
AGGR0060 EQU   *                                                                
         LA    R3,RGDTADSP(R3)     DISPLACE TO DATA: ACTIVE RECORD              
         SR    R7,R7                                                            
         ZIC   R0,RPCOLS           ACTUAL # COLS, THIS REPORT                   
*                                                                               
*   FOR A 'PENDING' REPORT, AN EXTRA 'FORCE ROW' COLUMN MUST BE                 
*    INCLUDED AS THE LAST COLUMN.  THIS WILL ENSURE THAT THE                    
*    ROW IS PRINTED.  THE NUMBER OF COLUMNS IS THEREFORE DECREASED              
*    BY 1, TO ONLY LOAD THE ACTIVE COLUMNS.  IF THE RESULT IS ZERO,             
*    THE SPEC IS IN ERROR.                                                      
*                                                                               
         TM    RPFLAGS,X'01'       'PENDING' REPORT?                            
         BNO   AGGR0080            NO                                           
         BCTR  R0,0                YES - LEAVE LAST COLUMN AS IS                
         LTR   R0,R0               ARE THERE ANY COLUMNS NOW?                   
         BNZ   AGGR0080            YES - PROCEED                                
         DC    H'0'                NO  - SPEC WRONG                             
AGGR0080 EQU   *                                                                
         L     R6,RPCOLDEF+4(R7)   FIRST COLUMN DEFINITION ADDRESS              
         CLI   6(R6),41            AGGBAS 'FORCE ROW' COLUMN?                   
         BE    AGGR0090            YES - MOVE DATA                              
         CLI   6(R6),70            AGGBAS 'FORCE ROW/REPLACE' COLUMN?           
         BE    AGGR0090            YES - MOVE DATA                              
         CLI   6(R6),59            AGGBAS 'EST TOTL FORCE ROW' COLUMN?          
         BNE   AGGR0100            NO  - DON'T MOVE DATA                        
AGGR0090 EQU   *                                                                
         MVC   0(4,R3),0(R4)       YES - MOVE AGGREG TO ACTIVE                  
AGGR0100 EQU   *                                                                
         LA    R3,4(R3)            BUMP TO                                      
         LA    R4,4(R4)               NEXT COLUMN                               
         LA    R7,4(R7)            BUMP TO NEXT COL DEFINITION                  
         BCT   R0,AGGR0080         CHECK NEXT ROW                               
*                                                                               
*   TEST                                                                        
*        CLC   =C'AGGKEYS',QUESTOR                                              
*        BNE   AGGR0120                                                         
*        L     R3,AACTIVE          RESET A(ACTIVE RECORD)                       
*        LA    R3,RGDTADSP(R3)     DISPLACE TO DATA: ACTIVE RECORD              
*        MVC   P+1(5),=C'POST:'                                                 
*        MVC   P+10(RGDTALEN),0(R3)                                             
*        GOTO1 REPORT                                                           
*   END   TEST                                                                  
*                                                                               
AGGR0120 EQU   *                                                                
         GOTO1 ESTTOTAL            CALCULATE ESTIMATE TOTAL $$                  
         XIT1                                                                   
AGGR0140 CLC   0(0,R3),0(R4)       AGGREGATE RECORD VS ACTIVE                   
*                                                                               
AGGR0160 MVC   AGGRBUF(0),0(R3)    MOVE ACTIVE KEY FOR COMPARE                  
*                                     LENGTH TO TSAR KEY                        
AGGRBUF  DS    CL(RRGRECSZ)                                                     
*                                                                               
         EJECT                                                                  
*                                                                               
*   ROUTINE CHECKS TO SEE IF AN INTERRUPTED SORT SEQUENCE IS BEING              
*      PROCESSED.  IF IT IS, THEN THE CORRESPONDING FIELD MUST BE               
*      ZEROED IN THE KEY FOR TABLE ENTRY, SO THAT A TABLE ACCESS                
*      MAY BE DONE.                                                             
*                                                                               
TESTABRK NTR1                                                                   
         LA    R3,AGGRBUF          A(TSAR KEY AREA)                             
         ZIC   RF,RPAGGTAB         INTERRUPTED SORT SEQUENCE?                   
         LTR   RF,RF                                                            
         BZ    TABR0040            NO  - FINISHED                               
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            YES - MULTIPLY # ROWS BY WIDTH FOR           
*                                     DISPLACEMENT TO BREAK FIELD.              
         AR    R3,RF                                                            
         XC    0(9,R3),0(R3)       CLEAR INTERRUPTED KEY FIELD                  
*                                     FOR TSAR LOOKUP                           
TABR0040 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*                                                                               
*   ROUTINE CHECKS TO SEE IF AN INTERRUPTED SORT SEQUENCE IS BEING              
*      PROCESSED.  IF IT IS, THEN THE CORRESPONDING FIELD MUST BE               
*      PLUGGED INTO THE TABLE ENTRY, SO THAT A COMPLETE COMPARISON              
*      MAY BE DONE.                                                             
*                                                                               
TESTABR2 NTR1                                                                   
         LA    R4,AGGRBUF          A(TSAR KEY AREA)                             
         ZIC   RF,RPAGGTAB         INTERRUPTED SORT SEQUENCE?                   
         LTR   RF,RF                                                            
         BZ    TAB20040            NO  - FINISHED                               
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            YES - MULTIPLY # ROWS BY WIDTH FOR           
*                                     DISPLACEMENT TO BREAK FIELD.              
         AR    R4,RF                                                            
         AR    R3,RF               DISPLACE TO BREAK FIELD                      
         MVC   0(9,R4),0(R3)       INSERT BREAK ROW DATA INTO ITEM              
*                                     TAKEN FROM TABLE                          
TAB20040 EQU   *                                                                
*                                                                               
*   START TEST                                                                  
*        MVC   P+1(4),=C'AGG:'                                                  
*        MVC   P+11(72),AGGCOMP                                                 
*        MVC   P+85(4),=C'CT= '                                                 
*        MVC   P+90(1),AGGCOUNT                                                 
*        GOTO1 REPORT                                                           
*   END   TEST                                                                  
*                                                                               
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
*                                                                               
*   ROUTINE CLEARS INTERRUPTED SORT SEQUENCE, IF PROCESSED, AND                 
*      THEN COMPARES KEY AGAINST SAVED KEY.  IF NEW, KEY IS SAVED,              
*      COUNTER IS SET TO ZERO.  IF NOT NEW, COUNTER IS SET TO NON-              
*      ZERO.  THIS COUNTER IS THEN USED DURING THE POST OF THIS                 
*      RECORD TO DETERMINE IF 'FORCED' FIELDS (THOSE PASSED IN FROM             
*      MERGED DATA) HAVE BEEN POSTED ONCE, AND ONLY ONCE!!!                     
*                                                                               
AGGKEYCT NTR1                                                                   
         LA    R4,AGGRBUF          A(TSAR KEY AREA)                             
         ZIC   RF,RPAGGTAB         INTERRUPTED SORT SEQUENCE?                   
         LTR   RF,RF                                                            
         BZ    AGGK0040            NO  - GO CHECK KEY                           
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            YES - MULTIPLY # ROWS BY WIDTH FOR           
*                                     DISPLACEMENT TO BREAK FIELD.              
         AR    R4,RF                                                            
         AR    R3,RF               DISPLACE TO BREAK FIELD                      
         XC    0(9,R4),0(R3)       CLEAR BREAK ROW DATA FIELD                   
*                                     AND CHECK KEY                             
AGGK0040 EQU   *                                                                
         CLC   AGGRBUF(RGKEYLEN),AGGCOMP                                        
*                                  KEY PREVIOUSLY USED?                         
         BE    AGGK0080            YES - SET COUNTER TO NON-ZERO                
         MVC   AGGCOMP(RGKEYLEN),AGGRBUF                                        
*                                  NO  - SAVE KEY                               
         XC    AGGCOUNT,AGGCOUNT   CLEAR COUNTER                                
         B     AGGK0120                                                         
AGGK0080 EQU   *                                                                
         MVI   AGGCOUNT,1          SET KEY TO NON-ZERO                          
AGGK0120 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
*                                                                               
*   ESTTOTAL:  SCAN ACTIVE RECORD, LOOKING FOR ESTIMATE TOTAL $$.               
*     IF PRESENT, SCAN LOOKING FOR CURRENT STN FC $$.  IF FOUND,                
*     ADD CURRENT STN FC $$ TO ESTIMATE TOTAL $$, WHICH CONTAINS                
*     CURRENT BOOKED $$ AT THIS TIME.  IF NO CURRENT STN FC $$                  
*     IN SPEC, BOOKED $$ ARE DELIVERED.  NOTE:  EST TOTAL $$ MAY                
*     BE INDICATED BY 'ESTT' (9,58) OR 'FEST' (9,59) COLUMN,                    
*     DEPENDING ON WHETHER THE DATA WAS GENERATED WITHIN A SINGLE               
*     REPORT, OR AGGREGATED FROM A SECOND REPORT.                               
*                                                                               
ESTTOTAL NTR1                                                                   
         L     R3,AACTIVE          RESET A(ACTIVE RECORD)                       
         LA    R3,RGDTADSP(R3)     DISPLACE TO DATA                             
         SR    R7,R7                                                            
         ZIC   R0,RPCOLS           ACTUAL # COLS, THIS REPORT                   
ESTO0020 EQU   *                                                                
         L     R6,RPCOLDEF+4(R7)   LOAD COLUMN DEFINITION                       
         CLI   6(R6),58            'ESTT' COLUMN?                               
         BE    ESTO0060            YES -                                        
         CLI   6(R6),59            'FEST' COLUMN?                               
         BE    ESTO0060            YES                                          
         LA    R3,4(R3)            BUMP TO NEXT COLUMN                          
         LA    R7,4(R7)            BUMP TO NEXT COLUMN DEFINITION               
         BCT   R0,ESTO0020         GO BACK FOR NEXT                             
         B     ESTO0120            NO ESTIMATE TOTAL - EXIT                     
ESTO0060 EQU   *                                                                
         L     R4,AACTIVE          RESET A(ACTIVE RECORD)                       
         LA    R4,RGDTADSP(R4)     DISPLACE TO DATA                             
         SR    R7,R7                                                            
         ZIC   R0,RPCOLS           ACTUAL # COLS, THIS REPORT                   
ESTO0080 EQU   *                                                                
         L     R6,RPCOLDEF+4(R7)   LOAD COLUMN DEFINITION                       
         CLI   6(R6),44            'CFOR' COLUMN?                               
         BE    ESTO0100            YES -                                        
         LA    R4,4(R4)            BUMP TO NEXT COLUMN                          
         LA    R7,4(R7)            BUMP TO NEXT COLUMN DEFINITION               
         BCT   R0,ESTO0080         GO BACK FOR NEXT                             
         B     ESTO0120            NO CURR STN FORECAST $$ - EXIT               
ESTO0100 EQU   *                                                                
*                                  NOW, R3 POINTS TO EST TOT $$                 
*                                       R4 POINTS TO CURR STN $$                
         L     RF,0(R3)            ADD TWO VALUES                               
         A     RF,0(R4)                                                         
         ST    RF,0(R3)            PUT IT BACK                                  
ESTO0120 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         DROP  R2,R5                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*  ROUTINE TO PASS SPL AS-RUN VALUES TO ACTIVE REPORT                           
*    GENERAL DESCRIPTION:                                                       
*    DATA IS DEVELOPED FOR AN ADDITIONAL REPORT.  THE 1ST IS MARKED             
*      AGGBASE, AND THE ADD'L AGGSPL.  ROW STRUCTURE FUNCTIONS SAME             
*      AS AGGREG/AGGBAS.  THE REPORT WILL HAVE A COLUMN 'SPLC' (CODE            
*      09,52) AND/OR 'SPLP' (CODE 09/53).  FOR 'SPLC', A PERCENT WILL           
*      BE CALCULATED BY USING THE FIRST TWO COLUMNS OF THE SPL AS-RUN           
*      RECORD.  'SPLP' WILL USE THE THIRD AND FOURTH COLUMNS, ETC, FOR          
*      SPLT, SPLE, AND SPLL.                                                    
*                                                                               
         DS    0F                                                               
SPLASRUN NMOD1 0,*ASRUN*                                                        
         L     RC,0(R1)                                                         
         L     R2,4(R1)            RPDATA WORKAREA                              
         USING RPSPECD,R2                                                       
         L     R3,8(R1)            ACTIVE REPORT RECORD                         
*                                                                               
         USING TSARD,R5                                                         
*                                                                               
         L     R5,ATSARDWA         SET A(TSAR CONTROL BLOCK)                    
*                                     SPL IS FIRST CONTROL BLOCK                
         LA    RE,SPLBUFF          CLEAR BUFFER RECORD                          
         LH    RF,=Y(L'SPLBUFF)                                                 
         XCEFL                                                                  
         LA    RF,SPLBUFF          SET A(BUFFER READ AREA)                      
         ST    RF,TSAREC                                                        
         ZIC   RF,RPAGGBAS         #ROWS TO COMPARE                             
         ZIC   RE,RPMISFLG+3       SPL ROW COMPARE ADJUSTMENT?                  
         LTR   RE,RE               ANY VALUE?                                   
         BZ    SPLA0005            NO                                           
         AR    RF,RE               YES - ADD IT TO # ROWS TO COMPARE            
SPLA0005 EQU   *                                                                
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  RF,0                REMOVE LAST POS, LAST ROW                    
         BCTR  RF,0                REMOVE 1 FOR EX STATEMENT                    
         ST    RF,FULL             SAVE COMPARISON LENGTH                       
         EX    RF,SPLA0160         MOVE ACTIVE RECORD TO TSAR KEY               
         GOTO1 TESTSBRK            INTERRUPTED KEY TEST: PART 1                 
*                                                                               
*   TEST                                                                        
         CLC   =C'SPLKEYS',QUESTOR                                              
         BNE   SPLA0010                                                         
         MVC   P+1(15),=C'SPL KEY SOUGHT:'                                      
         MVC   P+20(60),SPLBUFF                                                 
         GOTO1 REPORT                                                           
SPLA0010 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         MVI   TSOFFACT,TSARDH     SET TO READ HIGH                             
         GOTO1 ATSAROFF,(R5)                                                    
*                                                                               
         TM    TSERRS,TSEEOF       END OF FILE (REC NOT FOUND)?                 
         BO    SPLA0120            YES - FINISHED                               
*                                                                               
*                                                                               
*   TEST                                                                        
         CLC   =C'SPLKEYS',QUESTOR                                              
         BNE   SPLA0020                                                         
         MVC   P+1(15),=C'SPL KEY FOUND :'                                      
         MVC   P+20(60),SPLBUFF                                                 
         GOTO1 REPORT                                                           
SPLA0020 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         GOTO1 TESTSBR2            INTERRUPTED KEY TEST: PART 2                 
         LA    R4,SPLBUFF          A(TSAR RDA)                                  
         L     RF,FULL                                                          
         EX    RF,SPLA0140         KEY FOUND IN TABLE?                          
         BE    SPLA0040            YES - LOAD FROM AGGREG TO BASE               
         XC    SPLBUFF,SPLBUFF     NO  - CLEAR BASE INDICATOR VALUES            
*                                     (THESE MAY BE, IE, X'FFFFFFFF'            
*                                     WHICH CAN'T BE TOTALLED, ETC)             
         B     SPLA0050                                                         
*                                                                               
SPLA0040 EQU   *                                                                
         GOTO1 SPLKEYCT            SET COUNTER FOR THIS KEY                     
SPLA0050 EQU   *                                                                
         LA    R4,SPLBUFF          SET A(TABLE RECORD)                          
         LA    R3,RGDTADSP(R3)     DISPLACE TO DATA: ACTIVE RECORD              
         LA    R4,RGDTADSP(R4)     DISPLACE TO DATA: SPL AS-RUN REC             
*                                                                               
*   TEST                                                                        
         CLC   =C'SPLKEYS',QUESTOR                                              
         BNE   SPLA0042                                                         
         MVC   P+1(15),=C'DATA IN RECORD:'                                      
         MVC   P+20(64),0(R4)                                                   
         GOTO1 REPORT                                                           
SPLA0042 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         SR    R7,R7                                                            
         ZIC   R0,RPCOLS           ACTUAL # COLS, THIS REPORT                   
*                                                                               
SPLA0060 EQU   *                                                                
         L     R6,RPCOLDEF+4(R7)   FIRST COLUMN DEFINITION ADDRESS              
         CLI   6(R6),52            AGGBAS 'SPLC' COLUMN?                        
         BNE   SPLA0080            NO  -                                        
         LA    RF,0(R4)            YES - GET ADDR(SPL AS-RUN CURRENT)           
         ST    RF,DUB              A(SPLBUFF RECORD)                            
         MVC   0(4,R3),DUB         INSERT INTO DATA RECORD                      
*                                                                               
*   START TEST                                                                  
*        ST    R0,SVR0REG          SAVE LOOP CONTROL                            
*        MVC   P(10),=C'CURR ADDR:'                                             
*        GOTO1 HEXOUT,DMCB,DUB,P+15,4,=C'TOG'                                   
*        EDIT  (4,0(R4)),(8,P+25)                                               
*        EDIT  (4,4(R4)),(8,P+35)                                               
*        GOTO1 REPORT                                                           
*        L     R0,SVR0REG          RESTORE LOOP CONTROL                         
*   END   TEST                                                                  
*                                                                               
         B     SPLA0100                                                         
SPLA0080 EQU   *                                                                
         CLI   6(R6),53            AGGBAS 'SPLP' COLUMN?                        
         BNE   SPLA0090            NO  -                                        
         LA    RF,8(R4)            YES - GET ADDR(SPL AS-RUN PRIOR)             
         ST    RF,DUB                                                           
         MVC   0(4,R3),DUB         INSERT INTO DATA RECORD                      
         B     SPLA0100                                                         
SPLA0090 EQU   *                                                                
         CLI   6(R6),62            AGGBAS 'SPLT' COLUMN?                        
         BNE   SPLA0095            NO  -                                        
         LA    RF,16(R4)           YES - GET ADDR(SPL AS-RUN THIS WK)           
         ST    RF,DUB                                                           
         MVC   0(4,R3),DUB         INSERT INTO DATA RECORD                      
         B     SPLA0100                                                         
SPLA0095 EQU   *                                                                
         CLI   6(R6),63            AGGBAS 'SPLE' COLUMN?                        
         BNE   SPLA0100            NO  -                                        
         LA    RF,24(R4)           YES - GET ADDR(SPL AS-RUN ESTIMATED)         
         ST    RF,DUB                                                           
         MVC   0(4,R3),DUB         INSERT INTO DATA RECORD                      
         B     SPLA0105                                                         
SPLA0100 EQU   *                                                                
         CLI   6(R6),76            AGGBAS 'SPLL' COLUMN?                        
         BNE   SPLA0105            NO  -                                        
         LA    RF,32(R4)           YES - GET ADDR(SPL AS-RUN LST WK)            
         ST    RF,DUB                                                           
         MVC   0(4,R3),DUB         INSERT INTO DATA RECORD                      
         B     SPLA0105                                                         
SPLA0105 EQU   *                                                                
         LA    R3,4(R3)            BUMP TO NEXT ACTIVE COLUMN                   
         LA    R7,4(R7)            BUMP TO NEXT COL DEFINITION                  
         BCT   R0,SPLA0060         CHECK NEXT ROW                               
SPLA0120 EQU   *                                                                
*                                                                               
*   START TEST                                                                  
*        MVC   P+1(4),=C'SPL:'                                                  
*        MVC   P+11(72),SPLCOMP                                                 
*        MVC   P+85(4),=C'CT= '                                                 
*        MVC   P+90(1),SPLCOUNT                                                 
*        GOTO1 REPORT                                                           
*   END   TEST                                                                  
*                                                                               
         XIT1                                                                   
SPLA0140 CLC   0(0,R3),0(R4)       AGGREGATE RECORD VS ACTIVE                   
*                                                                               
SPLA0160 MVC   SPLBUFF(0),0(R3)    MOVE ACTIVE KEY TO TSAR BUFFER               
*                                                                               
SPLBUFF  DS    CL(RRGRECSZ)                                                     
*                                                                               
         DROP  R5                                                               
         EJECT                                                                  
*                                                                               
*   ROUTINE CHECKS TO SEE IF AN INTERRUPTED SORT SEQUENCE IS BEING              
*      PROCESSED.  IF IT IS, THEN THE CORRESPONDING FIELD MUST BE               
*      ZEROED IN THE KEY FOR TABLE ENTRY, SO THAT A TABLE ACCESS                
*      MAY BE DONE.                                                             
*                                                                               
TESTSBRK NTR1                                                                   
         LA    R3,SPLBUFF          SET A(TSAR BUFFER)                           
         ZIC   RF,RPAGGTAB         INTERRUPTED SORT SEQUENCE?                   
         LTR   RF,RF                                                            
         BZ    TSBR0040            NO  - FINISHED                               
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            YES - MULTIPLY # ROWS BY WIDTH FOR           
*                                     DISPLACEMENT TO BREAK FIELD.              
         AR    R3,RF                                                            
         XC    0(9,R3),0(R3)       CLEAR INTERRUPTED KEY FIELD                  
*                                     FOR TSAR LOOKUP                           
TSBR0040 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*   ROUTINE CHECKS TO SEE IF AN INTERRUPTED SORT SEQUENCE IS BEING              
*      PROCESSED.  IF IT IS, THEN THE CORRESPONDING FIELD MUST BE               
*      INSERTED INTO RECORD FROM TABLE, SO THAT A COMPARISON                    
*      MAY BE DONE.                                                             
*                                                                               
TESTSBR2 NTR1                                                                   
         LA    R4,SPLBUFF          SET A(TSAR BUFFER)                           
         ZIC   RF,RPAGGTAB         INTERRUPTED SORT SEQUENCE?                   
         LTR   RF,RF                                                            
         BZ    TSB20040            NO  - FINISHED                               
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            YES - MULTIPLY # ROWS BY WIDTH FOR           
*                                     DISPLACEMENT TO BREAK FIELD.              
         AR    R3,RF                                                            
         AR    R4,RF               DISPLACE TO BREAK FIELD                      
         MVC   0(9,R4),0(R3)       INSERT BREAK FIELD INTO TABLE                
*                                     ENTRY                                     
TSB20040 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   ROUTINE CLEARS INTERRUPTED SORT SEQUENCE, IF PROCESSED, AND                 
*      THEN COMPARES KEY AGAINST SAVED KEY.  IF NEW, KEY IS SAVED,              
*      COUNTER IS SET TO ZERO.  IF NOT NEW, COUNTER IS SET TO NON-              
*      ZERO.  THIS COUNTER IS THEN USED DURING THE POST OF THIS                 
*      RECORD TO DETERMINE IF 'FORCED' FIELDS (THOSE PASSED IN FROM             
*      MERGED DATA) HAVE BEEN POSTED ONCE, AND ONLY ONCE!!!                     
*                                                                               
SPLKEYCT NTR1                                                                   
         LA    R4,SPLBUFF          A(TSAR KEY AREA)                             
         ZIC   RF,RPAGGTAB         INTERRUPTED SORT SEQUENCE?                   
         LTR   RF,RF                                                            
         BZ    SPLK0040            NO  - GO CHECK KEY                           
         LA    RF,1(RF)            ADD 1 FOR CONTROL ROW                        
         MH    RF,=H'9'            YES - MULTIPLY # ROWS BY WIDTH FOR           
*                                     DISPLACEMENT TO BREAK FIELD.              
         AR    R4,RF                                                            
         AR    R3,RF               DISPLACE TO BREAK FIELD                      
         XC    0(9,R4),0(R3)       CLEAR BREAK ROW DATA FIELD                   
*                                     AND CHECK KEY                             
SPLK0040 EQU   *                                                                
         CLC   SPLBUFF(RGKEYLEN),SPLCOMP                                        
*                                  KEY PREVIOUSLY USED?                         
         BE    SPLK0080            YES - SET COUNTER TO NON-ZERO                
         MVC   SPLCOMP(RGKEYLEN),SPLBUFF                                        
*                                  NO  - SAVE KEY                               
         XC    SPLCOUNT,SPLCOUNT   CLEAR COUNTER                                
         B     SPLK0120                                                         
SPLK0080 EQU   *                                                                
         MVI   SPLCOUNT,1          SET KEY TO NON-ZERO                          
SPLK0120 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         DROP R2                                                                
         EJECT                                                                  
*                                                                               
*    SCANCOL:   SCAN MONTHLY BUCKETS FOR THIS COLUMN.  IF A NON-                
*        ZERO VALUE ENCOUNTERED, RETURN A NON-ZERO CC, TO INDICATE              
*        THAT ARRAY MUST BE PRINTED.                                            
*                                                                               
*        R1  ->  ROW MONTH DATA                                                 
*        RF  ->  ROW MONTH TOTALS                                               
*                                                                               
SCANCOL  NMOD1 0,*SCOL*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R7,4(R1)            RESET BUCKET INDEX                           
         L     RF,SVRFREG          RESET A(TOTAL ROW FOR COLUMN)                
         LA    RE,TOTROWLN*13      CALCULATE FIRST MONTH (PRIOR MON)            
*                                     ADDR FOR COLUMN                           
         SR    RF,RE               BACK UP TO 'PRIOR MONTH' BUCKET              
         LA    R0,13               SET LOOP CONTROL                             
SCOL0020 EQU   *                                                                
         L     R6,0(RF,R7)         LOAD TOTL FOR MONTH/COL                      
         LTR   R6,R6               ANY VALUE?                                   
         BNZ   SCOL0120            YES - PROCESS THIS LEVEL                     
         LA    RF,TOTROWLN(RF)     NO  - BUMP TO NEXT BUCKET                    
         BCT   R0,SCOL0020         GO BACK FOR NEXT BUCKET                      
         SR    R0,R0               NO VALUE - SET CC ZERO                       
         B     SCOL0160                                                         
SCOL0120 EQU   *                                                                
         LTR   RB,RB               SET CC NOT ZERO                              
SCOL0160 EQU   *                                                                
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*    SPLACCUM:   SPL ACCUMULATION ROUTINE:                                      
*        R6  ->  COLUMN DEFINITION                                              
*        R1  ->  ROW MONTH DATA                                                 
*        RF  ->  ROW MONTH TOTALS                                               
*                                                                               
SPLACCUM NMOD1 0,*SPAC*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R6,4(R1)                                                         
         L     R1,SVR1REG                                                       
         L     RF,SVRFREG                                                       
         LA    R7,TOTRSPLC         DISP TO SPL CURRENT                          
         CLI   6(R6),52            'SPL CURRENT' COLUMN?                        
         BE    SPAC0050            YES -                                        
         LA    R7,TOTRSPLP         DISP TO SPL PRIOR                            
         CLI   6(R6),53            'SPL PRIOR  ' COLUMN?                        
         BE    SPAC0050            YES -                                        
         LA    R7,TOTRSPLT         DISP TO SPL THIS WEEK                        
         CLI   6(R6),62            'SPL THIS WEEK' COLUMN?                      
         BE    SPAC0050            YES -                                        
         LA    R7,TOTRSPLE         DISP TO SPL ESTIMATED                        
         CLI   6(R6),63            'SPL ESTIMATED' COLUMN?                      
         BE    SPAC0050            YES -                                        
         LA    R7,TOTRSPLL         DISP TO SPL THIS WK LAST YEAR                
         CLI   6(R6),76            'SPL THS WK/LST YEAR' COLUMN?                
         BE    SPAC0050            YES -                                        
         SR    RF,RF               NOT AN SPL COLUMN:                           
*                                     SET CC = ZERO                             
         B     SPAC0100            EXIT                                         
SPAC0050 EQU   *                                                                
*                                                                               
*    FIRST ACCUMULATE THE MARKET PORTION OF SPL CALCULATION                     
*       DON'T ACCUMULATE IF THERE ARE -NO- MARKET DOLLARS!!                     
*                                                                               
         L     RE,4(R1,R7)         R1=COL DATA + R7=COL #                       
         LTR   RE,RE                                                            
         BZ    SPAC0060            NO MARKET $$ - DON'T ADD!                    
         A     RE,4(RF,R7)         RF=ROW/MONTH IN TABLE + R7=COL #             
         ST    RE,4(RF,R7)         STORE IT BACK                                
*                                                                               
*    NEXT ACCUMULATE THE STATION PORTION OF SPL CALCULATION                     
*                                                                               
         L     RE,0(R1,R7)         R1=COL DATA + R7=COL #                       
         A     RE,0(RF,R7)         RF=ROW/MONTH IN TABLE + R7=COL #             
         ST    RE,0(RF,R7)         STORE IT BACK                                
*                                                                               
*   START TEST                                                                  
*        MVC   P(15),=C'REGS: R1/R7/RF='                                        
*        ST    R1,DUB                                                           
*        MVC   P+20(4),DUB                                                      
*        ST    R7,DUB                                                           
*        MVC   P+25(4),DUB                                                      
*        ST    RF,DUB                                                           
*        MVC   P+30(4),DUB                                                      
*        GOTO1 REPORT                                                           
*        L     RF,SVRFREG          RESET                                        
*        MVC   P(12),=C'TOTAL ACCUM:'                                           
*        LA    R2,0(RF,R7)                                                      
*        EDIT  (4,0(R2)),(8,P+15)                                               
*        LA    R2,4(RF,R7)                                                      
*        EDIT  (4,0(R2)),(8,P+25)                                               
*        GOTO1 REPORT                                                           
*   END   TEST                                                                  
*                                                                               
SPAC0060 EQU   *                                                                
         LTR   RB,RB               SET CC NOT = ZERO                            
SPAC0100 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*    SPLSETUP:   SPL CALCULATION ROUTINE:                                       
*        R5,R7  ->  DATA COLUMN IN ARRAY                                        
*                                                                               
SPLSETUP NMOD1 0,*SPSE*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)                                                         
         USING RPSPECD,R2                                                       
*                                                                               
         L     R5,8(R1)                                                         
         L     R7,12(R1)                                                        
         LA    R3,0(R5,R7)         SET A(DATA COLUMN)                           
         L     RF,RPCOLDEF+4(R7)   A(COLUMN DEF SPEC)                           
         CLI   6(RF),52            SPL AS-RUN CURRENT?                          
         BNE   SPET0020            NO                                           
         LA    R4,TOTRSPLC(R5)     YES - A(SPL CURRENT IN ARRAY)                
         B     SPET0100            GO DO CALCULATION                            
SPET0020 EQU   *                                                                
         CLI   6(RF),53            SPL AS-RUN PRIOR?                            
         BNE   SPET0040            NO                                           
         LA    R4,TOTRSPLP(R5)     YES - A(SPL PRIOR IN ARRAY)                  
         B     SPET0100            GO DO CALCULATION                            
SPET0040 EQU   *                                                                
         CLI   6(RF),62            SPL AS-RUN THIS WEEK?                        
         BNE   SPET0060            NO                                           
         LA    R4,TOTRSPLT(R5)     YES - A(SPL THIS WEEK IN ARRAY)              
         B     SPET0100            GO DO CALCULATION                            
SPET0060 EQU   *                                                                
         CLI   6(RF),63            SPL AS-RUN ESTIMATED?                        
         BNE   SPET0080            NO  - EXIT                                   
         LA    R4,TOTRSPLE(R5)     YES - A(SPL ESTIMATED IN ARRAY)              
         B     SPET0100            GO DO CALCULATION                            
SPET0080 EQU   *                                                                
         CLI   6(RF),76            SPL AS-RUN THIS WK LAST YEAR?                
         BNE   SPET0180            NO  - EXIT                                   
         LA    R4,TOTRSPLL(R5)     YES - A(SPL THIS WK LAST YEAR)               
         B     SPET0100            GO DO CALCULATION                            
SPET0100 EQU   *                                                                
         MVC   DUB(4),0(R4)        LOAD SPL CURRENT STATION $$                  
         MVC   DUB+4(4),4(R4)      LOAD SPL CURRENT MARKET $$                   
*                                                                               
*   TEST                                                                        
*        MVC   P+1(08),=C'SPET0100'                                             
*        EDIT  (4,DUB),(12,P+12),DUB=MYDUB2                                     
*        EDIT  (4,DUB+4),(12,P+30),DUB=MYDUB2                                   
*        GOTO1 REPORT                                                           
*   TEST END                                                                    
*                                                                               
         SR    R0,R0                                                            
         L     R1,DUB              LOAD STATION $$                              
         L     RF,DUB+4            LOAD MARKET $$                               
         XC    DUB,DUB             CLEAR WORKSPACE                              
         LTR   R1,R1               CHECK FOR NEGATIVE                           
         BM    SPET0160            DON'T DIVIDE IF NEGATIVE                     
         LTR   RF,RF               CHECK FOR NEGATIVE                           
         BM    SPET0160            DON'T DIVIDE IF NEGATIVE                     
SPET0120 EQU   *                                                                
*                                                                               
*   IF FIGURES ARE TOO BIT, THE CALCULATIONS EXCEED THE SIZE OF THE             
*      REGISTERS.  TO AVOID THIS, A SIZE OF 1,000,000 HAS BEEN                  
*      CHOSEN AS THE CUTOFF.  IF THE STATION FIGURE IS HIGHER                   
*      BOTH STATION AND MARKET DOLLARS ARE DIVIDED BY 2 UNTIL THE               
*      THRESHOLD IS NOT EXCEEDED.  IN THIS MANNER, THE CALCULATION              
*      WILL NOT OVERFLOW.  THE MAGNITUDE OF THE FIGURES WILL MAKE               
*      THIS CALCULATION ACCURATE DESPITE THE DIVISIONS.                         
*                                                                               
         C     R1,=F'1000000'      COMPARE FOR OVERFLOW AVOIDANCE               
         BNH   SPET0140            OKAY - PROCEED                               
         SRA   R1,1                TOO BIG - DIVIDE NUMERATOR BY 2              
         SRA   RF,1                DIVIDE DENOMINATOR BY 2                      
         B     SPET0120            GO BACK AND CHECK AGAIN                      
SPET0140 EQU   *                                                                
         M     R0,=F'1000'         DECIMAL ALIGN - ONE DECIMAL PLACE            
         SLDA  R0,1                DOUBLE FOR ROUNDING                          
         AR    R1,RF               ADD MARKET$ FOR ROUNDING                     
         LTR   RF,RF               ANY MARKET $$?                               
         BZ    SPET0160            NO  - DON'T DIVIDE                           
         DR    R0,RF               DIVIDE BY MARKET$                            
         SRA   R1,1                DIVIDE BY 2                                  
         ST    R1,DUB              SAVE RESULT                                  
SPET0160 EQU   *                                                                
         MVC   0(4,R3),DUB         MOVE TO OUTPUT FIELD                         
*                                                                               
*   TEST                                                                        
****>>   BAS   RE,DISPSPET         **TEST**                                     
*   END TEST                                                                    
*                                                                               
SPET0180 EQU   *                                                                
         XIT1                                                                   
*                                                                               
MYDUB2   DS    D                                                                
         DROP  R2                                                               
         EJECT                                                                  
*                                                                               
*    SPLMAIN:   SPL CALCULATION ROUTINE WHEN COLUMNS ARE IN MAIN                
*        DATA RECORD, NOT PASSED IN FROM ANOTHER REPORT FORMAT                  
*                                                                               
*        R5,R7  ->  DATA COLUMN IN ARRAY                                        
*                                                                               
SPLMAIN  NMOD1 0,*SPSE*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)                                                         
         USING RPSPECD,R2                                                       
*                                                                               
         L     R5,8(R1)            A(DATA IN RECORD)                            
         L     R7,12(R1)           DISPLACEMENT INTO DATA IN RECORD             
         LA    R3,0(R5,R7)         SET A(DATA COLUMN)                           
         L     RF,RPCOLDEF+4(R7)   A(COLUMN DEF SPEC)                           
         CLI   6(RF),85            SPL AS-RUN CURRENT/MAIN RECORD?              
         BE    SMAI0100            YES - GO DO CALCULATION                      
SMAI0020 EQU   *                                                                
         CLI   6(RF),86            SPL AS-RUN PRIOR/MAIN RECORD?                
         BE    SMAI0100            YES - GO DO CALCULATION                      
SMAI0040 EQU   *                                                                
         CLI   6(RF),87            SPL AS-RUN THIS WEEK/MAIN RECORD?            
         BNE   SMAI0180            NO  - EXIT                                   
SMAI0100 EQU   *                                                                
         MVC   DUB(4),0(R3)        LOAD SPL CURRENT STATION $$                  
         MVC   DUB+4(4),4(R3)      LOAD SPL CURRENT MARKET $$                   
         SR    R0,R0                                                            
         L     R1,DUB              LOAD STATION $$                              
         L     RF,DUB+4            LOAD MARKET $$                               
         XC    DUB,DUB             CLEAR WORKSPACE                              
         LTR   R1,R1               CHECK FOR NEGATIVE                           
         BM    SMAI0160            DON'T DIVIDE IF NEGATIVE                     
         LTR   RF,RF               CHECK FOR NEGATIVE                           
         BM    SMAI0160            DON'T DIVIDE IF NEGATIVE                     
SMAI0120 EQU   *                                                                
*                                                                               
*   IF FIGURES ARE TOO BIT, THE CALCULATIONS EXCEED THE SIZE OF THE             
*      REGISTERS.  TO AVOID THIS, A SIZE OF 1,000,000 HAS BEEN                  
*      CHOSEN AS THE CUTOFF.  IF THE STATION FIGURE IS HIGHER                   
*      BOTH STATION AND MARKET DOLLARS ARE DIVIDED BY 2 UNTIL THE               
*      THRESHOLD IS NOT EXCEEDED.  IN THIS MANNER, THE CALCULATION              
*      WILL NOT OVERFLOW.  THE MAGNITUDE OF THE FIGURES WILL MAKE               
*      THIS CALCULATION ACCURATE DESPITE THE DIVISIONS.                         
*                                                                               
         C     R1,=F'1000000'      COMPARE FOR OVERFLOW AVOIDANCE               
         BNH   SMAI0140            OKAY - PROCEED                               
         SRA   R1,1                TOO BIG - DIVIDE NUMERATOR BY 2              
         SRA   RF,1                DIVIDE DENOMINATOR BY 2                      
         B     SMAI0120            GO BACK AND CHECK AGAIN                      
SMAI0140 EQU   *                                                                
         M     R0,=F'1000'         DECIMAL ALIGN - ONE DECIMAL PLACE            
         SLDA  R0,1                DOUBLE FOR ROUNDING                          
         AR    R1,RF               ADD MARKET$ FOR ROUNDING                     
         LTR   RF,RF               ANY MARKET $$?                               
         BZ    SMAI0160            NO  - DON'T DIVIDE                           
         DR    R0,RF               DIVIDE BY MARKET$                            
         SRA   R1,1                DIVIDE BY 2                                  
         ST    R1,DUB              SAVE RESULT                                  
SMAI0160 EQU   *                                                                
         MVC   0(4,R3),DUB         MOVE TO OUTPUT FIELD                         
*                                                                               
*   TEST                                                                        
****>>   BAS   RE,DISPSPET         **TEST**                                     
*   END TEST                                                                    
*                                                                               
SMAI0180 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         DROP  R2                                                               
         EJECT                                                                  
*DISPSPET NTR1                                                                  
*                       1.3.5.7.9.1.3.5.7.9.1.3.5.7.9.1.3.5.7.9.1               
*        MVC   P(31),=C'R4=12345678  STA=12345678  MKT='                        
*        MVC   P+41(4),=C'DUB='                                                 
*        ST    R4,DUB+4                                                         
*        GOTO1 HEXOUT,DMCB,DUB+4,P+3,4,=C'TOG'                                  
*        EDIT  (4,0(R4)),(8,P+17),DUB=MYDUB                                     
*        EDIT  (4,4(R4)),(8,P+31),DUB=MYDUB                                     
*        EDIT  (4,DUB),(8,P+45),DUB=MYDUB                                       
*        GOTO1 REPORT                                                           
*        XIT1                                                                   
*                                                                               
MYDUB    DS    D                                                                
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   RETRIEVE CONTRACT RECORD, IF NECESSARY.  FIND APPROPRIATE                   
*      COMMENT ELEMENTS.  ADD NUMBER OF COMMENT LINES TO 'LINE'                 
*      FOR SPACE TESTING.                                                       
*                                                                               
         DS    0F                                                               
COMMENTS NMOD1 0,*COMM*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)            RESET A(RPSPECD)                             
         USING RPSPECD,R2                                                       
         L     RF,ABUYNAMS         USE A(BUYNAMS TABLE) AS BUFFER               
*                                                                               
*                                  KEY SAVED IN 1ST PART OF BUFFER              
         CLC   28(4,RF),REC+RGDSKDSP                                            
*                                  IS RECORD ALREADY IN CORE?                   
         BE    CNTS0040            YES                                          
         XC    KEY,KEY             NO                                           
         MVC   KEY+28(4),REC+RGDSKDSP                                           
*                                  LOAD DISK ADDR RETRIEVE RECORD               
         GOTO1 GETCONTX                                                         
CNTS0040 EQU   *                                                                
         L     RF,ABUYNAMS         USE A(BUYNAMS TABLE) AS BUFFER               
         MVC   0(34,RF),KEY        SAVE KEY IN FIRST PART OF BUFFER             
         LA    R4,40(RF)           SET A(COMMENTS FLAG) IN BUFFER               
         MVI   0(R4),C'N'          SET 'COMMENTS FOUND' FLAG TO NO              
*                                                                               
         TM    RPMISFLG,X'20'      NO COMMENTS, 1ST BUY DATE?                   
         BNO   CNTS0080            NO                                           
         L     RE,DUB                                                           
         LA    RE,2(RE)            BUMP BY 2 FOR BUY DATE,                      
*                                     FOLLOWING SPACE                           
         ST    RE,DUB              PUT IT BACK                                  
         B     CNTS0050            EXIT                                         
CNTS0080 EQU   *                                                                
         TM    RPMISFLG,X'10'      YES - COMMENTS, 1ST BUY DATE?                
         BNO   CNTS0120            NO                                           
         L     RE,DUB                                                           
         LA    RE,1(RE)            BUMP BY 2 FOR BUY DATE ONLY                  
         ST    RE,DUB              PUT IT BACK                                  
CNTS0120 EQU   *                                                                
         LA    RF,50(RF)           RECORD IS 50 BYTES IN                        
         USING RCONREC,RF                                                       
         LA    RF,RCONELEM         A(1ST ELEMENT)                               
         DROP  RF                                                               
CNTS0160 EQU   *                                                                
         CLI   0(RF),0             END OF RECORD?                               
         BE    CNTS0280            YES                                          
         CLI   0(RF),X'11'         SAR COMMENT ELEMENT?                         
         BNE   CNTS0200            NO  -                                        
         MVI   0(R4),C'Y'          SET 'COMMENTS FOUND' FLAG TO YES             
         CLC   =C'C=',2(RF)        STANDARD COMMENT?                            
         BE    CNTS0240            YES                                          
         CLC   =C'SC=',2(RF)       SFM COMMENT?                                 
         BE    CNTS0240            NO                                           
         L     RE,DUB              YES - ADD 1 TO LINE COUNT                    
         LA    RE,1(RE)                                                         
         ST    RE,DUB              RESET LINE                                   
CNTS0200 EQU   *                                                                
         ZIC   R0,1(RF)            BUMP TO NEXT ELEMENT                         
         AR    RF,R0                                                            
         B     CNTS0160            GO BACK FOR NEXT                             
CNTS0240 EQU   *                                                                
         GOTO1 STANCOMT,DMCB,(RF)                                               
CNTS0280 EQU   *                                                                
*                                                                               
*   THREE ADDITIONAL LINES NEEDED FOR ALL 'COMMENT' REPORTS.  THESE             
*      ARE:  1ST SPACE LINE, 'LAST UPDATED ON DATE' LINE, AND LAST              
*      SPACE LINE, FOR FORMATTING.                                              
*                                                                               
*****>   CLI   0(R4),C'Y'          COMMENTS FOUND?                              
*****>   BNE   CNTS0050            NO                                           
         L     RE,DUB              YES - BUMP BY 2 FOR SPACES,                  
         LA    RE,2(RE)               'LAST UPDATE ON DATE'                     
         ST    RE,DUB              RESET LINE                                   
CNTS0050 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         DROP  R2                                                               
         EJECT                                                                  
*                                                                               
*   STANCOMT:  RETRIEVE EITHER THE 2E OR 34 COMMENT RECORD, COUNT               
*        NUMBER OF LINES                                                        
*                                                                               
STANCOMT NTR1                                                                   
         L     R4,0(R1)            SET A(ELEMENT WITH CODE)                     
         L     R3,ABUYNAMS         ESTABLISH A(CONTRACT RECORD)                 
         LA    R3,50(R3)                                                        
         USING RCONREC,R3                                                       
*                                                                               
         XC    KEY,KEY             CLEAR KEY                                    
         CLC   =C'C=',2(R4)        STANDARD COMMENT?                            
         BNE   STAN0050            NO  -                                        
         MVI   KEY,X'2E'           YES                                          
         MVC   KEY+15(2),RCONKREP  INSERT REP CODE                              
         MVC   KEY+17(2),=X'FFFF'  OFFICE CODE                                  
         MVC   KEY+19(8),4(R4)     INSERT COMMENT                               
         GOTO1 HIGHX                                                            
         CLC   KEY(27),KEYSAVE     FOUND?                                       
         BNE   STAN0090            NO - USE CURRENT COUNT                       
         GOTO1 GETSTCMX            YES - RETRIEVE RECORD                        
         L     R2,ABUYNAMS                                                      
         A     R2,=F'1500'                                                      
         USING RCMTD,R2                                                         
         ZIC   RF,RCMT#LIN         GET NUMBER OF LINES                          
         L     RE,DUB                                                           
         AR    RE,RF               ADD NUMBER OF LINES                          
         ST    RE,DUB              SAVE IT BACK                                 
         B     STAN0090            EXIT                                         
         DROP  R2                                                               
STAN0050 EQU   *                                                                
         MVI   KEY,X'34'           YES                                          
         MVC   KEY+20(2),RCONKREP  INSERT REP CODE                              
         MVC   KEY+22(2),RCONKOFF  OFFICE CODE                                  
         MVC   KEY+24(2),5(R4)     INSERT COMMENT                               
         MVI   KEY+26,C'0'         INSERT 'PAGE NUMBER'                         
         GOTO1 HIGHX                                                            
         CLC   KEY(27),KEYSAVE     FOUND?                                       
         BNE   STAN0090            NO - USE CURRENT COUNT                       
         GOTO1 GETSTCMX            YES - RETRIEVE RECORD                        
         L     R2,ABUYNAMS                                                      
         A     R2,=F'1500'                                                      
         USING ROCMD,R2                                                         
         LA    R2,ROCMDSEL         A(DESCRIPTIVE ELEMENT)                       
         DROP  R2                                                               
         L     RE,DUB                                                           
STAN0060 EQU   *                                                                
         CLI   0(R2),0             END OF RECORD REACHED?                       
         BNL   STAN0080            YES                                          
         CLI   0(R2),X'02'         COMMENT ELEMENT?                             
         BNE   STAN0070            NO                                           
         LA    RE,1(RE)            YES - ADD TO COUNTER                         
STAN0070 EQU   *                                                                
         ZIC   RF,1(R2)            BUMP TO NEXT ELEMENT                         
         LA    R2,RF                                                            
         B     STAN0060            GO BACK FOR NEXT                             
STAN0080 EQU   *                                                                
         ST    RE,DUB              SAVE FINAL COUNT                             
STAN0090 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
HIGHX    NTR1                                                                   
         LA    RF,DMRDHI                                                        
         MVC   KEYSAVE,KEY                                                      
         B     LINKDIRX                                                         
*                                                                               
SEQX     NTR1                                                                   
         LA    RF,DMRSEQ                                                        
         MVC   KEYSAVE,KEY                                                      
         B     LINKDIRX                                                         
*                                                                               
LINKDIRX EQU   *                                                                
         ST    RF,DMCB                                                          
         MVC   DMCB(1),DMINBTS                                                  
         GOTO1 DATAMGR,DMCB,,REPDIR,KEY,KEY,0                                   
         B     DMCHECKX                                                         
*                                                                               
GETCONTX NTR1                      RETRIEVE CONTRACT RECORD                     
         L     RF,ABUYNAMS         USE A(BUYNAMS TABLE) AS BUFFER               
         LA    RF,50(RF)           SET RECORD 50 BYTES IN                       
         B     LINKFILX                                                         
*                                                                               
GETSTCMX NTR1                      RETRIEVE STANDARD CONTRACT RECORD            
         L     RF,ABUYNAMS         USE A(BUYNAMS TABLE) AS BUFFER               
         A     RF,=F'1500'         SET RECORD 1500 BYTES IN                     
         XC    0(64,RF),0(RF)      CLEAR BEGINNING OF RECORD                    
         B     LINKFILX                                                         
*                                                                               
LINKFILX EQU   *                                                                
         LR    R2,RF                                                            
         GOTO1 DATAMGR,DMCB,(DMINBTS,GETREC),REPFILE,KEY+28,           X        
               (R2),(0,DMWORK)                                                  
         MVC   LASTIO,DMCB+12      SAVE THESE VALUES                            
         MVC   LASTDA,KEY+28                                                    
         MVC   LASTLEN,27(R2)                                                   
*                                                                               
DMCHECKX TM    DMCB+8,X'10'        TEST FOR RECORD NOT FOUND                    
         BZ    DMX010                                                           
         TM    29(R2),X'80'        IS RECORD MARKED FOR DELETION                
         BZ    DMX020              NO - ERROR                                   
         LTR   RB,RB               YES - RETURN WITH CC NE 0                    
         B     DMXIT                                                            
*                                                                               
DMX010   TM    DMCB+8,X'EF'        TEST FOR OTHER ERRORS                        
         BZ    DMXIT                                                            
*                                                                               
DMX020   MVC   WORK(27),=C'*** DATA MANAGER ERROR  ***'                         
         GOTO1 LOGIO,WORK+32,1,(27,WORK)                                        
         MVC   WORK(27),=C'*** REQUEST NUMBER NNNN ***'                         
         L     R5,MCADDR                                                        
         UNPK  WORK+19(4),MCREQNO-MASTD(3,R5)                                   
         OI    WORK+22,X'F0'                                                    
         BASR  RE,RF                                                            
         DC    H'0'            BLOW UP                                          
DMXIT    XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
* SUBROUTINE TO EXECUTE COLCOMP SPECS *                                         
         SPACE 1                                                                
         DS    0F                                                               
COMP     NMOD1 0,*COMP*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R7,4(R1)            LOAD A(SPECS)                                
*                                                                               
         USING RPSPECD,R2                                                       
*                                                                               
*   R2 IS PASSED IN AND SHOULD NOT BE CHANGED.                                  
*                                                                               
         XC    COMPROND,COMPROND   CLEAR ROUNDING FACTOR                        
         ST    R5,FULL             SAVE ROW ADDRESS                             
         SR    R4,R4               CLEAR REG FOR DIVIDES                        
         MVC   FLD,SPACES                                                       
         XC    WORK,WORK                                                        
         ZIC   RE,1(R6)                                                         
         SH    RE,=H'3'                                                         
         EX    RE,*+8              MOVE SPECS TO 'WORK'                         
         B     *+10                                                             
         MVC   WORK(0),2(R6)       *EXECUTED*                                   
*                                                                               
         LA    R6,WORK                                                          
         ZIC   RE,0(R6)            GET COL NUMBER                               
         CLI   0(R6),16            COLUMN NUMBER?                               
         BL    COMP0040            YES                                          
         CLI   0(R6),99            NO  - 'OLD' CONSTANT?                        
         BH    COMP0020            NO                                           
*                                                                               
*   OLD CONSTANT:  THIS SEEMS TO BE TRASH.  HOWEVER, I AM NOT SURE              
*      SOME ITEM DOESN'T DEPEND ON IT, SO IT IS LEFT IN.  AS IT                 
*      STANDS, CONSTANTS OF 0 TO 15 ARE NOT PERMITTED, AND THEN                 
*      THE CONSTANT VALUE IS DECREASED BY 16.  IF THIS MAKES SENSE              
*      TO ANYONE, IT ISN'T ME.   BILL UHR.  SEPT 93.                            
*                                                                               
         ZIC   R5,0(R6)            YES - GET CONSTANT                           
         SH    R5,=H'16'                                                        
         B     COMP0060                                                         
*                                                                               
*   NEW CONSTANT:  THIS ITEM IS OVERSTATED BY 100 IN THE RRG SPEC.              
*      IF A MULTIPLICATION BY 100 IS TO BE DONE, THE FIGURE IS                  
*      STATED AS '200'.  THE CORRECTION FACTOR IS APPLIED BELOW.                
*                                                                               
COMP0020 EQU   *                                                                
         ZIC   R5,0(R6)            NEW CONSTANT                                 
         SH    R5,=H'100'                                                       
         B     COMP0060                                                         
*                                                                               
COMP0040 BCTR  RE,0                                                             
         SLL   RE,2                                                             
         A     RE,FULL             POINT TO DATA                                
         ICM   R5,15,0(RE)         GET DATA IN REG                              
*                                                                               
*   TEST                                                                        
*        L     R5,TESTVAL1                                                      
*   TEST END                                                                    
*                                                                               
COMP0060 LA    R6,1(R6)            BUMP SPEC POINTER                            
*                                                                               
COMP0080 EQU   *                                                                
         ZIC   RE,WORK+63          USE LAST BYTE AS COUNTER                     
         LA    RE,1(RE)            INCREMENT COUNTER                            
         STC   RE,WORK+63          PUT IT BACK                                  
         ZIC   RE,1(R6)            GET COL NUM                                  
         CLI   1(R6),16            COLUMN NUMBER?                               
         BL    COMP0120            YES                                          
         CLI   1(R6),99            NO  - 'OLD' CONSTANT?                        
         BH    COMP0100            NO                                           
*                                                                               
*   OLD CONSTANT:  THIS SEEMS TO BE TRASH.  HOWEVER, I AM NOT SURE              
*      SOME ITEM DOESN'T DEPEND ON IT, SO IT IS LEFT IN.  AS IT                 
*      STANDS, CONSTANTS OF 0 TO 15 ARE NOT PERMITTED, AND THEN                 
*      THE CONSTANT VALUE IS DECREASED BY 16.  IF THIS MAKES SENSE              
*      TO ANYONE, IT ISN'T ME.   BILL UHR.  SEPT 93.                            
*                                                                               
         ZIC   RF,1(R6)            GET CONSTANT                                 
         SH    RF,=H'16'                                                        
         B     COMP0160                                                         
*                                                                               
*   NEW CONSTANT:  THIS ITEM IS OVERSTATED BY 100 IN THE RRG SPEC.              
*      IF A MULTIPLICATION BY 100 IS TO BE DONE, THE FIGURE IS                  
*      STATED AS '200'.  THE CORRECTION FACTOR IS APPLIED BELOW.                
*                                                                               
COMP0100 EQU   *                                                                
         ZIC   RF,1(R6)            NEW CONSTANT                                 
         SH    RF,=H'100'                                                       
         B     COMP0160                                                         
*                                                                               
*                                                                               
COMP0120 EQU   *                                                                
         CLI   WORK+63,1           FIRST COMPUTE FIELDS?                        
         BNE   COMP0140            NO  - NO FURTHER TESTING                     
         CLC   WORK(1),WORK+2      YES - 1ST CALCS ON SAME COLUMNS?             
         BNE   COMP0140            NO  -                                        
         LA    RF,13               YES - RETRIEVE TOTALS FOR COLUMN             
         MH    RF,=Y(TOTROWLN)        X L(MONTHS ROW)                           
         A     RF,SVTOTROW               + A(ROWTOT)                            
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         AR    RE,RF               POINT TO DATA IN TOTALS                      
         ICM   RF,15,0(RE)                                                      
         B     COMP0160                                                         
COMP0140 EQU   *                                                                
         BCTR  RE,0                                                             
         SLL   RE,2                                                             
         A     RE,FULL             POINT TO DATA                                
         ICM   RF,15,0(RE)                                                      
*                                                                               
*   TEST                                                                        
*        L     RF,TESTVAL2                                                      
*        B     COMP0160                                                         
*ESTVAL1 DC    F'316273000'                                                     
*ESTVAL2 DC    F'468323000'                                                     
*ESTVAL3 DC    F'268082000'                                                     
*ESTVAL4 DC    F'286508000'                                                     
*   TEST END                                                                    
*                                                                               
*                                                                               
COMP0160 CLI   0(R6),1             TEST ADD                                     
         BNE   COMP0180                                                         
         AR    R5,RF                                                            
         B     COMP0460                                                         
*                                                                               
COMP0180 CLI   0(R6),2             TEST SUB                                     
         BNE   COMP0200                                                         
         SR    R5,RF                                                            
         B     COMP0460                                                         
*                                                                               
COMP0200 CLI   0(R6),3             TEST MULT                                    
         BNE   COMP0220                                                         
         MR    R4,RF                                                            
         B     COMP0460                                                         
*                                                                               
COMP0220 CLI   0(R6),4             TEST DIVIDE                                  
         BNE   COMP0260                                                         
         LTR   RF,RF               TEST DIVIDE BY 0                             
         BZ    COMP0600            ZERO - DON'T DIVIDE                          
         BM    COMP0240            NEGATIVE: DON'T ADD FOR ROUNDING             
*                                                                               
*   WHEN A DIVIDE IS DONE, ONE HALF OF THE DIVISOR IS ADDED TO THE              
*        DIVIDEND AS A ROUNDING FACTOR.                                         
*                                                                               
         LR    R1,RF               LOAD DIVISOR FOR ROUND                       
         SRL   R1,1                DIVIDE BY 2                                  
         AR    R5,R1               ADD ROUNDING FACTOR TO DIVIDEND              
COMP0240 EQU   *                                                                
         DR    R4,RF                                                            
         B     COMP0460                                                         
*                                                                               
COMP0260 CLI   0(R6),5             PCT (1 DEC)                                  
         BE    *+12                                                             
         CLI   0(R6),7             PCTADJ (WEEK ADJUSTED PCT)                   
         BNE   COMP0340                                                         
*                                                                               
         LTR   RF,RF                                                            
         BZ    COMP0600                                                         
         CVD   RF,PK1              TEST IF PCT REASONABLE                       
         MP    PK1,=P'10'          NUMERATOR X 10                               
         CVD   R5,PK2              DENOMINATOR                                  
         CP    PK1,PK2                                                          
         BH    COMP0300                                                         
COMP0280 MVC   FLD+12(4),=C'HIGH'                                               
         MVI   PCTFLAG,1                                                        
         B     COMP0600                                                         
*                                                                               
COMP0300 M     R4,=F'2000'         X 1000 X 2                                   
         DR    R4,RF                                                            
         LTR   R5,R5                                                            
         BM    *+8                                                              
         A     R5,=F'1'                                                         
         SRA   R5,1                                                             
*                                                                               
         CLI   0(R6),7             TEST PCTADJ SPEC                             
         BNE   COMP0320                                                         
         CLI   PCTADJ,0            TEST PCTADJ ACTIVE                           
         BE    COMP0320            NO                                           
*                                                                               
         ZIC   RF,PCTADJ           GET FACTOR 1                                 
         AR    RF,RF               X 2                                          
         MR    R4,RF                                                            
         ZIC   RF,PCTADJ+1         GET FACTOR 2                                 
         DR    R4,RF                                                            
         A     R5,=F'1'                                                         
         SRA   R5,1                                                             
         CH    R5,=H'10000'                                                     
         BNL   COMP0280                                                         
*                                                                               
COMP0320 EQU   *                                                                
         EDIT  (R5),(16,FLD),1                                                  
         MVI   PCTFLAG,1                                                        
         B     COMP0600                                                         
*                                                                               
COMP0340 CLI   0(R6),6             PCT CHG (1 DEC)                              
         BNE   COMP0440                                                         
         C     R5,=F'107374000'    TEST REGISTER CUTOFF VALUE                   
         BH    COMP0360            BEYOND: ADJUST REG VALUES                    
         C     RF,=F'107374000'                                                 
         BNH   COMP0380            WITHIN LIMITS                                
COMP0360 EQU   *                                                                
         SRL   R5,10               DIVIDE BY 1024                               
         SRL   RF,10                                                            
COMP0380 EQU   *                                                                
         LCR   R0,RF               COMPLEMENT COL2                              
         AR    R5,R0               GIVES COL1 - COL2                            
*                                                                               
         LPR   R0,R5               NOW TEST REASONABLE                          
         LPR   R1,RF                                                            
         BZ    COMP0600                                                         
         MH    R1,=H'10'                                                        
         CR    R0,R1                                                            
         BH    COMP0280                                                         
         M     R4,=F'2000'         X 1000 X 2                                   
         DR    R4,RF                                                            
         LTR   R5,R5                                                            
         BZ    COMP0600                                                         
         BM    *+8                                                              
         A     R5,=F'1'                                                         
         SRA   R5,1                                                             
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    COMP0400            YES - LOAD SIGN AT FRONT                     
         EDIT  (R5),(15,FLD),1     NO  - LOAD SIGN FOLLOWING                    
         MVI   FLD+15,C'+'                                                      
         LTR   R5,R5                                                            
         BP    *+8                                                              
         MVI   FLD+15,C'-'                                                      
         B     COMP0600                                                         
COMP0400 EQU   *                                                                
         LTR   R5,R5               POSITIVE OR NEGATIVE?                        
         BP    COMP0420            POSITIVE                                     
*                                  NEGATIVE                                     
         EDIT  (R5),(15,FLD),1,FLOAT=-                                          
         B     COMP0600                                                         
COMP0420 EQU   *                                                                
         EDIT  (R5),(15,FLD),1,FLOAT=+                                          
         B     COMP0600                                                         
*                                                                               
COMP0440 DC    H'0'                UNKNOWN COMP SPEC                            
*                                                                               
COMP0460 LA    R6,2(R6)                                                         
         CLI   0(R6),0                                                          
         BNE   COMP0080                                                         
         L     RF,RPCOLDEF+4(R7)   A(COLUMN DEF SPEC)                           
         CLI   RCDNLOAD,C'Y'       DOWNLOAD REQUEST?                            
         BE    COMP0520                                                         
         CLI   4(RF),0             ANY DECIMAL PLACES?                          
         BNE   COMP0480            YES                                          
         EDIT  (R5),(16,FLD),MINUS=YES                                          
         B     COMP0600                                                         
COMP0480 EQU   *                                                                
         CLI   4(RF),1             1 DECIMAL PLACE?                             
         BNE   COMP0500            NO                                           
         EDIT  (R5),(16,FLD),1,MINUS=YES                                        
         B     COMP0600                                                         
COMP0500 EQU   *                   MUST BE 2 DECIMAL PLACES                     
         EDIT  (R5),(16,FLD),2,MINUS=YES                                        
         B     COMP0600                                                         
COMP0520 EQU   *                                                                
         CLI   4(RF),0             ANY DECIMAL PLACES?                          
         BNE   COMP0540            YES                                          
         EDIT  (R5),(15,FLD),FLOAT=-                                            
         B     COMP0580                                                         
COMP0540 EQU   *                                                                
         CLI   4(RF),1             1 DECIMAL PLACE?                             
         BNE   COMP0560            YES                                          
         EDIT  (R5),(15,FLD),1,FLOAT=-                                          
         B     COMP0580                                                         
COMP0560 EQU   *                   MUST BE 2 DECIMAL PLACES                     
         EDIT  (R5),(15,FLD),2,FLOAT=-                                          
COMP0580 EQU   *                   MUST BE 2 DECIMAL PLACES                     
         MVC   FLD(L'FLD-1),FLD+1  MOVE FIELD UP 1 POSITION                     
         MVI   FLD+L'FLD-1,C' '    INSERT SPACE INTO LAST POSITION              
COMP0600 EQU   *                                                                
         XIT1                                                                   
         EJECT                                                                  
* SUBROUTINE TO START LOGO                                                      
         SPACE                                                                  
         DS    0F                                                               
STLOGO   NMOD1 0,*STLO*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)            RESET A(RPSPECD)                             
         USING RPSPECD,R2                                                       
         MVI   RPREMPRT,C'Y'       TURN ON LOGO SWITCH                          
         MVI   XENDLOGO,C'Y'       TURN ON LOGO SWITCH                          
*                                                                               
         L     RE,VXADDR           NO START LOGO IF DOWNLOADING                 
         USING VXADDRD,RE                                                       
         L     RF,VXRCDOWN                                                      
         CLI   0(RF),X'01'                                                      
         BE    STLO0200                                                         
         DROP  RE                                                               
*                                                                               
         TM    NOLOGOSW,MCPRTINL   NOLOGOS SET?                                 
         BO    STLO0200            YES - EXIT ROUTINE                           
*                                                                               
         CLI   DIRECTSW,C'Y'       DIRECT TO QUEUE?                             
         BE    STLO0200            YES - EXIT ROUTINE                           
*                                                                               
         L     R4,LOGO                                                          
         MVC   0(2,R4),=X'90EC'    MAKE LOGO ACTIVE                             
         L     R5,LOGOC                                                         
         USING LOGOD,R5                                                         
         MVC   DUB,SPACES                                                       
*                                                                               
         LA    RF,LOGOTAB          POINT TO ID TO SIGN-ON TABLE                 
STLO0010 EQU *                                                                  
         CLI   0(RF),0             END OF TABLE ?                               
         BNE   STLO0020            ZERO IS YES                                  
         LA    RF,LOGOTAB          DEFAULT TO SJR                               
         B     STLO0030                                                         
STLO0020 EQU   *                                                                
         CLC   0(2,RF),RCREPFL                                                  
         BE    STLO0030                                                         
         LA    RF,5(RF)                                                         
         B     STLO0010                                                         
STLO0030 EQU   *                                                                
         MVC   DUB(3),2(RF)                                                     
         LA    RF,DUB+2                                                         
         CLI   0(RF),C' '                                                       
         BE    STLO0040                                                         
         LA    RF,1(RF)                                                         
STLO0040 EQU   *                                                                
         MVC   0(2,RF),QREQOFF                                                  
*                                                                               
STLO0050 EQU   *                                                                
         OC    RPREMCPY,RPREMCPY   TEST LOGO STARTED BY REMCOPY                 
         BZ    STLO0070                                                         
         CLI   RPREMCPY,C'Y'                                                    
         BNE   STLO0120                                                         
         LA    RF,DUB+2                                                         
         CLI   2(RF),C' '                                                       
         BE    STLO0060                                                         
         LA    RF,1(RF)                                                         
STLO0060 EQU   *                                                                
         MVC   0(2,RF),3(R7)       R7 POINTS TO REMCOPY SPEC                    
         B     STLO0120                                                         
*                                                                               
STLO0070 OC    RPREMPRT+1(3),RPREMPRT+1                                         
         BZ    STLO0110            (USED TO GO TO ST20)                         
         L     R1,RPROWDEF(R7)                                                  
         CLI   3(R1),4             OFFICE ROW                                   
         BNE   STLO0090                                                         
         LA    RF,DUB+2                                                         
         CLI   2(RF),C' '                                                       
         BE    STLO0080                                                         
         LA    RF,1(RF)                                                         
STLO0080 EQU   *                                                                
         MVC   0(2,RF),WORK+1                                                   
         B     STLO0120                                                         
*                                                                               
STLO0090 CLI   3(R1),3             REGION ROW                                   
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R4,ASPACND4                                                      
         MVI   ELCODE,3                                                         
         BAS   RE,FRSTELGO                                                      
         B     *+8                                                              
*                                                                               
STLO0100 BAS   RE,NEXTELGO                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   WORK(2),2(R4)                                                    
         BNE   STLO0100                                                         
         MVC   DESTID,30(R4)       FOUND ID CODE                                
         B     STLO0190                                                         
*                                                                               
STLO0110 EQU   *                                                                
         L     R1,MCADDR                                                        
         USING MASTD,R1                                                         
         OC    MCDESTID,MCDESTID   TEST DESTINATION ID IN MASTER                
         BZ    STLO0120            CONTROL BLOCK                                
         MVC   DESTID,MCDESTID     YES - USE THAT                               
         B     STLO0190                                                         
         DROP  R1                                                               
*                                                                               
STLO0120 L     R4,=A(IDBUFF)                                                    
         LA    R6,8(R4)                                                         
         LA    R7,1                                                             
*                                                                               
STLO0130 OC    0(6,R6),0(R6)       LOOK FOR MATCH IN ID BUFFER                  
         BZ    STLO0150                                                         
         CLC   0(6,R6),DUB                                                      
         BE    STLO0140                                                         
         LA    R6,8(R6)                                                         
         LA    R7,1(R7)                                                         
         B     STLO0130                                                         
*                                                                               
STLO0140 MVC   DESTID,6(R6)        FOUND                                        
         B     STLO0190                                                         
*                                                                               
STLO0150 ST    R7,4(R4)            NEW ENTRY                                    
         CH    R7,=H'1'                                                         
         BNE   STLO0160                                                         
         L     R3,=A(CTIO)         OPEN CONTROL FILE FOR 1ST ID                 
         GOTO1 DATAMGR,DMCB,=C'OPEN',=C'REP',=C'NCTFILE X',(R3)                 
*                                                                               
STLO0160 C     R7,0(R4)            IS THERE ROOM                                
         BL    *+6                                                              
         DC    H'0'                NO - BLOW                                    
         MVC   0(6,R6),DUB         LOOK UP ID ON CONTROL FILE                   
         L     R4,=A(CTIO)                                                      
         XC    0(25,R4),0(R4)                                                   
         MVI   0(R4),C'I'                                                       
         MVC   15(10,R4),SPACES                                                 
         MVC   15(6,R4),DUB                                                     
         GOTO1 DATAMGR,DMCB,DMREAD,=C'CTFILE',(R4),(R4),0                       
         CLI   DMCB+8,0                                                         
         BNE   STLO0170                                                         
         LA    R4,28(R4)                                                        
         MVI   ELCODE,2                                                         
         BAS   RE,FRSTELGO                                                      
         B     *+8                                                              
         BAS   RE,NEXTELGO                                                      
         BNE   STLO0170                                                         
         MVC   DESTID,2(R4)        FOUND ID                                     
         B     STLO0180                                                         
*                                                                               
STLO0170 MVC   DESTID,=H'43'       ID NOT FOUND - SEND TO DDS                   
*                                                                               
STLO0180 MVC   6(2,R6),DESTID                                                   
*                                                                               
STLO0190 LA    R4,=C'RPT'          ATTENTION TYPE TV                            
         CLI   QGROUP,C'R'                                                      
         BNE   *+8                                                              
         LA    R4,=C'RPR'          ATTENTION TYPE RADIO                         
         L     RF,ADCONLST                                                      
         L     RF,GETLOGO-ADCONSD(RF)                                           
         GOTO1 (RF),DMCB,(1,DESTID),(R5),DATAMGR,(R4)   GET LOGO INFO           
         MVC   LOGOJOB,=C'RERG'                                                 
         L     RF,THISQWK                                                       
         MVC   LOGOJOB+4(2),QWREQPR-QWKD(RF)                                    
         MVC   LOGOJOB+6(2),RPRPTCD                                             
         MVI   LOGOTYPE,C'S'                                                    
         L     R4,ADCONLST                                                      
         MVI   FOOTHOOK-ADCONSD(R4),X'FF'  DISABLE FOOTLINES                    
         GOTO1 LOGO,DMCB,(R5)       GO TO LOGO                                  
         L     R4,ABOX                                                          
         MVI   BOXOFF-BOXD(R4),0    LOGO MIGHT HAVE TURNED BOXES OFF            
*                                                                               
         L     R1,CHECKNXT                                                      
         CLI   22(R1),X'FF'                                                     
         BNE   *+14                                                             
         MVC   0(3,R1),=C'END'                                                  
         B     STLO0200                                                         
         MVC   0(8,R1),LOGOJOB                                                  
         MVC   8(7,R1),LOGO1                                                    
         MVC   15(7,R1),LOGO2                                                   
         LA    R1,22(R1)                                                        
         ST    R1,CHECKNXT                                                      
STLO0200 EQU   *                                                                
         XIT1                                                                   
*                                                                               
         DROP  R2                                                               
         EJECT                                                                  
NEXTELGO SR    R0,R0                                                            
         ICM   R0,1,1(R4)                                                       
         BNZ   *+6                                                              
         DC    H'0'                                                             
         AR    R4,R0                                                            
FRSTELGO CLI   0(R4),0                                                          
         BE    NEXTELGX                                                         
         CLC   0(1,R4),ELCODE                                                   
         BNE   NEXTELGO                                                         
         BR    RE                                                               
*                                                                               
NEXTELGX LTR   RE,RE                                                            
         BR    RE                                                               
         EJECT                                                                  
*                                                                               
*        LOGO TABLE --- REPID TO USER CODE TABLE                                
*                                                                               
LOGOTAB  EQU   *                                                                
         DC    CL5'SJSJR'          *INTERNAL AND DEFAULT*                       
         DC    CL5'BLBLR'          BLAIR                                        
         DC    CL5'NBNBC'          NBC                                          
         DC    CL5'UVUN '          UNIVISION                                    
         DC    CL5'B1TEL'          TELEMUNDO                                    
         DC    CL5'TOTOR'          INTEREP - TORBET                             
         DC    CL5'I1MMR'                    MAJOR MARKET                       
         DC    CL5'HNHN '                    HNWH                               
         DC    CL5'DIDI '                    DUPETTI                            
         DC    CL5'MGMG '                    MCGARVEN                           
         DC    CL5'GPGP '                    GROUP W                            
         DC    CL5'I2NON'                    NONREP                             
         DC    CL5'I8CAB'                    CABALLERO                          
         DC    CL5'I9SRS'                    SRS                                
         DC    CL5'RMRMS'                    RADIO MARKETING SPECLS             
         DC    X'00'                                                            
         DS    0H                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   SUBROUTINE TO SET AGGREGATE/SPL RECORDS INTO TSAR WORKSPACE                 
*                                                                               
         DS    0F                                                               
TABLDATA NMOD1 0,**TDAT**                                                       
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)            RESET A(RPSPEC)                              
         USING RPSPECD,R2                                                       
         MVC   FULL(1),12(R1)      SAVE SPL/AGG INDICATOR                       
         L     R5,12(R1)           A(RECORD BEING PROCESSED)                    
*                                                                               
*   TEST                                                                        
*        CLC   =C'TABLDATA',QUESTOR                                             
*        BNE   TDAT0010                                                         
*        MVC   P+1(09),=C'TABLDATA1'                                            
*        MVC   P+12(1),12(R1)                                                   
*        MVC   P+15(05),=C'FULL='                                               
*        MVC   P+22(1),FULL                                                     
**       GOTO1 REPORT                                                           
TDAT0010 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
         L     R3,ATSARDWA         SET A(TSAR CONTROL BLOCK)                    
*                                     1ST IS FOR SPL                            
         CLI   FULL,1              SPL TABLE NEEDED?                            
         BE    TDAT0020            YES                                          
         LA    R3,TSARDL+2(R3)     NO  - BUMP TO SECOND CONTROL BLOCK           
*                                     2ND IS FOR AGGREG                         
*                                     KEEP ON FULL-WORD BOUNDARY                
TDAT0020 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        CLC   =C'TABLDATA',QUESTOR                                             
*        BNE   TDAT0025                                                         
*        MVC   P+1(09),=C'TABLDATA2'                                            
*        MVC   P+12(1),12(R1)                                                   
*        MVC   P+15(05),=C'FULL='                                               
*        MVC   P+22(1),FULL                                                     
*        GOTO1 REPORT                                                           
TDAT0025 EQU   *                                                                
*   END TEST                                                                    
*                                                                               
*                                                                               
*   TEST                                                                        
*        CLC   =C'TABLDATA',QUESTOR                                             
*        BNE   TDAT0032                                                         
*        MVC   P+1(08),=C'SPL     '                                             
*        CLI   FULL,1              SPL TABLE NEEDED?                            
*        BE    TDAT0030            YES                                          
*        MVC   P+1(08),=C'AGGREG  '                                             
TDAT0030 EQU   *                                                                
*        GOTO1 REPORT                                                           
TDAT0032 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         USING TSARD,R3                                                         
         ZIC   R1,RPAGGTAB         AGGREGATE TABLE PROCESS NEEDED?              
         LTR   R1,R1                  TOTAL # ROWS NOT = ZERO?                  
         BNZ   TDAT0060            YES - CHECK FOR TABLE RESTART                
         MVI   TSOFFACT,TSAINI     NO  - USE 1ST TABLE SLOT                     
         MVC   TSAREC,=A(LENSPL)   SIZE OF SPL BUFFER                           
         CLI   FULL,1              SPL TABLE NEEDED?                            
         BE    TDAT0040            YES                                          
         MVC   TSAREC,=A(LENAGG)   NO  - SIZE OF AGGREG BUFFER                  
TDAT0040 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        MVC   P+1(08),=C'CLEARING'                                             
*        GOTO1 REPORT                                                           
*   END TEST                                                                    
*                                                                               
         GOTO1 ATSAROFF,(R3)       REINITIALIZE BUFFER                          
         B     TDAT0100                                                         
TDAT0060 EQU   *                                                                
         LA    RE,TBUFREC          CLEAR TBUFREC TO RETRIEVE                    
*                                     FIRST RECORD IN BUFFER                    
         LH    RF,=Y(L'TBUFREC)                                                 
         XCEFL                                                                  
         LA    R4,TBUFREC                                                       
         ST    R4,TSAREC           SET A(REC DELIVERY AREA)                     
         MVI   TSOFFACT,TSARDH     READ FOR 1ST RECORD                          
         OC    TSPRECN(4),TSPRECN  ANY RECORDS IN BUFFER?                       
         BZ    TDAT0100            NO  - JUST ADD RECORD                        
         GOTO1 ATSAROFF,(R3)                                                    
         TM    TSERRS,TSEEOF       END OF FILE?                                 
         BO    TDAT0100            YES - JUST ADD RECORD                        
         ZIC   R1,RPAGGTAB         RESET # ROWS                                 
         LA    R1,1(R1)            ADD 1 FOR CONTROL ROW                        
         MH    R1,=H'9'            MULTIPLY BY ROW WIDTH                        
         BCTR  R1,0                SET TO LAST ROW, LAST POS                    
         BCTR  R1,0                SET DOWN BY 1 FOR EX STATEMENT               
         EX    R1,TDAT0900         KEY IN TABLE?                                
         BE    TDAT0100            YES - ADD RECORD                             
         MVI   TSOFFACT,TSAINI     NO  - USE 1ST TABLE SLOT                     
         MVC   TSAREC,=A(LENSPL)   SIZE OF SPL BUFFER                           
         CLI   FULL,1              SPL TABLE NEEDED?                            
         BE    TDAT0080            YES                                          
         MVC   TSAREC,=A(LENAGG)   NO  - SIZE OF AGGREG BUFFER                  
TDAT0080 EQU   *                                                                
*                                                                               
*   TEST                                                                        
*        MVC   P+1(08),=C'CLEARING'                                             
*        GOTO1 REPORT                                                           
*   END TEST                                                                    
*                                                                               
         GOTO1 ATSAROFF,(R3)       REINITIALIZE BUFFER                          
TDAT0100 EQU   *                   NOW ADD RECORD TO BUFFER                     
         MVC   TBUFREC,0(R5)                                                    
*                                                                               
*   TEST                                                                        
*        CLC   =C'TABLDATA',QUESTOR                                             
*        BNE   TDAT0110                                                         
*        MVC   P+1(08),=C'TABLING:'                                             
*        MVC   P+11(60),TBUFREC                                                 
*        GOTO1 REPORT                                                           
TDAT0110 EQU   *                                                                
*   TEST END                                                                    
*                                                                               
         LA    R4,TBUFREC          RESET A(BUFFER RECORD)                       
         ST    R4,TSAREC                                                        
         MVI   TSOFFACT,TSAADD     ADD NEW RECORD                               
         GOTO1 ATSAROFF,(R3)                                                    
         BE    TDAT0120            ADDED SUCCESSFULLY                           
         TM    TSERRS,TSEEOF       BUFFER FULL?                                 
         BO    TDAT0160            YES - EXIT CC FOR MSG                        
         DC    H'0'                UNKNOWN ERROR..                              
TDAT0120 EQU   *                                                                
         SR    R0,R0               SET CC = ZERO                                
         B     TDAT0200                                                         
TDAT0160 EQU   *                                                                
         LTR   RB,RB               SET CC NOT = ZERO                            
TDAT0200 EQU   *                                                                
         XIT1                                                                   
*                                                                               
TDAT0900 CLC   0(0,R5),TBUFREC                                                  
*                                                                               
TBUFREC  DS    CL(RRGRECSZ)                                                     
*                                                                               
*     INCLUDE REREPTSAR                                                         
       ++INCLUDE REREPTSAR                                                      
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   RETRIEVE AND SHOW THE COMMENTS FOR THIS CONTRACT.  RECORD HAS               
*        ALREADY BEEN RETRIEVED.                                                
*                                                                               
SHOWCMTS NMOD1 0,*SCMT*                                                         
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         CLI   RPSPLACT,C'Y'       SPL REPORT?                                  
         BNE   SCMT0040            NO  -                                        
         CLI   RPLSTSTA,C'Y'       YES - LAST STATION?                          
         BNE   SCMT0480            NO  - DON'T SHOW COMMENTS NOW                
         BAS   RE,SPLCMTS          YES - SHOW SPL COMMENTS                      
         B     SCMT0480            EXIT ROUTINE                                 
SCMT0040 EQU   *                                                                
         ZIC   RF,RPCOMDSP         COMMENT DISPLACEMENT                         
         LA    R4,P                A(PRINT LINE)                                
         AR    R4,RF               ADD DISPLACEMENT TO PRINTLINE                
         L     R3,ABUYNAMS         CONTRACT RECORD IS IN BUFFER                 
         LR    R5,R3                                                            
         LA    R5,40(R5)           A(TEST FLAG)                                 
         LA    R3,50(R3)           RECORD IS 50 BYTES IN                        
         USING RCONREC,R3                                                       
         LA    R3,RCONELEM         A(1ST ELEMENT)                               
         LR    R6,R3               SAVE A(1ST ELEMENT)                          
         DROP  R3                                                               
         TM    RPMISFLG,X'20'      NO COMMENTS, DISP 1ST BUY DATE?              
         BO    SCMT0400            YES - SKIP COMMENTS                          
*                                                                               
*   BLANK LINE WILL ALWAYS PRECEDE/FOLLOW THE 'LAST UPDATED ON'                 
*     DISPLAY LINE.                                                             
*                                                                               
         GOTO1 =A(LOCALREP),DMCB,(RC),0 PRINT BLANK LINE FOR SPACING            
SCMT0080 EQU   *                                                                
         CLI   0(R3),0             END OF RECORD?                               
         BE    SCMT0200            YES                                          
         CLI   0(R3),X'11'         SAR COMMENT ELEMENT?                         
         BNE   SCMT0160            NO  -                                        
         CLC   =C'C=',2(R3)        STANDARD COMMENT WANTED?                     
         BE    SCMT0560            YES                                          
         CLC   =C'SC=',2(R3)       SFM COMMENT WANTED?                          
         BE    SCMT0560            YES                                          
SCMT0120 EQU   *                                                                
         ZIC   RE,1(R3)            GET ELEMENT LENGTH                           
         BCTR  RE,0                                                             
         BCTR  RE,0                SUBTRACT ELEMENT TYPE/LENGTH BYTES           
         BCTR  RE,0                SUBTRACT 1 FOR 'EXEC' STATEMENT              
         LR    R1,R3               A(ELEMENT)                                   
         LA    R1,2(R1)            SKIP CONTROL                                 
         EX    RE,SCMT0520         MOVE COMMENT TO PRINT BY LENGTH              
         GOTO1 =A(LOCALREP),DMCB,(RC),0 PRINT THE LINE                          
SCMT0160 EQU   *                                                                
         ZIC   R0,1(R3)            BUMP TO NEXT ELEMENT                         
         AR    R3,R0                                                            
         B     SCMT0080            GO BACK FOR NEXT                             
SCMT0200 EQU   *                                                                
*                                                                               
*   BLANK LINE WILL ALWAYS PRECEDE/FOLLOW THE 'LAST UPDATED ON'                 
*     DISPLAY LINE.                                                             
*                                                                               
*****>   CLI   0(R5),C'Y'          COMMENTS PRESENT?                            
*****>   BNE   SCMT0480            NO  - NO BLANK LINE                          
         LR    R3,R6               RESET A(1ST ELEMENT)                         
         MVC   0(19,R4),=C'LAST UPDATE ON: N/A'                                 
*                                  MOVE LITERAL TO PRINT LINE                   
SCMT0240 EQU   *                                                                
         CLI   0(R3),0             END OF RECORD?                               
         BE    SCMT0320            YES                                          
         CLI   0(R3),X'12'         PENDING ELEMENT?                             
         BE    SCMT0280            YES -                                        
         ZIC   RF,1(R3)            NO  - BUMP TO NEXT ELEMENT                   
         AR    R3,RF                                                            
         B     SCMT0240            GO BACK FOR NEXT                             
SCMT0280 EQU   *                                                                
         USING RSARXEL,R3                                                       
         CLI   RSARXLEN,120        OLD OR NEW ELEMENT?                          
         BNH   SCMT0320            OLD - ACTIVITY DATE DOESN'T EXIST            
         OC    RSARXLAD,RSARXLAD   ANY DATE IN FIELD?                           
         BZ    SCMT0320                                                         
         GOTO1 DATCON,DMCB,(3,RSARXLAD),(5,16(R4))                              
         DROP  R3                                                               
SCMT0320 EQU   *                                                                
         GOTO1 =A(LOCALREP),DMCB,(RC),0 PRINT 'LAST UPDATE ON' LINE             
SCMT0360 EQU   *                                                                
         TM    RPMISFLG,X'10'      DISP 1ST BUY DATE?                           
         BNO   SCMT0440            NO                                           
         B     SCMT0420                                                         
SCMT0400 EQU   *                                                                
*                                  NO COMMENTS/BUY ENTRY DATE DISPLAY           
*                                     ADD BLANK LINE                            
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                  PRINT BLANK LINE FOR SPACING                 
SCMT0420 EQU   *                                                                
         LR    R3,R6               RELOAD A(RCONELEM)                           
         USING RCONELEM,R3                                                      
         MVC   0(19,R4),=C'BUY ENTRY DATE: N/A'                                 
         GOTO1 DATCON,DMCB,(3,RCONCREA),(5,16(R4))                              
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                  PRINT 'BUY ENTRY DATE' LINE                  
         DROP  R3                                                               
*                                                                               
SCMT0440 EQU   *                                                                
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                  PRINT BLANK LINE FOR SPACING                 
SCMT0480 EQU   *                                                                
         XIT1                                                                   
SCMT0520 MVC   0(0,R4),0(R1)       MOVE COMMENT TO PRINT LINE                   
SCMT0560 EQU   *                                                                
         L     R2,ABUYNAMS         COMMENT RECORD IS IN BUFFER.                 
         A     R2,=F'1500'                                                      
         OC    0(64,R2),0(R2)      ANY RECORD THERE?                            
         BZ    SCMT0120            NO  - SHOW ELEMENT INSTEAD                   
         LA    R2,34(R2)           A(01 DESC ELEMENT)                           
SCMT0600 EQU   *                                                                
         CLI   0(R2),0             END OF RECORD?                               
         BE    SCMT0200            YES - FINISHED - GO BACK AND PUT             
*                                     OUT 'LAST UPDATED' INFO                   
         CLI   0(R2),X'02'         COMMENT ELEMENT?                             
         BNE   SCMT0640            NO  - SKIP IT                                
         ZIC   RF,1(R2)            GET ELEMENT LENGTH                           
         SH    RF,=H'3'            SUB L(CONTROL +1 FOR EXEC)                   
         LR    R1,R2               SET R1 FOR EX STATEMENT                      
         LA    R1,2(R1)            SKIP CONTROL                                 
         EX    RF,SCMT0520         MOVE LINE TO PRINT                           
         GOTO1 =A(LOCALREP),DMCB,(RC),0 PRINT THE LINE                          
SCMT0640 EQU   *                                                                
         ZIC   RF,1(R2)            BUMP TO NEXT ELEMENT                         
         AR    R2,RF                                                            
         B     SCMT0600            GO BACK FOR NEXT                             
         EJECT                                                                  
*                                                                               
*   SPLCMTS:  PRODUCE COMMENTS FROM THE SPL ELEMENT, AND ITS DATE               
*                                                                               
SPLCMTS  NTR1                                                                   
         ZIC   RF,RPCOMDSP         COMMENT DISPLACEMENT                         
         LA    R4,P                A(PRINT LINE)                                
         AR    R4,RF               ADD DISPLACEMENT TO PRINTLINE                
         L     R3,ABUYNAMS         CONTRACT RECORD IS IN BUFFER                 
         LR    R5,R3                                                            
         LA    R5,40(R5)           A(TEST FLAG)                                 
         LA    R3,50(R3)           RECORD IS 50 BYTES IN                        
         USING RCONREC,R3                                                       
         LA    R3,RCONELEM         A(1ST ELEMENT)                               
         LR    R6,R3               SAVE A(1ST ELEMENT)                          
         DROP  R3                                                               
*                                                                               
*   BLANK LINE WILL ALWAYS PRECEDE/FOLLOW THE 'SPL ENTERED ON'                  
*     DISPLAY LINE.                                                             
*                                                                               
         GOTO1 =A(LOCALREP),DMCB,(RC),0 PRINT BLANK LINE FOR SPACING            
SPCM0020 EQU   *                                                                
         CLI   0(R3),0             END OF RECORD?                               
         BE    SPCM0040            YES                                          
         CLI   0(R3),X'07'         SPL COMMENT ELEMENT?                         
         BNE   SPCM0030            NO  -                                        
SPCM0025 EQU   *                                                                
         ZIC   RE,1(R3)            GET ELEMENT LENGTH                           
         BCTR  RE,0                                                             
         BCTR  RE,0                SUBTRACT ELEMENT TYPE/LENGTH BYTES           
         BCTR  RE,0                SUBTRACT 1 FOR 'EXEC' STATEMENT              
         LR    R1,R3               A(ELEMENT)                                   
         LA    R1,2(R1)            SKIP CONTROL                                 
         EX    RE,SPCM0090         MOVE COMMENT TO PRINT BY LENGTH              
         GOTO1 =A(LOCALREP),DMCB,(RC),0 PRINT THE LINE                          
SPCM0030 EQU   *                                                                
         ZIC   R0,1(R3)            BUMP TO NEXT ELEMENT                         
         AR    R3,R0                                                            
         B     SPCM0020            GO BACK FOR NEXT                             
SPCM0040 EQU   *                                                                
*                                                                               
*   BLANK LINE WILL ALWAYS PRECEDE/FOLLOW THE 'SPL ENTERED ON'                  
*     DISPLAY LINE.                                                             
*                                                                               
         LR    R3,R6               RESET A(1ST ELEMENT)                         
         MVC   0(19,R4),=C'SPL ENTERED ON: N/A'                                 
*                                  MOVE LITERAL TO PRINT LINE                   
SPCM0050 EQU   *                                                                
         CLI   0(R3),0             END OF RECORD?                               
         BE    SPCM0070            YES                                          
         CLI   0(R3),X'06'         SPL ELEMENT?                                 
         BE    SPCM0060            YES -                                        
         ZIC   RF,1(R3)            NO  - BUMP TO NEXT ELEMENT                   
         AR    R3,RF                                                            
         B     SPCM0050            GO BACK FOR NEXT                             
SPCM0060 EQU   *                                                                
         USING RCONSPEL,R3                                                      
         OC    RCONSPYR(2),RCONSPYR   ANY DATE IN FIELD?                        
         BZ    SPCM0070            NO                                           
         TM    RCONSPES,X'08'      IS DATE COMPRESSED?                          
         BNO   SPCM0065            NO  - OLD FORMAT                             
         GOTO1 DATCON,DMCB,(2,RCONSPYR),(5,16(R4))                              
         B     SPCM0070                                                         
SPCM0065 EQU   *                                                                
         XC    SPDATE,SPDATE       PROCESS OLD FORMAT                           
         MVC   SPDATE(2),RCONSPYR                                               
         MVI   SPDATE+2,1          SET DAY TO '1'                               
         GOTO1 DATCON,DMCB,(3,SPDATE),(6,16(R4))                                
*                                  DATE IS MMM/YY IN PRINT                      
SPCM0070 EQU   *                                                                
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                  PRINT 'SPL ENTERED ON' LINE                  
         GOTO1 =A(LOCALREP),DMCB,(RC),0                                         
*                                  PRINT BLANK LINE FOR SPACING                 
SPCM0080 EQU   *                                                                
         XIT1                                                                   
*                                                                               
SPCM0090 MVC   0(0,R4),0(R1)       MOVE COMMENT TO PRINT LINE                   
*                                                                               
SPDATE   DS    XL3                 LOCAL DATE WORK SPACE                        
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* SUBROUTINE TO DUMP AGGREGATE TABLE/SPL AS RUN TABLE                           
         SPACE                                                                  
         DS    0F                                                               
*DUMPTABL NMOD1 0,*TABL*                                                        
*        L     RC,0(R1)            RESET A(WORKSPACE)                           
*        L     R4,4(R1)            RESET A(TABLE ENTRY)                         
*        L     R2,8(R1)            FLAG:  0 = SPL  1 = AGG                      
*        CLI   RCTRACE,C'T'        TABLE DISPLAY WANTED?                        
*        BNE   DUTA0060            NO                                           
*        ST    R4,FULL                                                          
*        GOTO1 HEXOUT,DMCB,FULL,P+15,4,=C'TOG'                                  
*        STC   R2,FULL                                                          
*        CLI   FULL,0              SPL DATA?                                    
*        BNE   DUTA0001            NO                                           
*        MVC   P+1(11),=C'SPL: @ LOC:'                                          
DUTA0001 EQU   *                                                                
*        CLI   FULL,1              AGG DATA?                                    
*        BNE   DUTA0002            NO                                           
*        MVC   P+1(11),=C'AGG: @ LOC:'                                          
DUTA0002 EQU   *                                                                
*        CLI   FULL,3              ACTIVE RECORD?                               
*        BNE   DUTA0003            NO                                           
*        MVC   P+1(11),=C'ACTIVE REC:'                                          
DUTA0003 EQU   *                                                                
*        CLI   FULL,4              TABLE RECORD?                                
*        BNE   DUTA0010            NO                                           
*        MVC   P+1(11),=C'TABLE  REC:'                                          
DUTA0010 EQU   *                                                                
*        GOTO1 REPORT                                                           
*        LA    R2,P                                                             
*        LA    R3,PSECOND                                                       
*        LR    R0,R4               SAVE A(RECORD)                               
*        LA    R5,12                                                            
DUTA0020 EQU   *                                                                
*        MVC   0(9,R2),0(R4)       LOAD 9 CHARS INTO PRINT                      
*        GOTO1 HEXOUT,DMCB,(R2),(R3),9,=C'SEP'                                  
*        MVC   132(9,R3),9(R3)                                                  
*        MVI   9(R3),C' '                                                       
*        LA    R2,10(R2)                                                        
*        LA    R3,10(R3)                                                        
*        LA    R4,9(R4)                                                         
*        BCT   R5,DUTA0020                                                      
*        MVC   PSECOND+119(12),SPACES                                           
*        MVI   SPACING,2                                                        
*        GOTO1 REPORT                                                           
*        LA    R3,P                                                             
*        LR    R4,R0               RELOAD A(RECORD)                             
*        LA    R4,RGDTADSP(R4)     OFFSET TO NUMERIC DATA                       
*        LA    R5,16                                                            
*        SPACE 2                                                                
DUTA0030 EQU   *                                                                
*        GOTO1 HEXOUT,DMCB,(R4),(R3),4,=C'SEP'                                  
*        MVC   132(4,R3),4(R3)                                                  
*        MVI   4(R3),C' '                                                       
*        LA    R3,5(R3)                                                         
*        LA    R4,4(R4)                                                         
*        BCT   R5,DUTA0030                                                      
*        MVC   P+79(52),SPACES                                                  
*        MVI   SPACING,3                                                        
*        GOTO1 REPORT                                                           
DUTA0060 EQU   *                                                                
*        XIT1                                                                   
*        EJECT                                                                  
*        LTORG                                                                  
         EJECT                                                                  
RGWORKC  DS    0D   **************** WORK AREA START ***************            
         DC    CL8'*RGWORKC'                                                    
*                                                                               
AXTRA    DS    0F                  EXTENTION ROUTINE ADDRESSES                  
AGETNAME DS    A                                                                
AGETADV  DS    A                                                                
AGETAGY  DS    A                                                                
AGETCONT DS    A                                                                
AXTRAN   EQU   (*-AXTRA)/L'AXTRA                                                
*                                                                               
PK1      DS    D                                                                
PK2      DS    D                                                                
         DS    0D                                                               
RECLABEL DC    C'***REC**'                                                      
REC      DS    XL256                                                            
         DC    C'*NEWREC*'                                                      
NEWREC   DS    XL256                                                            
         DC    C'*BDGREC*'                                                      
BDGREC   DS    XL256                                                            
         DS    0C                                                               
         DC    C'*KTZREC*'                                                      
         DS    F                   WORD LENGTH FOR VARIABLE                     
KTZREC   DS    XL256                                                            
KTZCOUNT DS    F                                                                
KTZADDR  DS    F                                                                
KTZRECSZ DS    F                                                                
KTZELT#  DS    F                                                                
KTZELEM  DS    CL32                ELEMENT BUILD AREA                           
LKTZRCKY EQU   51                  L(KEY SECTION OF RECORD)                     
LKTZCTRL EQU   4                   L(FULLWORD FOR VAR RECORDS)                  
KTZ1STEL EQU   51                  DISPLACEMENT TO 1ST ELT IN RECORD            
ADATEOP  DS    F                   A(DATE FIELD IN OUTPUT RECORD)               
         DS    0C                                                               
         DC    CL8'*RGWORK*'                                                    
RGWORK   DCB   DDNAME=RGWORK,DSORG=PS,EODAD=*,LRECL=RGRECLEN,          X        
               BLKSIZE=16*RGRECLEN,MACRF=(GM,PM),RECFM=FB                       
*                                                                               
ONLINER  DCB   DDNAME=ONLINER,DSORG=PS,EODAD=*,LRECL=RGRECLEN,         X        
               BLKSIZE=16*RGRECLEN,MACRF=(GM,PM),RECFM=FB                       
*                                                                               
BROWSER  DCB   DDNAME=BROWSER,DSORG=PS,RECFM=VB,MACRF=PM,              X        
               LRECL=4004,BLKSIZE=32760,BUFNO=2                                 
*                                                                               
TODAY    DS    CL8                 TODAY'S DATE                                 
RANKSPEC DS    CL8                                                              
RANKSUB  DS    A                                                                
THISQWK  DS    A                   REQUEST NUM/QWORK ADDRESS                    
THISRPT  DS    A                   CURRENT REPORT NUM/RPSPEC ADDRESS            
SAVERPT  DS    A                   SAVE AREA IF RECAP IN PROCESS                
SVTOTROW DS    A                   TOTAL BUFFER ADDRESS FOR CUR ROW             
HEADADDR DS    A                   ADDRESS OF TEMP HEADLINE DATA                
USERRD   DS    A                                                                
AWORKD   DS    A                                                                
CHECKNXT DC    A(CHECKLST)                                                      
PCTADJ   DS    H                                                                
DESTID   DS    XL2                                                              
RPMAXTTL DS    X                   MAX HEADLINE ROW TITLE LENGTH                
RPMAXCOD DS    X                   MAX HEADLINE CODE LENGTH                     
REPWIDTH DC    AL1(132)            DEFINED REPORT WIDTH                         
THISCOPY DS    C                   CURRENT COPY NUMBER                          
ELCODE   DS    C                                                                
RPTFRST  DS    C                                                                
RPTLAST  DS    C                                                                
REQFRST  DS    C                                                                
REQLAST  DS    C                                                                
RANKDONE DS    C                                                                
MONTH    DS    X                   CURRENT MONTH NUMBER                         
MONTHX   DS    X                                                                
QTR      DS    X                   CURRENT QUARTER NUMBER                       
STARTMON DS    X                   REQUEST START MONTH                          
ENDMON   DS    X                   REQUEST END MONTH                            
MKTBYTE  DS    X                   X'40' MORE THAN 1 STATION PER MKT            
*                                  X'20' THIS IS MARKET 'FF' RECORD             
*                                  X'04' MORE THAN 1 STA IN COMBO               
*                                  X'02' THIS IS COMBO X'FE' RECORD             
ROWIDTH  DS    X                                                                
SKIPTOT  DS    C                   SKIP PRINTING TOTAL LINE                     
CBLEVEL  DS    C                                                                
PRTSW    DS    C                                                                
DELTOTS  DS    C                                                                
RUNMODE  DS    C                                                                
NOLOGOSW DS    C                   MCPRTIND VALUE                               
DIRECTSW DS    C                   Y = DIRECT TO QUEUE                          
SVREMPQK DS    CL17                                                             
OUTPUT   DS    C                                                                
DASH     DS    C                                                                
REQPRNT  DS    C                                                                
WRKOPEN  DC    C'N'                RGWORK FILE OPEN FLAG                        
BROWZOPN DC    C'N'                BROWSER FILE OPEN FLAG                       
XFF      DC    15X'FF'                                                          
XFFE     DC    XL6'FFFFFFFFFFFE'   COMBO STATION TOTAL FLAG                     
NULLS    DC    5X'00'                                                           
H0       DC    H'0'                                                             
LSTCBLVL DS    CL1                 LAST CBLEVEL PRINTED                         
CLEARR1  DS    A                   LAST CLEAR START                             
CLEARR0  DS    A                   LAST CLEAR END                               
NOTOTS   DS    XL(RGCOLMAX)        WORKING NOTOTS INDS                          
ATOTALS  DC    A(TOTALS)                                                        
ATOTALX  DC    A(TOTALX)                                                        
ASVTOTS  DC    A(SVTOTALS)                                                      
ASVTOTX  DC    A(SVTOTALX)                                                      
ATOTRECS DC    A(TOTRECS)                                                       
ATOTRECX DC    A(TOTRECX)                                                       
ASVHEAD  DC    A(SVHEAD)                                                        
ANEXTTOT DS    A                                                                
ROWDSPL  DS    A                   CURRENT ROW DISPLACEMENT                     
COLDSPL  DS    A                   CURRENT COL DISPLACEMENT                     
SPECADDR DS    A                                                                
FTOTR6   DS    F                                                                
FTOTR7   DS    F                                                                
BRADDR1  DS    A                                                                
BRADDR2  DS    A                                                                
SVTOTREC DS    A                                                                
RKRECAP  DS    A                                                                
MCADDR   DS    A                                                                
APRISPEC DS    A                   A(ORIGINAL SPEC #)                           
SVRFREG  DS    F                                                                
SVR0REG  DS    F                                                                
SVR1REG  DS    F                                                                
CENTER   DC    V(CENTER)                                                        
UNDERLIN DC    V(UNDERLIN)                                                      
TOTWORK  DS    XL(RGCOLMAX*4)                                                   
TOTSAVE  DS    XL(RGCOLMAX*4)                                                   
FLD      DS    CL16                                                             
SORTKEY  DS    CL5                                                              
AGYOFFLG DS    CL1                 AGENCY OFFICE NOT USED FLAG                  
*                                  N = NO AGENCY OFFICE                         
COSPEC#  DS    X                   COMPANY SPEC ROW #                           
COSPEC#2 DS    X                   COMPANY SPEC ROW SKIP FLAG                   
NEWSPEC# DS    X                   NEW REPORT SPEC #                            
PRISPEC# DS    X                   PRIOR SPEC #                                 
XFERTO   DS    X                   TRANSFER TO UPON RETURN                      
*                                  1  =  NEXR2160                               
*                                  2  =  NEXR1840                               
PCTFLAG  DC    X'00'                                                            
ADVSAVE  DS    CL4                                                              
ADVNMSV  DS    CL8                                                              
AGYSAVE  DS    CL6                                                              
AGYNMSV  DS    CL8                                                              
SVMKTSTA DS    CL2                 MARKET STATION NUMBER                        
SVMKT    DS    CL20                MARKET NAME                                  
EXTRAPL  DS    CL132                                                            
STAGLINE DS    CL132               STAGGER PRINT LINE                           
PSAVE    DS    CL132                                                            
AAGGLINE DS    F                   A(AGGREGATE LINE SAVE AREA)                  
NEXTAGLN DS    F                   NEXT AVAILABLE AGG LINE SLOT                 
AAGGSPLN DS    F                   A(SAVED SPL AS RUN RECORD)                   
NEXTSPLN DS    F                   NEXT AVAILABLE SPL LINE SLOT                 
AACTIVE  DS    A                   A(ACTIVE RECORD)                             
COMPROND DS    F                   ROUNDING FACTOR FOR COLCOMP                  
MASTDSAV DS    A                   A(MCSTUFF)                                   
SAVPQOPN DS    A                   V(PQOPEN)                                    
SAVPQBUF DS    A                   V(PQBUFF)                                    
SAVDTMGR DS    A                   V(DTMGR)                                     
SPLCOMP  DS    CL(RGKEYLEN)        POSTING COMPARISON AREAS                     
AGGCOMP  DS    CL(RGKEYLEN)           FOR AGGREG VALUES                         
SPLCOUNT DS    XL1                 COUNTER/FLAG                                 
AGGCOUNT DS    XL1                 COUNTER/FLAG                                 
XENDLOGO DS    CL1                 EXECUTE END LOGO FLAG                        
OTHRNAME DS    CL1                 Y = CHANGE NAME TO 'OTHERS'                  
COMPFLAG DS    CL1                 N=NOT COLCOMP,Y=COLCOMP                      
FRSTREMO DS    XL1                 REMOTE FLAGS                                 
         DS    0F                                                               
RPTBXROW DC    7X'00',C'T',3X'00',C'M',43X'00'   8/12                           
RPTBXRX  DC    C'B'                56                                           
         DC    4X'00'                                                           
RPTMXLNS EQU   RPTBXRX-RPTBXROW     VALUE FOR MAX USABLE LINES                  
RPTBXCOL DC    XL132'00'                                                        
         DC    XL2'FFFF'                                                        
SAVSENUM DS    CL1                 SAVE AREA FOR SYSTEM NUMBER                  
         SPACE 2                                                                
* SORTCD1 USED TO SORT ON RANK VALUE (REC+0(9))                                 
* SORTCD2 USED TO RESORT AFTER RANK POSITIONS INSERTED                          
*                                                                               
SORTCD1  DC    CL80'SORT FIELDS=(1,000,A),FORMAT=BI,WORK=1'                     
SORTCD2  DC    CL80'SORT FIELDS=(1,000,A),FORMAT=BI,WORK=1'                     
RECCARD  DC    CL80'RECORD TYPE=F,LENGTH=000'                                   
         SPACE 2                                                                
RRGEOD   DCB   DDNAME=RRGEOD,MACRF=(PM),DSORG=PS,RECFM=FBM,LRECL=133            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
       ++INCLUDE RETVBTAB                                                       
         EJECT                                                                  
         DS    0D                                                               
         DC    CL8'*TOTALS*'                                                    
TOTALS   DS    ((RGROWMAX-1)*(RGCOLMAX+10)*4*18)X                               
TOTALX   EQU   *                                                                
*                                                                               
*    RGCOLMAX+10:  NOTATION -                                                   
*        RGCOLMAX = MAX NUMBER COLUMNS IN REPORT                                
*        +10      = ADDITIONAL BUCKETS REQUIRED IN SUPPORT OF THE               
*                   SPL FIGURES TO GET BOTTOM LINE TOTALS.  TWO                 
*                   BUCKETS PER SPL FIGURE:  5X2=10.                            
*                                                                               
TOTROWLN EQU   (RGCOLMAX+10)*4        LENGTH OF TOTALS FOR ONE MONTH            
TOTLEN   EQU   (RGCOLMAX+10)*4*18     LENGTH OF TOTALS FOR ONE ROW              
TOTRSPLC EQU   (RGCOLMAX)*4          DISP TO SPL AS-RUN CURRENT                 
TOTRSPLP EQU   (RGCOLMAX)*4+8        DISP TO SPL AS-RUN PRIOR                   
TOTRSPLT EQU   (RGCOLMAX)*4+16       DISP TO SPL AS-RUN THIS WEEK               
TOTRSPLE EQU   (RGCOLMAX)*4+24       DISP TO SPL AS-RUN ESTIMATED               
TOTRSPLL EQU   (RGCOLMAX)*4+32       DISP TO SPL AS-RUN THS WK LST YR           
         DS    0D                                                               
         DC    CL8'*SVTOTS*'                                                    
SVTOTALS DS    ((RGROWMAX-1)*(RGCOLMAX+10)*4*18)X                               
SVTOTALX EQU   *                                                                
         DS    0D                                                               
         DC    CL8'*SVHEAD*'                                                    
SVHEAD   DS    12CL132                                                          
         DS    0D                                                               
         DC    CL8'TOTRECS'                                                     
TOTRECS  DS    400XL256                                                         
TOTRECX  EQU   *-1                                                              
         DS    0D                                                               
         DS    0D                                                               
         DC    CL8'*RPDATA*'                                                    
RPDATA   DS    (25*(RPSPECX-RPSPECD))X   MAXIMUM 25 REPORTS/REQUEST             
RPDATX   EQU   *-1                                                              
         EJECT                                                                  
CHECKLST DC    1000XL22'00'                                                     
         DC    X'FF'                                                            
         SPACE                                                                  
IDBUFF   DS    0D                                                               
         DC    F'1000'                                                          
         DC    F'0'                                                             
         DC    8000X'00'                                                        
         SPACE                                                                  
CTIO     DS    0D                                                               
         DS    1000C                                                            
         SPACE                                                                  
         DS    0D                                                               
         DC    CL8'*DWNTAB*'                                                    
DOWNTAB  DC    500X'00'                                                         
LDOWNTAB EQU   250                SET LEN TO HALF                               
         EJECT                                                                  
* DSECT FOR EXPLODED OUTPUT SPECS *                                             
         SPACE 1                                                                
RPSPECD  DSECT                                                                  
*                                                                               
RPRPTNAM DS    A                   A(RPTNAME SPEC)                              
RPRPTRGT DS    A                   A(FIRST RPTRIGHT SPEC)                       
RPCOLCHK DS    A                   A(FIRST COLCHUNK SPEC)                       
RPCOLFUT DS    A                   A(FIRST COLFOOT SPEC)                        
RPREMPRT DS    A                   A(REMPRINT SPEC)                             
RPREMCPY DS    A                   A(FIRST REMCOPY SPEC)                        
RPRANK1  DS    A                   RANK1  AL1(ROW)/AL3(RANK SPEC)               
RPRANK2  DS    A                   RANK2  DITTO                                 
RPADVCD  DS    A                   ADV     AL1(ROW)/AL3(ROW IN REC)             
RPADVNM  DS    A                   ADVNAME DITTO                                
RPAGYCD  DS    A                   AGY     DITTO                                
RPAGYNM  DS    A                   AGYNAME DITTO                                
RPBCUME  DS    H                   CURR BILLING CUME DISPLACEMENT               
RPPCCUME DS    H                   CURR BILLING PERCENT CUME DISP               
RPBUDGET DS    H                   BUDGET COLUMN DISPLACEMENT                   
RPCBEXLN DS    H                   EX LEN FOR PRIMARY CONTROL BREAK             
RPMONTHS DS    X                   NON-ZERO = DSPL TO MONTH ROW SPEC            
RPTOTOPT DS    X                   C'T'=TOTS ONLY,C'Q'=QTRS ONLY                
RPSPCNG  DS    C                                                                
RPNOBOX  DS    C                                                                
RPWIDTH  DS    X                                                                
RPMARGIN DS    X                                                                
RPCOMDSP DS    X                   COMMENT DISPLACEMENT                         
RPBASIS  DS    C                                                                
RPOPT    DS    X                                                                
RPQTRS   DS    X                                                                
RPCHOP   DS    X                                                                
RPFOLD   DS    X                                                                
RPRPTCD  DS    CL2                                                              
RPRKCOL1 DS    X                                                                
RPRKCOL2 DS    X                                                                
RPCOPIES DS    X                                                                
RPMONEY  DS    X                                                                
RPROWS   DS    X                   ACTUAL ROWS THIS REPORT                      
RPCOLS   DS    X                   ACTUAL COLS THIS REPORT                      
RPCBMAX  DS    X                   =RPROWS - 1 IF MONTHLY REPORT                
RPSPLSTA DS    X                   SPL STATION ROW #                            
RPBRZFLG DS    X                   BROWSER DATE RECORD FLAG                     
*                                  X'00'  =  DATE RECORD NOT GENERATED          
*                                  X'01'  =  DATE RECORD GENERATED              
RPSPLACT DS    C                   SPL ACTIVE IN REPORT                         
*                                  Y  =  ACTIVE: NEED TO SET AFFIL              
RPFRCACT DS    C                   FORECAST COLUMNS ACTIVE IN REPORT            
*                                  Y  =  ACTIVE:                                
RPLSTSTA DS    C                   LAST STATION IN SECTION                      
*                                  Y  =  COMMENTS AFTER THIS ONE                
RPSTMKTR DS    C                   STATION ROW NUMBER                           
RPREPTYP DS    C                   REPORT TYPE                                  
RPAGGBAS DS    X                   # ROWS FOR AGGREGATE COMPARE                 
RPAGGTOT DS    X                   TOTAL # ROWS FOR AGGREGATE                   
RPAGGTAB DS    X                   ROWS BEFORE A BREAK (SPECIAL                 
*                                     AGGREGATE PROCESSING)                     
RPBUDPAS DS    X                   ROWS TO COMPARE FOR SPECIAL                  
*                                     BUDGET PROCESSING                         
RPFLAGS  DS    CL1                 X'01' = 'PENDING' REPORT                     
*                                  X'02' = 'COMMENT' REPORT                     
*                                  X'04' = 'SPLITPND' REPORT                    
RPMISFLG DS    CL8                 MISCELLANEOUS REPORT FLAGS                   
*                                  EIGHT BYTES FROM SPEC                        
*                                                                               
*                                  OPTIONS ARE NOT COMPLETE HERE.               
*                                  SEE 'BUHR.DDS.TEXT(RRGDOC) FOR               
*                                     CURRENT OPTIONS                           
*        BYTE 1:                                                                
*                                     X'01' = SPECIAL SORT NEEDED               
*        BYTE 2:                                                                
*                                     X'01' = DON'T INCREMENT RANK              
*                                        PRINT ON EQUAL VALUES                  
         DS    0D                                                               
RPROWDEF DS    XL((RGROWMAX+1)*4)  ROW DEF SPEC ADDRESSES                       
         DS    0D                                                               
RPROWNAM DS    XL((RGROWMAX+1)*4)  ROW NAME SPEC ADDRESSES                      
         DS    0D                                                               
RPCOLDEF DS    XL((RGCOLMAX+1)*4)  COL DEF SPEC ADDRESSES                       
         DS    0D                                                               
RPCOLNAM DS    XL((RGCOLMAX+1)*4)  COL NAME SPECS                               
         DS    0D                                                               
RPCOLCOM DS    XL((RGCOLMAX+1)*4)  COL COMP SPECS                               
         DS    0D                                                               
RPNOTOTS DS    XL(RGROWMAX*4)      NOTOT SPECS                                  
         DS    0D                                                               
RPTOTPRT DS    XL((RGROWMAX+1)*4)  TOT PRINT SPECS                              
         DS    0D                                                               
RPCBCTRS DS    XL((RGROWMAX+1)*4)  CONTROL BREAK COUNTERS                       
         DS    0D                                                               
RPROWDTA DS    XL(RGROWMAX*4)      DATA DSPLS                                   
         DS    0D                                                               
RPROWFLG DS    XL(RGROWMAX*4)      STAGGER FLAGS FOR ROWS                       
*                                  BIT 0     =   ROW IS STAGGERED               
*                                  BIT 1     =   ROW IS ABOVE STAGGER           
*                                  BITS 2-31  =  NOT USED AT THIS TIME          
         DS    0D                                                               
RPCOLDTA DS    XL(RGCOLMAX*4)      DATA DSPLS                                   
*                                                                               
RPCURWKS DS    XL12                WEEKS/MONTH - CURRENT YEAR                   
RPPRIWKS DS    XL12                WEEKS/MONTH - PRIOR YEAR                     
RPCWKYTD DS    XL12                WEEKS/YTD - CURRENT YEAR                     
RPPWKYTD DS    XL12                WEEKS/YTD - PRIOR YEAR                       
*                                                                               
RPCUREST DS    A                   A(CURRENT ESTIMATE COLUMN)                   
RPCURACT DS    A                   A(CURRENT ACTUAL   COLUMN)                   
RPCURBOK DS    A                   A(CURRENT BOOKED COLUMN)                     
RPCURBIL DS    A                   A(CURRENT BILLED COLUMN)                     
*                                                                               
RPSPECX  EQU   *                                                                
         EJECT                                                                  
RNSPECD  DSECT                     ***** DSECT FOR ROWNAME SPECS *****          
RNSPEC   DS    AL1(31)                                                          
RNSPECLN DS    AL1                                                              
RNDTATYP DS    AL1               DATA TYPE - 1=NAM,2=COD,3=BOTH,4=RNK           
RNLINTYP DS    AL1               LINE TYPE - 1=HEAD,2=MID, 3=PRINT              
RNTTLLEN DS    AL1               TITLE LENGTH                                   
RNCODLEN DS    AL1               CODE LENGTH                                    
RNNAMLEN DS    AL1               NAME LENGTH                                    
RNTITLE  DS    0C                ROW TITLE                                      
         EJECT                                                                  
       ++INCLUDE REREPQWKDD                                                     
         EJECT                                                                  
       ++INCLUDE REREPSPEQU                                                     
         EJECT                                                                  
       ++INCLUDE DDBIGBOX                                                       
         EJECT                                                                  
       ++INCLUDE REREPWORKD                                                     
         EJECT                                                                  
       ++INCLUDE DDLOGOD                                                        
         EJECT                                                                  
       ++INCLUDE DDREPMASTD                                                     
         EJECT                                                                  
       ++INCLUDE RESUBREPS                                                      
         EJECT                                                                  
QREC2D   DSECT                                                                  
       ++INCLUDE REGENREQ2                                                      
         EJECT                                                                  
QREC3D   DSECT                                                                  
       ++INCLUDE REGENREQ3                                                      
         EJECT                                                                  
RCMTD    DSECT                                                                  
       ++INCLUDE REGENCMT                                                       
         EJECT                                                                  
ROCMD    DSECT                                                                  
       ++INCLUDE REGENOCM                                                       
         EJECT                                                                  
DEVSP    DSECT                                                                  
       ++INCLUDE REGENDSP                                                       
         EJECT                                                                  
DEVCT    DSECT                                                                  
       ++INCLUDE REGENDCT                                                       
         EJECT                                                                  
       ++INCLUDE REXADDRD                                                       
         EJECT                                                                  
       ++INCLUDE DDTSARD                                                        
         EJECT                                                                  
       ++INCLUDE DDREMOTED                                                      
       ++INCLUDE REGENALL1A                                                     
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'108REREPRG03T05/01/02'                                      
         END                                                                    
